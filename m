Return-Path: <linux-kernel-owner+willy=40w.ods.org-S932274AbVIEHaR@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S932274AbVIEHaR (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 5 Sep 2005 03:30:17 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S932271AbVIEHaR
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 5 Sep 2005 03:30:17 -0400
Received: from colgate.yandex.ru ([213.180.200.34]:32927 "EHLO
	colgate.yandex.ru") by vger.kernel.org with ESMTP id S932274AbVIEHaQ
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Mon, 5 Sep 2005 03:30:16 -0400
Date: Mon, 5 Sep 2005 11:30:02 +0400 (MSD)
From: "Alexander Krizhanovsky" <klx@yandex.ru>
Message-Id: <431BF3FA.000001.11625@colgate.yandex.ru>
MIME-Version: 1.0
X-Mailer: Yamail [ http://yandex.ru ]
To: linux-kernel@vger.kernel.org
Subject: [PATCH] autofs: fix "busy inodes after umount..."
Reply-To: klx@yandex.ru
X-Source-Ip: 195.214.233.10
Content-Type: Multipart/Mixed;
  boundary="------------Boundary-00=_262C40MWKGMMYJ0CCJD0"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


--------------Boundary-00=_262C40MWKGMMYJ0CCJD0
Content-Type: text/plain;
  charset="US-ASCII"
Content-Transfer-Encoding: 7bit

Hello!

This patch for old autofs (version 3) cleans dentries which not putted after killing automount daemon (it's analogue of recent patch for autofs4).

Signed-off-by: Alexander Krizhanovsky <klx@yandex.ru>
--------------Boundary-00=_262C40MWKGMMYJ0CCJD0
Content-Disposition: attachment;
  Filename="autofs-patch"
Content-Type: application/octet-stream;
  name="autofs-patch"
Content-Transfer-Encoding: base64

LS0tIGxpbnV4LTIuNi4xMy9mcy9hdXRvZnMvYXV0b2ZzX2kuaC5vcmlnCTIwMDUtMDgtMjkgMDM6
NDE6MDEuMDAwMDAwMDAwICswNDAwCisrKyBsaW51eC0yLjYuMTMvZnMvYXV0b2ZzL2F1dG9mc19p
LmgJMjAwNS0wOS0wMiAyMDoxMDo1OS4wMDAwMDAwMDAgKzA0MDAKQEAgLTEwNSw2ICsxMDUsNyBA
QCBzdHJ1Y3QgYXV0b2ZzX3NiX2luZm8gewogCXN0cnVjdCBmaWxlICpwaXBlOwogCXBpZF90IG96
X3BncnA7CiAJaW50IGNhdGF0b25pYzsKKwlzdHJ1Y3Qgc3VwZXJfYmxvY2sgKnNiOwogCXVuc2ln
bmVkIGxvbmcgZXhwX3RpbWVvdXQ7CiAJaW5vX3QgbmV4dF9kaXJfaW5vOwogCXN0cnVjdCBhdXRv
ZnNfd2FpdF9xdWV1ZSAqcXVldWVzOyAvKiBXYWl0IHF1ZXVlIHBvaW50ZXIgKi8KQEAgLTEzNCw3
ICsxMzUsNyBAQCB2b2lkIGF1dG9mc19oYXNoX2luc2VydChzdHJ1Y3QgYXV0b2ZzX2RpCiB2b2lk
IGF1dG9mc19oYXNoX2RlbGV0ZShzdHJ1Y3QgYXV0b2ZzX2Rpcl9lbnQgKik7CiBzdHJ1Y3QgYXV0
b2ZzX2Rpcl9lbnQgKmF1dG9mc19oYXNoX2VudW0oY29uc3Qgc3RydWN0IGF1dG9mc19kaXJoYXNo
ICosb2ZmX3QgKixzdHJ1Y3QgYXV0b2ZzX2Rpcl9lbnQgKik7CiB2b2lkIGF1dG9mc19oYXNoX2Rw
dXRhbGwoc3RydWN0IGF1dG9mc19kaXJoYXNoICopOwotdm9pZCBhdXRvZnNfaGFzaF9udWtlKHN0
cnVjdCBhdXRvZnNfZGlyaGFzaCAqKTsKK3ZvaWQgYXV0b2ZzX2hhc2hfbnVrZShzdHJ1Y3QgYXV0
b2ZzX3NiX2luZm8gKik7CiAKIC8qIEV4cGlyYXRpb24taGFuZGxpbmcgZnVuY3Rpb25zICovCiAK
LS0tIGxpbnV4LTIuNi4xMy9mcy9hdXRvZnMvaW5vZGUuYy5vcmlnCTIwMDUtMDgtMjkgMDM6NDE6
MDEuMDAwMDAwMDAwICswNDAwCisrKyBsaW51eC0yLjYuMTMvZnMvYXV0b2ZzL2lub2RlLmMJMjAw
NS0wOS0wMiAyMDoxMzo0My4wMDAwMDAwMDAgKzA0MDAKQEAgLTI3LDcgKzI3LDcgQEAgc3RhdGlj
IHZvaWQgYXV0b2ZzX3B1dF9zdXBlcihzdHJ1Y3Qgc3VwZQogCWlmICggIXNiaS0+Y2F0YXRvbmlj
ICkKIAkJYXV0b2ZzX2NhdGF0b25pY19tb2RlKHNiaSk7IC8qIEZyZWUgd2FpdCBxdWV1ZXMsIGNs
b3NlIHBpcGUgKi8KIAotCWF1dG9mc19oYXNoX251a2UoJnNiaS0+ZGlyaGFzaCk7CisJYXV0b2Zz
X2hhc2hfbnVrZShzYmkpOwogCWZvciAoIG4gPSAwIDsgbiA8IEFVVE9GU19NQVhfU1lNTElOS1Mg
OyBuKysgKSB7CiAJCWlmICggdGVzdF9iaXQobiwgc2JpLT5zeW1saW5rX2JpdG1hcCkgKQogCQkJ
a2ZyZWUoc2JpLT5zeW1saW5rW25dLmRhdGEpOwpAQCAtMTQ4LDYgKzE0OCw3IEBAIGludCBhdXRv
ZnNfZmlsbF9zdXBlcihzdHJ1Y3Qgc3VwZXJfYmxvY2sKIAlzLT5zX21hZ2ljID0gQVVUT0ZTX1NV
UEVSX01BR0lDOwogCXMtPnNfb3AgPSAmYXV0b2ZzX3NvcHM7CiAJcy0+c190aW1lX2dyYW4gPSAx
OworCXNiaS0+c2IgPSBzOwogCiAJcm9vdF9pbm9kZSA9IGlnZXQocywgQVVUT0ZTX1JPT1RfSU5P
KTsKIAlyb290ID0gZF9hbGxvY19yb290KHJvb3RfaW5vZGUpOwotLS0gbGludXgtMi42LjEzL2Zz
L2F1dG9mcy9kaXJoYXNoLmMub3JpZwkyMDA1LTA4LTI5IDAzOjQxOjAxLjAwMDAwMDAwMCArMDQw
MAorKysgbGludXgtMi42LjEzL2ZzL2F1dG9mcy9kaXJoYXNoLmMJMjAwNS0wOS0wMiAyMDoxMDo1
OS4wMDAwMDAwMDAgKzA0MDAKQEAgLTIzMiwxMyArMjMyLDEzIEBAIHZvaWQgYXV0b2ZzX2hhc2hf
ZHB1dGFsbChzdHJ1Y3QgYXV0b2ZzX2QKIAogLyogRGVsZXRlIGV2ZXJ5dGhpbmcuICBUaGlzIGlz
IHVzZWQgb24gZmlsZXN5c3RlbSBkZXN0cnVjdGlvbiwgc28gd2UKICAgIG1ha2Ugbm8gYXR0ZW1w
dCB0byBrZWVwIHRoZSBwb2ludGVycyB2YWxpZCAqLwotdm9pZCBhdXRvZnNfaGFzaF9udWtlKHN0
cnVjdCBhdXRvZnNfZGlyaGFzaCAqZGgpCit2b2lkIGF1dG9mc19oYXNoX251a2Uoc3RydWN0IGF1
dG9mc19zYl9pbmZvICpzYmkpCiB7CiAJaW50IGk7CiAJc3RydWN0IGF1dG9mc19kaXJfZW50ICpl
bnQsICpuZW50OwogCiAJZm9yICggaSA9IDAgOyBpIDwgQVVUT0ZTX0hBU0hfU0laRSA7IGkrKyAp
IHsKLQkJZm9yICggZW50ID0gZGgtPmhbaV0gOyBlbnQgOyBlbnQgPSBuZW50ICkgeworCQlmb3Ig
KCBlbnQgPSBzYmktPmRpcmhhc2guaFtpXSA7IGVudCA7IGVudCA9IG5lbnQgKSB7CiAJCQluZW50
ID0gZW50LT5uZXh0OwogCQkJaWYgKCBlbnQtPmRlbnRyeSApCiAJCQkJZHB1dChlbnQtPmRlbnRy
eSk7CkBAIC0yNDYsNCArMjQ2LDUgQEAgdm9pZCBhdXRvZnNfaGFzaF9udWtlKHN0cnVjdCBhdXRv
ZnNfZGlyaAogCQkJa2ZyZWUoZW50KTsKIAkJfQogCX0KKwlzaHJpbmtfZGNhY2hlX3NiKHNiaS0+
c2IpOwogfQo=

--------------Boundary-00=_262C40MWKGMMYJ0CCJD0--
