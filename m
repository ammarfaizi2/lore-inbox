Return-Path: <linux-kernel-owner+willy=40w.ods.org-S1750890AbWHGCS3@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1750890AbWHGCS3 (ORCPT <rfc822;willy@w.ods.org>);
	Sun, 6 Aug 2006 22:18:29 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1750892AbWHGCS3
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Sun, 6 Aug 2006 22:18:29 -0400
Received: from py-out-1112.google.com ([64.233.166.177]:31412 "EHLO
	py-out-1112.google.com") by vger.kernel.org with ESMTP
	id S1750894AbWHGCS1 (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Sun, 6 Aug 2006 22:18:27 -0400
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
        s=beta; d=gmail.com;
        h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:references;
        b=a2UnF2xtC1vY58OVMX0S/qmt1jhhMlPgp+89AXac0F+3t9xDuESBLVsB41UrDwiNSOyGvH+b7JOSvNv+445f8FOFofMH4EFyqV8anivocm0HWTZwaB/EdCCETr431tlv3fDXhGeZij/kyXNWkhHImeEw1Hd/4EV8MTiapA4DfMk=
Message-ID: <4745278c0608061918m1c77234crc5d9bc1c215549f9@mail.gmail.com>
Date: Sun, 6 Aug 2006 22:18:23 -0400
From: "Vishal Patil" <vishpat@gmail.com>
To: "Andrea Arcangeli" <andrea@suse.de>
Subject: Re: Generic B-tree implementation
Cc: "Anton Altaparmakov" <aia21@cam.ac.uk>, "Gary Funck" <gary@intrepid.com>,
       "Linux Kernel Mailing List" <linux-kernel@vger.kernel.org>
In-Reply-To: <4745278c0607190926l57556563t410ca63514c8ca2f@mail.gmail.com>
MIME-Version: 1.0
Content-Type: multipart/mixed; 
	boundary="----=_Part_33970_17874812.1154917103763"
References: <4745278c0607180630m39040ad7neac25c1a64399aff@mail.gmail.com>
	 <JCEPIPKHCJGDMPOHDOIGCELEDFAA.gary@intrepid.com>
	 <4745278c0607180822u55ffe5b4g333e2e6457b37d02@mail.gmail.com>
	 <1153294394.13071.3.camel@imp.csi.cam.ac.uk>
	 <4745278c0607190634l3ab43bb7t3d2a7b80c22d44c4@mail.gmail.com>
	 <20060719161427.GN5726@opteron.random>
	 <4745278c0607190926l57556563t410ca63514c8ca2f@mail.gmail.com>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

------=_Part_33970_17874812.1154917103763
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Folks

Following Andrea's suggestions I have implemented the Linux kernel
page cache using B-Trees. I am attaching the patch along with this
email. Note that the patch was developed against 2.6.16.2. Also the
patch offers the B-tree data structure as a library (like the radix
tree)

Also I haven't made any performance measurements to compare it with
the radix tree implementation. However ideas to do this are most
welcome.

Thanks

- Vishal

On 7/19/06, Vishal Patil <vishpat@gmail.com> wrote:
> Andrea
>
> Thank you for your time and a very valuable input. I was thinking of
> implementing the VM management using B-trees because I wanted to play
> with something interesting in the kernel. However I will definately
> look into your idea of page cache as well.
>
> Will keep everyone informed about my progress.
>
> - Vishal
>
>
> On 7/19/06, Andrea Arcangeli <andrea@suse.de> wrote:
> > On Wed, Jul 19, 2006 at 09:34:43AM -0400, Vishal Patil wrote:
> > > I can get rid of recursions using loops, will need to work a little more on
> > > it.
> >
> > Before doing the above you may want to learn about all possible malloc
> > retvals too and to make sure the interface has all needed oom failure
> > paths that you're obviously missing.
> >
> > One of the advantages of rbtree vs b-trees (and vs radixtrees too) is
> > the fact they require zero dynamic metadata allocations of ram. They
> > use the same trick of list.h to avoid it while still being mostly
> > generic and sharable library code. Imagine rbtrees like scalable
> > lists. The kernel usage is quite optimized too, the mmap path for
> > example does a single lookup and it stores the last "lookup" point
> > before restarting with an insertion while keeping the mmap_sem (or
> > mutex renaming of the day) on hold so to avoid the insertion operation
> > to start over with a second (wasteful) lookup (again very similar to
> > what you could do if you had list, and the rebalancing is a very
> > immediate operation too involving only a limited number of pointers).
> >
> > > Also I will be working on developing a patch for VM management using
> > > B-trees instead of RB-trees.
> >
> > Once you start changing those bits, you'll notice the further
> > requirement of the btrees due to the oom failures in code paths that
> > are already reasonably complex with vma oom failures.
> >
> > As speed of cache raises faster than speed of ram, memory seeks tends
> > to cost more than they did in the past, but I doubt it worth it, most
> > important especially in the common case of very few vmas. I like the
> > common case of only a few dozen vmas to be so fast and low
> > overhead. The corner cases like uml and oracle already use nonlinear,
> > to also avoid the ram overhead of the vmas, with btree the lowmem
> > overhead would be even higher (the only 4/8 bytes of overhead of the
> > rbtrees would even be fixable with David's patch, but nobody
> > considered it very important so far to eliminate those 4/8 bytes
> > 32bit/64bit per vma, though we can do that in the future). So even if
> > btree would be faster for those extreme corner cases, it would still
> > not be a replacement for the nonlinear (I wish there was a decent
> > replacement for nonlinear, whose only reason to exist seems to be uml
> > on 64bit archs).
> >
> > If I would be in you, as a slightly more likely to succeed experiment,
> > I would be looking into replacing the pagecache radix-tree with a
> > btree, as long as you can leave intact the tagging properties we have
> > in the radix-tree needed for finding only dirty elements in the tree
> > etc... (we use that to avoid separate dirty lists for the pages). You
> > should also size the order to automatically match the cache size of
> > the arch (dunno if it's better at compile or run time). I'm no a
> > radix-tree guru but the btree may save some ram if you've all
> > pagecache pages scattered all over the place with random access. It
> > also won't require all levels to be allocated. However it will require
> > rebalancing, something the radix tree doesn't require, it seems a bit
> > of a tradeoff, and I suspect the radix-tree will still win in all
> > common cases. But at least all oom failure paths should already exists
> > for you, so that should avoid you having to touch much code externally
> > to your own btree files.
> >
> > I wish you to have fun with the btrees, I remember I had fun back then
> > when I was playing with the rbtrees ;).
> >
>
>
> --
> Motivation will almost always beat mere talent.
>


-- 
Motivation will almost always beat mere talent.

------=_Part_33970_17874812.1154917103763
Content-Type: text/x-patch; name=btree.rc1.patch; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: base64
X-Attachment-Id: f_eqk7shrs
Content-Disposition: attachment; filename="btree.rc1.patch"

ZGlmZiAtdXJOIGxpbnV4LTIuNi4xNi4yL21tL2ZpbGVtYXAuYyBsaW51eC0yLjYuMTYuMi1idHJl
ZS9tbS9maWxlbWFwLmMKLS0tIGxpbnV4LTIuNi4xNi4yL21tL2ZpbGVtYXAuYwkyMDA2LTA0LTA3
IDEyOjU2OjQ3LjAwMDAwMDAwMCAtMDQwMAorKysgbGludXgtMi42LjE2LjItYnRyZWUvbW0vZmls
ZW1hcC5jCTIwMDYtMDgtMDYgMjE6Mzc6NTUuMDAwMDAwMDAwIC0wNDAwCkBAIC0xMTIsMTAgKzEx
MiwxNiBAQAogICovCiB2b2lkIF9fcmVtb3ZlX2Zyb21fcGFnZV9jYWNoZShzdHJ1Y3QgcGFnZSAq
cGFnZSkKIHsKKwlzdHJ1Y3QgcGFnZSAqIGJwYWdlOwogCXN0cnVjdCBhZGRyZXNzX3NwYWNlICpt
YXBwaW5nID0gcGFnZS0+bWFwcGluZzsKKwl1bnNpZ25lZCBsb25nIGluZGV4ID0gcGFnZS0+aW5k
ZXg7CQogCi0JcmFkaXhfdHJlZV9kZWxldGUoJm1hcHBpbmctPnBhZ2VfdHJlZSwgcGFnZS0+aW5k
ZXgpOwotCXBhZ2UtPm1hcHBpbmcgPSBOVUxMOworCWJwYWdlID0gYnRyZWVfZGVsZXRlKCZtYXBw
aW5nLT5idHJlZSxtYXBwaW5nLT5idHJlZS5yb290LGluZGV4KS52YWw7CisJaWYgKCBicGFnZSAh
PSBwYWdlKSB7CisJCXBhbmljKCJERUJVRzogRGVsZXRpbmcgd3JvbmcgcGFnZSBpbiByZW1vdmUg
ZnJvbSBwYWdlIiAKKwkJCSJjYWNoZSAlZCwweCV4XG4iLGluZGV4LGJwYWdlKTsKKwl9IAorICAg
ICAJcGFnZS0+bWFwcGluZyA9IE5VTEw7CiAJbWFwcGluZy0+bnJwYWdlcy0tOwogCXBhZ2VjYWNo
ZV9hY2N0KC0xKTsKIH0KQEAgLTM5NSwxMiArNDAxLDE0IEBACiBpbnQgYWRkX3RvX3BhZ2VfY2Fj
aGUoc3RydWN0IHBhZ2UgKnBhZ2UsIHN0cnVjdCBhZGRyZXNzX3NwYWNlICptYXBwaW5nLAogCQlw
Z29mZl90IG9mZnNldCwgZ2ZwX3QgZ2ZwX21hc2spCiB7Ci0JaW50IGVycm9yID0gcmFkaXhfdHJl
ZV9wcmVsb2FkKGdmcF9tYXNrICYgfl9fR0ZQX0hJR0hNRU0pOwotCi0JaWYgKGVycm9yID09IDAp
IHsKKyAgICAgICAgaW50IGJ0cmVlX2Vycm9yID0gYnRyZWVfcHJlbG9hZChnZnBfbWFzayAmIH5f
X0dGUF9ISUdITUVNKTsKKyAgICAgICAgCisJaWYgKGJ0cmVlX2Vycm9yID09IDApIHsKIAkJd3Jp
dGVfbG9ja19pcnEoJm1hcHBpbmctPnRyZWVfbG9jayk7Ci0JCWVycm9yID0gcmFkaXhfdHJlZV9p
bnNlcnQoJm1hcHBpbmctPnBhZ2VfdHJlZSwgb2Zmc2V0LCBwYWdlKTsKLQkJaWYgKCFlcnJvcikg
eworICAgICAgICAgICAgICAgIGJ0cmVlX2Vycm9yID0gCisJCQlidHJlZV9pbnNlcnQoJm1hcHBp
bmctPmJ0cmVlLG9mZnNldCxwYWdlKTsKKyAgICAgICAgICAgICAgICAKKwkJaWYgKCFidHJlZV9l
cnJvcikgewogCQkJcGFnZV9jYWNoZV9nZXQocGFnZSk7CiAJCQlTZXRQYWdlTG9ja2VkKHBhZ2Up
OwogCQkJcGFnZS0+bWFwcGluZyA9IG1hcHBpbmc7CkBAIC00MDksOSArNDE3LDExIEBACiAJCQlw
YWdlY2FjaGVfYWNjdCgxKTsKIAkJfQogCQl3cml0ZV91bmxvY2tfaXJxKCZtYXBwaW5nLT50cmVl
X2xvY2spOwotCQlyYWRpeF90cmVlX3ByZWxvYWRfZW5kKCk7CisgICAgICAgICAgICAgICAgaWYo
YnRyZWVfZXJyb3IgPT0gMCkgeworICAgICAgICAgICAgICAgICAgICAgICAgYnRyZWVfcHJlbG9h
ZF9lbmQoKTsKKyAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgCiAJfQot
CXJldHVybiBlcnJvcjsKKwlyZXR1cm4gYnRyZWVfZXJyb3I7CiB9CiAKIEVYUE9SVF9TWU1CT0wo
YWRkX3RvX3BhZ2VfY2FjaGUpOwpAQCAtNTIyLDcgKzUzMiw3IEBACiAJc3RydWN0IHBhZ2UgKnBh
Z2U7CiAKIAlyZWFkX2xvY2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwotCXBhZ2UgPSByYWRp
eF90cmVlX2xvb2t1cCgmbWFwcGluZy0+cGFnZV90cmVlLCBvZmZzZXQpOworCXBhZ2UgPSBidHJl
ZV9sb29rdXAoJm1hcHBpbmctPmJ0cmVlLG9mZnNldCk7CiAJaWYgKHBhZ2UpCiAJCXBhZ2VfY2Fj
aGVfZ2V0KHBhZ2UpOwogCXJlYWRfdW5sb2NrX2lycSgmbWFwcGluZy0+dHJlZV9sb2NrKTsKQEAg
LTUzOSw3ICs1NDksNyBAQAogCXN0cnVjdCBwYWdlICpwYWdlOwogCiAJcmVhZF9sb2NrX2lycSgm
bWFwcGluZy0+dHJlZV9sb2NrKTsKLQlwYWdlID0gcmFkaXhfdHJlZV9sb29rdXAoJm1hcHBpbmct
PnBhZ2VfdHJlZSwgb2Zmc2V0KTsKKwlwYWdlID0gYnRyZWVfbG9va3VwKCZtYXBwaW5nLT5idHJl
ZSxvZmZzZXQpOwogCWlmIChwYWdlICYmIFRlc3RTZXRQYWdlTG9ja2VkKHBhZ2UpKQogCQlwYWdl
ID0gTlVMTDsKIAlyZWFkX3VubG9ja19pcnEoJm1hcHBpbmctPnRyZWVfbG9jayk7CkBAIC01NjMs
MTAgKzU3Myw5IEBACiAJCQkJdW5zaWduZWQgbG9uZyBvZmZzZXQpCiB7CiAJc3RydWN0IHBhZ2Ug
KnBhZ2U7Ci0KIAlyZWFkX2xvY2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwogcmVwZWF0Ogot
CXBhZ2UgPSByYWRpeF90cmVlX2xvb2t1cCgmbWFwcGluZy0+cGFnZV90cmVlLCBvZmZzZXQpOwor
CXBhZ2UgPSBidHJlZV9sb29rdXAoJm1hcHBpbmctPmJ0cmVlLG9mZnNldCk7CiAJaWYgKHBhZ2Up
IHsKIAkJcGFnZV9jYWNoZV9nZXQocGFnZSk7CiAJCWlmIChUZXN0U2V0UGFnZUxvY2tlZChwYWdl
KSkgewpAQCAtNjU4LDggKzY2NywxMCBAQAogCXVuc2lnbmVkIGludCByZXQ7CiAKIAlyZWFkX2xv
Y2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwotCXJldCA9IHJhZGl4X3RyZWVfZ2FuZ19sb29r
dXAoJm1hcHBpbmctPnBhZ2VfdHJlZSwKLQkJCQkodm9pZCAqKilwYWdlcywgc3RhcnQsIG5yX3Bh
Z2VzKTsKKworCXJldCA9IGJ0cmVlX2dhbmdfbG9va3VwKCZtYXBwaW5nLT5idHJlZSwodm9pZCAq
KilwYWdlcywKKwkJCQlzdGFydCxucl9wYWdlcyk7CisKIAlmb3IgKGkgPSAwOyBpIDwgcmV0OyBp
KyspCiAJCXBhZ2VfY2FjaGVfZ2V0KHBhZ2VzW2ldKTsKIAlyZWFkX3VubG9ja19pcnEoJm1hcHBp
bmctPnRyZWVfbG9jayk7CkBAIC02NzcsOCArNjg4LDkgQEAKIAl1bnNpZ25lZCBpbnQgcmV0Owog
CiAJcmVhZF9sb2NrX2lycSgmbWFwcGluZy0+dHJlZV9sb2NrKTsKLQlyZXQgPSByYWRpeF90cmVl
X2dhbmdfbG9va3VwX3RhZygmbWFwcGluZy0+cGFnZV90cmVlLAorCXJldCA9IGJ0cmVlX2dhbmdf
bG9va3VwX3RhZygmbWFwcGluZy0+YnRyZWUsCiAJCQkJKHZvaWQgKiopcGFnZXMsICppbmRleCwg
bnJfcGFnZXMsIHRhZyk7CisJCQogCWZvciAoaSA9IDA7IGkgPCByZXQ7IGkrKykKIAkJcGFnZV9j
YWNoZV9nZXQocGFnZXNbaV0pOwogCWlmIChyZXQpCmRpZmYgLXVyTiBsaW51eC0yLjYuMTYuMi9t
bS9wYWdlLXdyaXRlYmFjay5jIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL21tL3BhZ2Utd3JpdGViYWNr
LmMKLS0tIGxpbnV4LTIuNi4xNi4yL21tL3BhZ2Utd3JpdGViYWNrLmMJMjAwNi0wNC0wNyAxMjo1
Njo0Ny4wMDAwMDAwMDAgLTA0MDAKKysrIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL21tL3BhZ2Utd3Jp
dGViYWNrLmMJMjAwNi0wOC0wNiAyMjowODo1MC4wMDAwMDAwMDAgLTA0MDAKQEAgLTYzNCw4ICs2
MzQsMTUgQEAKIAkJCQlCVUdfT04obWFwcGluZzIgIT0gbWFwcGluZyk7CiAJCQkJaWYgKG1hcHBp
bmdfY2FwX2FjY291bnRfZGlydHkobWFwcGluZykpCiAJCQkJCWluY19wYWdlX3N0YXRlKG5yX2Rp
cnR5KTsKLQkJCQlyYWRpeF90cmVlX3RhZ19zZXQoJm1hcHBpbmctPnBhZ2VfdHJlZSwKLQkJCQkJ
cGFnZV9pbmRleChwYWdlKSwgUEFHRUNBQ0hFX1RBR19ESVJUWSk7CisJCQkJYnRyZWVfdGFnX3Nl
dCgmbWFwcGluZy0+YnRyZWUsCisJCQkJcGFnZV9pbmRleChwYWdlKSwgUEFHRUNBQ0hFX1RBR19E
SVJUWSk7CisKKwkJCQlpZiAoYnRyZWVfdGFnX3NldCgmbWFwcGluZy0+YnRyZWUsCisJCQkJcGFn
ZV9pbmRleChwYWdlKSwgUEFHRUNBQ0hFX1RBR19ESVJUWSkgIT0wICkgeworCQkJCQlwYW5pYygi
UHJvYmxlbSBzZXR0aW5nIHRoZSB0YWdcbiIpOworCQkJCX0JCQkJCQorCisJCQkJCiAJCQl9CiAJ
CQl3cml0ZV91bmxvY2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwogCQkJaWYgKG1hcHBpbmct
Pmhvc3QpIHsKQEAgLTcxNCw5ICs3MjEsMTYgQEAKIAlpZiAobWFwcGluZykgewogCQl3cml0ZV9s
b2NrX2lycXNhdmUoJm1hcHBpbmctPnRyZWVfbG9jaywgZmxhZ3MpOwogCQlpZiAoVGVzdENsZWFy
UGFnZURpcnR5KHBhZ2UpKSB7Ci0JCQlyYWRpeF90cmVlX3RhZ19jbGVhcigmbWFwcGluZy0+cGFn
ZV90cmVlLAorCQkJYnRyZWVfdGFnX2NsZWFyKCZtYXBwaW5nLT5idHJlZSwKIAkJCQkJCXBhZ2Vf
aW5kZXgocGFnZSksCiAJCQkJCQlQQUdFQ0FDSEVfVEFHX0RJUlRZKTsKKworCQkJaWYgKGJ0cmVl
X3RhZ19nZXQoJm1hcHBpbmctPmJ0cmVlLAorCQkJCQlwYWdlX2luZGV4KHBhZ2UpLAorCQkJCQlQ
QUdFQ0FDSEVfVEFHX0RJUlRZKSAgPT0gMSkgeworCQkJCXBhbmljKCJQcm9ibGVtIGNsZWFyaW5n
IHRoZSB0YWdcbiIpOworCQkJfQkJCQkKKwogCQkJd3JpdGVfdW5sb2NrX2lycXJlc3RvcmUoJm1h
cHBpbmctPnRyZWVfbG9jaywgZmxhZ3MpOwogCQkJaWYgKG1hcHBpbmdfY2FwX2FjY291bnRfZGly
dHkobWFwcGluZykpCiAJCQkJZGVjX3BhZ2Vfc3RhdGUobnJfZGlydHkpOwpAQCAtNzY5LDEwICs3
ODMsMTcgQEAKIAogCQl3cml0ZV9sb2NrX2lycXNhdmUoJm1hcHBpbmctPnRyZWVfbG9jaywgZmxh
Z3MpOwogCQlyZXQgPSBUZXN0Q2xlYXJQYWdlV3JpdGViYWNrKHBhZ2UpOwotCQlpZiAocmV0KQot
CQkJcmFkaXhfdHJlZV90YWdfY2xlYXIoJm1hcHBpbmctPnBhZ2VfdHJlZSwKKwkJaWYgKHJldCkg
eworCQkJYnRyZWVfdGFnX2NsZWFyKCZtYXBwaW5nLT5idHJlZSwKIAkJCQkJCXBhZ2VfaW5kZXgo
cGFnZSksCiAJCQkJCQlQQUdFQ0FDSEVfVEFHX1dSSVRFQkFDSyk7CisJCQlpZiAoYnRyZWVfdGFn
X2dldCgmbWFwcGluZy0+YnRyZWUsCisJCQkJcGFnZV9pbmRleChwYWdlKSwKKwkJCQlQQUdFQ0FD
SEVfVEFHX1dSSVRFQkFDSykgPT0gMSkgeworCQkJCXBhbmljKCJQcm9ibGVtIGNsZWFyaW5nIHRo
ZSB0YWdcbiIpOworCQkJfQkJCQkKKworCQl9CQkJCiAJCXdyaXRlX3VubG9ja19pcnFyZXN0b3Jl
KCZtYXBwaW5nLT50cmVlX2xvY2ssIGZsYWdzKTsKIAl9IGVsc2UgewogCQlyZXQgPSBUZXN0Q2xl
YXJQYWdlV3JpdGViYWNrKHBhZ2UpOwpAQCAtNzkwLDE0ICs4MTEsMjggQEAKIAogCQl3cml0ZV9s
b2NrX2lycXNhdmUoJm1hcHBpbmctPnRyZWVfbG9jaywgZmxhZ3MpOwogCQlyZXQgPSBUZXN0U2V0
UGFnZVdyaXRlYmFjayhwYWdlKTsKLQkJaWYgKCFyZXQpCi0JCQlyYWRpeF90cmVlX3RhZ19zZXQo
Jm1hcHBpbmctPnBhZ2VfdHJlZSwKKwkJaWYgKCFyZXQpIHsKKwkJCWJ0cmVlX3RhZ19zZXQoJm1h
cHBpbmctPmJ0cmVlLAogCQkJCQkJcGFnZV9pbmRleChwYWdlKSwKIAkJCQkJCVBBR0VDQUNIRV9U
QUdfV1JJVEVCQUNLKTsKLQkJaWYgKCFQYWdlRGlydHkocGFnZSkpCi0JCQlyYWRpeF90cmVlX3Rh
Z19jbGVhcigmbWFwcGluZy0+cGFnZV90cmVlLAorCQkJaWYgKGJ0cmVlX3RhZ19nZXQoJm1hcHBp
bmctPmJ0cmVlLAorCQkJCXBhZ2VfaW5kZXgocGFnZSksCisJCQkJUEFHRUNBQ0hFX1RBR19XUklU
RUJBQ0spICE9IDEpIHsKKwkJCQlwYW5pYygiUHJvYmxlbSBzZXR0aW5nIHRoZSB0YWdcbiIpOwor
CQkJfQkJCQkKKworCQl9CQkJCisJCWlmICghUGFnZURpcnR5KHBhZ2UpKSB7CisJCQlidHJlZV90
YWdfY2xlYXIoJm1hcHBpbmctPmJ0cmVlLAogCQkJCQkJcGFnZV9pbmRleChwYWdlKSwKIAkJCQkJ
CVBBR0VDQUNIRV9UQUdfRElSVFkpOworCQkJaWYgKGJ0cmVlX3RhZ19nZXQoJm1hcHBpbmctPmJ0
cmVlLAorCQkJCXBhZ2VfaW5kZXgocGFnZSksCisJCQkJUEFHRUNBQ0hFX1RBR19ESVJUWSkgPT0g
MSkgeworCQkJCXBhbmljKCJQcm9ibGVtIGNsZWFyaW5nIHRoZSB0YWciKTsKKwkJCX0JCQkJCisK
KwkJfQkJCQogCQl3cml0ZV91bmxvY2tfaXJxcmVzdG9yZSgmbWFwcGluZy0+dHJlZV9sb2NrLCBm
bGFncyk7CiAJfSBlbHNlIHsKIAkJcmV0ID0gVGVzdFNldFBhZ2VXcml0ZWJhY2socGFnZSk7CkBA
IC04MTcsNyArODUyLDcgQEAKIAlpbnQgcmV0OwogCiAJcmVhZF9sb2NrX2lycXNhdmUoJm1hcHBp
bmctPnRyZWVfbG9jaywgZmxhZ3MpOwotCXJldCA9IHJhZGl4X3RyZWVfdGFnZ2VkKCZtYXBwaW5n
LT5wYWdlX3RyZWUsIHRhZyk7CisJcmV0ID0gYnRyZWVfdGFnZ2VkKCZtYXBwaW5nLT5idHJlZSx0
YWcpOwogCXJlYWRfdW5sb2NrX2lycXJlc3RvcmUoJm1hcHBpbmctPnRyZWVfbG9jaywgZmxhZ3Mp
OwogCXJldHVybiByZXQ7CiB9CmRpZmYgLXVyTiBsaW51eC0yLjYuMTYuMi9tbS9yZWFkYWhlYWQu
YyBsaW51eC0yLjYuMTYuMi1idHJlZS9tbS9yZWFkYWhlYWQuYwotLS0gbGludXgtMi42LjE2LjIv
bW0vcmVhZGFoZWFkLmMJMjAwNi0wNC0wNyAxMjo1Njo0Ny4wMDAwMDAwMDAgLTA0MDAKKysrIGxp
bnV4LTIuNi4xNi4yLWJ0cmVlL21tL3JlYWRhaGVhZC5jCTIwMDYtMDgtMDYgMjI6MDQ6MzguMDAw
MDAwMDAwIC0wNDAwCkBAIC0yODIsNyArMjgyLDggQEAKIAkJaWYgKHBhZ2Vfb2Zmc2V0ID4gZW5k
X2luZGV4KQogCQkJYnJlYWs7CiAKLQkJcGFnZSA9IHJhZGl4X3RyZWVfbG9va3VwKCZtYXBwaW5n
LT5wYWdlX3RyZWUsIHBhZ2Vfb2Zmc2V0KTsKKwkJcGFnZSA9IGJ0cmVlX2xvb2t1cCgmbWFwcGlu
Zy0+YnRyZWUscGFnZV9vZmZzZXQpOworCQogCQlpZiAocGFnZSkKIAkJCWNvbnRpbnVlOwogCmRp
ZmYgLXVyTiBsaW51eC0yLjYuMTYuMi9tbS9zd2FwX3N0YXRlLmMgbGludXgtMi42LjE2LjItYnRy
ZWUvbW0vc3dhcF9zdGF0ZS5jCi0tLSBsaW51eC0yLjYuMTYuMi9tbS9zd2FwX3N0YXRlLmMJMjAw
Ni0wNC0wNyAxMjo1Njo0Ny4wMDAwMDAwMDAgLTA0MDAKKysrIGxpbnV4LTIuNi4xNi4yLWJ0cmVl
L21tL3N3YXBfc3RhdGUuYwkyMDA2LTA4LTA2IDIxOjM4OjI1LjAwMDAwMDAwMCAtMDQwMApAQCAt
MzcsNiArMzcsNyBAQAogCiBzdHJ1Y3QgYWRkcmVzc19zcGFjZSBzd2FwcGVyX3NwYWNlID0gewog
CS5wYWdlX3RyZWUJPSBSQURJWF9UUkVFX0lOSVQoR0ZQX0FUT01JQ3xfX0dGUF9OT1dBUk4pLAor
ICAgICAgICAuYnRyZWUgICAgICAgICAgPSBCVFJFRV9JTklUKEdGUF9BVE9NSUN8X19HRlBfTk9X
QVJOKSwgCiAJLnRyZWVfbG9jawk9IFJXX0xPQ0tfVU5MT0NLRUQsCiAJLmFfb3BzCQk9ICZzd2Fw
X2FvcHMsCiAJLmlfbW1hcF9ub25saW5lYXIgPSBMSVNUX0hFQURfSU5JVChzd2FwcGVyX3NwYWNl
LmlfbW1hcF9ub25saW5lYXIpLApAQCAtNzEsMTYgKzcyLDIxIEBACiBzdGF0aWMgaW50IF9fYWRk
X3RvX3N3YXBfY2FjaGUoc3RydWN0IHBhZ2UgKnBhZ2UsIHN3cF9lbnRyeV90IGVudHJ5LAogCQkJ
ICAgICAgIGdmcF90IGdmcF9tYXNrKQogewotCWludCBlcnJvcjsKKwlpbnQgYnRyZWVfZXJyb3I7
CiAKIAlCVUdfT04oUGFnZVN3YXBDYWNoZShwYWdlKSk7CiAJQlVHX09OKFBhZ2VQcml2YXRlKHBh
Z2UpKTsKLQllcnJvciA9IHJhZGl4X3RyZWVfcHJlbG9hZChnZnBfbWFzayk7Ci0JaWYgKCFlcnJv
cikgeworCisgICAgICAgIGJ0cmVlX2Vycm9yID0gYnRyZWVfcHJlbG9hZChnZnBfbWFzayk7CisJ
CisJaWYgKCFidHJlZV9lcnJvcikgewogCQl3cml0ZV9sb2NrX2lycSgmc3dhcHBlcl9zcGFjZS50
cmVlX2xvY2spOwotCQllcnJvciA9IHJhZGl4X3RyZWVfaW5zZXJ0KCZzd2FwcGVyX3NwYWNlLnBh
Z2VfdHJlZSwKKyAgICAgICAgICAgICAgICBpZiAoIWJ0cmVlX2Vycm9yKSB7CisgICAgICAgICAg
ICAgICAgICAgICAgIGJ0cmVlX2Vycm9yID0gYnRyZWVfaW5zZXJ0KCZzd2FwcGVyX3NwYWNlLmJ0
cmVlLAogCQkJCQkJZW50cnkudmFsLCBwYWdlKTsKLQkJaWYgKCFlcnJvcikgeworICAgICAgICAg
ICAgICAgIH0KKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
CisJCWlmICghYnRyZWVfZXJyb3IpIHsKIAkJCXBhZ2VfY2FjaGVfZ2V0KHBhZ2UpOwogCQkJU2V0
UGFnZUxvY2tlZChwYWdlKTsKIAkJCVNldFBhZ2VTd2FwQ2FjaGUocGFnZSk7CkBAIC04OSw5ICs5
NSwxMiBAQAogCQkJcGFnZWNhY2hlX2FjY3QoMSk7CiAJCX0KIAkJd3JpdGVfdW5sb2NrX2lycSgm
c3dhcHBlcl9zcGFjZS50cmVlX2xvY2spOwotCQlyYWRpeF90cmVlX3ByZWxvYWRfZW5kKCk7CisK
KyAgICAgICAgICAgICAgICBpZiAoIWJ0cmVlX2Vycm9yKSB7CisgICAgICAgICAgICAgICAgICAg
ICAgICBidHJlZV9wcmVsb2FkX2VuZCgpOworICAgICAgICAgICAgICAgIH0KIAl9Ci0JcmV0dXJu
IGVycm9yOworCXJldHVybiBidHJlZV9lcnJvcjsKIH0KIAogc3RhdGljIGludCBhZGRfdG9fc3dh
cF9jYWNoZShzdHJ1Y3QgcGFnZSAqcGFnZSwgc3dwX2VudHJ5X3QgZW50cnkpCkBAIC0xMjcsNyAr
MTM2LDEwIEBACiAJQlVHX09OKFBhZ2VXcml0ZWJhY2socGFnZSkpOwogCUJVR19PTihQYWdlUHJp
dmF0ZShwYWdlKSk7CiAKLQlyYWRpeF90cmVlX2RlbGV0ZSgmc3dhcHBlcl9zcGFjZS5wYWdlX3Ry
ZWUsIHBhZ2VfcHJpdmF0ZShwYWdlKSk7CisgICAgICAgIGlmIChidHJlZV9kZWxldGUoJnN3YXBw
ZXJfc3BhY2UuYnRyZWUsc3dhcHBlcl9zcGFjZS5idHJlZS5yb290LAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBwYWdlX3ByaXZhdGUocGFnZSkpLnZhbCAhPSBwYWdlKSB7CisJCXBh
bmljKCJERUJVRzogRGVsZXRpbmcgd3JvbmcgcGFnZSBmcm9tIHN3YXAgY2FjaGVcbiIpOwkJCQor
CX0KIAlzZXRfcGFnZV9wcml2YXRlKHBhZ2UsIDApOwogCUNsZWFyUGFnZVN3YXBDYWNoZShwYWdl
KTsKIAl0b3RhbF9zd2FwY2FjaGVfcGFnZXMtLTsKZGlmZiAtdXJOIGxpbnV4LTIuNi4xNi4yL21t
L3Ztc2Nhbi5jIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL21tL3Ztc2Nhbi5jCi0tLSBsaW51eC0yLjYu
MTYuMi9tbS92bXNjYW4uYwkyMDA2LTA0LTA3IDEyOjU2OjQ3LjAwMDAwMDAwMCAtMDQwMAorKysg
bGludXgtMi42LjE2LjItYnRyZWUvbW0vdm1zY2FuLmMJMjAwNi0wOC0wNiAxNTowODozNC4wMDAw
MDAwMDAgLTA0MDAKQEAgLTY5Miw3ICs2OTIsNyBAQAogCQkJCXN0cnVjdCBwYWdlICpwYWdlLCBp
bnQgbnJfcmVmcykKIHsKIAlzdHJ1Y3QgYWRkcmVzc19zcGFjZSAqbWFwcGluZyA9IHBhZ2VfbWFw
cGluZyhwYWdlKTsKLQlzdHJ1Y3QgcGFnZSAqKnJhZGl4X3BvaW50ZXI7CisJc3RydWN0IHBhZ2Ug
KiBidHJlZV9wb2ludGVyOwogCiAJLyoKIAkgKiBBdm9pZCBkb2luZyBhbnkgb2YgdGhlIGZvbGxv
d2luZyB3b3JrIGlmIHRoZSBwYWdlIGNvdW50CkBAIC03MzMsMTIgKzczMywxMiBAQAogCiAJd3Jp
dGVfbG9ja19pcnEoJm1hcHBpbmctPnRyZWVfbG9jayk7CiAKLQlyYWRpeF9wb2ludGVyID0gKHN0
cnVjdCBwYWdlICoqKXJhZGl4X3RyZWVfbG9va3VwX3Nsb3QoCi0JCQkJCQkmbWFwcGluZy0+cGFn
ZV90cmVlLAorCWJ0cmVlX3BvaW50ZXIgPSAoc3RydWN0IHBhZ2UgKilidHJlZV9sb29rdXBfc2xv
dCgKKwkJCQkJCSZtYXBwaW5nLT5idHJlZSwKIAkJCQkJCXBhZ2VfaW5kZXgocGFnZSkpOwogCiAJ
aWYgKCFwYWdlX21hcHBpbmcocGFnZSkgfHwgcGFnZV9jb3VudChwYWdlKSAhPSBucl9yZWZzIHx8
Ci0JCQkqcmFkaXhfcG9pbnRlciAhPSBwYWdlKSB7CisJCQlidHJlZV9wb2ludGVyICE9IHBhZ2Up
IHsKIAkJd3JpdGVfdW5sb2NrX2lycSgmbWFwcGluZy0+dHJlZV9sb2NrKTsKIAkJcmV0dXJuIC1F
QUdBSU47CiAJfQpAQCAtNzU5LDcgKzc1OSw3IEBACiAJCXNldF9wYWdlX3ByaXZhdGUobmV3cGFn
ZSwgcGFnZV9wcml2YXRlKHBhZ2UpKTsKIAl9CiAKLQkqcmFkaXhfcG9pbnRlciA9IG5ld3BhZ2U7
CisJYnRyZWVfcG9pbnRlciA9IG5ld3BhZ2U7CiAJX19wdXRfcGFnZShwYWdlKTsKIAl3cml0ZV91
bmxvY2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwogCmRpZmYgLXVyTiBsaW51eC0yLjYuMTYu
Mi9saWIvYnRyZWUuYyBsaW51eC0yLjYuMTYuMi1idHJlZS9saWIvYnRyZWUuYwotLS0gbGludXgt
Mi42LjE2LjIvbGliL2J0cmVlLmMJMTk2OS0xMi0zMSAxOTowMDowMC4wMDAwMDAwMDAgLTA1MDAK
KysrIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL2xpYi9idHJlZS5jCTIwMDYtMDgtMDYgMjE6NTc6MzIu
MDAwMDAwMDAwIC0wNDAwCkBAIC0wLDAgKzEsMTI3MyBAQAorLyoKKyAqICBidHJlZS5jCisgKgor
ICogIENvcHlyaWdodCAoQykgMjAwNiBWaXNoYWwgUGF0aWwgKHZpc2hwYXQgQVQgZ21haWwgRE9U
IGNvbSkgCisgKgorKi8KKworI2luY2x1ZGUgPGxpbnV4L2J0cmVlLmg+CisjaW5jbHVkZSA8bGlu
dXgvZXJybm8uaD4KKyNpbmNsdWRlIDxsaW51eC9pbml0Lmg+CisjaW5jbHVkZSA8bGludXgva2Vy
bmVsLmg+CisjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+CisjaW5jbHVkZSA8bGludXgvcmFkaXgt
dHJlZS5oPgorI2luY2x1ZGUgPGxpbnV4L3BlcmNwdS5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIu
aD4KKyNpbmNsdWRlIDxsaW51eC9ub3RpZmllci5oPgorI2luY2x1ZGUgPGxpbnV4L2NwdS5oPiAg
CisjaW5jbHVkZSA8bGludXgvZ2ZwLmg+CisjaW5jbHVkZSA8bGludXgvc3RyaW5nLmg+CisjaW5j
bHVkZSA8bGludXgvYml0b3BzLmg+CisjaW5jbHVkZSA8bGludXgvbW0uaD4KKwordHlwZWRlZiBl
bnVtIHtsZWZ0ID0gLTEscmlnaHQgPSAxfSBwb3NpdGlvbl90OworCit0eXBlZGVmIHN0cnVjdCB7
CisJYnRyZWVfbm9kZSAqIG5vZGU7CisJdW5zaWduZWQgaW50IGluZGV4OworfW5vZGVfcG9zOwor
CitzdHJ1Y3QgYnRyZWVfbm9kZSB7CisJc3RydWN0IGJ0cmVlX25vZGUgKiBuZXh0OwkJICAgICAg
ICAvLyBQb2ludGVyIHVzZWQgZm9yIGxpbmtlZCBsaXN0IAorCWJvb2wgbGVhZjsJCQkgICAgICAg
IC8vIFVzZWQgdG8gaW5kaWNhdGUgd2hldGhlciBsZWFmIG9yIG5vdAorICAgICAgICB1bnNpZ25l
ZCBpbnQgbnJfYWN0aXZlOwkJICAgICAgICAvLyBOdW1iZXIgb2YgYWN0aXZlIGtleXMKKwl1bnNp
Z25lZCBpbnQgbGV2ZWw7CQkgICAgICAgIC8vIExldmVsIGluIHRoZSBCLVRyZWUKKyAgICAgICAg
YnRfa2V5X3ZhbCBrZXlfdmFsc1syKkJUUkVFX09SREVSIC0gMV07CS8vIEFycmF5IG9mIGtleXMg
YW5kIHZhbHVlcworICAgICAgICBzdHJ1Y3QgYnRyZWVfbm9kZSAqIGNoaWxkcmVuWzIqQlRSRUVf
T1JERVJdOwkvLyBBcnJheSBvZiBwb2ludGVycyB0byBjaGlsZCBub2RlcworICAgICAgICB1bnNp
Z25lZCBsb25nIHRhZ3NbQlRSRUVfVEFHU11bQlRSRUVfVEFHX0xPTkdTXTsKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJpdG1hcCByZXF1aXJlZCBi
eSBwYWdlCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAv
LyBjYWNoZQorCXVuc2lnbmVkIGxvbmcgcGFkZGluZ1s2XTsKK30gOworCisvKgorKiAgICAgICBC
LVRyZWUgbm9kZSBhbmQga2V5IHZhbCBjYWNoZQorKi8KK3N0YXRpYyBrbWVtX2NhY2hlX3QgKmJ0
cmVlX25vZGVfY2FjaGVwOworCisvKgorICogUGVyLWNwdSBwb29sIG9mIHByZWxvYWRlZCBub2Rl
cworICovCitzdHJ1Y3QgYnRyZWVfcHJlbG9hZCB7CisgICAgICAgIGludCBucjsKKyAgICAgICAg
c3RydWN0IGJ0cmVlX25vZGUgKm5vZGVzW0JUUkVFX01BWF9QQVRIXTsKK307CitERUZJTkVfUEVS
X0NQVShzdHJ1Y3QgYnRyZWVfcHJlbG9hZCwgYnRyZWVfcHJlbG9hZHMpID0geyAwLCB9OworCitz
dGF0aWMgYnRyZWVfbm9kZSAqIGFsbG9jYXRlX2J0cmVlX25vZGUgKGJ0cmVlICogYnRyZWUsdW5z
aWduZWQgaW50IG9yZGVyKTsKK3N0YXRpYyBub2RlX3BvcyBnZXRfYnRyZWVfbm9kZShidHJlZSAq
IGJ0cmVlLHVuc2lnbmVkIGxvbmcga2V5KTsKK3N0YXRpYyBidF9rZXlfdmFsIHJlbW92ZV9rZXlf
ZnJvbV9sZWFmKGJ0cmVlICogYnRyZWUsIG5vZGVfcG9zICogbm9kZV9wb3MpOworc3RhdGljIGJ0
cmVlX25vZGUgKiBtZXJnZV9ub2RlcyhidHJlZSAqIGJ0cmVlLCBidHJlZV9ub2RlICogbjEsIGJ0
X2tleV92YWwga3YgLAorICAgICAgICBidHJlZV9ub2RlICogbjIpOworc3RhdGljIHZvaWQgbW92
ZV9rZXkoYnRyZWUgKiBidHJlZSwgYnRyZWVfbm9kZSAqIG5vZGUsIHVuc2lnbmVkIGludCBpbmRl
eCwgCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25fdCBw
b3MpOworc3RhdGljIG5vZGVfcG9zIGdldF9tYXhfa2V5X3BvcyhidHJlZSAqIGJ0cmVlLCBidHJl
ZV9ub2RlICogc3VidHJlZSk7CitzdGF0aWMgbm9kZV9wb3MgZ2V0X21pbl9rZXlfcG9zKGJ0cmVl
ICogYnRyZWUsIGJ0cmVlX25vZGUgKiBzdWJ0cmVlKTsKK3N0YXRpYyBidHJlZV9ub2RlICogbWVy
Z2Vfc2libGluZ3MoYnRyZWUgKiBidHJlZSwgYnRyZWVfbm9kZSAqIHBhcmVudCwKKyAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgaW5kZXgscG9zaXRpb25fdCBwb3MpOworc3RhdGlj
IHVuc2lnbmVkIGludCBfX2xvb2t1cChidHJlZSAqIGJ0cmVlLCB2b2lkICoqIHJlc3VsdHMsCisg
ICAgICAgIHVuc2lnbmVkIGxvbmcgZmlyc3RfaW5kZXgsdW5zaWduZWQgaW50IG1heF9pdGVtcywg
aW50IHRhZyk7CitzdGF0aWMgdm9pZCBwcmludF9zaW5nbGVfbm9kZShidHJlZSAqYnRyZWUsIGJ0
cmVlX25vZGUgKiBub2RlKTsgCitzdGF0aWMgdm9pZCB0cmFuc2Zlcl90YWdzKGJ0cmVlX25vZGUg
KiBzb3VyY2Vfbm9kZSwgaW50IHNvdXJjZV9pbmRleCwKKyAgICAgICAgICAgICAgICBidHJlZV9u
b2RlICogZGVzdF9ub2RlLGludCBkZXN0X2luZGV4KTsKK3N0YXRpYyB2b2lkIGNsZWFyX3RhZ3Mo
YnRyZWVfbm9kZSAqIG5vZGUsIGludCBpbmRleCk7CisKK3N0YXRpYyB2b2lkCitidHJlZV9ub2Rl
X2N0b3Iodm9pZCAqbm9kZSwga21lbV9jYWNoZV90ICpjYWNoZXAsIHVuc2lnbmVkIGxvbmcgZmxh
Z3MpIHsKKyAgICAgICAgbWVtc2V0KG5vZGUsIDAsIHNpemVvZihzdHJ1Y3QgYnRyZWVfbm9kZSkp
OworfQorCit2b2lkIF9faW5pdCBidHJlZV9pbml0KHZvaWQpIHsKKyAgICAgICAgYnRyZWVfbm9k
ZV9jYWNoZXAgPSBrbWVtX2NhY2hlX2NyZWF0ZSgiYnRyZWVfbm9kZSIsCisgICAgICAgICAgICAg
ICAgc2l6ZW9mKGJ0cmVlX25vZGUpLCAwLAorICAgICAgICAgICAgICAgIFNMQUJfUEFOSUMsIGJ0
cmVlX25vZGVfY3RvciwgTlVMTCk7Cit9CisKK3Vuc2lnbmVkIGxvbmcgYnRyZWVfa2V5X2ZuICh2
b2lkICogcGFnZSkgeworICAgICAgICByZXR1cm4gKCgoc3RydWN0IHBhZ2UqKXBhZ2UpLT5pbmRl
eCk7Cit9CisKK3Vuc2lnbmVkIGxvbmcgYnRyZWVfdmFsdWVfZm4gKHVuc2lnbmVkIGxvbmcga2V5
KSB7CisgICAgICAgIHJldHVybiAqKCh1bnNpZ25lZCBsb25nKilrZXkpOworfQorCit2b2lkIGJ0
cmVlX3ByaW50X2ZuICh1bnNpZ25lZCBsb25nIGtleSkgeworICAgICAgICBwcmludGsoIiVsdSAi
LCAqKCh1bnNpZ25lZCBsb25nKilrZXkpKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIHRhZ19z
ZXQoc3RydWN0IGJ0cmVlX25vZGUgKm5vZGUsIGludCB0YWcsIGludCBvZmZzZXQpCit7CisgICAg
ICAgIF9fc2V0X2JpdChvZmZzZXQsIG5vZGUtPnRhZ3NbdGFnXSk7Cit9CisKK3N0YXRpYyBpbmxp
bmUgdm9pZCB0YWdfY2xlYXIoc3RydWN0IGJ0cmVlX25vZGUgKm5vZGUsIGludCB0YWcsIGludCBv
ZmZzZXQpCit7CisgICAgICAgIF9fY2xlYXJfYml0KG9mZnNldCwgbm9kZS0+dGFnc1t0YWddKTsK
K30KKworc3RhdGljIGlubGluZSBpbnQgdGFnX2dldChzdHJ1Y3QgYnRyZWVfbm9kZSAqbm9kZSwg
aW50IHRhZywgaW50IG9mZnNldCkKK3sKKyAgICAgICAgcmV0dXJuIHRlc3RfYml0KG9mZnNldCwg
bm9kZS0+dGFnc1t0YWddKTsKK30KKworLyoKKyAqIExvYWQgdXAgdGhpcyBDUFUncyBidHJlZV9u
b2RlIGJ1ZmZlciB3aXRoIHN1ZmZpY2llbnQgb2JqZWN0cyB0bworICogZW5zdXJlIHRoYXQgdGhl
IGFkZGl0aW9uIG9mIGEgc2luZ2xlIGVsZW1lbnQgaW4gdGhlIHRyZWUgY2Fubm90IGZhaWwuICBP
bgorICogc3VjY2VzcywgcmV0dXJuIHplcm8sIHdpdGggcHJlZW1wdGlvbiBkaXNhYmxlZC4gIE9u
IGVycm9yLCByZXR1cm4gLUVOT01FTQorICogd2l0aCBwcmVlbXB0aW9uIG5vdCBkaXNhYmxlZC4K
KyAqLworaW50IGJ0cmVlX3ByZWxvYWQoZ2ZwX3QgZ2ZwX21hc2spIHsKKyAgICAgICAgc3RydWN0
IGJ0cmVlX3ByZWxvYWQgKmJ0cDsKKyAgICAgICAgc3RydWN0IGJ0cmVlX25vZGUgKm5vZGU7Cisg
ICAgICAgIGludCByZXQgPSAtRU5PTUVNOworCisgICAgICAgIHByZWVtcHRfZGlzYWJsZSgpOwor
ICAgICAgICBidHAgPSAmX19nZXRfY3B1X3ZhcihidHJlZV9wcmVsb2Fkcyk7CisgICAgICAgIHdo
aWxlIChidHAtPm5yIDwgQVJSQVlfU0laRShidHAtPm5vZGVzKSkgeworICAgICAgICAgICAgICAg
IHByZWVtcHRfZW5hYmxlKCk7CisgICAgICAgICAgICAgICAgbm9kZSA9IGttZW1fY2FjaGVfYWxs
b2MoYnRyZWVfbm9kZV9jYWNoZXAsIGdmcF9tYXNrKTsKKyAgICAgICAgICAgICAgICBpZiAobm9k
ZSA9PSBOVUxMKQorICAgICAgICAgICAgICAgICAgICAgICAgZ290byBvdXQ7CisgICAgICAgICAg
ICAgICAgcHJlZW1wdF9kaXNhYmxlKCk7CisgICAgICAgICAgICAgICAgYnRwID0gJl9fZ2V0X2Nw
dV92YXIoYnRyZWVfcHJlbG9hZHMpOworICAgICAgICAgICAgICAgIGlmIChidHAtPm5yIDwgQVJS
QVlfU0laRShidHAtPm5vZGVzKSkKKyAgICAgICAgICAgICAgICAgICAgICAgIGJ0cC0+bm9kZXNb
YnRwLT5ucisrXSA9IG5vZGU7CisgICAgICAgICAgICAgICAgZWxzZQorICAgICAgICAgICAgICAg
ICAgICAgICAga21lbV9jYWNoZV9mcmVlKGJ0cmVlX25vZGVfY2FjaGVwLCBub2RlKTsKKyAgICAg
ICAgfQorICAgICAgICByZXQgPSAwOworb3V0OgorICAgICAgICByZXR1cm4gcmV0OworfQorCisv
KioKKyogICAgICAgRnVuY3Rpb24gdXNlZCB0byBhbGxvY2F0ZSBtZW1vcnkgZm9yIHRoZSBidHJl
ZSBub2RlCisqICAgICAgIEBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyogICAgICAgQHBhcmFtIG9y
ZGVyIE9yZGVyIG9mIHRoZSBCLVRyZWUKKyogICAgICAgQHJldHVybiBUaGUgYWxsb2NhdGVkIEIt
dHJlZSBub2RlCisqLworc3RhdGljIGJ0cmVlX25vZGUgKiBhbGxvY2F0ZV9idHJlZV9ub2RlIChi
dHJlZSAqIGJ0cmVlLHVuc2lnbmVkIGludCBvcmRlcikgeworICAgICAgICBidHJlZV9ub2RlICog
bm9kZTsKKworICAgICAgICAvLyBBbGxvY2F0ZSBtZW1vcnkgZm9yIHRoZSBub2RlCisgICAgICAg
IG5vZGUgPSBrbWVtX2NhY2hlX2FsbG9jKGJ0cmVlX25vZGVfY2FjaGVwLGJ0cmVlLT5nZnBfbWFz
ayk7CisKKyAgICAgICAgLy8gSWYgdGhpcyBpcyBOVUxMIGdldCBwcmVsb2FkZWQgbm9kZQorICAg
ICAgICBpZiAobm9kZSAgPT0gTlVMTCAmJiAhKGJ0cmVlLT5nZnBfbWFzayAmIF9fR0ZQX1dBSVQp
KSB7CisgICAgICAgICAgICAgICAgc3RydWN0IGJ0cmVlX3ByZWxvYWQgKmJ0cDsKKworICAgICAg
ICAgICAgICAgIGJ0cCA9ICZfX2dldF9jcHVfdmFyKGJ0cmVlX3ByZWxvYWRzKTsKKyAgICAgICAg
ICAgICAgICBpZiAoYnRwLT5ucikgeworICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGJ0
cC0+bm9kZXNbYnRwLT5uciAtIDFdOworICAgICAgICAgICAgICAgICAgICAgICAgYnRwLT5ub2Rl
c1tidHAtPm5yIC0gMV0gPSBOVUxMOworICAgICAgICAgICAgICAgICAgICAgICAgYnRwLT5uci0t
OworICAgICAgICAgICAgICAgIH0KKyAgICAgICAgfQorICAgICAgIAorICAgICAgICAvLyBJbml0
aWFsaXplIHRoZSBudW1iZXIgb2YgYWN0aXZlIG5vZGVzCisgICAgICAgIG5vZGUtPm5yX2FjdGl2
ZSA9IDA7CisKKwkvLyBVc2UgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgaXQgaXMgYSBsZWFmCisJbm9k
ZS0+bGVhZiA9IHRydWU7CisKKwkvLyBVc2UgdG8gZGV0ZXJtaW5lIHRoZSBsZXZlbCBpbiB0aGUg
dHJlZQorCW5vZGUtPmxldmVsID0gMDsKKworCS8vSW5pdGlhbGl6ZSB0aGUgbGlua2VkIGxpc3Qg
cG9pbnRlciB0byBOVUxMCisJbm9kZS0+bmV4dCA9IE5VTEw7CisKKyAgICAgICAgcmV0dXJuIG5v
ZGU7Cit9CisKKy8qKgorKiAgICAgICBGdW5jdGlvbiB1c2VkIHRvIGZyZWUgdGhlIG1lbW9yeSBh
bGxvY2F0ZWQgdG8gdGhlIGItdHJlZSAKKyogICAgICAgQHBhcmFtIG5vZGUgVGhlIG5vZGUgdG8g
YmUgZnJlZWQKKyogICAgICAgQHBhcmFtIG9yZGVyIE9yZGVyIG9mIHRoZSBCLVRyZWUKKyogICAg
ICAgQHJldHVybiBUaGUgYWxsb2NhdGVkIEItdHJlZSBub2RlCisqLworc3RhdGljIGludCBmcmVl
X2J0cmVlX25vZGUgKGJ0cmVlX25vZGUgKiBub2RlKSB7CisgICAgICAgIGttZW1fY2FjaGVfZnJl
ZShidHJlZV9ub2RlX2NhY2hlcCxub2RlKTsKKyAgICAgICAgcmV0dXJuIDA7Cit9CisKKy8qKgor
KglVc2VkIHRvIHNwbGl0IHRoZSBjaGlsZCBub2RlIGFuZCBhZGp1c3QgdGhlIHBhcmVudCBzbyB0
aGF0CisqCWl0IGhhcyB0d28gY2hpbGRyZW4KKyoJQHBhcmFtIHBhcmVudCBQYXJlbnQgTm9kZQor
KglAcGFyYW0gaW5kZXggSW5kZXggb2YgdGhlIGNoaWxkIG5vZGUKKyoJQHBhcmFtIGNoaWxkICBG
dWxsIGNoaWxkIG5vZGUKKyoJCisqLworc3RhdGljIHZvaWQgYnRyZWVfc3BsaXRfY2hpbGQoYnRy
ZWUgKiBidHJlZSwgYnRyZWVfbm9kZSAqIHBhcmVudCwgCisJCQkJdW5zaWduZWQgaW50IGluZGV4
LAorCQkJCWJ0cmVlX25vZGUgKiBjaGlsZCkgeworCWludCBpID0gMDsJCisJdW5zaWduZWQgaW50
IG9yZGVyID0gYnRyZWUtPm9yZGVyOworCisJYnRyZWVfbm9kZSAqIG5ld19jaGlsZCA9IGFsbG9j
YXRlX2J0cmVlX25vZGUoYnRyZWUsYnRyZWUtPm9yZGVyKTsgCisJbmV3X2NoaWxkLT5sZWFmID0g
Y2hpbGQtPmxlYWY7CisJbmV3X2NoaWxkLT5sZXZlbCA9IGNoaWxkLT5sZXZlbDsKKwluZXdfY2hp
bGQtPm5yX2FjdGl2ZSA9IGJ0cmVlLT5vcmRlciAtIDE7CisKKwkvLyBDb3B5IHRoZSBoaWdoZXIg
b3JkZXIga2V5cyB0byB0aGUgbmV3IGNoaWxkCQorCWZvcihpPTA7aTxvcmRlciAtIDE7aSsrKSB7
CisJCW5ld19jaGlsZC0+a2V5X3ZhbHNbaV0gPSBjaGlsZC0+a2V5X3ZhbHNbaSArIG9yZGVyXTsK
KyAgICAgICAgICAgICAgICB0cmFuc2Zlcl90YWdzKGNoaWxkLGkgKyBvcmRlcixuZXdfY2hpbGQs
aSk7IAorICAgICAgICAgICAgICAgIAorICAgICAgICAgICAgICAgIGlmKCFjaGlsZC0+bGVhZikg
eworCQkJbmV3X2NoaWxkLT5jaGlsZHJlbltpXSA9IAorCQkJCWNoaWxkLT5jaGlsZHJlbltpICsg
b3JkZXJdOworCQl9IAorCX0KKwkKKwkvLyBDb3B5IHRoZSBsYXN0IGNoaWxkIHBvaW50ZXIKKwlp
ZighY2hpbGQtPmxlYWYpIHsKKwkJbmV3X2NoaWxkLT5jaGlsZHJlbltpXSA9IAorCQljaGlsZC0+
Y2hpbGRyZW5baSArIG9yZGVyXTsKKwl9CisKKwljaGlsZC0+bnJfYWN0aXZlID0gb3JkZXIgLSAx
OworCQorCWZvcihpID0gcGFyZW50LT5ucl9hY3RpdmUgKyAxO2kgPiBpbmRleCArIDE7aS0tKSB7
CisJCXBhcmVudC0+Y2hpbGRyZW5baV0gPSBwYXJlbnQtPmNoaWxkcmVuW2kgLSAxXTsKKwl9CisJ
cGFyZW50LT5jaGlsZHJlbltpbmRleCArIDFdID0gbmV3X2NoaWxkOworCisJZm9yKGkgPSBwYXJl
bnQtPm5yX2FjdGl2ZTtpID4gaW5kZXg7aS0tKSB7CisJCXBhcmVudC0+a2V5X3ZhbHNbaV0gPSBw
YXJlbnQtPmtleV92YWxzW2kgLSAxXTsKKyAgICAgICAgICAgICAgICB0cmFuc2Zlcl90YWdzKHBh
cmVudCxpIC0gMSxwYXJlbnQsaSk7ICAgICAgICAgICAgICAgIAorCX0KKworCXBhcmVudC0+a2V5
X3ZhbHNbaW5kZXhdID0gY2hpbGQtPmtleV92YWxzW29yZGVyIC0gMV07CQorICAgICAgICB0cmFu
c2Zlcl90YWdzKGNoaWxkLG9yZGVyIC0gMSxwYXJlbnQsaW5kZXgpOworCXBhcmVudC0+bnJfYWN0
aXZlKys7CisKK30KKworLyoqCisqCVVzZWQgdG8gaW5zZXJ0IGEga2V5IGluIHRoZSBub24tZnVs
bCBub2RlCisqCUBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyoJQHBhcmFtIG5vZGUgVGhlIG5vZGUg
dG8gd2hpY2ggdGhlIGtleSB3aWxsIGJlIGFkZGVkCisqCUBwYXJhbSB0aGUga2V5IHZhbHVlIHBh
aXIKKyoJQHJldHVybiB2b2lkCisqLworCitzdGF0aWMgaW50IGJ0cmVlX2luc2VydF9ub25mdWxs
IChidHJlZSAqIGJ0cmVlLCBidHJlZV9ub2RlICogcGFyZW50X25vZGUsCisJCQkJYnRfa2V5X3Zh
bCAqIGtleV92YWwpIHsKKwkKKwl1bnNpZ25lZCBsb25nIGtleSA9IGtleV92YWwtPmtleTsKKwlp
bnQgaSxqOworCWJ0cmVlX25vZGUgKiBjaGlsZDsJCisJYnRyZWVfbm9kZSAqIG5vZGUgPSBwYXJl
bnRfbm9kZTsKKwkKK2luc2VydDoJaSA9IG5vZGUtPm5yX2FjdGl2ZSAtIDE7CisJaWYobm9kZS0+
bGVhZikgeworCQl3aGlsZShpID49IDAgJiYga2V5IDwgbm9kZS0+a2V5X3ZhbHNbaV0ua2V5KSB7
CisJCQlub2RlLT5rZXlfdmFsc1tpICsgMV0gPSBub2RlLT5rZXlfdmFsc1tpXTsKKyAgICAgICAg
ICAgICAgICAgICAgICAgIHRyYW5zZmVyX3RhZ3Mobm9kZSxpLG5vZGUsaSArIDEpOworCQkJaS0t
OworCQl9CisKKwkJbm9kZS0+a2V5X3ZhbHNbaSArIDFdLmtleSA9IGtleTsKKyAgICAgICAgICAg
ICAgICBub2RlLT5rZXlfdmFsc1tpICsgMV0udmFsID0ga2V5X3ZhbC0+dmFsOworCisJCS8vIElk
ZW50aWNhbCBrZXkgZm91bmQKKyAgICAgICAgICAJaWYgKGkgPj0gMCAmJiAKKwkJCWtleSA9PSBu
b2RlLT5rZXlfdmFsc1tpXS5rZXkpIHsKKyAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9
IGkgKyAxOyBqIDxub2RlLT5ucl9hY3RpdmU7IGorKyApIHsKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgbm9kZS0+a2V5X3ZhbHNbal0gPQorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIG5vZGUtPmtleV92YWxzW2ogKyAxXTsKKwkJCQl0cmFuc2Zlcl90YWdz
KG5vZGUsaixub2RlLGogKyAxKTsKKyAgICAgICAgICAgICAgICAgICAgICAgIH0KKwkJCXJldHVy
biAtRUVYSVNUOworICAgICAgICAgICAgICAgIH0gZWxzZQorCQlub2RlLT5ucl9hY3RpdmUrKzsg
CisJfSBlbHNlIHsKKwkJd2hpbGUgKGkgPj0gMCAmJiBrZXkgPCBub2RlLT5rZXlfdmFsc1tpXS5r
ZXkpIHsKKwkJCWktLTsKKwkJfQorCisgICAgICAgICAgICAgICAgLy8gSWRlbnRpY2FsIGtleSBm
b3VuZCAgCisgICAgICAgICAgICAgICAgaWYgKGkgPj0gMCAmJiBrZXkgPT0gbm9kZS0+a2V5X3Zh
bHNbaV0ua2V5KSB7CisgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLUVFWElTVDsKKyAg
ICAgICAgICAgICAgICB9CisKKwkJaSsrOworCQljaGlsZCA9IG5vZGUtPmNoaWxkcmVuW2ldOyAK
KwkJCisJCWlmKGNoaWxkLT5ucl9hY3RpdmUgPT0gMipidHJlZS0+b3JkZXIgLSAxKSB7CisKKyAJ
CQkvLyBDaGVjayBmb3IgaWRlbnRpY2FsIGtleSBoZXJlCisgICAgICAgICAgICAgICAgICAgICAg
ICBmb3IgKGo9MDtqPGNoaWxkLT5ucl9hY3RpdmU7aisrKSB7CisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGlmIChrZXkgPT0gY2hpbGQtPmtleV92YWxzW2pdLmtleSkgeworICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtRUVYSVNUOworICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB9CisKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgaWYgKGtleSA8IGNoaWxkLT5rZXlfdmFsc1tqXS5rZXkpIHsKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgfQorICAgICAgICAgICAgICAgICAgICAgICAgfQorCisJCQlidHJlZV9zcGxpdF9j
aGlsZChidHJlZSxub2RlLGksY2hpbGQpOworCQkJaWYoa2V5ID4gCisJCQkJbm9kZS0+a2V5X3Zh
bHNbaV0ua2V5KSB7CisJCQkJaSsrOwkKKwkJCX0JCisJCX0KKwkJbm9kZSA9IG5vZGUtPmNoaWxk
cmVuW2ldOworCQlnb3RvIGluc2VydDsJCisJfQorICAgICAgIHJldHVybiAwOwkKK30KKworCisv
KioKKyogICAgICAgRnVuY3Rpb24gdXNlZCB0byBpbnNlcnQgbm9kZSBpbnRvIGEgQi1UcmVlCisq
ICAgICAgIEBwYXJhbSByb290IFJvb3Qgb2YgdGhlIEItVHJlZQorKiAgICAgICBAcGFyYW0gbm9k
ZSBUaGUgbm9kZSB0byBiZSBpbnNlcnRlZAorKiAgICAgICBAcGFyYW0gY29tcGFyZSBGdW5jdGlv
biB1c2VkIHRvIGNvbXBhcmUgdGhlIHR3byBub2RlcyBvZiB0aGUgdHJlZQorKiAgICAgICBAcmV0
dXJuIHN1Y2Nlc3Mgb3IgZmFpbHVyZQorKi8KK2ludCBidHJlZV9pbnNlcnQoYnRyZWUgKiBidHJl
ZSwgdW5zaWduZWQgbG9uZyBrZXksIHZvaWQgKiB2YWwpIHsKKwlidHJlZV9ub2RlICogcm5vZGUg
PSBOVUxMOworICAgICAgICBidF9rZXlfdmFsIGtleV92YWw7CisgICAgICAgIGludCByZXQgPSAt
MTsJCisgICAgICAgCQorICAgICAgICBrZXlfdmFsLmtleSA9IGtleTsKKyAgICAgICAga2V5X3Zh
bC52YWwgPSB2YWw7CisKKyAgICAgICAgLy8gRHVyaW5nIHRoZSBCLXRyZWUgaW5pdGlhbGl6YXRp
b24KKyAgICAgICAgaWYodW5saWtlbHkoYnRyZWUtPnJvb3QgPT0gTlVMTCkpIHsKKyAgICAgICAg
ICAgICAgICBidHJlZS0+cm9vdCA9IGFsbG9jYXRlX2J0cmVlX25vZGUoYnRyZWUsYnRyZWUtPm9y
ZGVyKTsKKyAgICAgICAgfQorICAgICAgICBybm9kZSA9IGJ0cmVlLT5yb290OworCisJaWYocm5v
ZGUtPm5yX2FjdGl2ZSA9PSAoMipidHJlZS0+b3JkZXIgLSAxKSkgeworCQlidHJlZV9ub2RlICog
bmV3X3Jvb3Q7CisJCW5ld19yb290ID0gYWxsb2NhdGVfYnRyZWVfbm9kZShidHJlZSxidHJlZS0+
b3JkZXIpOworCQluZXdfcm9vdC0+bGV2ZWwgPSBidHJlZS0+cm9vdC0+bGV2ZWwgKyAxOworCQli
dHJlZS0+cm9vdCA9IG5ld19yb290OwkKKwkJbmV3X3Jvb3QtPmxlYWYgPSBmYWxzZTsKKwkJbmV3
X3Jvb3QtPm5yX2FjdGl2ZSA9IDA7CisJCW5ld19yb290LT5jaGlsZHJlblswXSAgPSBybm9kZTsK
KwkJYnRyZWVfc3BsaXRfY2hpbGQoYnRyZWUsbmV3X3Jvb3QsMCxybm9kZSk7CisJCXJldCA9IGJ0
cmVlX2luc2VydF9ub25mdWxsKGJ0cmVlLG5ld19yb290LCZrZXlfdmFsKTsJCisJfSBlbHNlCisJ
CXJldCA9IGJ0cmVlX2luc2VydF9ub25mdWxsKGJ0cmVlLHJub2RlLCZrZXlfdmFsKTsJCQorICAg
ICAgICByZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTChidHJlZV9pbnNlcnQpOyAgICAgICAg
CisKKy8qKgorKglVc2VkIHRvIGdldCB0aGUgcG9zaXRpb24gb2YgdGhlIE1BWCBrZXkgd2l0aGlu
IHRoZSBzdWJ0cmVlCisqCUBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyoJQHBhcmFtIHN1YnRyZWUg
VGhlIHN1YnRyZWUgdG8gYmUgc2VhcmNoZWQKKyoJQHJldHVybiBUaGUgbm9kZSBjb250YWluaW5n
IHRoZSBrZXkgYW5kIHBvc2l0aW9uIG9mIHRoZSBrZXkKKyovCitzdGF0aWMgbm9kZV9wb3MgZ2V0
X21heF9rZXlfcG9zKGJ0cmVlICogYnRyZWUsIGJ0cmVlX25vZGUgKiBzdWJ0cmVlKSB7CisJbm9k
ZV9wb3Mgbm9kZV9wb3M7CisJYnRyZWVfbm9kZSAqIG5vZGUgPSBzdWJ0cmVlOyAKKwkKKwlub2Rl
X3Bvcy5ub2RlID0gTlVMTDsKKwlub2RlX3Bvcy5pbmRleCA9IDA7CisKKwl3aGlsZSh0cnVlKSB7
CisJCWlmKG5vZGUgPT0gTlVMTCkgeworCQkJYnJlYWs7CisJCX0KKworCQlpZihub2RlLT5sZWFm
KSB7CisJCQlub2RlX3Bvcy5ub2RlIAk9IG5vZGU7CisJCQlub2RlX3Bvcy5pbmRleCAJPSBub2Rl
LT5ucl9hY3RpdmUgLSAxOworCQkJcmV0dXJuIG5vZGVfcG9zOwkKKwkJfSBlbHNlIHsKKwkJCW5v
ZGVfcG9zLm5vZGUgCT0gbm9kZTsKKwkJCW5vZGVfcG9zLmluZGV4IAk9IG5vZGUtPm5yX2FjdGl2
ZSAtIDE7CisJCQlub2RlID0gbm9kZS0+Y2hpbGRyZW5bbm9kZS0+bnJfYWN0aXZlXTsJCisJCX0K
Kwl9CisJcmV0dXJuIG5vZGVfcG9zOworfQorCisvKioKKyoJVXNlZCB0byBnZXQgdGhlIHBvc2l0
aW9uIG9mIHRoZSBNQVgga2V5IHdpdGhpbiB0aGUgc3VidHJlZQorKglAcGFyYW0gYnRyZWUgVGhl
IGJ0cmVlCisqCUBwYXJhbSBzdWJ0cmVlIFRoZSBzdWJ0cmVlIHRvIGJlIHNlYXJjaGVkCisqCUBy
ZXR1cm4gVGhlIG5vZGUgY29udGFpbmluZyB0aGUga2V5IGFuZCBwb3NpdGlvbiBvZiB0aGUga2V5
CisqLworc3RhdGljIG5vZGVfcG9zIGdldF9taW5fa2V5X3BvcyhidHJlZSAqIGJ0cmVlLCBidHJl
ZV9ub2RlICogc3VidHJlZSkgeworCW5vZGVfcG9zIG5vZGVfcG9zOworCWJ0cmVlX25vZGUgKiBu
b2RlID0gc3VidHJlZTsgCisKKwlub2RlX3Bvcy5ub2RlID0gTlVMTDsKKwlub2RlX3Bvcy5pbmRl
eCA9IDA7CisKKwl3aGlsZSh0cnVlKSB7CisJCWlmKG5vZGUgPT0gTlVMTCkgeworCQkJYnJlYWs7
CisJCX0KKworCQlpZihub2RlLT5sZWFmKSB7CisJCQlub2RlX3Bvcy5ub2RlIAk9IG5vZGU7CisJ
CQlub2RlX3Bvcy5pbmRleCAJPSAwOworCQkJcmV0dXJuIG5vZGVfcG9zOwkKKwkJfSBlbHNlIHsK
KwkJCW5vZGVfcG9zLm5vZGUgCT0gbm9kZTsKKwkJCW5vZGVfcG9zLmluZGV4IAk9IDA7CisJCQlu
b2RlID0gbm9kZS0+Y2hpbGRyZW5bMF07CQorCQl9CisJfQorCXJldHVybiBub2RlX3BvczsKK30K
KworLyoqCisqCU1lcmdlIG5vZGVzIG4xIGFuZCBuMiAoY2FzZSAzYiBmcm9tIENvcm1lbikKKyoJ
QHBhcmFtIGJ0cmVlIFRoZSBidHJlZSAKKyoJQHBhcmFtIG5vZGUgVGhlIHBhcmVudCBub2RlIAor
KglAcGFyYW0gaW5kZXggb2YgdGhlIGNoaWxkCisqCUBwYXJhbSBwb3MgbGVmdCBvciByaWdodAor
KglAcmV0dXJuIG5vbmUgCisqLworc3RhdGljIGJ0cmVlX25vZGUgKiBtZXJnZV9zaWJsaW5ncyhi
dHJlZSAqIGJ0cmVlLCBidHJlZV9ub2RlICogcGFyZW50LCB1bnNpZ25lZCBpbnQgaW5kZXggLCAK
KwkJCQkJcG9zaXRpb25fdCBwb3MpIHsKKwl1bnNpZ25lZCBpbnQgajsKKwlidHJlZV9ub2RlICog
bmV3X25vZGU7CisJYnRyZWVfbm9kZSAqIG4xLCAqIG4yOworICAgICAgICAKKyAgICAgICAgaWYg
KGluZGV4ID09IChwYXJlbnQtPm5yX2FjdGl2ZSkpIHsgICAKKyAgICAgICAgICAgICAgIGluZGV4
LS07CisJICAgICAgIG4xID0gcGFyZW50LT5jaGlsZHJlbltwYXJlbnQtPm5yX2FjdGl2ZSAtIDFd
OworCSAgICAgICBuMiA9IHBhcmVudC0+Y2hpbGRyZW5bcGFyZW50LT5ucl9hY3RpdmVdOworICAg
ICAgICB9IGVsc2UgeworICAgICAgICAgICAgICAgbjEgPSBwYXJlbnQtPmNoaWxkcmVuW2luZGV4
XTsKKwkgICAgICAgbjIgPSBwYXJlbnQtPmNoaWxkcmVuW2luZGV4ICsgMV07CisgICAgICAgIH0K
KworCS8vTWVyZ2UgdGhlIGN1cnJlbnQgbm9kZSB3aXRoIHRoZSBsZWZ0IG5vZGUKKwluZXdfbm9k
ZSA9IGFsbG9jYXRlX2J0cmVlX25vZGUoYnRyZWUsYnRyZWUtPm9yZGVyKTsKKwluZXdfbm9kZS0+
bGV2ZWwgPSBuMS0+bGV2ZWw7CisJbmV3X25vZGUtPmxlYWYgPSBuMS0+bGVhZjsKKworCWZvcihq
PTA7ajxidHJlZS0+b3JkZXIgLSAxOyBqKyspIHsKKwkJbmV3X25vZGUtPmtleV92YWxzW2pdID0J
bjEtPmtleV92YWxzW2pdOworICAgICAgICAgICAgICAgIHRyYW5zZmVyX3RhZ3MobjEsaixuZXdf
bm9kZSxqKTsKKwkJbmV3X25vZGUtPmNoaWxkcmVuW2pdID0JbjEtPmNoaWxkcmVuW2pdOworCX0K
KwkKKwluZXdfbm9kZS0+a2V5X3ZhbHNbYnRyZWUtPm9yZGVyIC0gMV0gPQlwYXJlbnQtPmtleV92
YWxzW2luZGV4XTsKKyAgICAgICAgdHJhbnNmZXJfdGFncyhwYXJlbnQsaW5kZXgsbmV3X25vZGUs
YnRyZWUtPm9yZGVyIC0gMSk7CisJbmV3X25vZGUtPmNoaWxkcmVuW2J0cmVlLT5vcmRlciAtIDFd
ID0JbjEtPmNoaWxkcmVuW2J0cmVlLT5vcmRlciAtIDFdOworCisJZm9yKGo9MDtqPGJ0cmVlLT5v
cmRlciAtIDE7IGorKykgeworCQluZXdfbm9kZS0+a2V5X3ZhbHNbaiArIGJ0cmVlLT5vcmRlcl0g
PSAJbjItPmtleV92YWxzW2pdOworICAgICAgICAgICAgICAgIHRyYW5zZmVyX3RhZ3MobjIsaixu
ZXdfbm9kZSxqICsgYnRyZWUtPm9yZGVyKTsKKwkJbmV3X25vZGUtPmNoaWxkcmVuW2ogKyBidHJl
ZS0+b3JkZXJdID0gCW4yLT5jaGlsZHJlbltqXTsKKwl9CisJbmV3X25vZGUtPmNoaWxkcmVuWzIq
YnRyZWUtPm9yZGVyIC0gMV0gPSBuMi0+Y2hpbGRyZW5bYnRyZWUtPm9yZGVyIC0gMV07CisKKwlw
YXJlbnQtPmNoaWxkcmVuW2luZGV4XSA9IG5ld19ub2RlOworCisJZm9yKGogPSBpbmRleDtqPHBh
cmVudC0+bnJfYWN0aXZlO2orKykgeworCQlwYXJlbnQtPmtleV92YWxzW2pdID0gcGFyZW50LT5r
ZXlfdmFsc1tqICsgMV07CisgICAgICAgICAgICAgICAgdHJhbnNmZXJfdGFncyhwYXJlbnQsaiAr
IDEscGFyZW50LGopOworCQlwYXJlbnQtPmNoaWxkcmVuW2ogKyAxXSA9IHBhcmVudC0+Y2hpbGRy
ZW5baiArIDJdOworCX0KKworCW5ld19ub2RlLT5ucl9hY3RpdmUgPSBuMS0+bnJfYWN0aXZlICsg
bjItPm5yX2FjdGl2ZSArIDE7CisJcGFyZW50LT5ucl9hY3RpdmUtLTsKKworCWZyZWVfYnRyZWVf
bm9kZShuMSk7CisJZnJlZV9idHJlZV9ub2RlKG4yKTsKKworCWlmIChwYXJlbnQtPm5yX2FjdGl2
ZSA9PSAwICYmIGJ0cmVlLT5yb290ID09IHBhcmVudCkgeworCQlmcmVlX2J0cmVlX25vZGUocGFy
ZW50KTsKKwkJYnRyZWUtPnJvb3QgPSBuZXdfbm9kZTsKKwkJaWYobmV3X25vZGUtPmxldmVsKQor
CQkJbmV3X25vZGUtPmxlYWYgPSBmYWxzZTsKKwkJZWxzZQorCQkJbmV3X25vZGUtPmxlYWYgPSB0
cnVlOyAKKwl9CisKKwlyZXR1cm4gbmV3X25vZGU7Cit9CisKKy8qKgorKglNb3ZlIHRoZSBrZXkg
ZnJvbSBub2RlIHRvIGFub3RoZXIJCisqCUBwYXJhbSBidHJlZSBUaGUgQi1UcmVlCisqCUBwYXJh
bSBub2RlIFRoZSBwYXJlbnQgbm9kZQorKglAcGFyYW0gaW5kZXggb2YgdGhlIGtleSB0byBiZSBt
b3ZlZCBkb25lIAorKglAcGFyYW0gcG9zIHRoZSBwb3NpdGlvbiBvZiB0aGUgY2hpbGQgdG8gcmVj
ZWl2ZSB0aGUga2V5IAorKglAcmV0dXJuIG5vbmUKKyovCitzdGF0aWMgdm9pZCBtb3ZlX2tleShi
dHJlZSAqIGJ0cmVlLCBidHJlZV9ub2RlICogbm9kZSwgdW5zaWduZWQgaW50IGluZGV4LCBwb3Np
dGlvbl90IHBvcykgeworCWJ0cmVlX25vZGUgKiBsY2hpbGQ7CisJYnRyZWVfbm9kZSAqIHJjaGls
ZDsKKwl1bnNpZ25lZCBpbnQgaTsKKworCWlmKHBvcyA9PSByaWdodCkgeworCQlpbmRleC0tOwor
CX0KKwlsY2hpbGQgPSBub2RlLT5jaGlsZHJlbltpbmRleF07CisJcmNoaWxkID0gbm9kZS0+Y2hp
bGRyZW5baW5kZXggKyAxXTsKKwkKKwkvLyBNb3ZlIHRoZSBrZXkgZnJvbSB0aGUgcGFyZW50IHRv
IHRoZSBsZWZ0IGNoaWxkCisJaWYocG9zID09IGxlZnQpIHsKKwkJbGNoaWxkLT5rZXlfdmFsc1ts
Y2hpbGQtPm5yX2FjdGl2ZV0gPSBub2RlLT5rZXlfdmFsc1tpbmRleF07CisgICAgICAgICAgICAg
ICAgdHJhbnNmZXJfdGFncyhub2RlLGluZGV4LGxjaGlsZCxsY2hpbGQtPm5yX2FjdGl2ZSk7CisK
KwkJbGNoaWxkLT5jaGlsZHJlbltsY2hpbGQtPm5yX2FjdGl2ZSArIDFdID0gcmNoaWxkLT5jaGls
ZHJlblswXTsKKwkJcmNoaWxkLT5jaGlsZHJlblswXSA9IE5VTEw7CisJCWxjaGlsZC0+bnJfYWN0
aXZlKys7CisKKwkJbm9kZS0+a2V5X3ZhbHNbaW5kZXhdID0gcmNoaWxkLT5rZXlfdmFsc1swXTsK
KyAgICAgICAgICAgICAgICB0cmFuc2Zlcl90YWdzKHJjaGlsZCwwLG5vZGUsaW5kZXgpOworICAg
ICAgICAgICAgICAgIAorCQlmb3IoaT0wO2k8cmNoaWxkLT5ucl9hY3RpdmUgLSAxO2krKykgewor
CQkJcmNoaWxkLT5rZXlfdmFsc1tpXSA9IHJjaGlsZC0+a2V5X3ZhbHNbaSArIDFdOworICAgICAg
ICAgICAgICAgICAgICAgICAgdHJhbnNmZXJfdGFncyhyY2hpbGQsaSArIDEscmNoaWxkLGkpOwor
CQkJcmNoaWxkLT5jaGlsZHJlbltpXSA9IHJjaGlsZC0+Y2hpbGRyZW5baSArIDFdOworCQl9CisJ
CXJjaGlsZC0+Y2hpbGRyZW5bcmNoaWxkLT5ucl9hY3RpdmUgLSAxXSA9IAorCQkJCXJjaGlsZC0+
Y2hpbGRyZW5bcmNoaWxkLT5ucl9hY3RpdmVdOworCQlyY2hpbGQtPm5yX2FjdGl2ZS0tOworCX0g
ZWxzZSB7CisJCS8vIE1vdmUgdGhlIGtleSBmcm9tIHRoZSBwYXJlbnQgdG8gdGhlIHJpZ2h0IGNo
aWxkCisJCWZvcihpPXJjaGlsZC0+bnJfYWN0aXZlO2kgPiAwIDsgaS0tKSB7CisJCQlyY2hpbGQt
PmtleV92YWxzW2ldID0gcmNoaWxkLT5rZXlfdmFsc1tpIC0gMV07CisgICAgICAgICAgICAgICAg
ICAgICAgICB0cmFuc2Zlcl90YWdzKHJjaGlsZCxpIC0gMSxyY2hpbGQsaSk7CisJCQlyY2hpbGQt
PmNoaWxkcmVuW2kgKyAxXSA9IHJjaGlsZC0+Y2hpbGRyZW5baV07CQkKKwkJfQorCQlyY2hpbGQt
PmNoaWxkcmVuWzFdID0gcmNoaWxkLT5jaGlsZHJlblswXTsJCQorCQlyY2hpbGQtPmNoaWxkcmVu
WzBdID0gTlVMTDsKKworCQlyY2hpbGQtPmtleV92YWxzWzBdID0gbm9kZS0+a2V5X3ZhbHNbaW5k
ZXhdOworICAgICAgICAgICAgICAgIHRyYW5zZmVyX3RhZ3Mobm9kZSxpbmRleCxyY2hpbGQsMCk7
CisKKwkJcmNoaWxkLT5jaGlsZHJlblswXSA9IGxjaGlsZC0+Y2hpbGRyZW5bbGNoaWxkLT5ucl9h
Y3RpdmVdOwkKKwkJbGNoaWxkLT5jaGlsZHJlbltsY2hpbGQtPm5yX2FjdGl2ZV0gPSBOVUxMOwor
CisJCW5vZGUtPmtleV92YWxzW2luZGV4XSA9IGxjaGlsZC0+a2V5X3ZhbHNbbGNoaWxkLT5ucl9h
Y3RpdmUgLSAxXTsKKwkJdHJhbnNmZXJfdGFncyhsY2hpbGQsbGNoaWxkLT5ucl9hY3RpdmUgLSAx
LG5vZGUsaW5kZXgpOworICAgICAgICAgICAgICAgIAorCQlsY2hpbGQtPm5yX2FjdGl2ZS0tOwor
CQlyY2hpbGQtPm5yX2FjdGl2ZSsrOwkJCisJfQkJCQkKK30KKworLyoqCisqCU1lcmdlIG5vZGVz
IG4xIGFuZCBuMgorKglAcGFyYW0gbjEgRmlyc3Qgbm9kZQorKglAcGFyYW0gbjIgU2Vjb25kIG5v
ZGUKKyoJQHJldHVybiBjb21iaW5lZCBub2RlCisqLworc3RhdGljIGJ0cmVlX25vZGUgKiBtZXJn
ZV9ub2RlcyhidHJlZSAqIGJ0cmVlLCBidHJlZV9ub2RlICogbjEsIGJ0X2tleV92YWwga3YsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidHJlZV9ub2Rl
ICogbjIpIHsKKwlidHJlZV9ub2RlICogbmV3X25vZGU7CisJdW5zaWduZWQgaW50IGk7CQorCisJ
bmV3X25vZGUgPSBhbGxvY2F0ZV9idHJlZV9ub2RlKGJ0cmVlLGJ0cmVlLT5vcmRlcik7CisJbmV3
X25vZGUtPmxlYWYgPSB0cnVlOworCQorCWZvcihpPTA7aTxuMS0+bnJfYWN0aXZlO2krKykgewor
CQluZXdfbm9kZS0+a2V5X3ZhbHNbaV0gICA9IG4xLT5rZXlfdmFsc1tpXTsKKyAgICAgICAgICAg
ICAgICB0cmFuc2Zlcl90YWdzKG4xLGksbmV3X25vZGUsaSk7CisgICAgICAgICAgICAgICAgbmV3
X25vZGUtPmNoaWxkcmVuW2ldICAgPSBuMS0+Y2hpbGRyZW5baV07CisJfQorICAgICAgICBuZXdf
bm9kZS0+Y2hpbGRyZW5bbjEtPm5yX2FjdGl2ZV0gPSBuMS0+Y2hpbGRyZW5bbjEtPm5yX2FjdGl2
ZV07CisgICAgICAgIG5ld19ub2RlLT5rZXlfdmFsc1tuMS0+bnJfYWN0aXZlXSA9IGt2OworCisJ
Zm9yKGk9MDtpPG4yLT5ucl9hY3RpdmU7aSsrKSB7CisJCW5ld19ub2RlLT5rZXlfdmFsc1tpICsg
bjEtPm5yX2FjdGl2ZSArIDFdID0gbjItPmtleV92YWxzW2ldOworICAgICAgICAgICAgICAgIHRy
YW5zZmVyX3RhZ3MobjIsaSxuZXdfbm9kZSxpICsgbjEtPm5yX2FjdGl2ZSArIDEpOworICAgICAg
ICAgICAgICAgIG5ld19ub2RlLT5jaGlsZHJlbltpICsgbjEtPm5yX2FjdGl2ZSArIDFdID0gbjIt
PmNoaWxkcmVuW2ldOworCX0KKyAgICAgICAgbmV3X25vZGUtPmNoaWxkcmVuWzIqYnRyZWUtPm9y
ZGVyIC0gMV0gPSBuMi0+Y2hpbGRyZW5bbjItPm5yX2FjdGl2ZV07CisJCisgICAgICAgIG5ld19u
b2RlLT5ucl9hY3RpdmUgPSBuMS0+bnJfYWN0aXZlICsgbjItPm5yX2FjdGl2ZSArIDE7CisgICAg
ICAgIG5ld19ub2RlLT5sZWFmID0gbjEtPmxlYWY7CisgICAgICAgIG5ld19ub2RlLT5sZXZlbCA9
IG4xLT5sZXZlbDsKKworCWZyZWVfYnRyZWVfbm9kZShuMSk7CisJZnJlZV9idHJlZV9ub2RlKG4y
KTsKKworCXJldHVybiBuZXdfbm9kZTsKK30KKworLyoqCisqCVVzZWQgdG8gcmVtb3ZlIGEga2V5
IGZyb20gdGhlIEItdHJlZSBub2RlCisqCUBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyoJQHBhcmFt
IG5vZGUgVGhlIG5vZGUgZnJvbSB3aGljaCB0aGUga2V5IGlzIHRvIGJlIHJlbW92ZWQgCQorKglA
cGFyYW0ga2V5IFRoZSBrZXkgdG8gYmUgcmVtb3ZlZAorKglAcmV0dXJuIDAgb24gc3VjY2VzcyAt
MSBvbiBlcnJvciAKKyovCisKK2J0X2tleV92YWwgcmVtb3ZlX2tleV9mcm9tX2xlYWYoYnRyZWUg
KiBidHJlZSwgbm9kZV9wb3MgKiBub2RlX3BvcykgeworCXVuc2lnbmVkIGludCBrZXlzX21heCA9
IDIqYnRyZWUtPm9yZGVyIC0gMTsKKwl1bnNpZ25lZCBpbnQgaTsKKwlidF9rZXlfdmFsIGtleV92
YWw7CisJYnRyZWVfbm9kZSAqIG5vZGUgPSBub2RlX3Bvcy0+bm9kZTsKKworICAgICAgICBrZXlf
dmFsLmtleSA9IC0xOworICAgICAgICBrZXlfdmFsLnZhbCA9IE5VTEw7CisKKwlpZihub2RlLT5s
ZWFmID09IGZhbHNlKSB7CisJCXJldHVybiBrZXlfdmFsOworCX0JCisJCisJa2V5X3ZhbCA9IG5v
ZGUtPmtleV92YWxzW25vZGVfcG9zLT5pbmRleF07CisKKwlmb3IoaT1ub2RlX3Bvcy0+aW5kZXg7
aTwga2V5c19tYXggLSAxO2krKykgeworCQlub2RlLT5rZXlfdmFsc1tpXSA9IG5vZGUtPmtleV92
YWxzW2kgKyAxXTsKKyAgICAgICAgICAgICAgICB0cmFuc2Zlcl90YWdzKG5vZGUsaSArIDEsbm9k
ZSxpKTsKKwl9CisJCisJbm9kZS0+bnJfYWN0aXZlLS07CisKKwlpZihub2RlLT5ucl9hY3RpdmUg
PT0gMCApIHsKKyAgICAgICAgICAgICAgICBpZiAoYnRyZWUtPnJvb3QgPT0gbm9kZSkgeworICAg
ICAgICAgICAgICAgICAgICAgICAgYnRyZWUtPnJvb3QgPSBOVUxMOworICAgICAgICAgICAgICAg
IH0KKwkJZnJlZV9idHJlZV9ub2RlKG5vZGUpOworCX0KKwlyZXR1cm4ga2V5X3ZhbDsKK30KKwor
LyoqCisqICAgICAgIEZ1bmN0aW9uIHVzZWQgdG8gcmVtb3ZlIGEgbm9kZSBmcm9tIGEgIEItVHJl
ZQorKiAgICAgICBAcGFyYW0gYnRyZWUgVGhlIEItVHJlZQorKiAgICAgICBAcGFyYW0ga2V5IEtl
eSBvZiB0aGUgbm9kZSB0byBiZSByZW1vdmVkCisqICAgICAgIEBwYXJhbSB2YWx1ZSBmdW5jdGlv
biB0byBtYXAgdGhlIGtleSB0byBhbiB1bmlxdWUgaW50ZWdlciB2YWx1ZSAgICAgICAgCisqICAg
ICAgIEBwYXJhbSBjb21wYXJlIEZ1bmN0aW9uIHVzZWQgdG8gY29tcGFyZSB0aGUgdHdvIG5vZGVz
IG9mIHRoZSB0cmVlCisqICAgICAgIEByZXR1cm4gVGhlIHJlbW92ZWQga2V5IHZhbHVlIHBhaXIg
CisqLworCitidF9rZXlfdmFsIGJ0cmVlX2RlbGV0ZShidHJlZSAqIGJ0cmVlLGJ0cmVlX25vZGUg
KiBzdWJ0cmVlLHVuc2lnbmVkIGxvbmcga2V5KSB7CisJdW5zaWduZWQgaW50IGksaW5kZXg7CisJ
YnRyZWVfbm9kZSAqIG5vZGUgPSBOVUxMLCAqIHJzaWJsaW5nLCAqbHNpYmxpbmc7CisJYnRyZWVf
bm9kZSAqIGNvbWJfbm9kZSwgKiBwYXJlbnQ7CisJbm9kZV9wb3Mgc3ViX25vZGVfcG9zOworCW5v
ZGVfcG9zIG5vZGVfcG9zOworCWJ0X2tleV92YWwga2V5X3ZhbCwgcmVtb3ZlZF9rdix0b19yZW1v
dmVfa3Y7CisJdW5zaWduZWQgbG9uZyBrdiA9IGtleTsJCisKKwlub2RlID0gc3VidHJlZTsKKwlw
YXJlbnQgPSBOVUxMOworCXJlbW92ZWRfa3Yua2V5ID0gLTE7CisJcmVtb3ZlZF9rdi52YWwgPSBO
VUxMOwkKKworCS8vIEVtcHR5IHN1YnRyZWUKKwlpZiAobm9kZSA9PSBOVUxMKSB7CisJCXJldHVy
biByZW1vdmVkX2t2OworCX0KKworZGVsX2xvb3A6Zm9yIChpID0gMDs7aSA9IDApIHsKKyAgICAg
ICAgICAgICAKKyAgICAgICAgICAgIC8vSWYgdGhlcmUgYXJlIG5vIGtleXMgc2ltcGx5IHJldHVy
bgorICAgICAgICAgICAgaWYoIW5vZGUtPm5yX2FjdGl2ZSkKKyAgICAgICAgICAgICAgICByZXR1
cm4gcmVtb3ZlZF9rdjsKKworCSAgICAvLyBGaXggdGhlIGluZGV4IG9mIHRoZSBrZXkgZ3JlYXRl
ciB0aGFuIG9yIGVxdWFsCisJICAgIC8vIHRvIHRoZSBrZXkgdGhhdCB3ZSB3b3VsZCBsaWtlIHRv
IHNlYXJjaAorCQkKKwkgICAgd2hpbGUgKGkgPCBub2RlLT5ucl9hY3RpdmUgJiYga3YgPiAKKwkJ
CSAgICBub2RlLT5rZXlfdmFsc1tpXS5rZXkpIHsKKwkJICAgIGkrKzsKKwkgICAgfQorCSAgICBp
bmRleCA9IGk7CisKKwkgICAgLy8gSWYgd2UgZmluZCBzdWNoIGtleSBicmVhawkJICAgIAorCSAg
ICBpZihpIDwgbm9kZS0+bnJfYWN0aXZlICYmIAorCQkJa3YgPT0gbm9kZS0+a2V5X3ZhbHNbaV0u
a2V5KSB7CisJCQlicmVhazsKKwkgICAgfQorICAgICAgICAgICAgaWYobm9kZS0+bGVhZikKKyAg
ICAgICAgICAgICAgICByZXR1cm4gcmVtb3ZlZF9rdjsKKyAgICAgICAgICAgICAgICAKKyAgICAJ
ICAgIC8vU3RvcmUgdGhlIHBhcmVudCBub2RlCisJICAgIHBhcmVudCA9IG5vZGU7CisKKwkgICAg
Ly8gVG8gZ2V0IGEgY2hpbGQgbm9kZSAKKwkgICAgbm9kZSA9IG5vZGUtPmNoaWxkcmVuW2ldOwor
CisgICAgICAgICAgICAvL0lmIE5VTEwgbm90IGZvdW5kCisgICAgICAgICAgICBpZiAobm9kZSA9
PSBOVUxMKQorICAgICAgICAgICAgICAgIHJldHVybiByZW1vdmVkX2t2OworCisgICAgICAgICAg
ICBpZiAoaW5kZXggPT0gKHBhcmVudC0+bnJfYWN0aXZlKSkgeyAgIAorICAgICAgICAgICAgICAg
IGxzaWJsaW5nID0gIHBhcmVudC0+Y2hpbGRyZW5bcGFyZW50LT5ucl9hY3RpdmUgLSAxXTsKKwkg
ICAgCXJzaWJsaW5nID0gTlVMTDsgCisgICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09IDAp
IHsKKyAgICAgICAgICAgICAgICBsc2libGluZyA9IE5VTEw7CisgICAgICAgICAgICAgICAgcnNp
YmxpbmcgPSBwYXJlbnQtPmNoaWxkcmVuWzFdOworICAgICAgICAgICAgfSBlbHNlIHsKKyAgICAg
ICAgCWxzaWJsaW5nID0gcGFyZW50LT5jaGlsZHJlbltpIC0gMV07CisJICAgIAlyc2libGluZyA9
IHBhcmVudC0+Y2hpbGRyZW5baSArIDFdOworICAgICAgICAgICAgfQorCisJICAgIGlmIChub2Rl
LT5ucl9hY3RpdmUgPT0gYnRyZWUtPm9yZGVyIC0gMSAmJiBwYXJlbnQpIHsKKwkJLy8gVGhlIGN1
cnJlbnQgbm9kZSBoYXMgKHQgLSAxKSBrZXlzIGJ1dCB0aGUgcmlnaHQgc2libGluZyBoYXMgPiAo
dCAtIDEpCisJCS8vIGtleXMKKwkJaWYgKHJzaWJsaW5nICYmIChyc2libGluZy0+bnJfYWN0aXZl
ID4gYnRyZWUtPm9yZGVyIC0gMSkpIHsKKwkJCW1vdmVfa2V5KGJ0cmVlLHBhcmVudCxpLGxlZnQp
OworCQl9IGVsc2UKKwkJLy8gVGhlIGN1cnJlbnQgbm9kZSBoYXMgKHQgLSAxKSBrZXlzIGJ1dCB0
aGUgbGVmdCBzaWJsaW5nIGhhcyAodCAtIDEpCisJCS8vIGtleXMKKwkJaWYgKGxzaWJsaW5nICYm
IChsc2libGluZy0+bnJfYWN0aXZlID4gYnRyZWUtPm9yZGVyIC0gMSkpIHsKKwkJCW1vdmVfa2V5
KGJ0cmVlLHBhcmVudCxpLHJpZ2h0KTsKKwkJfSBlbHNlCisJCS8vIExlZnQgc2libGluZyBoYXMg
KHQgLSAxKSBrZXlzCisJICAgICAgICBpZihsc2libGluZyAmJiAobHNpYmxpbmctPm5yX2FjdGl2
ZSA9PSBidHJlZS0+b3JkZXIgLSAxKSkgeworCQkgICAgICAgIG5vZGUgPSBtZXJnZV9zaWJsaW5n
cyhidHJlZSxwYXJlbnQsaSxsZWZ0KTsKKwkJfSBlbHNlCisgICAgICAgICAgICAgICAgLy8gUmln
aHQgc2libGluZyBoYXMgKHQgLSAxKSBrZXlzCisJICAgICAgICBpZihyc2libGluZyAmJiAocnNp
YmxpbmctPm5yX2FjdGl2ZSA9PSBidHJlZS0+b3JkZXIgLSAxKSkgeworCQkgICAgICAgIG5vZGUg
PSBtZXJnZV9zaWJsaW5ncyhidHJlZSxwYXJlbnQsaSxyaWdodCk7CisJCX0KKwkgICAgfQorICAg
ICAgICB9ICAgICAgICAgICAgCisJCisJLy9DYXNlIDEgOiBUaGUgbm9kZSBjb250YWluaW5nIHRo
ZSBrZXkgaXMgZm91bmQgYW5kIGlzIHRoZSBsZWFmIG5vZGUuCisJLy9BbHNvIHRoZSBsZWFmIG5v
ZGUgaGFzIGtleXMgZ3JlYXRlciB0aGFuIHRoZSBtaW5pbXVtIHJlcXVpcmVkLgorCS8vU2ltcGx5
IHJlbW92ZSB0aGUga2V5CisJaWYobm9kZS0+bGVhZiAmJiAobm9kZS0+bnJfYWN0aXZlID4gYnRy
ZWUtPm9yZGVyIC0gMSkpIHsKKwkJbm9kZV9wb3Mubm9kZSA9IG5vZGU7CisJCW5vZGVfcG9zLmlu
ZGV4ID0gaW5kZXg7CisJCXJldHVybiByZW1vdmVfa2V5X2Zyb21fbGVhZihidHJlZSwmbm9kZV9w
b3MpOworCX0KKworCS8vSWYgdGhlIGxlYWYgbm9kZSBpcyB0aGUgcm9vdCBwZXJtaXQgZGVsZXRp
b24gZXZlbiBpZiB0aGUgbnVtYmVyIG9mIGtleXMgaXMKKwkvL2xlc3MgdGhhbiAodCAtIDEpCisJ
aWYobm9kZS0+bGVhZiAmJiAobm9kZSA9PSBidHJlZS0+cm9vdCkpIHsKKwkJbm9kZV9wb3Mubm9k
ZSA9IG5vZGU7CisJCW5vZGVfcG9zLmluZGV4ID0gaW5kZXg7CisJCXJldHVybiByZW1vdmVfa2V5
X2Zyb21fbGVhZihidHJlZSwmbm9kZV9wb3MpOworCX0KKworCisJLy9DYXNlIDI6IFRoZSBub2Rl
IGNvbnRhaW5pbmcgdGhlIGtleSBpcyBmb3VuZCBhbmQgaXMgYW4gaW50ZXJuYWwgbm9kZQorCWlm
KG5vZGUtPmxlYWYgPT0gZmFsc2UpIHsKKwkJaWYobm9kZS0+Y2hpbGRyZW5baW5kZXhdLT5ucl9h
Y3RpdmUgPiBidHJlZS0+b3JkZXIgLSAxICkgeworCQkJdG9fcmVtb3ZlX2t2ID0gbm9kZS0+a2V5
X3ZhbHNbaW5kZXhdOworCisJCQlzdWJfbm9kZV9wb3MgPSAKKwkJCQlnZXRfbWF4X2tleV9wb3Mo
YnRyZWUsbm9kZS0+Y2hpbGRyZW5baW5kZXhdKTsKKyAgICAgICAgICAgICAgICAgICAgICAgIGtl
eV92YWwgPSAKKwkJCQlzdWJfbm9kZV9wb3Mubm9kZS0+a2V5X3ZhbHNbc3ViX25vZGVfcG9zLmlu
ZGV4XTsKKyAgICAgICAgCQlub2RlLT5rZXlfdmFsc1tpbmRleF0gPSBrZXlfdmFsOwkKKyAgICAg
ICAgICAgICAgICAgICAgICAgIHRyYW5zZmVyX3RhZ3Mobm9kZSxpbmRleCxzdWJfbm9kZV9wb3Mu
bm9kZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViX25vZGVfcG9zLmluZGV4
KTsKKworCQkJc3ViX25vZGVfcG9zLm5vZGUtPmtleV92YWxzW3N1Yl9ub2RlX3Bvcy5pbmRleF0g
PSAKKwkJCQl0b19yZW1vdmVfa3Y7CisgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9k
ZS0+Y2hpbGRyZW5baW5kZXhdOworICAgICAgICAgICAgICAgICAgICAgICAgZ290byBkZWxfbG9v
cDsKKyAgICAgICAgICAgICAgIAorCQl9IGVsc2UgaWYgKChub2RlLT5jaGlsZHJlbltpbmRleCAr
IDFdLT5ucl9hY3RpdmUgPiBidHJlZS0+b3JkZXIgLSAxKSApIHsKKwkJCXRvX3JlbW92ZV9rdiA9
IG5vZGUtPmtleV92YWxzW2luZGV4XTsKKworCQkJc3ViX25vZGVfcG9zID0gCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGdldF9taW5fa2V5X3BvcyhidHJlZSxub2RlLT5jaGlsZHJl
bltpbmRleCArIDFdKTsKKyAgICAgICAgICAgICAgICAgICAgICAgIGtleV92YWwgPSBzdWJfbm9k
ZV9wb3Mubm9kZS0+a2V5X3ZhbHNbc3ViX25vZGVfcG9zLmluZGV4XTsKKyAgICAgICAgCQlub2Rl
LT5rZXlfdmFsc1tpbmRleF0gPSBrZXlfdmFsOwkKKyAgICAgICAgICAgICAgICAgICAgICAgIHRy
YW5zZmVyX3RhZ3Mobm9kZSxpbmRleCxzdWJfbm9kZV9wb3Mubm9kZSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgc3ViX25vZGVfcG9zLmluZGV4KTsKKworCQkJc3ViX25vZGVfcG9z
Lm5vZGUtPmtleV92YWxzW3N1Yl9ub2RlX3Bvcy5pbmRleF0gPSAKKwkJCQl0b19yZW1vdmVfa3Y7
CisKKyAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLT5jaGlsZHJlbltpbmRleCAr
IDFdOworICAgICAgICAgICAgICAgICAgICAgICAgZ290byBkZWxfbG9vcDsKKyAgICAgICAgICAg
ICAgCisJCX0gZWxzZSBpZiAoIAorCQkJbm9kZS0+Y2hpbGRyZW5baW5kZXhdLT5ucl9hY3RpdmUg
PT0gYnRyZWUtPm9yZGVyIC0gMSAmJgorCQkJbm9kZS0+Y2hpbGRyZW5baW5kZXggKyAxXS0+bnJf
YWN0aXZlID09IGJ0cmVlLT5vcmRlciAtIDEpIHsKKworCQkJY29tYl9ub2RlID0gbWVyZ2Vfbm9k
ZXMoYnRyZWUsbm9kZS0+Y2hpbGRyZW5baW5kZXhdLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBub2RlLT5rZXlfdmFsc1tpbmRleF0sCisJCQkJbm9kZS0+Y2hpbGRyZW5baW5kZXgg
KyAxXSk7CisJCQlub2RlLT5jaGlsZHJlbltpbmRleF0gPSBjb21iX25vZGU7CisJCQkKKwkJCWZv
cihpPWluZGV4ICsgMTtpPG5vZGUtPm5yX2FjdGl2ZTtpKyspIHsKKwkJCQlub2RlLT5jaGlsZHJl
bltpXSA9IG5vZGUtPmNoaWxkcmVuW2kgKyAxXTsKKwkJCQlub2RlLT5rZXlfdmFsc1tpIC0gMV0g
PSBub2RlLT5rZXlfdmFsc1tpXTsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJh
bnNmZXJfdGFncyhub2RlLGksbm9kZSxpIC0gMSk7CisJCQl9CisJCQlub2RlLT5ucl9hY3RpdmUt
LTsKKyAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLT5ucl9hY3RpdmUgPT0gMCAmJiBi
dHJlZS0+cm9vdCA9PSBub2RlKSB7CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZy
ZWVfYnRyZWVfbm9kZShub2RlKTsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnRy
ZWUtPnJvb3QgPSBjb21iX25vZGU7ICAgICAgICAKKyAgICAgICAgICAgICAgICAgICAgICAgIH0g
CisgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY29tYl9ub2RlOworICAgICAgICAgICAg
ICAgICAgICAgICAgZ290byBkZWxfbG9vcDsKKwkJfQkJCisgICAgICAgICAgfQorCQorCS8vIENh
c2UgMzoKKwkvLyBJbiB0aGlzIGNhc2Ugc3RhcnQgZnJvbSB0aGUgdG9wIG9mIHRoZSB0cmVlIGFu
ZCBjb250aW51ZQorCS8vIG1vdmluZyB0byB0aGUgbGVhZiBub2RlIG1ha2luZyBzdXJlIHRoYXQg
ZWFjaCBub2RlIHRoYXQKKwkvLyB3ZSBlbmNvdW50ZXIgb24gdGhlIHdheSBoYXMgYXRsZWFzdCAn
dCcgKG9yZGVyIG9mIHRoZSB0cmVlKQorCS8vIGtleXMgCisJaWYobm9kZS0+bGVhZiAmJiAobm9k
ZS0+bnJfYWN0aXZlID4gYnRyZWUtPm9yZGVyIC0gMSkpIHsKKwkgICAgICBub2RlX3Bvcy5ub2Rl
ID0gbm9kZTsKKwkgICAgICBub2RlX3Bvcy5pbmRleCA9IGluZGV4OworCSAgICAgIHJldHVybiBy
ZW1vdmVfa2V5X2Zyb21fbGVhZihidHJlZSwmbm9kZV9wb3MpOworCX0KKworICAgICAgICByZXR1
cm4gcmVtb3ZlZF9rdjsKK30KKworLyoqCisqCUZ1bmN0aW9uIHVzZWQgdG8gZ2V0IHRoZSBub2Rl
IGNvbnRhaW5pbmcgdGhlIGdpdmVuIGtleQorKglAcGFyYW0gYnRyZWUgVGhlIGJ0cmVlIHRvIGJl
IHNlYXJjaGVkCisqCUBwYXJhbSBrZXkgVGhlIHRoZSBrZXkgdG8gYmUgc2VhcmNoZWQKKyoJQHJl
dHVybiBUaGUgbm9kZSBhbmQgcG9zaXRpb24gb2YgdGhlIGtleSB3aXRoaW4gdGhlIG5vZGUgCisq
Lworbm9kZV9wb3MgIGdldF9idHJlZV9ub2RlKGJ0cmVlICogYnRyZWUsdW5zaWduZWQgbG9uZyBr
ZXkpIHsKKwlub2RlX3BvcyBrcDsKKwl1bnNpZ25lZCBsb25nIGtleV92YWwgPSBrZXk7CQorCWJ0
cmVlX25vZGUgKiBub2RlOworCXVuc2lnbmVkIGludCBpID0gMDsKKworCW5vZGUgPSBidHJlZS0+
cm9vdDsKKwlrcC5ub2RlID0gTlVMTDsKKwlrcC5pbmRleCA9IDA7CisKKwkvLyBFbXB0eSB0cmVl
CisJaWYgKG5vZGUgPT0gTlVMTCkgeworCQlyZXR1cm4ga3A7CisJfQkKKwkKKwlmb3IgKDs7aSA9
IDApIHsJCisKKwkgICAgLy8gRml4IHRoZSBpbmRleCBvZiB0aGUga2V5IGdyZWF0ZXIgdGhhbiBv
ciBlcXVhbAorCSAgICAvLyB0byB0aGUga2V5IHRoYXQgd2Ugd291bGQgbGlrZSB0byBzZWFyY2gK
KwkJCisJICAgIHdoaWxlIChpIDwgbm9kZS0+bnJfYWN0aXZlICYmIGtleV92YWwgPiAKKwkJCSAg
ICBub2RlLT5rZXlfdmFsc1tpXS5rZXkgKSB7CisJCSAgICBpKys7CisJICAgIH0KKworCSAgICAv
LyBJZiB3ZSBmaW5kIHN1Y2gga2V5IHJldHVybiB0aGUga2V5LXZhbHVlIHBhaXIJCSAgICAKKwkg
ICAgaWYoaSA8IG5vZGUtPm5yX2FjdGl2ZSAmJiAKKwkJCWtleV92YWwgPT0gbm9kZS0+a2V5X3Zh
bHNbaV0ua2V5KSB7CisJCSAgICBrcC5ub2RlID0gbm9kZTsKKwkJICAgIGtwLmluZGV4ID0gaTsJ
CisJCSAgICByZXR1cm4ga3A7CisJICAgIH0KKwkKKwkgICAgLy8gSWYgdGhlIG5vZGUgaXMgbGVh
ZiBhbmQgaWYgd2UgZGlkIG5vdCBmaW5kIHRoZSBrZXkgCisJICAgIC8vIHJldHVybiBOVUxMCisJ
ICAgIGlmKG5vZGUtPmxlYWYpIHsKKwkJICAgIHJldHVybiBrcDsKKwkgICAgfQorCisJICAgIC8v
IFRvIGdvdCBhIGNoaWxkIG5vZGUgCisJICAgIG5vZGUgPSBub2RlLT5jaGlsZHJlbltpXTsKKwl9
CisgICAgICAJcmV0dXJuIGtwOworCit9CisKKy8qKgorKiAgICAgICBVc2VkIHRvIGRlc3Rvcnkg
YnRyZWUKKyogICAgICAgQHBhcmFtIGJ0cmVlIFRoZSBCLXRyZWUKKyogICAgICAgQHJldHVybiBu
b25lCisqLwordm9pZCBidHJlZV9kZXN0cm95KGJ0cmVlICogYnRyZWUpIHsKKyAgICAgICBpbnQg
aSA9IDA7CisgICAgICAgdW5zaWduZWQgaW50IGN1cnJlbnRfbGV2ZWw7CisKKyAgICAgICBidHJl
ZV9ub2RlICogaGVhZCwgKiB0YWlsLCAqIG5vZGU7CisgICAgICAgYnRyZWVfbm9kZSAqIGNoaWxk
LCAqIGRlbF9ub2RlOworCisgICAgICAgbm9kZSA9IGJ0cmVlLT5yb290OworICAgICAgIGN1cnJl
bnRfbGV2ZWwgPSBub2RlLT5sZXZlbDsKKyAgICAgICBoZWFkID0gbm9kZTsKKyAgICAgICB0YWls
ID0gbm9kZTsKKworICAgICAgIHdoaWxlKHRydWUpIHsKKyAgICAgICAgICAgICAgIGlmKGhlYWQg
PT0gTlVMTCkgeworICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgICAg
IH0KKyAgICAgICAgICAgICAgIGlmIChoZWFkLT5sZXZlbCA8IGN1cnJlbnRfbGV2ZWwpIHsKKyAg
ICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9sZXZlbCA9IGhlYWQtPmxldmVsOworICAgICAg
ICAgICAgICAgfQorCisgICAgICAgICAgICAgICBpZihoZWFkLT5sZWFmID09IGZhbHNlKSB7Cisg
ICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCA7IGkgPCBoZWFkLT5ucl9hY3RpdmUgKyAx
OyBpKyspIHsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGhlYWQtPmNo
aWxkcmVuW2ldOworICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhaWwtPm5leHQgPSBj
aGlsZDsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWlsID0gY2hpbGQ7CisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQtPm5leHQgPSBOVUxMOworICAgICAgICAg
ICAgICAgICAgICAgICB9CisgICAgICAgICAgICAgICB9CisgICAgICAgICAgICAgICBkZWxfbm9k
ZSA9IGhlYWQ7CisgICAgICAgICAgICAgICBoZWFkID0gaGVhZC0+bmV4dDsKKyAgICAgICAgICAg
ICAgIGZyZWVfYnRyZWVfbm9kZShkZWxfbm9kZSk7CisgICAgICAgfQorCit9CisKK2ludCBidHJl
ZV90YWdnZWQoYnRyZWUgKiBidHJlZSwgaW50IHRhZykgeworICAgICAgICBpbnQgaSA9IDA7Cisg
ICAgICAgIGJ0cmVlX25vZGUgKiBoZWFkLCAqIHRhaWw7CisgICAgICAgIGJ0cmVlX25vZGUgKiBj
aGlsZDsKKworICAgICAgICBoZWFkID0gYnRyZWUtPnJvb3Q7CisgICAgICAgIHRhaWwgPSBidHJl
ZS0+cm9vdDsKKworICAgICAgICB3aGlsZSh0cnVlKSB7CisgICAgICAgICAgICAgICAgaWYoaGVh
ZCA9PSBOVUxMKSB7CisgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAg
ICAgICB9CisKKyAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGVhZC0+bnJfYWN0aXZl
OyBpKysgKSB7CisgICAgICAgICAgICAgICAgICAKKyAgICAgICAgICAgICAgICAgIGlmICh0YWcg
IT0gLTEgJiYgdGFnX2dldChoZWFkLHRhZyxpKSkgCisgICAgICAgICAgICAgICAgICAgICByZXR1
cm4gMTsKKyAgICAgICAgICAgICAgICAgIAorICAgICAgICAgICAgICAgIH0gICAgIAorCisgICAg
ICAgICAgICAgICAgaWYoaGVhZC0+bGVhZiA9PSBmYWxzZSkgeworICAgICAgICAgICAgICAgICAg
ICAgICAgZm9yKGkgPSAwIDsgaSA8IGhlYWQtPm5yX2FjdGl2ZSArIDE7IGkrKykgeworICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGhlYWQtPmNoaWxkcmVuW2ldOworICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWlsLT5uZXh0ID0gY2hpbGQ7CisgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHRhaWwgPSBjaGlsZDsKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgY2hpbGQtPm5leHQgPSBOVUxMOworICAgICAgICAgICAgICAgICAgICAg
ICAgfQorICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICAgICBoZWFkID0gaGVhZC0+bmV4
dDsKKyAgICAgICAgfQorICAgICAgICByZXR1cm4gMDsKK30KK0VYUE9SVF9TWU1CT0woYnRyZWVf
dGFnZ2VkKTsKKworLyoKKyAqIFJldHVybnMgMSBpZiBhbnkgc2xvdCBpbiB0aGUgbm9kZSBoYXMg
dGhpcyB0YWcgc2V0LgorICogT3RoZXJ3aXNlIHJldHVybnMgMC4KKyAqLworc3RhdGljIGlubGlu
ZSBpbnQgYW55X3RhZ19zZXQoc3RydWN0IGJ0cmVlX25vZGUgKm5vZGUsIGludCB0YWcpCit7Cisg
ICAgICAgIGludCBpZHg7CisgICAgICAgIGZvciAoaWR4ID0gMDsgaWR4IDwgQlRSRUVfVEFHX0xP
TkdTOyBpZHgrKykgeworICAgICAgICAgICAgICAgIGlmIChub2RlLT50YWdzW3RhZ11baWR4XSkK
KyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxOworICAgICAgICB9CisgICAgICAgIHJl
dHVybiAwOworfQorCitzdGF0aWMgdm9pZCBjbGVhcl90YWdzKGJ0cmVlX25vZGUgKiBub2RlLCBp
bnQgaW5kZXgpIHsKKwkgaW50IHRhZzsKKyAgICAgICAgZm9yICh0YWcgPSAwO3RhZzwgQlRSRUVf
VEFHUzsgdGFnKyspIHsKKwkJdGFnX2NsZWFyKG5vZGUsdGFnLGluZGV4KTsKKyAgICAgICAgfQor
fQorCitzdGF0aWMgdm9pZCB0cmFuc2Zlcl90YWdzKGJ0cmVlX25vZGUgKiBzb3VyY2Vfbm9kZSwg
aW50IHNvdXJjZV9pbmRleCwKKyAgICAgICAgICAgICAgICBidHJlZV9ub2RlICogZGVzdF9ub2Rl
LGludCBkZXN0X2luZGV4KSB7CisKKyAgICAgICAgaW50IHRhZzsKKyAgICAgICAgZm9yICh0YWcg
PSAwO3RhZzwgQlRSRUVfVEFHUzsgdGFnKyspIHsKKyAgICAgICAgICAgICAgICBpZiAodGFnX2dl
dChzb3VyY2Vfbm9kZSx0YWcsc291cmNlX2luZGV4KSkgeworICAgICAgICAgICAgICAgICAgICAg
ICAgdGFnX3NldChkZXN0X25vZGUsdGFnLGRlc3RfaW5kZXgpOworICAgICAgICAgICAgICAgICAg
ICAgICAgdGFnX2NsZWFyKHNvdXJjZV9ub2RlLHRhZyxzb3VyY2VfaW5kZXgpOworICAgICAgICAg
ICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICAgICAgICAgICAgICB0YWdfY2xlYXIoZGVzdF9u
b2RlLHRhZyxkZXN0X2luZGV4KTsKKyAgICAgICAgICAgICAgICB9CisgICAgICAgIH0KK30KKwor
c3RhdGljIHVuc2lnbmVkIGludCBfX2xvb2t1cChidHJlZSAqIGJ0cmVlLCB2b2lkICoqIHJlc3Vs
dHMsCisgICAgICAgIHVuc2lnbmVkIGxvbmcgZmlyc3RfaW5kZXgsdW5zaWduZWQgaW50IG1heF9p
dGVtcywgaW50IHRhZykgeworCisgICAgICAgIGludCBpID0gMCwgaiA9IDA7CisgICAgICAgIGlu
dCByZXQgPSAwOworICAgICAgICB1bnNpZ25lZCBsb25nIGtleTsKKyAgICAgICAgYnRyZWVfbm9k
ZSAqIGhlYWQsICogdGFpbDsKKyAgICAgICAgYnRyZWVfbm9kZSAqIGNoaWxkOworCisgICAgICAg
IGhlYWQgPSBidHJlZS0+cm9vdDsKKyAgICAgICAgdGFpbCA9IGJ0cmVlLT5yb290OworCisgICAg
ICAgIHdoaWxlKHRydWUpIHsKKyAgICAgICAgICAgICAgICBpZihoZWFkID09IE5VTEwpIHsKKyAg
ICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgICAgIH0KKworICAgICAg
ICAgICAgICAgIGlmICgoaGVhZC0+a2V5X3ZhbHNbaGVhZC0+bnJfYWN0aXZlIC0gMV0ua2V5IAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA+PSBmaXJzdF9pbmRleCkgJiYgKHJldCA8
IG1heF9pdGVtcykpIHsKKyAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGVhZC0+
bnJfYWN0aXZlOyBpKysgKSB7CisgICAgICAgICAgICAgICAgICAgICAKKyAgICAgICAgICAgICAg
ICAgICAgIGlmICh0YWcgIT0gLTEgJiYgIXRhZ19nZXQoaGVhZCx0YWcsaSkpIAorICAgICAgICAg
ICAgICAgICAgICAgICAgY29udGludWU7CisgICAgICAgICAgICAgICAgICAgICAKKyAgICAgICAg
ICAgICAgICAgICAgIGlmICgoa2V5ID0gaGVhZC0+a2V5X3ZhbHNbaV0ua2V5KSAKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID49IGZpcnN0X2luZGV4KSB7
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2VydGlvbiBzb3J0ICAgICAg
ICAgICAgICAgIAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAocmV0
IC0gMSk7aj49MDtqLS0pIHsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
aWYgKGJ0cmVlLT5rZXkocmVzdWx0c1tqXSkgPiBrZXkpIHsKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbaiArIDFdID0KKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzW2pdOyAgICAK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIH0KKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgcmVzdWx0c1srK2pdID0gaGVhZC0+a2V5X3ZhbHNbaV0udmFsOyAK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0Kys7CisKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgaWYocmV0ID09IG1heF9pdGVtcykgeworICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB9CisgICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAKKyAgICAgICAgICAg
ICAgICAgICB9ICAgICAKKyAgICAgICAgICAgICAgICB9CisKKyAgICAgICAgICAgICAgICBpZiho
ZWFkLT5sZWFmID09IGZhbHNlKSB7CisgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDAg
OyBpIDwgaGVhZC0+bnJfYWN0aXZlICsgMTsgaSsrKSB7CisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGNoaWxkID0gaGVhZC0+Y2hpbGRyZW5baV07CisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHRhaWwtPm5leHQgPSBjaGlsZDsKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdGFpbCA9IGNoaWxkOworICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBj
aGlsZC0+bmV4dCA9IE5VTEw7CisgICAgICAgICAgICAgICAgICAgICAgICB9CisgICAgICAgICAg
ICAgICAgfQorICAgICAgICAgICAgICAgIGhlYWQgPSBoZWFkLT5uZXh0OworICAgICAgICB9Cisg
ICAgICAgIHJldHVybiByZXQ7Cit9CisKKy8qKgorKiAgICAgICBQZXJmb3JtIG11bHRpcGxlIGxv
b2t1cCBvbiB0aGUgQi1UcmVlCisqICAgICAgIEBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyogICAg
ICAgQHBhcmFtIHJlc3VsdHMgd2hlcmUgdGhlIHJlc3VsdHMgd2lsbCBiZSBwbGFjZWQKKyogICAg
ICAgQHBhcmFtIGZpcnN0X2luZGV4IHN0YXJ0IHRoZSBsb29rdXAgZnJvbSB0aGlzIHRyZWUKKyog
ICAgICAgQHBhcmFtIG1heF9pdGVtcyBQbGFjZSB1cHRvIHRoZXNlIG1hbnkgaXRlbXMgaW4gcmVz
dWx0cworKiAgICAgICBAcmV0dXJuIFRoZSBudW1iZXIgb2YgaXRlbXMgZm91bmQKKyovCit1bnNp
Z25lZCBpbnQgYnRyZWVfZ2FuZ19sb29rdXAoYnRyZWUgKiBidHJlZSwgdm9pZCAqKiByZXN1bHRz
LAorICAgICAgICB1bnNpZ25lZCBsb25nIGZpcnN0X2luZGV4LHVuc2lnbmVkIGludCBtYXhfaXRl
bXMpIHsKKyAgICAgICAgcmV0dXJuIF9fbG9va3VwKGJ0cmVlLHJlc3VsdHMsZmlyc3RfaW5kZXgs
bWF4X2l0ZW1zLCAtMSk7Cit9CisKKworRVhQT1JUX1NZTUJPTChidHJlZV9nYW5nX2xvb2t1cCk7
CisKKy8qKgorKiAgICAgICBQZXJmb3JtIG11bHRpcGxlIGxvb2t1cCBvbiB0aGUgQi1UcmVlCisq
ICAgICAgIEBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyogICAgICAgQHBhcmFtIHJlc3VsdHMgd2hl
cmUgdGhlIHJlc3VsdHMgd2lsbCBiZSBwbGFjZWQKKyogICAgICAgQHBhcmFtIGZpcnN0X2luZGV4
IHN0YXJ0IHRoZSBsb29rdXAgZnJvbSB0aGlzIHRyZWUKKyogICAgICAgQHBhcmFtIG1heF9pdGVt
cyBQbGFjZSB1cHRvIHRoZXNlIG1hbnkgaXRlbXMgaW4gcmVzdWx0cworKiAgICAgICBAcmV0dXJu
IFRoZSBudW1iZXIgb2YgaXRlbXMgZm91bmQKKyovCit1bnNpZ25lZCBpbnQgYnRyZWVfZ2FuZ19s
b29rdXBfdGFnKGJ0cmVlICogYnRyZWUsIHZvaWQgKiogcmVzdWx0cywKKyAgICAgICAgdW5zaWdu
ZWQgbG9uZyBmaXJzdF9pbmRleCx1bnNpZ25lZCBpbnQgbWF4X2l0ZW1zLGludCB0YWcpIHsKKyAg
ICAgICAgcmV0dXJuIF9fbG9va3VwKGJ0cmVlLHJlc3VsdHMsZmlyc3RfaW5kZXgsbWF4X2l0ZW1z
LCB0YWcpOworfQorCisKK0VYUE9SVF9TWU1CT0woYnRyZWVfZ2FuZ19sb29rdXBfdGFnKTsKKwor
CisvKioKKyogICAgICAgRnVuY3Rpb24gdXNlZCB0byBzZWFyY2ggYSBub2RlIGluIGEgQi1UcmVl
CisqICAgICAgIEBwYXJhbSBidHJlZSBUaGUgQi10cmVlIHRvIGJlIHNlYXJjaGVkCisqICAgICAg
IEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBub2RlIHRvIGJlIHNlYXJjaAorKiAgICAgICBAcmV0dXJu
IFRoZSBrZXktdmFsdWUgcGFpcgorKi8KK3ZvaWQgKiBidHJlZV9sb29rdXAoYnRyZWUgKiBidHJl
ZSx1bnNpZ25lZCBsb25nIGtleSkgeworCisJYnRfa2V5X3ZhbCBrZXlfdmFsOworCW5vZGVfcG9z
IGtwOworCQorCWlmIChidHJlZS0+cm9vdCA9PSBOVUxMKSB7CisJCXJldHVybiBOVUxMOworCX0K
KworCWtwID0gZ2V0X2J0cmVlX25vZGUoYnRyZWUsa2V5KTsKKwlrZXlfdmFsLnZhbCA9IE5VTEw7
CisKKwlpZihrcC5ub2RlKSB7CisJCWtleV92YWwgPSBrcC5ub2RlLT5rZXlfdmFsc1trcC5pbmRl
eF07CisJfSAKKwlyZXR1cm4ga2V5X3ZhbC52YWw7IAorfQorRVhQT1JUX1NZTUJPTChidHJlZV9s
b29rdXApOworCisvKioKKyogICAgICAgRnVuY3Rpb24gdXNlZCB0byBnZXQgdGhlIHNsb3QgaW4g
YSBub2RlIG9mIGEgQi1UcmVlCisqICAgICAgIEBwYXJhbSBidHJlZSBUaGUgQi10cmVlIHRvIGJl
IHNlYXJjaGVkCisqICAgICAgIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBub2RlIHRvIGJlIHNlYXJj
aAorKiAgICAgICBAcmV0dXJuIFRoZSBrZXktdmFsdWUgcGFpcgorKi8KK2J0X2tleV92YWwgKiBi
dHJlZV9sb29rdXBfc2xvdChidHJlZSAqIGJ0cmVlLHVuc2lnbmVkIGxvbmcga2V5KSB7CisKKwli
dF9rZXlfdmFsICoga2V5X3ZhbCA9IE5VTEw7CisJbm9kZV9wb3Mga3A7CisKKwlpZiAoYnRyZWUt
PnJvb3QgPT0gTlVMTCkgeworCQlyZXR1cm4gTlVMTDsKKwl9CisKKwlrcCA9IGdldF9idHJlZV9u
b2RlKGJ0cmVlLGtleSk7CisKKwlpZihrcC5ub2RlKSB7CisJCWtleV92YWwgPSAma3Aubm9kZS0+
a2V5X3ZhbHNba3AuaW5kZXhdOworCX0KKwlyZXR1cm4ga2V5X3ZhbDsgCit9CitFWFBPUlRfU1lN
Qk9MKGJ0cmVlX2xvb2t1cF9zbG90KTsKKworLyoqCisqICAgICAgIFVzZWQgdG8gc2V0IHRoZSB0
YWcgZm9yIGEgbm9kZQorKiAgICAgICBAcGFyYW0gYnRyZWUgVGhlIGJ0cmVlCisqICAgICAgIEBw
YXJhbSBrZXkgVGhlIGtleSBvZiB0aGUgcGFnZSBmb3Igd2hpY2ggdGhlIHRhZyBpcyB0byBiZSBz
ZXQKKyogICAgICAgQHBhcmFtIHRhZyBUaGUgdGFnIHRvIGJlIHNldAorKiAgICAgICBAcmV0dXJu
IFRoZSBidHJlZSBrZXkgYW5kIHZhbCBmb3Igd2hpY2ggdGhlIHRhZyBpcyBzZXQgIAorKi8KKwor
YnRfa2V5X3ZhbCAqIGJ0cmVlX3RhZ19zZXQoYnRyZWUgKiBidHJlZSx1bnNpZ25lZCBsb25nIGtl
eSwgaW50IHRhZykgeworCWJ0X2tleV92YWwgKiBrZXlfdmFsID0gTlVMTDsKKwlub2RlX3BvcyBr
cCA9IGdldF9idHJlZV9ub2RlKGJ0cmVlLGtleSk7CisKKwlpZihrcC5ub2RlKSB7CisJCWtleV92
YWwgPSAma3Aubm9kZS0+a2V5X3ZhbHNba3AuaW5kZXhdOworICAgICAgICAgICAgICAgIGlmKCF0
YWdfZ2V0KGtwLm5vZGUsdGFnLGtwLmluZGV4KSkKKyAgICAgICAgICAgICAgICAgICAgICAgIHRh
Z19zZXQoa3Aubm9kZSx0YWcsa3AuaW5kZXgpOworCX0KKyAgICAgICAgQlVHX09OKGtleV92YWwg
PT0gTlVMTCk7CisJcmV0dXJuIGtleV92YWw7IAorfQorRVhQT1JUX1NZTUJPTChidHJlZV90YWdf
c2V0KTsKKworLyoqCisqICAgICAgIFVzZWQgdG8gY2xlYXIgdGhlIHRhZyBmb3IgYSBub2RlCisq
ICAgICAgIEBwYXJhbSBidHJlZSBUaGUgYnRyZWUKKyogICAgICAgQHBhcmFtIGtleSBUaGUga2V5
IG9mIHRoZSBwYWdlIGZvciB3aGljaCB0aGUgdGFnIGlzIHRvIGJlIHNldAorKiAgICAgICBAcGFy
YW0gdGFnIFRoZSB0YWcgdG8gYmUgc2V0CisqICAgICAgIEByZXR1cm4gVGhlIGJ0cmVlIGtleSBh
bmQgdmFsIGZvciB3aGljaCB0aGUgdGFnIGlzIGNsZWFyZWQgIAorKi8KKworYnRfa2V5X3ZhbCAq
IGJ0cmVlX3RhZ19jbGVhcihidHJlZSAqIGJ0cmVlLHVuc2lnbmVkIGxvbmcga2V5LCBpbnQgdGFn
KSB7CisgICAgICAgICBidF9rZXlfdmFsICoga2V5X3ZhbCA9IE5VTEw7CisJbm9kZV9wb3Mga3Ag
PSBnZXRfYnRyZWVfbm9kZShidHJlZSxrZXkpOworCisJaWYoa3Aubm9kZSkgeworCQlrZXlfdmFs
ID0gJmtwLm5vZGUtPmtleV92YWxzW2twLmluZGV4XTsKKyAgICAgICAgICAgICAgICBpZih0YWdf
Z2V0KGtwLm5vZGUsdGFnLGtwLmluZGV4KSkKKyAgICAgICAgICAgICAgICAgICAgICAgIHRhZ19j
bGVhcihrcC5ub2RlLHRhZyxrcC5pbmRleCk7CisJfQorICAgICAgICBCVUdfT04oa2V5X3ZhbCA9
PSBOVUxMKTsKKwlyZXR1cm4ga2V5X3ZhbDsgCit9CitFWFBPUlRfU1lNQk9MKGJ0cmVlX3RhZ19j
bGVhcik7CisKKy8qKgorKiAgICAgICBVc2VkIHRvIHZlcmlmeSB3aGV0aGVyIGEgdGFnIGlzIHNl
dAorKiAgICAgICBAcGFyYW0gYnRyZWUgVGhlIGJ0cmVlCisqICAgICAgIEBwYXJhbSBrZXkgVGhl
IGtleQorKiAgICAgICBAcGFyYW0gdGFnIFRoZSB0YWcKKyogICAgICAgQHJldHVybgorKiAgICAg
ICAwOiB0YWcgbm90IHByZXNlbnQKKyogICAgICAgMTogdGFnIHByZXNlbnQsIHNldAorKiAgICAg
ICAtMTogdGFnIHByZXNlbnQsIHVuc2V0IAorKi8KK2ludCBidHJlZV90YWdfZ2V0KGJ0cmVlICog
YnRyZWUsdW5zaWduZWQgbG9uZyBrZXksIGludCB0YWcpIHsKKyAgICAgICAgaW50IHJldCA9IDA7
CisgICAgICAgIGJ0X2tleV92YWwgKiBrZXlfdmFsID0gTlVMTDsKKwlub2RlX3BvcyBrcCA9IGdl
dF9idHJlZV9ub2RlKGJ0cmVlLGtleSk7CisKKwlpZihrcC5ub2RlKSB7CisJCWtleV92YWwgPSAm
a3Aubm9kZS0+a2V5X3ZhbHNba3AuaW5kZXhdOworICAgICAgICAgICAgICAgIHJldCA9IHRhZ19n
ZXQoa3Aubm9kZSx0YWcsa3AuaW5kZXgpOworICAgICAgICAgICAgICAgIHJldHVybiByZXQ/IDEg
OiAtMTsKKwl9CisgICAgICAgIEJVR19PTihrZXlfdmFsID09IE5VTEwpOworCXJldHVybiByZXQ7
IAorfQorRVhQT1JUX1NZTUJPTChidHJlZV90YWdfZ2V0KTsKKworCisvKioKKyoJR2V0IHRoZSBt
YXgga2V5IGluIHRoZSBidHJlZQorKglAcGFyYW0gYnRyZWUgVGhlIGJ0cmVlCisqCUByZXR1cm4g
VGhlIG1heCBrZXkgCisqLwordW5zaWduZWQgbG9uZyBidHJlZV9nZXRfbWF4X2tleShidHJlZSAq
IGJ0cmVlKSB7CisJbm9kZV9wb3Mgbm9kZV9wb3M7CisJbm9kZV9wb3MgPSBnZXRfbWF4X2tleV9w
b3MoYnRyZWUsYnRyZWUtPnJvb3QpOworCXJldHVybiBub2RlX3Bvcy5ub2RlLT5rZXlfdmFsc1tu
b2RlX3Bvcy5pbmRleF0ua2V5OworfQorCisvKioKKyoJR2V0IHRoZSBtaW4ga2V5IGluIHRoZSBi
dHJlZQorKglAcGFyYW0gYnRyZWUgVGhlIGJ0cmVlCisqCUByZXR1cm4gVGhlIG1heCBrZXkgCisq
LwordW5zaWduZWQgbG9uZyBidHJlZV9nZXRfbWluX2tleShidHJlZSAqIGJ0cmVlKSB7CisJbm9k
ZV9wb3Mgbm9kZV9wb3M7CisJbm9kZV9wb3MgPSBnZXRfbWluX2tleV9wb3MoYnRyZWUsYnRyZWUt
PnJvb3QpOworCXJldHVybiBub2RlX3Bvcy5ub2RlLT5rZXlfdmFsc1tub2RlX3Bvcy5pbmRleF0u
a2V5OworfQorCisvKioKKyoJVXNlZCB0byBwcmludCB0aGUga2V5cyBvZiB0aGUgYnRyZWVfbm9k
ZQorKglAcGFyYW0gbm9kZSBUaGUgbm9kZSB3aG9zZSBrZXlzIGFyZSB0byBiZSBwcmludGVkCisq
CUByZXR1cm4gbm9uZQorKi8KKworc3RhdGljIHZvaWQgcHJpbnRfc2luZ2xlX25vZGUoYnRyZWUg
KmJ0cmVlLCBidHJlZV9ub2RlICogbm9kZSkgeworCQorCWludCBpID0gMDsKKwkKKwlwcmludGso
IiB7ICIpOwkKKwl3aGlsZShpIDwgbm9kZS0+bnJfYWN0aXZlKSB7CisJCXByaW50aygiJWQoMHgl
eCkgIiwgbm9kZS0+a2V5X3ZhbHNbaV0ua2V5LAorCQkJbm9kZS0+a2V5X3ZhbHNbaV0udmFsKTsK
KwkJaSsrOworCX0KKwlwcmludGsoIn0gKDB4JXgsJWQsJWQpICIsIG5vZGUsbm9kZS0+bnJfYWN0
aXZlLG5vZGUtPmxldmVsKTsJCit9CisKKy8qKgorKiAgICAgICBGdW5jdGlvbiB1c2VkIHRvIHBy
aW50IHRoZSBCLXRyZWUKKyogICAgICAgQHBhcmFtIHJvb3QgUm9vdCBvZiB0aGUgQi1UcmVlCisq
ICAgICAgIEBwYXJhbSBwcmludF9rZXkgRnVuY3Rpb24gdXNlZCB0byBwcmludCB0aGUga2V5IHZh
bHVlCisqICAgICAgIEByZXR1cm4gbm9uZQorKi8KKwordm9pZCBwcmludF9zdWJ0cmVlKGJ0cmVl
ICpidHJlZSxidHJlZV9ub2RlICogbm9kZSkgeworCQorCWludCBpID0gMDsKKwl1bnNpZ25lZCBp
bnQgY3VycmVudF9sZXZlbDsKKworCWJ0cmVlX25vZGUgKiBoZWFkLCAqIHRhaWw7CisKKwljdXJy
ZW50X2xldmVsID0gbm9kZS0+bGV2ZWw7CisJaGVhZCA9IG5vZGU7CisJdGFpbCA9IG5vZGU7CisJ
CisJcHJpbnRrKCJERUJVRzogUHJpbnRpbmcgc3VidHJlZVxuIik7CisJd2hpbGUodHJ1ZSkgewor
CQlpZihoZWFkID09IE5VTEwpIHsKKwkJCWJyZWFrOworCQl9CisJCWlmIChoZWFkLT5sZXZlbCA8
IGN1cnJlbnRfbGV2ZWwpIHsKKwkJCWN1cnJlbnRfbGV2ZWwgPSBoZWFkLT5sZXZlbDsKKwkJCXBy
aW50aygiXG4iKTsKKwkJfQorCQlwcmludF9zaW5nbGVfbm9kZShidHJlZSxoZWFkKTsKKworCQlp
ZihoZWFkLT5sZWFmID09IGZhbHNlKSB7CQorCQkJZm9yKGkgPSAwIDsgaSA8IGhlYWQtPm5yX2Fj
dGl2ZSArIDE7IGkrKykgeworCQkJCXRhaWwtPm5leHQgPSBoZWFkLT5jaGlsZHJlbltpXTsKKwkJ
CQl0YWlsID0gaGVhZC0+Y2hpbGRyZW5baV07CisJCQkJaGVhZC0+Y2hpbGRyZW5baV0tPm5leHQg
PSBOVUxMOworCQkJfQorCQl9CisJCWhlYWQgPSBoZWFkLT5uZXh0OwkKKwl9CisJcHJpbnRrKCJc
biIpOworfQorRVhQT1JUX1NZTUJPTChwcmludF9zdWJ0cmVlKTsKKwpkaWZmIC11ck4gbGludXgt
Mi42LjE2LjIvbGliL01ha2VmaWxlIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL2xpYi9NYWtlZmlsZQot
LS0gbGludXgtMi42LjE2LjIvbGliL01ha2VmaWxlCTIwMDYtMDQtMDcgMTI6NTY6NDcuMDAwMDAw
MDAwIC0wNDAwCisrKyBsaW51eC0yLjYuMTYuMi1idHJlZS9saWIvTWFrZWZpbGUJMjAwNi0wOC0w
NSAxMDo1NzoxMi4wMDAwMDAwMDAgLTA0MDAKQEAgLTMsNyArMyw3IEBACiAjCiAKIGxpYi15IDo9
IGVycm5vLm8gY3R5cGUubyBzdHJpbmcubyB2c3ByaW50Zi5vIGNtZGxpbmUubyBcCi0JIGJ1c3Rf
c3BpbmxvY2tzLm8gcmJ0cmVlLm8gcmFkaXgtdHJlZS5vIGR1bXBfc3RhY2subyBcCisJIGJ1c3Rf
c3BpbmxvY2tzLm8gcmJ0cmVlLm8gcmFkaXgtdHJlZS5vIGR1bXBfc3RhY2subyBidHJlZS5vXAog
CSBpZHIubyBkaXY2NC5vIGludF9zcXJ0Lm8gYml0bWFwLm8gZXh0YWJsZS5vIHByaW9fdHJlZS5v
IFwKIAkgc2hhMS5vCiAKZGlmZiAtdXJOIGxpbnV4LTIuNi4xNi4yL2luaXQvbWFpbi5jIGxpbnV4
LTIuNi4xNi4yLWJ0cmVlL2luaXQvbWFpbi5jCi0tLSBsaW51eC0yLjYuMTYuMi9pbml0L21haW4u
YwkyMDA2LTA0LTA3IDEyOjU2OjQ3LjAwMDAwMDAwMCAtMDQwMAorKysgbGludXgtMi42LjE2LjIt
YnRyZWUvaW5pdC9tYWluLmMJMjAwNi0wOC0wNiAxNToyMDowNi4wMDAwMDAwMDAgLTA0MDAKQEAg
LTg0LDYgKzg0LDcgQEAKIGV4dGVybiB2b2lkIHBpZG1hcF9pbml0KHZvaWQpOwogZXh0ZXJuIHZv
aWQgcHJpb190cmVlX2luaXQodm9pZCk7CiBleHRlcm4gdm9pZCByYWRpeF90cmVlX2luaXQodm9p
ZCk7CitleHRlcm4gdm9pZCBidHJlZV9pbml0KHZvaWQpOwogZXh0ZXJuIHZvaWQgZnJlZV9pbml0
bWVtKHZvaWQpOwogZXh0ZXJuIHZvaWQgcG9wdWxhdGVfcm9vdGZzKHZvaWQpOwogZXh0ZXJuIHZv
aWQgZHJpdmVyX2luaXQodm9pZCk7CkBAIC01MjksNyArNTMwLDggQEAKIAlrZXlfaW5pdCgpOwog
CXNlY3VyaXR5X2luaXQoKTsKIAl2ZnNfY2FjaGVzX2luaXQobnVtX3BoeXNwYWdlcyk7Ci0JcmFk
aXhfdHJlZV9pbml0KCk7CisvLwlyYWRpeF90cmVlX2luaXQoKTsKKyAgICAgICAgYnRyZWVfaW5p
dCgpOwogCXNpZ25hbHNfaW5pdCgpOwogCS8qIHJvb3RmcyBwb3B1bGF0aW5nIG1pZ2h0IG5lZWQg
cGFnZS13cml0ZWJhY2sgKi8KIAlwYWdlX3dyaXRlYmFja19pbml0KCk7CmRpZmYgLXVyTiBsaW51
eC0yLjYuMTYuMi9mcy9idWZmZXIuYyBsaW51eC0yLjYuMTYuMi1idHJlZS9mcy9idWZmZXIuYwot
LS0gbGludXgtMi42LjE2LjIvZnMvYnVmZmVyLmMJMjAwNi0wNC0wNyAxMjo1Njo0Ny4wMDAwMDAw
MDAgLTA0MDAKKysrIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL2ZzL2J1ZmZlci5jCTIwMDYtMDgtMDYg
MTU6MTA6NDkuMDAwMDAwMDAwIC0wNDAwCkBAIC04NTksOSArODU5LDE1IEBACiAJCWlmIChwYWdl
LT5tYXBwaW5nKSB7CS8qIFJhY2Ugd2l0aCB0cnVuY2F0ZT8gKi8KIAkJCWlmIChtYXBwaW5nX2Nh
cF9hY2NvdW50X2RpcnR5KG1hcHBpbmcpKQogCQkJCWluY19wYWdlX3N0YXRlKG5yX2RpcnR5KTsK
LQkJCXJhZGl4X3RyZWVfdGFnX3NldCgmbWFwcGluZy0+cGFnZV90cmVlLAorCQkJYnRyZWVfdGFn
X3NldCgmbWFwcGluZy0+YnRyZWUsCiAJCQkJCQlwYWdlX2luZGV4KHBhZ2UpLAogCQkJCQkJUEFH
RUNBQ0hFX1RBR19ESVJUWSk7CisKKwkJCWlmIChidHJlZV90YWdfZ2V0KCZtYXBwaW5nLT5idHJl
ZSwKKwkJCSAgcGFnZV9pbmRleChwYWdlKSxQQUdFQ0FDSEVfVEFHX0RJUlRZKSAhPSAxKSB7CisJ
CQkJcGFuaWMoIlByb2JsZW0gc2V0dGluZyB0aGUgdGFnXG4iKTsKKwkJCX0JCQkJCisKIAkJfQog
CQl3cml0ZV91bmxvY2tfaXJxKCZtYXBwaW5nLT50cmVlX2xvY2spOwogCQlfX21hcmtfaW5vZGVf
ZGlydHkobWFwcGluZy0+aG9zdCwgSV9ESVJUWV9QQUdFUyk7CmRpZmYgLXVyTiBsaW51eC0yLjYu
MTYuMi9mcy9pbm9kZS5jIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL2ZzL2lub2RlLmMKLS0tIGxpbnV4
LTIuNi4xNi4yL2ZzL2lub2RlLmMJMjAwNi0wNC0wNyAxMjo1Njo0Ny4wMDAwMDAwMDAgLTA0MDAK
KysrIGxpbnV4LTIuNi4xNi4yLWJ0cmVlL2ZzL2lub2RlLmMJMjAwNi0wOC0wNiAyMTozNjoyMi4w
MDAwMDAwMDAgLTA0MDAKQEAgLTE2LDYgKzE2LDcgQEAKICNpbmNsdWRlIDxsaW51eC9iYWNraW5n
LWRldi5oPgogI2luY2x1ZGUgPGxpbnV4L3dhaXQuaD4KICNpbmNsdWRlIDxsaW51eC9oYXNoLmg+
CisjaW5jbHVkZSA8bGludXgvYnRyZWUuaD4KICNpbmNsdWRlIDxsaW51eC9zd2FwLmg+CiAjaW5j
bHVkZSA8bGludXgvc2VjdXJpdHkuaD4KICNpbmNsdWRlIDxsaW51eC9wYWdlbWFwLmg+CkBAIC0x
OTYsNiArMTk3LDcgQEAKIAltdXRleF9pbml0KCZpbm9kZS0+aV9tdXRleCk7CiAJaW5pdF9yd3Nl
bSgmaW5vZGUtPmlfYWxsb2Nfc2VtKTsKIAlJTklUX1JBRElYX1RSRUUoJmlub2RlLT5pX2RhdGEu
cGFnZV90cmVlLCBHRlBfQVRPTUlDKTsKKyAgICAgICAgSU5JVF9CVFJFRSgmaW5vZGUtPmlfZGF0
YS5idHJlZSwgR0ZQX0FUT01JQyk7CiAJcndsb2NrX2luaXQoJmlub2RlLT5pX2RhdGEudHJlZV9s
b2NrKTsKIAlzcGluX2xvY2tfaW5pdCgmaW5vZGUtPmlfZGF0YS5pX21tYXBfbG9jayk7CiAJSU5J
VF9MSVNUX0hFQUQoJmlub2RlLT5pX2RhdGEucHJpdmF0ZV9saXN0KTsKZGlmZiAtdXJOIGxpbnV4
LTIuNi4xNi4yL2luY2x1ZGUvbGludXgvYnRyZWUuaCBsaW51eC0yLjYuMTYuMi1idHJlZS9pbmNs
dWRlL2xpbnV4L2J0cmVlLmgKLS0tIGxpbnV4LTIuNi4xNi4yL2luY2x1ZGUvbGludXgvYnRyZWUu
aAkxOTY5LTEyLTMxIDE5OjAwOjAwLjAwMDAwMDAwMCAtMDUwMAorKysgbGludXgtMi42LjE2LjIt
YnRyZWUvaW5jbHVkZS9saW51eC9idHJlZS5oCTIwMDYtMDgtMDYgMjE6NDE6MDIuMDAwMDAwMDAw
IC0wNDAwCkBAIC0wLDAgKzEsODkgQEAKKy8qCisgKiAgYnRyZWUuaAorICoKKyAqICBDb3B5cmln
aHQgKEMpIDIwMDYgVmlzaGFsIFBhdGlsICh2aXNocGF0IEFUIGdtYWlsIERPVCBjb20pIAorICoK
KyovCisKKyNpZm5kZWYgX0JUUkVFX0hfCisjZGVmaW5lIF9CVFJFRV9IXworCisjaW5jbHVkZSA8
bGludXgvc2NoZWQuaD4KKyNpbmNsdWRlIDxsaW51eC9wcmVlbXB0Lmg+CisjaW5jbHVkZSA8bGlu
dXgvdHlwZXMuaD4KKworI2RlZmluZSBCVFJFRV9PUkRFUiA4IAorI2RlZmluZSBCVFJFRV9UQUdT
IDIKKyNkZWZpbmUgQlRSRUVfVEFHX0xPTkdTICAgIFwKKyAgICAgICAgKChCVFJFRV9PUkRFUiAr
IEJJVFNfUEVSX0xPTkcgLSAxKSAvIEJJVFNfUEVSX0xPTkcpCisjZGVmaW5lIEJUUkVFX01BWF9Q
QVRIIDgKKworCit0eXBlZGVmIGVudW0gIHtmYWxzZSx0cnVlfSBib29sOwordHlwZWRlZiBzdHJ1
Y3QgYnRyZWVfbm9kZSBidHJlZV9ub2RlOworCit0eXBlZGVmIHN0cnVjdCB7CisgICAgICAgIHVu
c2lnbmVkIGxvbmcga2V5OworCXZvaWQgKiB2YWw7Cit9IGJ0X2tleV92YWw7CisKKwordHlwZWRl
ZiBzdHJ1Y3QgYnRyZWUgeworCXVuc2lnbmVkIGludCBvcmRlcjsJCQkvLyBCLVRyZWUgb3JkZXIK
KwlidHJlZV9ub2RlICogcm9vdDsJCSAgICAgICAgLy8gUm9vdCBvZiB0aGUgQi1UcmVlCisgICAg
ICAgCXVuc2lnbmVkIGxvbmcgKCp2YWx1ZSkodW5zaWduZWQgbG9uZyBrZXkpOwkvLyBHZW5lcmF0
ZSB1aW50IHZhbHVlIGZvciB0aGUga2V5CisgICAgICAgIHVuc2lnbmVkIGxvbmcgKCprZXkpKHZv
aWQgKiBkYXRhKTsgICAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIHRoZSBrZXkgZnJvbQorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZnJvbSB0aGUgZGF0
YQorCXZvaWQgKCpwcmludF9rZXkpKHVuc2lnbmVkIGxvbmcga2V5KTsJCS8vIFByaW50IHRoZSBr
ZXkKKyAgICAgICAgZ2ZwX3QgICAgICAgICAgICAgICAgICAgZ2ZwX21hc2s7Cit9IGJ0cmVlOyAK
KworZXh0ZXJuIGludCBidHJlZV9pbnNlcnQoYnRyZWUgKiBidHJlZSwgdW5zaWduZWQgbG9uZyBr
ZXksIHZvaWQgKiB2YWwpOworZXh0ZXJuIGJ0X2tleV92YWwgYnRyZWVfZGVsZXRlKGJ0cmVlICog
YnRyZWUsYnRyZWVfbm9kZSAqIHN1YnRyZWUsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHVuc2lnbmVkIGxvbmcga2V5KTsKK2V4dGVybiB2b2lkICogYnRyZWVfbG9va3VwKGJ0cmVl
ICogYnRyZWUsICB1bnNpZ25lZCBsb25nIGtleSk7CitleHRlcm4gdW5zaWduZWQgaW50IGJ0cmVl
X2dhbmdfbG9va3VwKGJ0cmVlICogYnRyZWUsIHZvaWQgKiogcmVzdWx0cywKKyAgICAgICAgdW5z
aWduZWQgbG9uZyBmaXJzdF9pbmRleCx1bnNpZ25lZCBpbnQgbWF4X2l0ZW1zKTsKK2V4dGVybiB1
bnNpZ25lZCBpbnQgYnRyZWVfZ2FuZ19sb29rdXBfdGFnKGJ0cmVlICogYnRyZWUsIHZvaWQgKiog
cmVzdWx0cywKKyAgICAgICAgdW5zaWduZWQgbG9uZyBmaXJzdF9pbmRleCx1bnNpZ25lZCBpbnQg
bWF4X2l0ZW1zLGludCB0YWcpOworZXh0ZXJuIGJ0X2tleV92YWwgKiBidHJlZV9sb29rdXBfc2xv
dChidHJlZSAqIGJ0cmVlLCB1bnNpZ25lZCBsb25nIGtleSk7CitleHRlcm4gYnRfa2V5X3ZhbCAq
IGJ0cmVlX3RhZ19zZXQoYnRyZWUgKiBidHJlZSx1bnNpZ25lZCBsb25nIGtleSwgaW50IHRhZyk7
CitleHRlcm4gaW50IGJ0cmVlX3RhZ19nZXQoYnRyZWUgKiBidHJlZSx1bnNpZ25lZCBsb25nIGtl
eSwgaW50IHRhZyk7CitleHRlcm4gYnRfa2V5X3ZhbCAqIGJ0cmVlX3RhZ19jbGVhcihidHJlZSAq
IGJ0cmVlLHVuc2lnbmVkIGxvbmcga2V5LCBpbnQgdGFnKTsKK2V4dGVybiB2b2lkIGJ0cmVlX2Rl
c3Ryb3koYnRyZWUgKiBidHJlZSk7CitleHRlcm4gdW5zaWduZWQgbG9uZyBidHJlZV9nZXRfbWF4
X2tleShidHJlZSAqIGJ0cmVlKTsKK2V4dGVybiB1bnNpZ25lZCBsb25nIGJ0cmVlX2dldF9taW5f
a2V5KGJ0cmVlICogYnRyZWUpOworZXh0ZXJuIHVuc2lnbmVkIGxvbmcgYnRyZWVfdmFsdWVfZm4o
dW5zaWduZWQgbG9uZyBrZXkpOworZXh0ZXJuIHVuc2lnbmVkIGxvbmcgYnRyZWVfa2V5X2ZuKHZv
aWQgKiBwYWdlKTsKK2V4dGVybiB2b2lkIGJ0cmVlX3ByaW50X2ZuKHVuc2lnbmVkIGxvbmcga2V5
KTsKK2V4dGVybiBpbnQgYnRyZWVfcHJlbG9hZChnZnBfdCBnZnBfbWFzayk7CitleHRlcm4gaW50
IGJ0cmVlX3RhZ2dlZChidHJlZSAqIGJ0cmVlLCBpbnQgdGFnKTsKKworc3RhdGljIGlubGluZSB2
b2lkIGJ0cmVlX3ByZWxvYWRfZW5kKHZvaWQpCit7CisgICAgICAgIHByZWVtcHRfZW5hYmxlKCk7
Cit9CisKKyNkZWZpbmUgQlRSRUVfSU5JVChtYXNrKSB7IFwKKyAgICAgICAgLm9yZGVyICAgICAg
ICAgID0gQlRSRUVfT1JERVIsICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKKyAgICAgICAg
LnJvb3QgICAgICAgICAgID0gTlVMTCwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IFwKKyAgICAgICAgLnZhbHVlICAgICAgICAgID0gYnRyZWVfdmFsdWVfZm4sICAgICAgICAgICAg
ICAgICAgICAgICAgIFwKKyAgICAgICAgLmtleSAgICAgICAgICAgID0gYnRyZWVfa2V5X2ZuLCAg
ICAgICAgICAgICAgICAgICAgICAgICAgIFwKKyAgICAgICAgLnByaW50X2tleSAgICAgID0gYnRy
ZWVfcHJpbnRfZm4sICAgICAgICAgICAgICAgICAgICAgICAgIFwKKyAgICAgICAgLmdmcF9tYXNr
ICAgICAgID0gKG1hc2spICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKK30KKwor
I2RlZmluZSBJTklUX0JUUkVFKGJ0cmVlLG1hc2spICAgICAgICAgICAgICAgICAgICAgICAgICAg
IFwKK2RvIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBcCisgICAgICAgIChidHJlZSktPm9yZGVyID0gQlRSRUVfT1JERVI7ICAgICAgICAgICAg
ICAgICAgICAgXAorICAgICAgICAoYnRyZWUpLT5yb290ID0gTlVMTDsgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIFwKKyAgICAgICAgKGJ0cmVlKS0+dmFsdWUgICAgICAgICAgICA9IGJ0cmVl
X3ZhbHVlX2ZuOyAgICAgICBcCisgICAgICAgIChidHJlZSktPmtleSAgICAgICAgICAgICAgPSBi
dHJlZV9rZXlfZm47ICAgICAgICAgXAorICAgICAgICAoYnRyZWUpLT5wcmludF9rZXkgICAgICAg
ID0gYnRyZWVfcHJpbnRfZm47ICAgICAgIFwKKyAgICAgICAgKGJ0cmVlKS0+Z2ZwX21hc2sgICAg
ICAgICA9IChtYXNrKTsgICAgICAgICAgICAgICBcCit9IHdoaWxlICgwKQorCisKK2V4dGVybiB2
b2lkIHByaW50X3N1YnRyZWUoYnRyZWUgKiBidHJlZSxidHJlZV9ub2RlICogbm9kZSk7CisKKyNl
bmRpZgpkaWZmIC11ck4gbGludXgtMi42LjE2LjIvaW5jbHVkZS9saW51eC9mcy5oIGxpbnV4LTIu
Ni4xNi4yLWJ0cmVlL2luY2x1ZGUvbGludXgvZnMuaAotLS0gbGludXgtMi42LjE2LjIvaW5jbHVk
ZS9saW51eC9mcy5oCTIwMDYtMDQtMDcgMTI6NTY6NDcuMDAwMDAwMDAwIC0wNDAwCisrKyBsaW51
eC0yLjYuMTYuMi1idHJlZS9pbmNsdWRlL2xpbnV4L2ZzLmgJMjAwNi0wOC0wNSAxMDo1NzoxMi4w
MDAwMDAwMDAgLTA0MDAKQEAgLTIxNCw2ICsyMTQsNyBAQAogI2luY2x1ZGUgPGxpbnV4L2tvYmpl
Y3QuaD4KICNpbmNsdWRlIDxsaW51eC9saXN0Lmg+CiAjaW5jbHVkZSA8bGludXgvcmFkaXgtdHJl
ZS5oPgorI2luY2x1ZGUgPGxpbnV4L2J0cmVlLmg+CiAjaW5jbHVkZSA8bGludXgvcHJpb190cmVl
Lmg+CiAjaW5jbHVkZSA8bGludXgvaW5pdC5oPgogI2luY2x1ZGUgPGxpbnV4L3NjaGVkLmg+CkBA
IC0zNzIsNiArMzczLDcgQEAKIHN0cnVjdCBhZGRyZXNzX3NwYWNlIHsKIAlzdHJ1Y3QgaW5vZGUJ
CSpob3N0OwkJLyogb3duZXI6IGlub2RlLCBibG9ja19kZXZpY2UgKi8KIAlzdHJ1Y3QgcmFkaXhf
dHJlZV9yb290CXBhZ2VfdHJlZTsJLyogcmFkaXggdHJlZSBvZiBhbGwgcGFnZXMgKi8KKyAgICAg
ICAgc3RydWN0IGJ0cmVlICAgICAgICAgICAgYnRyZWU7ICAgICAgICAgIC8qIEJUcmVlIG9mIGFs
bCBwYWdlcyovCiAJcndsb2NrX3QJCXRyZWVfbG9jazsJLyogYW5kIHJ3bG9jayBwcm90ZWN0aW5n
IGl0ICovCiAJdW5zaWduZWQgaW50CQlpX21tYXBfd3JpdGFibGU7LyogY291bnQgVk1fU0hBUkVE
IG1hcHBpbmdzICovCiAJc3RydWN0IHByaW9fdHJlZV9yb290CWlfbW1hcDsJCS8qIHRyZWUgb2Yg
cHJpdmF0ZSBhbmQgc2hhcmVkIG1hcHBpbmdzICovCg==
------=_Part_33970_17874812.1154917103763--
