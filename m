Return-Path: <linux-kernel-owner+willy=40w.ods.org-S261830AbVATCNQ@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S261830AbVATCNQ (ORCPT <rfc822;willy@w.ods.org>);
	Wed, 19 Jan 2005 21:13:16 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S261840AbVATCNQ
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Wed, 19 Jan 2005 21:13:16 -0500
Received: from smtp1.Stanford.EDU ([171.67.16.123]:32385 "EHLO
	smtp1.Stanford.EDU") by vger.kernel.org with ESMTP id S261830AbVATCH2
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Wed, 19 Jan 2005 21:07:28 -0500
Date: Wed, 19 Jan 2005 18:07:26 -0800 (PST)
From: Junfeng Yang <yjf@stanford.edu>
To: Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
Subject: [BUG] 2.6.* pktgen doesn't set ethnet header properly
Message-ID: <Pine.GSO.4.44.0501191800030.17705-100000@epic8.Stanford.EDU>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Hi,

I tried to use pktgen module from 2.6.* kernels and found out that I
couldn't receive any packets generated by pktgen.  I did not even see a
"packet dropped by kernel" message.  It turned out that function
setup_inject in net/core/pktgen.c doesn't setup the ethernet header field
correctly.  Below is a patch that fixes the problem.

--- kernel-source-2.6.8-orig/net/core/pktgen.c	2004-08-13 22:37:26.000000000 -0700
+++ kernel-source-2.6.8/net/core/pktgen.c	2005-01-19 17:54:46.000000000 -0800
@@ -259,6 +259,9 @@

 	/* Set up Dest MAC */
 	memcpy(&(info->hh[0]), info->dst_mac, 6);
+
+	/* Set up protocol */
+	((struct ethhdr *)(info->hh))->h_proto = htons(ETH_P_IP);

 	info->saddr_min = 0;
 	info->saddr_max = 0;

-Junfeng

