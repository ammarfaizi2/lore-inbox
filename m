Return-Path: <linux-kernel-owner+willy=40w.ods.org-S1030517AbWHKCE5@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1030517AbWHKCE5 (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 10 Aug 2006 22:04:57 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1030658AbWHKCE4
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 10 Aug 2006 22:04:56 -0400
Received: from imx11.toshiba.co.jp ([61.202.160.20]:47027 "EHLO
	imx11.toshiba.co.jp") by vger.kernel.org with ESMTP
	id S1030517AbWHKCEz (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Thu, 10 Aug 2006 22:04:55 -0400
Date: Fri, 11 Aug 2006 11:04:35 +0900
Message-ID: <yyik65ghvt8.wl@forest.swc.toshiba.co.jp>
From: Tsutomu OWA <tsutomu.owa@toshiba.co.jp>
To: linux-kernel@vger.kernel.org
Cc: mingo@elte.hu, tglx@linutronix.de, linuxppc-dev@ozlabs.org,
       tsutomu.owa@toshiba.co.jp
Subject: [RFC PATCH 4/4] powerpc 2.6.16-rt29: to fix network driver (workaround)
User-Agent: Wanderlust/2.8.1 (Something) Emacs/20.7 Mule/4.0 (HANANOEN)
Organization: Software Engineering Center, TOSHIBA.
MIME-Version: 1.0 (generated by SEMI 1.14.4 - "Hosorogi")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


  To make network driver available for rt29 (actually rt21 and later).
When doing "ping -f", the network driver seems to hang without this 
workaround for rt version 29.

-- owa
# I suppose this should be fixed in other way in future but for now...

--- rt29/kernel/irq/manage.c	2006-07-10 09:01:21.000000000 +0900
+++ rt-powerpc/kernel/irq/manage.c	2006-07-21 20:17:50.000000000 +0900
@@ -723,15 +723,24 @@ static int do_irqd(void * __desc)
 		set_current_state(TASK_INTERRUPTIBLE);
 		do_hardirq(desc);
 		cond_resched_all();
+#ifndef CONFIG_PPC_PMAC64 /* work around: to revert to patch-2.6.16-rt20 version */
 		local_irq_disable();
+#endif /* !CONFIG_PPC_PMAC64 */
 		__do_softirq();
 		local_irq_enable();
 #ifdef CONFIG_SMP
 		/*
 		 * Did IRQ affinities change?
 		 */
+#ifdef CONFIG_PPC_PMAC64 /* work around; revert to patch-2.6.16-rt20 version */
+		if (!cpu_isset(smp_processor_id(), irq_affinity[irq])) {
+			mask = cpumask_of_cpu(any_online_cpu(irq_affinity[irq]));
+			set_cpus_allowed(current, mask);
+		}
+#else
 		if (!cpus_equal(current->cpus_allowed, irq_affinity[irq]))
 			set_cpus_allowed(current, irq_affinity[irq]);
+#endif /* CONFIG_PPC_PMAC64 */
 #endif
 		schedule();
 	}

