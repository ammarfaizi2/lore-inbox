Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S263875AbTETS5f (ORCPT <rfc822;willy@w.ods.org>);
	Tue, 20 May 2003 14:57:35 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S263877AbTETS5f
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Tue, 20 May 2003 14:57:35 -0400
Received: from x35.xmailserver.org ([208.129.208.51]:56981 "EHLO
	x35.xmailserver.org") by vger.kernel.org with ESMTP id S263875AbTETS5Y
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Tue, 20 May 2003 14:57:24 -0400
X-AuthUser: davidel@xmailserver.org
Date: Tue, 20 May 2003 12:09:31 -0700 (PDT)
From: Davide Libenzi <davidel@xmailserver.org>
X-X-Sender: davide@bigblue.dev.mcafeelabs.com
To: Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
Subject: SIS650+CPQ Presario 3045US details ...
Message-ID: <Pine.LNX.4.55.0305201202120.3636@bigblue.dev.mcafeelabs.com>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


Below are reported details about my CPQ Presario 3045US with the new
SIS650 chipset. I report how I changed the IRW routing functions, that
makes my machine to work fine. I did that completely blindly since I
couldn't find specs for the SIS650 chipset (Intel and AMD rulez about
docs). As you can see both 0x6* and 0x4* requests are generated by the PCI
world. Another strange thing is the 1000 bytes length unknown PCI
resource. The fw OHCI seem to load fine but I couldn't test it since I do
not have any fw device. With those changes everything works fine in my
machine, but the freakin' Broadcom 54g integrated wireless card. Is anyone
pinging those guys about Linux drivers support ?



- Davide



static int pirq_sis_get(struct pci_dev *router, struct pci_dev *dev, int pirq)
{
	u8 x;
	int reg = pirq;

	printk(KERN_INFO "SiS router get request: pirq=%x\n", pirq);
	switch(pirq) {
	case 0x01:
	case 0x02:
	case 0x03:
	case 0x04:
		reg += 0x40;
	case 0x41:
	case 0x42:
	case 0x43:
	case 0x44:
	case 0x62:
	case 0x60:
	case 0x61:
	case 0x63:
		printk(KERN_INFO "SiS router get request: reg=%x\n", reg);
		pci_read_config_byte(router, reg, &x);
		printk(KERN_INFO "SiS router get request: res=%x\n", (unsigned) x);
		if (reg < 0x60)
			break;
		if (!(x & 0x40))
			return 0;
		break;
	case 0x6a:
	case 0x7e:
		printk(KERN_INFO "SiS pirq: advanced IDE/ACPI/DAQ mapping not yet implemented\n");
		return 0;
	default:
		printk(KERN_INFO "SiS router pirq escape (%d)\n", pirq);
		return 0;
	}
	return (x & 0x80) ? 0 : (x & 0x0f);
}

static int pirq_sis_set(struct pci_dev *router, struct pci_dev *dev, int pirq, int irq)
{
	u8 x;
	int reg = pirq;

	printk(KERN_INFO "SiS router set request: pirq=%x irq=%x\n", pirq, irq);
	switch(pirq) {
	case 0x01:
	case 0x02:
	case 0x03:
	case 0x04:
		reg += 0x40;
	case 0x41:
	case 0x42:
	case 0x43:
	case 0x44:
	case 0x62:
	case 0x60:
	case 0x63:
	case 0x61:
		x = (irq&0x0f) ? (irq&0x0f) : 0x80;
		if (reg < 0x60)
			break;
		/* always mark OHCI enabled, as nothing else knows about this */
		x |= 0x40;
		break;
	case 0x6a:
	case 0x7e:
		printk(KERN_INFO "advanced SiS pirq mapping not yet implemented\n");
		return 0;
	default:
		printk(KERN_INFO "SiS router pirq escape (%d)\n", pirq);
		return 0;
	}
	printk(KERN_INFO "SiS router set request: pirq=%x res=%x\n", pirq, (unsigned) x);
	pci_write_config_byte(router, reg, x);

	return 1;
}


bled on CPU#0.
CPU:     After generic, caps: bfebf9ff 00000000 00000000 00000000
CPU:             Common caps: bfebf9ff 00000000 00000000 00000000
CPU: Intel(R) Pentium(R) 4 CPU 2.40GHz stepping 07
Enabling fast FPU save and restore... done.
Enabling unmasked SIMD FPU exception support... done.
Checking 'hlt' instruction... OK.
POSIX conformance testing by UNIFIX
mtrr: v1.40 (20010327) Richard Gooch (rgooch@atnf.csiro.au)
mtrr: detected mtrr type: Intel
PCI: PCI BIOS revision 2.10 entry at 0xe84c4, last bus=1
PCI: Using configuration type 1
PCI: Probing PCI hardware
PCI: Using IRQ router SIS [1039/0008] at 00:02.0
SiS router get request: pirq=60
SiS router get request: reg=60
SiS router get request: res=80
SiS router get request: pirq=61
SiS router get request: reg=61
SiS router get request: res=80
SiS router get request: pirq=62
SiS router get request: reg=62
SiS router get request: res=80
SiS router get request: pirq=63
SiS router get request: reg=63
SiS router get request: res=80
SiS router get request: pirq=44
SiS router get request: reg=44
SiS router get request: res=3
PCI: Found IRQ 3 for device 00:0b.0
PCI: Sharing IRQ 3 with 00:0c.0
isapnp: Scanning for PnP cards...
isapnp: No Plug & Play device found
Linux NET4.0 for Linux 2.4
Based upon Swansea University Computer Society NET3.039
Initializing RT netlink socket
apm: BIOS version 1.2 Flags 0x03 (Driver version 1.16)
Starting kswapd
VFS: Diskquotas version dquot_6.4.0 initialized
pty: 2048 Unix98 ptys configured
Serial driver version 5.05c (2001-07-08) with MANY_PORTS MULTIPORT SHARE_IRQ SERIAL_PCI ISAPNP enabled
ttyS00 at 0x03f8 (irq = 4) is a 16550A
SiS router get request: pirq=43
SiS router get request: reg=43
SiS router get request: res=5
PCI: Found IRQ 5 for device 00:02.6
PCI: Sharing IRQ 5 with 00:02.7
Real Time Clock Driver v1.10e
floppy0: no floppy controllers found
NET4: Frame Diverter 0.46
RAMDISK driver initialized: 16 RAM disks of 4096K size 1024 blocksize
Uniform Multi-Platform E-IDE driver Revision: 7.00beta3-.2.4
ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
SIS5513: IDE controller at PCI slot 00:02.5
SIS5513: chipset revision 0
SIS5513: not 100% native mode: will probe irqs later
SiS650    ATA 133 controller
    ide0: BM-DMA at 0x1100-0x1107, BIOS settings: hda:DMA, hdb:pio
    ide1: BM-DMA at 0x1108-0x110f, BIOS settings: hdc:DMA, hdd:pio
hda: HITACHI_DK23EA-60, ATA DISK drive
blk: queue c0314ca0, I/O limit 4095Mb (mask 0xffffffff)
hdc: DW-224E, ATAPI CD/DVD-ROM drive
ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
ide1 at 0x170-0x177,0x376 on irq 15
hda: attached ide-disk driver.
hda: host protected area => 1
hda: 117210240 sectors (60012 MB) w/2048KiB Cache, CHS=7296/255/63, UDMA(100)
ide-floppy driver 0.99.newide
Partition check:
 hda: hda1 hda2 hda3 hda4 < hda5 >
ide-floppy driver 0.99.newide
md: md driver 0.90.0 MAX_MD_DEVS=256, MD_SB_DISKS=27
md: Autodetecting RAID arrays.
md: autorun ...
md: ... autorun DONE.
NET4: Linux TCP/IP 1.0 for NET4.0
IP Protocols: ICMP, UDP, TCP, IGMP
IP: routing cache hash table of 4096 buckets, 32Kbytes
TCP: Hash tables configured (established 32768 bind 65536)
Linux IP multicast router 0.06 plus PIM-SM
NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.
RAMDISK: Compressed image found at block 0
Freeing initrd memory: 143k freed
VFS: Mounted root (ext2 filesystem).
Journalled Block Device driver loaded
kjournald starting.  Commit interval 5 seconds
EXT3-fs: mounted filesystem with ordered data mode.
Freeing unused kernel memory: 128k freed
usb.c: registered new driver usbdevfs
usb.c: registered new driver hub
SiS router get request: pirq=60
SiS router get request: reg=60
SiS router get request: res=80
SiS router set request: pirq=60 irq=b
SiS router set request: pirq=60 res=4b
PCI: Assigned IRQ 11 for device 00:03.0
PCI: Setting latency timer of device 00:03.0 to 64
usb-ohci.c: USB OHCI at membase 0xdc84a000, IRQ 11
usb-ohci.c: usb-00:03.0, Silicon Integrated Systems [SiS] 7001
usb.c: new USB bus registered, assigned bus number 1
hub.c: USB hub found
hub.c: 2 ports detected
SiS router get request: pirq=61
SiS router get request: reg=61
SiS router get request: res=80
SiS router set request: pirq=61 irq=a
SiS router set request: pirq=61 res=4a
PCI: Assigned IRQ 10 for device 00:03.1
PCI: Setting latency timer of device 00:03.1 to 64
usb-ohci.c: USB OHCI at membase 0xdc84c000, IRQ 10
usb-ohci.c: usb-00:03.1, Silicon Integrated Systems [SiS] 7001 (#2)
usb.c: new USB bus registered, assigned bus number 2
hub.c: USB hub found
hub.c: 2 ports detected
PCI: Enabling device 00:03.2 (0000 -> 0002)
SiS router get request: pirq=62
SiS router get request: reg=62
SiS router get request: res=80
SiS router set request: pirq=62 irq=b
SiS router set request: pirq=62 res=4b
PCI: Assigned IRQ 11 for device 00:03.2
PCI: Setting latency timer of device 00:03.2 to 64
usb-ohci.c: USB OHCI at membase 0xdc84e000, IRQ 11
usb-ohci.c: usb-00:03.2, Silicon Integrated Systems [SiS] 7001 (#3)
usb.c: new USB bus registered, assigned bus number 3
hub.c: USB hub found
hub.c: 2 ports detected
PCI: Enabling device 00:03.3 (0000 -> 0002)
SiS router get request: pirq=63
SiS router get request: reg=63
SiS router get request: res=80
SiS router set request: pirq=63 irq=3
SiS router set request: pirq=63 res=43
PCI: Assigned IRQ 3 for device 00:03.3
PCI: Setting latency timer of device 00:03.3 to 64
ehci-hcd 00:03.3: PCI device 1039:7002 (Silicon Integrated Systems [SiS])
ehci-hcd 00:03.3: irq 3, pci mem dc856000
usb.c: new USB bus registered, assigned bus number 4
PCI: 00:03.3 PCI cache line size set incorrectly (0 bytes) by BIOS/FW.
PCI: 00:03.3 PCI cache line size corrected to 32.
ehci-hcd 00:03.3: USB 2.0 enabled, EHCI 1.00, driver 2003-Jan-22
hub.c: USB hub found
hub.c: 6 ports detected
usb.c: registered new driver hiddev
usb.c: registered new driver hid
hid-core.c: v1.8.1 Andreas Gal, Vojtech Pavlik <vojtech@suse.cz>
hid-core.c: USB HID support drivers
mice: PS/2 mouse device common for all mice
EXT3 FS 2.4-0.9.19, 19 August 2002 on ide0(3,2), internal journal
Adding Swap: 1052248k swap-space (priority -1)
hub.c: new USB device 00:03.0-1, assigned address 2
hub.c: USB hub found
hub.c: 3 ports detected
hub.c: new USB device 00:03.0-1.1, assigned address 3
input0: USB HID v1.10 Keyboard [Silitek IBM USB HUB KEYBOARD] on usb1:3.0
hub.c: new USB device 00:03.0-1.2, assigned address 4
input1: USB HID v1.00 Mouse [04b3:3105] on usb1:4.0
kjournald starting.  Commit interval 5 seconds
EXT3 FS 2.4-0.9.19, 19 August 2002 on ide0(3,1), internal journal
EXT3-fs: mounted filesystem with ordered data mode.
kjournald starting.  Commit interval 5 seconds
EXT3 FS 2.4-0.9.19, 19 August 2002 on ide0(3,5), internal journal
EXT3-fs: mounted filesystem with ordered data mode.
ohci1394: $Rev: 896 $ Ben Collins <bcollins@debian.org>
SiS router get request: pirq=42
SiS router get request: reg=42
SiS router get request: res=a
PCI: Found IRQ 10 for device 00:02.3
PCI: Sharing IRQ 10 with 00:09.0
ohci1394_0: Unexpected PCI resource length of 1000!
ohci1394_0: OHCI-1394 1.0 (PCI): IRQ=[10]  MMIO=[fc000000-fc0007ff]  Max Packet=[2048]
ieee1394: Host added: Node[00:1023]  GUID[00508b719ed520cf]  [Linux OHCI-1394]
SCSI subsystem driver Revision: 1.00
hdc: attached ide-scsi driver.
scsi0 : SCSI host adapter emulation for IDE ATAPI devices
  Vendor: TEAC      Model: DW-224E           Rev: W.0A
  Type:   CD-ROM                             ANSI SCSI revision: 02
parport0: PC-style at 0x378 (0x778) [PCSPP,TRISTATE]
parport0: irq 7 detected
Attached scsi CD-ROM sr0 at scsi0, channel 0, id 0, lun 0
sr0: scsi3-mmc drive: 24x/24x writer cd/rw xa/form2 cdda tray
Uniform CD-ROM driver Revision: 3.12
ip_tables: (C) 2000-2002 Netfilter core team
8139too Fast Ethernet driver 0.9.26
SiS router get request: pirq=44
SiS router get request: reg=44
SiS router get request: res=3
PCI: Found IRQ 3 for device 00:0c.0
PCI: Sharing IRQ 3 with 00:0b.0
divert: allocating divert_blk for eth0
eth0: RealTek RTL8139 Fast Ethernet at 0xdc951000, 00:08:02:d5:20:cf, IRQ 3
eth0:  Identified 8139 chip type 'RTL-8139C'
ip_tables: (C) 2000-2002 Netfilter core team
eth0: Setting 100mbps full-duplex based on auto-negotiated partner ability 45e1.
eth0: Setting 100mbps full-duplex based on auto-negotiated partner ability 45e1.
Linux Kernel Card Services 3.1.22
  options:  [pci] [cardbus] [pm]
SiS router get request: pirq=44
SiS router get request: reg=44
SiS router get request: res=3
PCI: Found IRQ 3 for device 00:0b.0
PCI: Sharing IRQ 3 with 00:0c.0
Yenta IRQ list 0000, PCI irq3
Socket status: 30000006
cs: IO port probe 0x0c00-0x0cff: clean.
cs: IO port probe 0x0100-0x04ff: excluding 0x100-0x107 0x300-0x307 0x310-0x31f 0x378-0x37f 0x480-0x48f 0x4d0-0x4d7
cs: IO port probe 0x0a00-0x0aff: clean.
parport0: PC-style at 0x378 (0x778) [PCSPP,TRISTATE]
parport0: irq 7 detected
lp0: using parport0 (polling).
lp0: console ready



00:00.0 Host bridge: Silicon Integrated Systems [SiS] 650 Host (rev 11)
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128
	Memory at f8000000 (32-bit, non-prefetchable) [size=64M]
	Capabilities: [c0] AGP version 2.0

00:01.0 PCI bridge: Silicon Integrated Systems [SiS] SiS 530 Virtual PCI-to-PCI bridge (AGP) (prog-if 00 [Normal decode])
	Flags: bus master, fast devsel, latency 128
	Bus: primary=00, secondary=01, subordinate=01, sec-latency=32
	I/O behind bridge: 0000c000-0000dfff
	Memory behind bridge: e0000000-efffffff
	Prefetchable memory behind bridge: a0000000-afffffff

00:02.0 ISA bridge: Silicon Integrated Systems [SiS] 85C503/5513 (rev 04)
	Flags: bus master, medium devsel, latency 0

00:02.3 FireWire (IEEE 1394): Silicon Integrated Systems [SiS] FireWire Controller (prog-if 10 [OHCI])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128, IRQ 10
	Memory at fc000000 (32-bit, non-prefetchable) [size=4K]
	Expansion ROM at <unassigned> [disabled] [size=128K]
	Capabilities: [64] Power Management version 2

00:02.5 IDE interface: Silicon Integrated Systems [SiS] 5513 [IDE] (prog-if 80 [Master])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128
	I/O ports at 1100 [size=16]
	Capabilities: [58] Power Management version 2

00:02.6 Modem: Silicon Integrated Systems [SiS] Intel 537 [56k Winmodem] (rev a0) (prog-if 00 [Generic])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128, IRQ 5
	I/O ports at e000 [size=256]
	I/O ports at e100 [size=128]
	Capabilities: [48] Power Management version 2

00:02.7 Multimedia audio controller: Silicon Integrated Systems [SiS] SiS7012 PCI Audio Accelerator (rev a0)
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128, IRQ 5
	I/O ports at e200 [size=256]
	I/O ports at e300 [size=128]
	Capabilities: [48] Power Management version 2

00:03.0 USB Controller: Silicon Integrated Systems [SiS] SiS7001 USB Controller (rev 0f) (prog-if 10 [OHCI])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 64, IRQ 11
	Memory at f4002000 (32-bit, non-prefetchable) [size=4K]
	Capabilities: [dc] Power Management version 2

00:03.1 USB Controller: Silicon Integrated Systems [SiS] SiS7001 USB Controller (rev 0f) (prog-if 10 [OHCI])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 64, IRQ 10
	Memory at f4003000 (32-bit, non-prefetchable) [size=4K]
	Capabilities: [dc] Power Management version 2

00:03.2 USB Controller: Silicon Integrated Systems [SiS] SiS7001 USB Controller (rev 0f) (prog-if 10 [OHCI])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 64, IRQ 11
	Memory at 1c000000 (32-bit, non-prefetchable) [size=4K]
	Capabilities: [dc] Power Management version 2

00:03.3 USB Controller: Silicon Integrated Systems [SiS] SiS7002 USB 2.0 (prog-if 20 [EHCI])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 64, IRQ 3
	Memory at 1c001000 (32-bit, non-prefetchable) [size=4K]
	Capabilities: [50] Power Management version 2

00:09.0 Network controller: Broadcom Corporation: Unknown device 4320 (rev 02)
	Subsystem: Compaq Computer Corporation: Unknown device 00e7
	Flags: bus master, fast devsel, latency 128, IRQ 10
	Memory at fc002000 (32-bit, non-prefetchable) [size=8K]
	Capabilities: [40] Power Management version 2

00:0b.0 CardBus bridge: ENE Technology Inc CB1410 Cardbus Controller
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 168, IRQ 3
	Memory at 1c002000 (32-bit, non-prefetchable) [size=4K]
	Bus: primary=00, secondary=03, subordinate=03, sec-latency=176
	Memory window 0: 1c400000-1c7ff000 (prefetchable)
	Memory window 1: 1c800000-1cbff000
	I/O window 0: 00004000-000040ff
	I/O window 1: 00004400-000044ff
	16-bit legacy interface ports at 0001

00:0c.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8139/8139C/8139C+ (rev 10)
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: bus master, medium devsel, latency 128, IRQ 3
	I/O ports at e400 [size=256]
	Memory at fc004000 (32-bit, non-prefetchable) [size=256]
	Capabilities: [50] Power Management version 2

01:00.0 VGA compatible controller: Silicon Integrated Systems [SiS] SiS650/651/M650/740 PCI/AGP VGA Display Adapter (prog-if 00 [VGA])
	Subsystem: Compaq Computer Corporation: Unknown device 083c
	Flags: 66Mhz, medium devsel, IRQ 11
	BIST result: 00
	Memory at a0000000 (32-bit, prefetchable) [size=128M]
	Memory at e0000000 (32-bit, non-prefetchable) [size=128K]
	I/O ports at c000 [size=128]
	Capabilities: [40] Power Management version 2
	Capabilities: [50] AGP version 2.0

