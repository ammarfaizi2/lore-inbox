Return-Path: <linux-kernel-owner+willy=40w.ods.org-S266761AbUFYPw3@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S266761AbUFYPw3 (ORCPT <rfc822;willy@w.ods.org>);
	Fri, 25 Jun 2004 11:52:29 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S266762AbUFYPw3
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Fri, 25 Jun 2004 11:52:29 -0400
Received: from cantor.suse.de ([195.135.220.2]:50095 "EHLO Cantor.suse.de")
	by vger.kernel.org with ESMTP id S266761AbUFYPw1 (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Fri, 25 Jun 2004 11:52:27 -0400
Date: Fri, 25 Jun 2004 17:50:04 +0200
Message-ID: <s5hacyrfxhv.wl@alsa2.suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Andrea Arcangeli <andrea@suse.de>
Cc: Andi Kleen <ak@suse.de>, ak@muc.de, tripperda@nvidia.com,
       discuss@x86-64.org, linux-kernel@vger.kernel.org
Subject: Re: [discuss] Re: 32-bit dma allocations on 64-bit platforms
In-Reply-To: <20040624184447.GW30687@dualathlon.random>
References: <20040623234644.GC38425@colin2.muc.de>
	<s5hhdt1i4yc.wl@alsa2.suse.de>
	<20040624112900.GE16727@wotan.suse.de>
	<s5h4qp1hvk0.wl@alsa2.suse.de>
	<20040624164258.1a1beea3.ak@suse.de>
	<s5hy8mdgfzj.wl@alsa2.suse.de>
	<20040624152946.GK30687@dualathlon.random>
	<s5hsmclgcwl.wl@alsa2.suse.de>
	<20040624171620.GN30687@dualathlon.random>
	<s5hbrj8hkm9.wl@alsa2.suse.de>
	<20040624184447.GW30687@dualathlon.random>
User-Agent: Wanderlust/2.10.1 (Watching The Wheels) SEMI/1.14.5 (Awara-Onsen) FLIM/1.14.5 (Demachiyanagi) APEL/10.6 MULE XEmacs/21.4 (patch 15) (Security Through Obscurity) (i386-suse-linux)
MIME-Version: 1.0 (generated by SEMI 1.14.5 - "Awara-Onsen")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

At Thu, 24 Jun 2004 20:44:47 +0200,
Andrea Arcangeli wrote:
> 
> On Thu, Jun 24, 2004 at 08:33:02PM +0200, Takashi Iwai wrote:
> > Sure, in extreme cases, it can't work.  But at least, it _may_ work
> > better than using only GFP_DMA.  And indeed it should (still) work
> > on most of consumer PC boxes.  The addition of another zone would help
> > much better, though.
> 
> of course agreed.

The below is the new patch to follow your advice.


thanks,

Takashi

--- linux-2.6.7/arch/i386/kernel/pci-dma.c-dist	2004-06-24 15:56:46.017473544 +0200
+++ linux-2.6.7/arch/i386/kernel/pci-dma.c	2004-06-25 17:43:42.509366917 +0200
@@ -23,11 +23,22 @@ void *dma_alloc_coherent(struct device *
 	if (dev == NULL || (dev->coherent_dma_mask < 0xffffffff))
 		gfp |= GFP_DMA;
 
+ again:
 	ret = (void *)__get_free_pages(gfp, get_order(size));
 
-	if (ret != NULL) {
+	if (ret == NULL) {
+		if (dev && (gfp & GFP_DMA)) {
+			gfp &= ~GFP_DMA;
+			goto again;
+		}
+	} else {
 		memset(ret, 0, size);
 		*dma_handle = virt_to_phys(ret);
+		if (!(gfp & GFP_DMA) &&
+		    (((unsigned long)*dma_handle + size - 1) & ~(unsigned long)dev->coherent_dma_mask)) {
+			free_pages((unsigned long)ret, get_order(size));
+			return NULL;
+		}
 	}
 	return ret;
 }
