Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S272665AbTG1E4O (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 28 Jul 2003 00:56:14 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S272666AbTG1E4O
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 28 Jul 2003 00:56:14 -0400
Received: from franka.aracnet.com ([216.99.193.44]:8414 "EHLO
	franka.aracnet.com") by vger.kernel.org with ESMTP id S272665AbTG1Ezy
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Mon, 28 Jul 2003 00:55:54 -0400
Date: Sun, 27 Jul 2003 22:10:48 -0700
From: "Martin J. Bligh" <mbligh@aracnet.com>
To: linux-kernel <linux-kernel@vger.kernel.org>
Subject: [Bug 988] New: Badness in local_bh_enable when entering S3 from e100 
Message-ID: <3604430000.1059369048@[10.10.2.4]>
X-Mailer: Mulberry/2.2.1 (Linux/x86)
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

http://bugme.osdl.org/show_bug.cgi?id=988

           Summary: Badness in local_bh_enable when entering S3 from e100
    Kernel Version: 2.6.0-test1
            Status: NEW
          Severity: normal
             Owner: andrew.grover@intel.com
         Submitter: chadk@cmanitoba.com


Distribution: Debian GNU/Linux 'unstable'
Hardware Environment: Toshiba Satellite 5200
Problem Description: After resuming from S3 mode on the laptop, endless messages
are generated by the e100 driver

Stopping tasks: klogd entered refrigerator
=init entered refrigerator
=khubd entered refrigerator
=pdflush entered refrigerator
=pdflush entered refrigerator
=kswapd0 entered refrigerator
kseriod entered refrigerator
=kjournald entered refrigerator
...[snip]...
=|
Suspending devices
Suspending devices
hda: start_power_step(step: 0)
hda: start_power_step(step: 1)
hda: complete_power_step(step: 1, stat: 50, err: 0)
hda: completing PM request, suspend
Suspending devices
Badness in local_bh_enable at kernel/softirq.c:113
Call Trace:
 [local_bh_enable+133/135] local_bh_enable+0x85/0x87
 [e100_do_wol+20/87] e100_do_wol+0x14/0x57
 [e100_suspend+62/153] e100_suspend+0x3e/0x99
 [e100_suspend+0/153] e100_suspend+0x0/0x99
 [pci_device_suspend+70/90] pci_device_suspend+0x46/0x5a
 [device_suspend+214/248] device_suspend+0xd6/0xf8
 [acpi_system_save_state+104/138] acpi_system_save_state+0x68/0x8a
 [acpi_suspend+104/174] acpi_suspend+0x68/0xae
 [acpi_system_write_sleep+228/282] acpi_system_write_sleep+0xe4/0x11a
 [acpi_system_write_sleep+0/282] acpi_system_write_sleep+0x0/0x11a
 [vfs_write+161/268] vfs_write+0xa1/0x10c
 [sys_write+63/93] sys_write+0x3f/0x5d
 [syscall_call+7/11] syscall_call+0x7/0xb

Badness in local_bh_enable at kernel/softirq.c:113
Call Trace:
 [local_bh_enable+133/135] local_bh_enable+0x85/0x87
 [e100_config+156/256] e100_config+0x9c/0x100
 [local_bh_enable+133/135] local_bh_enable+0x85/0x87
 [e100_do_wol+28/87] e100_do_wol+0x1c/0x57
 [e100_suspend+62/153] e100_suspend+0x3e/0x99
 [e100_suspend+0/153] e100_suspend+0x0/0x99
 [pci_device_suspend+70/90] pci_device_suspend+0x46/0x5a
 [device_suspend+214/248] device_suspend+0xd6/0xf8
 [acpi_system_save_state+104/138] acpi_system_save_state+0x68/0x8a
 [acpi_suspend+104/174] acpi_suspend+0x68/0xae
 [acpi_system_write_sleep+228/282] acpi_system_write_sleep+0xe4/0x11a
 [acpi_system_write_sleep+0/282] acpi_system_write_sleep+0x0/0x11a
 [vfs_write+161/268] vfs_write+0xa1/0x10c
 [sys_write+63/93] sys_write+0x3f/0x5d
 [syscall_call+7/11] syscall_call+0x7/0xb

Badness in local_bh_enable at kernel/softirq.c:113
Call Trace:
 [local_bh_enable+133/135] local_bh_enable+0x85/0x87
 [e100_exec_non_cu_cmd+346/546] e100_exec_non_cu_cmd+0x15a/0x222
 [e100_config+171/256] e100_config+0xab/0x100
 [e100_do_wol+28/87] e100_do_wol+0x1c/0x57
 [e100_suspend+62/153] e100_suspend+0x3e/0x99
 [e100_suspend+0/153] e100_suspend+0x0/0x99
 [pci_device_suspend+70/90] pci_device_suspend+0x46/0x5a
 [device_suspend+214/248] device_suspend+0xd6/0xf8
 [acpi_system_save_state+104/138] acpi_system_save_state+0x68/0x8a
 [acpi_suspend+104/174] acpi_suspend+0x68/0xae
 [acpi_system_write_sleep+228/282] acpi_system_write_sleep+0xe4/0x11a
 [acpi_system_write_sleep+0/282] acpi_system_write_sleep+0x0/0x11a
 [vfs_write+161/268] vfs_write+0xa1/0x10c
 [sys_write+63/93] sys_write+0x3f/0x5d
 [syscall_call+7/11] syscall_call+0x7/0xb

ehci_hcd 0000:02:06.2: suspend to state 3
 hwsleep-0257 [30] acpi_enter_sleep_state: Entering sleep state [S3]
Enabling SEP on CPU 0
Back to C!
Devices Resumed
hub 1-0:0: resubmit --> -115
ehci_hcd 0000:02:06.2: resume
hda: Wakeup request inited, waiting for !BSY...
hda: start_power_step(step: 1000)
blk: queue c03fc63c, I/O limit 4095Mb (mask 0xffffffff)
hda: completing PM request, resume
Devices Resumed
Restarting tasks...init left refrigerator
khubd left refrigerator
pdflush left refrigerator
kswapd0 left refrigerator
kseriod left refrigerator
kjournald left refrigerator
portmap left refrigerator
syslogd left refrigerator
klogd left refrigerator
ifd left refrigerator
...[snip]...
 done
pdflush left refrigerator
toshkey left refrigerator
hub 1-0:0: debounce: port 5: delay 100ms stable 4 status 0x501
eth1: Error -110 writing Tx descriptor to BAP
message repeated 23963 times
eth1: Error -110 setting multicast list.
eth1: Error -110 writing Tx descriptor to BAP
hermes @ IO 0x100: Card removed while issuing command.
eth1: Error -19 disabling MAC port
unregister_netdevice: waiting for eth1 to become free. Usage count = -7
unregister_netdevice: waiting for eth1 to become free. Usage count = -7
unregister_netdevice: waiting for eth1 to become free. Usage count = -7
Kernel logging (proc) stopped.
Kernel log daemon terminating.

dmesg output:
Inspecting /boot/System.map-2.6.0-test1
Loaded 24038 symbols from /boot/System.map-2.6.0-test1.
Symbols match kernel version 2.6.0.
No module symbols loaded - kernel modules not enabled. 
Linux version 2.6.0-test1 (root@cerebus) (gcc version 3.3.1 20030626 (Debian
prerelease)) #4 Wed Jul 23 19:24:16 CDT 2003
Video mode to be used for restore is ffff
BIOS-provided physical RAM map:
 BIOS-e820: 0000000000000000 - 000000000009fc00 (usable)
 BIOS-e820: 000000000009fc00 - 00000000000a0000 (reserved)
 BIOS-e820: 00000000000e0000 - 00000000000eee00 (reserved)
 BIOS-e820: 00000000000eee00 - 00000000000ef000 (ACPI NVS)
 BIOS-e820: 00000000000ef000 - 0000000000100000 (reserved)
 BIOS-e820: 0000000000100000 - 000000001ffcc000 (usable)
 BIOS-e820: 000000001ffcc000 - 000000001ffd0000 (reserved)
 BIOS-e820: 000000001ffd0000 - 000000001ffe0000 (ACPI data)
 BIOS-e820: 000000001ffe0000 - 0000000020000000 (reserved)
 BIOS-e820: 00000000feda0000 - 00000000fedc0000 (reserved)
 BIOS-e820: 00000000ffb80000 - 00000000ffc00000 (reserved)
 BIOS-e820: 00000000fff80000 - 0000000100000000 (reserved)
511MB LOWMEM available.
On node 0 totalpages: 131020
  DMA zone: 4096 pages, LIFO batch:1
  Normal zone: 126924 pages, LIFO batch:16
  HighMem zone: 0 pages, LIFO batch:1
ACPI: RSDP (v000 TOSHIB                     ) @ 0x000f0180
ACPI: RSDT (v001 TOSHIB 5200     08194.02057) @ 0x1ffd0000
ACPI: FADT (v002 TOSHIB 5200     08194.02057) @ 0x1ffd0058
ACPI: DBGP (v001 TOSHIB 5200     08194.02057) @ 0x1ffd00dc
ACPI: BOOT (v001 TOSHIB 5200     08194.02057) @ 0x1ffd0030
ACPI: DSDT (v001 TOSHIB 5200     08194.02057) @ 0x00000000
ACPI: BIOS passes blacklist
ACPI: MADT not present
Building zonelist for node : 0
Kernel command line: root=/dev/hda5 ro
Local APIC disabled by BIOS -- reenabling.
Found and enabled local APIC!
Initializing CPU#0
PID hash table entries: 2048 (order 11: 16384 bytes)
Detected 1994.115 MHz processor.
Console: colour VGA+ 80x25
Calibrating delay loop... 3940.35 BogoMIPS
Memory: 514916k/524080k available (1954k kernel code, 8368k reserved, 861k data,
136k init, 0k highmem)
Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)
Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)
Mount-cache hash table entries: 512 (order: 0, 4096 bytes)
-> /dev
-> /dev/console
-> /root
CPU: Trace cache: 12K uops, L1 D cache: 8K
CPU: L2 cache: 512K
CPU:     After generic, caps: bfebfbff 00000000 00000000 00000080
Intel machine check architecture supported.
Intel machine check reporting enabled on CPU#0.
CPU#0: Intel P4/Xeon Extended MCE MSRs (12) available
CPU#0: Thermal monitoring enabled
CPU: Intel Mobile Intel(R) Pentium(R) 4 - M CPU 2.00GHz stepping 07
Enabling fast FPU save and restore... done.
Enabling unmasked SIMD FPU exception support... done.
Checking 'hlt' instruction... OK.
POSIX conformance testing by UNIFIX
enabled ExtINT on CPU#0
ESR value before enabling vector: 00000000
ESR value after enabling vector: 00000000
Using local APIC timer interrupts.
calibrating APIC timer ...
..... CPU clock speed is 1993.0204 MHz.
..... host bus clock speed is 99.0660 MHz.
Initializing RT netlink socket
PCI: PCI BIOS revision 2.10 entry at 0xfcebc, last bus=4
PCI: Using configuration type 1
mtrr: v2.0 (20020519)
BIO: pool of 256 setup, 15Kb (60 bytes/bio)
biovec pool[0]:   1 bvecs: 256 entries (12 bytes)
biovec pool[1]:   4 bvecs: 256 entries (48 bytes)
biovec pool[2]:  16 bvecs: 256 entries (192 bytes)
biovec pool[3]:  64 bvecs: 256 entries (768 bytes)
biovec pool[4]: 128 bvecs: 256 entries (1536 bytes)
biovec pool[5]: 256 bvecs: 256 entries (3072 bytes)
ACPI: Subsystem revision 20030619
 tbxface-0117 [03] acpi_load_tables      : ACPI Tables successfully acquired
Parsing all Control
Methods:................................................................................................................................................
Table [DSDT](id F004) - 741 Objects with 70 Devices 144 Methods 16 Regions
ACPI Namespace successfully loaded at root c03f803c
evxfevnt-0093 [04] acpi_enable           : Transition to ACPI mode successful
evgpeblk-0748 [06] ev_create_gpe_block   : GPE 00 to 15 [_GPE] 2 regs at
000000000000EE28 on int 9
Completing Region/Field/Buffer/Package
initialization:.........................................................
Initialized 16/16 Regions 0/0 Fields 18/18 Buffers 23/23 Packages (749 nodes)
Executing all Device _STA and_INI
methods:.......................................................................
71 Devices found containing: 71 _STA, 1 _INI methods
ACPI: Interpreter enabled
ACPI: Using PIC for interrupt routing
ACPI: PCI Interrupt Link [LNKA] (IRQs 3 4 6 7 10 11 12, disabled)
ACPI: PCI Interrupt Link [LNKB] (IRQs 3 4 6 7 10 11 12, disabled)
ACPI: PCI Interrupt Link [LNKC] (IRQs 3 4 6 7 10 *11 12)
ACPI: PCI Interrupt Link [LNKD] (IRQs 3 4 *6 7 10 11 12)
ACPI: PCI Interrupt Link [LNKE] (IRQs 3 *4 6 7 10 11 12)
ACPI: PCI Interrupt Link [LNKF] (IRQs 3 4 6 7 10 11 12, disabled)
ACPI: PCI Interrupt Link [LNKG] (IRQs *5)
ACPI: PCI Interrupt Link [LNKH] (IRQs 3 4 6 7 10 11 12, disabled)
ACPI: PCI Root Bridge [PCI0] (00:00)
PCI: Probing PCI hardware (bus 00)
Transparent bridge - Intel Corp. 82801BAM/CAM PCI Bri
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0._PRT]
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCIB._PRT]
ACPI: PCI Interrupt Routing Table [\_SB_.PCI0.PCI1._PRT]
ACPI: Power Resource [PFN0] (off)
ACPI: Power Resource [PFN1] (off)
Linux Plug and Play Support v0.96 (c) Adam Belay
PnPBIOS: Scanning system for PnP BIOS support...
PnPBIOS: A PnP BIOS was not detected.
drivers/usb/core/usb.c: registered new driver usbfs
drivers/usb/core/usb.c: registered new driver hub
ACPI: PCI Interrupt Link [LNKA] enabled at IRQ 10
ACPI: PCI Interrupt Link [LNKB] enabled at IRQ 11
ACPI: PCI Interrupt Link [LNKF] enabled at IRQ 10
ACPI: PCI Interrupt Link [LNKH] enabled at IRQ 11
PCI: Using ACPI for IRQ routing
PCI: if you experience problems, try using option 'pci=noacpi' or even 'acpi=off'
pty: 256 Unix98 ptys configured
SBF: Simple Boot Flag extension found and enabled.
SBF: Setting boot flags 0x1
cpufreq: P4/Xeon(TM) CPU On-Demand Clock Modulation available
Enabling SEP on CPU 0
Journalled Block Device driver loaded
Installing knfsd (copyright (C) 1996 okir@monad.swb.de).
Initializing Cryptographic API
ACPI: AC Adapter [ADP1] (on-line)
ACPI: Battery Slot [BAT1] (battery present)
ACPI: Battery Slot [BAT2] (battery absent)
ACPI: Power Button (FF) [PWRF]
ACPI: Lid Switch [LID]
ACPI: Fan [FAN0] (off)
ACPI: Fan [FAN1] (off)
ACPI: Processor [CPU0] (supports C1 C2 C3)
ACPI: Thermal Zone [THRM] (35 C)
Toshiba Laptop ACPI Extras version 0.15
hw_random: RNG not detected
Linux agpgart interface v0.100 (c) Dave Jones
agpgart: Detected an Intel i845 Chipset.
agpgart: Maximum main memory to use for agp memory: 439M
agpgart: AGP aperture is 256M @ 0xe0000000
Serial: 8250/16550 driver $Revision: 1.90 $ IRQ sharing disabled
PCI: Enabling device 0000:00:1f.6 (0000 -> 0001)
anticipatory scheduling elevator
floppy0: no floppy controllers found
Intel(R) PRO/100 Network Driver - version 2.3.18-k1
Copyright (c) 2003 Intel Corporation

e100: selftest OK.
e100: eth0: Intel(R) PRO/100 Network Connection
  Hardware receive checksums enabled

Uniform Multi-Platform E-IDE driver Revision: 7.00alpha2
ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx
ICH3M: IDE controller at PCI slot 0000:00:1f.1
ICH3M: chipset revision 2
ICH3M: not 100%% native mode: will probe irqs later
    ide0: BM-DMA at 0xcfa0-0xcfa7, BIOS settings: hda:DMA, hdb:DMA
    ide1: BM-DMA at 0xcfa8-0xcfaf, BIOS settings: hdc:pio, hdd:pio
hda: TOSHIBA MK4018GAS, ATA DISK drive
hdb: TOSHIBA DVD-ROM SD-R6012, ATAPI CD/DVD-ROM drive
ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
hda: max request size: 128KiB
hda: host protected area => 1
hda: 78140160 sectors (40008 MB), CHS=77520/16/63, UDMA(100)
 hda: hda1 hda2 < hda5 hda6 >
PCI: Enabling device 0000:02:06.2 (0000 -> 0002)
ehci_hcd 0000:02:06.2: NEC Corporation USB 2.0
ehci_hcd 0000:02:06.2: irq 11, pci mem e0850400
ehci_hcd 0000:02:06.2: new USB bus registered, assigned bus number 1
ehci_hcd 0000:02:06.2: USB 2.0 enabled, EHCI 0.95, driver 2003-Jun-13
hub 1-0:0: USB hub found
hub 1-0:0: 5 ports detected
drivers/usb/host/uhci-hcd.c: USB Universal Host Controller Interface driver v2.1
mice: PS/2 mouse device common for all mice
input: PC Speaker
spurious 8259A interrupt: IRQ7.
serio: i8042 AUX port at 0x60,0x64 irq 12
input: AT Set 2 keyboard on isa0060/serio0
serio: i8042 KBD port at 0x60,0x64 irq 1
NET4: Linux TCP/IP 1.0 for NET4.0
IP: routing cache hash table of 4096 buckets, 32Kbytes
TCP: Hash tables configured (established 32768 bind 65536)
NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.
cpufreq: No CPUs supporting ACPI performance management found.
BIOS EDD facility v0.09 2003-Jan-22, 1 devices found
ACPI: (supports S0 S3 S4 S5)
EXT3-fs: INFO: recovery required on readonly filesystem.
EXT3-fs: write access will be enabled during recovery.
hub 1-0:0: debounce: port 5: delay 100ms stable 4 status 0x501
kjournald starting.  Commit interval 5 seconds
EXT3-fs: hda5: orphan cleanup on readonly fs
ext3_orphan_cleanup: deleting unreferenced inode 245451
ext3_orphan_cleanup: deleting unreferenced inode 245396
EXT3-fs: hda5: 2 orphan inodes deleted
EXT3-fs: recovery complete.
EXT3-fs: mounted filesystem with ordered data mode.
VFS: Mounted root (ext3 filesystem) readonly.
Freeing unused kernel memory: 136k freed
Adding 674688k swap on /dev/hda6.  Priority:-1 extents:1
EXT3 FS on hda5, internal journal
Real Time Clock Driver v1.11
drivers/usb/core/usb.c: registered new driver hiddev
drivers/usb/core/usb.c: registered new driver hid
drivers/usb/input/hid-core.c: v2.0:USB HID core driver
NTFS driver 2.1.4 [Flags: R/O MODULE].
NTFS volume version 3.1.
lp: driver loaded but no devices found
PCI: Enabling device 0000:00:1f.5 (0000 -> 0001)
PCI: Setting latency timer of device 0000:00:1f.5 to 64
intel8x0: clocking to 48000
IPv6 v0.8 for NET4.0
IPv6 over IPv4 tunneling driver
Linux Kernel Card Services 3.1.22
  options:  [pci] [cardbus] [pm]
PCI: Enabling device 0000:02:0a.0 (0000 -> 0002)
Yenta IRQ list 0000, PCI irq11
Socket status: 30000010
PCI: Enabling device 0000:02:0b.0 (0000 -> 0002)
Yenta IRQ list 0008, PCI irq10
Socket status: 30000007
cs: IO port probe 0x0c00-0x0cff: clean.
cs: IO port probe 0x0800-0x08ff: clean.
cs: IO port probe 0x0100-0x04ff: excluding 0x170-0x177 0x1e0-0x1e7 0x370-0x377
0x3c0-0x3df 0x4d0-0x4d7
cs: IO port probe 0x0a00-0x0aff: clean.
cs: memory probe 0xa0000000-0xa0ffffff: clean.
orinoco.c 0.13e (David Gibson <hermes@gibson.dropbear.id.au> and others)
orinoco_cs.c 0.13e (David Gibson <hermes@gibson.dropbear.id.au> and others)
eth1: Station identity 001f:0001:0008:000a
eth1: Looks like a Lucent/Agere firmware version 8.10
eth1: Ad-hoc demo mode supported
eth1: IEEE standard IBSS ad-hoc mode supported
eth1: WEP supported, 104-bit key
eth1: MAC address 00:02:2D:6F:6B:A6
eth1: Station name "HERMES I"
eth1: ready
eth1: index 0x01: Vcc 3.3, irq 11, io 0x0100-0x013f
eth1: New link status: Connected (0001)
eth1: New link status: Connected (0001)
eth0: no IPv6 routers present
eth1: no IPv6 routers present


Steps to reproduce:
echo "S3" > /proc/acpi/sleep

