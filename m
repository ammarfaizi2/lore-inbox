Return-Path: <linux-kernel-owner+willy=40w.ods.org-S267306AbUGVVia@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S267306AbUGVVia (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 22 Jul 2004 17:38:30 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S267303AbUGVVia
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 22 Jul 2004 17:38:30 -0400
Received: from hqemgate00.nvidia.com ([216.228.112.144]:28175 "EHLO
	hqemgate00.nvidia.com") by vger.kernel.org with ESMTP
	id S267300AbUGVViJ (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Thu, 22 Jul 2004 17:38:09 -0400
X-MimeOLE: Produced By Microsoft Exchange V6.5.7226.0
Content-class: urn:content-classes:message
MIME-Version: 1.0
Content-Type: multipart/mixed;
	boundary="----_=_NextPart_001_01C47034.2D4882BF"
Subject: [PATCH 2.6.8-rc2] sata_nv.c
Date: Thu, 22 Jul 2004 14:38:07 -0700
Message-ID: <DBFABB80F7FD3143A911F9E6CFD477B03F95E1@hqemmail02.nvidia.com>
X-MS-Has-Attach: yes
X-MS-TNEF-Correlator: 
Thread-Topic: [PATCH 2.6.8-rc2] sata_nv.c
Thread-Index: AcRwNC9h72vWwbEVTnSWgRVTmWug8Q==
From: "Andrew Chew" <achew@nvidia.com>
To: <linux-kernel@vger.kernel.org>
Cc: <jgarzik@pobox.com>, <linux-ide@vger.kernel.org>
X-OriginalArrivalTime: 22 Jul 2004 21:38:08.0394 (UTC) FILETIME=[2DE6FEA0:01C47034]
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

This is a multi-part message in MIME format.

------_=_NextPart_001_01C47034.2D4882BF
Content-Type: text/plain;
	charset="us-ascii"
Content-Transfer-Encoding: quoted-printable

This patch updates the NVIDIA libata-based SATA driver to support the
CK804 SATA controller.

------_=_NextPart_001_01C47034.2D4882BF
Content-Type: application/octet-stream;
	name="sata_nv.diff"
Content-Transfer-Encoding: base64
Content-Description: sata_nv.diff
Content-Disposition: attachment;
	filename="sata_nv.diff"

LS0tIGxpbnV4LTIuNi44LXJjMi9kcml2ZXJzL3Njc2kvc2F0YV9udi5jCTIwMDQtMDctMjEgMTU6
MjI6NDkuMDAwMDAwMDAwIC0wNzAwCisrKyBsaW51eC9kcml2ZXJzL3Njc2kvc2F0YV9udi5jCTIw
MDQtMDctMjIgMTQ6MjU6NDcuNDczNjAxODAwIC0wNzAwCkBAIC0yMCw2ICsyMCwxMSBAQAogICog
IElmIHlvdSBkbyBub3QgZGVsZXRlIHRoZSBwcm92aXNpb25zIGFib3ZlLCBhIHJlY2lwaWVudCBt
YXkgdXNlIHlvdXIKICAqICB2ZXJzaW9uIG9mIHRoaXMgZmlsZSB1bmRlciBlaXRoZXIgdGhlIE9T
TCBvciB0aGUgR1BMLgogICoKKyAqICAwLjAyCisgKiAgICAgLSBBZGRlZCBzdXBwb3J0IGZvciBD
SzgwNCBTQVRBIGNvbnRyb2xsZXIuCisgKgorICogIDAuMDEKKyAqICAgICAtIEluaXRpYWwgcmV2
aXNpb24uCiAgKi8KIAogI2luY2x1ZGUgPGxpbnV4L2NvbmZpZy5oPgpAQCAtMzUsNyArNDAsNyBA
QAogI2luY2x1ZGUgPGxpbnV4L2xpYmF0YS5oPgogCiAjZGVmaW5lIERSVl9OQU1FCQkJInNhdGFf
bnYiCi0jZGVmaW5lIERSVl9WRVJTSU9OCQkJIjAuMDEiCisjZGVmaW5lIERSVl9WRVJTSU9OCQkJ
IjAuMDIiCiAKICNkZWZpbmUgTlZfUE9SVFMJCQkyCiAjZGVmaW5lIE5WX1BJT19NQVNLCQkJMHgx
ZgpAQCAtNDYsNiArNTEsNyBAQAogI2RlZmluZSBOVl9QT1JUMV9TQ1JfUkVHX09GRlNFVAkJMHg0
MAogCiAjZGVmaW5lIE5WX0lOVF9TVEFUVVMJCQkweDEwCisjZGVmaW5lIE5WX0lOVF9TVEFUVVNf
Q0s4MDQJCTB4NDQwCiAjZGVmaW5lIE5WX0lOVF9TVEFUVVNfUERFVl9JTlQJCTB4MDEKICNkZWZp
bmUgTlZfSU5UX1NUQVRVU19QREVWX1BNCQkweDAyCiAjZGVmaW5lIE5WX0lOVF9TVEFUVVNfUERF
Vl9BRERFRAkweDA0CkBAIC02Miw2ICs2OCw3IEBACiAJCQkJCU5WX0lOVF9TVEFUVVNfU0RFVl9I
T1RQTFVHKQogCiAjZGVmaW5lIE5WX0lOVF9FTkFCTEUJCQkweDExCisjZGVmaW5lIE5WX0lOVF9F
TkFCTEVfQ0s4MDQJCTB4NDQxCiAjZGVmaW5lIE5WX0lOVF9FTkFCTEVfUERFVl9NQVNLCQkweDAx
CiAjZGVmaW5lIE5WX0lOVF9FTkFCTEVfUERFVl9QTQkJMHgwMgogI2RlZmluZSBOVl9JTlRfRU5B
QkxFX1BERVZfQURERUQJMHgwNApAQCAtODUsMjUgKzkyLDc4IEBACiBzdGF0aWMgdTMyIG52X3Nj
cl9yZWFkIChzdHJ1Y3QgYXRhX3BvcnQgKmFwLCB1bnNpZ25lZCBpbnQgc2NfcmVnKTsKIHN0YXRp
YyB2b2lkIG52X3Njcl93cml0ZSAoc3RydWN0IGF0YV9wb3J0ICphcCwgdW5zaWduZWQgaW50IHNj
X3JlZywgdTMyIHZhbCk7CiBzdGF0aWMgdm9pZCBudl9ob3N0X3N0b3AgKHN0cnVjdCBhdGFfaG9z
dF9zZXQgKmhvc3Rfc2V0KTsKK3N0YXRpYyB2b2lkIG52X2VuYWJsZV9ob3RwbHVnKHN0cnVjdCBh
dGFfcHJvYmVfZW50ICpwcm9iZV9lbnQpOworc3RhdGljIHZvaWQgbnZfZGlzYWJsZV9ob3RwbHVn
KHN0cnVjdCBhdGFfaG9zdF9zZXQgKmhvc3Rfc2V0KTsKK3N0YXRpYyB2b2lkIG52X2NoZWNrX2hv
dHBsdWcoc3RydWN0IGF0YV9ob3N0X3NldCAqaG9zdF9zZXQpOworc3RhdGljIHZvaWQgbnZfZW5h
YmxlX2hvdHBsdWdfY2s4MDQoc3RydWN0IGF0YV9wcm9iZV9lbnQgKnByb2JlX2VudCk7CitzdGF0
aWMgdm9pZCBudl9kaXNhYmxlX2hvdHBsdWdfY2s4MDQoc3RydWN0IGF0YV9ob3N0X3NldCAqaG9z
dF9zZXQpOworc3RhdGljIHZvaWQgbnZfY2hlY2tfaG90cGx1Z19jazgwNChzdHJ1Y3QgYXRhX2hv
c3Rfc2V0ICpob3N0X3NldCk7CisKK3R5cGVkZWYgZW51bQoreworCU5GT1JDRTIgPSAwLAorCU5G
T1JDRTMsCisJQ0s4MDQKK30gbnZfaG9zdF90eXBlX3Q7CiAKIHN0YXRpYyBzdHJ1Y3QgcGNpX2Rl
dmljZV9pZCBudl9wY2lfdGJsW10gPSB7CiAJeyBQQ0lfVkVORE9SX0lEX05WSURJQSwgUENJX0RF
VklDRV9JRF9OVklESUFfTkZPUkNFMlNfU0FUQSwKLQkJUENJX0FOWV9JRCwgUENJX0FOWV9JRCwg
fSwKKwkJUENJX0FOWV9JRCwgUENJX0FOWV9JRCwgMCwgMCwgTkZPUkNFMiB9LAogCXsgUENJX1ZF
TkRPUl9JRF9OVklESUEsIFBDSV9ERVZJQ0VfSURfTlZJRElBX05GT1JDRTNTX1NBVEEsCi0JCVBD
SV9BTllfSUQsIFBDSV9BTllfSUQsIH0sCisJCVBDSV9BTllfSUQsIFBDSV9BTllfSUQsIDAsIDAs
IE5GT1JDRTMgfSwKIAl7IFBDSV9WRU5ET1JfSURfTlZJRElBLCBQQ0lfREVWSUNFX0lEX05WSURJ
QV9ORk9SQ0UzU19TQVRBMiwKLQkJUENJX0FOWV9JRCwgUENJX0FOWV9JRCwgfSwKKwkJUENJX0FO
WV9JRCwgUENJX0FOWV9JRCwgMCwgMCwgTkZPUkNFMyB9LAogCXsgUENJX1ZFTkRPUl9JRF9OVklE
SUEsIFBDSV9ERVZJQ0VfSURfTlZJRElBX05GT1JDRV9DSzgwNF9TQVRBLAotCQlQQ0lfQU5ZX0lE
LCBQQ0lfQU5ZX0lELCB9LAorCQlQQ0lfQU5ZX0lELCBQQ0lfQU5ZX0lELCAwLCAwLCBDSzgwNCB9
LAogCXsgUENJX1ZFTkRPUl9JRF9OVklESUEsIFBDSV9ERVZJQ0VfSURfTlZJRElBX05GT1JDRV9D
SzgwNF9TQVRBMiwKLQkJUENJX0FOWV9JRCwgUENJX0FOWV9JRCwgfSwKKwkJUENJX0FOWV9JRCwg
UENJX0FOWV9JRCwgMCwgMCwgQ0s4MDQgfSwKIAl7IFBDSV9WRU5ET1JfSURfTlZJRElBLCBQQ0lf
REVWSUNFX0lEX05WSURJQV9ORk9SQ0VfTUNQMDRfU0FUQSwKLQkJUENJX0FOWV9JRCwgUENJX0FO
WV9JRCwgfSwKKwkJUENJX0FOWV9JRCwgUENJX0FOWV9JRCwgMCwgMCwgQ0s4MDQgfSwKIAl7IFBD
SV9WRU5ET1JfSURfTlZJRElBLCBQQ0lfREVWSUNFX0lEX05WSURJQV9ORk9SQ0VfTUNQMDRfU0FU
QTIsCi0JCVBDSV9BTllfSUQsIFBDSV9BTllfSUQsIH0sCisJCVBDSV9BTllfSUQsIFBDSV9BTllf
SUQsIDAsIDAsIENLODA0IH0sCiAJeyAwLCB9IC8qIHRlcm1pbmF0ZSBsaXN0ICovCiB9OwogCisj
ZGVmaW5lIE5WX0hPU1RfRkxBR1NfU0NSX01NSU8JMHgwMDAwMDAwMQorCit0eXBlZGVmIHN0cnVj
dAoreworCW52X2hvc3RfdHlwZV90CQlob3N0X3R5cGU7CisJdW5zaWduZWQgbG9uZwkJaG9zdF9m
bGFnczsKKwl2b2lkCQkJKCplbmFibGVfaG90cGx1Zykoc3RydWN0IGF0YV9wcm9iZV9lbnQgKnBy
b2JlX2VudCk7CisJdm9pZAkJCSgqZGlzYWJsZV9ob3RwbHVnKShzdHJ1Y3QgYXRhX2hvc3Rfc2V0
ICpob3N0X3NldCk7CisJdm9pZAkJCSgqY2hlY2tfaG90cGx1Zykoc3RydWN0IGF0YV9ob3N0X3Nl
dCAqaG9zdF9zZXQpOworCit9IG52X2hvc3RfZGVzY190Oworc3RhdGljIG52X2hvc3RfZGVzY190
IG52X2RldmljZV90YmxbXSA9IHsKKwl7CisJCS5ob3N0X3R5cGUJPSBORk9SQ0UyLAorCQkuaG9z
dF9mbGFncwk9IDB4MDAwMDAwMDAsCisJCS5lbmFibGVfaG90cGx1Zwk9IG52X2VuYWJsZV9ob3Rw
bHVnLAorCQkuZGlzYWJsZV9ob3RwbHVnPSBudl9kaXNhYmxlX2hvdHBsdWcsCisJCS5jaGVja19o
b3RwbHVnCT0gbnZfY2hlY2tfaG90cGx1ZywKKwl9LAorCXsKKwkJLmhvc3RfdHlwZQk9IE5GT1JD
RTMsCisJCS5ob3N0X2ZsYWdzCT0gMHgwMDAwMDAwMCwKKwkJLmVuYWJsZV9ob3RwbHVnCT0gbnZf
ZW5hYmxlX2hvdHBsdWcsCisJCS5kaXNhYmxlX2hvdHBsdWc9IG52X2Rpc2FibGVfaG90cGx1ZywK
KwkJLmNoZWNrX2hvdHBsdWcJPSBudl9jaGVja19ob3RwbHVnLAorCX0sCisJewkuaG9zdF90eXBl
CT0gQ0s4MDQsCisJCS5ob3N0X2ZsYWdzCT0gTlZfSE9TVF9GTEFHU19TQ1JfTU1JTywKKwkJLmVu
YWJsZV9ob3RwbHVnCT0gbnZfZW5hYmxlX2hvdHBsdWdfY2s4MDQsCisJCS5kaXNhYmxlX2hvdHBs
dWc9IG52X2Rpc2FibGVfaG90cGx1Z19jazgwNCwKKwkJLmNoZWNrX2hvdHBsdWcJPSBudl9jaGVj
a19ob3RwbHVnX2NrODA0LAorCX0sCit9OworCit0eXBlZGVmIHN0cnVjdAoreworCW52X2hvc3Rf
ZGVzY190CQkqaG9zdF9kZXNjOworCXVuc2lnbmVkIGxvbmcJCXNjcl9hZGRyOworfSBudl9ob3N0
X3Q7CisKIHN0YXRpYyBzdHJ1Y3QgcGNpX2RyaXZlciBudl9wY2lfZHJpdmVyID0gewogCS5uYW1l
CQkJPSBEUlZfTkFNRSwKIAkuaWRfdGFibGUJCT0gbnZfcGNpX3RibCwKQEAgLTE1OCwxMSArMjE4
LDEwIEBACiBpcnFyZXR1cm5fdCBudl9pbnRlcnJ1cHQgKGludCBpcnEsIHZvaWQgKmRldl9pbnN0
YW5jZSwgc3RydWN0IHB0X3JlZ3MgKnJlZ3MpCiB7CiAJc3RydWN0IGF0YV9ob3N0X3NldCAqaG9z
dF9zZXQgPSBkZXZfaW5zdGFuY2U7CisJbnZfaG9zdF90ICpob3N0ID0gaG9zdF9zZXQtPnByaXZh
dGVfZGF0YTsKIAl1bnNpZ25lZCBpbnQgaTsKIAl1bnNpZ25lZCBpbnQgaGFuZGxlZCA9IDA7CiAJ
dW5zaWduZWQgbG9uZyBmbGFnczsKLQl1OCBpbnRyX3N0YXR1czsKLQl1OCBpbnRyX2VuYWJsZTsK
IAogCXNwaW5fbG9ja19pcnFzYXZlKCZob3N0X3NldC0+bG9jaywgZmxhZ3MpOwogCkBAIC0xNzgs
MzMgKzIzNywxMCBAQAogCQkJCWhhbmRsZWQgKz0gYXRhX2hvc3RfaW50cihhcCwgcWMpOwogCQl9
CiAKLQkJaW50cl9zdGF0dXMgPSBpbmIoYXAtPmlvYWRkci5zY3JfYWRkciArIE5WX0lOVF9TVEFU
VVMpOwotCQlpbnRyX2VuYWJsZSA9IGluYihhcC0+aW9hZGRyLnNjcl9hZGRyICsgTlZfSU5UX0VO
QUJMRSk7Ci0KLQkJLy8gQ2xlYXIgaW50ZXJydXB0IHN0YXR1cy4KLQkJb3V0YigweGZmLCBhcC0+
aW9hZGRyLnNjcl9hZGRyICsgTlZfSU5UX1NUQVRVUyk7CisJfQogCi0JCWlmIChpbnRyX3N0YXR1
cyAmIE5WX0lOVF9TVEFUVVNfSE9UUExVRykgewotCQkJaWYgKGludHJfc3RhdHVzICYgTlZfSU5U
X1NUQVRVU19QREVWX0FEREVEKSB7Ci0JCQkJcHJpbnRrKEtFUk5fV0FSTklORyAiYXRhJXU6ICIK
LQkJCQkJIlByaW1hcnkgZGV2aWNlIGFkZGVkXG4iLCBhcC0+aWQpOwotCQkJfQotCi0JCQlpZiAo
aW50cl9zdGF0dXMgJiBOVl9JTlRfU1RBVFVTX1BERVZfUkVNT1ZFRCkgewotCQkJCXByaW50ayhL
RVJOX1dBUk5JTkcgImF0YSV1OiAiCi0JCQkJCSJQcmltYXJ5IGRldmljZSByZW1vdmVkXG4iLCBh
cC0+aWQpOwotCQkJfQotCi0JCQlpZiAoaW50cl9zdGF0dXMgJiBOVl9JTlRfU1RBVFVTX1NERVZf
QURERUQpIHsKLQkJCQlwcmludGsoS0VSTl9XQVJOSU5HICJhdGEldTogIgotCQkJCQkiU2Vjb25k
YXJ5IGRldmljZSBhZGRlZFxuIiwgYXAtPmlkKTsKLQkJCX0KLQotCQkJaWYgKGludHJfc3RhdHVz
ICYgTlZfSU5UX1NUQVRVU19TREVWX1JFTU9WRUQpIHsKLQkJCQlwcmludGsoS0VSTl9XQVJOSU5H
ICJhdGEldTogIgotCQkJCQkiU2Vjb25kYXJ5IGRldmljZSByZW1vdmVkXG4iLCBhcC0+aWQpOwot
CQkJfQotCQl9CisJaWYgKGhvc3QtPmhvc3RfZGVzYy0+Y2hlY2tfaG90cGx1ZykgeworCQlob3N0
LT5ob3N0X2Rlc2MtPmNoZWNrX2hvdHBsdWcoaG9zdF9zZXQpOwogCX0KIAogCXNwaW5fdW5sb2Nr
X2lycXJlc3RvcmUoJmhvc3Rfc2V0LT5sb2NrLCBmbGFncyk7CkBAIC0yMTQsNDEgKzI1MCw1MSBA
QAogCiBzdGF0aWMgdTMyIG52X3Njcl9yZWFkIChzdHJ1Y3QgYXRhX3BvcnQgKmFwLCB1bnNpZ25l
ZCBpbnQgc2NfcmVnKQogeworCXN0cnVjdCBhdGFfaG9zdF9zZXQgKmhvc3Rfc2V0ID0gYXAtPmhv
c3Rfc2V0OworCW52X2hvc3RfdCAqaG9zdCA9IGhvc3Rfc2V0LT5wcml2YXRlX2RhdGE7CisKIAlp
ZiAoc2NfcmVnID4gU0NSX0NPTlRST0wpCiAJCXJldHVybiAweGZmZmZmZmZmVTsKIAotCXJldHVy
biBpbmwoYXAtPmlvYWRkci5zY3JfYWRkciArIChzY19yZWcgKiA0KSk7CisJaWYgKGhvc3QtPmhv
c3RfZGVzYy0+aG9zdF9mbGFncyAmIE5WX0hPU1RfRkxBR1NfU0NSX01NSU8pIHsKKwkJcmV0dXJu
IHJlYWRsKGFwLT5pb2FkZHIuc2NyX2FkZHIgKyAoc2NfcmVnICogNCkpOworCX0gZWxzZSB7CisJ
CXJldHVybiBpbmwoYXAtPmlvYWRkci5zY3JfYWRkciArIChzY19yZWcgKiA0KSk7CisJfQogfQog
CiBzdGF0aWMgdm9pZCBudl9zY3Jfd3JpdGUgKHN0cnVjdCBhdGFfcG9ydCAqYXAsIHVuc2lnbmVk
IGludCBzY19yZWcsIHUzMiB2YWwpCiB7CisJc3RydWN0IGF0YV9ob3N0X3NldCAqaG9zdF9zZXQg
PSBhcC0+aG9zdF9zZXQ7CisJbnZfaG9zdF90ICpob3N0ID0gaG9zdF9zZXQtPnByaXZhdGVfZGF0
YTsKKwogCWlmIChzY19yZWcgPiBTQ1JfQ09OVFJPTCkKIAkJcmV0dXJuOwogCi0Jb3V0bCh2YWws
IGFwLT5pb2FkZHIuc2NyX2FkZHIgKyAoc2NfcmVnICogNCkpOworCWlmIChob3N0LT5ob3N0X2Rl
c2MtPmhvc3RfZmxhZ3MgJiBOVl9IT1NUX0ZMQUdTX1NDUl9NTUlPKSB7CisJCXdyaXRlbCh2YWws
IGFwLT5pb2FkZHIuc2NyX2FkZHIgKyAoc2NfcmVnICogNCkpOworCX0gZWxzZSB7CisJCW91dGwo
dmFsLCBhcC0+aW9hZGRyLnNjcl9hZGRyICsgKHNjX3JlZyAqIDQpKTsKKwl9CiB9CiAKIHN0YXRp
YyB2b2lkIG52X2hvc3Rfc3RvcCAoc3RydWN0IGF0YV9ob3N0X3NldCAqaG9zdF9zZXQpCiB7Ci0J
aW50IGk7Ci0KLQlmb3IgKGk9MDsgaTxob3N0X3NldC0+bl9wb3J0czsgaSsrKSB7Ci0JCXU4IGlu
dHJfbWFzazsKKwludl9ob3N0X3QgKmhvc3QgPSBob3N0X3NldC0+cHJpdmF0ZV9kYXRhOwogCi0J
CS8vIERpc2FibGUgaG90cGx1ZyBldmVudCBpbnRlcnJ1cHRzLgotCQlpbnRyX21hc2sgPSBpbmIo
aG9zdF9zZXQtPnBvcnRzW2ldLT5pb2FkZHIuc2NyX2FkZHIgKwotCQkJCU5WX0lOVF9FTkFCTEUp
OwotCQlpbnRyX21hc2sgJj0gfihOVl9JTlRfRU5BQkxFX0hPVFBMVUcpOwotCQlvdXRiKGludHJf
bWFzaywgaG9zdF9zZXQtPnBvcnRzW2ldLT5pb2FkZHIuc2NyX2FkZHIgKwotCQkJCU5WX0lOVF9F
TkFCTEUpOworCS8vIERpc2FibGUgaG90cGx1ZyBldmVudCBpbnRlcnJ1cHRzLgorCWlmIChob3N0
LT5ob3N0X2Rlc2MtPmRpc2FibGVfaG90cGx1ZykgeworCQlob3N0LT5ob3N0X2Rlc2MtPmRpc2Fi
bGVfaG90cGx1Zyhob3N0X3NldCk7CiAJfQorCisJa2ZyZWUoaG9zdCk7CiB9CiAKIHN0YXRpYyBp
bnQgbnZfaW5pdF9vbmUgKHN0cnVjdCBwY2lfZGV2ICpwZGV2LCBjb25zdCBzdHJ1Y3QgcGNpX2Rl
dmljZV9pZCAqZW50KQogewogCXN0YXRpYyBpbnQgcHJpbnRlZF92ZXJzaW9uID0gMDsKKwludl9o
b3N0X3QgKmhvc3Q7CiAJc3RydWN0IGF0YV9wcm9iZV9lbnQgKnByb2JlX2VudCA9IE5VTEw7Ci0J
aW50IGk7CiAJaW50IHJjOwogCiAJaWYgKCFwcmludGVkX3ZlcnNpb24rKykKQEAgLTI3NSw2ICsz
MjEsMTQgQEAKIAkJZ290byBlcnJfb3V0X3JlZ2lvbnM7CiAJfQogCisJaG9zdCA9IGttYWxsb2Mo
c2l6ZW9mKG52X2hvc3RfdCksIEdGUF9LRVJORUwpOworCWlmICghaG9zdCkgeworCQlyYyA9IC1F
Tk9NRU07CisJCWdvdG8gZXJyX291dF9mcmVlX3Byb2JlX2VudDsKKwl9CisKKwlob3N0LT5ob3N0
X2Rlc2MgPSAmbnZfZGV2aWNlX3RibFtlbnQtPmRyaXZlcl9kYXRhXTsKKwogCW1lbXNldChwcm9i
ZV9lbnQsIDAsIHNpemVvZigqcHJvYmVfZW50KSk7CiAJSU5JVF9MSVNUX0hFQUQoJnByb2JlX2Vu
dC0+bm9kZSk7CiAKQEAgLTI4NCw2ICszMzgsNyBAQAogCQkJCUFUQV9GTEFHX1NBVEFfUkVTRVQg
fAogCQkJCUFUQV9GTEFHX1NSU1QgfAogCQkJCUFUQV9GTEFHX05PX0xFR0FDWTsKKwogCXByb2Jl
X2VudC0+cG9ydF9vcHMgPSAmbnZfb3BzOwogCXByb2JlX2VudC0+bl9wb3J0cyA9IE5WX1BPUlRT
OwogCXByb2JlX2VudC0+aXJxID0gcGRldi0+aXJxOwpAQCAtMjk4LDggKzM1Myw2IEBACiAJCXBj
aV9yZXNvdXJjZV9zdGFydChwZGV2LCAxKSB8IEFUQV9QQ0lfQ1RMX09GUzsKIAlwcm9iZV9lbnQt
PnBvcnRbMF0uYm1kbWFfYWRkciA9CiAJCXBjaV9yZXNvdXJjZV9zdGFydChwZGV2LCA0KSB8IE5W
X1BPUlQwX0JNRE1BX1JFR19PRkZTRVQ7Ci0JcHJvYmVfZW50LT5wb3J0WzBdLnNjcl9hZGRyID0K
LQkJcGNpX3Jlc291cmNlX3N0YXJ0KHBkZXYsIDUpIHwgTlZfUE9SVDBfU0NSX1JFR19PRkZTRVQ7
CiAKIAlwcm9iZV9lbnQtPnBvcnRbMV0uY21kX2FkZHIgPSBwY2lfcmVzb3VyY2Vfc3RhcnQocGRl
diwgMik7CiAJYXRhX3N0ZF9wb3J0cygmcHJvYmVfZW50LT5wb3J0WzFdKTsKQEAgLTMwOCwzMSAr
MzYxLDUwIEBACiAJCXBjaV9yZXNvdXJjZV9zdGFydChwZGV2LCAzKSB8IEFUQV9QQ0lfQ1RMX09G
UzsKIAlwcm9iZV9lbnQtPnBvcnRbMV0uYm1kbWFfYWRkciA9CiAJCXBjaV9yZXNvdXJjZV9zdGFy
dChwZGV2LCA0KSB8IE5WX1BPUlQxX0JNRE1BX1JFR19PRkZTRVQ7Ci0JcHJvYmVfZW50LT5wb3J0
WzFdLnNjcl9hZGRyID0KLQkJcGNpX3Jlc291cmNlX3N0YXJ0KHBkZXYsIDUpIHwgTlZfUE9SVDFf
U0NSX1JFR19PRkZTRVQ7CisKKwlwcm9iZV9lbnQtPnByaXZhdGVfZGF0YSA9IGhvc3Q7CisKKwlp
ZiAoaG9zdC0+aG9zdF9kZXNjLT5ob3N0X2ZsYWdzICYgTlZfSE9TVF9GTEFHU19TQ1JfTU1JTykg
eworCQl2b2lkICptbWlvX2Jhc2U7CisJCXVuc2lnbmVkIGxvbmcgYmFzZTsKKworCQltbWlvX2Jh
c2UgPSBpb3JlbWFwKHBjaV9yZXNvdXJjZV9zdGFydChwZGV2LCA1KSwKKwkJCQlwY2lfcmVzb3Vy
Y2VfbGVuKHBkZXYsIDUpKTsKKwkJYmFzZSA9ICh1bnNpZ25lZCBsb25nKW1taW9fYmFzZTsKKwor
CQlwcm9iZV9lbnQtPnBvcnRbMF0uc2NyX2FkZHIgPQorCQkJYmFzZSArIE5WX1BPUlQwX1NDUl9S
RUdfT0ZGU0VUOworCQlwcm9iZV9lbnQtPnBvcnRbMV0uc2NyX2FkZHIgPQorCQkJYmFzZSArIE5W
X1BPUlQxX1NDUl9SRUdfT0ZGU0VUOworCQlob3N0LT5zY3JfYWRkciA9IGJhc2U7CisJfSBlbHNl
IHsKKworCQlwcm9iZV9lbnQtPnBvcnRbMF0uc2NyX2FkZHIgPQorCQkJcGNpX3Jlc291cmNlX3N0
YXJ0KHBkZXYsIDUpIHwgTlZfUE9SVDBfU0NSX1JFR19PRkZTRVQ7CisJCXByb2JlX2VudC0+cG9y
dFsxXS5zY3JfYWRkciA9CisJCQlwY2lfcmVzb3VyY2Vfc3RhcnQocGRldiwgNSkgfCBOVl9QT1JU
MV9TQ1JfUkVHX09GRlNFVDsKKwkJaG9zdC0+c2NyX2FkZHIgPQorCQkJcGNpX3Jlc291cmNlX3N0
YXJ0KHBkZXYsIDUpOworCX0KIAogCXBjaV9zZXRfbWFzdGVyKHBkZXYpOwogCisJLy8gRW5hYmxl
IGhvdHBsdWcgZXZlbnQgaW50ZXJydXB0cy4KKwlpZiAoaG9zdC0+aG9zdF9kZXNjLT5lbmFibGVf
aG90cGx1ZykgeworCQlob3N0LT5ob3N0X2Rlc2MtPmVuYWJsZV9ob3RwbHVnKHByb2JlX2VudCk7
CisJfQorCiAJcmMgPSBhdGFfZGV2aWNlX2FkZChwcm9iZV9lbnQpOwogCWlmIChyYyAhPSBOVl9Q
T1JUUykKIAkJZ290byBlcnJfb3V0X3JlZ2lvbnM7CiAKLQkvLyBFbmFibGUgaG90cGx1ZyBldmVu
dCBpbnRlcnJ1cHRzLgotCWZvciAoaT0wOyBpPHByb2JlX2VudC0+bl9wb3J0czsgaSsrKSB7Ci0J
CXU4IGludHJfbWFzazsKLQotCQlvdXRiKE5WX0lOVF9TVEFUVVNfSE9UUExVRywgcHJvYmVfZW50
LT5wb3J0W2ldLnNjcl9hZGRyICsKLQkJCQkJCU5WX0lOVF9TVEFUVVMpOwotCi0JCWludHJfbWFz
ayA9IGluYihwcm9iZV9lbnQtPnBvcnRbaV0uc2NyX2FkZHIgKyBOVl9JTlRfRU5BQkxFKTsKLQkJ
aW50cl9tYXNrIHw9IE5WX0lOVF9FTkFCTEVfSE9UUExVRzsKLQkJb3V0YihpbnRyX21hc2ssIHBy
b2JlX2VudC0+cG9ydFtpXS5zY3JfYWRkciArIE5WX0lOVF9FTkFCTEUpOwotCX0KLQogCWtmcmVl
KHByb2JlX2VudCk7CiAKIAlyZXR1cm4gMDsKIAorZXJyX291dF9mcmVlX3Byb2JlX2VudDoKKwlr
ZnJlZShwcm9iZV9lbnQpOworCiBlcnJfb3V0X3JlZ2lvbnM6CiAJcGNpX3JlbGVhc2VfcmVnaW9u
cyhwZGV2KTsKIApAQCAtMzQxLDYgKzQxMywxMzMgQEAKIAlyZXR1cm4gcmM7CiB9CiAKK3N0YXRp
YyB2b2lkIG52X2VuYWJsZV9ob3RwbHVnKHN0cnVjdCBhdGFfcHJvYmVfZW50ICpwcm9iZV9lbnQp
Cit7CisJbnZfaG9zdF90ICpob3N0ID0gcHJvYmVfZW50LT5wcml2YXRlX2RhdGE7CisJdTggaW50
cl9tYXNrOworCisJb3V0YihOVl9JTlRfU1RBVFVTX0hPVFBMVUcsCisJCWhvc3QtPnNjcl9hZGRy
ICsgTlZfSU5UX1NUQVRVUyk7CisKKwlpbnRyX21hc2sgPSBpbmIoaG9zdC0+c2NyX2FkZHIgKyBO
Vl9JTlRfRU5BQkxFKTsKKwlpbnRyX21hc2sgfD0gTlZfSU5UX0VOQUJMRV9IT1RQTFVHOworCisJ
b3V0YihpbnRyX21hc2ssIGhvc3QtPnNjcl9hZGRyICsgTlZfSU5UX0VOQUJMRSk7Cit9CisKK3N0
YXRpYyB2b2lkIG52X2Rpc2FibGVfaG90cGx1ZyhzdHJ1Y3QgYXRhX2hvc3Rfc2V0ICpob3N0X3Nl
dCkKK3sKKwludl9ob3N0X3QgKmhvc3QgPSBob3N0X3NldC0+cHJpdmF0ZV9kYXRhOworCXU4IGlu
dHJfbWFzazsKKworCWludHJfbWFzayA9IGluYihob3N0LT5zY3JfYWRkciArIE5WX0lOVF9FTkFC
TEUpOworCisJaW50cl9tYXNrICY9IH4oTlZfSU5UX0VOQUJMRV9IT1RQTFVHKTsKKworCW91dGIo
aW50cl9tYXNrLCBob3N0LT5zY3JfYWRkciArIE5WX0lOVF9FTkFCTEUpOworfQorCitzdGF0aWMg
dm9pZCBudl9jaGVja19ob3RwbHVnKHN0cnVjdCBhdGFfaG9zdF9zZXQgKmhvc3Rfc2V0KQorewor
CW52X2hvc3RfdCAqaG9zdCA9IGhvc3Rfc2V0LT5wcml2YXRlX2RhdGE7CisJdTggaW50cl9zdGF0
dXM7CisKKwlpbnRyX3N0YXR1cyA9IGluYihob3N0LT5zY3JfYWRkciArIE5WX0lOVF9TVEFUVVMp
OworCisJLy8gQ2xlYXIgaW50ZXJydXB0IHN0YXR1cy4KKwlvdXRiKDB4ZmYsIGhvc3QtPnNjcl9h
ZGRyICsgTlZfSU5UX1NUQVRVUyk7CisKKwlpZiAoaW50cl9zdGF0dXMgJiBOVl9JTlRfU1RBVFVT
X0hPVFBMVUcpIHsKKwkJaWYgKGludHJfc3RhdHVzICYgTlZfSU5UX1NUQVRVU19QREVWX0FEREVE
KSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICJudl9zYXRhOiAiCisJCQkJIlByaW1hcnkgZGV2
aWNlIGFkZGVkXG4iKTsKKwkJfQorCisJCWlmIChpbnRyX3N0YXR1cyAmIE5WX0lOVF9TVEFUVVNf
UERFVl9SRU1PVkVEKSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICJudl9zYXRhOiAiCisJCQkJ
IlByaW1hcnkgZGV2aWNlIHJlbW92ZWRcbiIpOworCQl9CisKKwkJaWYgKGludHJfc3RhdHVzICYg
TlZfSU5UX1NUQVRVU19TREVWX0FEREVEKSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICJudl9z
YXRhOiAiCisJCQkJIlNlY29uZGFyeSBkZXZpY2UgYWRkZWRcbiIpOworCQl9CisKKwkJaWYgKGlu
dHJfc3RhdHVzICYgTlZfSU5UX1NUQVRVU19TREVWX1JFTU9WRUQpIHsKKwkJCXByaW50ayhLRVJO
X1dBUk5JTkcgIm52X3NhdGE6ICIKKwkJCQkiU2Vjb25kYXJ5IGRldmljZSByZW1vdmVkXG4iKTsK
KwkJfQorCX0KK30KKworc3RhdGljIHZvaWQgbnZfZW5hYmxlX2hvdHBsdWdfY2s4MDQoc3RydWN0
IGF0YV9wcm9iZV9lbnQgKnByb2JlX2VudCkKK3sKKwludl9ob3N0X3QgKmhvc3QgPSBwcm9iZV9l
bnQtPnByaXZhdGVfZGF0YTsKKwl1OCBpbnRyX21hc2s7CisJdTggcmVndmFsOworCisJcGNpX3Jl
YWRfY29uZmlnX2J5dGUocHJvYmVfZW50LT5wZGV2LCAweDUwLCAmcmVndmFsKTsKKwlyZWd2YWwg
fD0gMHgwNDsKKwlwY2lfd3JpdGVfY29uZmlnX2J5dGUocHJvYmVfZW50LT5wZGV2LCAweDUwLCBy
ZWd2YWwpOworCisJd3JpdGViKE5WX0lOVF9TVEFUVVNfSE9UUExVRywgaG9zdC0+c2NyX2FkZHIg
KyBOVl9JTlRfU1RBVFVTX0NLODA0KTsKKworCWludHJfbWFzayA9IHJlYWRiKGhvc3QtPnNjcl9h
ZGRyICsgTlZfSU5UX0VOQUJMRV9DSzgwNCk7CisJaW50cl9tYXNrIHw9IE5WX0lOVF9FTkFCTEVf
SE9UUExVRzsKKworCXdyaXRlYihpbnRyX21hc2ssIGhvc3QtPnNjcl9hZGRyICsgTlZfSU5UX0VO
QUJMRV9DSzgwNCk7Cit9CisKK3N0YXRpYyB2b2lkIG52X2Rpc2FibGVfaG90cGx1Z19jazgwNChz
dHJ1Y3QgYXRhX2hvc3Rfc2V0ICpob3N0X3NldCkKK3sKKwludl9ob3N0X3QgKmhvc3QgPSBob3N0
X3NldC0+cHJpdmF0ZV9kYXRhOworCXU4IGludHJfbWFzazsKKwl1OCByZWd2YWw7CisKKwlpbnRy
X21hc2sgPSByZWFkYihob3N0LT5zY3JfYWRkciArIE5WX0lOVF9FTkFCTEVfQ0s4MDQpOworCisJ
aW50cl9tYXNrICY9IH4oTlZfSU5UX0VOQUJMRV9IT1RQTFVHKTsKKworCXdyaXRlYihpbnRyX21h
c2ssIGhvc3QtPnNjcl9hZGRyICsgTlZfSU5UX0VOQUJMRV9DSzgwNCk7CisKKwlwY2lfcmVhZF9j
b25maWdfYnl0ZShob3N0X3NldC0+cGRldiwgMHg1MCwgJnJlZ3ZhbCk7CisJcmVndmFsICY9IH4w
eDA0OworCXBjaV93cml0ZV9jb25maWdfYnl0ZShob3N0X3NldC0+cGRldiwgMHg1MCwgcmVndmFs
KTsKK30KKworc3RhdGljIHZvaWQgbnZfY2hlY2tfaG90cGx1Z19jazgwNChzdHJ1Y3QgYXRhX2hv
c3Rfc2V0ICpob3N0X3NldCkKK3sKKwludl9ob3N0X3QgKmhvc3QgPSBob3N0X3NldC0+cHJpdmF0
ZV9kYXRhOworCXU4IGludHJfc3RhdHVzOworCisJaW50cl9zdGF0dXMgPSByZWFkYihob3N0LT5z
Y3JfYWRkciArIE5WX0lOVF9TVEFUVVNfQ0s4MDQpOworCisJLy8gQ2xlYXIgaW50ZXJydXB0IHN0
YXR1cy4KKwl3cml0ZWIoMHhmZiwgaG9zdC0+c2NyX2FkZHIgKyBOVl9JTlRfU1RBVFVTX0NLODA0
KTsKKworCWlmIChpbnRyX3N0YXR1cyAmIE5WX0lOVF9TVEFUVVNfSE9UUExVRykgeworCQlpZiAo
aW50cl9zdGF0dXMgJiBOVl9JTlRfU1RBVFVTX1BERVZfQURERUQpIHsKKwkJCXByaW50ayhLRVJO
X1dBUk5JTkcgIm52X3NhdGE6ICIKKwkJCQkiUHJpbWFyeSBkZXZpY2UgYWRkZWRcbiIpOworCQl9
CisKKwkJaWYgKGludHJfc3RhdHVzICYgTlZfSU5UX1NUQVRVU19QREVWX1JFTU9WRUQpIHsKKwkJ
CXByaW50ayhLRVJOX1dBUk5JTkcgIm52X3NhdGE6ICIKKwkJCQkiUHJpbWFyeSBkZXZpY2UgcmVt
b3ZlZFxuIik7CisJCX0KKworCQlpZiAoaW50cl9zdGF0dXMgJiBOVl9JTlRfU1RBVFVTX1NERVZf
QURERUQpIHsKKwkJCXByaW50ayhLRVJOX1dBUk5JTkcgIm52X3NhdGE6ICIKKwkJCQkiU2Vjb25k
YXJ5IGRldmljZSBhZGRlZFxuIik7CisJCX0KKworCQlpZiAoaW50cl9zdGF0dXMgJiBOVl9JTlRf
U1RBVFVTX1NERVZfUkVNT1ZFRCkgeworCQkJcHJpbnRrKEtFUk5fV0FSTklORyAibnZfc2F0YTog
IgorCQkJCSJTZWNvbmRhcnkgZGV2aWNlIHJlbW92ZWRcbiIpOworCQl9CisJfQorfQorCiBzdGF0
aWMgaW50IF9faW5pdCBudl9pbml0KHZvaWQpCiB7CiAJcmV0dXJuIHBjaV9tb2R1bGVfaW5pdCgm
bnZfcGNpX2RyaXZlcik7Cg==

------_=_NextPart_001_01C47034.2D4882BF--
