Return-Path: <linux-kernel-owner+willy=40w.ods.org-S261839AbVCGUYV@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S261839AbVCGUYV (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 7 Mar 2005 15:24:21 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S261837AbVCGUXd
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 7 Mar 2005 15:23:33 -0500
Received: from mail.autoweb.net ([198.172.237.26]:43793 "EHLO mail.autoweb.net")
	by vger.kernel.org with ESMTP id S261237AbVCGUDX (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Mon, 7 Mar 2005 15:03:23 -0500
Date: Mon, 7 Mar 2005 15:03:03 -0500
From: Ryan Anderson <ryan@michonline.com>
To: User Mode Linux Dev List 
	<user-mode-linux-devel@lists.sourceforge.net>,
       Jeff Dike <jdike@addtoit.com>, Andrew Morton <akpm@osdl.org>,
       Linux Kernel <linux-kernel@vger.kernel.org>
Subject: Re: [uml-devel] [PATCH] UML - Make deb-pkg build target build a Debian-style user-mode-linux package
Message-ID: <20050307200303.GT7828@mythryan2.michonline.com>
Mail-Followup-To: User Mode Linux Dev List <user-mode-linux-devel@lists.sourceforge.net>,
	Jeff Dike <jdike@addtoit.com>, Andrew Morton <akpm@osdl.org>,
	Linux Kernel <linux-kernel@vger.kernel.org>
References: <20050307182828.GS7828@mythryan2.michonline.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20050307182828.GS7828@mythryan2.michonline.com>
User-Agent: Mutt/1.5.6+20040907i
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Sorry, I forgot something important.

On Mon, Mar 07, 2005 at 01:28:28PM -0500, Ryan Anderson wrote:
> Make the deb-pkg build target understand the "um" arch and set up the
> package and directory structure to match a mainline-Debian style
> user-mode-linux package.
> 
> This is primarily so that it stops matching, exactly, the naming
> convention used by normal, non-UML kernels generated by this command.
> 
> Installing "linux-2.6.11" and "linux-2.6.11", where one is a UML kernel
> doesn't do the right thing.  This fixes that.

Signed-off-by: Ryan Anderson <ryan@michonline.com>

> 
> 
> diff -Nru a/scripts/package/builddeb b/scripts/package/builddeb
> --- a/scripts/package/builddeb	2005-03-07 13:21:16 -05:00
> +++ b/scripts/package/builddeb	2005-03-07 13:21:16 -05:00
> @@ -14,18 +14,38 @@
>  # Some variables and settings used throughout the script
>  version=$KERNELRELEASE
>  tmpdir="$objtree/debian/tmp"
> +packagename=linux-$version
> +
> +if [ "$ARCH" == "um" ] ; then
> +	packagename=user-mode-linux-$version
> +fi
>  
>  # Setup the directory structure
>  rm -rf "$tmpdir"
>  mkdir -p "$tmpdir/DEBIAN" "$tmpdir/lib" "$tmpdir/boot"
> +if [ "$ARCH" == "um" ] ; then
> +	mkdir -p "$tmpdir/usr/lib/uml/modules/$version" "$tmpdir/usr/share/doc/$packagename" "$tmpdir/usr/bin"
> +fi
>  
>  # Build and install the kernel
> -cp System.map "$tmpdir/boot/System.map-$version"
> -cp .config "$tmpdir/boot/config-$version"
> -cp $KBUILD_IMAGE "$tmpdir/boot/vmlinuz-$version"
> +if [ "$ARCH" == "um" ] ; then
> +	$MAKE linux
> +	cp System.map "$tmpdir/usr/lib/uml/modules/$version/System.map"
> +	cp .config "$tmpdir/usr/share/doc/$packagename/config"
> +	gzip "$tmpdir/usr/share/doc/$packagename/config"
> +	cp $KBUILD_IMAGE "$tmpdir/usr/bin/linux-$version"
> +else 
> +	cp System.map "$tmpdir/boot/System.map-$version"
> +	cp .config "$tmpdir/boot/config-$version"
> +	cp $KBUILD_IMAGE "$tmpdir/boot/vmlinuz-$version"
> +fi
>  
>  if grep -q '^CONFIG_MODULES=y' .config ; then
>  	INSTALL_MOD_PATH="$tmpdir" make modules_install
> +	if [ "$ARCH" == "um" ] ; then
> +		mv "$tmpdir/lib/modules/$version"/* "$tmpdir/usr/lib/uml/modules/$version/"
> +		rmdir "$tmpdir/lib/modules/$version"
> +	fi
>  fi
>  
>  # Install the maintainer scripts
> @@ -60,11 +80,11 @@
>  Maintainer: $name
>  Standards-Version: 3.6.1
>  
> -Package: linux-$version
> +Package: $packagename
>  Architecture: any
> -Description: Linux kernel, version $version
> +Description: Linux kernel, version $packagename
>   This package contains the Linux kernel, modules and corresponding other
> - files version $version.
> + files version $packagename
>  EOF
>  
>  # Fix some ownership and permissions
> 
> -- 
> 
> Ryan Anderson
>   sometimes Pug Majere
> 
> 
> -------------------------------------------------------
> SF email is sponsored by - The IT Product Guide
> Read honest & candid reviews on hundreds of IT Products from real users.
> Discover which products truly live up to the hype. Start reading now.
> http://ads.osdn.com/?ad_id=6595&alloc_id=14396&op=click
> _______________________________________________
> User-mode-linux-devel mailing list
> User-mode-linux-devel@lists.sourceforge.net
> https://lists.sourceforge.net/lists/listinfo/user-mode-linux-devel

-- 

Ryan Anderson
  sometimes Pug Majere
