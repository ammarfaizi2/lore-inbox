Return-Path: <linux-kernel-owner+willy=40w.ods.org-S268356AbUIWJw0@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S268356AbUIWJw0 (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 23 Sep 2004 05:52:26 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S268357AbUIWJw0
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 23 Sep 2004 05:52:26 -0400
Received: from mx1.redhat.com ([66.187.233.31]:15595 "EHLO mx1.redhat.com")
	by vger.kernel.org with ESMTP id S268356AbUIWJwY (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Thu, 23 Sep 2004 05:52:24 -0400
From: David Howells <dhowells@redhat.com>
To: akpm@osdl.org
cc: linux-kernel@vger.kernel.org
Subject: [PATCH] Return a different error if unavailable keytype is used
User-Agent: EMH/1.14.1 SEMI/1.14.5 (Awara-Onsen) FLIM/1.14.5 (Demachiyanagi) APEL/10.6 Emacs/21.3 (i386-redhat-linux-gnu) MULE/5.0 (SAKAKI)
MIME-Version: 1.0 (generated by SEMI 1.14.5 - "Awara-Onsen")
Content-Type: text/plain; charset=US-ASCII
Date: Thu, 23 Sep 2004 10:52:21 +0100
Message-ID: <26085.1095933141@redhat.com>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


The attached patch causes the add_key() syscall to return a different error if
the key type is unavailable to distinguish between that and an error
indicating the keyring to add to is unavailable.

Signed-Off-By: David Howells <dhowells@redhat.com>
---

 key.c |    2 +-
 1 files changed, 1 insertion(+), 1 deletion(-)

diff -uNrp linux-2.6.9-rc2-mm1/security/keys/key.c linux-2.6.9-rc2-mm1-afskey/security/keys/key.c
--- linux-2.6.9-rc2-mm1/security/keys/key.c	2004-09-16 12:09:57.000000000 +0100
+++ linux-2.6.9-rc2-mm1-afskey/security/keys/key.c	2004-09-22 16:14:03.000000000 +0100
@@ -744,7 +744,7 @@ struct key *key_create_or_update(struct 
 	 * types */
 	ktype = key_type_lookup(type);
 	if (IS_ERR(ktype)) {
-		key = ERR_PTR(PTR_ERR(ktype));
+		key = ERR_PTR(-ENODEV);
 		goto error;
 	}
 
