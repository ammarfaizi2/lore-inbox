Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S271718AbTHDMss (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 4 Aug 2003 08:48:48 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S271719AbTHDMss
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 4 Aug 2003 08:48:48 -0400
Received: from mail.gmx.de ([213.165.64.20]:48316 "HELO mail.gmx.net")
	by vger.kernel.org with SMTP id S271718AbTHDMsY (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Mon, 4 Aug 2003 08:48:24 -0400
Message-Id: <5.2.1.1.2.20030804142302.01975a80@wen-online.de>
X-Mailer: QUALCOMM Windows Eudora Version 5.2.1
Date: Mon, 04 Aug 2003 14:52:19 +0200
To: linux kernel mailing list <linux-kernel@vger.kernel.org>
From: Mike Galbraith <efault@gmx.de>
Subject: sound update causes artsd to fail/abort initialization
Cc: perex@suse.cz, alsa-devel@alsa-project.org
Mime-Version: 1.0
Content-Type: multipart/mixed;
	boundary="=====================_30985828==_"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

--=====================_30985828==_
Content-Type: text/plain; charset="us-ascii"; format=flowed

Greetings,

While testing 2.6.0-test2-mm3-1, I ran into a problem with artsd failing 
during X/KDE startup, leaving an error message "cpu overload, 
aborting".  It takes about 20 seconds to fail, and after X finally does 
come up, all seems well with the exception of artsd being AWOL.  (I don't 
know what artsd has to do with sound, but whatever it is, it doesn't seem 
to be terribly important, because xmms seems to work fine without 
it)  After the initial failure, dropping back to the shell and restarting 
X/KDE _usually_ results in artsd starting just fine, though once in a while 
I'll get the same hang and failure that I always get the first time around.

Using the "brute-ignorance" method (pick something at random, patch -R it), 
I narrowed it down a little.  Exactly what I reverted is attached for 
reference.  Box is a piii/500 with an onboard ymf-740c, and I'm using oss 
emulation.

	-Mike
--=====================_30985828==_
Content-Type: application/octet-stream; name="xx.diff";
 x-mac-type="42494E41"; x-mac-creator="5843454C"
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="xx.diff"

ZGlmZiAtTnJ1IGEvaW5jbHVkZS9zb3VuZC9wY21fb3NzLmggYi9pbmNsdWRlL3NvdW5kL3BjbV9v
c3MuaAotLS0gYS9pbmNsdWRlL3NvdW5kL3BjbV9vc3MuaAlTYXQgQXVnICAyIDEyOjE2OjM0IDIw
MDMKKysrIGIvaW5jbHVkZS9zb3VuZC9wY21fb3NzLmgJU2F0IEF1ZyAgMiAxMjoxNjozNCAyMDAz
CkBAIC0zMCw3ICszMCw5IEBACiAJdW5zaWduZWQgaW50IGRpc2FibGU6MSwKIAkJICAgICBkaXJl
Y3Q6MSwKIAkJICAgICBibG9jazoxLAotCQkgICAgIG5vbmJsb2NrOjE7CisJCSAgICAgbm9uYmxv
Y2s6MSwKKwkJICAgICB3aG9sZWZyYWc6MSwKKwkJICAgICBub3NpbGVuY2U6MTsKIAl1bnNpZ25l
ZCBpbnQgcGVyaW9kczsKIAl1bnNpZ25lZCBpbnQgcGVyaW9kX3NpemU7CiAJc25kX3BjbV9vc3Nf
c2V0dXBfdCAqbmV4dDsKZGlmZiAtTnJ1IGEvc291bmQvY29yZS9vc3MvcGNtX29zcy5jIGIvc291
bmQvY29yZS9vc3MvcGNtX29zcy5jCi0tLSBhL3NvdW5kL2NvcmUvb3NzL3BjbV9vc3MuYwlTYXQg
QXVnICAyIDEyOjE2OjM1IDIwMDMKKysrIGIvc291bmQvY29yZS9vc3MvcGNtX29zcy5jCVNhdCBB
dWcgIDIgMTI6MTY6MzUgMjAwMwpAQCAtMjIsNiArMjIsOSBAQAogI2lmIDAKICNkZWZpbmUgUExV
R0lOX0RFQlVHCiAjZW5kaWYKKyNpZiAwCisjZGVmaW5lIE9TU19ERUJVRworI2VuZGlmCiAKICNp
bmNsdWRlIDxzb3VuZC9kcml2ZXIuaD4KICNpbmNsdWRlIDxsaW51eC92ZXJzaW9uLmg+CkBAIC00
NDIsNyArNDQ1LDcgQEAKIAl9IGVsc2UgewogCQlzd19wYXJhbXMtPnN0YXJ0X3RocmVzaG9sZCA9
IHJ1bnRpbWUtPmJvdW5kYXJ5OwogCX0KLQlpZiAoYXRvbWljX3JlYWQoJnJ1bnRpbWUtPm1tYXBf
Y291bnQpKQorCWlmIChhdG9taWNfcmVhZCgmcnVudGltZS0+bW1hcF9jb3VudCkgfHwgc3Vic3Ry
ZWFtLT5zdHJlYW0gPT0gU05EUlZfUENNX1NUUkVBTV9DQVBUVVJFKQogCQlzd19wYXJhbXMtPnN0
b3BfdGhyZXNob2xkID0gcnVudGltZS0+Ym91bmRhcnk7CiAJZWxzZQogCQlzd19wYXJhbXMtPnN0
b3BfdGhyZXNob2xkID0gcnVudGltZS0+YnVmZmVyX3NpemU7CkBAIC00NTEsOCArNDU0LDE4IEBA
CiAJc3dfcGFyYW1zLT5zbGVlcF9taW4gPSAwOwogCXN3X3BhcmFtcy0+YXZhaWxfbWluID0gcnVu
dGltZS0+cGVyaW9kX3NpemU7CiAJc3dfcGFyYW1zLT54ZmVyX2FsaWduID0gMTsKLQlzd19wYXJh
bXMtPnNpbGVuY2VfdGhyZXNob2xkID0gMDsKLQlzd19wYXJhbXMtPnNpbGVuY2Vfc2l6ZSA9IDA7
CisJaWYgKGF0b21pY19yZWFkKCZydW50aW1lLT5tbWFwX2NvdW50KSB8fAorCSAgICAoc3Vic3Ry
ZWFtLT5vc3Muc2V0dXAgJiYgc3Vic3RyZWFtLT5vc3Muc2V0dXAtPm5vc2lsZW5jZSkpIHsKKwkJ
c3dfcGFyYW1zLT5zaWxlbmNlX3RocmVzaG9sZCA9IDA7CisJCXN3X3BhcmFtcy0+c2lsZW5jZV9z
aXplID0gMDsKKwl9IGVsc2UgeworCQlzbmRfcGNtX3VmcmFtZXNfdCBmcmFtZXM7CisJCWZyYW1l
cyA9IHJ1bnRpbWUtPnBlcmlvZF9zaXplICsgMTY7CisJCWlmIChmcmFtZXMgPiBydW50aW1lLT5i
dWZmZXJfc2l6ZSkKKwkJCWZyYW1lcyA9IHJ1bnRpbWUtPmJ1ZmZlcl9zaXplOworCQlzd19wYXJh
bXMtPnNpbGVuY2VfdGhyZXNob2xkID0gZnJhbWVzOworCQlzd19wYXJhbXMtPnNpbGVuY2Vfc2l6
ZSA9IGZyYW1lczsKKwl9CiAKIAlpZiAoKGVyciA9IHNuZF9wY21fa2VybmVsX2lvY3RsKHN1YnN0
cmVhbSwgU05EUlZfUENNX0lPQ1RMX1NXX1BBUkFNUywgc3dfcGFyYW1zKSkgPCAwKSB7CiAJCXNu
ZF9wcmludGQoIlNXX1BBUkFNUyBmYWlsZWQ6ICVpXG4iLCBlcnIpOwpAQCAtNTY3LDYgKzU4MCwz
MSBAQAogCXJldHVybiAwOwogfQogCitzdGF0aWMgaW50IHNuZF9wY21fb3NzX2NhcHR1cmVfcG9z
aXRpb25fZml4dXAoc25kX3BjbV9zdWJzdHJlYW1fdCAqc3Vic3RyZWFtLCBzbmRfcGNtX3NmcmFt
ZXNfdCAqZGVsYXkpCit7CisJc25kX3BjbV9ydW50aW1lX3QgKnJ1bnRpbWU7CisJc25kX3BjbV91
ZnJhbWVzX3QgZnJhbWVzOworCWludCBlcnIgPSAwOworCisJd2hpbGUgKDEpIHsKKwkJZXJyID0g
c25kX3BjbV9rZXJuZWxfaW9jdGwoc3Vic3RyZWFtLCBTTkRSVl9QQ01fSU9DVExfREVMQVksIGRl
bGF5KTsKKwkJaWYgKGVyciA8IDApCisJCQlicmVhazsKKwkJcnVudGltZSA9IHN1YnN0cmVhbS0+
cnVudGltZTsKKwkJaWYgKCpkZWxheSA8PSAoc25kX3BjbV9zZnJhbWVzX3QpcnVudGltZS0+YnVm
ZmVyX3NpemUpCisJCQlicmVhazsKKwkJLyogaW4gY2FzZSBvZiBvdmVycnVuLCBza2lwIHdob2xl
IHBlcmlvZHMgbGlrZSBPU1MvTGludXggZHJpdmVyIGRvZXMgKi8KKwkJLyogdW50aWwgYXZhaWwo
ZGVsYXkpIDw9IGJ1ZmZlcl9zaXplICovCisJCWZyYW1lcyA9ICgqZGVsYXkgLSBydW50aW1lLT5i
dWZmZXJfc2l6ZSkgKyBydW50aW1lLT5wZXJpb2Rfc2l6ZSAtIDE7CisJCWZyYW1lcyAvPSBydW50
aW1lLT5wZXJpb2Rfc2l6ZTsKKwkJZnJhbWVzICo9IHJ1bnRpbWUtPnBlcmlvZF9zaXplOworCQll
cnIgPSBzbmRfcGNtX2tlcm5lbF9pb2N0bChzdWJzdHJlYW0sIFNORFJWX1BDTV9JT0NUTF9GT1JX
QVJELCAmZnJhbWVzKTsKKwkJaWYgKGVyciA8IDApCisJCQlicmVhazsKKwl9CisJcmV0dXJuIGVy
cjsKK30KKwogc25kX3BjbV9zZnJhbWVzX3Qgc25kX3BjbV9vc3Nfd3JpdGUzKHNuZF9wY21fc3Vi
c3RyZWFtX3QgKnN1YnN0cmVhbSwgY29uc3QgY2hhciAqcHRyLCBzbmRfcGNtX3VmcmFtZXNfdCBm
cmFtZXMsIGludCBpbl9rZXJuZWwpCiB7CiAJc25kX3BjbV9ydW50aW1lX3QgKnJ1bnRpbWUgPSBz
dWJzdHJlYW0tPnJ1bnRpbWU7CkBAIC01NzQsNiArNjEyLDEyIEBACiAJd2hpbGUgKDEpIHsKIAkJ
aWYgKHJ1bnRpbWUtPnN0YXR1cy0+c3RhdGUgPT0gU05EUlZfUENNX1NUQVRFX1hSVU4gfHwKIAkJ
ICAgIHJ1bnRpbWUtPnN0YXR1cy0+c3RhdGUgPT0gU05EUlZfUENNX1NUQVRFX1NVU1BFTkRFRCkg
eworI2lmZGVmIE9TU19ERUJVRworCQkJaWYgKHJ1bnRpbWUtPnN0YXR1cy0+c3RhdGUgPT0gU05E
UlZfUENNX1NUQVRFX1hSVU4pCisJCQkJcHJpbnRrKCJwY21fb3NzOiB3cml0ZTogcmVjb3Zlcmlu
ZyBmcm9tIFhSVU5cbiIpOworCQkJZWxzZQorCQkJCXByaW50aygicGNtX29zczogd3JpdGU6IHJl
Y292ZXJpbmcgZnJvbSBTVVNQRU5EXG4iKTsKKyNlbmRpZgogCQkJcmV0ID0gc25kX3BjbV9vc3Nf
cHJlcGFyZShzdWJzdHJlYW0pOwogCQkJaWYgKHJldCA8IDApCiAJCQkJYnJlYWs7CkBAIC01OTks
MTAgKzY0MywxNyBAQAogc25kX3BjbV9zZnJhbWVzX3Qgc25kX3BjbV9vc3NfcmVhZDMoc25kX3Bj
bV9zdWJzdHJlYW1fdCAqc3Vic3RyZWFtLCBjaGFyICpwdHIsIHNuZF9wY21fdWZyYW1lc190IGZy
YW1lcywgaW50IGluX2tlcm5lbCkKIHsKIAlzbmRfcGNtX3J1bnRpbWVfdCAqcnVudGltZSA9IHN1
YnN0cmVhbS0+cnVudGltZTsKKwlzbmRfcGNtX3NmcmFtZXNfdCBkZWxheTsKIAlpbnQgcmV0Owog
CXdoaWxlICgxKSB7CiAJCWlmIChydW50aW1lLT5zdGF0dXMtPnN0YXRlID09IFNORFJWX1BDTV9T
VEFURV9YUlVOIHx8CiAJCSAgICBydW50aW1lLT5zdGF0dXMtPnN0YXRlID09IFNORFJWX1BDTV9T
VEFURV9TVVNQRU5ERUQpIHsKKyNpZmRlZiBPU1NfREVCVUcKKwkJCWlmIChydW50aW1lLT5zdGF0
dXMtPnN0YXRlID09IFNORFJWX1BDTV9TVEFURV9YUlVOKQorCQkJCXByaW50aygicGNtX29zczog
cmVhZDogcmVjb3ZlcmluZyBmcm9tIFhSVU5cbiIpOworCQkJZWxzZQorCQkJCXByaW50aygicGNt
X29zczogcmVhZDogcmVjb3ZlcmluZyBmcm9tIFNVU1BFTkRcbiIpOworI2VuZGlmCiAJCQlyZXQg
PSBzbmRfcGNtX2tlcm5lbF9pb2N0bChzdWJzdHJlYW0sIFNORFJWX1BDTV9JT0NUTF9EUkFJTiwg
MCk7CiAJCQlpZiAocmV0IDwgMCkKIAkJCQlicmVhazsKQEAgLTYxMSw2ICs2NjIsOSBAQAogCQkJ
aWYgKHJldCA8IDApCiAJCQkJYnJlYWs7CiAJCX0KKwkJcmV0ID0gc25kX3BjbV9vc3NfY2FwdHVy
ZV9wb3NpdGlvbl9maXh1cChzdWJzdHJlYW0sICZkZWxheSk7CisJCWlmIChyZXQgPCAwKQorCQkJ
YnJlYWs7CiAJCWlmIChpbl9rZXJuZWwpIHsKIAkJCW1tX3NlZ21lbnRfdCBmczsKIAkJCWZzID0g
c25kX2VudGVyX3VzZXIoKTsKQEAgLTY0MCw2ICs2OTQsMTIgQEAKIAl3aGlsZSAoMSkgewogCQlp
ZiAocnVudGltZS0+c3RhdHVzLT5zdGF0ZSA9PSBTTkRSVl9QQ01fU1RBVEVfWFJVTiB8fAogCQkg
ICAgcnVudGltZS0+c3RhdHVzLT5zdGF0ZSA9PSBTTkRSVl9QQ01fU1RBVEVfU1VTUEVOREVEKSB7
CisjaWZkZWYgT1NTX0RFQlVHCisJCQlpZiAocnVudGltZS0+c3RhdHVzLT5zdGF0ZSA9PSBTTkRS
Vl9QQ01fU1RBVEVfWFJVTikKKwkJCQlwcmludGsoInBjbV9vc3M6IHdyaXRldjogcmVjb3Zlcmlu
ZyBmcm9tIFhSVU5cbiIpOworCQkJZWxzZQorCQkJCXByaW50aygicGNtX29zczogd3JpdGV2OiBy
ZWNvdmVyaW5nIGZyb20gU1VTUEVORFxuIik7CisjZW5kaWYKIAkJCXJldCA9IHNuZF9wY21fb3Nz
X3ByZXBhcmUoc3Vic3RyZWFtKTsKIAkJCWlmIChyZXQgPCAwKQogCQkJCWJyZWFrOwpAQCAtNjcw
LDYgKzczMCwxMiBAQAogCXdoaWxlICgxKSB7CiAJCWlmIChydW50aW1lLT5zdGF0dXMtPnN0YXRl
ID09IFNORFJWX1BDTV9TVEFURV9YUlVOIHx8CiAJCSAgICBydW50aW1lLT5zdGF0dXMtPnN0YXRl
ID09IFNORFJWX1BDTV9TVEFURV9TVVNQRU5ERUQpIHsKKyNpZmRlZiBPU1NfREVCVUcKKwkJCWlm
IChydW50aW1lLT5zdGF0dXMtPnN0YXRlID09IFNORFJWX1BDTV9TVEFURV9YUlVOKQorCQkJCXBy
aW50aygicGNtX29zczogcmVhZHY6IHJlY292ZXJpbmcgZnJvbSBYUlVOXG4iKTsKKwkJCWVsc2UK
KwkJCQlwcmludGsoInBjbV9vc3M6IHJlYWR2OiByZWNvdmVyaW5nIGZyb20gU1VTUEVORFxuIik7
CisjZW5kaWYKIAkJCXJldCA9IHNuZF9wY21fa2VybmVsX2lvY3RsKHN1YnN0cmVhbSwgU05EUlZf
UENNX0lPQ1RMX0RSQUlOLCAwKTsKIAkJCWlmIChyZXQgPCAwKQogCQkJCWJyZWFrOwpAQCAtNzQ2
LDggKzgxMiw5IEBACiAJCQlidWYgKz0gdG1wOwogCQkJYnl0ZXMgLT0gdG1wOwogCQkJeGZlciAr
PSB0bXA7Ci0JCQlpZiAocnVudGltZS0+b3NzLmJ1ZmZlcl91c2VkID09IHJ1bnRpbWUtPm9zcy5w
ZXJpb2RfYnl0ZXMpIHsKLQkJCQl0bXAgPSBzbmRfcGNtX29zc193cml0ZTIoc3Vic3RyZWFtLCBy
dW50aW1lLT5vc3MuYnVmZmVyLCBydW50aW1lLT5vc3MucGVyaW9kX2J5dGVzLCAxKTsKKwkJCWlm
IChzdWJzdHJlYW0tPm9zcy5zZXR1cCA9PSBOVUxMIHx8ICFzdWJzdHJlYW0tPm9zcy5zZXR1cC0+
d2hvbGVmcmFnIHx8CisJCQkgICAgcnVudGltZS0+b3NzLmJ1ZmZlcl91c2VkID09IHJ1bnRpbWUt
Pm9zcy5wZXJpb2RfYnl0ZXMpIHsKKwkJCQl0bXAgPSBzbmRfcGNtX29zc193cml0ZTIoc3Vic3Ry
ZWFtLCBydW50aW1lLT5vc3MuYnVmZmVyLCBydW50aW1lLT5vc3MuYnVmZmVyX3VzZWQsIDEpOwog
CQkJCWlmICh0bXAgPD0gMCkKIAkJCQkJcmV0dXJuIHhmZXIgPiAwID8gKHNuZF9wY21fc2ZyYW1l
c190KXhmZXIgOiB0bXA7CiAJCQkJcnVudGltZS0+b3NzLmJ5dGVzICs9IHRtcDsKQEAgLTg1NSw2
ICs5MjIsMjIgQEAKIAlyZXR1cm4gMDsKIH0KIAorc3RhdGljIGludCBzbmRfcGNtX29zc19wb3N0
KHNuZF9wY21fb3NzX2ZpbGVfdCAqcGNtX29zc19maWxlKQoreworCXNuZF9wY21fc3Vic3RyZWFt
X3QgKnN1YnN0cmVhbTsKKwlpbnQgZXJyOworCisJc3Vic3RyZWFtID0gcGNtX29zc19maWxlLT5z
dHJlYW1zW1NORFJWX1BDTV9TVFJFQU1fUExBWUJBQ0tdOworCWlmIChzdWJzdHJlYW0gIT0gTlVM
TCkgeworCQlpZiAoKGVyciA9IHNuZF9wY21fb3NzX21ha2VfcmVhZHkoc3Vic3RyZWFtKSkgPCAw
KQorCQkJcmV0dXJuIGVycjsKKwkJc25kX3BjbV9rZXJuZWxfcGxheWJhY2tfaW9jdGwoc3Vic3Ry
ZWFtLCBTTkRSVl9QQ01fSU9DVExfU1RBUlQsIDApOworCX0KKwkvKiBub3RlOiBhbGwgZXJyb3Jz
IGZyb20gdGhlIHN0YXJ0IGFjdGlvbiBhcmUgaWdub3JlZCAqLworCS8qIE9TUyBhcHBzIGRvIG5v
dCBrbm93LCBob3cgdG8gaGFuZGxlIHRoZW0gKi8KKwlyZXR1cm4gMDsKK30KKwogc3RhdGljIGlu
dCBzbmRfcGNtX29zc19zeW5jKHNuZF9wY21fb3NzX2ZpbGVfdCAqcGNtX29zc19maWxlKQogewog
CWludCBlcnIgPSAwOwpAQCAtMTE4OCw2ICsxMjcxLDEwIEBACiAJc25kX3BjbV9ydW50aW1lX3Qg
KnJ1bnRpbWU7CiAJc25kX3BjbV9zdWJzdHJlYW1fdCAqcHN1YnN0cmVhbSA9IE5VTEwsICpjc3Vi
c3RyZWFtID0gTlVMTDsKIAlpbnQgZXJyLCBjbWQ7CisKKyNpZmRlZiBPU1NfREVCVUcKKwlwcmlu
dGsoInBjbV9vc3M6IHRyaWdnZXIgPSAweCV4XG4iLCB0cmlnZ2VyKTsKKyNlbmRpZgogCQogCXBz
dWJzdHJlYW0gPSBwY21fb3NzX2ZpbGUtPnN0cmVhbXNbU05EUlZfUENNX1NUUkVBTV9QTEFZQkFD
S107CiAJY3N1YnN0cmVhbSA9IHBjbV9vc3NfZmlsZS0+c3RyZWFtc1tTTkRSVl9QQ01fU1RSRUFN
X0NBUFRVUkVdOwpAQCAtMTI4OCw3ICsxMzc1LDcgQEAKIHsJCiAJc25kX3BjbV9zdWJzdHJlYW1f
dCAqc3Vic3RyZWFtOwogCXNuZF9wY21fcnVudGltZV90ICpydW50aW1lOwotCXNuZF9wY21fc3Rh
dHVzX3Qgc3RhdHVzOworCXNuZF9wY21fc2ZyYW1lc190IGRlbGF5OwogCXN0cnVjdCBjb3VudF9p
bmZvIGluZm87CiAJaW50IGVycjsKIApAQCAtMTMwNiwxNCArMTM5MywxNyBAQAogCQkJcmV0dXJu
IC1FRkFVTFQ7CiAJCXJldHVybiAwOwogCX0KLQltZW1zZXQoJnN0YXR1cywgMCwgc2l6ZW9mKHN0
YXR1cykpOwotCWVyciA9IHNuZF9wY21fa2VybmVsX2lvY3RsKHN1YnN0cmVhbSwgU05EUlZfUENN
X0lPQ1RMX1NUQVRVUywgJnN0YXR1cyk7CisJaWYgKHN0cmVhbSA9PSBTTkRSVl9QQ01fU1RSRUFN
X1BMQVlCQUNLKSB7CisJCWVyciA9IHNuZF9wY21fa2VybmVsX2lvY3RsKHN1YnN0cmVhbSwgU05E
UlZfUENNX0lPQ1RMX0RFTEFZLCAmZGVsYXkpOworCX0gZWxzZSB7CisJCWVyciA9IHNuZF9wY21f
b3NzX2NhcHR1cmVfcG9zaXRpb25fZml4dXAoc3Vic3RyZWFtLCAmZGVsYXkpOworCX0KIAlpZiAo
ZXJyIDwgMCkKIAkJcmV0dXJuIGVycjsKIAlpZiAoc3RyZWFtID09IFNORFJWX1BDTV9TVFJFQU1f
UExBWUJBQ0spIHsKLQkJaW5mby5ieXRlcyA9IHJ1bnRpbWUtPm9zcy5ieXRlcyAtIHNuZF9wY21f
b3NzX2J5dGVzKHN1YnN0cmVhbSwgcnVudGltZS0+YnVmZmVyX3NpemUgLSBzdGF0dXMuYXZhaWwp
OworCQlpbmZvLmJ5dGVzID0gcnVudGltZS0+b3NzLmJ5dGVzIC0gc25kX3BjbV9vc3NfYnl0ZXMo
c3Vic3RyZWFtLCBkZWxheSk7CiAJfSBlbHNlIHsKLQkJaW5mby5ieXRlcyA9IHJ1bnRpbWUtPm9z
cy5ieXRlcyArIHNuZF9wY21fb3NzX2J5dGVzKHN1YnN0cmVhbSwgc3RhdHVzLmF2YWlsKTsKKwkJ
aW5mby5ieXRlcyA9IHJ1bnRpbWUtPm9zcy5ieXRlcyArIHNuZF9wY21fb3NzX2J5dGVzKHN1YnN0
cmVhbSwgZGVsYXkpOwogCX0KIAlpbmZvLnB0ciA9IHNuZF9wY21fb3NzX2J5dGVzKHN1YnN0cmVh
bSwgcnVudGltZS0+c3RhdHVzLT5od19wdHIgJSBydW50aW1lLT5idWZmZXJfc2l6ZSk7CiAJaWYg
KGF0b21pY19yZWFkKCZydW50aW1lLT5tbWFwX2NvdW50KSkgewpAQCAtMTMyNiwxMCArMTQxNiw3
IEBACiAJCWlmIChzdWJzdHJlYW0tPnN0cmVhbSA9PSBTTkRSVl9QQ01fU1RSRUFNX1BMQVlCQUNL
KQogCQkJc25kX3BjbV9vc3Nfc2ltdWxhdGVfZmlsbChzdWJzdHJlYW0pOwogCX0gZWxzZSB7Ci0J
CWlmIChzdHJlYW0gPT0gU05EUlZfUENNX1NUUkVBTV9QTEFZQkFDSykKLQkJCWluZm8uYmxvY2tz
ID0gKHJ1bnRpbWUtPmJ1ZmZlcl9zaXplIC0gc3RhdHVzLmF2YWlsKSAvIHJ1bnRpbWUtPnBlcmlv
ZF9zaXplOwotCQllbHNlCi0JCQlpbmZvLmJsb2NrcyA9IHN0YXR1cy5hdmFpbCAvIHJ1bnRpbWUt
PnBlcmlvZF9zaXplOworCQlpbmZvLmJsb2NrcyA9IGRlbGF5IC8gcnVudGltZS0+cGVyaW9kX3Np
emU7CiAJfQogCWlmIChjb3B5X3RvX3VzZXIoX2luZm8sICZpbmZvLCBzaXplb2YoaW5mbykpKQog
CQlyZXR1cm4gLUVGQVVMVDsKQEAgLTEzNDAsNyArMTQyNyw3IEBACiB7CiAJc25kX3BjbV9zdWJz
dHJlYW1fdCAqc3Vic3RyZWFtOwogCXNuZF9wY21fcnVudGltZV90ICpydW50aW1lOwotCXNuZF9w
Y21fc3RhdHVzX3Qgc3RhdHVzOworCXNuZF9wY21fc2ZyYW1lc190IGF2YWlsOwogCXN0cnVjdCBh
dWRpb19idWZfaW5mbyBpbmZvOwogCWludCBlcnI7CiAKQEAgLTEzNTcsNyArMTQ0NCw2IEBACiAK
IAlpbmZvLmZyYWdzaXplID0gcnVudGltZS0+b3NzLnBlcmlvZF9ieXRlczsKIAlpbmZvLmZyYWdz
dG90YWwgPSBydW50aW1lLT5wZXJpb2RzOwotCW1lbXNldCgmc3RhdHVzLCAwLCBzaXplb2Yoc3Rh
dHVzKSk7CiAJaWYgKHJ1bnRpbWUtPm9zcy5wcmVwYXJlKSB7CiAJCWlmIChzdHJlYW0gPT0gU05E
UlZfUENNX1NUUkVBTV9QTEFZQkFDSykgewogCQkJaW5mby5ieXRlcyA9IHJ1bnRpbWUtPm9zcy5w
ZXJpb2RfYnl0ZXMgKiBydW50aW1lLT5wZXJpb2RzOwpAQCAtMTM2NywyMSArMTQ1MywyMSBAQAog
CQkJaW5mby5mcmFnbWVudHMgPSAwOwogCQl9CiAJfSBlbHNlIHsKLQkJZXJyID0gc25kX3BjbV9r
ZXJuZWxfaW9jdGwoc3Vic3RyZWFtLCBTTkRSVl9QQ01fSU9DVExfU1RBVFVTLCAmc3RhdHVzKTsK
KwkJaWYgKHN0cmVhbSA9PSBTTkRSVl9QQ01fU1RSRUFNX1BMQVlCQUNLKSB7CisJCQllcnIgPSBz
bmRfcGNtX2tlcm5lbF9pb2N0bChzdWJzdHJlYW0sIFNORFJWX1BDTV9JT0NUTF9ERUxBWSwgJmF2
YWlsKTsKKwkJCWF2YWlsID0gcnVudGltZS0+YnVmZmVyX3NpemUgLSBhdmFpbDsKKwkJfSBlbHNl
IHsKKwkJCWVyciA9IHNuZF9wY21fb3NzX2NhcHR1cmVfcG9zaXRpb25fZml4dXAoc3Vic3RyZWFt
LCAmYXZhaWwpOworCQl9CiAJCWlmIChlcnIgPCAwKQogCQkJcmV0dXJuIGVycjsKLQkJaW5mby5i
eXRlcyA9IHNuZF9wY21fb3NzX2J5dGVzKHN1YnN0cmVhbSwgc3RhdHVzLmF2YWlsKTsKLQkJaW5m
by5mcmFnbWVudHMgPSBzdGF0dXMuYXZhaWwgLyBydW50aW1lLT5wZXJpb2Rfc2l6ZTsKKwkJaW5m
by5ieXRlcyA9IHNuZF9wY21fb3NzX2J5dGVzKHN1YnN0cmVhbSwgYXZhaWwpOworCQlpbmZvLmZy
YWdtZW50cyA9IGF2YWlsIC8gcnVudGltZS0+cGVyaW9kX3NpemU7CiAJfQogCi0jaWYgMAotCS8q
IHZlcnkgZXhwZXJpbWVudGFsIHN0dWZmIHRvIGdldCBRdWFrZTIgd29ya2luZyAqLwotCXJ1bnRp
bWUtPm9zcy5wZXJpb2QgPSAoaW5mby5wZXJpb2RzIC0gMSkgPDwgMTY7Ci0JZm9yICh0bXAgPSBp
bmZvLmZyYWdzaXplOyB0bXAgPiAxOyB0bXAgPj49IDEpCi0JCXJ1bnRpbWUtPm9zcy5wZXJpb2Qr
KzsKLQlydW50aW1lLT5vc3Muc3ViZGl2aXNpb24gPSAxOwkvKiBkaXNhYmxlIFNVQkRJVklERSAq
LworI2lmZGVmIE9TU19ERUJVRworCXByaW50aygicGNtX29zczogc3BhY2U6IGJ5dGVzID0gJWks
IGZyYWdtZW50cyA9ICVpLCBmcmFnc3RvdGFsID0gJWksIGZyYWdzaXplID0gJWlcbiIsIGluZm8u
Ynl0ZXMsIGluZm8uZnJhZ21lbnRzLCBpbmZvLmZyYWdzdG90YWwsIGluZm8uZnJhZ3NpemUpOwog
I2VuZGlmCi0JLy8gcHJpbnRrKCJzcGFjZTogYnl0ZXMgPSAlaSwgcGVyaW9kcyA9ICVpLCBmcmFn
c3RvdGFsID0gJWksIGZyYWdzaXplID0gJWlcbiIsIGluZm8uYnl0ZXMsIGluZm8ucGVyaW9kcywg
aW5mby5mcmFnc3RvdGFsLCBpbmZvLmZyYWdzaXplKTsKIAlpZiAoY29weV90b191c2VyKF9pbmZv
LCAmaW5mbywgc2l6ZW9mKGluZm8pKSkKIAkJcmV0dXJuIC1FRkFVTFQ7CiAJcmV0dXJuIDA7CkBA
IC0xNzI3LDYgKzE4MTMsOSBAQAogI2VuZGlmCiAJaWYgKCgoY21kID4+IDgpICYgMHhmZikgIT0g
J1AnKQogCQlyZXR1cm4gLUVJTlZBTDsKKyNpZmRlZiBPU1NfREVCVUcKKwlwcmludGsoInBjbV9v
c3M6IGlvY3RsID0gMHgleFxuIiwgY21kKTsKKyNlbmRpZgogCXN3aXRjaCAoY21kKSB7CiAJY2Fz
ZSBTTkRDVExfRFNQX1JFU0VUOgogCQlyZXR1cm4gc25kX3BjbV9vc3NfcmVzZXQocGNtX29zc19m
aWxlKTsKQEAgLTE3ODIsOCArMTg3MSw4IEBACiAJY2FzZSBTT1VORF9QQ01fV1JJVEVfRklMVEVS
OgogCWNhc2UgU09VTkRfUENNX1JFQURfRklMVEVSOgogCQlyZXR1cm4gLUVJTzsKLQljYXNlIFNO
RENUTF9EU1BfUE9TVDoJLyogdG8gZG8gKi8KLQkJcmV0dXJuIDA7CisJY2FzZSBTTkRDVExfRFNQ
X1BPU1Q6CisJCXJldHVybiBzbmRfcGNtX29zc19wb3N0KHBjbV9vc3NfZmlsZSk7CiAJY2FzZSBT
TkRDVExfRFNQX1NVQkRJVklERToKIAkJaWYgKGdldF91c2VyKHJlcywgKGludCAqKWFyZykpCiAJ
CQlyZXR1cm4gLUVGQVVMVDsKQEAgLTE4NjYsNyArMTk1NSwxNSBAQAogCXN1YnN0cmVhbSA9IHBj
bV9vc3NfZmlsZS0+c3RyZWFtc1tTTkRSVl9QQ01fU1RSRUFNX0NBUFRVUkVdOwogCWlmIChzdWJz
dHJlYW0gPT0gTlVMTCkKIAkJcmV0dXJuIC1FTlhJTzsKKyNpZm5kZWYgT1NTX0RFQlVHCiAJcmV0
dXJuIHNuZF9wY21fb3NzX3JlYWQxKHN1YnN0cmVhbSwgYnVmLCBjb3VudCk7CisjZWxzZQorCXsK
KwkJc3NpemVfdCByZXMgPSBzbmRfcGNtX29zc19yZWFkMShzdWJzdHJlYW0sIGJ1ZiwgY291bnQp
OworCQlwcmludGsoInBjbV9vc3M6IHJlYWQgJWxpIGJ5dGVzIChyZXR1cm5lZCAlbGkgYnl0ZXMp
XG4iLCAobG9uZyljb3VudCwgKGxvbmcpcmVzKTsKKwkJcmV0dXJuIHJlczsKKwl9CisjZW5kaWYK
IH0KIAogc3RhdGljIHNzaXplX3Qgc25kX3BjbV9vc3Nfd3JpdGUoc3RydWN0IGZpbGUgKmZpbGUs
IGNvbnN0IGNoYXIgKmJ1Ziwgc2l6ZV90IGNvdW50LCBsb2ZmX3QgKm9mZnNldCkKQEAgLTE4ODIs
NiArMTk3OSw5IEBACiAJdXAoJmZpbGUtPmZfZGVudHJ5LT5kX2lub2RlLT5pX3NlbSk7CiAJcmVz
dWx0ID0gc25kX3BjbV9vc3Nfd3JpdGUxKHN1YnN0cmVhbSwgYnVmLCBjb3VudCk7CiAJZG93bigm
ZmlsZS0+Zl9kZW50cnktPmRfaW5vZGUtPmlfc2VtKTsKKyNpZmRlZiBPU1NfREVCVUcKKwlwcmlu
dGsoInBjbV9vc3M6IHdyaXRlICVsaSBieXRlcyAod3JvdGUgJWxpIGJ5dGVzKVxuIiwgKGxvbmcp
Y291bnQsIChsb25nKXJlc3VsdCk7CisjZW5kaWYKIAlyZXR1cm4gcmVzdWx0OwogfQogCkBAIC0x
OTI3LDEyICsyMDI3LDIwIEBACiAJfQogCWlmIChjc3Vic3RyZWFtICE9IE5VTEwpIHsKIAkJc25k
X3BjbV9ydW50aW1lX3QgKnJ1bnRpbWUgPSBjc3Vic3RyZWFtLT5ydW50aW1lOworCQllbnVtIHNu
ZHJ2X3BjbV9zdGF0ZSBvc3RhdGU7CiAJCXBvbGxfd2FpdChmaWxlLCAmcnVudGltZS0+c2xlZXAs
IHdhaXQpOwogCQlzbmRfcGNtX3N0cmVhbV9sb2NrX2lycShjc3Vic3RyZWFtKTsKLQkJaWYgKHJ1
bnRpbWUtPnN0YXR1cy0+c3RhdGUgIT0gU05EUlZfUENNX1NUQVRFX1JVTk5JTkcgfHwKKwkJaWYg
KChvc3RhdGUgPSBydW50aW1lLT5zdGF0dXMtPnN0YXRlKSAhPSBTTkRSVl9QQ01fU1RBVEVfUlVO
TklORyB8fAogCQkgICAgc25kX3BjbV9vc3NfY2FwdHVyZV9yZWFkeShjc3Vic3RyZWFtKSkKIAkJ
CW1hc2sgfD0gUE9MTElOIHwgUE9MTFJETk9STTsKIAkJc25kX3BjbV9zdHJlYW1fdW5sb2NrX2ly
cShjc3Vic3RyZWFtKTsKKwkJaWYgKG9zdGF0ZSAhPSBTTkRSVl9QQ01fU1RBVEVfUlVOTklORyAm
JiBydW50aW1lLT5vc3MudHJpZ2dlcikgeworCQkJc25kX3BjbV9vc3NfZmlsZV90IG9maWxlOwor
CQkJbWVtc2V0KCZvZmlsZSwgMCwgc2l6ZW9mKG9maWxlKSk7CisJCQlvZmlsZS5zdHJlYW1zW1NO
RFJWX1BDTV9TVFJFQU1fQ0FQVFVSRV0gPSBwY21fb3NzX2ZpbGUtPnN0cmVhbXNbU05EUlZfUENN
X1NUUkVBTV9DQVBUVVJFXTsKKwkJCXJ1bnRpbWUtPm9zcy50cmlnZ2VyID0gMDsKKwkJCXNuZF9w
Y21fb3NzX3NldF90cmlnZ2VyKCZvZmlsZSwgUENNX0VOQUJMRV9JTlBVVCk7CisJCX0KIAl9CiAK
IAlyZXR1cm4gbWFzazsKQEAgLTE5NDUsNiArMjA1Myw5IEBACiAJc25kX3BjbV9ydW50aW1lX3Qg
KnJ1bnRpbWU7CiAJaW50IGVycjsKIAorI2lmZGVmIE9TU19ERUJVRworCXByaW50aygicGNtX29z
czogbW1hcCBiZWdpblxuIik7CisjZW5kaWYKIAlwY21fb3NzX2ZpbGUgPSBzbmRfbWFnaWNfY2Fz
dChzbmRfcGNtX29zc19maWxlX3QsIGZpbGUtPnByaXZhdGVfZGF0YSwgcmV0dXJuIC1FTlhJTyk7
CiAJc3dpdGNoICgoYXJlYS0+dm1fZmxhZ3MgJiAoVk1fUkVBRCB8IFZNX1dSSVRFKSkpIHsKIAlj
YXNlIFZNX1JFQUQgfCBWTV9XUklURToKQEAgLTE5ODgsNiArMjA5OSw5IEBACiAJaWYgKGVyciA8
IDApCiAJCXJldHVybiBlcnI7CiAJcnVudGltZS0+b3NzLm1tYXBfYnl0ZXMgPSBhcmVhLT52bV9l
bmQgLSBhcmVhLT52bV9zdGFydDsKKyNpZmRlZiBPU1NfREVCVUcKKwlwcmludGsoInBjbV9vc3M6
IG1tYXAgb2ssIGJ5dGVzID0gMHgleFxuIiwgcnVudGltZS0+b3NzLm1tYXBfYnl0ZXMpOworI2Vu
ZGlmCiAJLyogSW4gbW1hcCBtb2RlIHdlIG5ldmVyIHN0b3AgKi8KIAlydW50aW1lLT5zdG9wX3Ro
cmVzaG9sZCA9IHJ1bnRpbWUtPmJvdW5kYXJ5OwogCkBAIC0yMDA1LDE0ICsyMTE5LDE2IEBACiAJ
c25kX3BjbV9vc3Nfc2V0dXBfdCAqc2V0dXAgPSBwc3RyLT5vc3Muc2V0dXBfbGlzdDsKIAlkb3du
KCZwc3RyLT5vc3Muc2V0dXBfbXV0ZXgpOwogCXdoaWxlIChzZXR1cCkgewotCQlzbmRfaXByaW50
ZihidWZmZXIsICIlcyAldSAldSVzJXMlcyVzXG4iLAorCQlzbmRfaXByaW50ZihidWZmZXIsICIl
cyAldSAldSVzJXMlcyVzJXMlc1xuIiwKIAkJCSAgICBzZXR1cC0+dGFza19uYW1lLAogCQkJICAg
IHNldHVwLT5wZXJpb2RzLAogCQkJICAgIHNldHVwLT5wZXJpb2Rfc2l6ZSwKIAkJCSAgICBzZXR1
cC0+ZGlzYWJsZSA/ICIgZGlzYWJsZSIgOiAiIiwKIAkJCSAgICBzZXR1cC0+ZGlyZWN0ID8gIiBk
aXJlY3QiIDogIiIsCiAJCQkgICAgc2V0dXAtPmJsb2NrID8gIiBibG9jayIgOiAiIiwKLQkJCSAg
ICBzZXR1cC0+bm9uYmxvY2sgPyAiIG5vbi1ibG9jayIgOiAiIik7CisJCQkgICAgc2V0dXAtPm5v
bmJsb2NrID8gIiBub24tYmxvY2siIDogIiIsCisJCQkgICAgc2V0dXAtPndob2xlZnJhZyA/ICIg
d2hvbGUtZnJhZyIgOiAiIiwKKwkJCSAgICBzZXR1cC0+bm9zaWxlbmNlID8gIiBuby1zaWxlbmNl
IiA6ICIiKTsKIAkJc2V0dXAgPSBzZXR1cC0+bmV4dDsKIAl9CiAJdXAoJnBzdHItPm9zcy5zZXR1
cF9tdXRleCk7CkBAIC0yMDc4LDYgKzIxOTQsMTAgQEAKIAkJCQl0ZW1wbGF0ZS5ibG9jayA9IDE7
CiAJCQl9IGVsc2UgaWYgKCFzdHJjbXAoc3RyLCAibm9uLWJsb2NrIikpIHsKIAkJCQl0ZW1wbGF0
ZS5ub25ibG9jayA9IDE7CisJCQl9IGVsc2UgaWYgKCFzdHJjbXAoc3RyLCAid2hvbGUtZnJhZyIp
KSB7CisJCQkJdGVtcGxhdGUud2hvbGVmcmFnID0gMTsKKwkJCX0gZWxzZSBpZiAoIXN0cmNtcChz
dHIsICJuby1zaWxlbmNlIikpIHsKKwkJCQl0ZW1wbGF0ZS5ub3NpbGVuY2UgPSAxOwogCQkJfQog
CQl9IHdoaWxlICgqc3RyKTsKIAkJaWYgKHNldHVwID09IE5VTEwpIHsKQEAgLTIyNjksMyArMjM4
OSwyNCBAQAogCiBtb2R1bGVfaW5pdChhbHNhX3BjbV9vc3NfaW5pdCkKIG1vZHVsZV9leGl0KGFs
c2FfcGNtX29zc19leGl0KQorCisjaWZuZGVmIE1PRFVMRQorCisvKiBmb3JtYXQgaXM6IHNuZC1w
Y20tb3NzPWRzcF9tYXAsYWRzcF9tYXBbLG5vbmJsb2NrX29wZW5dICovCisKK3N0YXRpYyBpbnQg
X19pbml0IGFsc2FfcGNtX29zc19zZXR1cChjaGFyICpzdHIpCit7CisJc3RhdGljIHVuc2lnbmVk
IF9faW5pdGRhdGEgbnJfZGV2ID0gMDsKKworCWlmIChucl9kZXYgPj0gU05EUlZfQ0FSRFMpCisJ
CXJldHVybiAwOworCSh2b2lkKShnZXRfb3B0aW9uKCZzdHIsJmRzcF9tYXBbbnJfZGV2XSkgPT0g
MiAmJgorCSAgICAgICBnZXRfb3B0aW9uKCZzdHIsJmFkc3BfbWFwW25yX2Rldl0pID09IDIpOwor
CSh2b2lkKShnZXRfb3B0aW9uKCZzdHIsJm5vbmJsb2NrX29wZW4pID09IDIpOworCW5yX2Rldisr
OworCXJldHVybiAxOworfQorCitfX3NldHVwKCJzbmQtcGNtLW9zcz0iLCBhbHNhX3BjbV9vc3Nf
c2V0dXApOworCisjZW5kaWYgLyogIU1PRFVMRSAqLwpkaWZmIC1OcnUgYS9zb3VuZC9jb3JlL29z
cy9wY21fcGx1Z2luLmMgYi9zb3VuZC9jb3JlL29zcy9wY21fcGx1Z2luLmMKLS0tIGEvc291bmQv
Y29yZS9vc3MvcGNtX3BsdWdpbi5jCVNhdCBBdWcgIDIgMTI6MTY6MzEgMjAwMworKysgYi9zb3Vu
ZC9jb3JlL29zcy9wY21fcGx1Z2luLmMJU2F0IEF1ZyAgMiAxMjoxNjozMSAyMDAzCkBAIC01Niw2
ICs1NiwxNyBAQAogCXJldHVybiAwOwogfQogCisvKgorICogIGJlY2F1c2Ugc29tZSBjYXJkcyBt
aWdodCBoYXZlIHJhdGVzICJ2ZXJ5IGNsb3NlIiwgd2UgaWdub3JlCisgKiAgYWxsICJyZXNhbXBs
aW5nIiByZXF1ZXN0cyB3aXRoaW4gKy01JQorICovCitzdGF0aWMgaW50IHJhdGVfbWF0Y2godW5z
aWduZWQgaW50IHNyY19yYXRlLCB1bnNpZ25lZCBpbnQgZHN0X3JhdGUpCit7CisJdW5zaWduZWQg
aW50IGxvdyA9IChzcmNfcmF0ZSAqIDk1KSAvIDEwMDsKKwl1bnNpZ25lZCBpbnQgaGlnaCA9IChz
cmNfcmF0ZSAqIDEwNSkgLyAxMDA7CisJcmV0dXJuIGRzdF9yYXRlID49IGxvdyAmJiBkc3RfcmF0
ZSA8PSBoaWdoOworfQorCiBzdGF0aWMgaW50IHNuZF9wY21fcGx1Z2luX2FsbG9jKHNuZF9wY21f
cGx1Z2luX3QgKnBsdWdpbiwgc25kX3BjbV91ZnJhbWVzX3QgZnJhbWVzKQogewogCXNuZF9wY21f
cGx1Z2luX2Zvcm1hdF90ICpmb3JtYXQ7CkBAIC04MCwxMSArOTEsMTQgQEAKIAkJcGx1Z2luLT5i
dWYgPSB2bWFsbG9jKHNpemUpOwogCQlwbHVnaW4tPmJ1Zl9mcmFtZXMgPSBmcmFtZXM7CiAJfQot
CWlmICghcGx1Z2luLT5idWYpCisJaWYgKCFwbHVnaW4tPmJ1ZikgeworCQlwbHVnaW4tPmJ1Zl9m
cmFtZXMgPSAwOwogCQlyZXR1cm4gLUVOT01FTTsKKwl9CiAJYyA9IHBsdWdpbi0+YnVmX2NoYW5u
ZWxzOwogCWlmIChwbHVnaW4tPmFjY2VzcyA9PSBTTkRSVl9QQ01fQUNDRVNTX1JXX0lOVEVSTEVB
VkVEKSB7CiAJCWZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBmb3JtYXQtPmNoYW5uZWxzOyBj
aGFubmVsKyssIGMrKykgeworCQkJYy0+ZnJhbWVzID0gZnJhbWVzOwogCQkJYy0+ZW5hYmxlZCA9
IDE7CiAJCQljLT53YW50ZWQgPSAwOwogCQkJYy0+YXJlYS5hZGRyID0gcGx1Z2luLT5idWY7CkBA
IC05NSw2ICsxMDksNyBAQAogCQlzbmRfYXNzZXJ0KChzaXplICUgZm9ybWF0LT5jaGFubmVscykg
PT0gMCwpOwogCQlzaXplIC89IGZvcm1hdC0+Y2hhbm5lbHM7CiAJCWZvciAoY2hhbm5lbCA9IDA7
IGNoYW5uZWwgPCBmb3JtYXQtPmNoYW5uZWxzOyBjaGFubmVsKyssIGMrKykgeworCQkJYy0+ZnJh
bWVzID0gZnJhbWVzOwogCQkJYy0+ZW5hYmxlZCA9IDE7CiAJCQljLT53YW50ZWQgPSAwOwogCQkJ
Yy0+YXJlYS5hZGRyID0gcGx1Z2luLT5idWYgKyAoY2hhbm5lbCAqIHNpemUpOwpAQCAtNDIwLDcg
KzQzNSw3IEBACiAKIAkvKiBGb3JtYXQgY2hhbmdlIChsaW5lYXJpemF0aW9uKSAqLwogCWlmICgo
c3JjZm9ybWF0LmZvcm1hdCAhPSBkc3Rmb3JtYXQuZm9ybWF0IHx8Ci0JICAgICBzcmNmb3JtYXQu
cmF0ZSAhPSBkc3Rmb3JtYXQucmF0ZSB8fAorCSAgICAgIXJhdGVfbWF0Y2goc3JjZm9ybWF0LnJh
dGUsIGRzdGZvcm1hdC5yYXRlKSB8fAogCSAgICAgc3JjZm9ybWF0LmNoYW5uZWxzICE9IGRzdGZv
cm1hdC5jaGFubmVscykgJiYKIAkgICAgIXNuZF9wY21fZm9ybWF0X2xpbmVhcihzcmNmb3JtYXQu
Zm9ybWF0KSkgewogCQlpZiAoc25kX3BjbV9mb3JtYXRfbGluZWFyKGRzdGZvcm1hdC5mb3JtYXQp
KQpAQCAtNDY4LDcgKzQ4Myw3IEBACiAJCQkJdHRhYmxlW3YgKiBzdiArIHZdID0gRlVMTDsKIAkJ
fQogCQl0bXBmb3JtYXQuY2hhbm5lbHMgPSBkc3Rmb3JtYXQuY2hhbm5lbHM7Ci0JCWlmIChzcmNm
b3JtYXQucmF0ZSA9PSBkc3Rmb3JtYXQucmF0ZSAmJgorCQlpZiAocmF0ZV9tYXRjaChzcmNmb3Jt
YXQucmF0ZSwgZHN0Zm9ybWF0LnJhdGUpICYmCiAJCSAgICBzbmRfcGNtX2Zvcm1hdF9saW5lYXIo
ZHN0Zm9ybWF0LmZvcm1hdCkpCiAJCQl0bXBmb3JtYXQuZm9ybWF0ID0gZHN0Zm9ybWF0LmZvcm1h
dDsKIAkJZXJyID0gc25kX3BjbV9wbHVnaW5fYnVpbGRfcm91dGUocGx1ZywKQEAgLTQ5MCw3ICs1
MDUsNyBAQAogCX0KIAogCS8qIHJhdGUgcmVzYW1wbGluZyAqLwotCWlmIChzcmNmb3JtYXQucmF0
ZSAhPSBkc3Rmb3JtYXQucmF0ZSkgeworCWlmICghcmF0ZV9tYXRjaChzcmNmb3JtYXQucmF0ZSwg
ZHN0Zm9ybWF0LnJhdGUpKSB7CiAJCXRtcGZvcm1hdC5yYXRlID0gZHN0Zm9ybWF0LnJhdGU7CiAJ
CWlmIChzcmNmb3JtYXQuY2hhbm5lbHMgPT0gZHN0Zm9ybWF0LmNoYW5uZWxzICYmCiAJCSAgICBz
bmRfcGNtX2Zvcm1hdF9saW5lYXIoZHN0Zm9ybWF0LmZvcm1hdCkpCmRpZmYgLU5ydSBhL3NvdW5k
L2NvcmUvb3NzL3BjbV9wbHVnaW4uaCBiL3NvdW5kL2NvcmUvb3NzL3BjbV9wbHVnaW4uaAotLS0g
YS9zb3VuZC9jb3JlL29zcy9wY21fcGx1Z2luLmgJU2F0IEF1ZyAgMiAxMjoxNjozNSAyMDAzCisr
KyBiL3NvdW5kL2NvcmUvb3NzL3BjbV9wbHVnaW4uaAlTYXQgQXVnICAyIDEyOjE2OjM1IDIwMDMK
QEAgLTEwNiw2ICsxMDYsNyBAQAogdHlwZWRlZiBzdHJ1Y3QgX3NuZF9wY21fcGx1Z2luX2NoYW5u
ZWwgewogCXZvaWQgKmFwdHI7CQkJLyogcG9pbnRlciB0byB0aGUgYWxsb2NhdGVkIGFyZWEgKi8K
IAlzbmRfcGNtX2NoYW5uZWxfYXJlYV90IGFyZWE7CisJc25kX3BjbV91ZnJhbWVzX3QgZnJhbWVz
OwkvKiBhbGxvY2F0ZWQgZnJhbWVzICovCiAJdW5zaWduZWQgaW50IGVuYWJsZWQ6MTsJCS8qIGNo
YW5uZWwgbmVlZCB0byBiZSBwcm9jZXNzZWQgKi8KIAl1bnNpZ25lZCBpbnQgd2FudGVkOjE7CQkv
KiBjaGFubmVsIGlzIHdhbnRlZCAqLwogfSBzbmRfcGNtX3BsdWdpbl9jaGFubmVsX3Q7CmRpZmYg
LU5ydSBhL3NvdW5kL2NvcmUvcGNtX2xpYi5jIGIvc291bmQvY29yZS9wY21fbGliLmMKLS0tIGEv
c291bmQvY29yZS9wY21fbGliLmMJU2F0IEF1ZyAgMiAxMjoxNjozMSAyMDAzCisrKyBiL3NvdW5k
L2NvcmUvcGNtX2xpYi5jCVNhdCBBdWcgIDIgMTI6MTY6MzEgMjAwMwpAQCAtNjAsNyArNjAsNyBA
QAogCQkJcmV0dXJuOwogCQlzbmRfYXNzZXJ0KHJ1bnRpbWUtPnNpbGVuY2VfZmlsbGVkIDw9IHJ1
bnRpbWUtPmJ1ZmZlcl9zaXplLCByZXR1cm4pOwogCQlub2lzZV9kaXN0ID0gc25kX3BjbV9wbGF5
YmFja19od19hdmFpbChydW50aW1lKSArIHJ1bnRpbWUtPnNpbGVuY2VfZmlsbGVkOwotCQlpZiAo
bm9pc2VfZGlzdCA+IChzbmRfcGNtX3NmcmFtZXNfdCkgcnVudGltZS0+c2lsZW5jZV90aHJlc2hv
bGQpCisJCWlmIChub2lzZV9kaXN0ID49IChzbmRfcGNtX3NmcmFtZXNfdCkgcnVudGltZS0+c2ls
ZW5jZV90aHJlc2hvbGQpCiAJCQlyZXR1cm47CiAJCWZyYW1lcyA9IHJ1bnRpbWUtPnNpbGVuY2Vf
dGhyZXNob2xkIC0gbm9pc2VfZGlzdDsKIAkJaWYgKGZyYW1lcyA+IHJ1bnRpbWUtPnNpbGVuY2Vf
c2l6ZSkKQEAgLTg0LDEwICs4NCw5IEBACiAJCQlpZiAoKHNuZF9wY21fc2ZyYW1lc190KXJ1bnRp
bWUtPnNpbGVuY2Vfc3RhcnQgPCAwKQogCQkJCXJ1bnRpbWUtPnNpbGVuY2Vfc3RhcnQgKz0gcnVu
dGltZS0+Ym91bmRhcnk7CiAJCX0KLQkJZnJhbWVzID0gcnVudGltZS0+YnVmZmVyX3NpemU7CisJ
CWZyYW1lcyA9IHJ1bnRpbWUtPmJ1ZmZlcl9zaXplIC0gcnVudGltZS0+c2lsZW5jZV9maWxsZWQ7
CiAJfQotCXNuZF9hc3NlcnQoZnJhbWVzID49IHJ1bnRpbWUtPnNpbGVuY2VfZmlsbGVkLCByZXR1
cm4pOwotCWZyYW1lcyAtPSBydW50aW1lLT5zaWxlbmNlX2ZpbGxlZDsKKwlzbmRfYXNzZXJ0KGZy
YW1lcyA8PSBydW50aW1lLT5idWZmZXJfc2l6ZSwgcmV0dXJuKTsKIAlpZiAoZnJhbWVzID09IDAp
CiAJCXJldHVybjsKIAlvZnMgPSAocnVudGltZS0+c2lsZW5jZV9zdGFydCArIHJ1bnRpbWUtPnNp
bGVuY2VfZmlsbGVkKSAlIHJ1bnRpbWUtPmJ1ZmZlcl9zaXplOwpAQCAtMTkzMiw3ICsxOTMxLDcg
QEAKIAkJaWYgKHJ1bnRpbWUtPnNpbGVuY2Vfc2l6ZSA+PSBydW50aW1lLT5ib3VuZGFyeSkgewog
CQkJZnJhbWVzID0gMTsKIAkJfSBlbHNlIGlmIChydW50aW1lLT5zaWxlbmNlX3NpemUgPiAwICYm
Ci0JCSAgICBydW50aW1lLT5zaWxlbmNlX2ZpbGxlZCA8IHJ1bnRpbWUtPmJ1ZmZlcl9zaXplKSB7
CisJCQkgICBydW50aW1lLT5zaWxlbmNlX2ZpbGxlZCA8IHJ1bnRpbWUtPmJ1ZmZlcl9zaXplKSB7
CiAJCQlzbmRfcGNtX3NmcmFtZXNfdCBub2lzZV9kaXN0OwogCQkJbm9pc2VfZGlzdCA9IHNuZF9w
Y21fcGxheWJhY2tfaHdfYXZhaWwocnVudGltZSkgKyBydW50aW1lLT5zaWxlbmNlX2ZpbGxlZDsK
IAkJCXNuZF9hc3NlcnQobm9pc2VfZGlzdCA8PSAoc25kX3BjbV9zZnJhbWVzX3QpcnVudGltZS0+
c2lsZW5jZV90aHJlc2hvbGQsICk7CmRpZmYgLU5ydSBhL3NvdW5kL2NvcmUvcGNtX21lbW9yeS5j
IGIvc291bmQvY29yZS9wY21fbWVtb3J5LmMKLS0tIGEvc291bmQvY29yZS9wY21fbWVtb3J5LmMJ
U2F0IEF1ZyAgMiAxMjoxNjozNCAyMDAzCisrKyBiL3NvdW5kL2NvcmUvcGNtX21lbW9yeS5jCVNh
dCBBdWcgIDIgMTI6MTY6MzQgMjAwMwpAQCAtMjIsNiArMjIsNyBAQAogI2luY2x1ZGUgPHNvdW5k
L2RyaXZlci5oPgogI2luY2x1ZGUgPGFzbS9pby5oPgogI2luY2x1ZGUgPGxpbnV4L3RpbWUuaD4K
KyNpbmNsdWRlIDxsaW51eC9pbml0Lmg+CiAjaW5jbHVkZSA8c291bmQvY29yZS5oPgogI2luY2x1
ZGUgPHNvdW5kL3BjbS5oPgogI2luY2x1ZGUgPHNvdW5kL2luZm8uaD4KQEAgLTU2OCwzICs1Njks
MTggQEAKIH0KIAogI2VuZGlmIC8qIENPTkZJR19QQ0kgKi8KKworI2lmbmRlZiBNT0RVTEUKKwor
LyogZm9ybWF0IGlzOiBzbmQtcGNtPXByZWFsbG9jYXRlX2RtYSxtYXhpbXVtX3N1YnN0cmVhbXMg
Ki8KKworc3RhdGljIGludCBfX2luaXQgYWxzYV9wY21fc2V0dXAoY2hhciAqc3RyKQoreworCSh2
b2lkKShnZXRfb3B0aW9uKCZzdHIsJnByZWFsbG9jYXRlX2RtYSkgPT0gMiAmJgorCSAgICAgICBn
ZXRfb3B0aW9uKCZzdHIsJm1heGltdW1fc3Vic3RyZWFtcykgPT0gMik7CisJcmV0dXJuIDE7Cit9
CisKK19fc2V0dXAoInNuZC1wY209IiwgYWxzYV9wY21fc2V0dXApOworCisjZW5kaWYgLyogaWZu
ZGVmIE1PRFVMRSAqLwpkaWZmIC1OcnUgYS9zb3VuZC9jb3JlL3BjbV9uYXRpdmUuYyBiL3NvdW5k
L2NvcmUvcGNtX25hdGl2ZS5jCi0tLSBhL3NvdW5kL2NvcmUvcGNtX25hdGl2ZS5jCVNhdCBBdWcg
IDIgMTI6MTY6MzEgMjAwMworKysgYi9zb3VuZC9jb3JlL3BjbV9uYXRpdmUuYwlTYXQgQXVnICAy
IDEyOjE2OjMxIDIwMDMKQEAgLTQ2MSw5ICs0NjEsMTUgQEAKIAlpZiAocGFyYW1zLT54ZmVyX2Fs
aWduID09IDAgfHwKIAkgICAgcGFyYW1zLT54ZmVyX2FsaWduICUgcnVudGltZS0+bWluX2FsaWdu
ICE9IDApCiAJCXJldHVybiAtRUlOVkFMOwotCWlmICgocGFyYW1zLT5zaWxlbmNlX3RocmVzaG9s
ZCAhPSAwIHx8IHBhcmFtcy0+c2lsZW5jZV9zaXplIDwgcnVudGltZS0+Ym91bmRhcnkpICYmCi0J
ICAgIChwYXJhbXMtPnNpbGVuY2VfdGhyZXNob2xkICsgcGFyYW1zLT5zaWxlbmNlX3NpemUgPiBy
dW50aW1lLT5idWZmZXJfc2l6ZSkpCi0JCXJldHVybiAtRUlOVkFMOworCWlmIChwYXJhbXMtPnNp
bGVuY2Vfc2l6ZSA+PSBydW50aW1lLT5ib3VuZGFyeSkgeworCQlpZiAocGFyYW1zLT5zaWxlbmNl
X3RocmVzaG9sZCAhPSAwKQorCQkJcmV0dXJuIC1FSU5WQUw7CisJfSBlbHNlIHsKKwkJaWYgKHBh
cmFtcy0+c2lsZW5jZV9zaXplID4gcGFyYW1zLT5zaWxlbmNlX3RocmVzaG9sZCkKKwkJCXJldHVy
biAtRUlOVkFMOworCQlpZiAocGFyYW1zLT5zaWxlbmNlX3RocmVzaG9sZCA+IHJ1bnRpbWUtPmJ1
ZmZlcl9zaXplKQorCQkJcmV0dXJuIC1FSU5WQUw7CisJfQogCXNuZF9wY21fc3RyZWFtX2xvY2tf
aXJxKHN1YnN0cmVhbSk7CiAJcnVudGltZS0+dHN0YW1wX21vZGUgPSBwYXJhbXMtPnRzdGFtcF9t
b2RlOwogCXJ1bnRpbWUtPnNsZWVwX21pbiA9IHBhcmFtcy0+c2xlZXBfbWluOwpkaWZmIC1OcnUg
YS9zb3VuZC9jb3JlL29zcy9yYXRlLmMgYi9zb3VuZC9jb3JlL29zcy9yYXRlLmMKLS0tIGEvc291
bmQvY29yZS9vc3MvcmF0ZS5jCVNhdCBBdWcgIDIgMTI6MTY6MzIgMjAwMworKysgYi9zb3VuZC9j
b3JlL29zcy9yYXRlLmMJU2F0IEF1ZyAgMiAxMjoxNjozMiAyMDAzCkBAIC04NSwxMSArODUsNyBA
QAogI3VuZGVmIFBVVF9TMTZfTEFCRUxTCiAJdm9pZCAqZ2V0ID0gZ2V0X3MxNl9sYWJlbHNbZGF0
YS0+Z2V0XTsKIAl2b2lkICpwdXQgPSBwdXRfczE2X2xhYmVsc1tkYXRhLT5wdXRdOwotCXZvaWQg
KmdldF9zMTZfZW5kID0gMDsKIAlzaWduZWQgc2hvcnQgc2FtcGxlID0gMDsKLSNkZWZpbmUgR0VU
X1MxNl9FTkQgKmdldF9zMTZfZW5kCi0jaW5jbHVkZSAicGx1Z2luX29wcy5oIgotI3VuZGVmIEdF
VF9TMTZfRU5ECiAJCiAJZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IHBsdWdpbi0+c3JjX2Zv
cm1hdC5jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAJCXBvcyA9IGRhdGEtPnBvczsKQEAgLTEwOCwy
NCArMTA0LDE2IEBACiAJCWRzdF9zdGVwID0gZHN0X2NoYW5uZWxzW2NoYW5uZWxdLmFyZWEuc3Rl
cCAvIDg7CiAJCXNyY19mcmFtZXMxID0gc3JjX2ZyYW1lczsKIAkJZHN0X2ZyYW1lczEgPSBkc3Rf
ZnJhbWVzOwotCQlpZiAocG9zICYgflJfTUFTSykgewotCQkJZ2V0X3MxNl9lbmQgPSAmJmFmdGVy
X2dldDE7Ci0JCQlnb3RvICpnZXQ7Ci0JCWFmdGVyX2dldDE6Ci0JCQlwb3MgJj0gUl9NQVNLOwot
CQkJUzEgPSBTMjsKLQkJCVMyID0gc2FtcGxlOwotCQkJc3JjICs9IHNyY19zdGVwOwotCQkJc3Jj
X2ZyYW1lczEtLTsKLQkJfQogCQl3aGlsZSAoZHN0X2ZyYW1lczEtLSA+IDApIHsKIAkJCWlmIChw
b3MgJiB+Ul9NQVNLKSB7CiAJCQkJcG9zICY9IFJfTUFTSzsKIAkJCQlTMSA9IFMyOwogCQkJCWlm
IChzcmNfZnJhbWVzMS0tID4gMCkgewotCQkJCQlnZXRfczE2X2VuZCA9ICYmYWZ0ZXJfZ2V0MjsK
IAkJCQkJZ290byAqZ2V0OwotCQkJCWFmdGVyX2dldDI6CisjZGVmaW5lIEdFVF9TMTZfRU5EIGFm
dGVyX2dldAorI2luY2x1ZGUgInBsdWdpbl9vcHMuaCIKKyN1bmRlZiBHRVRfUzE2X0VORAorCQkJ
CWFmdGVyX2dldDoKIAkJCQkJUzIgPSBzYW1wbGU7CiAJCQkJCXNyYyArPSBzcmNfc3RlcDsKIAkJ
CQl9CkBAIC0zMTgsNiArMzA2LDggQEAKICNlbmRpZgogCiAJZHN0X2ZyYW1lcyA9IHJhdGVfZHN0
X2ZyYW1lcyhwbHVnaW4sIGZyYW1lcyk7CisJaWYgKGRzdF9mcmFtZXMgPiBkc3RfY2hhbm5lbHNb
MF0uZnJhbWVzKQorCQlkc3RfZnJhbWVzID0gZHN0X2NoYW5uZWxzWzBdLmZyYW1lczsKIAlkYXRh
ID0gKHJhdGVfdCAqKXBsdWdpbi0+ZXh0cmFfZGF0YTsKIAlkYXRhLT5mdW5jKHBsdWdpbiwgc3Jj
X2NoYW5uZWxzLCBkc3RfY2hhbm5lbHMsIGZyYW1lcywgZHN0X2ZyYW1lcyk7CiAJcmV0dXJuIGRz
dF9mcmFtZXM7Cg==
--=====================_30985828==_--

