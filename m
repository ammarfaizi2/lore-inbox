Return-Path: <linux-kernel-owner+willy=40w.ods.org-S1758196AbWK0Njc@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1758196AbWK0Njc (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 27 Nov 2006 08:39:32 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1758203AbWK0Njc
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 27 Nov 2006 08:39:32 -0500
Received: from wr-out-0506.google.com ([64.233.184.227]:50384 "EHLO
	wr-out-0506.google.com") by vger.kernel.org with ESMTP
	id S1758196AbWK0Njb (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Mon, 27 Nov 2006 08:39:31 -0500
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
        s=beta; d=gmail.com;
        h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:references;
        b=CQORImdUQ0CKxZeNdmdc46mOnA4O4F/d3qeAC6UzfgqV7aH4COx37Q/4Xrwr5j5wFkoYMKXz9vRcIHKZ2zUnvy/ijD7GfotiK0nJT0MxHmSk6h9ydUvVx0izVv9e2w+IC6Bnfb8PJUT+h9fuiNVq+71JLuuU7TMkCu4K2N/XLX4=
Message-ID: <344eb09a0611270539v6b65fb6bo9f7bfcc24f1a9a73@mail.gmail.com>
Date: Mon, 27 Nov 2006 19:09:29 +0530
From: "Bharata B Rao" <bharata.rao@gmail.com>
To: "=?ISO-8859-1?Q?S=E9bastien_Dugu=E9?=" <sebastien.dugue@bull.net>
Subject: Re: [PATCH -mm 4/4][AIO] - Listio support
Cc: linux-kernel <linux-kernel@vger.kernel.org>,
       linux-aio <linux-aio@kvack.org>, "Andrew Morton" <akpm@osdl.org>,
       "Suparna Bhattacharya" <suparna@in.ibm.com>,
       "Christoph Hellwig" <hch@infradead.org>,
       "Zach Brown" <zach.brown@oracle.com>,
       "Badari Pulavarty" <pbadari@us.ibm.com>,
       "Jean Pierre Dion" <jean-pierre.dion@bull.net>,
       "Ulrich Drepper" <drepper@redhat.com>
In-Reply-To: <20061120152307.46dbf409@frecb000686>
MIME-Version: 1.0
Content-Type: multipart/mixed; 
	boundary="----=_Part_77092_19065165.1164634769333"
References: <20061120151700.4a4f9407@frecb000686>
	 <20061120152307.46dbf409@frecb000686>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

------=_Part_77092_19065165.1164634769333
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On 11/20/06, S=E9bastien Dugu=E9 <sebastien.dugue@bull.net> wrote:
>
>                         POSIX listio support
>
>   This patch adds POSIX listio completion notification support. It builds
> on support provided by the aio signal notification patch and adds an
> IOCB_CMD_GROUP command to io_submit().
>

I have altered this patch to provide the listio support through a
separate syscall.

The code is in RFC stage at the moment and is only compile-tested on
i386. I have refrained from modifying unistd.h for now in order to
avoid touching too many files. I plan to do actual tests (which
involves user space changes to aio libraries) only if there is an
agreement with this syscall approach.

More details about the interface are in the patch itself.

Regards,
Bharata.

------=_Part_77092_19065165.1164634769333
Content-Type: text/x-patch; name=aio-listio-support.patch; 
	charset=ANSI_X3.4-1968
Content-Transfer-Encoding: base64
X-Attachment-Id: f_ev0xmpnl
Content-Disposition: attachment; filename="aio-listio-support.patch"

CiAgVGhpcyBwYXRjaCBhZGRzIFBPU0lYIGxpc3RpbyBjb21wbGV0aW9uIG5vdGlmaWNhdGlvbiBz
dXBwb3J0LiBJdCBidWlsZHMKb24gc3VwcG9ydCBwcm92aWRlZCBieSB0aGUgYWlvIHNpZ25hbCBu
b3RpZmljYXRpb24gcGF0Y2ggYW5kIGFkZHMgYQpzeXN0ZW0gY2FsbCBsaW9fc3VibWl0KCkuCgog
IGxpb19zdWJtaXQoKSBpcyBzaW1pbGFyIHRvIGlvX3N1Ym1pdCgpIGV4Y2VwdCB0aGF0IGl0IHRh
a2VzIHR3byBtb3JlCmFyZ3VybWVudHM6IG1vZGUgYW5kIHNpZ2V2ZW50LgoKICBtb2RlIGNhbiBi
ZSBMSU9fV0FJVCBvciBMSU9fTk9XQUlULiBzaWdldmVudCBhcmd1bWVudCBzcGVjaWZpY2llcwp0
aGUgc2lnZXZlbnQgbm90aWZpY2F0aW9uIG1lY2hhbmlzbSBvbiBsaXN0aW8gY29tcGxldGlvbi4g
bGlvX3N1Ym1pdCgpCndhaXRzIHdpdGhpbiB0aGUgc3lzY2FsbCBpZiBMSU9fV0FJVCBpcyBzcGVj
aWZpZWQuCgogIEEgc3RydWN0IGxpb19ldmVudCBpcyBhZGRlZCBpbiBpbmNsdWRlL2xpbnV4L2Fp
by5oCgogIEEgc3RydWN0IGxpb19ldmVudCAqa2lfbGlvIGlzIGFkZGVkIHRvIHN0cnVjdCBpb2Ni
IGluIGluY2x1ZGUvbGludXgvYWlvLmgKCiAgSW4gbGlvX3N1Ym1pdCgpLCBhIGxpb19ldmVudCBp
cyBjcmVhdGVkIGluIGxpb19jcmVhdGUoKSB3aGljaCBjb250YWlucyB0aGUKbmVjZXNzYXJ5IGlu
Zm9ybWF0aW9uIGZvciBzaWduYWxpbmcgYSB0aHJlYWQgKHNpZ25hbCBudW1iZXIsIHBpZCwgbm90
aWZ5IHR5cGUKYW5kIHZhbHVlKSBhbG9uZyB3aXRoIGEgY291bnQgb2YgcmVxdWVzdHMgYXR0YWNo
ZWQgdG8gdGhpcyBldmVudC4KCiAgICAgICAgVGhlIGZvbGxvd2luZyBkZXBpY3RzIHRoZSBsaW9f
ZXZlbnQgc3RydWN0dXJlOgoKICAgICAgICBzdHJ1Y3QgbGlvX2V2ZW50IHsKICAgICAgICAgICAg
ICAgIGF0b21pY190CQlsaW9fdXNlcnM7CiAgICAgICAgICAgICAgICBzdHJ1Y3QgYWlvX25vdGlm
eQlsaW9fbm90aWZ5OwogICAgICAgIH07CgogIGxpb191c2VycyBob2xkcyBhbiBhdG9taWMgY291
bnRlciBvZiB0aGUgbnVtYmVyIG9mIHJlcXVlc3RzIGF0dGFjaGVkIHRvIHRoaXMKbGlvLiBJdCBp
cyBpbmNyZW1lbnRlZCB3aXRoIGVhY2ggcmVxdWVzdCBzdWJtaXR0ZWQgYW5kIGRlY3JlbWVudGVk
IGF0IGVhY2gKcmVxdWVzdCBjb21wbGV0aW9uLiBXaGVuIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwg
d2Ugc2VuZCB0aGUgbm90aWZpY2F0aW9uLgoKICBJbiBhaW9fY29tcGxldGUoKSwgaWYgdGhlIHJl
cXVlc3QgaXMgYXR0YWNoZWQgdG8gYW4gbGlvIChraV9saW8gPD4gMCksCnRoZW4gbGlvX2NoZWNr
KCkgaXMgY2FsbGVkIHRvIGRlY3JlbWVudCB0aGUgbGlvX3VzZXJzIGNvdW50IGFuZCBldmVudHVh
bGx5CnNpZ25hbCB0aGUgdXNlciBwcm9jZXNzIHdoZW4gYWxsIHRoZSByZXF1ZXN0cyBpbiB0aGUg
Z3JvdXAgaGF2ZSBjb21wbGV0ZWQuCgpTZWJhc3RpZW4gRHVndWUncyBsaXN0aW8gcGF0Y2ggaGFz
IGJlZW4gbW9kaWZpZWQgdG8gYXJyaXZlIGF0IHRoaXMgcGF0Y2guCgpTaWduZWQtb2ZmLWJ5OiBT
ZWJhc3RpZW4gRHVndWUgPHNlYmFzdGllbi5kdWd1ZUBidWxsLm5ldD4KU2lnbmVkLW9mZi1ieTog
TGF1cmVudCBWaXZpZXIgPGxhdXJlbnQudml2aWVyQGJ1bGwubmV0PgpTaWduZWQtb2ZmLWJ5OiBC
aGFyYXRhIEIgUmFvIDxiaGFyYXRhLnJhb0BnbWFpbC5jb20+Ci0tLQoKIGZzL2Fpby5jICAgICAg
ICAgICAgICAgICB8ICAxODEgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KystLS0tLS0KIGZzL2NvbXBhdC5jICAgICAgICAgICAgICB8ICAgMjkgKysrKysrKwogaW5jbHVk
ZS9saW51eC9haW8uaCAgICAgIHwgICAxMyArKy0KIGluY2x1ZGUvbGludXgvYWlvX2FiaS5oICB8
ICAgIDUgKwogaW5jbHVkZS9saW51eC9zeXNjYWxscy5oIHwgICAgMiAKIDUgZmlsZXMgY2hhbmdl
ZCwgMjA0IGluc2VydGlvbnMoKyksIDI2IGRlbGV0aW9ucygtKQoKZGlmZiAtcHVOIGZzL2Fpby5j
fmFpby1saXN0aW8tc3VwcG9ydCBmcy9haW8uYwotLS0gbGludXgtMi42LjE5LXJjNS1tbTIvZnMv
YWlvLmN+YWlvLWxpc3Rpby1zdXBwb3J0CTIwMDYtMTEtMjMgMTk6MDU6MzMuMDAwMDAwMDAwICsw
NTMwCisrKyBsaW51eC0yLjYuMTktcmM1LW1tMi1iaGFyYXRhL2ZzL2Fpby5jCTIwMDYtMTEtMjUg
MTE6MjQ6NTUuMDAwMDAwMDAwICswNTMwCkBAIC00MTMsNiArNDEzLDcgQEAgc3RhdGljIHN0cnVj
dCBraW9jYiBmYXN0Y2FsbCAqX19haW9fZ2V0XwogCXJlcS0+a2lfY3R4ID0gY3R4OwogCXJlcS0+
a2lfY2FuY2VsID0gTlVMTDsKIAlyZXEtPmtpX3JldHJ5ID0gTlVMTDsKKwlyZXEtPmtpX2xpbyA9
IE5VTEw7CiAJcmVxLT5raV9kdG9yID0gTlVMTDsKIAlyZXEtPnByaXZhdGUgPSBOVUxMOwogCXJl
cS0+a2lfaW92ZWMgPSBOVUxMOwpAQCAtMTAxMCw2ICsxMDExLDU5IEBAIG91dF91bmxvY2s6CiAJ
cmV0dXJuIC1FSU5WQUw7CiB9CiAKK3N0YXRpYyBpbmxpbmUgdm9pZCBsaW9fY2hlY2soc3RydWN0
IGxpb19ldmVudCAqbGlvKQoreworCWludCByZXQ7CisKKwlyZXQgPSBhdG9taWNfZGVjX2FuZF90
ZXN0KCZsaW8tPmxpb191c2Vycyk7CisKKwlpZiAodW5saWtlbHkocmV0KSAmJiBsaW8tPmxpb19u
b3RpZnkubm90aWZ5ICE9IFNJR0VWX05PTkUpIHsKKwkJLyogbGFzdCBvbmUgLT4gbm90aWZ5IHBy
b2Nlc3MgKi8KKwkJaWYgKGFpb19zZW5kX3NpZ25hbCgmbGlvLT5saW9fbm90aWZ5KSkKKwkJCXNp
Z3F1ZXVlX2ZyZWUobGlvLT5saW9fbm90aWZ5LnNpZ3EpOworCQlrZnJlZShsaW8pOworCX0KK30K
Kworc3RhdGljIHN0cnVjdCBsaW9fZXZlbnQgKmxpb19jcmVhdGUoc3RydWN0IHNpZ2V2ZW50IF9f
dXNlciAqdXNlcl9ldmVudCwKKwkJCWludCBtb2RlKQoreworCWludCByZXQgPSAwOworCXN0cnVj
dCBsaW9fZXZlbnQgKmxpbyA9IE5VTEw7CisKKwlpZiAodW5saWtlbHkoKG1vZGUgPT0gTElPX05P
V0FJVCkgJiYgIXVzZXJfZXZlbnQpKQorCQlyZXR1cm4gbGlvOworCisJbGlvID0ga3phbGxvYyhz
aXplb2YoKmxpbyksIEdGUF9LRVJORUwpOworCisJaWYgKCFsaW8pCisJCXJldHVybiBFUlJfUFRS
KC1FQUdBSU4pOworCisJLyoKKwkgKiBHcmFiIGFuIGluaXRpYWwgcmVmIG9uIHRoZSBsaW8gdG8g
YXZvaWQgcmFjZXMgYmV0d2VlbgorCSAqIHN1Ym1pc3Npb24gYW5kIGNvbXBsZXRpb24uCisJICov
CisJYXRvbWljX3NldCgmbGlvLT5saW9fdXNlcnMsIDEpOworCisJbGlvLT5saW9fbm90aWZ5Lm5v
dGlmeSA9IFNJR0VWX05PTkU7CisKKwkvKiBzaWdldmVudCBhcmd1bWVudCBpcyBpZ25vcmVkIHdp
dGggTElPX1dBSVQgKi8KKwlpZiAodXNlcl9ldmVudCAmJiAobW9kZSA9PSBMSU9fTk9XQUlUKSkg
eworCQkvKgorCQkgKiBVc2VyIHNwZWNpZmllZCBhbiBldmVudCBmb3IgdGhpcyBsaW8sCisJCSAq
IGhlIHdhbnRzIHRvIGJlIG5vdGlmaWVkIHVwb24gbGlvIGNvbXBsZXRpb24uCisJCSAqLworCQly
ZXQgPSBhaW9fc2V0dXBfc2lnZXZlbnQoJmxpby0+bGlvX25vdGlmeSwgdXNlcl9ldmVudCk7CisK
KwkJaWYgKHJldCkgeworCQkJa2ZyZWUobGlvKTsKKwkJCXJldHVybiBFUlJfUFRSKHJldCk7CisJ
CX0KKwl9CisKKwlyZXR1cm4gbGlvOworfQorCiAvKiBhaW9fY29tcGxldGUKICAqCUNhbGxlZCB3
aGVuIHRoZSBpbyByZXF1ZXN0IG9uIHRoZSBnaXZlbiBpb2NiIGlzIGNvbXBsZXRlLgogICoJUmV0
dXJucyB0cnVlIGlmIHRoaXMgaXMgdGhlIGxhc3QgdXNlciBvZiB0aGUgcmVxdWVzdC4gIFRoZSAK
QEAgLTEwNTgsNiArMTExMiw4IEBAIGludCBmYXN0Y2FsbCBhaW9fY29tcGxldGUoc3RydWN0IGtp
b2NiICoKIAkgKiB3aGVuIHRoZSBldmVudCBnb3QgY2FuY2VsbGVkLgogCSAqLwogCWlmIChraW9j
YklzQ2FuY2VsbGVkKGlvY2IpKSB7CisJCWlmIChpb2NiLT5raV9saW8pCisJCQlsaW9fY2hlY2so
aW9jYi0+a2lfbGlvKTsKIAkJaWYgKGlvY2ItPmtpX25vdGlmeS5zaWdxKQogCQkJc2lncXVldWVf
ZnJlZShpb2NiLT5raV9ub3RpZnkuc2lncSk7CiAJCWdvdG8gcHV0X3JxOwpAQCAtMTEwMCw2ICsx
MTU2LDE0IEBAIGludCBmYXN0Y2FsbCBhaW9fY29tcGxldGUoc3RydWN0IGtpb2NiICoKIAkJCXNp
Z3F1ZXVlX2ZyZWUoaW9jYi0+a2lfbm90aWZ5LnNpZ3EpOwogCX0KIAorCS8qCisJICogSW4gY2Fz
ZSBvZiBsaXN0aW8sIGluIGFkZGl0aW9uIHRvIHRoZSBvcHRpb25hbCBwZXItaW9jYiBzaWdldmVu
dAorCSAqIG5vdGlmaWNhdGlvbiAoYXMgYWJvdmUpLCB0aGUgbGlzdGlvIGFzIGEgd2hvbGUgY2Fu
IGFsc28gZ2VuZXJhdGUKKwkgKiBhIHNpZ2V2ZW50IG5vdGlmaWNhdGlvbi4KKwkgKi8KKwlpZiAo
aW9jYi0+a2lfbGlvKQorCQlsaW9fY2hlY2soaW9jYi0+a2lfbGlvKTsKKwogCXByX2RlYnVnKCIl
bGQgcmV0cmllczogJXpkIG9mICV6ZFxuIiwgaW9jYi0+a2lfcmV0cmllZCwKIAkJaW9jYi0+a2lf
bmJ5dGVzIC0gaW9jYi0+a2lfbGVmdCwgaW9jYi0+a2lfbmJ5dGVzKTsKIHB1dF9ycToKQEAgLTE2
MzQsNyArMTY5OCw3IEBAIHN0YXRpYyBpbnQgYWlvX3dha2VfZnVuY3Rpb24od2FpdF9xdWV1ZV8K
IH0KIAogaW50IGZhc3RjYWxsIGlvX3N1Ym1pdF9vbmUoc3RydWN0IGtpb2N0eCAqY3R4LCBzdHJ1
Y3QgaW9jYiBfX3VzZXIgKnVzZXJfaW9jYiwKLQkJCSBzdHJ1Y3QgaW9jYiAqaW9jYikKKwkJCSBz
dHJ1Y3QgaW9jYiAqaW9jYiwgc3RydWN0IGxpb19ldmVudCAqbGlvKQogewogCXN0cnVjdCBraW9j
YiAqcmVxOwogCXN0cnVjdCBmaWxlICpmaWxlOwpAQCAtMTY5MCwxMiArMTc1NCwxMyBAQCBpbnQg
ZmFzdGNhbGwgaW9fc3VibWl0X29uZShzdHJ1Y3Qga2lvY3R4CiAKIAlpZiAoaW9jYi0+YWlvX3Np
Z2V2ZW50cCkgewogCQlyZXQgPSBhaW9fc2V0dXBfc2lnZXZlbnQoJnJlcS0+a2lfbm90aWZ5LAot
CQkJCQkgKHN0cnVjdCBzaWdldmVudCBfX3VzZXIgKikodW5zaWduZWQgbG9uZykKLQkJCQkJIGlv
Y2ItPmFpb19zaWdldmVudHApOworCQkJKHN0cnVjdCBzaWdldmVudCBfX3VzZXIgKikodW5zaWdu
ZWQgbG9uZykKKwkJCQkgaW9jYi0+YWlvX3NpZ2V2ZW50cCk7CiAJCWlmIChyZXQpCiAJCQlnb3Rv
IG91dF9wdXRfcmVxOwogCX0KIAorCXJlcS0+a2lfbGlvID0gbGlvOwogCXJldCA9IGFpb19zZXR1
cF9pb2NiKHJlcSk7CiAKIAlpZiAocmV0KQpAQCAtMTcyMyw2ICsxNzg4LDQ4IEBAIG91dF9wdXRf
cmVxOgogCXJldHVybiByZXQ7CiB9CiAKK3N0YXRpYyBpbnQgaW9fc3VibWl0X2dyb3VwKHN0cnVj
dCBraW9jdHggKmN0eCwgbG9uZyBuciwKKwlzdHJ1Y3QgaW9jYiBfX3VzZXIgKiBfX3VzZXIgKmlv
Y2JwcCwgc3RydWN0IGxpb19ldmVudCAqbGlvKQoreworCWludCBpOworCWxvbmcgcmV0ID0gMDsK
KworCS8qCisJICogQUtQTTogc2hvdWxkIHRoaXMgcmV0dXJuIGEgcGFydGlhbCByZXN1bHQgaWYg
c29tZSBvZiB0aGUgSU9zIHdlcmUKKwkgKiBzdWNjZXNzZnVsbHkgc3VibWl0dGVkPworCSAqLwor
CWZvciAoaSA9IDA7IGkgPCBucjsgaSsrKSB7CisJCXN0cnVjdCBpb2NiIF9fdXNlciAqdXNlcl9p
b2NiOworCQlzdHJ1Y3QgaW9jYiB0bXA7CisKKwkJaWYgKHVubGlrZWx5KF9fZ2V0X3VzZXIodXNl
cl9pb2NiLCBpb2NicHAgKyBpKSkpIHsKKwkJCXJldCA9IC1FRkFVTFQ7CisJCQlicmVhazsKKwkJ
fQorCisJCWlmICh1bmxpa2VseShjb3B5X2Zyb21fdXNlcigmdG1wLCB1c2VyX2lvY2IsIHNpemVv
Zih0bXApKSkpIHsKKwkJCXJldCA9IC1FRkFVTFQ7CisJCQlicmVhazsKKwkJfQorCisJCWlmIChs
aW8pCisJCQlhdG9taWNfaW5jKCZsaW8tPmxpb191c2Vycyk7CisKKwkJcmV0ID0gaW9fc3VibWl0
X29uZShjdHgsIHVzZXJfaW9jYiwgJnRtcCwgbGlvKTsKKwkJaWYgKHJldCkgeworCQkJaWYgKGxp
bykgeworCQkJCS8qCisJCQkJICogSW4gY2FzZSBvZiBsaXN0aW8sIGNvbnRpbnVlIHdpdGgKKwkJ
CQkgKiB0aGUgc3Vic2VxdWVudCByZXF1ZXN0cworCQkJCSAqLworCQkJCWF0b21pY19kZWMoJmxp
by0+bGlvX3VzZXJzKTsKKwkJCX0gZWxzZQorCQkJCWJyZWFrOworCQl9CisJfQorCXJldHVybiBp
ID8gaSA6IHJldDsKK30KKwogLyogc3lzX2lvX3N1Ym1pdDoKICAqCVF1ZXVlIHRoZSBuciBpb2Ni
cyBwb2ludGVkIHRvIGJ5IGlvY2JwcCBmb3IgcHJvY2Vzc2luZy4gIFJldHVybnMKICAqCXRoZSBu
dW1iZXIgb2YgaW9jYnMgcXVldWVkLiAgTWF5IHJldHVybiAtRUlOVkFMIGlmIHRoZSBhaW9fY29u
dGV4dApAQCAtMTc0MCw3ICsxODQ3LDYgQEAgYXNtbGlua2FnZSBsb25nIHN5c19pb19zdWJtaXQo
YWlvX2NvbnRleAogewogCXN0cnVjdCBraW9jdHggKmN0eDsKIAlsb25nIHJldCA9IDA7Ci0JaW50
IGk7CiAKIAlpZiAodW5saWtlbHkobnIgPCAwKSkKIAkJcmV0dXJuIC1FSU5WQUw7CkBAIC0xNzU0
LDMxICsxODYwLDYwIEBAIGFzbWxpbmthZ2UgbG9uZyBzeXNfaW9fc3VibWl0KGFpb19jb250ZXgK
IAkJcmV0dXJuIC1FSU5WQUw7CiAJfQogCi0JLyoKLQkgKiBBS1BNOiBzaG91bGQgdGhpcyByZXR1
cm4gYSBwYXJ0aWFsIHJlc3VsdCBpZiBzb21lIG9mIHRoZSBJT3Mgd2VyZQotCSAqIHN1Y2Nlc3Nm
dWxseSBzdWJtaXR0ZWQ/Ci0JICovCi0JZm9yIChpPTA7IGk8bnI7IGkrKykgewotCQlzdHJ1Y3Qg
aW9jYiBfX3VzZXIgKnVzZXJfaW9jYjsKLQkJc3RydWN0IGlvY2IgdG1wOworCXJldCA9IGlvX3N1
Ym1pdF9ncm91cChjdHgsIG5yLCBpb2NicHAsIE5VTEwpOwogCi0JCWlmICh1bmxpa2VseShfX2dl
dF91c2VyKHVzZXJfaW9jYiwgaW9jYnBwICsgaSkpKSB7Ci0JCQlyZXQgPSAtRUZBVUxUOwotCQkJ
YnJlYWs7Ci0JCX0KKwlwdXRfaW9jdHgoY3R4KTsKKwlyZXR1cm4gcmV0OworfQogCi0JCWlmICh1
bmxpa2VseShjb3B5X2Zyb21fdXNlcigmdG1wLCB1c2VyX2lvY2IsIHNpemVvZih0bXApKSkpIHsK
LQkJCXJldCA9IC1FRkFVTFQ7Ci0JCQlicmVhazsKLQkJfQorYXNtbGlua2FnZSBsb25nIHN5c19s
aW9fc3VibWl0KGFpb19jb250ZXh0X3QgY3R4X2lkLCBpbnQgbW9kZSwgbG9uZyBuciwKKwlzdHJ1
Y3QgaW9jYiBfX3VzZXIgKiBfX3VzZXIgKmlvY2JwcCwgc3RydWN0IHNpZ2V2ZW50IF9fdXNlciAq
ZXZlbnQpCit7CisJc3RydWN0IGtpb2N0eCAqY3R4OworCXN0cnVjdCBsaW9fZXZlbnQgKmxpbyA9
IE5VTEw7CisJbG9uZyByZXQgPSAwOwogCi0JCXJldCA9IGlvX3N1Ym1pdF9vbmUoY3R4LCB1c2Vy
X2lvY2IsICZ0bXApOwotCQlpZiAocmV0KQotCQkJYnJlYWs7CisJaWYgKHVubGlrZWx5KG5yIDwg
MCkpCisJCXJldHVybiAtRUlOVkFMOworCisJaWYgKHVubGlrZWx5KCFhY2Nlc3Nfb2soVkVSSUZZ
X1JFQUQsIGlvY2JwcCwgKG5yKnNpemVvZigqaW9jYnBwKSkpKSkKKwkJcmV0dXJuIC1FRkFVTFQ7
CisKKwljdHggPSBsb29rdXBfaW9jdHgoY3R4X2lkKTsKKwlpZiAodW5saWtlbHkoIWN0eCkpIHsK
KwkJcHJfZGVidWcoIkVJTlZBTDogbGlvX3N1Ym1pdDogaW52YWxpZCBjb250ZXh0IGlkXG4iKTsK
KwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJbGlvID0gbGlvX2NyZWF0ZShldmVudCwgbW9kZSk7
CisKKwlyZXQgPSBQVFJfRVJSKGxpbyk7CisJaWYgKElTX0VSUihsaW8pKQorCQlnb3RvIG91dF9w
dXRfY3R4OworCisJcmV0ID0gaW9fc3VibWl0X2dyb3VwKGN0eCwgbnIsIGlvY2JwcCwgbGlvKTsK
KworCS8qIElmIHdlIGZhaWxlZCB0byBzdWJtaXQgZXZlbiBvbmUgcmVxdWVzdCBqdXN0IHJldHVy
biAqLworCWlmIChyZXQgPCAwICkgeworCQlpZiAobGlvKQorCQkJa2ZyZWUobGlvKTsKKwkJZ290
byBvdXRfcHV0X2N0eDsKKwl9CisKKwkvKgorCSAqIERyb3AgZXh0cmEgcmVmIG9uIHRoZSBsaW8g
bm93IHRoYXQgd2UncmUgZG9uZSBzdWJtaXR0aW5nIHJlcXVlc3RzLgorCSAqLworCWlmIChsaW8p
CisJCWxpb19jaGVjayhsaW8pOworCisJaWYgKG1vZGUgPT0gTElPX1dBSVQpIHsKKwkJd2FpdF9l
dmVudChjdHgtPndhaXQsIGF0b21pY19yZWFkKCZsaW8tPmxpb191c2VycykgPT0gMCk7CisJCWtm
cmVlKGxpbyk7CiAJfQogCitvdXRfcHV0X2N0eDoKIAlwdXRfaW9jdHgoY3R4KTsKLQlyZXR1cm4g
aSA/IGkgOiByZXQ7CisJcmV0dXJuIHJldDsKIH0KIAogLyogbG9va3VwX2tpb2NiCmRpZmYgLXB1
TiBpbmNsdWRlL2xpbnV4L2Fpb19hYmkuaH5haW8tbGlzdGlvLXN1cHBvcnQgaW5jbHVkZS9saW51
eC9haW9fYWJpLmgKLS0tIGxpbnV4LTIuNi4xOS1yYzUtbW0yL2luY2x1ZGUvbGludXgvYWlvX2Fi
aS5ofmFpby1saXN0aW8tc3VwcG9ydAkyMDA2LTExLTIzIDIxOjU2OjE0LjAwMDAwMDAwMCArMDUz
MAorKysgbGludXgtMi42LjE5LXJjNS1tbTItYmhhcmF0YS9pbmNsdWRlL2xpbnV4L2Fpb19hYmku
aAkyMDA2LTExLTIzIDIxOjU2OjU1LjAwMDAwMDAwMCArMDUzMApAQCAtNDUsNiArNDUsMTEgQEAg
ZW51bSB7CiAJSU9DQl9DTURfUFdSSVRFViA9IDgsCiB9OwogCitlbnVtIHsKKwlMSU9fV0FJVCA9
IDAsCisJTElPX05PV0FJVCA9IDEsCit9OworCiAvKiByZWFkKCkgZnJvbSAvZGV2L2FpbyByZXR1
cm5zIHRoZXNlIHN0cnVjdHVyZXMuICovCiBzdHJ1Y3QgaW9fZXZlbnQgewogCV9fdTY0CQlkYXRh
OwkJLyogdGhlIGRhdGEgZmllbGQgZnJvbSB0aGUgaW9jYiAqLwpkaWZmIC1wdU4gaW5jbHVkZS9s
aW51eC9haW8uaH5haW8tbGlzdGlvLXN1cHBvcnQgaW5jbHVkZS9saW51eC9haW8uaAotLS0gbGlu
dXgtMi42LjE5LXJjNS1tbTIvaW5jbHVkZS9saW51eC9haW8uaH5haW8tbGlzdGlvLXN1cHBvcnQJ
MjAwNi0xMS0yMyAyMTo1NzoyMy4wMDAwMDAwMDAgKzA1MzAKKysrIGxpbnV4LTIuNi4xOS1yYzUt
bW0yLWJoYXJhdGEvaW5jbHVkZS9saW51eC9haW8uaAkyMDA2LTExLTIzIDIyOjAxOjExLjAwMDAw
MDAwMCArMDUzMApAQCAtNTgsNiArNTgsMTEgQEAgc3RydWN0IGFpb19ub3RpZnkgewogCXN0cnVj
dCBzaWdxdWV1ZQkJKnNpZ3E7CiB9OwogCitzdHJ1Y3QgbGlvX2V2ZW50IHsKKwlhdG9taWNfdAkJ
bGlvX3VzZXJzOworCXN0cnVjdCBhaW9fbm90aWZ5CWxpb19ub3RpZnk7Cit9OworCiAvKiBpcyB0
aGVyZSBhIGJldHRlciBwbGFjZSB0byBkb2N1bWVudCBmdW5jdGlvbiBwb2ludGVyIG1ldGhvZHM/
ICovCiAvKioKICAqIGtpX3JldHJ5CS0JaW9jYiBmb3J3YXJkIHByb2dyZXNzIGNhbGxiYWNrCkBA
IC0xMTIsNyArMTE3LDggQEAgc3RydWN0IGtpb2NiIHsKIAlfX3U2NAkJCWtpX3VzZXJfZGF0YTsJ
LyogdXNlcidzIGRhdGEgZm9yIGNvbXBsZXRpb24gKi8KIAl3YWl0X3F1ZXVlX3QJCWtpX3dhaXQ7
CiAJbG9mZl90CQkJa2lfcG9zOwotCisJLyogbGlvIHRoaXMgaW9jYiBtaWdodCBiZSBhdHRhY2hl
ZCB0byAqLworCXN0cnVjdCBsaW9fZXZlbnQJKmtpX2xpbzsKIAl2b2lkCQkJKnByaXZhdGU7CiAJ
LyogU3RhdGUgdGhhdCB3ZSByZW1lbWJlciB0byBiZSBhYmxlIHRvIHJlc3RhcnQvcmV0cnkgICov
CiAJdW5zaWduZWQgc2hvcnQJCWtpX29wY29kZTsKQEAgLTIyMCwxMiArMjI2LDEzIEBAIHN0cnVj
dCBtbV9zdHJ1Y3Q7CiBleHRlcm4gdm9pZCBGQVNUQ0FMTChleGl0X2FpbyhzdHJ1Y3QgbW1fc3Ry
dWN0ICptbSkpOwogZXh0ZXJuIHN0cnVjdCBraW9jdHggKmxvb2t1cF9pb2N0eCh1bnNpZ25lZCBs
b25nIGN0eF9pZCk7CiBleHRlcm4gaW50IEZBU1RDQUxMKGlvX3N1Ym1pdF9vbmUoc3RydWN0IGtp
b2N0eCAqY3R4LAotCQkJc3RydWN0IGlvY2IgX191c2VyICp1c2VyX2lvY2IsIHN0cnVjdCBpb2Ni
ICppb2NiKSk7CisJCQlzdHJ1Y3QgaW9jYiBfX3VzZXIgKnVzZXJfaW9jYiwgc3RydWN0IGlvY2Ig
KmlvY2IsCisJCQlzdHJ1Y3QgbGlvX2V2ZW50ICpsaW8pKTsKIAogLyogc2VtaSBwcml2YXRlLCBi
dXQgdXNlZCBieSB0aGUgMzJiaXQgZW11bGF0aW9uczogKi8KIHN0cnVjdCBraW9jdHggKmxvb2t1
cF9pb2N0eCh1bnNpZ25lZCBsb25nIGN0eF9pZCk7CiBpbnQgRkFTVENBTEwoaW9fc3VibWl0X29u
ZShzdHJ1Y3Qga2lvY3R4ICpjdHgsIHN0cnVjdCBpb2NiIF9fdXNlciAqdXNlcl9pb2NiLAotCQkJ
CSAgc3RydWN0IGlvY2IgKmlvY2IpKTsKKwkJCQkgIHN0cnVjdCBpb2NiICppb2NiLCBzdHJ1Y3Qg
bGlvX2V2ZW50ICpsaW8pKTsKIAogI2RlZmluZSBnZXRfaW9jdHgoa2lvY3R4KSBkbyB7CQkJCQkJ
XAogCUJVR19PTihhdG9taWNfcmVhZCgmKGtpb2N0eCktPnVzZXJzKSA8PSAwKTsJCQlcCmRpZmYg
LXB1TiBmcy9jb21wYXQuY35haW8tbGlzdGlvLXN1cHBvcnQgZnMvY29tcGF0LmMKLS0tIGxpbnV4
LTIuNi4xOS1yYzUtbW0yL2ZzL2NvbXBhdC5jfmFpby1saXN0aW8tc3VwcG9ydAkyMDA2LTExLTI0
IDA4OjUyOjQyLjAwMDAwMDAwMCArMDUzMAorKysgbGludXgtMi42LjE5LXJjNS1tbTItYmhhcmF0
YS9mcy9jb21wYXQuYwkyMDA2LTExLTI0IDA5OjUzOjU2LjAwMDAwMDAwMCArMDUzMApAQCAtNjc4
LDYgKzY3OCwzNSBAQCBjb21wYXRfc3lzX2lvX3N1Ym1pdChhaW9fY29udGV4dF90IGN0eF9pCiAJ
cmV0dXJuIHJldDsKIH0KIAorYXNtbGlua2FnZSBsb25nCitjb21wYXRfc3lzX2xpb19zdWJtaXQo
YWlvX2NvbnRleHRfdCBjdHhfaWQsIGludCBtb2RlLCBpbnQgbnIsIHUzMiBfX3VzZXIgKmlvY2Is
CisJCXN0cnVjdCBjb21wYXRfc2lnZXZlbnQgX191c2VyICpzaWdfdXNlcikKK3sKKwlzdHJ1Y3Qg
aW9jYiBfX3VzZXIgKiBfX3VzZXIgKmlvY2I2NDsKKwlzdHJ1Y3Qgc2lndmVudCBfX3VzZXIgKmV2
ZW50ID0gTlVMTDsKKwlsb25nIHJldDsKKworCWlmICh1bmxpa2VseShuciA8IDApKQorCQlyZXR1
cm4gLUVJTlZBTDsKKworCWlmIChuciA+IE1BWF9BSU9fU1VCTUlUUykKKwkJbnIgPSBNQVhfQUlP
X1NVQk1JVFM7CisKKwlpb2NiNjQgPSBjb21wYXRfYWxsb2NfdXNlcl9zcGFjZShuciAqIHNpemVv
ZigqaW9jYjY0KSk7CisJcmV0ID0gY29weV9pb2NiKG5yLCBpb2NiLCBpb2NiNjQpOworCWlmIChy
ZXQpCisJCXJldHVybiByZXQ7CisKKwlpZiAoc2lnX3VzZXIpIHsKKwkJc3RydWN0IHNpZ2V2ZW50
IGtldmVudDsKKwkJZXZlbnQgPSBjb21wYXRfYWxsb2NfdXNlcl9zcGFjZShzaXplb2Yoc3RydWN0
IHNpZ2V2ZW50KSk7CisJCWlmIChnZXRfY29tcGF0X3NpZ2V2ZW50KCZrZXZlbnQsIHNpZ191c2Vy
KSB8fAorCQkJY29weV90b191c2VyKGV2ZW50LCAma2V2ZW50LCBzaXplb2Yoc3RydWN0IHNpZ2V2
ZW50KSkpCisJCQlyZXR1cm4gLUVGQVVMVDsKKwl9CisJcmV0dXJuIHN5c19saW9fc3VibWl0KGN0
eF9pZCwgbW9kZSwgbnIsIGlvY2I2NCwgZXZlbnQpOworfQorCiBzdHJ1Y3QgY29tcGF0X25jcF9t
b3VudF9kYXRhIHsKIAljb21wYXRfaW50X3QgdmVyc2lvbjsKIAljb21wYXRfdWludF90IG5jcF9m
ZDsKZGlmZiAtcHVOIGluY2x1ZGUvbGludXgvc3lzY2FsbHMuaH5haW8tbGlzdGlvLXN1cHBvcnQg
aW5jbHVkZS9saW51eC9zeXNjYWxscy5oCi0tLSBsaW51eC0yLjYuMTktcmM1LW1tMi9pbmNsdWRl
L2xpbnV4L3N5c2NhbGxzLmh+YWlvLWxpc3Rpby1zdXBwb3J0CTIwMDYtMTEtMjQgMDk6NDI6NDQu
MDAwMDAwMDAwICswNTMwCisrKyBsaW51eC0yLjYuMTktcmM1LW1tMi1iaGFyYXRhL2luY2x1ZGUv
bGludXgvc3lzY2FsbHMuaAkyMDA2LTExLTI0IDA5OjQzOjQyLjAwMDAwMDAwMCArMDUzMApAQCAt
MzE5LDYgKzMxOSw4IEBAIGFzbWxpbmthZ2UgbG9uZyBzeXNfaW9fZ2V0ZXZlbnRzKGFpb19jb24K
IAkJCQlzdHJ1Y3QgdGltZXNwZWMgX191c2VyICp0aW1lb3V0KTsKIGFzbWxpbmthZ2UgbG9uZyBz
eXNfaW9fc3VibWl0KGFpb19jb250ZXh0X3QsIGxvbmcsCiAJCQkJc3RydWN0IGlvY2IgX191c2Vy
ICogX191c2VyICopOworYXNtbGlua2FnZSBsb25nIHN5c19saW9fc3VibWl0KGFpb19jb250ZXh0
X3QsIGludCwgbG9uZywKKwkJc3RydWN0IGlvY2IgX191c2VyICogX191c2VyICosIHN0cnVjdCBz
aWdldmVudCBfX3VzZXIgKik7CiBhc21saW5rYWdlIGxvbmcgc3lzX2lvX2NhbmNlbChhaW9fY29u
dGV4dF90IGN0eF9pZCwgc3RydWN0IGlvY2IgX191c2VyICppb2NiLAogCQkJICAgICAgc3RydWN0
IGlvX2V2ZW50IF9fdXNlciAqcmVzdWx0KTsKIGFzbWxpbmthZ2Ugc3NpemVfdCBzeXNfc2VuZGZp
bGUoaW50IG91dF9mZCwgaW50IGluX2ZkLApfCg==
------=_Part_77092_19065165.1164634769333--
