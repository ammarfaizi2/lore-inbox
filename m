Return-Path: <linux-kernel-owner+willy=40w.ods.org-S266199AbUIALtE@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S266199AbUIALtE (ORCPT <rfc822;willy@w.ods.org>);
	Wed, 1 Sep 2004 07:49:04 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S266221AbUIALs3
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Wed, 1 Sep 2004 07:48:29 -0400
Received: from f7.mail.ru ([194.67.57.37]:4367 "EHLO f7.mail.ru")
	by vger.kernel.org with ESMTP id S266199AbUIALqJ (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Wed, 1 Sep 2004 07:46:09 -0400
From: Kirill Korotaev <kksx@mail.ru>
To: akpm@osdl.org, torvalds@osdl.org
Cc: linux-kernel@vger.kernel.org
Subject: [PATCH] obscure pid implementation fix (v2)
Mime-Version: 1.0
X-Mailer: mPOP Web-Mail 2.19
X-Originating-IP: 192.168.0.129 via proxy [195.133.213.201]
Date: Wed, 01 Sep 2004 15:46:07 +0400
Reply-To: Kirill Korotaev <kksx@mail.ru>
Content-Type: multipart/mixed;
	boundary="----6ch90RMi-im0oRHt2F11XYxd8:1094039167"
Message-Id: <E1C2TZ1-000JZr-00.kksx-mail-ru@f7.mail.ru>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


------6ch90RMi-im0oRHt2F11XYxd8:1094039167
Content-Type: text/plain; charset=koi8-r
Content-Transfer-Encoding: 8bit

I remade the previous patch against the latest Linus tree, please apply.

This patch fixes strange and obscure pid implementation in current kernels:
- it removes calling of put_task_struct() from detach_pid()
  under tasklist_lock. This allows to use blocking calls
  in security_task_free() hooks (in __put_task_struct()).
- it saves some space = 5*5 ints = 100 bytes in task_struct
- it's smaller and tidy, more straigthforward and doesn't use
  any knowledge about pids using and assignment.
- it removes pid_links and pid_struct doesn't hold reference counters
  on task_struct. instead, new pid_structs and linked altogether and
  only one of them is inserted in hash_list.

Signed-off-by: Kirill Korotaev (kksx@mail.ru)

Kirill


------6ch90RMi-im0oRHt2F11XYxd8:1094039167
Content-Type: application/octet-stream; name="diff-pid-2.6.9rc1"
Content-Disposition: attachment; filename="diff-pid-2.6.9rc1"
Content-Transfer-Encoding: base64

LS0tIHRlc3QvZHJpdmVycy9jaGFyL3R0eV9pby5jLnBpZAkyMDA0LTA5LTAxIDE0OjMyOjI2LjAw
MDAwMDAwMCArMDQwMAorKysgdGVzdC9kcml2ZXJzL2NoYXIvdHR5X2lvLmMJMjAwNC0wOS0wMSAx
NDozNDo0Ny4wMDAwMDAwMDAgKzA0MDAKQEAgLTQyNCw3ICs0MjQsNiBAQCB2b2lkIGRvX3R0eV9o
YW5ndXAodm9pZCAqZGF0YSkKIAlzdHJ1Y3QgZmlsZSAqIGNvbnNfZmlscCA9IE5VTEw7CiAJc3Ry
dWN0IGZpbGUgKmZpbHAsICpmID0gTlVMTDsKIAlzdHJ1Y3QgdGFza19zdHJ1Y3QgKnA7Ci0Jc3Ry
dWN0IHBpZCAqcGlkOwogCWludCAgICBjbG9zZWNvdW50ID0gMCwgbjsKIAogCWlmICghdHR5KQpA
QCAtNDk1LDggKzQ5NCw3IEBAIHZvaWQgZG9fdHR5X2hhbmd1cCh2b2lkICpkYXRhKQogCQogCXJl
YWRfbG9jaygmdGFza2xpc3RfbG9jayk7CiAJaWYgKHR0eS0+c2Vzc2lvbiA+IDApIHsKLQkJc3Ry
dWN0IGxpc3RfaGVhZCAqbDsKLQkJZm9yX2VhY2hfdGFza19waWQodHR5LT5zZXNzaW9uLCBQSURU
WVBFX1NJRCwgcCwgbCwgcGlkKSB7CisJCWRvX2VhY2hfdGFza19waWQodHR5LT5zZXNzaW9uLCBQ
SURUWVBFX1NJRCwgcCkgewogCQkJaWYgKHAtPnNpZ25hbC0+dHR5ID09IHR0eSkKIAkJCQlwLT5z
aWduYWwtPnR0eSA9IE5VTEw7CiAJCQlpZiAoIXAtPnNpZ25hbC0+bGVhZGVyKQpAQCAtNTA1LDcg
KzUwMyw3IEBAIHZvaWQgZG9fdHR5X2hhbmd1cCh2b2lkICpkYXRhKQogCQkJc2VuZF9ncm91cF9z
aWdfaW5mbyhTSUdDT05ULCBTRU5EX1NJR19QUklWLCBwKTsKIAkJCWlmICh0dHktPnBncnAgPiAw
KQogCQkJCXAtPnNpZ25hbC0+dHR5X29sZF9wZ3JwID0gdHR5LT5wZ3JwOwotCQl9CisJCX0gd2hp
bGVfZWFjaF90YXNrX3BpZCh0dHktPnNlc3Npb24sIFBJRFRZUEVfU0lELCBwKTsKIAl9CiAJcmVh
ZF91bmxvY2soJnRhc2tsaXN0X2xvY2spOwogCkBAIC01NzcsOCArNTc1LDYgQEAgdm9pZCBkaXNh
c3NvY2lhdGVfY3R0eShpbnQgb25fZXhpdCkKIHsKIAlzdHJ1Y3QgdHR5X3N0cnVjdCAqdHR5Owog
CXN0cnVjdCB0YXNrX3N0cnVjdCAqcDsKLQlzdHJ1Y3QgbGlzdF9oZWFkICpsOwotCXN0cnVjdCBw
aWQgKnBpZDsKIAlpbnQgdHR5X3BncnAgPSAtMTsKIAogCWxvY2tfa2VybmVsKCk7CkBAIC02MDcs
OCArNjAzLDkgQEAgdm9pZCBkaXNhc3NvY2lhdGVfY3R0eShpbnQgb25fZXhpdCkKIAl0dHktPnBn
cnAgPSAtMTsKIAogCXJlYWRfbG9jaygmdGFza2xpc3RfbG9jayk7Ci0JZm9yX2VhY2hfdGFza19w
aWQoY3VycmVudC0+c2lnbmFsLT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCwgbCwgcGlkKQorCWRv
X2VhY2hfdGFza19waWQoY3VycmVudC0+c2lnbmFsLT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCkg
ewogCQlwLT5zaWduYWwtPnR0eSA9IE5VTEw7CisJfSB3aGlsZV9lYWNoX3Rhc2tfcGlkKGN1cnJl
bnQtPnNpZ25hbC0+c2Vzc2lvbiwgUElEVFlQRV9TSUQsIHApOwogCXJlYWRfdW5sb2NrKCZ0YXNr
bGlzdF9sb2NrKTsKIAl1bmxvY2tfa2VybmVsKCk7CiB9CkBAIC0xMjYwLDE1ICsxMjU3LDE1IEBA
IHN0YXRpYyB2b2lkIHJlbGVhc2VfZGV2KHN0cnVjdCBmaWxlICogZmkKIAkgKi8KIAlpZiAodHR5
X2Nsb3NpbmcgfHwgb190dHlfY2xvc2luZykgewogCQlzdHJ1Y3QgdGFza19zdHJ1Y3QgKnA7Ci0J
CXN0cnVjdCBsaXN0X2hlYWQgKmw7Ci0JCXN0cnVjdCBwaWQgKnBpZDsKIAogCQlyZWFkX2xvY2so
JnRhc2tsaXN0X2xvY2spOwotCQlmb3JfZWFjaF90YXNrX3BpZCh0dHktPnNlc3Npb24sIFBJRFRZ
UEVfU0lELCBwLCBsLCBwaWQpCisJCWRvX2VhY2hfdGFza19waWQodHR5LT5zZXNzaW9uLCBQSURU
WVBFX1NJRCwgcCkgewogCQkJcC0+c2lnbmFsLT50dHkgPSBOVUxMOworCQl9IHdoaWxlX2VhY2hf
dGFza19waWQodHR5LT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCk7CiAJCWlmIChvX3R0eSkKLQkJ
CWZvcl9lYWNoX3Rhc2tfcGlkKG9fdHR5LT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCxsLCBwaWQp
CisJCQlkb19lYWNoX3Rhc2tfcGlkKG9fdHR5LT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCkgewog
CQkJCXAtPnNpZ25hbC0+dHR5ID0gTlVMTDsKKwkJCX0gd2hpbGVfZWFjaF90YXNrX3BpZChvX3R0
eS0+c2Vzc2lvbiwgUElEVFlQRV9TSUQsIHApOwogCQlyZWFkX3VubG9jaygmdGFza2xpc3RfbG9j
ayk7CiAJfQogCkBAIC0xNjM4LDggKzE2MzUsNiBAQCBzdGF0aWMgaW50IGZpb25iaW8oc3RydWN0
IGZpbGUgKmZpbGUsIGluCiAKIHN0YXRpYyBpbnQgdGlvY3NjdHR5KHN0cnVjdCB0dHlfc3RydWN0
ICp0dHksIGludCBhcmcpCiB7Ci0Jc3RydWN0IGxpc3RfaGVhZCAqbDsKLQlzdHJ1Y3QgcGlkICpw
aWQ7CiAJdGFza190ICpwOwogCiAJaWYgKGN1cnJlbnQtPnNpZ25hbC0+bGVhZGVyICYmCkBAIC0x
NjYyLDggKzE2NTcsOSBAQCBzdGF0aWMgaW50IHRpb2NzY3R0eShzdHJ1Y3QgdHR5X3N0cnVjdCAq
CiAJCQkgKi8KIAogCQkJcmVhZF9sb2NrKCZ0YXNrbGlzdF9sb2NrKTsKLQkJCWZvcl9lYWNoX3Rh
c2tfcGlkKHR0eS0+c2Vzc2lvbiwgUElEVFlQRV9TSUQsIHAsIGwsIHBpZCkKKwkJCWRvX2VhY2hf
dGFza19waWQodHR5LT5zZXNzaW9uLCBQSURUWVBFX1NJRCwgcCkgewogCQkJCXAtPnNpZ25hbC0+
dHR5ID0gTlVMTDsKKwkJCX0gd2hpbGVfZWFjaF90YXNrX3BpZCh0dHktPnNlc3Npb24sIFBJRFRZ
UEVfU0lELCBwKTsKIAkJCXJlYWRfdW5sb2NrKCZ0YXNrbGlzdF9sb2NrKTsKIAkJfSBlbHNlCiAJ
CQlyZXR1cm4gLUVQRVJNOwpAQCAtMTk3MCw4ICsxOTY2LDYgQEAgc3RhdGljIHZvaWQgX19kb19T
QUsodm9pZCAqYXJnKQogI2Vsc2UKIAlzdHJ1Y3QgdHR5X3N0cnVjdCAqdHR5ID0gYXJnOwogCXN0
cnVjdCB0YXNrX3N0cnVjdCAqcDsKLQlzdHJ1Y3QgbGlzdF9oZWFkICpsOwotCXN0cnVjdCBwaWQg
KnBpZDsKIAlpbnQgc2Vzc2lvbjsKIAlpbnQJCWk7CiAJc3RydWN0IGZpbGUJKmZpbHA7CkBAIC0x
OTg0LDcgKzE5NzgsNyBAQCBzdGF0aWMgdm9pZCBfX2RvX1NBSyh2b2lkICphcmcpCiAJaWYgKHR0
eS0+ZHJpdmVyLT5mbHVzaF9idWZmZXIpCiAJCXR0eS0+ZHJpdmVyLT5mbHVzaF9idWZmZXIodHR5
KTsKIAlyZWFkX2xvY2soJnRhc2tsaXN0X2xvY2spOwotCWZvcl9lYWNoX3Rhc2tfcGlkKHNlc3Np
b24sIFBJRFRZUEVfU0lELCBwLCBsLCBwaWQpIHsKKwlkb19lYWNoX3Rhc2tfcGlkKHNlc3Npb24s
IFBJRFRZUEVfU0lELCBwKSB7CiAJCWlmIChwLT5zaWduYWwtPnR0eSA9PSB0dHkgfHwgc2Vzc2lv
biA+IDApIHsKIAkJCXByaW50ayhLRVJOX05PVElDRSAiU0FLOiBraWxsZWQgcHJvY2VzcyAlZCIK
IAkJCSAgICAiICglcyk6IHAtPnNpZ25hbC0+c2Vzc2lvbj09dHR5LT5zZXNzaW9uXG4iLApAQCAt
MjAxMSw3ICsyMDA1LDcgQEAgc3RhdGljIHZvaWQgX19kb19TQUsodm9pZCAqYXJnKQogCQkJc3Bp
bl91bmxvY2soJnAtPmZpbGVzLT5maWxlX2xvY2spOwogCQl9CiAJCXRhc2tfdW5sb2NrKHApOwot
CX0KKwl9IHdoaWxlX2VhY2hfdGFza19waWQoc2Vzc2lvbiwgUElEVFlQRV9TSUQsIHApOwogCXJl
YWRfdW5sb2NrKCZ0YXNrbGlzdF9sb2NrKTsKICNlbmRpZgogfQotLS0gdGVzdC9mcy9wcm9jL2Jh
c2UuYy5waWQJMjAwNC0wOS0wMSAxNDozMjo1NC4wMDAwMDAwMDAgKzA0MDAKKysrIHRlc3QvZnMv
cHJvYy9iYXNlLmMJMjAwNC0wOS0wMSAxNDozNDo0Ny4wMDAwMDAwMDAgKzA0MDAKQEAgLTc3OCwx
MCArNzc4LDkgQEAgc3RhdGljIHN0cnVjdCBpbm9kZV9vcGVyYXRpb25zIHByb2NfcGlkXwogCS5m
b2xsb3dfbGluawk9IHByb2NfcGlkX2ZvbGxvd19saW5rCiB9OwogCi1zdGF0aWMgaW50IHBpZF9h
bGl2ZShzdHJ1Y3QgdGFza19zdHJ1Y3QgKnApCitzdGF0aWMgaW5saW5lIGludCBwaWRfYWxpdmUo
c3RydWN0IHRhc2tfc3RydWN0ICpwKQogewotCUJVR19PTihwLT5waWRzW1BJRFRZUEVfUElEXS5w
aWRwdHIgIT0gJnAtPnBpZHNbUElEVFlQRV9QSURdLnBpZCk7Ci0JcmV0dXJuIGF0b21pY19yZWFk
KCZwLT5waWRzW1BJRFRZUEVfUElEXS5waWQuY291bnQpOworCXJldHVybiBwLT5waWRzW1BJRFRZ
UEVfUElEXS5uciAhPSAwOwogfQogCiAjZGVmaW5lIE5VTUJVRiAxMAotLS0gdGVzdC9mcy9mY250
bC5jLnBpZAkyMDA0LTA5LTAxIDE0OjMyOjUwLjAwMDAwMDAwMCArMDQwMAorKysgdGVzdC9mcy9m
Y250bC5jCTIwMDQtMDktMDEgMTQ6MzQ6NDcuMDAwMDAwMDAwICswNDAwCkBAIC00OTcsMTEgKzQ5
Nyw5IEBAIHZvaWQgc2VuZF9zaWdpbyhzdHJ1Y3QgZm93bl9zdHJ1Y3QgKmZvd24KIAkJCXNlbmRf
c2lnaW9fdG9fdGFzayhwLCBmb3duLCBmZCwgYmFuZCk7CiAJCX0KIAl9IGVsc2UgewotCQlzdHJ1
Y3QgbGlzdF9oZWFkICpsOwotCQlzdHJ1Y3QgcGlkICpwaWRwdHI7Ci0JCWZvcl9lYWNoX3Rhc2tf
cGlkKC1waWQsIFBJRFRZUEVfUEdJRCwgcCwgbCwgcGlkcHRyKSB7CisJCWRvX2VhY2hfdGFza19w
aWQoLXBpZCwgUElEVFlQRV9QR0lELCBwKSB7CiAJCQlzZW5kX3NpZ2lvX3RvX3Rhc2socCwgZm93
biwgZmQsIGJhbmQpOwotCQl9CisJCX0gd2hpbGVfZWFjaF90YXNrX3BpZCgtcGlkLCBQSURUWVBF
X1BHSUQsIHApOwogCX0KIAlyZWFkX3VubG9jaygmdGFza2xpc3RfbG9jayk7CiAgb3V0X3VubG9j
a19mb3duOgpAQCAtNTM0LDExICs1MzIsOSBAQCBpbnQgc2VuZF9zaWd1cmcoc3RydWN0IGZvd25f
c3RydWN0ICpmb3duCiAJCQlzZW5kX3NpZ3VyZ190b190YXNrKHAsIGZvd24pOwogCQl9CiAJfSBl
bHNlIHsKLQkJc3RydWN0IGxpc3RfaGVhZCAqbDsKLQkJc3RydWN0IHBpZCAqcGlkcHRyOwotCQlm
b3JfZWFjaF90YXNrX3BpZCgtcGlkLCBQSURUWVBFX1BHSUQsIHAsIGwsIHBpZHB0cikgeworCQlk
b19lYWNoX3Rhc2tfcGlkKC1waWQsIFBJRFRZUEVfUEdJRCwgcCkgewogCQkJc2VuZF9zaWd1cmdf
dG9fdGFzayhwLCBmb3duKTsKLQkJfQorCQl9IHdoaWxlX2VhY2hfdGFza19waWQoLXBpZCwgUElE
VFlQRV9QR0lELCBwKTsKIAl9CiAJcmVhZF91bmxvY2soJnRhc2tsaXN0X2xvY2spOwogIG91dF91
bmxvY2tfZm93bjoKLS0tIHRlc3QvaW5jbHVkZS9saW51eC9waWQuaC5waWQJMjAwNC0wOS0wMSAx
NDozMzoxNy4wMDAwMDAwMDAgKzA0MDAKKysrIHRlc3QvaW5jbHVkZS9saW51eC9waWQuaAkyMDA0
LTA5LTAxIDE1OjQ5OjEzLjAzNjY4ODgwOCArMDQwMApAQCAtMTAsNTYgKzEwLDQ2IEBAIGVudW0g
cGlkX3R5cGUKIAlQSURUWVBFX01BWAogfTsKIAotc3RydWN0IHBpZAorc3RydWN0IHBpZF9zdHJ1
Y3QKIHsKLQkvKiBUcnkgdG8ga2VlcCBoYXNoX2NoYWluIGluIHRoZSBzYW1lIGNhY2hlbGluZSBh
cyBuciBmb3IgZmluZF9waWQgKi8KLQlzdHJ1Y3QgaGxpc3Rfbm9kZSBoYXNoX2NoYWluOworCS8q
IFRyeSB0byBrZWVwIGhhc2hfbGlzdCBpbiB0aGUgc2FtZSBjYWNoZWxpbmUgYXMgbnIgZm9yIGZp
bmRfcGlkICovCiAJaW50IG5yOwotCWF0b21pY190IGNvdW50OwotCXN0cnVjdCB0YXNrX3N0cnVj
dCAqdGFzazsKLQlzdHJ1Y3QgbGlzdF9oZWFkIHRhc2tfbGlzdDsKLX07Ci0KLXN0cnVjdCBwaWRf
bGluawotewotCXN0cnVjdCBsaXN0X2hlYWQgcGlkX2NoYWluOwotCXN0cnVjdCBwaWQgKnBpZHB0
cjsKLQlzdHJ1Y3QgcGlkIHBpZDsKKwlzdHJ1Y3QgaGxpc3Rfbm9kZSBoYXNoX2xpc3Q7CisJLyog
bGlzdCBvZiBwaWRzIHdpdGggdGhlIHNhbWUgbnIsIG9ubHkgb25lIG9mIHRoZW0gaXMgaW4gdGhl
IGhhc2ggKi8KKwlzdHJ1Y3QgbGlzdF9oZWFkIHBpZF9saXN0OwogfTsKIAogI2RlZmluZSBwaWRf
dGFzayhlbGVtLCB0eXBlKSBcCi0JbGlzdF9lbnRyeShlbGVtLCBzdHJ1Y3QgdGFza19zdHJ1Y3Qs
IHBpZHNbdHlwZV0ucGlkX2NoYWluKQorCWxpc3RfZW50cnkoZWxlbSwgc3RydWN0IHRhc2tfc3Ry
dWN0LCBwaWRzW3R5cGVdLnBpZF9saXN0KQogCiAvKgotICogYXR0YWNoX3BpZCgpIGFuZCBsaW5r
X3BpZCgpIG11c3QgYmUgY2FsbGVkIHdpdGggdGhlIHRhc2tsaXN0X2xvY2sKKyAqIGF0dGFjaF9w
aWQoKSBhbmQgZGV0YWNoX3BpZCgpIG11c3QgYmUgY2FsbGVkIHdpdGggdGhlIHRhc2tsaXN0X2xv
Y2sKICAqIHdyaXRlLWhlbGQuCiAgKi8KIGV4dGVybiBpbnQgRkFTVENBTEwoYXR0YWNoX3BpZChz
dHJ1Y3QgdGFza19zdHJ1Y3QgKnRhc2ssIGVudW0gcGlkX3R5cGUgdHlwZSwgaW50IG5yKSk7CiAK
LWV4dGVybiB2b2lkIEZBU1RDQUxMKGxpbmtfcGlkKHN0cnVjdCB0YXNrX3N0cnVjdCAqdGFzaywg
c3RydWN0IHBpZF9saW5rICpsaW5rLCBzdHJ1Y3QgcGlkICpwaWQpKTsKLQotLyoKLSAqIGRldGFj
aF9waWQoKSBtdXN0IGJlIGNhbGxlZCB3aXRoIHRoZSB0YXNrbGlzdF9sb2NrIHdyaXRlLWhlbGQu
Ci0gKi8KIGV4dGVybiB2b2lkIEZBU1RDQUxMKGRldGFjaF9waWQoc3RydWN0IHRhc2tfc3RydWN0
ICp0YXNrLCBlbnVtIHBpZF90eXBlKSk7CiAKIC8qCiAgKiBsb29rIHVwIGEgUElEIGluIHRoZSBo
YXNoIHRhYmxlLiBNdXN0IGJlIGNhbGxlZCB3aXRoIHRoZSB0YXNrbGlzdF9sb2NrCiAgKiBoZWxk
LgogICovCi1leHRlcm4gc3RydWN0IHBpZCAqRkFTVENBTEwoZmluZF9waWQoZW51bSBwaWRfdHlw
ZSwgaW50KSk7CitleHRlcm4gc3RydWN0IHBpZF9zdHJ1Y3QgKkZBU1RDQUxMKGZpbmRfcGlkKGVu
dW0gcGlkX3R5cGUsIGludCkpOwogCiBleHRlcm4gaW50IGFsbG9jX3BpZG1hcCh2b2lkKTsKIGV4
dGVybiB2b2lkIEZBU1RDQUxMKGZyZWVfcGlkbWFwKGludCkpOwogZXh0ZXJuIHZvaWQgc3dpdGNo
X2V4ZWNfcGlkcyhzdHJ1Y3QgdGFza19zdHJ1Y3QgKmxlYWRlciwgc3RydWN0IHRhc2tfc3RydWN0
ICp0aHJlYWQpOwogCi0jZGVmaW5lIGZvcl9lYWNoX3Rhc2tfcGlkKHdobywgdHlwZSwgdGFzaywg
ZWxlbSwgcGlkKQkJXAotCWlmICgocGlkID0gZmluZF9waWQodHlwZSwgd2hvKSkpCQkJXAotCSAg
ICAgICAgZm9yIChlbGVtID0gcGlkLT50YXNrX2xpc3QubmV4dCwJCQlcCi0JCQlwcmVmZXRjaChl
bGVtLT5uZXh0KSwJCQkJXAotCQkJdGFzayA9IHBpZF90YXNrKGVsZW0sIHR5cGUpOwkJCVwKLQkJ
CWVsZW0gIT0gJnBpZC0+dGFza19saXN0OwkJCVwKLQkJCWVsZW0gPSBlbGVtLT5uZXh0LCBwcmVm
ZXRjaChlbGVtLT5uZXh0KSwgCVwKLQkJCXRhc2sgPSBwaWRfdGFzayhlbGVtLCB0eXBlKSkKKyNk
ZWZpbmUgZG9fZWFjaF90YXNrX3BpZCh3aG8sIHR5cGUsIHRhc2spCQkJCVwKKwlpZiAoKHRhc2sg
PSBmaW5kX3Rhc2tfYnlfcGlkX3R5cGUodHlwZSwgd2hvKSkpIHsJCVwKKwkJcHJlZmV0Y2godGFz
ay0+cGlkc1t0eXBlXS5waWRfbGlzdC5uZXh0KTsJCVwKKwkJZG8geworCisjZGVmaW5lIHdoaWxl
X2VhY2hfdGFza19waWQod2hvLCB0eXBlLCB0YXNrKQkJCQlcCisJCQl0YXNrID0gcGlkX3Rhc2so
dGFzay0+cGlkc1t0eXBlXS5waWRfbGlzdC5uZXh0LAlcCisJCQkJCQl0eXBlKTsJCQlcCisJCQlw
cmVmZXRjaCh0YXNrLT5waWRzW3R5cGVdLnBpZF9saXN0Lm5leHQpOwlcCisJCX0gd2hpbGUgKGxp
c3RfZW1wdHkoJnRhc2stPnBpZHNbdHlwZV0uaGFzaF9saXN0KSk7CVwKKwl9CiAKICNlbmRpZiAv
KiBfTElOVVhfUElEX0ggKi8KLS0tIHRlc3QvaW5jbHVkZS9saW51eC9zY2hlZC5oLnBpZAkyMDA0
LTA5LTAxIDE0OjMzOjE3LjAwMDAwMDAwMCArMDQwMAorKysgdGVzdC9pbmNsdWRlL2xpbnV4L3Nj
aGVkLmgJMjAwNC0wOS0wMSAxNDozNDo0Ni45OTM2MzA1NTIgKzA0MDAKQEAgLTQ5NCw3ICs0OTQs
NyBAQCBzdHJ1Y3QgdGFza19zdHJ1Y3QgewogCXN0cnVjdCB0YXNrX3N0cnVjdCAqZ3JvdXBfbGVh
ZGVyOwkvKiB0aHJlYWRncm91cCBsZWFkZXIgKi8KIAogCS8qIFBJRC9QSUQgaGFzaCB0YWJsZSBs
aW5rYWdlLiAqLwotCXN0cnVjdCBwaWRfbGluayBwaWRzW1BJRFRZUEVfTUFYXTsKKwlzdHJ1Y3Qg
cGlkX3N0cnVjdCBwaWRzW1BJRFRZUEVfTUFYXTsKIAogCXdhaXRfcXVldWVfaGVhZF90IHdhaXRf
Y2hsZGV4aXQ7CS8qIGZvciB3YWl0NCgpICovCiAJc3RydWN0IGNvbXBsZXRpb24gKnZmb3JrX2Rv
bmU7CQkvKiBmb3IgdmZvcmsoKSAqLwpAQCAtNjczLDcgKzY3Myw4IEBAIGV4dGVybiBzdHJ1Y3Qg
dGFza19zdHJ1Y3QgaW5pdF90YXNrOwogCiBleHRlcm4gc3RydWN0ICAgbW1fc3RydWN0IGluaXRf
bW07CiAKLWV4dGVybiBzdHJ1Y3QgdGFza19zdHJ1Y3QgKmZpbmRfdGFza19ieV9waWQoaW50IHBp
ZCk7CisjZGVmaW5lIGZpbmRfdGFza19ieV9waWQobnIpCWZpbmRfdGFza19ieV9waWRfdHlwZShQ
SURUWVBFX1BJRCwgbnIpCitleHRlcm4gc3RydWN0IHRhc2tfc3RydWN0ICpmaW5kX3Rhc2tfYnlf
cGlkX3R5cGUoaW50IHR5cGUsIGludCBwaWQpOwogZXh0ZXJuIHZvaWQgc2V0X3NwZWNpYWxfcGlk
cyhwaWRfdCBzZXNzaW9uLCBwaWRfdCBwZ3JwKTsKIGV4dGVybiB2b2lkIF9fc2V0X3NwZWNpYWxf
cGlkcyhwaWRfdCBzZXNzaW9uLCBwaWRfdCBwZ3JwKTsKIApAQCAtODc2LDkgKzg3Nyw3IEBAIGV4
dGVybiB0YXNrX3QgKiBGQVNUQ0FMTChuZXh0X3RocmVhZChjb24KIAogc3RhdGljIGlubGluZSBp
bnQgdGhyZWFkX2dyb3VwX2VtcHR5KHRhc2tfdCAqcCkKIHsKLQlzdHJ1Y3QgcGlkICpwaWQgPSBw
LT5waWRzW1BJRFRZUEVfVEdJRF0ucGlkcHRyOwotCi0JcmV0dXJuIHBpZC0+dGFza19saXN0Lm5l
eHQtPm5leHQgPT0gJnBpZC0+dGFza19saXN0OworCXJldHVybiBsaXN0X2VtcHR5KCZwLT5waWRz
W1BJRFRZUEVfVEdJRF0ucGlkX2xpc3QpOwogfQogCiAjZGVmaW5lIGRlbGF5X2dyb3VwX2xlYWRl
cihwKSBcCi0tLSB0ZXN0L2tlcm5lbC9waWQuYy5waWQJMjAwNC0wOS0wMSAxNDozMzoyMS4wMDAw
MDAwMDAgKzA0MDAKKysrIHRlc3Qva2VybmVsL3BpZC5jCTIwMDQtMDktMDEgMTU6Mzg6MzAuOTc3
Mjk2NjcyICswNDAwCkBAIC0xNDYsNzAgKzE0Niw2MSBAQCBmYWlsdXJlOgogCXJldHVybiAtMTsK
IH0KIAotZmFzdGNhbGwgc3RydWN0IHBpZCAqZmluZF9waWQoZW51bSBwaWRfdHlwZSB0eXBlLCBp
bnQgbnIpCitmYXN0Y2FsbCBzdHJ1Y3QgcGlkX3N0cnVjdCAqZmluZF9waWQoZW51bSBwaWRfdHlw
ZSB0eXBlLCBpbnQgbnIpCiB7CiAJc3RydWN0IGhsaXN0X25vZGUgKmVsZW07Ci0Jc3RydWN0IHBp
ZCAqcGlkOworCXN0cnVjdCBwaWRfc3RydWN0ICpwaWQ7CiAKIAlobGlzdF9mb3JfZWFjaF9lbnRy
eShwaWQsIGVsZW0sCi0JCQkmcGlkX2hhc2hbdHlwZV1bcGlkX2hhc2hmbihucildLCBoYXNoX2No
YWluKSB7CisJCQkmcGlkX2hhc2hbdHlwZV1bcGlkX2hhc2hmbihucildLCBoYXNoX2xpc3QpIHsK
IAkJaWYgKHBpZC0+bnIgPT0gbnIpCiAJCQlyZXR1cm4gcGlkOwogCX0KIAlyZXR1cm4gTlVMTDsK
IH0KIAotdm9pZCBmYXN0Y2FsbCBsaW5rX3BpZCh0YXNrX3QgKnRhc2ssIHN0cnVjdCBwaWRfbGlu
ayAqbGluaywgc3RydWN0IHBpZCAqcGlkKQotewotCWF0b21pY19pbmMoJnBpZC0+Y291bnQpOwot
CWxpc3RfYWRkX3RhaWwoJmxpbmstPnBpZF9jaGFpbiwgJnBpZC0+dGFza19saXN0KTsKLQlsaW5r
LT5waWRwdHIgPSBwaWQ7Ci19Ci0KIGludCBmYXN0Y2FsbCBhdHRhY2hfcGlkKHRhc2tfdCAqdGFz
aywgZW51bSBwaWRfdHlwZSB0eXBlLCBpbnQgbnIpCiB7Ci0Jc3RydWN0IHBpZCAqcGlkID0gZmlu
ZF9waWQodHlwZSwgbnIpOworCXN0cnVjdCBwaWRfc3RydWN0ICpwaWQsICp0YXNrX3BpZDsKIAot
CWlmIChwaWQpCi0JCWF0b21pY19pbmMoJnBpZC0+Y291bnQpOwotCWVsc2UgewotCQlwaWQgPSAm
dGFzay0+cGlkc1t0eXBlXS5waWQ7Ci0JCXBpZC0+bnIgPSBucjsKLQkJYXRvbWljX3NldCgmcGlk
LT5jb3VudCwgMSk7Ci0JCUlOSVRfTElTVF9IRUFEKCZwaWQtPnRhc2tfbGlzdCk7Ci0JCXBpZC0+
dGFzayA9IHRhc2s7Ci0JCWdldF90YXNrX3N0cnVjdCh0YXNrKTsKLQkJaGxpc3RfYWRkX2hlYWQo
JnBpZC0+aGFzaF9jaGFpbiwKKwl0YXNrX3BpZCA9ICZ0YXNrLT5waWRzW3R5cGVdOworCXBpZCA9
IGZpbmRfcGlkKHR5cGUsIG5yKTsKKwlpZiAocGlkID09IE5VTEwpIHsKKwkJaGxpc3RfYWRkX2hl
YWQoJnRhc2tfcGlkLT5oYXNoX2xpc3QsCiAJCQkJJnBpZF9oYXNoW3R5cGVdW3BpZF9oYXNoZm4o
bnIpXSk7CisJCUlOSVRfTElTVF9IRUFEKCZ0YXNrX3BpZC0+cGlkX2xpc3QpOworCX0gZWxzZSB7
CisJCUlOSVRfSExJU1RfTk9ERSgmdGFza19waWQtPmhhc2hfbGlzdCk7CisJCWxpc3RfYWRkX3Rh
aWwoJnRhc2tfcGlkLT5waWRfbGlzdCwgJnBpZC0+cGlkX2xpc3QpOwogCX0KLQlsaXN0X2FkZF90
YWlsKCZ0YXNrLT5waWRzW3R5cGVdLnBpZF9jaGFpbiwgJnBpZC0+dGFza19saXN0KTsKLQl0YXNr
LT5waWRzW3R5cGVdLnBpZHB0ciA9IHBpZDsKKwl0YXNrX3BpZC0+bnIgPSBucjsKIAogCXJldHVy
biAwOwogfQogCiBzdGF0aWMgaW5saW5lIGludCBfX2RldGFjaF9waWQodGFza190ICp0YXNrLCBl
bnVtIHBpZF90eXBlIHR5cGUpCiB7Ci0Jc3RydWN0IHBpZF9saW5rICpsaW5rID0gdGFzay0+cGlk
cyArIHR5cGU7Ci0Jc3RydWN0IHBpZCAqcGlkID0gbGluay0+cGlkcHRyOworCXN0cnVjdCBwaWRf
c3RydWN0ICpwaWQsICpwaWRfbmV4dDsKIAlpbnQgbnI7CiAKLQlsaXN0X2RlbCgmbGluay0+cGlk
X2NoYWluKTsKLQlpZiAoIWF0b21pY19kZWNfYW5kX3Rlc3QoJnBpZC0+Y291bnQpKQotCQlyZXR1
cm4gMDsKLQorCXBpZCA9ICZ0YXNrLT5waWRzW3R5cGVdOworCWlmICghaGxpc3RfdW5oYXNoZWQo
JnBpZC0+aGFzaF9saXN0KSkgeworCQlobGlzdF9kZWwoJnBpZC0+aGFzaF9saXN0KTsKKwkJaWYg
KCFsaXN0X2VtcHR5KCZwaWQtPnBpZF9saXN0KSkgeworCQkJcGlkX25leHQgPSBsaXN0X2VudHJ5
KHBpZC0+cGlkX2xpc3QubmV4dCwKKwkJCQkJCXN0cnVjdCBwaWRfc3RydWN0LCBwaWRfbGlzdCk7
CisJCQkvKiBpbnNlcnQgbmV4dCBwaWQgZnJvbSBwaWRfbGlzdCB0byBoYXNoICovCisJCQlobGlz
dF9hZGRfaGVhZCgmcGlkX25leHQtPmhhc2hfbGlzdCwKKwkJCQkmcGlkX2hhc2hbdHlwZV1bcGlk
X2hhc2hmbihwaWRfbmV4dC0+bnIpXSk7CisJCX0KKwl9CisJbGlzdF9kZWwoJnBpZC0+cGlkX2xp
c3QpOwogCW5yID0gcGlkLT5ucjsKLQlobGlzdF9kZWwoJnBpZC0+aGFzaF9jaGFpbik7Ci0JcHV0
X3Rhc2tfc3RydWN0KHBpZC0+dGFzayk7CisJcGlkLT5uciA9IDA7CiAKIAlyZXR1cm4gbnI7CiB9
CiAKLXN0YXRpYyB2b2lkIF9kZXRhY2hfcGlkKHRhc2tfdCAqdGFzaywgZW51bSBwaWRfdHlwZSB0
eXBlKQotewotCV9fZGV0YWNoX3BpZCh0YXNrLCB0eXBlKTsKLX0KLQogdm9pZCBmYXN0Y2FsbCBk
ZXRhY2hfcGlkKHRhc2tfdCAqdGFzaywgZW51bSBwaWRfdHlwZSB0eXBlKQogewogCWludCBuciA9
IF9fZGV0YWNoX3BpZCh0YXNrLCB0eXBlKTsKQEAgLTIyMywxNiArMjE0LDE2IEBAIHZvaWQgZmFz
dGNhbGwgZGV0YWNoX3BpZCh0YXNrX3QgKnRhc2ssIGUKIAlmcmVlX3BpZG1hcChucik7CiB9CiAK
LXRhc2tfdCAqZmluZF90YXNrX2J5X3BpZChpbnQgbnIpCit0YXNrX3QgKmZpbmRfdGFza19ieV9w
aWRfdHlwZShpbnQgdHlwZSwgaW50IG5yKQogewotCXN0cnVjdCBwaWQgKnBpZCA9IGZpbmRfcGlk
KFBJRFRZUEVfUElELCBucik7CisJc3RydWN0IHBpZF9zdHJ1Y3QgKnBpZCA9IGZpbmRfcGlkKHR5
cGUsIG5yKTsKIAogCWlmICghcGlkKQogCQlyZXR1cm4gTlVMTDsKLQlyZXR1cm4gcGlkX3Rhc2so
cGlkLT50YXNrX2xpc3QubmV4dCwgUElEVFlQRV9QSUQpOworCXJldHVybiBwaWRfdGFzaygmcGlk
LT5waWRfbGlzdCwgdHlwZSk7CiB9CiAKLUVYUE9SVF9TWU1CT0woZmluZF90YXNrX2J5X3BpZCk7
CitFWFBPUlRfU1lNQk9MKGZpbmRfdGFza19ieV9waWRfdHlwZSk7CiAKIC8qCiAgKiBUaGlzIGZ1
bmN0aW9uIHN3aXRjaGVzIHRoZSBQSURzIGlmIGEgbm9uLWxlYWRlciB0aHJlYWQgY2FsbHMKQEAg
LTI0MSwxMyArMjMyLDEzIEBAIEVYUE9SVF9TWU1CT0woZmluZF90YXNrX2J5X3BpZCk7CiAgKi8K
IHZvaWQgc3dpdGNoX2V4ZWNfcGlkcyh0YXNrX3QgKmxlYWRlciwgdGFza190ICp0aHJlYWQpCiB7
Ci0JX2RldGFjaF9waWQobGVhZGVyLCBQSURUWVBFX1BJRCk7Ci0JX2RldGFjaF9waWQobGVhZGVy
LCBQSURUWVBFX1RHSUQpOwotCV9kZXRhY2hfcGlkKGxlYWRlciwgUElEVFlQRV9QR0lEKTsKLQlf
ZGV0YWNoX3BpZChsZWFkZXIsIFBJRFRZUEVfU0lEKTsKKwkodm9pZClfX2RldGFjaF9waWQobGVh
ZGVyLCBQSURUWVBFX1BJRCk7CisJKHZvaWQpX19kZXRhY2hfcGlkKGxlYWRlciwgUElEVFlQRV9U
R0lEKTsKKwkodm9pZClfX2RldGFjaF9waWQobGVhZGVyLCBQSURUWVBFX1BHSUQpOworCSh2b2lk
KV9fZGV0YWNoX3BpZChsZWFkZXIsIFBJRFRZUEVfU0lEKTsKIAotCV9kZXRhY2hfcGlkKHRocmVh
ZCwgUElEVFlQRV9QSUQpOwotCV9kZXRhY2hfcGlkKHRocmVhZCwgUElEVFlQRV9UR0lEKTsKKwko
dm9pZClfX2RldGFjaF9waWQodGhyZWFkLCBQSURUWVBFX1BJRCk7CisJKHZvaWQpX19kZXRhY2hf
cGlkKHRocmVhZCwgUElEVFlQRV9UR0lEKTsKIAogCWxlYWRlci0+cGlkID0gbGVhZGVyLT50Z2lk
ID0gdGhyZWFkLT5waWQ7CiAJdGhyZWFkLT5waWQgPSB0aHJlYWQtPnRnaWQ7Ci0tLSB0ZXN0L2tl
cm5lbC9leGl0LmMucGlkCTIwMDQtMDktMDEgMTQ6MzM6MjAuMDAwMDAwMDAwICswNDAwCisrKyB0
ZXN0L2tlcm5lbC9leGl0LmMJMjAwNC0wOS0wMSAxNDozNDo0Ny4wMDAwMDAwMDAgKzA0MDAKQEAg
LTEyNCwxNiArMTI0LDE1IEBAIHZvaWQgdW5oYXNoX3Byb2Nlc3Moc3RydWN0IHRhc2tfc3RydWN0
ICoKIGludCBzZXNzaW9uX29mX3BncnAoaW50IHBncnApCiB7CiAJc3RydWN0IHRhc2tfc3RydWN0
ICpwOwotCXN0cnVjdCBsaXN0X2hlYWQgKmw7Ci0Jc3RydWN0IHBpZCAqcGlkOwogCWludCBzaWQg
PSAtMTsKIAogCXJlYWRfbG9jaygmdGFza2xpc3RfbG9jayk7Ci0JZm9yX2VhY2hfdGFza19waWQo
cGdycCwgUElEVFlQRV9QR0lELCBwLCBsLCBwaWQpCisJZG9fZWFjaF90YXNrX3BpZChwZ3JwLCBQ
SURUWVBFX1BHSUQsIHApIHsKIAkJaWYgKHAtPnNpZ25hbC0+c2Vzc2lvbiA+IDApIHsKIAkJCXNp
ZCA9IHAtPnNpZ25hbC0+c2Vzc2lvbjsKIAkJCWdvdG8gb3V0OwogCQl9CisJfSB3aGlsZV9lYWNo
X3Rhc2tfcGlkKHBncnAsIFBJRFRZUEVfUEdJRCwgcCk7CiAJcCA9IGZpbmRfdGFza19ieV9waWQo
cGdycCk7CiAJaWYgKHApCiAJCXNpZCA9IHAtPnNpZ25hbC0+c2Vzc2lvbjsKQEAgLTE1NCwxMSAr
MTUzLDkgQEAgb3V0Ogogc3RhdGljIGludCB3aWxsX2JlY29tZV9vcnBoYW5lZF9wZ3JwKGludCBw
Z3JwLCB0YXNrX3QgKmlnbm9yZWRfdGFzaykKIHsKIAlzdHJ1Y3QgdGFza19zdHJ1Y3QgKnA7Ci0J
c3RydWN0IGxpc3RfaGVhZCAqbDsKLQlzdHJ1Y3QgcGlkICpwaWQ7CiAJaW50IHJldCA9IDE7CiAK
LQlmb3JfZWFjaF90YXNrX3BpZChwZ3JwLCBQSURUWVBFX1BHSUQsIHAsIGwsIHBpZCkgeworCWRv
X2VhY2hfdGFza19waWQocGdycCwgUElEVFlQRV9QR0lELCBwKSB7CiAJCWlmIChwID09IGlnbm9y
ZWRfdGFzawogCQkJCXx8IHAtPnN0YXRlID49IFRBU0tfWk9NQklFIAogCQkJCXx8IHAtPnJlYWxf
cGFyZW50LT5waWQgPT0gMSkKQEAgLTE2OCw3ICsxNjUsNyBAQCBzdGF0aWMgaW50IHdpbGxfYmVj
b21lX29ycGhhbmVkX3BncnAoaW50CiAJCQlyZXQgPSAwOwogCQkJYnJlYWs7CiAJCX0KLQl9CisJ
fSB3aGlsZV9lYWNoX3Rhc2tfcGlkKHBncnAsIFBJRFRZUEVfUEdJRCwgcCk7CiAJcmV0dXJuIHJl
dDsJLyogKHNpZ2hpbmcpICJPZnRlbiEiICovCiB9CiAKQEAgLTE4NywxMCArMTg0LDggQEAgc3Rh
dGljIGlubGluZSBpbnQgaGFzX3N0b3BwZWRfam9icyhpbnQgcAogewogCWludCByZXR2YWwgPSAw
OwogCXN0cnVjdCB0YXNrX3N0cnVjdCAqcDsKLQlzdHJ1Y3QgbGlzdF9oZWFkICpsOwotCXN0cnVj
dCBwaWQgKnBpZDsKIAotCWZvcl9lYWNoX3Rhc2tfcGlkKHBncnAsIFBJRFRZUEVfUEdJRCwgcCwg
bCwgcGlkKSB7CisJZG9fZWFjaF90YXNrX3BpZChwZ3JwLCBQSURUWVBFX1BHSUQsIHApIHsKIAkJ
aWYgKHAtPnN0YXRlICE9IFRBU0tfU1RPUFBFRCkKIAkJCWNvbnRpbnVlOwogCkBAIC0yMDYsNyAr
MjAxLDcgQEAgc3RhdGljIGlubGluZSBpbnQgaGFzX3N0b3BwZWRfam9icyhpbnQgcAogCiAJCXJl
dHZhbCA9IDE7CiAJCWJyZWFrOwotCX0KKwl9IHdoaWxlX2VhY2hfdGFza19waWQocGdycCwgUElE
VFlQRV9QR0lELCBwKTsKIAlyZXR1cm4gcmV0dmFsOwogfQogCkBAIC04NDksOSArODQ0LDYgQEAg
YXNtbGlua2FnZSBsb25nIHN5c19leGl0KGludCBlcnJvcl9jb2RlKQogCiB0YXNrX3QgZmFzdGNh
bGwgKm5leHRfdGhyZWFkKGNvbnN0IHRhc2tfdCAqcCkKIHsKLQljb25zdCBzdHJ1Y3QgcGlkX2xp
bmsgKmxpbmsgPSBwLT5waWRzICsgUElEVFlQRV9UR0lEOwotCWNvbnN0IHN0cnVjdCBsaXN0X2hl
YWQgKnRtcCwgKmhlYWQgPSAmbGluay0+cGlkcHRyLT50YXNrX2xpc3Q7Ci0KICNpZmRlZiBDT05G
SUdfU01QCiAJaWYgKCFwLT5zaWdoYW5kKQogCQlCVUcoKTsKQEAgLTg1OSwxMSArODUxLDcgQEAg
dGFza190IGZhc3RjYWxsICpuZXh0X3RocmVhZChjb25zdCB0YXNrXwogCQkJCSFyd2xvY2tfaXNf
bG9ja2VkKCZ0YXNrbGlzdF9sb2NrKSkKIAkJQlVHKCk7CiAjZW5kaWYKLQl0bXAgPSBsaW5rLT5w
aWRfY2hhaW4ubmV4dDsKLQlpZiAodG1wID09IGhlYWQpCi0JCXRtcCA9IGhlYWQtPm5leHQ7Ci0K
LQlyZXR1cm4gcGlkX3Rhc2sodG1wLCBQSURUWVBFX1RHSUQpOworCXJldHVybiBwaWRfdGFzayhw
LT5waWRzW1BJRFRZUEVfVEdJRF0ucGlkX2xpc3QubmV4dCwgUElEVFlQRV9UR0lEKTsKIH0KIAog
RVhQT1JUX1NZTUJPTChuZXh0X3RocmVhZCk7Ci0tLSB0ZXN0L2tlcm5lbC9zeXMuYy5waWQJMjAw
NC0wOS0wMSAxNDozMzoyMS4wMDAwMDAwMDAgKzA0MDAKKysrIHRlc3Qva2VybmVsL3N5cy5jCTIw
MDQtMDktMDEgMTQ6MzQ6NDcuMDAwMDAwMDAwICswNDAwCkBAIC0zMTAsOCArMzEwLDYgQEAgYXNt
bGlua2FnZSBsb25nIHN5c19zZXRwcmlvcml0eShpbnQgd2hpYwogewogCXN0cnVjdCB0YXNrX3N0
cnVjdCAqZywgKnA7CiAJc3RydWN0IHVzZXJfc3RydWN0ICp1c2VyOwotCXN0cnVjdCBwaWQgKnBp
ZDsKLQlzdHJ1Y3QgbGlzdF9oZWFkICpsOwogCWludCBlcnJvciA9IC1FSU5WQUw7CiAKIAlpZiAo
d2hpY2ggPiAyIHx8IHdoaWNoIDwgMCkKQEAgLTMzNiw4ICszMzQsOSBAQCBhc21saW5rYWdlIGxv
bmcgc3lzX3NldHByaW9yaXR5KGludCB3aGljCiAJCWNhc2UgUFJJT19QR1JQOgogCQkJaWYgKCF3
aG8pCiAJCQkJd2hvID0gcHJvY2Vzc19ncm91cChjdXJyZW50KTsKLQkJCWZvcl9lYWNoX3Rhc2tf
cGlkKHdobywgUElEVFlQRV9QR0lELCBwLCBsLCBwaWQpCisJCQlkb19lYWNoX3Rhc2tfcGlkKHdo
bywgUElEVFlQRV9QR0lELCBwKSB7CiAJCQkJZXJyb3IgPSBzZXRfb25lX3ByaW8ocCwgbmljZXZh
bCwgZXJyb3IpOworCQkJfSB3aGlsZV9lYWNoX3Rhc2tfcGlkKHdobywgUElEVFlQRV9QR0lELCBw
KTsKIAkJCWJyZWFrOwogCQljYXNlIFBSSU9fVVNFUjoKIAkJCWlmICghd2hvKQpAQCAtMzcxLDgg
KzM3MCw2IEBAIG91dDoKIGFzbWxpbmthZ2UgbG9uZyBzeXNfZ2V0cHJpb3JpdHkoaW50IHdoaWNo
LCBpbnQgd2hvKQogewogCXN0cnVjdCB0YXNrX3N0cnVjdCAqZywgKnA7Ci0Jc3RydWN0IGxpc3Rf
aGVhZCAqbDsKLQlzdHJ1Y3QgcGlkICpwaWQ7CiAJc3RydWN0IHVzZXJfc3RydWN0ICp1c2VyOwog
CWxvbmcgbmljZXZhbCwgcmV0dmFsID0gLUVTUkNIOwogCkBAIC0zOTQsMTEgKzM5MSwxMSBAQCBh
c21saW5rYWdlIGxvbmcgc3lzX2dldHByaW9yaXR5KGludCB3aGljCiAJCWNhc2UgUFJJT19QR1JQ
OgogCQkJaWYgKCF3aG8pCiAJCQkJd2hvID0gcHJvY2Vzc19ncm91cChjdXJyZW50KTsKLQkJCWZv
cl9lYWNoX3Rhc2tfcGlkKHdobywgUElEVFlQRV9QR0lELCBwLCBsLCBwaWQpIHsKKwkJCWRvX2Vh
Y2hfdGFza19waWQod2hvLCBQSURUWVBFX1BHSUQsIHApIHsKIAkJCQluaWNldmFsID0gMjAgLSB0
YXNrX25pY2UocCk7CiAJCQkJaWYgKG5pY2V2YWwgPiByZXR2YWwpCiAJCQkJCXJldHZhbCA9IG5p
Y2V2YWw7Ci0JCQl9CisJCQl9IHdoaWxlX2VhY2hfdGFza19waWQod2hvLCBQSURUWVBFX1BHSUQs
IHApOwogCQkJYnJlYWs7CiAJCWNhc2UgUFJJT19VU0VSOgogCQkJaWYgKCF3aG8pCkBAIC0xMDQ0
LDEyICsxMDQxLDExIEBAIGFzbWxpbmthZ2UgbG9uZyBzeXNfc2V0cGdpZChwaWRfdCBwaWQsIHAK
IAogCWlmIChwZ2lkICE9IHBpZCkgewogCQlzdHJ1Y3QgdGFza19zdHJ1Y3QgKnA7Ci0JCXN0cnVj
dCBwaWQgKnBpZDsKLQkJc3RydWN0IGxpc3RfaGVhZCAqbDsKIAotCQlmb3JfZWFjaF90YXNrX3Bp
ZChwZ2lkLCBQSURUWVBFX1BHSUQsIHAsIGwsIHBpZCkKKwkJZG9fZWFjaF90YXNrX3BpZChwZ2lk
LCBQSURUWVBFX1BHSUQsIHApIHsKIAkJCWlmIChwLT5zaWduYWwtPnNlc3Npb24gPT0gY3VycmVu
dC0+c2lnbmFsLT5zZXNzaW9uKQogCQkJCWdvdG8gb2tfcGdpZDsKKwkJfSB3aGlsZV9lYWNoX3Rh
c2tfcGlkKHBnaWQsIFBJRFRZUEVfUEdJRCwgcCk7CiAJCWdvdG8gb3V0OwogCX0KIApAQCAtMTEy
Nyw3ICsxMTIzLDcgQEAgYXNtbGlua2FnZSBsb25nIHN5c19nZXRzaWQocGlkX3QgcGlkKQogCiBh
c21saW5rYWdlIGxvbmcgc3lzX3NldHNpZCh2b2lkKQogewotCXN0cnVjdCBwaWQgKnBpZDsKKwlz
dHJ1Y3QgcGlkX3N0cnVjdCAqcGlkOwogCWludCBlcnIgPSAtRVBFUk07CiAKIAlpZiAoIXRocmVh
ZF9ncm91cF9sZWFkZXIoY3VycmVudCkpCi0tLSB0ZXN0L2tlcm5lbC9zaWduYWwuYy5waWQJMjAw
NC0wOS0wMSAxNDozMzoyMS4wMDAwMDAwMDAgKzA0MDAKKysrIHRlc3Qva2VybmVsL3NpZ25hbC5j
CTIwMDQtMDktMDEgMTQ6MzQ6NDcuMDAwMDAwMDAwICswNDAwCkBAIC0xMTEwLDggKzExMTAsNiBA
QCBpbnQgZ3JvdXBfc2VuZF9zaWdfaW5mbyhpbnQgc2lnLCBzdHJ1Y3QgCiBpbnQgX19raWxsX3Bn
X2luZm8oaW50IHNpZywgc3RydWN0IHNpZ2luZm8gKmluZm8sIHBpZF90IHBncnApCiB7CiAJc3Ry
dWN0IHRhc2tfc3RydWN0ICpwOwotCXN0cnVjdCBsaXN0X2hlYWQgKmw7Ci0Jc3RydWN0IHBpZCAq
cGlkOwogCWludCByZXR2YWwsIHN1Y2Nlc3M7CiAKIAlpZiAocGdycCA8PSAwKQpAQCAtMTExOSwx
MSArMTExNywxMSBAQCBpbnQgX19raWxsX3BnX2luZm8oaW50IHNpZywgc3RydWN0IHNpZ2luCiAK
IAlzdWNjZXNzID0gMDsKIAlyZXR2YWwgPSAtRVNSQ0g7Ci0JZm9yX2VhY2hfdGFza19waWQocGdy
cCwgUElEVFlQRV9QR0lELCBwLCBsLCBwaWQpIHsKKwlkb19lYWNoX3Rhc2tfcGlkKHBncnAsIFBJ
RFRZUEVfUEdJRCwgcCkgewogCQlpbnQgZXJyID0gZ3JvdXBfc2VuZF9zaWdfaW5mbyhzaWcsIGlu
Zm8sIHApOwogCQlzdWNjZXNzIHw9ICFlcnI7CiAJCXJldHZhbCA9IGVycjsKLQl9CisJfSB3aGls
ZV9lYWNoX3Rhc2tfcGlkKHBncnAsIFBJRFRZUEVfUEdJRCwgcCk7CiAJcmV0dXJuIHN1Y2Nlc3Mg
PyAwIDogcmV0dmFsOwogfQogCkBAIC0xMTUwLDggKzExNDgsNiBAQCBpbnQKIGtpbGxfc2xfaW5m
byhpbnQgc2lnLCBzdHJ1Y3Qgc2lnaW5mbyAqaW5mbywgcGlkX3Qgc2lkKQogewogCWludCBlcnIs
IHJldHZhbCA9IC1FSU5WQUw7Ci0Jc3RydWN0IHBpZCAqcGlkOwotCXN0cnVjdCBsaXN0X2hlYWQg
Kmw7CiAJc3RydWN0IHRhc2tfc3RydWN0ICpwOwogCiAJaWYgKHNpZCA8PSAwKQpAQCAtMTE1OSwx
MyArMTE1NSwxMyBAQCBraWxsX3NsX2luZm8oaW50IHNpZywgc3RydWN0IHNpZ2luZm8gKmluCiAK
IAlyZXR2YWwgPSAtRVNSQ0g7CiAJcmVhZF9sb2NrKCZ0YXNrbGlzdF9sb2NrKTsKLQlmb3JfZWFj
aF90YXNrX3BpZChzaWQsIFBJRFRZUEVfU0lELCBwLCBsLCBwaWQpIHsKKwlkb19lYWNoX3Rhc2tf
cGlkKHNpZCwgUElEVFlQRV9TSUQsIHApIHsKIAkJaWYgKCFwLT5zaWduYWwtPmxlYWRlcikKIAkJ
CWNvbnRpbnVlOwogCQllcnIgPSBncm91cF9zZW5kX3NpZ19pbmZvKHNpZywgaW5mbywgcCk7CiAJ
CWlmIChyZXR2YWwpCiAJCQlyZXR2YWwgPSBlcnI7Ci0JfQorCX0gd2hpbGVfZWFjaF90YXNrX3Bp
ZChzaWQsIFBJRFRZUEVfU0lELCBwKTsKIAlyZWFkX3VubG9jaygmdGFza2xpc3RfbG9jayk7CiBv
dXQ6CiAJcmV0dXJuIHJldHZhbDsKLS0tIHRlc3Qva2VybmVsL2ZvcmsuYy5waWQJMjAwNC0wOS0w
MSAxNDozMzoyMC4wMDAwMDAwMDAgKzA0MDAKKysrIHRlc3Qva2VybmVsL2ZvcmsuYwkyMDA0LTA5
LTAxIDE0OjM0OjQ3LjAwMDAwMDAwMCArMDQwMApAQCAtMTEyNCwxNCArMTEyNCwxMyBAQCBzdGF0
aWMgdGFza190ICpjb3B5X3Byb2Nlc3ModW5zaWduZWQgbG9uCiAJCV9fcHRyYWNlX2xpbmsocCwg
Y3VycmVudC0+cGFyZW50KTsKIAogCWF0dGFjaF9waWQocCwgUElEVFlQRV9QSUQsIHAtPnBpZCk7
CisJYXR0YWNoX3BpZChwLCBQSURUWVBFX1RHSUQsIHAtPnRnaWQpOwogCWlmICh0aHJlYWRfZ3Jv
dXBfbGVhZGVyKHApKSB7Ci0JCWF0dGFjaF9waWQocCwgUElEVFlQRV9UR0lELCBwLT50Z2lkKTsK
IAkJYXR0YWNoX3BpZChwLCBQSURUWVBFX1BHSUQsIHByb2Nlc3NfZ3JvdXAocCkpOwogCQlhdHRh
Y2hfcGlkKHAsIFBJRFRZUEVfU0lELCBwLT5zaWduYWwtPnNlc3Npb24pOwogCQlpZiAocC0+cGlk
KQogCQkJX19nZXRfY3B1X3Zhcihwcm9jZXNzX2NvdW50cykrKzsKLQl9IGVsc2UKLQkJbGlua19w
aWQocCwgcC0+cGlkcyArIFBJRFRZUEVfVEdJRCwgJnAtPmdyb3VwX2xlYWRlci0+cGlkc1tQSURU
WVBFX1RHSURdLnBpZCk7CisJfQogCiAJbnJfdGhyZWFkcysrOwogCXdyaXRlX3VubG9ja19pcnEo
JnRhc2tsaXN0X2xvY2spOwotLS0gdGVzdC9rZXJuZWwvY2FwYWJpbGl0eS5jLnBpZAkyMDA0LTA5
LTAxIDE0OjMzOjIwLjAwMDAwMDAwMCArMDQwMAorKysgdGVzdC9rZXJuZWwvY2FwYWJpbGl0eS5j
CTIwMDQtMDktMDEgMTQ6MzQ6NDcuMDAwMDAwMDAwICswNDAwCkBAIC04OSwxNCArODksMTIgQEAg
c3RhdGljIGlubGluZSB2b2lkIGNhcF9zZXRfcGcoaW50IHBncnAsIAogCQkJICAgICAga2VybmVs
X2NhcF90ICpwZXJtaXR0ZWQpCiB7CiAJdGFza190ICpnLCAqdGFyZ2V0OwotCXN0cnVjdCBsaXN0
X2hlYWQgKmw7Ci0Jc3RydWN0IHBpZCAqcGlkOwogCi0JZm9yX2VhY2hfdGFza19waWQocGdycCwg
UElEVFlQRV9QR0lELCBnLCBsLCBwaWQpIHsKKwlkb19lYWNoX3Rhc2tfcGlkKHBncnAsIFBJRFRZ
UEVfUEdJRCwgZykgewogCQl0YXJnZXQgPSBnOwogCQl3aGlsZV9lYWNoX3RocmVhZChnLCB0YXJn
ZXQpCiAJCQlzZWN1cml0eV9jYXBzZXRfc2V0KHRhcmdldCwgZWZmZWN0aXZlLCBpbmhlcml0YWJs
ZSwgcGVybWl0dGVkKTsKLQl9CisJfSB3aGlsZV9lYWNoX3Rhc2tfcGlkKHBncnAsIFBJRFRZUEVf
UEdJRCwgZyk7CiB9CiAKIC8qCg==

------6ch90RMi-im0oRHt2F11XYxd8:1094039167--
