Return-Path: <linux-kernel-owner+willy=40w.ods.org-S965029AbVIUVh1@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S965029AbVIUVh1 (ORCPT <rfc822;willy@w.ods.org>);
	Wed, 21 Sep 2005 17:37:27 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S965024AbVIUVh1
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Wed, 21 Sep 2005 17:37:27 -0400
Received: from mf00.sitadelle.com ([212.94.174.67]:18010 "EHLO
	smtp.cegetel.net") by vger.kernel.org with ESMTP id S965008AbVIUVhY
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Wed, 21 Sep 2005 17:37:24 -0400
Message-ID: <4331D290.6070104@cosmosbay.com>
Date: Wed, 21 Sep 2005 23:37:20 +0200
From: Eric Dumazet <dada1@cosmosbay.com>
User-Agent: Mozilla Thunderbird 1.0 (Windows/20041206)
X-Accept-Language: fr, en
MIME-Version: 1.0
To: linux-kernel@vger.kernel.org, netfilter-devel@lists.netfilter.org,
       netdev@vger.kernel.org
Cc: Andi Kleen <ak@suse.de>
Subject: [PATCH 3/3] netfilter : 3 patches to boost ip_tables performance
References: <432EF0C5.5090908@cosmosbay.com> <200509191948.55333.ak@suse.de> <432FDAC5.3040801@cosmosbay.com> <200509201830.20689.ak@suse.de> <433082DE.3060308@cosmosbay.com> <43308324.70403@cosmosbay.com>
In-Reply-To: <43308324.70403@cosmosbay.com>
Content-Type: multipart/mixed;
 boundary="------------030002070203020903060702"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

This is a multi-part message in MIME format.
--------------030002070203020903060702
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

Patch 3/3 (please apply after Patch 2/3)

3) NUMA allocation.

Part of the performance problem we have with netfilter is memory allocation
is not NUMA aware, but 'only' SMP aware (ie each CPU normally touch
separate cache lines)

Even with small iptables rules, the cost of this misplacement can be high
  on common workloads.

Instead of using one vmalloc() area (located in the node of the iptables
process), we now allocate an area for each possible CPU, using NUMA policy
(MPOL_PREFERRED) so that memory should be allocated in the CPU's node
if possible.

If the size of ipt_table is small enough (less than one page), we use
kmalloc_node() instead of vmalloc(), to use less memory and less TLB entries)
in small setups.

Please note that this patch doesnt change the number of allocated bytes, only 
the location of allocated zones.

Note2 : This patch depends on another patch that declares sys_set_mempolicy()
in include/linux/syscalls.h
( http://marc.theaimsgroup.com/?l=linux-kernel&m=112725288622984&w=2 )

Signed-off-by: Eric Dumazet <dada1@cosmosbay.com>


--------------030002070203020903060702
Content-Type: text/plain;
 name="patch_ip_tables_numa.3"
Content-Transfer-Encoding: base64
Content-Disposition: inline;
 filename="patch_ip_tables_numa.3"

LS0tIGxpbnV4LTIuNi9uZXQvaXB2NC9uZXRmaWx0ZXIvaXBfdGFibGVzLmMJMjAwNS0wOS0y
MiAwMDo0NDozNC4wMDAwMDAwMDAgKzAyMDAKKysrIGxpbnV4LTIuNi1lZC9uZXQvaXB2NC9u
ZXRmaWx0ZXIvaXBfdGFibGVzLmMJMjAwNS0wOS0yMiAwMDo1NzoxNS4wMDAwMDAwMDAgKzAy
MDAKQEAgLTE3LDYgKzE3LDggQEAKICNpbmNsdWRlIDxsaW51eC9za2J1ZmYuaD4KICNpbmNs
dWRlIDxsaW51eC9rbW9kLmg+CiAjaW5jbHVkZSA8bGludXgvdm1hbGxvYy5oPgorI2luY2x1
ZGUgPGxpbnV4L21lbXBvbGljeS5oPgorI2luY2x1ZGUgPGxpbnV4L3N5c2NhbGxzLmg+CiAj
aW5jbHVkZSA8bGludXgvbmV0ZGV2aWNlLmg+CiAjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+
CiAjaW5jbHVkZSA8bGludXgvdGNwLmg+CkBAIC04MiwxMSArODQsNiBAQAogICAgY29udGV4
dCBzdG9wcyBwYWNrZXRzIGNvbWluZyB0aHJvdWdoIGFuZCBhbGxvd3MgdXNlciBjb250ZXh0
IHRvIHJlYWQKICAgIHRoZSBjb3VudGVycyBvciB1cGRhdGUgdGhlIHJ1bGVzLgogCi0gICBU
byBiZSBjYWNoZSBmcmllbmRseSBvbiBTTVAsIHdlIGFycmFuZ2UgdGhlbSBsaWtlIHNvOgot
ICAgWyBuLWVudHJpZXMgXQotICAgLi4uIGNhY2hlLWFsaWduIHBhZGRpbmcgLi4uCi0gICBb
IG4tZW50cmllcyBdCi0KICAgIEhlbmNlIHRoZSBzdGFydCBvZiBhbnkgdGFibGUgaXMgZ2l2
ZW4gYnkgZ2V0X3RhYmxlKCkgYmVsb3cuICAqLwogCiAvKiBUaGUgdGFibGUgaXRzZWxmICov
CkBAIC0xMDQsNyArMTAxLDcgQEAKIAl1bnNpZ25lZCBpbnQgdW5kZXJmbG93W05GX0lQX05V
TUhPT0tTXTsKIAogCS8qIGlwdF9lbnRyeSB0YWJsZXM6IG9uZSBwZXIgQ1BVICovCi0JY2hh
ciBlbnRyaWVzWzBdIF9fX19jYWNoZWxpbmVfYWxpZ25lZDsKKwl2b2lkICplbnRyaWVzW05S
X0NQVVNdOwogfTsKIAogc3RhdGljIExJU1RfSEVBRChpcHRfdGFyZ2V0KTsKQEAgLTExMywx
MiArMTEwLDYgQEAKICNkZWZpbmUgU0VUX0NPVU5URVIoYyxiLHApIGRvIHsgKGMpLmJjbnQg
PSAoYik7IChjKS5wY250ID0gKHApOyB9IHdoaWxlKDApCiAjZGVmaW5lIEFERF9DT1VOVEVS
KGMsYixwKSBkbyB7IChjKS5iY250ICs9IChiKTsgKGMpLnBjbnQgKz0gKHApOyB9IHdoaWxl
KDApCiAKLSNpZmRlZiBDT05GSUdfU01QCi0jZGVmaW5lIFRBQkxFX09GRlNFVCh0LHApIChT
TVBfQUxJR04oKHQpLT5zaXplKSoocCkpCi0jZWxzZQotI2RlZmluZSBUQUJMRV9PRkZTRVQo
dCxwKSAwCi0jZW5kaWYKLQogI2lmIDAKICNkZWZpbmUgZG93bih4KSBkbyB7IHByaW50aygi
RE9XTjoldToiICN4ICJcbiIsIF9fTElORV9fKTsgZG93bih4KTsgfSB3aGlsZSgwKQogI2Rl
ZmluZSBkb3duX2ludGVycnVwdGlibGUoeCkgKHsgaW50IF9fcjsgcHJpbnRrKCJET1dOaTol
dToiICN4ICJcbiIsIF9fTElORV9fKTsgX19yID0gZG93bl9pbnRlcnJ1cHRpYmxlKHgpOyBp
ZiAoX19yICE9IDApIHByaW50aygiQUJPUlQtRE9XTmk6JXVcbiIsIF9fTElORV9fKTsgX19y
OyB9KQpAQCAtMzMxLDggKzMyMiw3IEBACiAJcmVhZF9sb2NrX2JoKCZ0YWJsZS0+bG9jayk7
CiAjZW5kaWYKIAlJUF9ORl9BU1NFUlQodGFibGUtPnZhbGlkX2hvb2tzICYgKDEgPDwgaG9v
aykpOwotCXRhYmxlX2Jhc2UgPSAodm9pZCAqKXRhYmxlLT5wcml2YXRlLT5lbnRyaWVzCi0J
CSsgVEFCTEVfT0ZGU0VUKHRhYmxlLT5wcml2YXRlLCBzbXBfcHJvY2Vzc29yX2lkKCkpOwor
CXRhYmxlX2Jhc2UgPSAodm9pZCAqKXRhYmxlLT5wcml2YXRlLT5lbnRyaWVzW3NtcF9wcm9j
ZXNzb3JfaWQoKV07CiAJZSA9IGdldF9lbnRyeSh0YWJsZV9iYXNlLCB0YWJsZS0+cHJpdmF0
ZS0+aG9va19lbnRyeVtob29rXSk7CiAKICNpZmRlZiBDT05GSUdfTkVURklMVEVSX0RFQlVH
CkBAIC02MDgsNyArNTk4LDcgQEAKIC8qIEZpZ3VyZXMgb3V0IGZyb20gd2hhdCBob29rIGVh
Y2ggcnVsZSBjYW4gYmUgY2FsbGVkOiByZXR1cm5zIDAgaWYKICAgIHRoZXJlIGFyZSBsb29w
cy4gIFB1dHMgaG9vayBiaXRtYXNrIGluIGNvbWVmcm9tLiAqLwogc3RhdGljIGludAotbWFy
a19zb3VyY2VfY2hhaW5zKHN0cnVjdCBpcHRfdGFibGVfaW5mbyAqbmV3aW5mbywgdW5zaWdu
ZWQgaW50IHZhbGlkX2hvb2tzKQorbWFya19zb3VyY2VfY2hhaW5zKHN0cnVjdCBpcHRfdGFi
bGVfaW5mbyAqbmV3aW5mbywgdW5zaWduZWQgaW50IHZhbGlkX2hvb2tzLCB2b2lkICplbnRy
eTApCiB7CiAJdW5zaWduZWQgaW50IGhvb2s7CiAKQEAgLTYxNyw3ICs2MDcsNyBAQAogCWZv
ciAoaG9vayA9IDA7IGhvb2sgPCBORl9JUF9OVU1IT09LUzsgaG9vaysrKSB7CiAJCXVuc2ln
bmVkIGludCBwb3MgPSBuZXdpbmZvLT5ob29rX2VudHJ5W2hvb2tdOwogCQlzdHJ1Y3QgaXB0
X2VudHJ5ICplCi0JCQk9IChzdHJ1Y3QgaXB0X2VudHJ5ICopKG5ld2luZm8tPmVudHJpZXMg
KyBwb3MpOworCQkJPSAoc3RydWN0IGlwdF9lbnRyeSAqKShlbnRyeTAgKyBwb3MpOwogCiAJ
CWlmICghKHZhbGlkX2hvb2tzICYgKDEgPDwgaG9vaykpKQogCQkJY29udGludWU7CkBAIC02
NjcsMTMgKzY1NywxMyBAQAogCQkJCQkJZ290byBuZXh0OwogCiAJCQkJCWUgPSAoc3RydWN0
IGlwdF9lbnRyeSAqKQotCQkJCQkJKG5ld2luZm8tPmVudHJpZXMgKyBwb3MpOworCQkJCQkJ
KGVudHJ5MCArIHBvcyk7CiAJCQkJfSB3aGlsZSAob2xkcG9zID09IHBvcyArIGUtPm5leHRf
b2Zmc2V0KTsKIAogCQkJCS8qIE1vdmUgYWxvbmcgb25lICovCiAJCQkJc2l6ZSA9IGUtPm5l
eHRfb2Zmc2V0OwogCQkJCWUgPSAoc3RydWN0IGlwdF9lbnRyeSAqKQotCQkJCQkobmV3aW5m
by0+ZW50cmllcyArIHBvcyArIHNpemUpOworCQkJCQkoZW50cnkwICsgcG9zICsgc2l6ZSk7
CiAJCQkJZS0+Y291bnRlcnMucGNudCA9IHBvczsKIAkJCQlwb3MgKz0gc2l6ZTsKIAkJCX0g
ZWxzZSB7CkBAIC02OTAsNyArNjgwLDcgQEAKIAkJCQkJbmV3cG9zID0gcG9zICsgZS0+bmV4
dF9vZmZzZXQ7CiAJCQkJfQogCQkJCWUgPSAoc3RydWN0IGlwdF9lbnRyeSAqKQotCQkJCQko
bmV3aW5mby0+ZW50cmllcyArIG5ld3Bvcyk7CisJCQkJCShlbnRyeTAgKyBuZXdwb3MpOwog
CQkJCWUtPmNvdW50ZXJzLnBjbnQgPSBwb3M7CiAJCQkJcG9zID0gbmV3cG9zOwogCQkJfQpA
QCAtOTAwLDYgKzg5MCw3IEBACiB0cmFuc2xhdGVfdGFibGUoY29uc3QgY2hhciAqbmFtZSwK
IAkJdW5zaWduZWQgaW50IHZhbGlkX2hvb2tzLAogCQlzdHJ1Y3QgaXB0X3RhYmxlX2luZm8g
Km5ld2luZm8sCisJCXZvaWQgKmVudHJ5MCwKIAkJdW5zaWduZWQgaW50IHNpemUsCiAJCXVu
c2lnbmVkIGludCBudW1iZXIsCiAJCWNvbnN0IHVuc2lnbmVkIGludCAqaG9va19lbnRyaWVz
LApAQCAtOTIwLDExICs5MTEsMTEgQEAKIAlkdXByaW50ZigidHJhbnNsYXRlX3RhYmxlOiBz
aXplICV1XG4iLCBuZXdpbmZvLT5zaXplKTsKIAlpID0gMDsKIAkvKiBXYWxrIHRocm91Z2gg
ZW50cmllcywgY2hlY2tpbmcgb2Zmc2V0cy4gKi8KLQlyZXQgPSBJUFRfRU5UUllfSVRFUkFU
RShuZXdpbmZvLT5lbnRyaWVzLCBuZXdpbmZvLT5zaXplLAorCXJldCA9IElQVF9FTlRSWV9J
VEVSQVRFKGVudHJ5MCwgbmV3aW5mby0+c2l6ZSwKIAkJCQljaGVja19lbnRyeV9zaXplX2Fu
ZF9ob29rcywKIAkJCQluZXdpbmZvLAotCQkJCW5ld2luZm8tPmVudHJpZXMsCi0JCQkJbmV3
aW5mby0+ZW50cmllcyArIHNpemUsCisJCQkJZW50cnkwLAorCQkJCWVudHJ5MCArIHNpemUs
CiAJCQkJaG9va19lbnRyaWVzLCB1bmRlcmZsb3dzLCAmaSk7CiAJaWYgKHJldCAhPSAwKQog
CQlyZXR1cm4gcmV0OwpAQCAtOTUyLDI1ICs5NDMsMjQgQEAKIAkJfQogCX0KIAotCWlmICgh
bWFya19zb3VyY2VfY2hhaW5zKG5ld2luZm8sIHZhbGlkX2hvb2tzKSkKKwlpZiAoIW1hcmtf
c291cmNlX2NoYWlucyhuZXdpbmZvLCB2YWxpZF9ob29rcywgZW50cnkwKSkKIAkJcmV0dXJu
IC1FTE9PUDsKIAogCS8qIEZpbmFsbHksIGVhY2ggc2FuaXR5IGNoZWNrIG11c3QgcGFzcyAq
LwogCWkgPSAwOwotCXJldCA9IElQVF9FTlRSWV9JVEVSQVRFKG5ld2luZm8tPmVudHJpZXMs
IG5ld2luZm8tPnNpemUsCisJcmV0ID0gSVBUX0VOVFJZX0lURVJBVEUoZW50cnkwLCBuZXdp
bmZvLT5zaXplLAogCQkJCWNoZWNrX2VudHJ5LCBuYW1lLCBzaXplLCAmaSk7CiAKIAlpZiAo
cmV0ICE9IDApIHsKLQkJSVBUX0VOVFJZX0lURVJBVEUobmV3aW5mby0+ZW50cmllcywgbmV3
aW5mby0+c2l6ZSwKKwkJSVBUX0VOVFJZX0lURVJBVEUoZW50cnkwLCBuZXdpbmZvLT5zaXpl
LAogCQkJCSAgY2xlYW51cF9lbnRyeSwgJmkpOwogCQlyZXR1cm4gcmV0OwogCX0KIAogCS8q
IEFuZCBvbmUgY29weSBmb3IgZXZlcnkgb3RoZXIgQ1BVICovCi0JZm9yIChpID0gMTsgaSA8
IG51bV9wb3NzaWJsZV9jcHVzKCk7IGkrKykgewotCQltZW1jcHkobmV3aW5mby0+ZW50cmll
cyArIFNNUF9BTElHTihuZXdpbmZvLT5zaXplKSppLAotCQkgICAgICAgbmV3aW5mby0+ZW50
cmllcywKLQkJICAgICAgIFNNUF9BTElHTihuZXdpbmZvLT5zaXplKSk7CisJZm9yX2VhY2hf
Y3B1KGkpIHsKKwkJaWYgKG5ld2luZm8tPmVudHJpZXNbaV0gJiYgbmV3aW5mby0+ZW50cmll
c1tpXSAhPSBlbnRyeTApCisJCQltZW1jcHkobmV3aW5mby0+ZW50cmllc1tpXSwgZW50cnkw
LCBuZXdpbmZvLT5zaXplKTsKIAl9CiAKIAlyZXR1cm4gcmV0OwpAQCAtMTAxMCwxNSArMTAw
MCwxMiBAQAogCiAjaWZkZWYgQ09ORklHX05FVEZJTFRFUl9ERUJVRwogCXsKLQkJc3RydWN0
IGlwdF9lbnRyeSAqdGFibGVfYmFzZTsKLQkJdW5zaWduZWQgaW50IGk7CisJCWludCBjcHU7
CiAKLQkJZm9yIChpID0gMDsgaSA8IG51bV9wb3NzaWJsZV9jcHVzKCk7IGkrKykgewotCQkJ
dGFibGVfYmFzZSA9Ci0JCQkJKHZvaWQgKiluZXdpbmZvLT5lbnRyaWVzCi0JCQkJKyBUQUJM
RV9PRkZTRVQobmV3aW5mbywgaSk7Ci0KLQkJCXRhYmxlX2Jhc2UtPmNvbWVmcm9tID0gMHhk
ZWFkNTdhYzsKKwkJZm9yX2VhY2hfY3B1KGNwdSkgeworCQkJc3RydWN0IGlwdF9lbnRyeSAq
dGFibGVfYmFzZSA9IG5ld2luZm8tPmVudHJpZXNbY3B1XTsKKwkJCWlmICh0YWJsZV9iYXNl
KQorCQkJCXRhYmxlX2Jhc2UtPmNvbWVmcm9tID0gMHhkZWFkNTdhYzsKIAkJfQogCX0KICNl
bmRpZgpAQCAtMTA4Myw3ICsxMDcwLDcgQEAKIAlpZiAodGFibGUpCiAJCXdyaXRlX2xvY2tf
YmgocGVyX2NwdV9wdHIodGFibGUtPmxvY2tfcCwgY3VyY3B1KSk7CiAJaSA9IDA7Ci0JSVBU
X0VOVFJZX0lURVJBVEUodC0+ZW50cmllcyArIFRBQkxFX09GRlNFVCh0LCBjdXJjcHUpLAor
CUlQVF9FTlRSWV9JVEVSQVRFKHQtPmVudHJpZXNbY3VyY3B1XSwKIAkJCSAgdC0+c2l6ZSwK
IAkJCSAgc2V0X2VudHJ5X3RvX2NvdW50ZXIsCiAJCQkgIGNvdW50ZXJzLApAQCAtMTA5Nyw3
ICsxMDg0LDcgQEAKIAkJaWYgKHRhYmxlKQogCQkJd3JpdGVfbG9ja19iaChwZXJfY3B1X3B0
cih0YWJsZS0+bG9ja19wLCBjcHUpKTsKIAkJaSA9IDA7Ci0JCUlQVF9FTlRSWV9JVEVSQVRF
KHQtPmVudHJpZXMgKyBUQUJMRV9PRkZTRVQodCwgY3B1KSwKKwkJSVBUX0VOVFJZX0lURVJB
VEUodC0+ZW50cmllc1tjcHVdLAogCQkJCSAgdC0+c2l6ZSwKIAkJCQkgIGFkZF9lbnRyeV90
b19jb3VudGVyLAogCQkJCSAgY291bnRlcnMsCkBAIC0xMTEwLDcgKzEwOTcsNyBAQAogCWlm
ICh0YWJsZSkKIAkJd3JpdGVfbG9ja19iaCgmdGFibGUtPmxvY2spOwogCWkgPSAwOwotCUlQ
VF9FTlRSWV9JVEVSQVRFKHQtPmVudHJpZXMsCisJSVBUX0VOVFJZX0lURVJBVEUodC0+ZW50
cmllc1swXSwKIAkJCSAgdC0+c2l6ZSwKIAkJCSAgc2V0X2VudHJ5X3RvX2NvdW50ZXIsCiAJ
CQkgIGNvdW50ZXJzLApAQCAtMTEyOSw2ICsxMTE2LDcgQEAKIAlzdHJ1Y3QgaXB0X2VudHJ5
ICplOwogCXN0cnVjdCBpcHRfY291bnRlcnMgKmNvdW50ZXJzOwogCWludCByZXQgPSAwOwor
CXZvaWQgKmxvY19jcHVfZW50cnk7CiAKIAkvKiBXZSBuZWVkIGF0b21pYyBzbmFwc2hvdCBv
ZiBjb3VudGVyczogcmVzdCBkb2Vzbid0IGNoYW5nZQogCSAgIChvdGhlciB0aGFuIGNvbWVm
cm9tLCB3aGljaCB1c2Vyc3BhY2UgZG9lc24ndCBjYXJlCkBAIC0xMTQyLDggKzExMzAsMTIg
QEAKIAkvKiBGaXJzdCwgc3VtIGNvdW50ZXJzLi4uICovCiAJZ2V0X2NvdW50ZXJzKHRhYmxl
LCB0YWJsZS0+cHJpdmF0ZSwgY291bnRlcnMpOwogCi0JLyogLi4uIHRoZW4gY29weSBlbnRp
cmUgdGhpbmcgZnJvbSBDUFUgMC4uLiAqLwotCWlmIChjb3B5X3RvX3VzZXIodXNlcnB0ciwg
dGFibGUtPnByaXZhdGUtPmVudHJpZXMsIHRvdGFsX3NpemUpICE9IDApIHsKKwkvKgorCSAq
IGNob29zZSB0aGUgY29weSB0aGF0IGlzIG9uIG91ciBub2RlL2NwdSwKKwkgKi8KKwlsb2Nf
Y3B1X2VudHJ5ID0gdGFibGUtPnByaXZhdGUtPmVudHJpZXNbZ2V0X2NwdSgpXTsKKwkvKiAu
Li4gdGhlbiBjb3B5IGVudGlyZSB0aGluZyAuLi4gKi8KKwlpZiAoY29weV90b191c2VyKHVz
ZXJwdHIsIGxvY19jcHVfZW50cnksIHRvdGFsX3NpemUpICE9IDApIHsKIAkJcmV0ID0gLUVG
QVVMVDsKIAkJZ290byBmcmVlX2NvdW50ZXJzOwogCX0KQEAgLTExNTUsNyArMTE0Nyw3IEBA
CiAJCXN0cnVjdCBpcHRfZW50cnlfbWF0Y2ggKm07CiAJCXN0cnVjdCBpcHRfZW50cnlfdGFy
Z2V0ICp0OwogCi0JCWUgPSAoc3RydWN0IGlwdF9lbnRyeSAqKSh0YWJsZS0+cHJpdmF0ZS0+
ZW50cmllcyArIG9mZik7CisJCWUgPSAoc3RydWN0IGlwdF9lbnRyeSAqKShsb2NfY3B1X2Vu
dHJ5ICsgb2ZmKTsKIAkJaWYgKGNvcHlfdG9fdXNlcih1c2VycHRyICsgb2ZmCiAJCQkJICsg
b2Zmc2V0b2Yoc3RydWN0IGlwdF9lbnRyeSwgY291bnRlcnMpLAogCQkJCSAmY291bnRlcnNb
bnVtXSwKQEAgLTExOTIsNiArMTE4NCw3IEBACiAJfQogCiAgZnJlZV9jb3VudGVyczoKKwlw
dXRfY3B1KCk7CiAJdmZyZWUoY291bnRlcnMpOwogCXJldHVybiByZXQ7CiB9CkBAIC0xMjI0
LDYgKzEyMTcsNjAgQEAKIAlyZXR1cm4gcmV0OwogfQogCitzdGF0aWMgdm9pZCBmcmVlX3Rh
YmxlX2luZm8oc3RydWN0IGlwdF90YWJsZV9pbmZvICppbmZvKQoreworCWludCBjcHU7CisJ
Zm9yX2VhY2hfY3B1KGNwdSkgeworCQlpZiAoaW5mby0+c2l6ZSA8PSBQQUdFX1NJWkUpCisJ
CQlrZnJlZShpbmZvLT5lbnRyaWVzW2NwdV0pOworCQllbHNlCisJCQl2ZnJlZShpbmZvLT5l
bnRyaWVzW2NwdV0pOworCX0KKwlrZnJlZShpbmZvKTsKK30KKworc3RhdGljIHN0cnVjdCBp
cHRfdGFibGVfaW5mbyAqYWxsb2NfdGFibGVfaW5mbyh1bnNpZ25lZCBpbnQgc2l6ZSkKK3sK
K3N0cnVjdCBpcHRfdGFibGVfaW5mbyAqbmV3aW5mbzsKK2ludCBjcHU7CisJbmV3aW5mbyA9
IGt6YWxsb2Moc2l6ZW9mKHN0cnVjdCBpcHRfdGFibGVfaW5mbyksIEdGUF9LRVJORUwpOwor
CWlmICghbmV3aW5mbykKKwkJcmV0dXJuIE5VTEw7CisJbmV3aW5mby0+c2l6ZSA9IHNpemU7
CisJZm9yX2VhY2hfY3B1KGNwdSkgeworCQlpZiAoc2l6ZSA8PSBQQUdFX1NJWkUpIHsKKwkJ
CW5ld2luZm8tPmVudHJpZXNbY3B1XSA9IGttYWxsb2Nfbm9kZShzaXplLAorCQkJCUdGUF9L
RVJORUwsCisJCQkJY3B1X3RvX25vZGUoY3B1KSk7CisJCX0gZWxzZSB7CisjaWZkZWYgQ09O
RklHX05VTUEKKwkJCXN0cnVjdCBtZW1wb2xpY3kgKm9sZHBvbDsKKwkJCW1tX3NlZ21lbnRf
dCBvbGRmcyA9IGdldF9mcygpOworCQkJREVDTEFSRV9CSVRNQVAobXlub2RlLCBNQVhfTlVN
Tk9ERVMpOworCisJCQlvbGRwb2wgPSBjdXJyZW50LT5tZW1wb2xpY3k7CisJCQltcG9sX2dl
dChvbGRwb2wpOworCQkJYml0bWFwX3plcm8obXlub2RlLCBNQVhfTlVNTk9ERVMpOworCQkJ
c2V0X2JpdChjcHVfdG9fbm9kZShjcHUpLCBteW5vZGUpOworCQkJc2V0X2ZzKEtFUk5FTF9E
Uyk7CisJCQlzeXNfc2V0X21lbXBvbGljeShNUE9MX1BSRUZFUlJFRCwgbXlub2RlLCBNQVhf
TlVNTk9ERVMpOworCQkJc2V0X2ZzKG9sZGZzKTsKKyNlbmRpZgorCQkJbmV3aW5mby0+ZW50
cmllc1tjcHVdID0gdm1hbGxvYyhzaXplKTsKKyNpZmRlZiBDT05GSUdfTlVNQQorCQkJbXBv
bF9mcmVlKGN1cnJlbnQtPm1lbXBvbGljeSk7CisJCQljdXJyZW50LT5tZW1wb2xpY3kgPSBv
bGRwb2w7CisjZW5kaWYKKwkJfQorCQlpZiAobmV3aW5mby0+ZW50cmllc1tjcHVdID09IDAp
IHsKKwkJCWZyZWVfdGFibGVfaW5mbyhuZXdpbmZvKTsKKwkJCXJldHVybiBOVUxMOworCQl9
CisJfQorCXJldHVybiBuZXdpbmZvOworfQorCisKIHN0YXRpYyBpbnQKIGRvX3JlcGxhY2Uo
dm9pZCBfX3VzZXIgKnVzZXIsIHVuc2lnbmVkIGludCBsZW4pCiB7CkBAIC0xMjMyLDYgKzEy
NzksNyBAQAogCXN0cnVjdCBpcHRfdGFibGUgKnQ7CiAJc3RydWN0IGlwdF90YWJsZV9pbmZv
ICpuZXdpbmZvLCAqb2xkaW5mbzsKIAlzdHJ1Y3QgaXB0X2NvdW50ZXJzICpjb3VudGVyczsK
Kwl2b2lkICpsb2NfY3B1X2VudHJ5LCAqbG9jX2NwdV9vbGRfZW50cnk7CiAKIAlpZiAoY29w
eV9mcm9tX3VzZXIoJnRtcCwgdXNlciwgc2l6ZW9mKHRtcCkpICE9IDApCiAJCXJldHVybiAt
RUZBVUxUOwpAQCAtMTI0NCwxMiArMTI5MiwxNCBAQAogCWlmICgoU01QX0FMSUdOKHRtcC5z
aXplKSA+PiBQQUdFX1NISUZUKSArIDIgPiBudW1fcGh5c3BhZ2VzKQogCQlyZXR1cm4gLUVO
T01FTTsKIAotCW5ld2luZm8gPSB2bWFsbG9jKHNpemVvZihzdHJ1Y3QgaXB0X3RhYmxlX2lu
Zm8pCi0JCQkgICsgU01QX0FMSUdOKHRtcC5zaXplKSAqIG51bV9wb3NzaWJsZV9jcHVzKCkp
OworCW5ld2luZm8gPSBhbGxvY190YWJsZV9pbmZvKHRtcC5zaXplKTsKIAlpZiAoIW5ld2lu
Zm8pCiAJCXJldHVybiAtRU5PTUVNOwotCi0JaWYgKGNvcHlfZnJvbV91c2VyKG5ld2luZm8t
PmVudHJpZXMsIHVzZXIgKyBzaXplb2YodG1wKSwKKwkvKgorCSAqIGNob29zZSB0aGUgY29w
eSB0aGF0IGlzIG9uIG91ciBub2RlL2NwdQorCSAqLworCWxvY19jcHVfZW50cnkgPSBuZXdp
bmZvLT5lbnRyaWVzW2dldF9jcHUoKV07CisJaWYgKGNvcHlfZnJvbV91c2VyKGxvY19jcHVf
ZW50cnksIHVzZXIgKyBzaXplb2YodG1wKSwKIAkJCSAgIHRtcC5zaXplKSAhPSAwKSB7CiAJ
CXJldCA9IC1FRkFVTFQ7CiAJCWdvdG8gZnJlZV9uZXdpbmZvOwpAQCAtMTI2MCwxMCArMTMx
MCw5IEBACiAJCXJldCA9IC1FTk9NRU07CiAJCWdvdG8gZnJlZV9uZXdpbmZvOwogCX0KLQlt
ZW1zZXQoY291bnRlcnMsIDAsIHRtcC5udW1fY291bnRlcnMgKiBzaXplb2Yoc3RydWN0IGlw
dF9jb3VudGVycykpOwogCiAJcmV0ID0gdHJhbnNsYXRlX3RhYmxlKHRtcC5uYW1lLCB0bXAu
dmFsaWRfaG9va3MsCi0JCQkgICAgICBuZXdpbmZvLCB0bXAuc2l6ZSwgdG1wLm51bV9lbnRy
aWVzLAorCQkJICAgICAgbmV3aW5mbywgbG9jX2NwdV9lbnRyeSwgdG1wLnNpemUsIHRtcC5u
dW1fZW50cmllcywKIAkJCSAgICAgIHRtcC5ob29rX2VudHJ5LCB0bXAudW5kZXJmbG93KTsK
IAlpZiAocmV0ICE9IDApCiAJCWdvdG8gZnJlZV9uZXdpbmZvX2NvdW50ZXJzOwpAQCAtMTMw
Miw4ICsxMzUxLDEwIEBACiAJLyogR2V0IHRoZSBvbGQgY291bnRlcnMuICovCiAJZ2V0X2Nv
dW50ZXJzKE5VTEwsIG9sZGluZm8sIGNvdW50ZXJzKTsKIAkvKiBEZWNyZWFzZSBtb2R1bGUg
dXNhZ2UgY291bnRzIGFuZCBmcmVlIHJlc291cmNlICovCi0JSVBUX0VOVFJZX0lURVJBVEUo
b2xkaW5mby0+ZW50cmllcywgb2xkaW5mby0+c2l6ZSwgY2xlYW51cF9lbnRyeSxOVUxMKTsK
LQl2ZnJlZShvbGRpbmZvKTsKKwlsb2NfY3B1X29sZF9lbnRyeSA9IG9sZGluZm8tPmVudHJp
ZXNbc21wX3Byb2Nlc3Nvcl9pZCgpXTsKKwlJUFRfRU5UUllfSVRFUkFURShsb2NfY3B1X29s
ZF9lbnRyeSwgb2xkaW5mby0+c2l6ZSwgY2xlYW51cF9lbnRyeSxOVUxMKTsKKwlwdXRfY3B1
KCk7CisJZnJlZV90YWJsZV9pbmZvKG9sZGluZm8pOwogCWlmIChjb3B5X3RvX3VzZXIodG1w
LmNvdW50ZXJzLCBjb3VudGVycywKIAkJCSBzaXplb2Yoc3RydWN0IGlwdF9jb3VudGVycykg
KiB0bXAubnVtX2NvdW50ZXJzKSAhPSAwKQogCQlyZXQgPSAtRUZBVUxUOwpAQCAtMTMxNSwx
MSArMTM2NiwxMiBAQAogCW1vZHVsZV9wdXQodC0+bWUpOwogCXVwKCZpcHRfbXV0ZXgpOwog
IGZyZWVfbmV3aW5mb19jb3VudGVyc191bnRyYW5zOgotCUlQVF9FTlRSWV9JVEVSQVRFKG5l
d2luZm8tPmVudHJpZXMsIG5ld2luZm8tPnNpemUsIGNsZWFudXBfZW50cnksTlVMTCk7CisJ
SVBUX0VOVFJZX0lURVJBVEUobG9jX2NwdV9lbnRyeSwgbmV3aW5mby0+c2l6ZSwgY2xlYW51
cF9lbnRyeSxOVUxMKTsKICBmcmVlX25ld2luZm9fY291bnRlcnM6CiAJdmZyZWUoY291bnRl
cnMpOwogIGZyZWVfbmV3aW5mbzoKLQl2ZnJlZShuZXdpbmZvKTsKKwlwdXRfY3B1KCk7CisJ
ZnJlZV90YWJsZV9pbmZvKG5ld2luZm8pOwogCXJldHVybiByZXQ7CiB9CiAKQEAgLTEzNTIs
NiArMTQwNCw3IEBACiAJc3RydWN0IGlwdF9jb3VudGVyc19pbmZvIHRtcCwgKnBhZGRjOwog
CXN0cnVjdCBpcHRfdGFibGUgKnQ7CiAJaW50IHJldCA9IDA7CisJdm9pZCAqbG9jX2NwdV9l
bnRyeTsKICNpZmRlZiBDT05GSUdfU01QCiAJcndsb2NrX3QgKmxvY2twOwogI2VuZGlmCkBA
IC0xMzg5LDcgKzE0NDIsMTEgQEAKIAl9CiAKIAlpID0gMDsKLQlJUFRfRU5UUllfSVRFUkFU
RSh0LT5wcml2YXRlLT5lbnRyaWVzLAorCS8qCisJICogY2hvb3NlIHRoZSBjb3B5IHRoYXQg
aXMgb24gb3VyIG5vZGUsCisJICovCisJbG9jX2NwdV9lbnRyeSA9IHQtPnByaXZhdGUtPmVu
dHJpZXNbc21wX3Byb2Nlc3Nvcl9pZCgpXTsKKwlJUFRfRU5UUllfSVRFUkFURShsb2NfY3B1
X2VudHJ5LAogCQkJICB0LT5wcml2YXRlLT5zaXplLAogCQkJICBhZGRfY291bnRlcl90b19l
bnRyeSwKIAkJCSAgcGFkZGMtPmNvdW50ZXJzLApAQCAtMTU4NCw4ICsxNjQxLDE1IEBACiB7
CiAJaW50IHJldDsKIAlzdHJ1Y3QgaXB0X3RhYmxlX2luZm8gKm5ld2luZm87Ci0Jc3RhdGlj
IHN0cnVjdCBpcHRfdGFibGVfaW5mbyBib290c3RyYXAKLQkJPSB7IDAsIDAsIDAsIHsgMCB9
LCB7IDAgfSwgeyB9IH07CisJc3RhdGljIHN0cnVjdCBpcHRfdGFibGVfaW5mbyBib290c3Ry
YXAgPSB7CisJCS5zaXplID0gMCwKKwkJLm51bWJlciA9IDAsCisJCS5pbml0aWFsX2VudHJp
ZXMgPSAwLAorCQkuaG9va19lbnRyeSA9IHsgMCB9LAorCQkudW5kZXJmbG93ID0geyAwIH0s
CisJCS5lbnRyaWVzID0ge05VTEwgfQorCQl9OworCXZvaWQgKmxvY19jcHVfZW50cnk7CiAj
aWZkZWYgQ09ORklHX1NNUAogCWludCBjcHU7CiAJaWYgKCF0YWJsZS0+bG9ja19wKSB7CkBA
IC0xNTk3LDI2ICsxNjYxLDMwIEBACiAjZWxzZQogCXJ3bG9ja19pbml0KCZ0YWJsZS0+bG9j
ayk7CiAjZW5kaWYKLQluZXdpbmZvID0gdm1hbGxvYyhzaXplb2Yoc3RydWN0IGlwdF90YWJs
ZV9pbmZvKQotCQkJICArIFNNUF9BTElHTihyZXBsLT5zaXplKSAqIG51bV9wb3NzaWJsZV9j
cHVzKCkpOworCisJbmV3aW5mbyA9IGFsbG9jX3RhYmxlX2luZm8ocmVwbC0+c2l6ZSk7CiAJ
aWYgKCFuZXdpbmZvKQogCQlyZXR1cm4gLUVOT01FTTsKLQotCW1lbWNweShuZXdpbmZvLT5l
bnRyaWVzLCByZXBsLT5lbnRyaWVzLCByZXBsLT5zaXplKTsKKwkvKgorCSAqIGNob29zZSB0
aGUgY29weSB0aGF0IGlzIG9uIG91ciBub2RlL2NwdQorCSAqLworCWxvY19jcHVfZW50cnkg
PSBuZXdpbmZvLT5lbnRyaWVzW2dldF9jcHUoKV07CisJbWVtY3B5KGxvY19jcHVfZW50cnks
IHJlcGwtPmVudHJpZXMsIHJlcGwtPnNpemUpOwogCiAJcmV0ID0gdHJhbnNsYXRlX3RhYmxl
KHRhYmxlLT5uYW1lLCB0YWJsZS0+dmFsaWRfaG9va3MsCi0JCQkgICAgICBuZXdpbmZvLCBy
ZXBsLT5zaXplLAorCQkJICAgICAgbmV3aW5mbywgbG9jX2NwdV9lbnRyeSwgcmVwbC0+c2l6
ZSwKIAkJCSAgICAgIHJlcGwtPm51bV9lbnRyaWVzLAogCQkJICAgICAgcmVwbC0+aG9va19l
bnRyeSwKIAkJCSAgICAgIHJlcGwtPnVuZGVyZmxvdyk7CisJcHV0X2NwdSgpOwogCWlmIChy
ZXQgIT0gMCkgewotCQl2ZnJlZShuZXdpbmZvKTsKKwkJZnJlZV90YWJsZV9pbmZvKG5ld2lu
Zm8pOwogCQlyZXR1cm4gcmV0OwogCX0KIAogCXJldCA9IGRvd25faW50ZXJydXB0aWJsZSgm
aXB0X211dGV4KTsKIAlpZiAocmV0ICE9IDApIHsKLQkJdmZyZWUobmV3aW5mbyk7CisJCWZy
ZWVfdGFibGVfaW5mbyhuZXdpbmZvKTsKIAkJcmV0dXJuIHJldDsKIAl9CiAKQEAgLTE2NDQs
MjAgKzE3MTIsMjUgQEAKIAlyZXR1cm4gcmV0OwogCiAgZnJlZV91bmxvY2s6Ci0JdmZyZWUo
bmV3aW5mbyk7CisJZnJlZV90YWJsZV9pbmZvKG5ld2luZm8pOwogCWdvdG8gdW5sb2NrOwog
fQogCiB2b2lkIGlwdF91bnJlZ2lzdGVyX3RhYmxlKHN0cnVjdCBpcHRfdGFibGUgKnRhYmxl
KQogeworCXZvaWQgKmxvY19jcHVfZW50cnk7CiAJZG93bigmaXB0X211dGV4KTsKIAlMSVNU
X0RFTEVURSgmaXB0X3RhYmxlcywgdGFibGUpOwogCXVwKCZpcHRfbXV0ZXgpOwogCi0JLyog
RGVjcmVhc2UgbW9kdWxlIHVzYWdlIGNvdW50cyBhbmQgZnJlZSByZXNvdXJjZXMgKi8KLQlJ
UFRfRU5UUllfSVRFUkFURSh0YWJsZS0+cHJpdmF0ZS0+ZW50cmllcywgdGFibGUtPnByaXZh
dGUtPnNpemUsCisJLyogRGVjcmVhc2UgbW9kdWxlIHVzYWdlIGNvdW50cyBhbmQgZnJlZSBy
ZXNvdXJjZXMKKwkgKiBjaG9vc2UgdGhlIGNvcHkgdGhhdCBpcyBvbiBvdXIgbm9kZS9jcHUK
KwkgKi8KKwlsb2NfY3B1X2VudHJ5ID0gdGFibGUtPnByaXZhdGUtPmVudHJpZXNbZ2V0X2Nw
dSgpXTsKKwlJUFRfRU5UUllfSVRFUkFURShsb2NfY3B1X2VudHJ5LCB0YWJsZS0+cHJpdmF0
ZS0+c2l6ZSwKIAkJCSAgY2xlYW51cF9lbnRyeSwgTlVMTCk7Ci0JdmZyZWUodGFibGUtPnBy
aXZhdGUpOworCXB1dF9jcHUoKTsKKwlmcmVlX3RhYmxlX2luZm8odGFibGUtPnByaXZhdGUp
OwogI2lmZGVmIENPTkZJR19TTVAKIAlmcmVlX3BlcmNwdSh0YWJsZS0+bG9ja19wKTsKIAl0
YWJsZS0+bG9ja19wID0gTlVMTDsK
--------------030002070203020903060702--
