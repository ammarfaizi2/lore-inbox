Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id <S261775AbSJIMhu>; Wed, 9 Oct 2002 08:37:50 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org
	id <S261668AbSJIMbg>; Wed, 9 Oct 2002 08:31:36 -0400
Received: from d12lmsgate-4.de.ibm.com ([194.196.100.237]:58783 "EHLO
	d12lmsgate-4.de.ibm.com") by vger.kernel.org with ESMTP
	id <S261671AbSJIM35> convert rfc822-to-8bit; Wed, 9 Oct 2002 08:29:57 -0400
Content-Type: text/plain;
  charset="us-ascii"
From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Organization: IBM Deutschland GmbH
To: linux-kernel@vger.kernel.org, torvalds@transmeta.com
Subject: [PATCH] 2.5.41 s390 (1/8): compile fixes.
Date: Wed, 9 Oct 2002 14:28:04 +0200
X-Mailer: KMail [version 1.4]
MIME-Version: 1.0
Content-Transfer-Encoding: 8BIT
Message-Id: <200210091428.04829.schwidefsky@de.ibm.com>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Switch to @$(generate-asm-offsets.h) method to create the asm-offsets.h file,
fix signal dequeueing in the 31 bit emulation code and fix includes.

diff -urN linux-2.5.41/arch/s390/Makefile linux-2.5.41-s390/arch/s390/Makefile
--- linux-2.5.41/arch/s390/Makefile	Mon Oct  7 20:23:34 2002
+++ linux-2.5.41-s390/arch/s390/Makefile	Wed Oct  9 14:01:06 2002
@@ -17,9 +17,7 @@
 OBJCOPYFLAGS	:= -O binary
 LDFLAGS_vmlinux := -e start
 
-CFLAGS_PIPE := -pipe
-CFLAGS_NSR  := -fno-strength-reduce
-CFLAGS := $(CFLAGS) $(CFLAGS_PIPE) $(CFLAGS_NSR)
+CFLAGS += -pipe -fno-strength-reduce
 
 HEAD := arch/s390/kernel/head.o arch/s390/kernel/init_task.o
 
@@ -38,11 +36,24 @@
 image: vmlinux 
 	@$(MAKEBOOT) image
 
+install: vmlinux
+	@$(MAKEBOOT) BOOTIMAGE=image install
+
 archclean:
-	@$(MAKEBOOT) clean
-	$(MAKE) -C arch/$(ARCH)/kernel clean
 
 archmrproper:
 
-install: vmlinux
-	@$(MAKEBOOT) BOOTIMAGE=image install
+prepare: include/asm-$(ARCH)/offsets.h
+
+arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+				   include/config/MARKER
+
+include/asm-$(ARCH)/offsets.h.tmp: arch/$(ARCH)/kernel/asm-offsets.s
+	@$(generate-asm-offsets.h) < $< > $@
+
+include/asm-$(ARCH)/offsets.h: include/asm-$(ARCH)/offsets.h.tmp
+	@echo -n '  Generating $@'
+	@$(update-if-changed)
+
+CLEAN_FILES += include/asm-$(ARCH)/offsets.h.tmp \
+	       include/asm-$(ARCH)/offsets.h
diff -urN linux-2.5.41/arch/s390/defconfig linux-2.5.41-s390/arch/s390/defconfig
--- linux-2.5.41/arch/s390/defconfig	Mon Oct  7 20:24:50 2002
+++ linux-2.5.41-s390/arch/s390/defconfig	Wed Oct  9 14:01:06 2002
@@ -91,6 +91,7 @@
 #
 # CONFIG_SCSI_7000FASST is not set
 # CONFIG_SCSI_ACARD is not set
+# CONFIG_SCSI_AACRAID is not set
 # CONFIG_SCSI_AIC7XXX is not set
 # CONFIG_SCSI_AIC7XXX_OLD is not set
 # CONFIG_SCSI_DPT_I2O is not set
@@ -121,6 +122,7 @@
 # CONFIG_SCSI_SYM53C416 is not set
 # CONFIG_SCSI_T128 is not set
 # CONFIG_SCSI_U14_34F is not set
+# CONFIG_SCSI_NSP32 is not set
 # CONFIG_SCSI_DEBUG is not set
 
 #
diff -urN linux-2.5.41/arch/s390/kernel/Makefile linux-2.5.41-s390/arch/s390/kernel/Makefile
--- linux-2.5.41/arch/s390/kernel/Makefile	Mon Oct  7 20:25:19 2002
+++ linux-2.5.41-s390/arch/s390/kernel/Makefile	Wed Oct  9 14:01:06 2002
@@ -19,26 +19,3 @@
 obj-$(CONFIG_REMOTE_DEBUG)	+= gdb-stub.o #gdb-low.o 
 
 include $(TOPDIR)/Rules.make
-
-.PHONY: asm-offsets.h
-
-entry.S: asm-offsets.h
-
-asm-offsets.h: asm-offsets.c
-	$(CC) $(CFLAGS) $(EXTRA_CFLAGS) -S $< -o - | grep -- "->" | \
-	(echo "#ifndef __ASM_OFFSETS_H__"; \
-	 echo "#define __ASM_OFFSETS_H__"; \
-	 echo "/*"; \
-	 echo " * DO NOT MODIFY"; \
-	 echo " *"; \
-	 echo " * This file was generated by arch/s390/kernel/Makefile"; \
-	 echo " */"; \
-	 sed -e "s:^->\([^ ]*\) \([^ ]*\) \(.*\):#define \\1 \\2 /* \\3*/:" \
-	     -e "s:->::"; \
-	 echo "#endif" \
-	) > asm-offsets.h
-
-clean:
-	rm -f asm-offsets.h
-
-
diff -urN linux-2.5.41/arch/s390/kernel/entry.S linux-2.5.41-s390/arch/s390/kernel/entry.S
--- linux-2.5.41/arch/s390/kernel/entry.S	Mon Oct  7 20:23:33 2002
+++ linux-2.5.41-s390/arch/s390/kernel/entry.S	Wed Oct  9 14:01:06 2002
@@ -17,8 +17,7 @@
 #include <asm/errno.h>
 #include <asm/ptrace.h>
 #include <asm/thread_info.h>
-
-#include "asm-offsets.h"
+#include <asm/offsets.h>
 
 /*
  * Stack layout for the system_call stack entry.
diff -urN linux-2.5.41/arch/s390x/Makefile linux-2.5.41-s390/arch/s390x/Makefile
--- linux-2.5.41/arch/s390x/Makefile	Mon Oct  7 20:24:36 2002
+++ linux-2.5.41-s390/arch/s390x/Makefile	Wed Oct  9 14:01:06 2002
@@ -18,9 +18,7 @@
 LDFLAGS_vmlinux := -e start
 MODFLAGS += -fpic
 
-CFLAGS_PIPE := -pipe
-CFLAGS_NSR  := -fno-strength-reduce
-CFLAGS := $(CFLAGS) $(CFLAGS_PIPE) $(CFLAGS_NSR)
+CFLAGS += -pipe -fno-strength-reduce
 
 HEAD := arch/s390x/kernel/head.o arch/s390x/kernel/init_task.o
 
@@ -42,7 +40,20 @@
 	@$(MAKEBOOT) BOOTIMAGE=image install
 
 archclean:
-	@$(MAKEBOOT) clean
-	$(MAKE) -C arch/$(ARCH)/kernel clean
 
 archmrproper:
+
+prepare: include/asm-$(ARCH)/offsets.h
+
+arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+				   include/config/MARKER
+
+include/asm-$(ARCH)/offsets.h.tmp: arch/$(ARCH)/kernel/asm-offsets.s
+	@$(generate-asm-offsets.h) < $< > $@
+
+include/asm-$(ARCH)/offsets.h: include/asm-$(ARCH)/offsets.h.tmp
+	@echo -n '  Generating $@'
+	@$(update-if-changed)
+
+CLEAN_FILES += include/asm-$(ARCH)/offsets.h.tmp \
+	       include/asm-$(ARCH)/offsets.h
diff -urN linux-2.5.41/arch/s390x/defconfig linux-2.5.41-s390/arch/s390x/defconfig
--- linux-2.5.41/arch/s390x/defconfig	Mon Oct  7 20:22:53 2002
+++ linux-2.5.41-s390/arch/s390x/defconfig	Wed Oct  9 14:01:06 2002
@@ -92,6 +92,7 @@
 #
 # CONFIG_SCSI_7000FASST is not set
 # CONFIG_SCSI_ACARD is not set
+# CONFIG_SCSI_AACRAID is not set
 # CONFIG_SCSI_AIC7XXX is not set
 # CONFIG_SCSI_AIC7XXX_OLD is not set
 # CONFIG_SCSI_DPT_I2O is not set
@@ -122,6 +123,7 @@
 # CONFIG_SCSI_SYM53C416 is not set
 # CONFIG_SCSI_T128 is not set
 # CONFIG_SCSI_U14_34F is not set
+# CONFIG_SCSI_NSP32 is not set
 # CONFIG_SCSI_DEBUG is not set
 
 #
diff -urN linux-2.5.41/arch/s390x/kernel/Makefile linux-2.5.41-s390/arch/s390x/kernel/Makefile
--- linux-2.5.41/arch/s390x/kernel/Makefile	Mon Oct  7 20:24:06 2002
+++ linux-2.5.41-s390/arch/s390x/kernel/Makefile	Wed Oct  9 14:01:06 2002
@@ -30,28 +30,3 @@
 # This is just to get the dependencies...
 #
 binfmt_elf32.o:	$(TOPDIR)/fs/binfmt_elf.c
-
-.PHONY: asm-offsets.h
-
-entry.S: asm-offsets.h
-
-#
-# Automatic offset generation for assembler files.
-#
-asm-offsets.h: asm-offsets.c
-	$(CC) $(CFLAGS) $(EXTRA_CFLAGS) -S $< -o - | grep -- "->" | \
-	(echo "#ifndef __ASM_OFFSETS_H__"; \
-	 echo "#define __ASM_OFFSETS_H__"; \
-	 echo "/*"; \
-	 echo " * DO NOT MODIFY"; \
-	 echo " *"; \
-	 echo " * This file was generated by arch/s390/kernel/Makefile"; \
-	 echo " */"; \
-	 sed -e "s:^->\([^ ]*\) \([^ ]*\) \(.*\):#define \\1 \\2 /* \\3*/:" \
-	     -e "s:->::"; \
-	 echo "#endif" \
-	) > asm-offsets.h
-
-clean:
-	rm -f asm-offsets.h
-
diff -urN linux-2.5.41/arch/s390x/kernel/entry.S linux-2.5.41-s390/arch/s390x/kernel/entry.S
--- linux-2.5.41/arch/s390x/kernel/entry.S	Mon Oct  7 20:23:36 2002
+++ linux-2.5.41-s390/arch/s390x/kernel/entry.S	Wed Oct  9 14:01:06 2002
@@ -17,8 +17,7 @@
 #include <asm/errno.h>
 #include <asm/ptrace.h>
 #include <asm/thread_info.h>
-
-#include "asm-offsets.h"
+#include <asm/offsets.h>
 
 /*
  * Stack layout for the system_call stack entry.
diff -urN linux-2.5.41/arch/s390x/kernel/ioctl32.c linux-2.5.41-s390/arch/s390x/kernel/ioctl32.c
--- linux-2.5.41/arch/s390x/kernel/ioctl32.c	Mon Oct  7 20:25:16 2002
+++ linux-2.5.41-s390/arch/s390x/kernel/ioctl32.c	Wed Oct  9 14:01:06 2002
@@ -25,9 +25,9 @@
 #include <linux/ext2_fs.h>
 #include <linux/hdreg.h>
 #include <linux/if_bonding.h>
-#include <linux/loop.h>
 #include <linux/blkpg.h>
 #include <linux/blk.h>
+#include <linux/loop.h>
 #include <linux/elevator.h>
 #include <asm/types.h>
 #include <asm/uaccess.h>
diff -urN linux-2.5.41/arch/s390x/kernel/linux32.c linux-2.5.41-s390/arch/s390x/kernel/linux32.c
--- linux-2.5.41/arch/s390x/kernel/linux32.c	Mon Oct  7 20:23:33 2002
+++ linux-2.5.41-s390/arch/s390x/kernel/linux32.c	Wed Oct  9 14:01:06 2002
@@ -1953,9 +1953,7 @@
 	}
 
 	spin_lock_irq(&current->sig->siglock);
-	sig = dequeue_signal(&current->sig->shared_pending, &these, &info);
-	if (!sig)
-		sig = dequeue_signal(&current->pending, &these, &info);
+	sig = dequeue_signal(&these, &info);
 	if (!sig) {
 		/* None ready -- temporarily unblock those we're interested
 		   in so that we'll be awakened when they arrive.  */
@@ -1973,9 +1971,7 @@
 		timeout = schedule_timeout(timeout);
 
 		spin_lock_irq(&current->sig->siglock);
-		sig = dequeue_signal(&current->sig->shared_pending, &these, &info);
-		if (!sig)
-			sig = dequeue_signal(&current->pending, &these, &info);
+		sig = dequeue_signal(&these, &info);
 		current->blocked = current->real_blocked;
 		siginitset(&current->real_blocked, 0);
 		recalc_sigpending();
diff -urN linux-2.5.41/drivers/s390/cio/cio.c linux-2.5.41-s390/drivers/s390/cio/cio.c
--- linux-2.5.41/drivers/s390/cio/cio.c	Mon Oct  7 20:25:19 2002
+++ linux-2.5.41-s390/drivers/s390/cio/cio.c	Wed Oct  9 14:01:06 2002
@@ -1,7 +1,7 @@
 /*
  *  drivers/s390/cio/cio.c
  *   S/390 common I/O routines -- low level i/o calls
- *   $Revision: 1.26 $
+ *   $Revision: 1.27 $
  *
  *    Copyright (C) 1999-2002 IBM Deutschland Entwicklung GmbH,
  *                            IBM Corporation
@@ -27,6 +27,7 @@
 #include "cio.h"
 #include "cio_debug.h"
 #include "ioinfo.h"
+#include "chsc.h"
 #include "s390io.h" /* FIXME: try to do without this */
 
 static atomic_t sync_isc = ATOMIC_INIT (-1);

