Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id <S315783AbSFYTOS>; Tue, 25 Jun 2002 15:14:18 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org
	id <S315794AbSFYTOS>; Tue, 25 Jun 2002 15:14:18 -0400
Received: from mion.elka.pw.edu.pl ([194.29.160.35]:29322 "EHLO
	mion.elka.pw.edu.pl") by vger.kernel.org with ESMTP
	id <S315783AbSFYTOM>; Tue, 25 Jun 2002 15:14:12 -0400
Date: Tue, 25 Jun 2002 21:13:54 +0200 (MET DST)
From: Bartlomiej Zolnierkiewicz <B.Zolnierkiewicz@elka.pw.edu.pl>
To: Martin Dalecki <dalecki@evision-ventures.com>
cc: Kernel Mailing List <linux-kernel@vger.kernel.org>
Subject: [PATCH] 2.5.24: generic ATA PCI auto-dma tuning (1/5)
Message-ID: <Pine.SOL.4.30.0206252110560.27820-200000@mion.elka.pw.edu.pl>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-559023410-1804928587-1025032434=:27820"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.
  Send mail to mime@docserver.cac.washington.edu for more info.

---559023410-1804928587-1025032434=:27820
Content-Type: TEXT/PLAIN; charset=US-ASCII


Hi!

This is first of five patches implementing generic ATA host chips
(U)DMA auto-tuning... against 2.5.24 but should also apply cleanly
to 2.5.24 + Martin's ide-clean-94 patch...

Lot of duplicated code is removed and simple, coherent scheme is provided...

diffstat for 5 patches:
35 files changed, 338 insertions(+), 825 deletions(-)


	- add int 'modes_map' and flag 'no_atapi_autodma' to
	  struct ata_channel, initialise them in *_init_channel()
	  functions

	- add XFER_UDMA_ALL and XFER_UDMA_80W defines to ata-timing.h

	- convert *_ratemask() functions to *_modes_map(),
	  mark them with __init
	  affected drivers: alim15x3.c, cmd64x.c, hpt366.c,
	  		    pdc202xx.c, serverworks.c, sis5513.c

	- split aec62xx_udma_setup() to aec62xx_udma_setup()
	  and aec62xx_modes_map()

	- move eighty_ninty_three(drive) check from *_ratemask()
	  to driver specific config_chipset_for_dma()

--
Bartlomiej Zolnierkiewicz

---559023410-1804928587-1025032434=:27820
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="ata-hosts-7.diff"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.SOL.4.30.0206252113540.27820@mion.elka.pw.edu.pl>
Content-Description: 
Content-Disposition: attachment; filename="ata-hosts-7.diff"

ZGlmZiAtdXIgbGludXgtMi41LjI0L2luY2x1ZGUvbGludXgvaWRlLmggbGlu
dXgvaW5jbHVkZS9saW51eC9pZGUuaA0KLS0tIGxpbnV4LTIuNS4yNC9pbmNs
dWRlL2xpbnV4L2lkZS5oCU1vbiBKdW4gMjQgMjI6MjE6MDMgMjAwMg0KKysr
IGxpbnV4L2luY2x1ZGUvbGludXgvaWRlLmgJTW9uIEp1biAyNCAyMjoyNDoz
MCAyMDAyDQpAQCAtNDk2LDcgKzQ5Niw5IEBADQogCXVuc2lnbmVkIHVubWFz
awkJOiAxOwkvKiBmbGFnOiBva2F5IHRvIHVubWFzayBvdGhlciBpcnFzICov
DQogCXVuc2lnbmVkIHNsb3cJCTogMTsJLyogZmxhZzogc2xvdyBkYXRhIHBv
cnQgKi8NCiAJdW5zaWduZWQgaW9fMzJiaXQJOiAxOwkvKiAwPTE2LWJpdCwg
MT0zMi1iaXQgKi8NCisJdW5zaWduZWQgbm9fYXRhcGlfYXV0b2RtYSA6IDE7
CS8qIGZsYWc6IHVzZSBhdXRvIERNQSBvbmx5IGZvciBkaXNrcyAqLw0KIAl1
bnNpZ25lZCBjaGFyIGJ1c19zdGF0ZTsJLyogcG93ZXIgc3RhdGUgb2YgdGhl
IElERSBidXMgKi8NCisJaW50IG1vZGVzX21hcDsJCQkvKiBtYXAgb2Ygc3Vw
cG9ydGVkIHRyYW5zZmVyIG1vZGVzICovDQogfTsNCiANCiAvKg0KZGlmZiAt
dXIgbGludXgtMi41LjI0L2RyaXZlcnMvaWRlL2FlYzYyeHguYyBsaW51eC9k
cml2ZXJzL2lkZS9hZWM2Mnh4LmMNCi0tLSBsaW51eC0yLjUuMjQvZHJpdmVy
cy9pZGUvYWVjNjJ4eC5jCU1vbiBKdW4gMjQgMjI6MTU6MTggMjAwMg0KKysr
IGxpbnV4L2RyaXZlcnMvaWRlL2FlYzYyeHguYwlNb24gSnVuIDI0IDIyOjI0
OjMwIDIwMDINCkBAIC0xNjIsMTQgKzE2MiwyNCBAQA0KICNpZmRlZiBDT05G
SUdfQkxLX0RFVl9JREVETUENCiBzdGF0aWMgaW50IGFlYzYyeHhfdWRtYV9z
ZXR1cChzdHJ1Y3QgYXRhX2RldmljZSAqZHJpdmUpDQogew0KLQl1MzIgYm1p
ZGUgPSBwY2lfcmVzb3VyY2Vfc3RhcnQoZHJpdmUtPmNoYW5uZWwtPnBjaV9k
ZXYsIDQpOw0KIAlzaG9ydCBzcGVlZDsNCisNCisJc3BlZWQgPSBhdGFfdGlt
aW5nX21vZGUoZHJpdmUsIGRyaXZlLT5jaGFubmVsLT5tb2Rlc19tYXApOw0K
KwlhZWNfc2V0X2RyaXZlKGRyaXZlLCBzcGVlZCk7DQorCXVkbWFfZW5hYmxl
KGRyaXZlLCBkcml2ZS0+Y2hhbm5lbC0+YXV0b2RtYSAmJiAoc3BlZWQgJiBY
RkVSX01PREUpICE9IFhGRVJfUElPLCAwKTsNCisNCisJcmV0dXJuIDA7DQor
fQ0KKw0KK3N0YXRpYyBpbnQgX19pbml0IGFlYzYyeHhfbW9kZXNfbWFwKHN0
cnVjdCBhdGFfY2hhbm5lbCAqY2gpDQorew0KKwl1MzIgYm1pZGUgPSBwY2lf
cmVzb3VyY2Vfc3RhcnQoY2gtPnBjaV9kZXYsIDQpOw0KIAlpbnQgbWFwOw0K
IA0KLQltYXAgPSBYRkVSX1BJTyB8IFhGRVJfRVBJTyB8IFhGRVJfTVdETUEg
fCBYRkVSX1VETUEgfCBYRkVSX1NXRE1BIHwgWEZFUl9VRE1BOw0KKwltYXAg
PSBYRkVSX0VQSU8gfCBYRkVSX1NXRE1BIHwgWEZFUl9NV0RNQSB8IFhGRVJf
VURNQTsNCiANCi0JaWYgKGRyaXZlLT5jaGFubmVsLT51ZG1hX2ZvdXIpDQot
CQlzd2l0Y2ggKGRyaXZlLT5jaGFubmVsLT5wY2lfZGV2LT5kZXZpY2UpIHsN
CisJaWYgKGNoLT51ZG1hX2ZvdXIpDQorCQlzd2l0Y2ggKGNoLT5wY2lfZGV2
LT5kZXZpY2UpIHsNCiAJCQljYXNlIFBDSV9ERVZJQ0VfSURfQVJUT1BfQVRQ
ODY1UjoNCiAJCQljYXNlIFBDSV9ERVZJQ0VfSURfQVJUT1BfQVRQODY1Og0K
IAkJCQkvKiBDYW4ndCB1c2UgdGhlc2UgbW9kZXMgc2ltdWx0YW5lb3VzbHks
DQpAQCAtMTgwLDExICsxOTAsNyBAQA0KIAkJCQltYXAgfD0gWEZFUl9VRE1B
XzY2Ow0KIAkJfQ0KIA0KLQlzcGVlZCA9IGF0YV90aW1pbmdfbW9kZShkcml2
ZSwgbWFwKTsNCi0JYWVjX3NldF9kcml2ZShkcml2ZSwgc3BlZWQpOw0KLQl1
ZG1hX2VuYWJsZShkcml2ZSwgZHJpdmUtPmNoYW5uZWwtPmF1dG9kbWEgJiYg
KHNwZWVkICYgWEZFUl9NT0RFKSAhPSBYRkVSX1BJTywgMCk7DQotDQotCXJl
dHVybiAwOw0KKwlyZXR1cm4gbWFwOw0KIH0NCiAjZW5kaWYNCiANCkBAIC0y
NjksNiArMjc1LDcgQEANCiAjaWZkZWYgQ09ORklHX0JMS19ERVZfSURFRE1B
DQogCWlmIChjaC0+ZG1hX2Jhc2UpIHsNCiAJCWNoLT5oaWdobWVtID0gMTsN
CisJCWNoLT5tb2Rlc19tYXAgPSBhZWM2Mnh4X21vZGVzX21hcChjaCk7DQog
CQljaC0+dWRtYV9zZXR1cCA9IGFlYzYyeHhfdWRtYV9zZXR1cDsNCiAjaWZk
ZWYgQ09ORklHX0lERURNQV9BVVRPDQogCQlpZiAoIW5vYXV0b2RtYSkNCmRp
ZmYgLXVyIGxpbnV4LTIuNS4yNC9kcml2ZXJzL2lkZS9hbGltMTV4My5jIGxp
bnV4L2RyaXZlcnMvaWRlL2FsaW0xNXgzLmMNCi0tLSBsaW51eC0yLjUuMjQv
ZHJpdmVycy9pZGUvYWxpbTE1eDMuYwlNb24gSnVuIDI0IDIyOjE1OjE4IDIw
MDINCisrKyBsaW51eC9kcml2ZXJzL2lkZS9hbGltMTV4My5jCU1vbiBKdW4g
MjQgMjI6MjQ6MzAgMjAwMg0KQEAgLTk5LDYgKzk5LDcgQEANCiAJX19yZXN0
b3JlX2ZsYWdzKGZsYWdzKTsNCiB9DQogDQorLyogRklYTUU6IHVuZm9sZCAg
LS1ia3ogKi8NCiBzdGF0aWMgYnl0ZSBhbGkxNXgzX2Nhbl91bHRyYShzdHJ1
Y3QgYXRhX2RldmljZSAqZHJpdmUpDQogew0KIAlpZiAobTUyMjlfcmV2aXNp
b24gPD0gMHgyMCkgew0KQEAgLTExNiwyNiArMTE3LDYgQEANCiAJfQ0KIH0N
CiANCi1zdGF0aWMgaW50IGFsaTE1eDNfcmF0ZW1hc2soc3RydWN0IGF0YV9k
ZXZpY2UgKmRyaXZlKQ0KLXsNCi0JaW50IG1hcCA9IDA7DQotDQotCWlmICgh
YWxpMTV4M19jYW5fdWx0cmEoZHJpdmUpKQ0KLQkJcmV0dXJuIDA7DQotDQot
CW1hcCB8PSBYRkVSX1VETUE7DQotDQotCWlmICghZWlnaHR5X25pbnR5X3Ro
cmVlKGRyaXZlKSkNCi0JCXJldHVybiBtYXA7DQotDQotCWlmIChtNTIyOV9y
ZXZpc2lvbiA+PSAweEM0KQ0KLQkJbWFwIHw9IFhGRVJfVURNQV8xMDA7DQot
CWlmIChtNTIyOV9yZXZpc2lvbiA+PSAweEMyKQ0KLQkJbWFwIHw9IFhGRVJf
VURNQV82NjsNCi0NCi0JcmV0dXJuIG1hcDsNCi19DQotDQogc3RhdGljIGlu
dCBhbGkxNXgzX3R1bmVfY2hpcHNldChzdHJ1Y3QgYXRhX2RldmljZSAqZHJp
dmUsIGJ5dGUgc3BlZWQpDQogew0KIAlzdHJ1Y3QgcGNpX2RldiAqZGV2ID0g
ZHJpdmUtPmNoYW5uZWwtPnBjaV9kZXY7DQpAQCAtMTU2LDYgKzEzNyw3IEBA
DQogCWlmIChzcGVlZCA8IFhGRVJfU1dfRE1BXzApDQogCQlhbGkxNXgzX3R1
bmVfZHJpdmUoZHJpdmUsIHNwZWVkKTsNCiAjaWZkZWYgQ09ORklHX0JMS19E
RVZfSURFRE1BDQorCS8qIEZJWE1FOiBubyBzdXBwb3J0IGZvciBNV0RNQSBh
bmQgU1dETUEgbW9kZXMgIC0tYmt6ICovDQogCWVsc2UgaWYgKHNwZWVkID49
IFhGRVJfVURNQV8wKSB7DQogCQlwY2lfcmVhZF9jb25maWdfYnl0ZShkZXYs
IG01MjI5X3VkbWEsICZ0bXBieXRlKTsNCiAJCXRtcGJ5dGUgJj0gKDB4MGYg
PDwgKCgxLXVuaXQpIDw8IDIpKTsNCkBAIC0xNzgsMTUgKzE2MCwxNyBAQA0K
ICNpZmRlZiBDT05GSUdfQkxLX0RFVl9JREVETUENCiBzdGF0aWMgaW50IGNv
bmZpZ19jaGlwc2V0X2Zvcl9kbWEoc3RydWN0IGF0YV9kZXZpY2UgKmRyaXZl
LCB1OCB1ZG1hKQ0KIHsNCi0JaW50IG1hcDsNCisJaW50IG1hcCA9IGRyaXZl
LT5jaGFubmVsLT5tb2Rlc19tYXA7DQogCXU4IG1vZGU7DQogDQotCWlmICh1
ZG1hKQ0KLQkJbWFwID0gYWxpMTV4M19yYXRlbWFzayhkcml2ZSk7DQotCWVs
c2UNCi0JCW1hcCA9IFhGRVJfU1dETUEgfCBYRkVSX01XRE1BOw0KKwlpZiAo
IWVpZ2h0eV9uaW50eV90aHJlZShkcml2ZSkpDQorCQltYXAgJj0gflhGRVJf
VURNQV84MFc7DQorDQorCWlmICghdWRtYSkNCisJCW1hcCAmPSB+WEZFUl9V
RE1BX0FMTDsNCiANCiAJbW9kZSA9IGF0YV90aW1pbmdfbW9kZShkcml2ZSwg
bWFwKTsNCisNCiAJaWYgKG1vZGUgPCBYRkVSX1NXX0RNQV8wKQ0KIAkJcmV0
dXJuIDA7DQogDQpAQCAtMjYyLDYgKzI0NiwyNCBAQA0KIA0KIAlyZXR1cm4g
dWRtYV9wY2lfaW5pdChkcml2ZSwgcnEpOw0KIH0NCisNCitzdGF0aWMgaW50
IF9faW5pdCBhbGkxNXgzX21vZGVzX21hcChzdHJ1Y3QgYXRhX2NoYW5uZWwg
KmNoKQ0KK3sNCisJaW50IG1hcCA9IFhGRVJfRVBJTyB8IFhGRVJfU1dETUEg
fCBYRkVSX01XRE1BOw0KKw0KKwlpZiAoIWFsaTE1eDNfY2FuX3VsdHJhKGNo
LT5kcml2ZSkpDQorCQlyZXR1cm4gbWFwOw0KKw0KKwltYXAgfD0gWEZFUl9V
RE1BOw0KKw0KKwlpZiAobTUyMjlfcmV2aXNpb24gPj0gMHhDMikgew0KKwkJ
bWFwIHw9IFhGRVJfVURNQV82NjsNCisJCWlmIChtNTIyOV9yZXZpc2lvbiA+
PSAweEM0KQ0KKwkJCW1hcCB8PSBYRkVSX1VETUFfMTAwOw0KKwl9DQorDQor
CXJldHVybiBtYXA7DQorfQ0KICNlbmRpZg0KIA0KIHN0YXRpYyB1bnNpZ25l
ZCBpbnQgX19pbml0IGFsaTE1eDNfaW5pdF9jaGlwc2V0KHN0cnVjdCBwY2lf
ZGV2ICpkZXYpDQpAQCAtNDM2LDYgKzQzOCw3IEBADQogCQkvKg0KIAkJICog
TTE1NDNDIG9yIG5ld2VyIGZvciBETUFpbmcNCiAJCSAqLw0KKwkJaHdpZi0+
bW9kZXNfbWFwID0gYWxpMTV4M19tb2Rlc19tYXAoaHdpZik7DQogCQlod2lm
LT51ZG1hX2luaXQgPSBhbGkxNXgzX3VkbWFfaW5pdDsNCiAJCWh3aWYtPnVk
bWFfc2V0dXAgPSBhbGkxNXgzX3VkbWFfc2V0dXA7DQogCQlod2lmLT5hdXRv
ZG1hID0gMTsNCmRpZmYgLXVyIGxpbnV4LTIuNS4yNC9kcml2ZXJzL2lkZS9h
dGEtdGltaW5nLmggbGludXgvZHJpdmVycy9pZGUvYXRhLXRpbWluZy5oDQot
LS0gbGludXgtMi41LjI0L2RyaXZlcnMvaWRlL2F0YS10aW1pbmcuaAlNb24g
SnVuIDI0IDIyOjE1OjEyIDIwMDINCisrKyBsaW51eC9kcml2ZXJzL2lkZS9h
dGEtdGltaW5nLmgJTW9uIEp1biAyNCAyMjoyNDozMCAyMDAyDQpAQCAtNjks
NiArNjksOSBAQA0KICNkZWZpbmUgWEZFUl9FUElPCTB4MDENCiAjZGVmaW5l
IFhGRVJfUElPCTB4MDANCiANCisjZGVmaW5lIFhGRVJfVURNQV9BTEwJMHg0
ZQ0KKyNkZWZpbmUgWEZFUl9VRE1BXzgwVwkweDBlDQorDQogLyogRXh0ZXJu
YWwgaW50ZXJmYWNlIHRvIGhvc3QgY2hpcHMgY2hhbm5lbCB0aW1pbmcgc2V0
dXAuDQogICoNCiAgKiBJdCdzIGEgYml0IGVsYWJvcmF0ZSBkdWUgdG8gdGhl
IGxlZ2FjeSB3ZSBoYXZlIHRvIGJlYXIuDQpkaWZmIC11ciBsaW51eC0yLjUu
MjQvZHJpdmVycy9pZGUvY21kNjR4LmMgbGludXgvZHJpdmVycy9pZGUvY21k
NjR4LmMNCi0tLSBsaW51eC0yLjUuMjQvZHJpdmVycy9pZGUvY21kNjR4LmMJ
TW9uIEp1biAyNCAyMjoyMTowMSAyMDAyDQorKysgbGludXgvZHJpdmVycy9p
ZGUvY21kNjR4LmMJTW9uIEp1biAyNCAyMjoyNTozMiAyMDAyDQpAQCAtMjE3
LDEwICsyMTcsMTAgQEANCiAJaWRlX2NvbmZpZ19kcml2ZV9zcGVlZChkcml2
ZSwgc3BlZWQpOw0KIH0NCiANCi1zdGF0aWMgaW50IGNtZDY0eF9yYXRlbWFz
ayhzdHJ1Y3QgYXRhX2RldmljZSAqZHJpdmUpDQorc3RhdGljIGludCBfX2lu
aXQgY21kNnh4X21vZGVzX21hcChzdHJ1Y3QgYXRhX2NoYW5uZWwgKmNoKQ0K
IHsNCi0Jc3RydWN0IHBjaV9kZXYgKmRldiA9IGRyaXZlLT5jaGFubmVsLT5w
Y2lfZGV2Ow0KLQlpbnQgbWFwID0gMDsNCisJc3RydWN0IHBjaV9kZXYgKmRl
diA9IGNoLT5wY2lfZGV2Ow0KKwlpbnQgbWFwID0gWEZFUl9FUElPIHwgWEZF
Ul9TV0RNQSB8IFhGRVJfTVdETUE7DQogDQogCXN3aXRjaChkZXYtPmRldmlj
ZSkgew0KIAkJY2FzZSBQQ0lfREVWSUNFX0lEX0NNRF82ODA6DQpAQCAtMjM0
LDEwICsyMzQsOSBAQA0KIAkJCWJyZWFrOw0KIAkJY2FzZSBQQ0lfREVWSUNF
X0lEX0NNRF82NDY6DQogCQl7DQotCQkJdTMyIGNsYXNzX3JldjsNCi0JCQlw
Y2lfcmVhZF9jb25maWdfZHdvcmQoZGV2LA0KLQkJCQlQQ0lfQ0xBU1NfUkVW
SVNJT04sICZjbGFzc19yZXYpOw0KLQkJCWNsYXNzX3JldiAmPSAweGZmOw0K
KwkJCXUzMiByZXY7DQorCQkJcGNpX3JlYWRfY29uZmlnX2R3b3JkKGRldiwg
UENJX0NMQVNTX1JFVklTSU9OLCAmcmV2KTsNCisJCQlyZXYgJj0gMHhmZjsN
CiAJCS8qDQogCQkgKiBVbHRyYURNQSBvbmx5IHN1cHBvcnRlZCBvbiBQQ0k2
NDZVIGFuZCBQQ0k2NDZVMiwgd2hpY2gNCiAJCSAqIGNvcnJlc3BvbmQgdG8g
cmV2aXNpb25zIDB4MDMsIDB4MDUgYW5kIDB4MDcgcmVzcGVjdGl2ZWx5Lg0K
QEAgLTI1MCw3ICsyNDksNyBAQA0KIAkJICoNCiAJCSAqIFNvIHdlIG9ubHkg
ZG8gVWx0cmFETUEgb24gcmV2aXNpb24gMHgwNSBhbmQgMHgwNyBjaGlwc2V0
cy4NCiAJCSAqLw0KLQkJCXN3aXRjaChjbGFzc19yZXYpIHsNCisJCQlzd2l0
Y2gocmV2KSB7DQogCQkJCWNhc2UgMHgwNzoNCiAJCQkJY2FzZSAweDA1Og0K
IAkJCQkJbWFwIHw9IFhGRVJfVURNQTsNCkBAIC0yNjAsMTEgKzI1OSw2IEBA
DQogCQl9DQogCX0NCiANCi0JaWYgKCFlaWdodHlfbmludHlfdGhyZWUoZHJp
dmUpKSB7DQotCQlpZiAobWFwICYgWEZFUl9VRE1BKQ0KLQkJCXJldHVybiBY
RkVSX1VETUE7DQotCQlyZXR1cm4gMDsNCi0JfQ0KIAlyZXR1cm4gbWFwOw0K
IH0NCiANCkBAIC01MjAsMTAgKzUxNCwxMyBAQA0KIAlpbnQgbWFwOw0KIAl1
OCBtb2RlOw0KIA0KLQlpZiAodWRtYSkNCi0JCW1hcCA9IGNtZDY0eF9yYXRl
bWFzayhkcml2ZSk7DQotCWVsc2UNCi0JCW1hcCA9IFhGRVJfU1dETUEgfCBY
RkVSX01XRE1BOw0KKwltYXAgPSBkcml2ZS0+Y2hhbm5lbC0+bW9kZXNfbWFw
Ow0KKw0KKwlpZiAoIWVpZ2h0eV9uaW50eV90aHJlZShkcml2ZSkpDQorCQlt
YXAgJj0gflhGRVJfVURNQV84MFc7DQorDQorCWlmICghdWRtYSkNCisJCW1h
cCAmPSB+WEZFUl9VRE1BX0FMTDsNCiANCiAJbW9kZSA9IGF0YV90aW1pbmdf
bW9kZShkcml2ZSwgbWFwKTsNCiANCkBAIC04ODcsNiArODg0LDcgQEANCiAj
aWZkZWYgQ09ORklHX0JMS19ERVZfSURFRE1BDQogCWlmIChod2lmLT5kbWFf
YmFzZSkgew0KIAkJaHdpZi0+aGlnaG1lbSA9IDE7DQorCQlod2lmLT5tb2Rl
c19tYXAgPSBjbWQ2eHhfbW9kZXNfbWFwKGh3aWYpOw0KICMgaWZkZWYgQ09O
RklHX0lERURNQV9BVVRPDQogCQlpZiAoIW5vYXV0b2RtYSkNCiAJCQlod2lm
LT5hdXRvZG1hID0gMTsNCmRpZmYgLXVyIGxpbnV4LTIuNS4yNC9kcml2ZXJz
L2lkZS9ocHQzNjYuYyBsaW51eC9kcml2ZXJzL2lkZS9ocHQzNjYuYw0KLS0t
IGxpbnV4LTIuNS4yNC9kcml2ZXJzL2lkZS9ocHQzNjYuYwlNb24gSnVuIDI0
IDIyOjIxOjAxIDIwMDINCisrKyBsaW51eC9kcml2ZXJzL2lkZS9ocHQzNjYu
YwlNb24gSnVuIDI0IDIyOjI0OjMwIDIwMDINCkBAIC00OTMsMzcgKzQ5Mywy
MyBAQA0KIAlyZXR1cm4gY2xhc3NfcmV2Ow0KIH0NCiANCi1zdGF0aWMgaW50
IGhwdDN4eF9yYXRlbWFzayhzdHJ1Y3QgYXRhX2RldmljZSAqZHJpdmUpDQor
c3RhdGljIGludCBfX2luaXQgaHB0M3h4X21vZGVzX21hcChzdHJ1Y3QgYXRh
X2NoYW5uZWwgKmNoKQ0KIHsNCi0JdTMyIHJldiA9IGhwdF9yZXZpc2lvbihk
cml2ZS0+Y2hhbm5lbC0+cGNpX2Rldik7DQotCWludCBtYXAgPSBYRkVSX1VE
TUE7DQorCXUzMiByZXYgPSBocHRfcmV2aXNpb24oY2gtPnBjaV9kZXYpOw0K
KwlpbnQgbWFwID0gWEZFUl9FUElPIHwgWEZFUl9NV0RNQSB8IFhGRVJfVURN
QSB8IFhGRVJfVURNQV82NjsNCiANCiAJaWYgKHJldiA+PSA4KSB7CQkJCQkv
KiBIUFQzNzQgKi8NCiAJCWlmIChIUFQzNzRfQUxMT1dfQVRBMTMzXzYpDQog
CQkJbWFwIHw9IFhGRVJfVURNQV8xMzM7DQotCQltYXAgfD0gKFhGRVJfVURN
QV8xMDAgfCBYRkVSX1VETUFfNjYpOw0KKwkJbWFwIHw9IFhGRVJfVURNQV8x
MDA7DQogCX0gZWxzZSBpZiAocmV2ID49IDUpIHsJCQkJLyogSFBUMzcyICov
DQogCQlpZiAoSFBUMzcyX0FMTE9XX0FUQTEzM182KQ0KIAkJCW1hcCB8PSBY
RkVSX1VETUFfMTMzOw0KLQkJbWFwIHw9IChYRkVSX1VETUFfMTAwIHwgWEZF
Ul9VRE1BXzY2KTsNCi0JfSBlbHNlIGlmIChyZXYgPj0gNCkgewkJCQkvKiBI
UFQzNzBBICovDQorCQltYXAgfD0gWEZFUl9VRE1BXzEwMDsNCisJfSBlbHNl
IGlmIChyZXYgPj0gMykgewkJCQkvKiBIUFQzNzBBIC8gSFBUMzcwICovDQog
CQlpZiAoSFBUMzcwX0FMTE9XX0FUQTEwMF81KQ0KIAkJCW1hcCB8PSBYRkVS
X1VETUFfMTAwOw0KLQkJbWFwIHw9IFhGRVJfVURNQV82NjsNCi0JfSBlbHNl
IGlmIChyZXYgPj0gMykgewkJCQkvKiBIUFQzNzAgKi8NCi0JCWlmIChIUFQz
NzBfQUxMT1dfQVRBMTAwXzUpDQotCQkJbWFwIHw9IFhGRVJfVURNQV8xMDA7
DQotCQltYXAgfD0gWEZFUl9VRE1BXzY2Ow0KLQkJaWYgKGNoZWNrX2luX2Ry
aXZlX2xpc3RzKGRyaXZlLCBiYWRfYXRhMzMpKQ0KLQkJCXJldHVybiAwOw0K
LQl9IGVsc2UgewkJCQkJLyogSFBUMzY2IGFuZCBIUFQzNjggKi8NCi0JCW1h
cCB8PSBYRkVSX1VETUFfNjY7DQotCQlpZiAoY2hlY2tfaW5fZHJpdmVfbGlz
dHMoZHJpdmUsIGJhZF9hdGEzMykpDQotCQkJcmV0dXJuIDA7DQotCX0NCi0N
Ci0JaWYgKCFlaWdodHlfbmludHlfdGhyZWUoZHJpdmUpKQ0KLQkJcmV0dXJu
IFhGRVJfVURNQTsNCisJfQkJCQkJCS8qIEhQVDM2NiAvIEhQVDM2OCAqLw0K
IA0KIAlyZXR1cm4gbWFwOw0KIH0NCkBAIC02NzksOCArNjY1LDExIEBADQog
DQogCXJldiA9IGhwdF9yZXZpc2lvbihkcml2ZS0+Y2hhbm5lbC0+cGNpX2Rl
dik7DQogDQotCS8qIEZJWE1FOiBjaGVjayBTV0RNQSBtb2RlcyAtLWJreiAq
Lw0KLQltYXAgPSBocHQzeHhfcmF0ZW1hc2soZHJpdmUpIHwgWEZFUl9NV0RN
QTsNCisJbWFwID0gZHJpdmUtPmNoYW5uZWwtPm1vZGVzX21hcDsNCisNCisJ
aWYgKCFlaWdodHlfbmludHlfdGhyZWUoZHJpdmUpKQ0KKwkJbWFwICY9IH5Y
RkVSX1VETUFfODBXOw0KKw0KIAltb2RlID0gYXRhX3RpbWluZ19tb2RlKGRy
aXZlLCBtYXApOw0KIA0KIAkvKiBGSVhNRTogYmFkbGlzdHMgbmVlZCBmdXRo
ZXIgaW52ZXN0aWdhdGlvbiAtLWJreg0KQEAgLTEyNzIsNiArMTI2MSw3IEBA
DQogLy8JCQljaC0+cmVzZXRwcm9jID0gaHB0M3h4X3Jlc2V0Ow0KIC8vCQkJ
Y2gtPmJ1c3Byb2MgPSBocHQzeHhfdHJpc3RhdGU7DQogCQl9DQorCQljaC0+
bW9kZXNfbWFwID0gaHB0M3h4X21vZGVzX21hcChjaCk7DQogCQljaC0+dWRt
YV9zZXR1cCA9IGhwdDN4eF91ZG1hX3NldHVwOw0KIA0KIAkJaWYgKCFub2F1
dG9kbWEpDQpkaWZmIC11ciBsaW51eC0yLjUuMjQvZHJpdmVycy9pZGUvcGRj
MjAyeHguYyBsaW51eC9kcml2ZXJzL2lkZS9wZGMyMDJ4eC5jDQotLS0gbGlu
dXgtMi41LjI0L2RyaXZlcnMvaWRlL3BkYzIwMnh4LmMJTW9uIEp1biAyNCAy
MjoyMTowMSAyMDAyDQorKysgbGludXgvZHJpdmVycy9pZGUvcGRjMjAyeHgu
YwlNb24gSnVuIDI0IDIyOjI0OjMwIDIwMDINCkBAIC0xMjksMjEgKzEyOSwx
OCBAQA0KIAlyZXR1cm4gMDsNCiB9DQogDQotc3RhdGljIGludCBwZGMyMDJ4
eF9yYXRlbWFzayhzdHJ1Y3QgYXRhX2RldmljZSAqZHJpdmUpDQorc3RhdGlj
IGludCBfX2luaXQgcGRjMjAyeHhfbW9kZXNfbWFwKHN0cnVjdCBhdGFfY2hh
bm5lbCAqY2gpDQogew0KLQlzdHJ1Y3QgcGNpX2RldiAqZGV2ID0gZHJpdmUt
PmNoYW5uZWwtPnBjaV9kZXY7DQotCWludCBtYXAgPSAwOw0KLQ0KLQlpZiAo
IWVpZ2h0eV9uaW50eV90aHJlZShkcml2ZSkpDQotCQlyZXR1cm4gWEZFUl9V
RE1BOw0KKwlpbnQgbWFwID0gWEZFUl9FUElPIHwgWEZFUl9TV0RNQSB8IFhG
RVJfTVdETUE7DQogDQotCXN3aXRjaChkZXYtPmRldmljZSkgew0KKwlzd2l0
Y2goY2gtPnBjaV9kZXYtPmRldmljZSkgew0KIAkJY2FzZSBQQ0lfREVWSUNF
X0lEX1BST01JU0VfMjAyNzY6DQogCQljYXNlIFBDSV9ERVZJQ0VfSURfUFJP
TUlTRV8yMDI3NToNCiAJCWNhc2UgUENJX0RFVklDRV9JRF9QUk9NSVNFXzIw
MjY5Og0KIAkJCW1hcCB8PSBYRkVSX1VETUFfMTMzOw0KIAkJY2FzZSBQQ0lf
REVWSUNFX0lEX1BST01JU0VfMjAyNjhSOg0KIAkJY2FzZSBQQ0lfREVWSUNF
X0lEX1BST01JU0VfMjAyNjg6DQorCQkJbWFwICY9IH5YRkVSX1NXRE1BOw0K
IAkJY2FzZSBQQ0lfREVWSUNFX0lEX1BST01JU0VfMjAyNjc6DQogCQljYXNl
IFBDSV9ERVZJQ0VfSURfUFJPTUlTRV8yMDI2NToNCiAJCQltYXAgfD0gWEZF
Ul9VRE1BXzEwMDsNCkBAIC0xNTIsNiArMTQ5LDcgQEANCiAJCWNhc2UgUENJ
X0RFVklDRV9JRF9QUk9NSVNFXzIwMjQ2Og0KIAkJCW1hcCB8PSBYRkVSX1VE
TUE7DQogCX0NCisNCiAJcmV0dXJuIG1hcDsNCiB9DQogDQpAQCAtNDc5LDE0
ICs0NzcsMTMgQEANCiAJCQlwY2lfd3JpdGVfY29uZmlnX2J5dGUoZGV2LCBk
cml2ZV9wY2ksIEFQfFBSRUZFVENIX0VOKTsNCiAJfQ0KIA0KLQlpZiAodWRt
YSkgew0KLQkJbWFwID0gcGRjMjAyeHhfcmF0ZW1hc2soZHJpdmUpOw0KLQl9
IGVsc2Ugew0KLQkJaWYgKCFqdW1wYml0KQ0KLQkJCW1hcCA9IFhGRVJfU1dE
TUEgfCBYRkVSX01XRE1BOw0KLQkJZWxzZQ0KLQkJCW1hcCA9IFhGRVJfTVdE
TUE7DQotCX0NCisJbWFwID0gaHdpZi0+bW9kZXNfbWFwOw0KKw0KKwlpZiAo
IWVpZ2h0eV9uaW50eV90aHJlZShkcml2ZSkpDQorCQltYXAgJj0gflhGRVJf
VURNQV84MFc7DQorDQorCWlmICghdWRtYSkNCisJCW1hcCAmPSB+WEZFUl9V
RE1BX0FMTDsNCiANCiAJbW9kZSA9IGF0YV90aW1pbmdfbW9kZShkcml2ZSwg
bWFwKTsNCiAJaWYgKG1vZGUgPCBYRkVSX1NXX0RNQV8wKSB7DQpAQCAtNzQ4
LDYgKzc0NSw3IEBADQogDQogI2lmZGVmIENPTkZJR19CTEtfREVWX0lERURN
QQ0KIAlpZiAoaHdpZi0+ZG1hX2Jhc2UpIHsNCisJCWh3aWYtPm1vZGVzX21h
cCA9IHBkYzIwMnh4X21vZGVzX21hcChod2lmKTsNCiAJCWh3aWYtPnVkbWFf
aXJxX2xvc3QgPSBwZGMyMDJ4eF9idWc7DQogCQlod2lmLT51ZG1hX3RpbWVv
dXQgPSBwZGMyMDJ4eF9idWc7DQogCQlod2lmLT51ZG1hX3NldHVwID0gcGRj
MjAyeHhfdWRtYV9zZXR1cDsNCmRpZmYgLXVyIGxpbnV4LTIuNS4yNC9kcml2
ZXJzL2lkZS9zZXJ2ZXJ3b3Jrcy5jIGxpbnV4L2RyaXZlcnMvaWRlL3NlcnZl
cndvcmtzLmMNCi0tLSBsaW51eC0yLjUuMjQvZHJpdmVycy9pZGUvc2VydmVy
d29ya3MuYwlNb24gSnVuIDI0IDIyOjIxOjAxIDIwMDINCisrKyBsaW51eC9k
cml2ZXJzL2lkZS9zZXJ2ZXJ3b3Jrcy5jCU1vbiBKdW4gMjQgMjI6MjY6NTUg
MjAwMg0KQEAgLTEwMywxNSArMTAzLDExIEBADQogDQogc3RhdGljIHN0cnVj
dCBwY2lfZGV2ICppc2FfZGV2Ow0KIA0KLXN0YXRpYyBpbnQgc3Z3a3NfcmF0
ZW1hc2soc3RydWN0IGF0YV9kZXZpY2UgKmRyaXZlKQ0KK3N0YXRpYyBpbnQg
X19pbml0IHN2d2tzX21vZGVzX21hcChzdHJ1Y3QgYXRhX2NoYW5uZWwgKmNo
KQ0KIHsNCi0Jc3RydWN0IHBjaV9kZXYgKmRldiA9IGRyaXZlLT5jaGFubmVs
LT5wY2lfZGV2Ow0KLQlpbnQgbWFwID0gMDsNCisJaW50IG1hcCA9IFhGRVJf
RVBJTyB8IFhGRVJfTVdETUE7DQogDQotCWlmICghZWlnaHR5X25pbnR5X3Ro
cmVlKGRyaXZlKSkNCi0JCXJldHVybiBYRkVSX1VETUE7DQotDQotCXN3aXRj
aChkZXYtPmRldmljZSkgew0KKwlzd2l0Y2goY2gtPnBjaV9kZXYtPmRldmlj
ZSkgew0KIAkJY2FzZSBQQ0lfREVWSUNFX0lEX1NFUlZFUldPUktTX0NTQjVJ
REU6DQogCQkJaWYgKHN2d2tzX3JldmlzaW9uID49IFNWV0tTX0NTQjVfUkVW
SVNJT05fTkVXKQ0KIAkJCQltYXAgfD0gWEZFUl9VRE1BXzEwMDsNCkBAIC0x
MjAsNiArMTE2LDcgQEANCiAJCQltYXAgfD0gWEZFUl9VRE1BOw0KIAkJCWJy
ZWFrOw0KIAl9DQorDQogCXJldHVybiBtYXA7DQogfQ0KIA0KQEAgLTE3Niw2
ICsxNzMsNyBAQA0KIAkJCWNzYjVfcGlvICAgfD0gKChzcGVlZCAtIFhGRVJf
UElPXzApIDw8ICg0KmRyaXZlLT5kbikpOw0KIAkJCWJyZWFrOw0KIA0KKwkJ
LyogRklYTUU6IGNoZWNrIFNXRE1BIG1vZGVzICAtLWJreiAqLw0KICNpZmRl
ZiBDT05GSUdfQkxLX0RFVl9JREVETUENCiAJCWNhc2UgWEZFUl9NV19ETUFf
MjoNCiAJCWNhc2UgWEZFUl9NV19ETUFfMToNCkBAIC0yMzIsMTEgKzIzMCwx
MiBAQA0KICNpZmRlZiBDT05GSUdfQkxLX0RFVl9JREVETUENCiBzdGF0aWMg
aW50IGNvbmZpZ19jaGlwc2V0X2Zvcl9kbWEoc3RydWN0IGF0YV9kZXZpY2Ug
KmRyaXZlKQ0KIHsNCi0JaW50IG1hcDsNCisJaW50IG1hcCA9IGRyaXZlLT5j
aGFubmVsLT5tb2Rlc19tYXA7DQogCXU4IG1vZGU7DQogDQotCS8qIEZJWE1F
OiBjaGVjayBTV0RNQSBtb2RlcyAtLWJreiAqLw0KLQltYXAgPSBYRkVSX01X
RE1BIHwgc3Z3a3NfcmF0ZW1hc2soZHJpdmUpOw0KKwlpZiAoIWVpZ2h0eV9u
aW50eV90aHJlZShkcml2ZSkpDQorCQltYXAgJj0gflhGRVJfVURNQV84MFc7
DQorDQogCW1vZGUgPSBhdGFfdGltaW5nX21vZGUoZHJpdmUsIG1hcCk7DQog
DQogCXJldHVybiAhc3Z3a3NfdHVuZV9jaGlwc2V0KGRyaXZlLCBtb2RlKTsN
CkBAIC00NTAsNiArNDQ5LDcgQEANCiAJCWlmICghbm9hdXRvZG1hKQ0KIAkJ
CWh3aWYtPmF1dG9kbWEgPSAxOw0KICNlbmRpZg0KKwkJaHdpZi0+bW9kZXNf
bWFwID0gc3Z3a3NfbW9kZXNfbWFwKGh3aWYpOw0KIAkJaHdpZi0+dWRtYV9z
dG9wID0gc3Z3a3NfdWRtYV9zdG9wOw0KIAkJaHdpZi0+dWRtYV9zZXR1cCA9
IHN2d2tzX3VkbWFfc2V0dXA7DQogCQlod2lmLT5oaWdobWVtID0gMTsNCmRp
ZmYgLXVyIGxpbnV4LTIuNS4yNC9kcml2ZXJzL2lkZS9zaXM1NTEzLmMgbGlu
dXgvZHJpdmVycy9pZGUvc2lzNTUxMy5jDQotLS0gbGludXgtMi41LjI0L2Ry
aXZlcnMvaWRlL3NpczU1MTMuYwlNb24gSnVuIDI0IDIyOjE1OjE4IDIwMDIN
CisrKyBsaW51eC9kcml2ZXJzL2lkZS9zaXM1NTEzLmMJTW9uIEp1biAyNCAy
MjoyNDozMCAyMDAyDQpAQCAtMjA3LDkgKzIwNyw5IEBADQogDQogc3RhdGlj
IHN0cnVjdCBwY2lfZGV2ICpob3N0X2RldiA9IE5VTEw7DQogDQotc3RhdGlj
IGludCBzaXM1NTEzX3JhdGVtYXNrKHN0cnVjdCBhdGFfZGV2aWNlICpkcml2
ZSkNCitzdGF0aWMgaW50IF9faW5pdCBzaXM1NTEzX21vZGVzX21hcChzdHJ1
Y3QgYXRhX2NoYW5uZWwgKmNoKQ0KIHsNCi0JaW50IG1hcCA9IDA7DQorCWlu
dCBtYXAgPSBYRkVSX0VQSU8gfCBYRkVSX1NXRE1BIHwgWEZFUl9NV0RNQTsN
CiANCiAJc3dpdGNoKGNoaXBzZXRfZmFtaWx5KSB7DQogCQljYXNlIEFUQV8x
MzM6CS8qIG1hcCB8PSBYRkVSX1VETUFfMTMzOyAqLw0KQEAgLTIyMSwxNSAr
MjIxLDggQEANCiAJCWNhc2UgQVRBXzMzOg0KIAkJCW1hcCB8PSBYRkVSX1VE
TUE7DQogCQkJYnJlYWs7DQotCQljYXNlIEFUQV8xNjoNCi0JCWNhc2UgQVRB
XzAwOg0KLQkJZGVmYXVsdDoNCi0JCQlyZXR1cm4gMDsNCiAJfQ0KIA0KLQlp
ZiAoIWVpZ2h0eV9uaW50eV90aHJlZShkcml2ZSkpDQotCQlyZXR1cm4gWEZF
Ul9VRE1BOw0KLQ0KIAlyZXR1cm4gbWFwOw0KIH0NCiANCkBAIC00MDcsNyAr
NDAwLDcgQEANCiAjaWZkZWYgQ09ORklHX0JMS19ERVZfSURFRE1BDQogc3Rh
dGljIGludCBjb25maWdfY2hpcHNldF9mb3JfZG1hKHN0cnVjdCBhdGFfZGV2
aWNlICpkcml2ZSwgdTggdWRtYSkNCiB7DQotCWludCBtYXA7DQorCWludCBt
YXAgPSBkcml2ZS0+Y2hhbm5lbC0+bW9kZXNfbWFwOw0KIAl1OCBtb2RlOw0K
IA0KICNpZmRlZiBERUJVRw0KQEAgLTQxNSwxMCArNDA4LDExIEBADQogCSAg
ICAgICBkcml2ZS0+ZG4sIHVkbWEpOw0KICNlbmRpZg0KIA0KLQlpZiAodWRt
YSkNCi0JCW1hcCA9IHNpczU1MTNfcmF0ZW1hc2soZHJpdmUpOw0KLQllbHNl
DQotCQltYXAgPSBYRkVSX1NXRE1BIHwgWEZFUl9NV0RNQTsNCisJaWYgKCFl
aWdodHlfbmludHlfdGhyZWUoZHJpdmUpKQ0KKwkJbWFwICY9IH5YRkVSX1VE
TUFfODBXOw0KKw0KKwlpZiAoIXVkbWEpDQorCQltYXAgJj0gflhGRVJfVURN
QV9BTEw7DQogDQogCW1vZGUgPSBhdGFfdGltaW5nX21vZGUoZHJpdmUsIG1h
cCk7DQogCWlmIChtb2RlIDwgWEZFUl9TV19ETUFfMCkNCkBAIC01ODcsNiAr
NTgxLDcgQEANCiAJCWlmIChjaGlwc2V0X2ZhbWlseSA+IEFUQV8xNikgew0K
IAkJCWh3aWYtPmF1dG9kbWEgPSBub2F1dG9kbWEgPyAwIDogMTsNCiAJCQlo
d2lmLT5oaWdobWVtID0gMTsNCisJCQlod2lmLT5tb2Rlc19tYXAgPSBzaXM1
NTEzX21vZGVzX21hcChod2lmKTsNCiAJCQlod2lmLT51ZG1hX3NldHVwID0g
c2lzNTUxM191ZG1hX3NldHVwOw0KIAkJfSBlbHNlIHsNCiAjZW5kaWYNCg==
---559023410-1804928587-1025032434=:27820--
