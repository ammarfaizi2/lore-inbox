Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S264270AbTKMNvm (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 13 Nov 2003 08:51:42 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S264271AbTKMNvm
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 13 Nov 2003 08:51:42 -0500
Received: from yellow.csi.cam.ac.uk ([131.111.8.67]:36225 "EHLO
	yellow.csi.cam.ac.uk") by vger.kernel.org with ESMTP
	id S264270AbTKMNvg (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Thu, 13 Nov 2003 08:51:36 -0500
Date: Thu, 13 Nov 2003 13:51:35 +0000 (GMT)
From: Anton Altaparmakov <aia21@cam.ac.uk>
To: Linus Torvalds <torvalds@osdl.org>
cc: linux-kernel@vger.kernel.org, linux-ntfs-dev@lists.sourceforge.net
Subject: [PATCH-2.6-test-BK] Fix a bug in the NTFS driver.
Message-ID: <Pine.SOL.4.58.0311131349420.28567@yellow.csi.cam.ac.uk>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Linus, please do a

	bk pull http://linux-ntfs.bkbits.net/ntfs-2.6

This fixes a bug in ntfs that has been reported by at least two people so
far which renders some fragmented files generated by Windows XP
inaccessible from Linux.  This patch has been verified to work correctly
on examples of these files.

Thanks!

Best regards,

	Anton
-- 
Anton Altaparmakov <aia21 at cam.ac.uk> (replace at with @)
Unix Support, Computing Service, University of Cambridge, CB2 3QH, UK
Linux NTFS maintainer / IRC: #ntfs on irc.freenode.net
WWW: http://linux-ntfs.sf.net/, http://www-stu.christs.cam.ac.uk/~aia21/

===================================================================

This will update the following files:

 Documentation/filesystems/ntfs.txt |    4 ++++
 fs/ntfs/ChangeLog                  |    8 ++++++++
 fs/ntfs/Makefile                   |    2 +-
 fs/ntfs/attrib.c                   |   33 +++++++++++++++------------------
 fs/ntfs/attrib.h                   |    2 +-
 5 files changed, 29 insertions(+), 20 deletions(-)

through these ChangeSets:

<aia21@cantab.net> (03/11/11 1.1422.3.1)
   NTFS: Minor bug fix in attribute list attribute handling that fixes the
   I/O errors on "ls" of certain fragmented files found by at least two
   people running Windows XP.


diff -Nru a/Documentation/filesystems/ntfs.txt b/Documentation/filesystems/ntfs.txt
--- a/Documentation/filesystems/ntfs.txt	Thu Nov 13 13:42:28 2003
+++ b/Documentation/filesystems/ntfs.txt	Thu Nov 13 13:42:28 2003
@@ -272,6 +272,10 @@

 Note, a technical ChangeLog aimed at kernel hackers is in fs/ntfs/ChangeLog.

+2.1.5:
+	- Minor bug fix in attribute list attribute handling that fixes the
+	  I/O errors on "ls" of certain fragmented files found by at least two
+	  people running Windows XP.
 2.1.4:
 	- Minor update allowing compilation with all gcc versions (well, the
 	  ones the kernel can be compiled with anyway).
diff -Nru a/fs/ntfs/ChangeLog b/fs/ntfs/ChangeLog
--- a/fs/ntfs/ChangeLog	Thu Nov 13 13:42:28 2003
+++ b/fs/ntfs/ChangeLog	Thu Nov 13 13:42:28 2003
@@ -20,6 +20,14 @@
 	  sufficient for synchronisation here. We then just need to make sure
 	  ntfs_readpage/writepage/truncate interoperate properly with us.

+2.1.5 - Fix minor bug in attribute list attribute handling.
+
+	- Fix bug in attribute list handling.  Actually it is not as much a bug
+	  as too much protection in that we were not allowing attribute lists
+	  which waste space on disk while Windows XP clearly allows it and in
+	  fact creates such attribute lists so our driver was failing.
+	- Update NTFS documentation ready for 2.6 kernel release.
+
 2.1.4 - Reduce compiler requirements.

 	- Remove all uses of unnamed structs and unions in the driver to make
diff -Nru a/fs/ntfs/Makefile b/fs/ntfs/Makefile
--- a/fs/ntfs/Makefile	Thu Nov 13 13:42:28 2003
+++ b/fs/ntfs/Makefile	Thu Nov 13 13:42:28 2003
@@ -5,7 +5,7 @@
 ntfs-objs := aops.o attrib.o compress.o debug.o dir.o file.o inode.o mft.o \
 	     mst.o namei.o super.o sysctl.o time.o unistr.o upcase.o

-EXTRA_CFLAGS = -DNTFS_VERSION=\"2.1.4\"
+EXTRA_CFLAGS = -DNTFS_VERSION=\"2.1.5\"

 ifeq ($(CONFIG_NTFS_DEBUG),y)
 EXTRA_CFLAGS += -DDEBUG
diff -Nru a/fs/ntfs/attrib.c b/fs/ntfs/attrib.c
--- a/fs/ntfs/attrib.c	Thu Nov 13 13:42:28 2003
+++ b/fs/ntfs/attrib.c	Thu Nov 13 13:42:28 2003
@@ -1215,7 +1215,7 @@
  * load_attribute_list - load an attribute list into memory
  * @vol:		ntfs volume from which to read
  * @run_list:		run list of the attribute list
- * @al:			destination buffer
+ * @al_start:		destination buffer
  * @size:		size of the destination buffer in bytes
  * @initialized_size:	initialized size of the attribute list
  *
@@ -1227,10 +1227,11 @@
  *
  * Return 0 on success or -errno on error.
  */
-int load_attribute_list(ntfs_volume *vol, run_list *run_list, u8 *al,
+int load_attribute_list(ntfs_volume *vol, run_list *run_list, u8 *al_start,
 		const s64 size, const s64 initialized_size)
 {
 	LCN lcn;
+	u8 *al = al_start;
 	u8 *al_end = al + initialized_size;
 	run_list_element *rl;
 	struct buffer_head *bh;
@@ -1284,32 +1285,28 @@
 	}
 	if (initialized_size < size) {
 initialize:
-		memset(al + initialized_size, 0, size - initialized_size);
+		memset(al_start + initialized_size, 0, size - initialized_size);
 	}
 done:
 	up_read(&run_list->lock);
 	return err;
 do_final:
 	if (al < al_end) {
-		/* Partial block. */
-		memcpy(al, bh->b_data, al_end - al);
-		brelse(bh);
 		/*
-		 * Skip sanity checking if initialized_size < size as it is
-		 * too much trouble.
+		 * Partial block.
+		 *
+		 * Note: The attribute list can be smaller than its allocation
+		 * by multiple clusters.  This has been encountered by at least
+		 * two people running Windows XP, thus we cannot do any
+		 * truncation sanity checking here. (AIA)
 		 */
+		memcpy(al, bh->b_data, al_end - al);
+		brelse(bh);
 		if (initialized_size < size)
 			goto initialize;
-		/* If the final lcn is partial all is fine. */
-		if (((s64)(block - (lcn << vol->cluster_size_bits >>
-				block_size_bits)) << block_size_bits >>
-				vol->cluster_size_bits) == rl->length - 1) {
-			if (!rl[1].length || (rl[1].lcn == LCN_RL_NOT_MAPPED
-					&& !rl[2].length))
-				goto done;
-		}
-	} else
-		brelse(bh);
+		goto done;
+	}
+	brelse(bh);
 	/* Real overflow! */
 	ntfs_error(sb, "Attribute list buffer overflow. Read attribute list "
 			"is truncated.");
diff -Nru a/fs/ntfs/attrib.h b/fs/ntfs/attrib.h
--- a/fs/ntfs/attrib.h	Thu Nov 13 13:42:28 2003
+++ b/fs/ntfs/attrib.h	Thu Nov 13 13:42:28 2003
@@ -87,7 +87,7 @@
 		const IGNORE_CASE_BOOL ic, const VCN lowest_vcn, const u8 *val,
 		const u32 val_len, attr_search_context *ctx);

-extern int load_attribute_list(ntfs_volume *vol, run_list *rl, u8 *al,
+extern int load_attribute_list(ntfs_volume *vol, run_list *rl, u8 *al_start,
 		const s64 size, const s64 initialized_size);

 static inline s64 attribute_value_length(const ATTR_RECORD *a)

===================================================================

This BitKeeper patch contains the following changesets:
1.1422.3.1
## Wrapped with gzip_uu ##


M'XL( $6*LS\  ^U86V_:2!1^QK_B*'U)4S SOF&SHFK:M-VHMRA)=_M0"8WM
M,;9B/,@S+F7E_>][Q@XD$&@3E'U8=0%A,Y[YSO@[W[F8)_!9\G+881FSJ/$$
M?A=2#3L1*Q0+S8(K'#H7 H?ZJ9CR?C.M7ZA$]BS3,_#J&5-1"M]X*8<=:MJK
M$;68\6'G_/7;S^^/SPUC-()7*2LF_((K&(T,)<IO+(_E"Z;27!2F*EDAIUPQ
M,Q+3>C6UM@BQ\.W2@4U<KZ8><09U1&-*F4-Y3"S']YP;-+U)4\@X-T4Y68>Q
M*;X(<0/'JHGM!IYQ M2DCF69MDF!V'U*\0-T,'2]H3MX1LB0$&CN^,4-(?#,
MA1XQ7L+CWL$K(X*/EV\NAO A*T0)836!)/L.60%,J3(+*\4ASZ2Z]1--Q'E6
M3$"E3.G97.(I1Z33_B?@92E*":* @UP>@$@@XJ5B")B4;#+EA>(Q+LIQ42*J
M(H9P@=B0<X9&U%P@S(R+6<ZAK(I"F_DS*V(QE_#ES#3> 5+H&V<W7C5Z#WP9
M!F'$> XOW]6);#35_\"NN-Y238,!(13?-@G<H";X8U G/**A2UWJQ,0.[[KF
M+LS2[73@VHY36[X7!.L66S;-:(M%XM1>R&A,O"#R'3^*8G>WR17.ADG'"9QK
MDR<BJC3M3&6BZ#?,+Z3BTQ;!5-_5MDW0>N 2CP](8G$OC$,[O+N)>R!O;,MV
M\+B5B73;)MQZX,6,18GG>FZ4^#\G(MVTZ%F>[:U;;*7S7DRVF?3J./&2@.%R
MPA-[D#B[;=X ;3K<I;[7))^?4Z2STB-ZR=C72\0G VK;%K71D$W=)DW9P7J"
MLH>.LS-!.?]6@OK/I*9&W9^@5\Z;#^::LWLH8(\,=FH-'' ,RZ2F.S0ZO4>@
MJ ./PQ'B_( D'1-WPN<Z!/:,S[N*WQZ?Q+$)Q<AT_=IU;<MOZ[#E/T#A_J^N
M\#:Q;2C\#MU["=H"O]4S]. -DC!=47(?.DSCJPX#O7#[DM5$@.-(52S/%Y I
MR"04 @$E3"OL'IE>K26, TJ(=G!6"L4C';X:M^%]SO%3\G9MGHNYIFK=HM0P
M\S1#@#FRRT'.6,2U:^),7NDKR/(-NQ"A$TK<5 ,G]=YPQVA0PR0L4A"5G"ET
MG&PVNFX+I !1E1"7&;;$VB"NR5IBD);/LQB7-HT>Q+?S$2!FO$ ME(!]-5SQ
MLN Y#FI!<,WI[7A=MC<;X?J@YFEWL*XU3[=B53=/;:QBRKM_J%+HT5\[5)NF
M<T>H+LG>(U)/?*#&J?YZ_>7R_'C\ZLW[X[<7,(+>B=;7^(_7YQ>GGSZ.OAXT
MT?SU8$U#RWYU0T,/:X=WBVBM';Z=\(GKMB(*R$-$A,F(^K^TC-H'B1TR6M*]
MCXRH11LE71_A"%ZP?"P5*_&IOQ-SJ;*BS5%AE22\U"MLTJYHCEF!MR%8/%Y1
M-=;,'>J=C;^)'+,<'.&QJ^^LN01'R[,N5#X<+>UU&TP;,3OM,*IY>>TW;=<?
MM':;8Z<SQ>Z-J\/E%'B&_LM4QO+L+QZ/)7YW@71!GV QV[SVM($,'+";HP^6
MA@X"\! ::3A#2)P/82ZB*[,9:R]\Q#(TA,N4;VH%)0LA%I@IU@[,_J@3K%18
M%'0IB1H.6P!T_;3*5::]'>45%J528CV\3+$*IE@R0LX+X$6$.L%+?$TK+0(*
M9K=<NFBYDKHVXH9T98P%UK#%]4J<W^X%)$-&%A"E/+K2""G:,N'P^/3X*3)A
M8R1:+<G1;($D=R%,>\_#,98PUM5^X:CB'IX@D9U.B,5*\L,P;6BU"7J1:!1J
M(;^=SD0H@?LH.,[]VUB;O24MI=O3TOV>37^:E=+-K.31P+>;K(3=S_^E[=XY
MJ7VF_W%.2O?)24&37YIO_AU#0#=\>R29?#.]K/Z=;#0OJ^DHT'\5Q&%B_ -)
'I2S5"14

