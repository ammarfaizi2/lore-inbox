Return-Path: <linux-kernel-owner+willy=40w.ods.org-S261669AbUL3QMr@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S261669AbUL3QMr (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 30 Dec 2004 11:12:47 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S261666AbUL3QMr
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 30 Dec 2004 11:12:47 -0500
Received: from news.suse.de ([195.135.220.2]:32173 "EHLO Cantor.suse.de")
	by vger.kernel.org with ESMTP id S261664AbUL3QM0 (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Thu, 30 Dec 2004 11:12:26 -0500
Date: Thu, 30 Dec 2004 17:12:24 +0100
Message-ID: <s5h1xd7zrx3.wl@alsa2.suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: =?ISO-8859-2?Q?Pawe=B3?= Sikora <pluto@pld-linux.org>
Cc: linux-kernel@vger.kernel.org
Subject: Re: [oops] # rmmod snd_nm256
In-Reply-To: <200412300059.42982.pluto@pld-linux.org>
References: <200412300059.42982.pluto@pld-linux.org>
User-Agent: Wanderlust/2.10.1 (Watching The Wheels) SEMI/1.14.5 (Awara-Onsen) FLIM/1.14.5 (Demachiyanagi) APEL/10.6 MULE XEmacs/21.4 (patch 15) (Security Through Obscurity) (i386-suse-linux)
MIME-Version: 1.0 (generated by SEMI 1.14.5 - "Awara-Onsen")
Content-Type: text/plain; charset=ISO-8859-2
Content-Transfer-Encoding: 8bit
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

At Thu, 30 Dec 2004 00:59:42 +0100,
Pawe³ Sikora wrote:
> 
> # rmmod snd_nm256
> Oops: 0000 [#1]

Does the patch below fix the problem?


Takashi


--- linux/sound/pci/nm256/nm256.c	27 Dec 2004 13:32:57 -0000	1.61
+++ linux/sound/pci/nm256/nm256.c	30 Dec 2004 16:10:00 -0000
@@ -1486,12 +1486,6 @@
 
 	snd_nm256_init_chip(chip);
 
-	if ((err = snd_nm256_pcm(chip, 0)) < 0)
-		goto __error;
-	
-	if ((err = snd_nm256_mixer(chip)) < 0)
-		goto __error;
-
 	// pci_set_master(pci); /* needed? */
 	
 	snd_card_set_pm_callback(card, nm256_suspend, nm256_resume, chip);
@@ -1612,6 +1606,12 @@
 		chip->reset_workaround = 1;
 	}
 
+	if ((err = snd_nm256_pcm(chip, 0)) < 0 ||
+	    (err = snd_nm256_mixer(chip)) < 0) {
+		snd_card_free(card);
+		return err;
+	}
+
 	sprintf(card->shortname, "NeoMagic %s", card->driver);
 	sprintf(card->longname, "%s at 0x%lx & 0x%lx, irq %d",
 		card->shortname,
