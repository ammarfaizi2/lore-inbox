Return-Path: <linux-kernel-owner+willy=40w.ods.org-S932096AbVJKOYO@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S932096AbVJKOYO (ORCPT <rfc822;willy@w.ods.org>);
	Tue, 11 Oct 2005 10:24:14 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S932097AbVJKOYO
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Tue, 11 Oct 2005 10:24:14 -0400
Received: from 68.105.138.210.bn.2iij.net ([210.138.105.68]:8458 "HELO
	viper2.netfort.gr.jp") by vger.kernel.org with SMTP id S932096AbVJKOYO
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Tue, 11 Oct 2005 10:24:14 -0400
Date: Tue, 11 Oct 2005 23:24:30 +0900
Message-ID: <87achg9lnl.dancerj%dancer@netfort.gr.jp>
From: Junichi Uekawa <dancer@netfort.gr.jp>
To: Scott James Remnant <scott@netsplit.com>
Cc: Junichi Uekawa <dancer@netfort.gr.jp>, 322309@bugs.debian.org,
       329468@bugs.debian.org, debian-devel@bugs.debian.org,
       linux-kernel@vger.kernel.org, 332903@bugs.debian.org
Subject: Re: Bug#322309: Debian woody dpkg no longer works with recent	linux kernel.
In-Reply-To: <1128897196.19000.3.camel@localhost.localdomain>
References: <87zmpi3ell.dancerj%dancer@netfort.gr.jp>
	<1128897196.19000.3.camel@localhost.localdomain>
User-Agent: Wanderlust/2.14.0 (Africa) SEMI/1.14.6 (Maruoka) FLIM/1.14.7
 (=?ISO-8859-4?Q?Sanj=F2?=) APEL/10.6 Emacs/21.4 (x86_64-pc-linux-gnu)
 MULE/5.0 (SAKAKI)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Hi,

> > dpkg in Debian woody (3.0) is broken by recent linux kernels;
> > due to the following command changing behavior (mmap of 
> > zero-byte length):
> > 
> >   addr=mmap(NULL, 0, PROT_READ, MAP_SHARED, fd, 0);
> > 
> > These bugs are caused by mmap changing behavior; 
> > it used to return NULL when given a length of 0.
> > However, it now returns -1, and gives back an errno=EINVAL.
> > 
> Indeed.  This was the sole change in the 1.13.8 release.

1.13.8 is more recent than sarge; and I'm not quite sure 
why sarge successfully installs, and woody fails.


I'm seeing several potential solutions.

0.
Backport dpkg change to woody and update woody
(maybe impossible due to Debian oldstable
update infrastructure)

1. 
Modify [c]debootstrap to dump dummy data in 
/var/lib/dpkg/{status,available}

2. 
write a kernel patch to return 0 when mmap is 
called with length=0

3.
Create a LD_PRELOAD or ptrace hack to return 
0 when mmap is called with length=0


regards,
	junichi
