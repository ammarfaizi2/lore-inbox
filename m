Return-Path: <linux-kernel-owner+willy=40w.ods.org-S262188AbUKLJWv@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S262188AbUKLJWv (ORCPT <rfc822;willy@w.ods.org>);
	Fri, 12 Nov 2004 04:22:51 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S262237AbUKLJWv
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Fri, 12 Nov 2004 04:22:51 -0500
Received: from mail.suse.de ([195.135.220.2]:26280 "EHLO Cantor.suse.de")
	by vger.kernel.org with ESMTP id S262188AbUKLJWt (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Fri, 12 Nov 2004 04:22:49 -0500
Date: Fri, 12 Nov 2004 10:22:48 +0100
Message-ID: <s5hbre3fml3.wl@alsa2.suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Martin Josefsson <gandalf@wlug.westbo.se>
Cc: perex@suse.cz, akpm@osdl.org, linux-kernel@vger.kernel.org
Subject: Re: [PATCH] Add pci_save_state() to ALSA
In-Reply-To: <1100205586.6496.31.camel@tux.rsn.bth.se>
References: <1100205586.6496.31.camel@tux.rsn.bth.se>
User-Agent: Wanderlust/2.10.1 (Watching The Wheels) SEMI/1.14.5 (Awara-Onsen) FLIM/1.14.5 (Demachiyanagi) APEL/10.6 MULE XEmacs/21.4 (patch 15) (Security Through Obscurity) (i386-suse-linux)
MIME-Version: 1.0 (generated by SEMI 1.14.5 - "Awara-Onsen")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

At Thu, 11 Nov 2004 21:39:46 +0100,
Martin Josefsson wrote:
> 
> Hi
> 
> Some time ago, a patch was merged that removed pci_save_state() and
> pci_restore_state() from various drivers. That patch also added
> pci_restore_state() to sound/core/init.c but didn't add pci_save_state()
> anywhere.

pci_save_state() is called internally in
drivers/pci/pci-driver.c:pci_device_suspend(), so it's redundant.

> My laptop doesn't resume (gets what I assume is an ACPI timeout and
> hangs solid) without this small obvious patch.

I'm wondering how this can fix your problem...


Takashi


> Signed-off-by: Martin Josefsson <gandalf@wlug.westbo.se>
> 
> --- linux-2.6.10-rc1-bk21.orig/sound/core/init.c	2004-11-11 18:51:17.000000000 +0100
> +++ linux-2.6.10-rc1-bk21/sound/core/init.c	2004-11-11 20:57:52.000000000 +0100
> @@ -789,6 +789,8 @@ int snd_card_pci_suspend(struct pci_dev 
>  		return 0;
>  	if (card->power_state == SNDRV_CTL_POWER_D3hot)
>  		return 0;
> +	/* save the PCI config space */
> +	pci_save_state(dev);
>  	/* FIXME: correct state value? */
>  	return card->pm_suspend(card, 0);
>  }
> 
> -- 
> /Martin
