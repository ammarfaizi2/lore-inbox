Return-Path: <linux-kernel-owner+willy=40w.ods.org-S1030246AbVKHQiR@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1030246AbVKHQiR (ORCPT <rfc822;willy@w.ods.org>);
	Tue, 8 Nov 2005 11:38:17 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S932497AbVKHQiR
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Tue, 8 Nov 2005 11:38:17 -0500
Received: from mail.sf-mail.de ([62.27.20.61]:46812 "EHLO mail.sf-mail.de")
	by vger.kernel.org with ESMTP id S932496AbVKHQiQ (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Tue, 8 Nov 2005 11:38:16 -0500
From: Rolf Eike Beer <eike-kernel@sf-tec.de>
To: "goggin, edward" <egoggin@emc.com>
Subject: Re: oops with USB Storage on 2.6.14
Date: Tue, 8 Nov 2005 17:38:05 +0100
User-Agent: KMail/1.8.3
Cc: "'Andrew Morton'" <akpm@osdl.org>, Masanari Iida <standby24x7@gmail.com>,
       linux-kernel@vger.kernel.org, linux-usb-devel@lists.sourceforge.net,
       linux-scsi@vger.kernel.org
References: <C2EEB4E538D3DC48BF57F391F422779321ADBA@srmanning.eng.emc.com>
In-Reply-To: <C2EEB4E538D3DC48BF57F391F422779321ADBA@srmanning.eng.emc.com>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart9764188.oRKEEioV84";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200511081738.12040@bilbo.math.uni-mannheim.de>
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

--nextPart9764188.oRKEEioV84
Content-Type: text/plain;
  charset="iso-8859-6"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

Am Dienstag, 8. November 2005 17:24 schrieb goggin, edward:
>I've run into a bug like this several times using 2.6.14-rc4 while
>testing dm-multipath's reaction to uevents generated by forcing
>fiber channel transport failures -- which leads to the scsi device
>being detached and the queuedata pointer in the device's queue being
>reset in scsi_device_dev_release.  The fix I've used is below and
>it seems to work well for me.  I was going to place this patch on
>dm-devel today or tomorrow anyway.
>
>drivers/scsi/scsi_lib.c:scsi_next_command()
>Call scsi_device_get and scsi_device_put around the calls to
>scsi_put_command
>and scsi_run_queue so that the scsi host structure will not be de-allocated
>between scsi_put_command and scsi_run_queue.
>
>*** ../base/linux-2.6.14-rc4/drivers/scsi/scsi_lib.c	Mon Oct 10 20:19:19
>2005
>--- drivers/scsi/scsi_lib.c	Thu Nov  3 13:30:03 2005
>***************
>*** 592,601 ****

Your patch is linewrapped. Also please use unified diff format, good choice=
=20
for diff options is "-Naurp".

Eike

--nextPart9764188.oRKEEioV84
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.0 (GNU/Linux)

iD8DBQBDcNR0XKSJPmm5/E4RAopVAJ4vO+G6fd0A225vHKQYfTIk+0/vhQCfSKxk
I/uaYGi51mnQmMimx34JG5U=
=IM+u
-----END PGP SIGNATURE-----

--nextPart9764188.oRKEEioV84--
