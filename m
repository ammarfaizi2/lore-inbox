Return-Path: <linux-kernel-owner@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id <S286251AbRLJMkW>; Mon, 10 Dec 2001 07:40:22 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org
	id <S286252AbRLJMkM>; Mon, 10 Dec 2001 07:40:12 -0500
Received: from ikura.fe.dis.titech.ac.jp ([131.112.171.65]:59264 "HELO
	ikura.fe.dis.titech.ac.jp") by vger.kernel.org with SMTP
	id <S286251AbRLJMjy>; Mon, 10 Dec 2001 07:39:54 -0500
Date: Mon, 10 Dec 2001 21:39:51 +0900
Message-ID: <w53d71n1c6g.wl@megaela.fe.dis.titech.ac.jp>
From: GOTO Masanori <gotom@debian.org>
To: torvalds@transmeta.com
Cc: gotom@debian.org, marcelo@conectiva.com.br, linux-kernel@vger.kernel.org,
        andrea@suse.de
Subject: Re: [PATCH] direct IO breaks root filesystem
In-Reply-To: In your message of "Sun, 9 Dec 2001 21:55:57 -0800 (PST)"
	<Pine.LNX.4.33.0112092154060.13692-100000@penguin.transmeta.com>
In-Reply-To: <w534rmzendn.wl@megaela.fe.dis.titech.ac.jp>
	<Pine.LNX.4.33.0112092154060.13692-100000@penguin.transmeta.com>
User-Agent: Wanderlust/2.2.15 (More Than Words) EMIKO/1.13.9 (Euglena tripteris) FLIM/1.13.2 (Kasanui) APEL/10.2 MULE XEmacs/21.1 (patch 10) (Capitol Reef) (i386-debian-linux)
MIME-Version: 1.0 (generated by EMIKO 1.13.9 - "Euglena tripteris")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

At Sun, 9 Dec 2001 21:55:57 -0800 (PST),
Linus Torvalds <torvalds@transmeta.com> wrote:
> On Mon, 10 Dec 2001, GOTO Masanori wrote:
> >
> > The reason is that when kernel accesses /dev/sda with O_DIRECT,
> > blkdev_direct_IO() is called. But, it calls generic_direct_IO(),
> > and generic_direct_IO() calls brw_kiovec(..., inode->i_dev, ...).
> 
> That's a bad bug, yes.

Yes, dangerous bug...

> However, the bug is really in "generic_direct_IO()", and you should fix it
> there, instead of avoiding to use it altogether.
> 
> "generic_direct_IO()" should just get the device from "bh->b_dev (which is
> filled in correctly by "get_block()".

Oh, that's right, the patch becomes more simple (and works well).
Is this patch OK?

--- linux.vanilla/fs/buffer.c	Mon Dec 10 21:13:10 2001
+++ linux/fs/buffer.c	Mon Dec 10 20:59:34 2001
@@ -2003,12 +2003,12 @@
 {
 	int i, nr_blocks, retval;
 	unsigned long * blocks = iobuf->blocks;
+	struct buffer_head bh;
 
+	bh.b_dev = inode->i_dev;
 	nr_blocks = iobuf->length / blocksize;
 	/* build the blocklist */
 	for (i = 0; i < nr_blocks; i++, blocknr++) {
-		struct buffer_head bh;
-
 		bh.b_state = 0;
 		bh.b_dev = inode->i_dev;
 		bh.b_size = blocksize;
@@ -2034,7 +2034,7 @@
 		blocks[i] = bh.b_blocknr;
 	}
 
-	retval = brw_kiovec(rw, 1, &iobuf, inode->i_dev, iobuf->blocks, blocksize);
+	retval = brw_kiovec(rw, 1, &iobuf, bh.b_dev, iobuf->blocks, blocksize);
 
  out:
 	return retval;


-- gotom
