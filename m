Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S270524AbTHHJIq (ORCPT <rfc822;willy@w.ods.org>);
	Fri, 8 Aug 2003 05:08:46 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S270642AbTHHJIq
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Fri, 8 Aug 2003 05:08:46 -0400
Received: from zeus.kernel.org ([204.152.189.113]:42167 "EHLO zeus.kernel.org")
	by vger.kernel.org with ESMTP id S270524AbTHHJI3 (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Fri, 8 Aug 2003 05:08:29 -0400
Date: Fri, 8 Aug 2003 10:54:51 +0200 (MEST)
From: Javier Achirica <achirica@telefonica.net>
To: Jeff Garzik <jgarzik@pobox.com>
cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>,
       linux-kernel mailing list <linux-kernel@vger.kernel.org>
Subject: Re: [PATCH] airo driver: fix races, oops, etc..
In-Reply-To: <3F32678B.7020407@pobox.com>
Message-ID: <Pine.SOL.4.30.0308081053240.387-200000@tudela.mad.ttd.net>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-559023410-851401618-1060332891=:387"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.
  Send mail to mime@docserver.cac.washington.edu for more info.

---559023410-851401618-1060332891=:387
Content-Type: TEXT/PLAIN; charset=US-ASCII



On Thu, 7 Aug 2003, Jeff Garzik wrote:

> Javier Achirica wrote:
> > I've been studying the problem for a while and I've implemented a solution
> > using a single kernel thread and a wait queue for synchronization. I've
> > tested it and looks like it works fine. It can be used both in 2.4
> > and 2.6 kernels. Before submitting a patch with it I'd like someone with
> > experience in this kind of code to take a look at it just in case I'm
> > doing something dumb. Jeff? :-)
>
> Unless the patch is huge (100K or more), post it to linux-kernel, and CC
> it to me and Benjamin Herrenschmidt.

Here it goes. This version should be applied to the latest patches I sent
you in the 2.4 tree. Comments are welcome.

Thanks,
Javier Achirica

---559023410-851401618-1060332891=:387
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="thread.diff"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.SOL.4.30.0308081054510.387@tudela.mad.ttd.net>
Content-Description: 
Content-Disposition: attachment; filename="thread.diff"

LS0tIGxpbnV4L2RyaXZlcnMvbmV0L3dpcmVsZXNzL2Fpcm8uYy5vcmlnCTIw
MDMtMDgtMDYgMjI6Mjg6NDAgKzAyMDANCisrKyBsaW51eC9kcml2ZXJzL25l
dC93aXJlbGVzcy9haXJvLmMJMjAwMy0wOC0wNiAyMjozMDozMSArMDIwMA0K
QEAgLTMyLDcgKzMyLDYgQEANCiAjaW5jbHVkZSA8bGludXgvdGltZXIuaD4N
CiAjaW5jbHVkZSA8bGludXgvaW50ZXJydXB0Lmg+DQogI2luY2x1ZGUgPGxp
bnV4L2luLmg+DQotI2luY2x1ZGUgPGxpbnV4L3RxdWV1ZS5oPg0KICNpbmNs
dWRlIDxhc20vaW8uaD4NCiAjaW5jbHVkZSA8YXNtL3N5c3RlbS5oPg0KICNp
bmNsdWRlIDxhc20vYml0b3BzLmg+DQpAQCAtOTY1LDggKzk2NCw2IEBADQog
c3RhdGljIHZvaWQgZW5hYmxlX2ludGVycnVwdHMoc3RydWN0IGFpcm9faW5m
byopOw0KIHN0YXRpYyB2b2lkIGRpc2FibGVfaW50ZXJydXB0cyhzdHJ1Y3Qg
YWlyb19pbmZvKik7DQogc3RhdGljIHUxNiBpc3N1ZWNvbW1hbmQoc3RydWN0
IGFpcm9faW5mbyosIENtZCAqcENtZCwgUmVzcCAqcFJzcCk7DQotc3RhdGlj
IHUxNiBzZW5kY29tbWFuZChzdHJ1Y3QgYWlyb19pbmZvICphaSwgQ21kICpw
Q21kKTsNCi1zdGF0aWMgdm9pZCBjb21wbGV0ZWNvbW1hbmQoc3RydWN0IGFp
cm9faW5mbyAqYWksIFJlc3AgKnBSc3ApOw0KIHN0YXRpYyBpbnQgYmFwX3Nl
dHVwKHN0cnVjdCBhaXJvX2luZm8qLCB1MTYgcmlkLCB1MTYgb2Zmc2V0LCBp
bnQgd2hpY2hiYXApOw0KIHN0YXRpYyBpbnQgYXV4X2JhcF9yZWFkKHN0cnVj
dCBhaXJvX2luZm8qLCB1MTYgKnB1MTZEc3QsIGludCBieXRlbGVuLA0KIAkJ
CWludCB3aGljaGJhcCk7DQpAQCAtOTg2LDYgKzk4Myw4IEBADQogDQogc3Rh
dGljIHZvaWQgYWlyb19pbnRlcnJ1cHQoIGludCBpcnEsIHZvaWQqIGRldl9p
ZCwgc3RydWN0IHB0X3JlZ3MNCiAJCQkgICAgKnJlZ3MpOw0KK3N0YXRpYyBp
bnQgYWlyb190aHJlYWQodm9pZCAqZGF0YSk7DQorc3RhdGljIHZvaWQgdGlt
ZXJfZnVuYyggc3RydWN0IG5ldF9kZXZpY2UgKmRldiApOw0KIHN0YXRpYyBp
bnQgYWlyb19pb2N0bChzdHJ1Y3QgbmV0X2RldmljZSAqZGV2LCBzdHJ1Y3Qg
aWZyZXEgKnJxLCBpbnQgY21kKTsNCiAjaWZkZWYgV0lSRUxFU1NfRVhUDQog
c3RydWN0IGl3X3N0YXRpc3RpY3MgKmFpcm9fZ2V0X3dpcmVsZXNzX3N0YXRz
IChzdHJ1Y3QgbmV0X2RldmljZSAqZGV2KTsNCkBAIC05OTYsOCArOTk1LDgg
QEANCiBpbnQgZmxhc2hjYXJkKHN0cnVjdCBuZXRfZGV2aWNlICpkZXYsIGFp
cm9uZXRfaW9jdGwgKmNvbXApOw0KICNlbmRpZiAvKiBDSVNDT19FWFQgKi8N
CiAjaWZkZWYgTUlDU1VQUE9SVA0KLXN0YXRpYyB2b2lkIG1pY2luaXQoc3Ry
dWN0IGFpcm9faW5mbyAqYWksIE1JQ1JpZCAqbWljcik7DQotc3RhdGljIHZv
aWQgbWljc2V0dXAoc3RydWN0IGFpcm9faW5mbyAqYWkpOw0KK3N0YXRpYyB2
b2lkIG1pY2luaXQoc3RydWN0IGFpcm9faW5mbyAqYWkpOw0KK3N0YXRpYyBp
bnQgbWljc2V0dXAoc3RydWN0IGFpcm9faW5mbyAqYWkpOw0KIHN0YXRpYyBp
bnQgZW5jYXBzdWxhdGUoc3RydWN0IGFpcm9faW5mbyAqYWksIGV0aGVySGVh
ZCAqcFBhY2tldCwgTUlDQnVmZmVyICpidWZmZXIsIGludCBsZW4pOw0KIHN0
YXRpYyBpbnQgZGVjYXBzdWxhdGUoc3RydWN0IGFpcm9faW5mbyAqYWksIE1J
Q0J1ZmZlciAqbWljLCBldGhlckhlYWQgKnBQYWNrZXQsIHUxNiBwYXlMZW4p
Ow0KICNlbmRpZg0KQEAgLTEwMTUsNDEgKzEwMTQsNTAgQEANCiAJaW50IG5l
ZWRfY29tbWl0OwkvLyBOZWVkIHRvIHNldCBjb25maWcNCiAJY2hhciBrZXlp
bmRleDsgLy8gVXNlZCB3aXRoIGF1dG8gd2VwDQogCWNoYXIgZGVmaW5kZXg7
IC8vIFVzZWQgd2l0aCBhdXRvIHdlcA0KLQlzdHJ1Y3QgdGltZXJfbGlzdCB0
aW1lcjsNCiAJc3RydWN0IHByb2NfZGlyX2VudHJ5ICpwcm9jX2VudHJ5Ow0K
IAlzdHJ1Y3QgYWlyb19pbmZvICpuZXh0Ow0KICAgICAgICAgc3BpbmxvY2tf
dCBhdXhfbG9jazsNCiAgICAgICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7DQot
I2RlZmluZSBGTEFHX1BST01JU0MgICBJRkZfUFJPTUlTQwkvKiAweDEwMCAt
IGluY2x1ZGUvbGludXgvaWYuaCAqLw0KLSNkZWZpbmUgRkxBR19SQURJT19P
RkYgMHgwMgkJLyogVXNlciBkaXNhYmxpbmcgb2YgTUFDICovDQotI2RlZmlu
ZSBGTEFHX1JBRElPX0RPV04gMHgwOAkJLyogaWZ1cC9pZmRvd24gZGlzYWJs
aW5nIG9mIE1BQyAqLw0KLSNkZWZpbmUgRkxBR19GTEFTSElORyAgMHgxMA0K
LSNkZWZpbmUgRkxBR19BREhPQyAgICAgICAgMHgwMSAvKiBOZWVkZWQgYnkg
TUlDICovDQotI2RlZmluZSBGTEFHX01JQ19DQVBBQkxFICAweDIwDQotI2Rl
ZmluZSBGTEFHX1VQREFURV9NVUxUSSAweDQwDQotI2RlZmluZSBGTEFHX1VQ
REFURV9VTkkgICAweDgwDQotI2RlZmluZSBGTEFHXzgwMl8xMSAgICAweDIw
MA0KLSNkZWZpbmUgRkxBR19QRU5ESU5HX1hNSVQgICAweDQwMA0KLSNkZWZp
bmUgRkxBR19QRU5ESU5HX1hNSVQxMSAweDgwMA0KLSNkZWZpbmUgRkxBR19Q
Q0kgICAgMHgxMDAwDQorI2RlZmluZSBGTEFHX1BST01JU0MJOAkvKiBJRkZf
UFJPTUlTQyAweDEwMCAtIGluY2x1ZGUvbGludXgvaWYuaCAqLw0KKyNkZWZp
bmUgRkxBR19SQURJT19PRkYJMAkvKiBVc2VyIGRpc2FibGluZyBvZiBNQUMg
Ki8NCisjZGVmaW5lIEZMQUdfUkFESU9fRE9XTgkxCS8qIGlmdXAvaWZkb3du
IGRpc2FibGluZyBvZiBNQUMgKi8NCisjZGVmaW5lIEZMQUdfUkFESU9fTUFT
SyAweDAzDQorI2RlZmluZSBGTEFHX0ZMQVNISU5HCTINCisjZGVmaW5lIEZM
QUdfQURIT0MJMwkvKiBOZWVkZWQgYnkgTUlDICovDQorI2RlZmluZSBGTEFH
X01JQ19DQVBBQkxFIDQNCisjZGVmaW5lIEZMQUdfVVBEQVRFX01VTFRJIDUN
CisjZGVmaW5lIEZMQUdfVVBEQVRFX1VOSSA2DQorI2RlZmluZSBGTEFHXzgw
Ml8xMQk3DQorI2RlZmluZSBGTEFHX1BFTkRJTkdfWE1JVCA5DQorI2RlZmlu
ZSBGTEFHX1BFTkRJTkdfWE1JVDExIDEwDQorI2RlZmluZSBGTEFHX1BDSQkx
MQ0KKyNkZWZpbmUgSk9CX01BU0sJMHhmZjAwMDANCisjZGVmaW5lIEpPQl9E
SUUJCTE2DQorI2RlZmluZSBKT0JfWE1JVAkxNw0KKyNkZWZpbmUgSk9CX1hN
SVQxMQkxOA0KKyNkZWZpbmUgSk9CX1NUQVRTCTE5DQorI2RlZmluZSBKT0Jf
UFJPTUlTQwkyMA0KKyNkZWZpbmUgSk9CX01JQwkJMjENCisjZGVmaW5lIEpP
Ql9FVkVOVAkyMg0KKyNkZWZpbmUgSk9CX0FVVE9XRVAJMjMNCiAJaW50ICgq
YmFwX3JlYWQpKHN0cnVjdCBhaXJvX2luZm8qLCB1MTYgKnB1MTZEc3QsIGlu
dCBieXRlbGVuLA0KIAkJCWludCB3aGljaGJhcCk7DQogCXVuc2lnbmVkIHNo
b3J0ICpmbGFzaDsNCiAJdGRzUnNzaUVudHJ5ICpyc3NpOw0KLQlzdHJ1Y3Qg
c2VtYXBob3JlIHNlbTsNCiAJc3RydWN0IHRhc2tfc3RydWN0ICp0YXNrOw0K
LQlzdHJ1Y3QgdHFfc3RydWN0IHN0YXRzX3Rhc2s7DQotCXN0cnVjdCB0cV9z
dHJ1Y3QgcHJvbWlzY190YXNrOw0KKwlzdHJ1Y3Qgc2VtYXBob3JlIHNlbTsN
CisJcGlkX3QgdGhyX3BpZDsNCisJd2FpdF9xdWV1ZV9oZWFkX3QgdGhyX3dh
aXQ7DQorCXN0cnVjdCBjb21wbGV0aW9uIHRocl9leGl0ZWQ7DQorCXVuc2ln
bmVkIGxvbmcgZXhwaXJlczsNCiAJc3RydWN0IHsNCiAJCXN0cnVjdCBza19i
dWZmICpza2I7DQogCQlpbnQgZmlkOw0KLQkJc3RydWN0IHRxX3N0cnVjdCB0
YXNrOw0KIAl9IHhtaXQsIHhtaXQxMTsNCiAJc3RydWN0IG5ldF9kZXZpY2Ug
KndpZmlkZXY7DQogI2lmZGVmIFdJUkVMRVNTX0VYVA0KIAlzdHJ1Y3QgaXdf
c3RhdGlzdGljcwl3c3RhdHM7CQkvLyB3aXJlbGVzcyBzdGF0cw0KIAl1bnNp
Z25lZCBsb25nCQlzY2FuX3RpbWVzdGFtcDsJLyogVGltZSBzdGFydGVkIHRv
IHNjYW4gKi8NCi0Jc3RydWN0IHRxX3N0cnVjdAlldmVudF90YXNrOw0KICNp
ZiBXSVJFTEVTU19FWFQgPiAxNQ0KIAlzdHJ1Y3QgaXdfc3B5X2RhdGEJc3B5
X2RhdGE7DQogI2Vsc2UgLyogV0lSRUxFU1NfRVhUID4gMTUgKi8NCkBAIC0x
MDYzLDcgKzEwNzEsNiBAQA0KIAkvKiBNSUMgc3R1ZmYgKi8NCiAJbWljX21v
ZHVsZQkJbW9kWzJdOw0KIAltaWNfc3RhdGlzdGljcwkJbWljc3RhdHM7DQot
CXN0cnVjdCB0cV9zdHJ1Y3QgCW1pY190YXNrOw0KIH07DQogDQogc3RhdGlj
IGlubGluZSBpbnQgYmFwX3JlYWQoc3RydWN0IGFpcm9faW5mbyAqYWksIHUx
NiAqcHUxNkRzdCwgaW50IGJ5dGVsZW4sDQpAQCAtMTIxMyw5ICsxMjIwLDkg
QEANCiAJY2ZnciA9IGFpLT5jb25maWc7DQogDQogCWlmICgoY2Znci5vcG1v
ZGUgJiAweEZGKSA9PSBNT0RFX1NUQV9JQlNTKQ0KLQkJYWktPmZsYWdzIHw9
IEZMQUdfQURIT0M7DQorCQlzZXRfYml0KEZMQUdfQURIT0MsICZhaS0+Zmxh
Z3MpOw0KIAllbHNlDQotCQlhaS0+ZmxhZ3MgJj0gfkZMQUdfQURIT0M7DQor
CQljbGVhcl9iaXQoRkxBR19BREhPQywgJmFpLT5mbGFncyk7DQogDQogCWZv
cihzID0gJmNmZ3IubGVuOyBzIDw9ICZjZmdyLnJ0c1RocmVzOyBzKyspICpz
ID0gY3B1X3RvX2xlMTYoKnMpOw0KIA0KQEAgLTEyNzksNyArMTI4Niw3IEBA
DQogCXN0cnVjdCBhaXJvX2luZm8gKmluZm8gPSBkZXYtPnByaXY7DQogCVJl
c3AgcnNwOw0KIA0KLQlpZiAoaW5mby0+ZmxhZ3MgJiBGTEFHX0ZMQVNISU5H
KQ0KKwlpZiAodGVzdF9iaXQoRkxBR19GTEFTSElORywgJmluZm8tPmZsYWdz
KSkNCiAJCXJldHVybiAtRUlPOw0KIA0KIAkvKiBNYWtlIHN1cmUgdGhlIGNh
cmQgaXMgY29uZmlndXJlZC4NCkBAIC0xMjkzLDcgKzEzMDAsNyBAQA0KIA0K
IAlpZiAoaW5mby0+d2lmaWRldiAhPSBkZXYpIHsNCiAJCS8qIFBvd2VyIG9u
IHRoZSBNQUMgY29udHJvbGxlciAod2hpY2ggbWF5IGhhdmUgYmVlbiBkaXNh
YmxlZCkgKi8NCi0JCWluZm8tPmZsYWdzICY9IH5GTEFHX1JBRElPX0RPV047
DQorCQljbGVhcl9iaXQoRkxBR19SQURJT19ET1dOLCAmaW5mby0+ZmxhZ3Mp
Ow0KIAkJZW5hYmxlX2ludGVycnVwdHMoaW5mbyk7DQogCX0NCiAJZW5hYmxl
X01BQyhpbmZvLCAmcnNwLCAxKTsNCkBAIC0xMzUxLDcgKzEzNTgsNyBAQA0K
IAl9DQogfQ0KIA0KLXN0YXRpYyB2b2lkIGFpcm9fZG9feG1pdChzdHJ1Y3Qg
bmV0X2RldmljZSAqZGV2KSB7DQorc3RhdGljIHZvaWQgYWlyb19lbmRfeG1p
dChzdHJ1Y3QgbmV0X2RldmljZSAqZGV2KSB7DQogCXUxNiBzdGF0dXM7DQog
CWludCBpOw0KIAlzdHJ1Y3QgYWlyb19pbmZvICpwcml2ID0gZGV2LT5wcml2
Ow0KQEAgLTEzNTksMTcgKzEzNjYsMTAgQEANCiAJaW50IGZpZCA9IHByaXYt
PnhtaXQuZmlkOw0KIAl1MzIgKmZpZHMgPSBwcml2LT5maWRzOw0KIA0KLQlp
ZiAoZG93bl90cnlsb2NrKCZwcml2LT5zZW0pICE9IDApIHsNCi0JCXByaXYt
PmZsYWdzIHw9IEZMQUdfUEVORElOR19YTUlUOw0KLQkJbmV0aWZfc3RvcF9x
dWV1ZShkZXYpOw0KLQkJcHJpdi0+eG1pdC50YXNrLnJvdXRpbmUgPSAodm9p
ZCAoKikodm9pZCAqKSlhaXJvX2RvX3htaXQ7DQotCQlwcml2LT54bWl0LnRh
c2suZGF0YSA9ICh2b2lkICopZGV2Ow0KLQkJc2NoZWR1bGVfdGFzaygmcHJp
di0+eG1pdC50YXNrKTsNCi0JCXJldHVybjsNCi0JfQ0KKwljbGVhcl9iaXQo
Sk9CX1hNSVQsICZwcml2LT5mbGFncyk7DQorCWNsZWFyX2JpdChGTEFHX1BF
TkRJTkdfWE1JVCwgJnByaXYtPmZsYWdzKTsNCiAJc3RhdHVzID0gdHJhbnNt
aXRfODAyXzNfcGFja2V0IChwcml2LCBmaWRzW2ZpZF0sIHNrYi0+ZGF0YSk7
DQogCXVwKCZwcml2LT5zZW0pOw0KLQlwcml2LT5mbGFncyAmPSB+RkxBR19Q
RU5ESU5HX1hNSVQ7DQogDQogCWkgPSAwOw0KIAlpZiAoIHN0YXR1cyA9PSBT
VUNDRVNTICkgew0KQEAgLTE0MTMsMTEgKzE0MTMsMTcgQEANCiAJZmlkc1tp
XSB8PSAobGVuIDw8IDE2KTsNCiAJcHJpdi0+eG1pdC5za2IgPSBza2I7DQog
CXByaXYtPnhtaXQuZmlkID0gaTsNCi0JYWlyb19kb194bWl0KGRldik7DQor
CWlmIChkb3duX3RyeWxvY2soJnByaXYtPnNlbSkgIT0gMCkgew0KKwkJc2V0
X2JpdChGTEFHX1BFTkRJTkdfWE1JVCwgJnByaXYtPmZsYWdzKTsNCisJCW5l
dGlmX3N0b3BfcXVldWUoZGV2KTsNCisJCXNldF9iaXQoSk9CX1hNSVQsICZw
cml2LT5mbGFncyk7DQorCQl3YWtlX3VwX2ludGVycnVwdGlibGUoJnByaXYt
PnRocl93YWl0KTsNCisJfSBlbHNlDQorCQlhaXJvX2VuZF94bWl0KGRldik7
DQogCXJldHVybiAwOw0KIH0NCiANCi1zdGF0aWMgdm9pZCBhaXJvX2RvX3ht
aXQxMShzdHJ1Y3QgbmV0X2RldmljZSAqZGV2KSB7DQorc3RhdGljIHZvaWQg
YWlyb19lbmRfeG1pdDExKHN0cnVjdCBuZXRfZGV2aWNlICpkZXYpIHsNCiAJ
dTE2IHN0YXR1czsNCiAJaW50IGk7DQogCXN0cnVjdCBhaXJvX2luZm8gKnBy
aXYgPSBkZXYtPnByaXY7DQpAQCAtMTQyNSwxNyArMTQzMSwxMCBAQA0KIAlp
bnQgZmlkID0gcHJpdi0+eG1pdDExLmZpZDsNCiAJdTMyICpmaWRzID0gcHJp
di0+ZmlkczsNCiANCi0JaWYgKGRvd25fdHJ5bG9jaygmcHJpdi0+c2VtKSAh
PSAwKSB7DQotCQlwcml2LT5mbGFncyB8PSBGTEFHX1BFTkRJTkdfWE1JVDEx
Ow0KLQkJbmV0aWZfc3RvcF9xdWV1ZShkZXYpOw0KLQkJcHJpdi0+eG1pdDEx
LnRhc2sucm91dGluZSA9ICh2b2lkICgqKSh2b2lkICopKWFpcm9fZG9feG1p
dDExOw0KLQkJcHJpdi0+eG1pdDExLnRhc2suZGF0YSA9ICh2b2lkICopZGV2
Ow0KLQkJc2NoZWR1bGVfdGFzaygmcHJpdi0+eG1pdDExLnRhc2spOw0KLQkJ
cmV0dXJuOw0KLQl9DQorCWNsZWFyX2JpdChKT0JfWE1JVDExLCAmcHJpdi0+
ZmxhZ3MpOw0KKwljbGVhcl9iaXQoRkxBR19QRU5ESU5HX1hNSVQxMSwgJnBy
aXYtPmZsYWdzKTsNCiAJc3RhdHVzID0gdHJhbnNtaXRfODAyXzExX3BhY2tl
dCAocHJpdiwgZmlkc1tmaWRdLCBza2ItPmRhdGEpOw0KIAl1cCgmcHJpdi0+
c2VtKTsNCi0JcHJpdi0+ZmxhZ3MgJj0gfkZMQUdfUEVORElOR19YTUlUMTE7
DQogDQogCWkgPSBNQVhfRklEUyAvIDI7DQogCWlmICggc3RhdHVzID09IFNV
Q0NFU1MgKSB7DQpAQCAtMTQ3OSw3ICsxNDc4LDEzIEBADQogCWZpZHNbaV0g
fD0gKGxlbiA8PCAxNik7DQogCXByaXYtPnhtaXQxMS5za2IgPSBza2I7DQog
CXByaXYtPnhtaXQxMS5maWQgPSBpOw0KLQlhaXJvX2RvX3htaXQxMShkZXYp
Ow0KKwlpZiAoZG93bl90cnlsb2NrKCZwcml2LT5zZW0pICE9IDApIHsNCisJ
CXNldF9iaXQoRkxBR19QRU5ESU5HX1hNSVQxMSwgJnByaXYtPmZsYWdzKTsN
CisJCW5ldGlmX3N0b3BfcXVldWUoZGV2KTsNCisJCXNldF9iaXQoSk9CX1hN
SVQxMSwgJnByaXYtPmZsYWdzKTsNCisJCXdha2VfdXBfaW50ZXJydXB0aWJs
ZSgmcHJpdi0+dGhyX3dhaXQpOw0KKwl9IGVsc2UNCisJCWFpcm9fZW5kX3ht
aXQxMShkZXYpOw0KIAlyZXR1cm4gMDsNCiB9DQogDQpAQCAtMTQ4NywyOSAr
MTQ5MiwyNCBAQA0KIAlTdGF0c1JpZCBzdGF0c19yaWQ7DQogCXUzMiAqdmFs
cyA9IHN0YXRzX3JpZC52YWxzOw0KIA0KLQlpZiAoZG93bl90cnlsb2NrKCZh
aS0+c2VtKSA9PSAwKSB7DQotCQlyZWFkU3RhdHNSaWQoYWksICZzdGF0c19y
aWQsIFJJRF9TVEFUUywgMCk7DQotCQl1cCgmYWktPnNlbSk7DQorCWNsZWFy
X2JpdChKT0JfU1RBVFMsICZhaS0+ZmxhZ3MpOw0KKwlyZWFkU3RhdHNSaWQo
YWksICZzdGF0c19yaWQsIFJJRF9TVEFUUywgMCk7DQorCXVwKCZhaS0+c2Vt
KTsNCiANCi0JCWFpLT5zdGF0cy5yeF9wYWNrZXRzID0gdmFsc1s0M10gKyB2
YWxzWzQ0XSArIHZhbHNbNDVdOw0KLQkJYWktPnN0YXRzLnR4X3BhY2tldHMg
PSB2YWxzWzM5XSArIHZhbHNbNDBdICsgdmFsc1s0MV07DQotCQlhaS0+c3Rh
dHMucnhfYnl0ZXMgPSB2YWxzWzkyXTsNCi0JCWFpLT5zdGF0cy50eF9ieXRl
cyA9IHZhbHNbOTFdOw0KLQkJYWktPnN0YXRzLnJ4X2Vycm9ycyA9IHZhbHNb
MF0gKyB2YWxzWzJdICsgdmFsc1szXSArIHZhbHNbNF07DQotCQlhaS0+c3Rh
dHMudHhfZXJyb3JzID0gdmFsc1s0Ml0gKyBhaS0+c3RhdHMudHhfZmlmb19l
cnJvcnM7DQotCQlhaS0+c3RhdHMubXVsdGljYXN0ID0gdmFsc1s0M107DQot
CQlhaS0+c3RhdHMuY29sbGlzaW9ucyA9IHZhbHNbODldOw0KLQ0KLQkJLyog
ZGV0YWlsZWQgcnhfZXJyb3JzOiAqLw0KLQkJYWktPnN0YXRzLnJ4X2xlbmd0
aF9lcnJvcnMgPSB2YWxzWzNdOw0KLQkJYWktPnN0YXRzLnJ4X2NyY19lcnJv
cnMgPSB2YWxzWzRdOw0KLQkJYWktPnN0YXRzLnJ4X2ZyYW1lX2Vycm9ycyA9
IHZhbHNbMl07DQotCQlhaS0+c3RhdHMucnhfZmlmb19lcnJvcnMgPSB2YWxz
WzBdOw0KLQl9IGVsc2Ugew0KLQkJYWktPnN0YXRzX3Rhc2sucm91dGluZSA9
ICh2b2lkICgqKSh2b2lkICopKWFpcm9fcmVhZF9zdGF0czsNCi0JCWFpLT5z
dGF0c190YXNrLmRhdGEgPSAodm9pZCAqKWFpOw0KLQkJc2NoZWR1bGVfdGFz
aygmYWktPnN0YXRzX3Rhc2spOw0KLQl9DQorCWFpLT5zdGF0cy5yeF9wYWNr
ZXRzID0gdmFsc1s0M10gKyB2YWxzWzQ0XSArIHZhbHNbNDVdOw0KKwlhaS0+
c3RhdHMudHhfcGFja2V0cyA9IHZhbHNbMzldICsgdmFsc1s0MF0gKyB2YWxz
WzQxXTsNCisJYWktPnN0YXRzLnJ4X2J5dGVzID0gdmFsc1s5Ml07DQorCWFp
LT5zdGF0cy50eF9ieXRlcyA9IHZhbHNbOTFdOw0KKwlhaS0+c3RhdHMucnhf
ZXJyb3JzID0gdmFsc1swXSArIHZhbHNbMl0gKyB2YWxzWzNdICsgdmFsc1s0
XTsNCisJYWktPnN0YXRzLnR4X2Vycm9ycyA9IHZhbHNbNDJdICsgYWktPnN0
YXRzLnR4X2ZpZm9fZXJyb3JzOw0KKwlhaS0+c3RhdHMubXVsdGljYXN0ID0g
dmFsc1s0M107DQorCWFpLT5zdGF0cy5jb2xsaXNpb25zID0gdmFsc1s4OV07
DQorDQorCS8qIGRldGFpbGVkIHJ4X2Vycm9yczogKi8NCisJYWktPnN0YXRz
LnJ4X2xlbmd0aF9lcnJvcnMgPSB2YWxzWzNdOw0KKwlhaS0+c3RhdHMucnhf
Y3JjX2Vycm9ycyA9IHZhbHNbNF07DQorCWFpLT5zdGF0cy5yeF9mcmFtZV9l
cnJvcnMgPSB2YWxzWzJdOw0KKwlhaS0+c3RhdHMucnhfZmlmb19lcnJvcnMg
PSB2YWxzWzBdOw0KIH0NCiANCiBzdHJ1Y3QgbmV0X2RldmljZV9zdGF0cyAq
YWlyb19nZXRfc3RhdHMoc3RydWN0IG5ldF9kZXZpY2UgKmRldikNCkBAIC0x
NTE3LDQ2ICsxNTE3LDM3IEBADQogCXN0cnVjdCBhaXJvX2luZm8gKmxvY2Fs
ID0gIGRldi0+cHJpdjsNCiANCiAJLyogR2V0IHN0YXRzIG91dCBvZiB0aGUg
Y2FyZCBpZiBhdmFpbGFibGUgKi8NCi0JYWlyb19yZWFkX3N0YXRzKGxvY2Fs
KTsNCisJaWYgKGRvd25fdHJ5bG9jaygmbG9jYWwtPnNlbSkgIT0gMCkgew0K
KwkJc2V0X2JpdChKT0JfU1RBVFMsICZsb2NhbC0+ZmxhZ3MpOw0KKwkJd2Fr
ZV91cF9pbnRlcnJ1cHRpYmxlKCZsb2NhbC0+dGhyX3dhaXQpOw0KKwl9IGVs
c2UNCisJCWFpcm9fcmVhZF9zdGF0cyhsb2NhbCk7DQogDQogCXJldHVybiAm
bG9jYWwtPnN0YXRzOw0KIH0NCiANCi1zdGF0aWMgdm9pZCBhaXJvX2VuZF9w
cm9taXNjKHN0cnVjdCBhaXJvX2luZm8gKmFpKSB7DQotCVJlc3AgcnNwOw0K
LQ0KLQlpZiAoKElONDUwMChhaSwgRVZTVEFUKSAmIEVWX0NNRCkgIT0gMCkg
ew0KLQkJY29tcGxldGVjb21tYW5kKGFpLCAmcnNwKTsNCi0JCXVwKCZhaS0+
c2VtKTsNCi0JfSBlbHNlIHsNCi0JCWFpLT5wcm9taXNjX3Rhc2sucm91dGlu
ZSA9ICh2b2lkICgqKSh2b2lkICopKWFpcm9fZW5kX3Byb21pc2M7DQotCQlh
aS0+cHJvbWlzY190YXNrLmRhdGEgPSAodm9pZCAqKWFpOw0KLQkJc2NoZWR1
bGVfdGFzaygmYWktPnByb21pc2NfdGFzayk7DQotCX0NCi19DQotDQogc3Rh
dGljIHZvaWQgYWlyb19zZXRfcHJvbWlzYyhzdHJ1Y3QgYWlyb19pbmZvICph
aSkgew0KIAlDbWQgY21kOw0KKwlSZXNwIHJzcDsNCiANCi0JaWYgKGRvd25f
dHJ5bG9jaygmYWktPnNlbSkgPT0gMCkgew0KLQkJbWVtc2V0KCZjbWQsIDAs
IHNpemVvZihjbWQpKTsNCi0JCWNtZC5jbWQ9Q01EX1NFVE1PREU7DQotCQlj
bWQucGFybTA9KGFpLT5mbGFncyZJRkZfUFJPTUlTQykgPyBQUk9NSVNDIDog
Tk9QUk9NSVNDOw0KLQkJc2VuZGNvbW1hbmQoYWksICZjbWQpOw0KLQkJYWly
b19lbmRfcHJvbWlzYyhhaSk7DQotCX0gZWxzZSB7DQotCQlhaS0+cHJvbWlz
Y190YXNrLnJvdXRpbmUgPSAodm9pZCAoKikodm9pZCAqKSlhaXJvX3NldF9w
cm9taXNjOw0KLQkJYWktPnByb21pc2NfdGFzay5kYXRhID0gKHZvaWQgKilh
aTsNCi0JCXNjaGVkdWxlX3Rhc2soJmFpLT5wcm9taXNjX3Rhc2spOw0KLQl9
DQorCW1lbXNldCgmY21kLCAwLCBzaXplb2YoY21kKSk7DQorCWNtZC5jbWQ9
Q01EX1NFVE1PREU7DQorCWNsZWFyX2JpdChKT0JfUFJPTUlTQywgJmFpLT5m
bGFncyk7DQorCWNtZC5wYXJtMD0oYWktPmZsYWdzJklGRl9QUk9NSVNDKSA/
IFBST01JU0MgOiBOT1BST01JU0M7DQorCWlzc3VlY29tbWFuZChhaSwgJmNt
ZCwgJnJzcCk7DQorCXVwKCZhaS0+c2VtKTsNCiB9DQogDQogc3RhdGljIHZv
aWQgYWlyb19zZXRfbXVsdGljYXN0X2xpc3Qoc3RydWN0IG5ldF9kZXZpY2Ug
KmRldikgew0KIAlzdHJ1Y3QgYWlyb19pbmZvICphaSA9IGRldi0+cHJpdjsN
CiANCiAJaWYgKChkZXYtPmZsYWdzIF4gYWktPmZsYWdzKSAmIElGRl9QUk9N
SVNDKSB7DQotCQlhaS0+ZmxhZ3MgXj0gSUZGX1BST01JU0M7DQotCQlhaXJv
X3NldF9wcm9taXNjKGFpKTsNCisJCWNoYW5nZV9iaXQoRkxBR19QUk9NSVND
LCAmYWktPmZsYWdzKTsNCisJCWlmIChkb3duX3RyeWxvY2soJmFpLT5zZW0p
ICE9IDApIHsNCisJCQlzZXRfYml0KEpPQl9QUk9NSVNDLCAmYWktPmZsYWdz
KTsNCisJCQl3YWtlX3VwX2ludGVycnVwdGlibGUoJmFpLT50aHJfd2FpdCk7
DQorCQl9IGVsc2UNCisJCQlhaXJvX3NldF9wcm9taXNjKGFpKTsNCiAJfQ0K
IA0KIAlpZiAoKGRldi0+ZmxhZ3MmSUZGX0FMTE1VTFRJKXx8ZGV2LT5tY19j
b3VudD4wKSB7DQpAQCAtMTYwMiw3ICsxNTkzLDcgQEANCiAJCSAqIFRoYXQn
cyB0aGUgbWV0aG9kIHRoYXQgaXMgbW9zdCBmcmllbmRseSB0b3dhcmRzIHRo
ZSBuZXR3b3JrDQogCQkgKiBzdGFjayAoaS5lLiB0aGUgbmV0d29yayBzdGFj
ayB3b24ndCB0cnkgdG8gYnJvYWRjYXN0DQogCQkgKiBhbnl0aGluZyBvbiB0
aGUgaW50ZXJmYWNlIGFuZCByb3V0ZXMgYXJlIGdvbmUuIEplYW4gSUkgKi8N
Ci0JCWFpLT5mbGFncyB8PSBGTEFHX1JBRElPX0RPV047DQorCQlzZXRfYml0
KEZMQUdfUkFESU9fRE9XTiwgJmFpLT5mbGFncyk7DQogCQlkaXNhYmxlX01B
QyhhaSwgMSk7DQogI2VuZGlmDQogCQlkaXNhYmxlX2ludGVycnVwdHMoIGFp
ICk7DQpAQCAtMTYxNyw4ICsxNjA4LDYgQEANCiAJc3RydWN0IGFpcm9faW5m
byAqYWkgPSBkZXYtPnByaXY7DQogCWRpc2FibGVfaW50ZXJydXB0cyhhaSk7
DQogCWZyZWVfaXJxKCBkZXYtPmlycSwgZGV2ICk7DQotCWlmIChhdXRvX3dl
cCkNCi0JCWRlbF90aW1lcl9zeW5jKCZhaS0+dGltZXIpOw0KIAl0YWtlZG93
bl9wcm9jX2VudHJ5KCBkZXYsIGFpICk7DQogCWlmIChhaS0+cmVnaXN0ZXJl
ZCkgew0KIAkJdW5yZWdpc3Rlcl9uZXRkZXYoIGRldiApOw0KQEAgLTE2Mjks
NyArMTYxOCw5IEBADQogCQl9DQogCQlhaS0+cmVnaXN0ZXJlZCA9IDA7DQog
CX0NCi0JZmx1c2hfc2NoZWR1bGVkX3Rhc2tzKCk7DQorCXNldF9iaXQoSk9C
X0RJRSwgJmFpLT5mbGFncyk7DQorCWtpbGxfcHJvYyhhaS0+dGhyX3BpZCwg
U0lHVEVSTSwgMSk7DQorCXdhaXRfZm9yX2NvbXBsZXRpb24oJmFpLT50aHJf
ZXhpdGVkKTsNCiAJaWYgKGFpLT5mbGFzaCkNCiAJCWtmcmVlKGFpLT5mbGFz
aCk7DQogCWlmIChhaS0+cnNzaSkNCkBAIC0xNzM0LDkgKzE3MjUsMTQgQEAN
CiAJc2VtYV9pbml0KCZhaS0+c2VtLCAxKTsNCiAJYWktPm5lZWRfY29tbWl0
ID0gMDsNCiAJYWktPmNvbmZpZy5sZW4gPSAwOw0KKwlpbml0X3dhaXRxdWV1
ZV9oZWFkICgmYWktPnRocl93YWl0KTsNCisJaW5pdF9jb21wbGV0aW9uICgm
YWktPnRocl9leGl0ZWQpOw0KKwlhaS0+dGhyX3BpZCA9IGtlcm5lbF90aHJl
YWQoYWlyb190aHJlYWQsIGRldiwgQ0xPTkVfRlMgfCBDTE9ORV9GSUxFUyk7
DQorCWlmIChhaS0+dGhyX3BpZCA8IDApDQorCQlnb3RvIGVycl9vdXRfZnJl
ZTsNCiAJcmMgPSBhZGRfYWlyb19kZXYoIGRldiApOw0KIAlpZiAocmMpDQot
CQlnb3RvIGVycl9vdXRfZnJlZTsNCisJCWdvdG8gZXJyX291dF90aHI7DQog
DQogCS8qIFRoZSBBaXJvLXNwZWNpZmljIGVudHJpZXMgaW4gdGhlIGRldmlj
ZSBzdHJ1Y3R1cmUuICovDQogCWRldi0+aGFyZF9zdGFydF94bWl0ID0gJmFp
cm9fc3RhcnRfeG1pdDsNCkBAIC0xNzc2LDcgKzE3NzIsNyBAQA0KIAkJfQ0K
IAl9IGVsc2Ugew0KIAkJYWktPmJhcF9yZWFkID0gZmFzdF9iYXBfcmVhZDsN
Ci0JCWFpLT5mbGFncyB8PSBGTEFHX0ZMQVNISU5HOw0KKwkJc2V0X2JpdChG
TEFHX0ZMQVNISU5HLCAmYWktPmZsYWdzKTsNCiAJfQ0KIA0KIAlyYyA9IHJl
Z2lzdGVyX25ldGRldihkZXYpOw0KQEAgLTE4MDcsNiArMTgwMywxMCBAQA0K
IAlmcmVlX2lycShkZXYtPmlycSwgZGV2KTsNCiBlcnJfb3V0X3VubGluazoN
CiAJZGVsX2Fpcm9fZGV2KGRldik7DQorZXJyX291dF90aHI6DQorCXNldF9i
aXQoSk9CX0RJRSwgJmFpLT5mbGFncyk7DQorCWtpbGxfcHJvYyhhaS0+dGhy
X3BpZCwgU0lHVEVSTSwgMSk7DQorCXdhaXRfZm9yX2NvbXBsZXRpb24oJmFp
LT50aHJfZXhpdGVkKTsNCiBlcnJfb3V0X2ZyZWU6DQogCWtmcmVlKGRldik7
DQogCXJldHVybiBOVUxMOw0KQEAgLTE4NzAsMzggKzE4NzAsMTAzIEBADQog
CXVuaW9uIGl3cmVxX2RhdGEgd3JxdTsNCiAJU3RhdHVzUmlkIHN0YXR1c19y
aWQ7DQogDQotCWlmIChkb3duX3RyeWxvY2soJmFpLT5zZW0pID09IDApIHsN
Ci0JCVBDNDUwMF9yZWFkcmlkKGFpLCBSSURfU1RBVFVTLCAmc3RhdHVzX3Jp
ZCwgc2l6ZW9mKHN0YXR1c19yaWQpLCAwKTsNCi0JCXVwKCZhaS0+c2VtKTsN
Ci0JCXdycXUuZGF0YS5sZW5ndGggPSAwOw0KLQkJd3JxdS5kYXRhLmZsYWdz
ID0gMDsNCi0JCW1lbWNweSh3cnF1LmFwX2FkZHIuc2FfZGF0YSwgc3RhdHVz
X3JpZC5ic3NpZFswXSwgRVRIX0FMRU4pOw0KLQkJd3JxdS5hcF9hZGRyLnNh
X2ZhbWlseSA9IEFSUEhSRF9FVEhFUjsNCisJY2xlYXJfYml0KEpPQl9FVkVO
VCwgJmFpLT5mbGFncyk7DQorCVBDNDUwMF9yZWFkcmlkKGFpLCBSSURfU1RB
VFVTLCAmc3RhdHVzX3JpZCwgc2l6ZW9mKHN0YXR1c19yaWQpLCAwKTsNCisJ
dXAoJmFpLT5zZW0pOw0KKwl3cnF1LmRhdGEubGVuZ3RoID0gMDsNCisJd3Jx
dS5kYXRhLmZsYWdzID0gMDsNCisJbWVtY3B5KHdycXUuYXBfYWRkci5zYV9k
YXRhLCBzdGF0dXNfcmlkLmJzc2lkWzBdLCBFVEhfQUxFTik7DQorCXdycXUu
YXBfYWRkci5zYV9mYW1pbHkgPSBBUlBIUkRfRVRIRVI7DQogDQotCQkvKiBT
ZW5kIGV2ZW50IHRvIHVzZXIgc3BhY2UgKi8NCi0JCXdpcmVsZXNzX3NlbmRf
ZXZlbnQoZGV2LCBTSU9DR0lXQVAsICZ3cnF1LCBOVUxMKTsNCi0JfSBlbHNl
IHsNCi0JCWFpLT5ldmVudF90YXNrLnJvdXRpbmUgPSAodm9pZCAoKikodm9p
ZCAqKSlhaXJvX3NlbmRfZXZlbnQ7DQotCQlhaS0+ZXZlbnRfdGFzay5kYXRh
ID0gKHZvaWQgKilkZXY7DQotCQlzY2hlZHVsZV90YXNrKCZhaS0+ZXZlbnRf
dGFzayk7DQotCX0NCisJLyogU2VuZCBldmVudCB0byB1c2VyIHNwYWNlICov
DQorCXdpcmVsZXNzX3NlbmRfZXZlbnQoZGV2LCBTSU9DR0lXQVAsICZ3cnF1
LCBOVUxMKTsNCiB9DQogI2VuZGlmDQogDQotc3RhdGljIHZvaWQgYWlyb19y
ZWFkX21pYyhzdHJ1Y3QgYWlyb19pbmZvICphaSkgew0KLQlNSUNSaWQgbWlj
X3JpZDsNCitzdGF0aWMgaW50IGFpcm9fdGhyZWFkKHZvaWQgKmRhdGEpIHsN
CisJc3RydWN0IG5ldF9kZXZpY2UgKmRldiA9IGRhdGE7DQorCXN0cnVjdCBh
aXJvX2luZm8gKmFpID0gZGV2LT5wcml2Ow0KKwlpbnQgbG9ja2VkOw0KKwkN
CisJZGFlbW9uaXplKCk7DQorCXJlcGFyZW50X3RvX2luaXQoKTsNCisJc2ln
ZW1wdHlzZXQoJmN1cnJlbnQtPmJsb2NrZWQpOw0KKwlyZWNhbGNfc2lncGVu
ZGluZyhjdXJyZW50KTsNCisNCisJc3RybmNweSAoY3VycmVudC0+Y29tbSwg
ZGV2LT5uYW1lLCBzaXplb2YoY3VycmVudC0+Y29tbSkgLSAxKTsNCisJY3Vy
cmVudC0+Y29tbVtzaXplb2YoY3VycmVudC0+Y29tbSkgLSAxXSA9ICdcMCc7
DQorDQorCXdoaWxlKDEpIHsNCisJCWlmIChzaWduYWxfcGVuZGluZyhjdXJy
ZW50KSkNCisJCQlmbHVzaF9zaWduYWxzKGN1cnJlbnQpOw0KIA0KLQlpZiAo
ZG93bl90cnlsb2NrKCZhaS0+c2VtKSA9PSAwKSB7DQotCQlQQzQ1MDBfcmVh
ZHJpZChhaSwgUklEX01JQywgJm1pY19yaWQsIHNpemVvZihtaWNfcmlkKSwg
MCk7DQotCQl1cCgmYWktPnNlbSk7DQorCQlpZiAodGVzdF9iaXQoSk9CX0RJ
RSwgJmFpLT5mbGFncykpDQorCQkJYnJlYWs7DQorDQorCQlpZiAoYWktPmZs
YWdzICYgSk9CX01BU0spIHsNCisJCQlsb2NrZWQgPSBkb3duX2ludGVycnVw
dGlibGUoJmFpLT5zZW0pOw0KKwkJfSBlbHNlIHsNCisJCQl3YWl0X3F1ZXVl
X3Qgd2FpdDsNCisNCisJCQlpbml0X3dhaXRxdWV1ZV9lbnRyeSgmd2FpdCwg
Y3VycmVudCk7DQorCQkJYWRkX3dhaXRfcXVldWUoJmFpLT50aHJfd2FpdCwg
JndhaXQpOw0KKwkJCWZvciAoOzspIHsNCisJCQkJc2V0X2N1cnJlbnRfc3Rh
dGUoVEFTS19JTlRFUlJVUFRJQkxFKTsNCisJCQkJaWYgKGFpLT5mbGFncyAm
IEpPQl9NQVNLKQ0KKwkJCQkJYnJlYWs7DQorCQkJCWlmIChhaS0+ZXhwaXJl
cykgew0KKwkJCQkJaWYgKHRpbWVfYWZ0ZXJfZXEoamlmZmllcyxhaS0+ZXhw
aXJlcykpew0KKwkJCQkJCXNldF9iaXQoSk9CX0FVVE9XRVAsJmFpLT5mbGFn
cyk7DQorCQkJCQkJYnJlYWs7DQorCQkJCQl9DQorCQkJCQlpZiAoIXNpZ25h
bF9wZW5kaW5nKGN1cnJlbnQpKSB7DQorCQkJCQkJc2NoZWR1bGVfdGltZW91
dChhaS0+ZXhwaXJlcyAtIGppZmZpZXMpOw0KKwkJCQkJCWNvbnRpbnVlOw0K
KwkJCQkJfQ0KKwkJCQl9IGVsc2UgaWYgKCFzaWduYWxfcGVuZGluZyhjdXJy
ZW50KSkgew0KKwkJCQkJc2NoZWR1bGUoKTsNCisJCQkJCWNvbnRpbnVlOw0K
KwkJCQl9DQorCQkJCWJyZWFrOw0KKwkJCX0NCisJCQljdXJyZW50LT5zdGF0
ZSA9IFRBU0tfUlVOTklORzsNCisJCQlyZW1vdmVfd2FpdF9xdWV1ZSgmYWkt
PnRocl93YWl0LCAmd2FpdCk7DQorCQkJbG9ja2VkID0gMTsNCisJCX0NCisN
CisJCWlmIChsb2NrZWQpDQorCQkJY29udGludWU7DQorDQorCQlpZiAodGVz
dF9iaXQoSk9CX0RJRSwgJmFpLT5mbGFncykpIHsNCisJCQl1cCgmYWktPnNl
bSk7DQorCQkJYnJlYWs7DQorCQl9DQorDQorCQlpZiAodGVzdF9iaXQoRkxB
R19GTEFTSElORywgJmFpLT5mbGFncykpIHsNCisJCQl1cCgmYWktPnNlbSk7
DQorCQkJY29udGludWU7DQorCQl9DQorDQorCQlpZiAodGVzdF9iaXQoSk9C
X1hNSVQsICZhaS0+ZmxhZ3MpKQ0KKwkJCWFpcm9fZW5kX3htaXQoZGV2KTsN
CisJCWVsc2UgaWYgKHRlc3RfYml0KEpPQl9YTUlUMTEsICZhaS0+ZmxhZ3Mp
KQ0KKwkJCWFpcm9fZW5kX3htaXQxMShkZXYpOw0KKwkJZWxzZSBpZiAodGVz
dF9iaXQoSk9CX1NUQVRTLCAmYWktPmZsYWdzKSkNCisJCQlhaXJvX3JlYWRf
c3RhdHMoYWkpOw0KKwkJZWxzZSBpZiAodGVzdF9iaXQoSk9CX1BST01JU0Ms
ICZhaS0+ZmxhZ3MpKQ0KKwkJCWFpcm9fc2V0X3Byb21pc2MoYWkpOw0KICNp
ZmRlZiBNSUNTVVBQT1JUDQotCQltaWNpbml0IChhaSwgJm1pY19yaWQpOw0K
KwkJZWxzZSBpZiAodGVzdF9iaXQoSk9CX01JQywgJmFpLT5mbGFncykpDQor
CQkJbWljaW5pdChhaSk7DQogI2VuZGlmDQotCX0gZWxzZSB7DQotCQlhaS0+
bWljX3Rhc2sucm91dGluZSA9ICh2b2lkICgqKSh2b2lkICopKWFpcm9fcmVh
ZF9taWM7DQotCQlhaS0+bWljX3Rhc2suZGF0YSA9ICh2b2lkICopYWk7DQot
CQlzY2hlZHVsZV90YXNrKCZhaS0+bWljX3Rhc2spOw0KKyNpZiBXSVJFTEVT
U19FWFQgPiAxMw0KKwkJZWxzZSBpZiAodGVzdF9iaXQoSk9CX0VWRU5ULCAm
YWktPmZsYWdzKSkNCisJCQlhaXJvX3NlbmRfZXZlbnQoZGV2KTsNCisjZW5k
aWYNCisJCWVsc2UgaWYgKHRlc3RfYml0KEpPQl9BVVRPV0VQLCAmYWktPmZs
YWdzKSkNCisJCQl0aW1lcl9mdW5jKGRldik7DQogCX0NCisJY29tcGxldGVf
YW5kX2V4aXQgKCZhaS0+dGhyX2V4aXRlZCwgMCk7DQogfQ0KIA0KIHN0YXRp
YyB2b2lkIGFpcm9faW50ZXJydXB0ICggaW50IGlycSwgdm9pZCogZGV2X2lk
LCBzdHJ1Y3QgcHRfcmVncyAqcmVncykgew0KQEAgLTE5MzAsOCArMTk5NSwx
NSBAQA0KIA0KIAkJaWYgKCBzdGF0dXMgJiBFVl9NSUMgKSB7DQogCQkJT1VU
NDUwMCggYXByaXYsIEVWQUNLLCBFVl9NSUMgKTsNCi0JCQlpZiAoYXByaXYt
PmZsYWdzICYgRkxBR19NSUNfQ0FQQUJMRSkNCi0JCQkJYWlyb19yZWFkX21p
YyggYXByaXYgKTsNCisjaWZkZWYgTUlDU1VQUE9SVA0KKwkJCWlmICh0ZXN0
X2JpdChGTEFHX01JQ19DQVBBQkxFLCAmYXByaXYtPmZsYWdzKSkgew0KKwkJ
CQlpZiAoZG93bl90cnlsb2NrKCZhcHJpdi0+c2VtKSAhPSAwKSB7DQorCQkJ
CQlzZXRfYml0KEpPQl9NSUMsICZhcHJpdi0+ZmxhZ3MpOw0KKwkJCQkJd2Fr
ZV91cF9pbnRlcnJ1cHRpYmxlKCZhcHJpdi0+dGhyX3dhaXQpOw0KKwkJCQl9
IGVsc2UNCisJCQkJCW1pY2luaXQgKGFwcml2KTsNCisJCQl9DQorI2VuZGlm
DQogCQl9DQogCQlpZiAoIHN0YXR1cyAmIEVWX0xJTksgKSB7DQogI2lmIFdJ
UkVMRVNTX0VYVCA+IDEzDQpAQCAtMTk3MywxNSArMjA0NSwxOCBAQA0KICNk
ZWZpbmUgUkNfTk9BVVRIIDkgLyogU3RhdGlvbiByZXF1ZXN0aW5nIChSZSlB
c3NvY2lhdGlvbiBpcyBub3QNCiAJCSAgICAgICBBdXRoZW50aWNhdGVkIHdp
dGggdGhlIHJlc3BvbmRpbmcgc3RhdGlvbiAqLw0KIAkJCWlmIChuZXdTdGF0
dXMgIT0gQVNTT0NJQVRFRCkgew0KLQkJCQlpZiAoYXV0b193ZXAgJiYgIXRp
bWVyX3BlbmRpbmcoJmFwcml2LT50aW1lcikpIHsNCi0JCQkJCWFwcml2LT50
aW1lci5leHBpcmVzID0gUlVOX0FUKEhaKjMpOw0KLQkJICAgICAgCQkJYWRk
X3RpbWVyKCZhcHJpdi0+dGltZXIpOw0KKwkJCQlpZiAoYXV0b193ZXAgJiYg
IWFwcml2LT5leHBpcmVzKSB7DQorCQkJCQlhcHJpdi0+ZXhwaXJlcyA9IFJV
Tl9BVCgzKkhaKTsNCisJCQkJCXdha2VfdXBfaW50ZXJydXB0aWJsZSgmYXBy
aXYtPnRocl93YWl0KTsNCiAJCQkJfQ0KIAkJCX0gZWxzZSB7DQogCQkJCXN0
cnVjdCB0YXNrX3N0cnVjdCAqdGFzayA9IGFwcml2LT50YXNrOw0KKwkJCQlp
ZiAoYXV0b193ZXApDQorCQkJCQlhcHJpdi0+ZXhwaXJlcyA9IDA7DQogCQkJ
CWlmICh0YXNrKQ0KIAkJCQkJd2FrZV91cF9wcm9jZXNzICh0YXNrKTsNCi0J
CQkJYXByaXYtPmZsYWdzfD1GTEFHX1VQREFURV9VTkl8RkxBR19VUERBVEVf
TVVMVEk7DQorCQkJCXNldF9iaXQoRkxBR19VUERBVEVfVU5JLCAmYXByaXYt
PmZsYWdzKTsNCisJCQkJc2V0X2JpdChGTEFHX1VQREFURV9NVUxUSSwgJmFw
cml2LT5mbGFncyk7DQogCQkJfQ0KICNpZiBXSVJFTEVTU19FWFQgPiAxMw0K
IAkJCS8qIFF1ZXN0aW9uIDogaXMgQVNTT0NJQVRFRCB0aGUgb25seSBzdGF0
dXMNCkBAIC0yMDAyLDcgKzIwNzcsMTEgQEANCiAJCQkJCXdpcmVsZXNzX3Nl
bmRfZXZlbnQoZGV2LCBTSU9DR0lXU0NBTiwgJndycXUsIE5VTEwpOw0KIAkJ
CQkJYXByaXYtPnNjYW5fdGltZXN0YW1wID0gMDsNCiAJCQkJfQ0KLQkJCQlh
aXJvX3NlbmRfZXZlbnQoZGV2KTsNCisJCQkJaWYgKGRvd25fdHJ5bG9jaygm
YXByaXYtPnNlbSkgIT0gMCkgew0KKwkJCQkJc2V0X2JpdChKT0JfRVZFTlQs
ICZhcHJpdi0+ZmxhZ3MpOw0KKwkJCQkJd2FrZV91cF9pbnRlcnJ1cHRpYmxl
KCZhcHJpdi0+dGhyX3dhaXQpOw0KKwkJCQl9IGVsc2UNCisJCQkJCWFpcm9f
c2VuZF9ldmVudChkZXYpOw0KIAkJCX0gZWxzZSB7DQogCQkJCW1lbXNldCh3
cnF1LmFwX2FkZHIuc2FfZGF0YSwgJ1wwJywgRVRIX0FMRU4pOw0KIAkJCQl3
cnF1LmFwX2FkZHIuc2FfZmFtaWx5ID0gQVJQSFJEX0VUSEVSOw0KQEAgLTIw
MzMsNyArMjExMiw3IEBADQogCQkJZmlkID0gSU40NTAwKCBhcHJpdiwgUlhG
SUQgKTsNCiANCiAJCQkvKiBHZXQgdGhlIHBhY2tldCBsZW5ndGggKi8NCi0J
CQlpZiAoYXByaXYtPmZsYWdzICYgRkxBR184MDJfMTEpIHsNCisJCQlpZiAo
dGVzdF9iaXQoRkxBR184MDJfMTEsICZhcHJpdi0+ZmxhZ3MpKSB7DQogCQkJ
CWJhcF9zZXR1cCAoYXByaXYsIGZpZCwgNCwgQkFQMCk7DQogCQkJCWJhcF9y
ZWFkIChhcHJpdiwgKHUxNiopJmhkciwgc2l6ZW9mKGhkciksIEJBUDApOw0K
IAkJCQkvKiBCYWQgQ1JDLiBJZ25vcmUgcGFja2V0ICovDQpAQCAtMjA1Miw3
ICsyMTMxLDcgQEANCiAJCQkJbGVuID0gMDsNCiAJCQl9DQogCQkJaWYgKGxl
bikgew0KLQkJCQlpZiAoYXByaXYtPmZsYWdzICYgRkxBR184MDJfMTEpIHsN
CisJCQkJaWYgKHRlc3RfYml0KEZMQUdfODAyXzExLCAmYXByaXYtPmZsYWdz
KSkgew0KIAkJCQkJYmFwX3JlYWQgKGFwcml2LCAodTE2KikmZmMsIHNpemVv
ZihmYyksIEJBUDApOw0KIAkJCQkJZmMgPSBsZTE2X3RvX2NwdShmYyk7DQog
CQkJCQlzd2l0Y2ggKGZjICYgMHhjKSB7DQpAQCAtMjA4MSw3ICsyMTYwLDcg
QEANCiAJCQl9DQogCQkJaWYgKGxlbikgew0KIAkJCQlidWZmZXIgPSAodTE2
Kilza2JfcHV0IChza2IsIGxlbiArIGhkcmxlbik7DQotCQkJCWlmIChhcHJp
di0+ZmxhZ3MgJiBGTEFHXzgwMl8xMSkgew0KKwkJCQlpZiAodGVzdF9iaXQo
RkxBR184MDJfMTEsICZhcHJpdi0+ZmxhZ3MpKSB7DQogCQkJCQlidWZmZXJb
MF0gPSBmYzsNCiAJCQkJCWJhcF9yZWFkIChhcHJpdiwgYnVmZmVyICsgMSwg
aGRybGVuIC0gMiwgQkFQMCk7DQogCQkJCQlpZiAoaGRybGVuID09IDI0KQ0K
QEAgLTIxMjgsMTEgKzIyMDcsMTIgQEANCiAJCQkJCWNoYXIgKnNhOw0KIAkJ
CQkJc3RydWN0IGl3X3F1YWxpdHkgd3N0YXRzOw0KIAkJCQkJLyogUHJlcGFy
ZSBzcHkgZGF0YSA6IGFkZHIgKyBxdWFsICovDQotCQkJCQlzYSA9IChjaGFy
KilidWZmZXIgKyAoKGFwcml2LT5mbGFncyAmIEZMQUdfODAyXzExKSA/IDEw
IDogNik7DQotCQkJCQlpZiAoIShhcHJpdi0+ZmxhZ3MgJiBGTEFHXzgwMl8x
MSkpIHsNCisJCQkJCWlmICghdGVzdF9iaXQoRkxBR184MDJfMTEsICZhcHJp
di0+ZmxhZ3MpKSB7DQorCQkJCQkJc2EgPSAoY2hhciopYnVmZmVyICsgNjsN
CiAJCQkJCQliYXBfc2V0dXAgKGFwcml2LCBmaWQsIDgsIEJBUDApOw0KIAkJ
CQkJCWJhcF9yZWFkIChhcHJpdiwgKHUxNiopaGRyLnJzc2ksIDIsIEJBUDAp
Ow0KLQkJCQkJfQ0KKwkJCQkJfSBlbHNlDQorCQkJCQkJc2EgPSAoY2hhciop
YnVmZmVyICsgMTA7DQogCQkJCQl3c3RhdHMucXVhbCA9IGhkci5yc3NpWzBd
Ow0KIAkJCQkJaWYgKGFwcml2LT5yc3NpKQ0KIAkJCQkJCXdzdGF0cy5sZXZl
bCA9IDB4MTAwIC0gYXByaXYtPnJzc2lbaGRyLnJzc2lbMV1dLnJzc2lkQm07
DQpAQCAtMjE0OSwxMiArMjIyOSwxMiBAQA0KIAkJCQkJaW50IGk7DQogCQkJ
CQljaGFyICpzYTsNCiANCi0JCQkJCXNhID0gKGNoYXIqKWJ1ZmZlciArICgo
YXByaXYtPmZsYWdzICYgRkxBR184MDJfMTEpID8gMTAgOiA2KTsNCisJCQkJ
CXNhID0gKGNoYXIqKWJ1ZmZlciArICh0ZXN0X2JpdChGTEFHXzgwMl8xMSwg
JmFwcml2LT5mbGFncykgPyAxMCA6IDYpOw0KIA0KIAkJCQkJZm9yIChpPTA7
IGk8YXByaXYtPnNweV9udW1iZXI7IGkrKykNCiAJCQkJCQlpZiAoIW1lbWNt
cChzYSxhcHJpdi0+c3B5X2FkZHJlc3NbaV0sRVRIX0FMRU4pKQ0KIAkJCQkJ
CXsNCi0JCQkJCQkJaWYgKCEoYXByaXYtPmZsYWdzICYgRkxBR184MDJfMTEp
KSB7DQorCQkJCQkJCWlmICghdGVzdF9iaXQoRkxBR184MDJfMTEsICZhcHJp
di0+ZmxhZ3MpKSB7DQogCQkJCQkJCQliYXBfc2V0dXAgKGFwcml2LCBmaWQs
IDgsIEJBUDApOw0KIAkJCQkJCQkJYmFwX3JlYWQgKGFwcml2LCAodTE2Kilo
ZHIucnNzaSwgMiwgQkFQMCk7DQogCQkJCQkJCX0NCkBAIC0yMTcyLDcgKzIy
NTIsNyBAQA0KICNlbmRpZiAvKiBXSVJFTEVTU19FWFQgPiAxNSAqLw0KIAkJ
CQlPVVQ0NTAwKCBhcHJpdiwgRVZBQ0ssIEVWX1JYKTsNCiANCi0JCQkJaWYg
KGFwcml2LT5mbGFncyAmIEZMQUdfODAyXzExKSB7DQorCQkJCWlmICh0ZXN0
X2JpdChGTEFHXzgwMl8xMSwgJmFwcml2LT5mbGFncykpIHsNCiAJCQkJCXNr
Yi0+bWFjLnJhdyA9IHNrYi0+ZGF0YTsNCiAJCQkJCXNrYi0+cGt0X3R5cGUg
PSBQQUNLRVRfT1RIRVJIT1NUOw0KIAkJCQkJc2tiLT5kZXYgPSBhcHJpdi0+
d2lmaWRldjsNCkBAIC0yMjEwLDEwICsyMjkwLDEwIEBADQogCQkJCS8qIFNl
dCB1cCB0byBiZSB1c2VkIGFnYWluICovDQogCQkJCWFwcml2LT5maWRzW2lu
ZGV4XSAmPSAweGZmZmY7DQogCQkJCWlmIChpbmRleCA8IE1BWF9GSURTIC8g
Mikgew0KLQkJCQkJaWYgKCEoYXByaXYtPmZsYWdzICYgRkxBR19QRU5ESU5H
X1hNSVQpKQ0KKwkJCQkJaWYgKCF0ZXN0X2JpdChGTEFHX1BFTkRJTkdfWE1J
VCwgJmFwcml2LT5mbGFncykpDQogCQkJCQkJbmV0aWZfd2FrZV9xdWV1ZShk
ZXYpOw0KIAkJCQl9IGVsc2Ugew0KLQkJCQkJaWYgKCEoYXByaXYtPmZsYWdz
ICYgRkxBR19QRU5ESU5HX1hNSVQxMSkpDQorCQkJCQlpZiAoIXRlc3RfYml0
KEZMQUdfUEVORElOR19YTUlUMTEsICZhcHJpdi0+ZmxhZ3MpKQ0KIAkJCQkJ
CW5ldGlmX3dha2VfcXVldWUoYXByaXYtPndpZmlkZXYpOw0KIAkJCQl9DQog
CQkJfSBlbHNlIHsNCkBAIC0yMjczLDcgKzIzNTMsNyBAQA0KIAkgKiBpbnN0
ZWFkIG9mIHRoaXMgZmxhZywgYnV0IEkgZG9uJ3QgdHJ1c3QgaXQgKndpdGhp
biogdGhlDQogCSAqIG9wZW4vY2xvc2UgZnVuY3Rpb25zLCBhbmQgdGVzdGlu
ZyBib3RoIGZsYWdzIHRvZ2V0aGVyIGlzDQogCSAqICJjaGVhcGVyIiAtIEpl
YW4gSUkgKi8NCi0JaWYgKGFpLT5mbGFncyAmIChGTEFHX1JBRElPX09GRnxG
TEFHX1JBRElPX0RPV04pKSByZXR1cm4gU1VDQ0VTUzsNCisJaWYgKGFpLT5m
bGFncyAmIEZMQUdfUkFESU9fTUFTSykgcmV0dXJuIFNVQ0NFU1M7DQogCW1l
bXNldCgmY21kLCAwLCBzaXplb2YoY21kKSk7DQogCWNtZC5jbWQgPSBNQUNf
RU5BQkxFOw0KIAlpZiAoIWxvY2spDQpAQCAtMjM5NCwxMCArMjQ3NCwxMCBA
QA0KIAkJYWktPmNvbmZpZy5vcG1vZGUgPSBhZGhvYyA/IE1PREVfU1RBX0lC
U1MgOiBNT0RFX1NUQV9FU1M7DQogDQogI2lmZGVmIE1JQ1NVUFBPUlQNCi0J
CWlmICgoY2FwX3JpZC5sZW4+PXNpemVvZihjYXBfcmlkKSkgJiYgKGNhcF9y
aWQuZXh0U29mdENhcCYxKSkgew0KKwkJaWYgKChjYXBfcmlkLmxlbj49c2l6
ZW9mKGNhcF9yaWQpKSAmJiAoY2FwX3JpZC5leHRTb2Z0Q2FwJjEpICYmDQor
CQkgICAgKG1pY3NldHVwKGFpKSA9PSBTVUNDRVNTKSkgew0KIAkJCWFpLT5j
b25maWcub3Btb2RlIHw9IE1PREVfTUlDOw0KLQkJCWFpLT5mbGFncyB8PSBG
TEFHX01JQ19DQVBBQkxFOw0KLQkJCW1pY3NldHVwKGFpKTsNCisJCQlzZXRf
Yml0KEZMQUdfTUlDX0NBUEFCTEUsICZhaS0+ZmxhZ3MpOw0KIAkJfQ0KICNl
bmRpZg0KIA0KQEAgLTI0NjMsMzQgKzI1NDMsMTUgQEANCiAJCXJjID0gcmVh
ZFdlcEtleVJpZChhaSwgJndrciwgMCk7DQogCX0gd2hpbGUobGFzdGluZGV4
ICE9IHdrci5raW5kZXgpOw0KIA0KLQlpZiAoYXV0b193ZXAgJiYgIXRpbWVy
X3BlbmRpbmcoJmFpLT50aW1lcikpIHsNCi0JCWFpLT50aW1lci5leHBpcmVz
ID0gUlVOX0FUKEhaKjMpOw0KLQkJYWRkX3RpbWVyKCZhaS0+dGltZXIpOw0K
KwlpZiAoYXV0b193ZXApIHsNCisJCWFpLT5leHBpcmVzID0gUlVOX0FUKDMq
SFopOw0KKwkJd2FrZV91cF9pbnRlcnJ1cHRpYmxlKCZhaS0+dGhyX3dhaXQp
Ow0KIAl9DQotCXJldHVybiBTVUNDRVNTOw0KLX0NCi0NCi1zdGF0aWMgdTE2
IGlzc3VlY29tbWFuZChzdHJ1Y3QgYWlyb19pbmZvICphaSwgQ21kICpwQ21k
LCBSZXNwICpwUnNwKSB7DQotICAgICAgICAvLyBJbSByZWFsbHkgcGFyYW5v
aWQgYWJvdXQgbGV0dGluZyBpdCBydW4gZm9yZXZlciENCi0JaW50IG1heF90
cmllcyA9IDYwMDAwMDsNCi0NCi0JaWYgKHNlbmRjb21tYW5kKGFpLCBwQ21k
KSA9PSAodTE2KUVSUk9SKQ0KLQkJcmV0dXJuIEVSUk9SOw0KIA0KLQl3aGls
ZSAobWF4X3RyaWVzLS0gJiYgKElONDUwMChhaSwgRVZTVEFUKSAmIEVWX0NN
RCkgPT0gMCkgew0KLQkJaWYgKCFpbl9pbnRlcnJ1cHQoKSAmJiAobWF4X3Ry
aWVzICYgMjU1KSA9PSAwKQ0KLQkJCXNjaGVkdWxlKCk7DQotCX0NCi0JaWYg
KCBtYXhfdHJpZXMgPT0gLTEgKSB7DQotCQlwcmludGsoIEtFUk5fRVJSDQot
CQkJImFpcm86IE1heCB0cmllcyBleGNlZWRlZCB3YWl0aW5nIGZvciBjb21t
YW5kXG4iICk7DQotICAgICAgICAgICAgICAgIHJldHVybiBFUlJPUjsNCi0J
fQ0KLQljb21wbGV0ZWNvbW1hbmQoYWksIHBSc3ApOw0KIAlyZXR1cm4gU1VD
Q0VTUzsNCiB9DQogDQotc3RhdGljIHUxNiBzZW5kY29tbWFuZChzdHJ1Y3Qg
YWlyb19pbmZvICphaSwgQ21kICpwQ21kKSB7DQorc3RhdGljIHUxNiBpc3N1
ZWNvbW1hbmQoc3RydWN0IGFpcm9faW5mbyAqYWksIENtZCAqcENtZCwgUmVz
cCAqcFJzcCkgew0KICAgICAgICAgLy8gSW0gcmVhbGx5IHBhcmFub2lkIGFi
b3V0IGxldHRpbmcgaXQgcnVuIGZvcmV2ZXIhDQogCWludCBtYXhfdHJpZXMg
PSA2MDAwMDA7DQogCXUxNiBjbWQ7DQpAQCAtMjUwOSwxMCArMjU3MCwxNiBA
QA0KIAkJCSJhaXJvOiBNYXggdHJpZXMgZXhjZWVkZWQgd2hlbiBpc3N1ZWlu
ZyBjb21tYW5kXG4iICk7DQogICAgICAgICAgICAgICAgIHJldHVybiBFUlJP
UjsNCiAJfQ0KLQlyZXR1cm4gU1VDQ0VTUzsNCi19DQogDQotc3RhdGljIHZv
aWQgY29tcGxldGVjb21tYW5kKHN0cnVjdCBhaXJvX2luZm8gKmFpLCBSZXNw
ICpwUnNwKSB7DQorCXdoaWxlIChtYXhfdHJpZXMtLSAmJiAoSU40NTAwKGFp
LCBFVlNUQVQpICYgRVZfQ01EKSA9PSAwKSB7DQorCQlpZiAoIWluX2ludGVy
cnVwdCgpICYmIChtYXhfdHJpZXMgJiAyNTUpID09IDApDQorCQkJc2NoZWR1
bGUoKTsNCisJfQ0KKwlpZiAoIG1heF90cmllcyA9PSAtMSApIHsNCisJCXBy
aW50ayggS0VSTl9FUlINCisJCQkiYWlybzogTWF4IHRyaWVzIGV4Y2VlZGVk
IHdhaXRpbmcgZm9yIGNvbW1hbmRcbiIgKTsNCisgICAgICAgICAgICAgICAg
cmV0dXJuIEVSUk9SOw0KKwl9DQogCS8vIGNvbW1hbmQgY29tcGxldGVkDQog
CXBSc3AtPnN0YXR1cyA9IElONDUwMChhaSwgU1RBVFVTKTsNCiAJcFJzcC0+
cnNwMCA9IElONDUwMChhaSwgUkVTUDApOw0KQEAgLTI1MjUsNiArMjU5Miw4
IEBADQogCX0NCiAJLy8gYWNrbm93bGVkZ2UgcHJvY2Vzc2luZyB0aGUgc3Rh
dHVzL3Jlc3BvbnNlDQogCU9VVDQ1MDAoYWksIEVWQUNLLCBFVl9DTUQpOw0K
Kw0KKwlyZXR1cm4gU1VDQ0VTUzsNCiB9DQogDQogLyogU2V0cyB1cCB0aGUg
YmFwIHRvIHN0YXJ0IGV4Y2hhbmdlIGRhdGEuICB3aGljaGJhcCBzaG91bGQN
CkBAIC0yODExLDcgKzI4ODAsNyBAQA0KIAlsZW4gLT0gRVRIX0FMRU4gKiAy
Ow0KIA0KICNpZmRlZiBNSUNTVVBQT1JUDQotCWlmICgoYWktPmZsYWdzICYg
RkxBR19NSUNfQ0FQQUJMRSkgJiYgYWktPm1pY3N0YXRzLmVuYWJsZWQgJiYg
DQorCWlmICh0ZXN0X2JpdChGTEFHX01JQ19DQVBBQkxFLCAmYWktPmZsYWdz
KSAmJiBhaS0+bWljc3RhdHMuZW5hYmxlZCAmJiANCiAJICAgIChudG9ocygo
KHUxNiAqKXBQYWNrZXQpWzZdKSAhPSAweDg4OEUpKSB7DQogCQlpZiAoZW5j
YXBzdWxhdGUoYWksKGV0aGVySGVhZCAqKXBQYWNrZXQsJnBNaWMsbGVuKSAh
PSBTVUNDRVNTKQ0KIAkJCXJldHVybiBFUlJPUjsNCkBAIC0zMzE0LDcgKzMz
ODMsNyBAQA0KIAkJCWlmICgoYWktPmNvbmZpZy5ybW9kZSAmIDB4ZmYpID49
IFJYTU9ERV9SRk1PTikNCiAJCQkJCWFpLT5uZWVkX2NvbW1pdCA9IDI7DQog
CQkJYWktPmNvbmZpZy5ybW9kZSAmPSAweGZlMDA7DQotCQkJYWktPmZsYWdz
ICY9IH5GTEFHXzgwMl8xMTsNCisJCQljbGVhcl9iaXQgKEZMQUdfODAyXzEx
LCAmYWktPmZsYWdzKTsNCiAJCQlhaS0+Y29uZmlnLm9wbW9kZSAmPSAweEZG
MDA7DQogCQkJYWktPmNvbmZpZy5zY2FuTW9kZSA9IFNDQU5NT0RFX0FDVElW
RTsNCiAJCQlpZiAoIGxpbmVbMF0gPT0gJ2EnICkgew0KQEAgLTMzMjQsMTEg
KzMzOTMsMTEgQEANCiAJCQkJaWYgKCBsaW5lWzBdID09ICdyJyApIHsNCiAJ
CQkJCWFpLT5jb25maWcucm1vZGUgfD0gUlhNT0RFX1JGTU9OIHwgUlhNT0RF
X0RJU0FCTEVfODAyXzNfSEVBREVSOw0KIAkJCQkJYWktPmNvbmZpZy5zY2Fu
TW9kZSA9IFNDQU5NT0RFX1BBU1NJVkU7DQotCQkJCQlhaS0+ZmxhZ3MgfD0g
RkxBR184MDJfMTE7DQorCQkJCQlzZXRfYml0IChGTEFHXzgwMl8xMSwgJmFp
LT5mbGFncyk7DQogCQkJCX0gZWxzZSBpZiAoIGxpbmVbMF0gPT0gJ3knICkg
ew0KIAkJCQkJYWktPmNvbmZpZy5ybW9kZSB8PSBSWE1PREVfUkZNT05fQU5Z
QlNTIHwgUlhNT0RFX0RJU0FCTEVfODAyXzNfSEVBREVSOw0KIAkJCQkJYWkt
PmNvbmZpZy5zY2FuTW9kZSA9IFNDQU5NT0RFX1BBU1NJVkU7DQotCQkJCQlh
aS0+ZmxhZ3MgfD0gRkxBR184MDJfMTE7DQorCQkJCQlzZXRfYml0IChGTEFH
XzgwMl8xMSwgJmFpLT5mbGFncyk7DQogCQkJCX0gZWxzZSBpZiAoIGxpbmVb
MF0gPT0gJ2wnICkNCiAJCQkJCWFpLT5jb25maWcucm1vZGUgfD0gUlhNT0RF
X0xBTk1PTjsNCiAJCQl9DQpAQCAtMzMzOSw5ICszNDA4LDkgQEANCiAJCWVs
c2UgaWYgKCFzdHJuY21wKGxpbmUsIlJhZGlvOiAiLCA3KSkgew0KIAkJCWxp
bmUgKz0gNzsNCiAJCQlpZiAoIXN0cm5jbXAobGluZSwib2ZmIiwzKSkgew0K
LQkJCQlhaS0+ZmxhZ3MgfD0gRkxBR19SQURJT19PRkY7DQorCQkJCXNldF9i
aXQgKEZMQUdfUkFESU9fT0ZGLCAmYWktPmZsYWdzKTsNCiAJCQl9IGVsc2Ug
ew0KLQkJCQlhaS0+ZmxhZ3MgJj0gfkZMQUdfUkFESU9fT0ZGOw0KKwkJCQlj
bGVhcl9iaXQgKEZMQUdfUkFESU9fT0ZGLCAmYWktPmZsYWdzKTsNCiAJCQl9
DQogCQl9DQogLyoqKiBOb2RlTmFtZSBwcm9jZXNzaW5nICovDQpAQCAtMzU0
NSw3ICszNjE0LDcgQEANCiAJCSAgICAgKGFpLT5jb25maWcub3Btb2RlICYg
MHhGRikgPT0gMSA/IGdldF9ybW9kZShhaS0+Y29uZmlnLnJtb2RlKToNCiAJ
CSAgICAgKGFpLT5jb25maWcub3Btb2RlICYgMHhGRikgPT0gMiA/ICJBUCIg
Og0KIAkJICAgICAoYWktPmNvbmZpZy5vcG1vZGUgJiAweEZGKSA9PSAzID8g
IkFQIFJQVFIiIDogIkVycm9yIiwNCi0JCSAgICAgYWktPmZsYWdzJkZMQUdf
UkFESU9fT0ZGID8gIm9mZiIgOiAib24iLA0KKwkJICAgICB0ZXN0X2JpdChG
TEFHX1JBRElPX09GRiwgJmFpLT5mbGFncykgPyAib2ZmIiA6ICJvbiIsDQog
CQkgICAgIGFpLT5jb25maWcubm9kZU5hbWUsDQogCQkgICAgIGFpLT5jb25m
aWcucG93ZXJTYXZlTW9kZSA9PSAwID8gIkNBTSIgOg0KIAkJICAgICBhaS0+
Y29uZmlnLnBvd2VyU2F2ZU1vZGUgPT0gMSA/ICJQU1AiIDoNCkBAIC00MDEy
LDIzICs0MDgxLDE0IEBADQogICAgd2lsbCBzd2l0Y2ggV0VQIG1vZGVzIHRv
IHNlZSBpZiB0aGF0IHdpbGwgaGVscC4gIElmIHRoZSBjYXJkIGlzDQogICAg
YXNzb2NpYXRlZCB3ZSB3aWxsIGNoZWNrIGV2ZXJ5IG1pbnV0ZSB0byBzZWUg
aWYgYW55dGhpbmcgaGFzDQogICAgY2hhbmdlZC4gKi8NCi1zdGF0aWMgdm9p
ZCB0aW1lcl9mdW5jKCB1X2xvbmcgZGF0YSApIHsNCi0Jc3RydWN0IG5ldF9k
ZXZpY2UgKmRldiA9IChzdHJ1Y3QgbmV0X2RldmljZSopZGF0YTsNCitzdGF0
aWMgdm9pZCB0aW1lcl9mdW5jKCBzdHJ1Y3QgbmV0X2RldmljZSAqZGV2ICkg
ew0KIAlzdHJ1Y3QgYWlyb19pbmZvICphcHJpdiA9IGRldi0+cHJpdjsNCi0J
dTE2IGxpbmtzdGF0ID0gSU40NTAwKGFwcml2LCBMSU5LU1RBVCk7DQogCVJl
c3AgcnNwOw0KIA0KLQlpZiAoIShhcHJpdi0+ZmxhZ3MgJiBGTEFHX0ZMQVNI
SU5HKSAmJiAobGlua3N0YXQgIT0gMHg0MDApKSB7DQogLyogV2UgZG9uJ3Qg
aGF2ZSBhIGxpbmsgc28gdHJ5IGNoYW5naW5nIHRoZSBhdXRodHlwZSAqLw0K
LQkJaWYgKGRvd25fdHJ5bG9jaygmYXByaXYtPnNlbSkgIT0gMCkgew0KLQkJ
CWFwcml2LT50aW1lci5leHBpcmVzID0gUlVOX0FUKDEpOw0KLQkJCWFkZF90
aW1lcigmYXByaXYtPnRpbWVyKTsNCi0JCQlyZXR1cm47DQotCQl9DQotDQot
CQlyZWFkQ29uZmlnUmlkKGFwcml2LCAwKTsNCi0JCWRpc2FibGVfTUFDKGFw
cml2LCAwKTsNCi0JCXN3aXRjaChhcHJpdi0+Y29uZmlnLmF1dGhUeXBlKSB7
DQorCXJlYWRDb25maWdSaWQoYXByaXYsIDApOw0KKwlkaXNhYmxlX01BQyhh
cHJpdiwgMCk7DQorCXN3aXRjaChhcHJpdi0+Y29uZmlnLmF1dGhUeXBlKSB7
DQogCQljYXNlIEFVVEhfRU5DUllQVDoNCiAvKiBTbyBkcm9wIHRvIE9QRU4g
Ki8NCiAJCQlhcHJpdi0+Y29uZmlnLmF1dGhUeXBlID0gQVVUSF9PUEVOOw0K
QEAgLTQwNDcsMTYgKzQxMDcsMTUgQEANCiAJCQlicmVhazsNCiAJCWRlZmF1
bHQ6ICAvKiBXZSdsbCBlc2NhbGF0ZSB0byBTSEFSRURLRVkgKi8NCiAJCQlh
cHJpdi0+Y29uZmlnLmF1dGhUeXBlID0gQVVUSF9TSEFSRURLRVk7DQotCQl9
DQotCQlhcHJpdi0+bmVlZF9jb21taXQgPSAxOw0KLQkJd3JpdGVDb25maWdS
aWQoYXByaXYsIDApOw0KLQkJZW5hYmxlX01BQyhhcHJpdiwgJnJzcCwgMCk7
DQotCQl1cCgmYXByaXYtPnNlbSk7DQorCX0NCisJYXByaXYtPm5lZWRfY29t
bWl0ID0gMTsNCisJd3JpdGVDb25maWdSaWQoYXByaXYsIDApOw0KKwllbmFi
bGVfTUFDKGFwcml2LCAmcnNwLCAwKTsNCisJdXAoJmFwcml2LT5zZW0pOw0K
IA0KIC8qIFNjaGVkdWxlIGNoZWNrIHRvIHNlZSBpZiB0aGUgY2hhbmdlIHdv
cmtlZCAqLw0KLQkJYXByaXYtPnRpbWVyLmV4cGlyZXMgPSBSVU5fQVQoSFoq
Myk7DQotCQlhZGRfdGltZXIoJmFwcml2LT50aW1lcik7DQotCX0NCisJY2xl
YXJfYml0KEpPQl9BVVRPV0VQLCAmYXByaXYtPmZsYWdzKTsNCisJYXByaXYt
PmV4cGlyZXMgPSBSVU5fQVQoSFoqMyk7DQogfQ0KIA0KIHN0YXRpYyBpbnQg
YWRkX2Fpcm9fZGV2KCBzdHJ1Y3QgbmV0X2RldmljZSAqZGV2ICkgew0KQEAg
LTQwNjQsMTUgKzQxMjMsNiBAQA0KIAlpZiAoICFub2RlICkNCiAJCXJldHVy
biAtRU5PTUVNOw0KIA0KLQlpZiAoIGF1dG9fd2VwICkgew0KLQkJc3RydWN0
IGFpcm9faW5mbyAqYXByaXY9ZGV2LT5wcml2Ow0KLQkJc3RydWN0IHRpbWVy
X2xpc3QgKnRpbWVyID0gJmFwcml2LT50aW1lcjsNCi0NCi0JCXRpbWVyLT5m
dW5jdGlvbiA9IHRpbWVyX2Z1bmM7DQotCQl0aW1lci0+ZGF0YSA9ICh1X2xv
bmcpZGV2Ow0KLQkJaW5pdF90aW1lcih0aW1lcik7DQotCX0NCi0NCiAJbm9k
ZS0+ZGV2ID0gZGV2Ow0KIAlub2RlLT5uZXh0ID0gYWlyb19kZXZpY2VzOw0K
IAlhaXJvX2RldmljZXMgPSBub2RlOw0KQEAgLTQxMDMsNyArNDE1Myw3IEBA
DQogCQlyZXR1cm4gLUVOT0RFVjsNCiANCiAJcGNpX3NldF9kcnZkYXRhKHBk
ZXYsIGRldik7DQotCSgoc3RydWN0IGFpcm9faW5mbyAqKWRldi0+cHJpdikt
PmZsYWdzIHw9IEZMQUdfUENJOw0KKwljbGVhcl9iaXQgKEZMQUdfUENJLCAm
KChzdHJ1Y3QgYWlyb19pbmZvICopZGV2LT5wcml2KS0+ZmxhZ3MpOw0KIAly
ZXR1cm4gMDsNCiB9DQogDQpAQCAtNDE0OSw3ICs0MTk5LDcgQEANCiAJd2hp
bGUoIGFpcm9fZGV2aWNlcyApIHsNCiAJCXByaW50ayggS0VSTl9JTkZPICJh
aXJvOiBVbnJlZ2lzdGVyaW5nICVzXG4iLCBhaXJvX2RldmljZXMtPmRldi0+
bmFtZSApOw0KICNpZmRlZiBDT05GSUdfUENJDQotCQlpZiAoKChzdHJ1Y3Qg
YWlyb19pbmZvICopYWlyb19kZXZpY2VzLT5kZXYtPnByaXYpLT5mbGFncyAm
IEZMQUdfUENJKQ0KKwkJaWYgKHRlc3RfYml0KEZMQUdfUENJLCAmKChzdHJ1
Y3QgYWlyb19pbmZvICopYWlyb19kZXZpY2VzLT5kZXYtPnByaXYpLT5mbGFn
cykpDQogCQkJaXNfcGNpID0gMTsNCiAjZW5kaWYNCiAJCXN0b3BfYWlyb19j
YXJkKCBhaXJvX2RldmljZXMtPmRldiwgMSApOw0KQEAgLTQ2MjMsMjggKzQ2
NzMsMjggQEANCiAJCQlsb2NhbC0+Y29uZmlnLm9wbW9kZSB8PSBNT0RFX1NU
QV9JQlNTOw0KIAkJCWxvY2FsLT5jb25maWcucm1vZGUgJj0gMHhmZTAwOw0K
IAkJCWxvY2FsLT5jb25maWcuc2Nhbk1vZGUgPSBTQ0FOTU9ERV9BQ1RJVkU7
DQotCQkJbG9jYWwtPmZsYWdzICY9IH5GTEFHXzgwMl8xMTsNCisJCQljbGVh
cl9iaXQgKEZMQUdfODAyXzExLCAmbG9jYWwtPmZsYWdzKTsNCiAJCQlicmVh
azsNCiAJCWNhc2UgSVdfTU9ERV9JTkZSQToNCiAJCQlsb2NhbC0+Y29uZmln
Lm9wbW9kZSAmPSAweEZGMDA7DQogCQkJbG9jYWwtPmNvbmZpZy5vcG1vZGUg
fD0gTU9ERV9TVEFfRVNTOw0KIAkJCWxvY2FsLT5jb25maWcucm1vZGUgJj0g
MHhmZTAwOw0KIAkJCWxvY2FsLT5jb25maWcuc2Nhbk1vZGUgPSBTQ0FOTU9E
RV9BQ1RJVkU7DQotCQkJbG9jYWwtPmZsYWdzICY9IH5GTEFHXzgwMl8xMTsN
CisJCQljbGVhcl9iaXQgKEZMQUdfODAyXzExLCAmbG9jYWwtPmZsYWdzKTsN
CiAJCQlicmVhazsNCiAJCWNhc2UgSVdfTU9ERV9NQVNURVI6DQogCQkJbG9j
YWwtPmNvbmZpZy5vcG1vZGUgJj0gMHhGRjAwOw0KIAkJCWxvY2FsLT5jb25m
aWcub3Btb2RlIHw9IE1PREVfQVA7DQogCQkJbG9jYWwtPmNvbmZpZy5ybW9k
ZSAmPSAweGZlMDA7DQogCQkJbG9jYWwtPmNvbmZpZy5zY2FuTW9kZSA9IFND
QU5NT0RFX0FDVElWRTsNCi0JCQlsb2NhbC0+ZmxhZ3MgJj0gfkZMQUdfODAy
XzExOw0KKwkJCWNsZWFyX2JpdCAoRkxBR184MDJfMTEsICZsb2NhbC0+Zmxh
Z3MpOw0KIAkJCWJyZWFrOw0KIAkJY2FzZSBJV19NT0RFX1JFUEVBVDoNCiAJ
CQlsb2NhbC0+Y29uZmlnLm9wbW9kZSAmPSAweEZGMDA7DQogCQkJbG9jYWwt
PmNvbmZpZy5vcG1vZGUgfD0gTU9ERV9BUF9SUFRSOw0KIAkJCWxvY2FsLT5j
b25maWcucm1vZGUgJj0gMHhmZTAwOw0KIAkJCWxvY2FsLT5jb25maWcuc2Nh
bk1vZGUgPSBTQ0FOTU9ERV9BQ1RJVkU7DQotCQkJbG9jYWwtPmZsYWdzICY9
IH5GTEFHXzgwMl8xMTsNCisJCQljbGVhcl9iaXQgKEZMQUdfODAyXzExLCAm
bG9jYWwtPmZsYWdzKTsNCiAJCQlicmVhazsNCiAJCWNhc2UgSVdfTU9ERV9N
T05JVE9SOg0KIAkJCWxvY2FsLT5jb25maWcub3Btb2RlICY9IDB4RkYwMDsN
CkBAIC00NjUyLDcgKzQ3MDIsNyBAQA0KIAkJCWxvY2FsLT5jb25maWcucm1v
ZGUgJj0gMHhmZTAwOw0KIAkJCWxvY2FsLT5jb25maWcucm1vZGUgfD0gUlhN
T0RFX1JGTU9OIHwgUlhNT0RFX0RJU0FCTEVfODAyXzNfSEVBREVSOw0KIAkJ
CWxvY2FsLT5jb25maWcuc2Nhbk1vZGUgPSBTQ0FOTU9ERV9QQVNTSVZFOw0K
LQkJCWxvY2FsLT5mbGFncyB8PSBGTEFHXzgwMl8xMTsNCisJCQlzZXRfYml0
IChGTEFHXzgwMl8xMSwgJmxvY2FsLT5mbGFncyk7DQogCQkJYnJlYWs7DQog
CQlkZWZhdWx0Og0KIAkJCXJldHVybiAtRUlOVkFMOw0KQEAgLTQ4NDEsMTQg
KzQ4OTEsMTQgQEANCiAJcmVhZENhcGFiaWxpdHlSaWQobG9jYWwsICZjYXBf
cmlkKTsNCiANCiAJaWYgKHZ3cnEtPmRpc2FibGVkKSB7DQotCQlsb2NhbC0+
ZmxhZ3MgfD0gRkxBR19SQURJT19PRkY7DQorCQlzZXRfYml0IChGTEFHX1JB
RElPX09GRiwgJmxvY2FsLT5mbGFncyk7DQogCQlsb2NhbC0+bmVlZF9jb21t
aXQgPSAxOw0KIAkJcmV0dXJuIC1FSU5QUk9HUkVTUzsJCS8qIENhbGwgY29t
bWl0IGhhbmRsZXIgKi8NCiAJfQ0KIAlpZiAodndycS0+ZmxhZ3MgIT0gSVdf
VFhQT1dfTVdBVFQpIHsNCiAJCXJldHVybiAtRUlOVkFMOw0KIAl9DQotCWxv
Y2FsLT5mbGFncyAmPSB+RkxBR19SQURJT19PRkY7DQorCWNsZWFyX2JpdCAo
RkxBR19SQURJT19PRkYsICZsb2NhbC0+ZmxhZ3MpOw0KIAlmb3IgKGkgPSAw
OyBjYXBfcmlkLnR4UG93ZXJMZXZlbHNbaV0gJiYgKGkgPCA4KTsgaSsrKQ0K
IAkJaWYgKCh2d3JxLT52YWx1ZT09Y2FwX3JpZC50eFBvd2VyTGV2ZWxzW2ld
KSkgew0KIAkJCWxvY2FsLT5jb25maWcudHhQb3dlciA9IHZ3cnEtPnZhbHVl
Ow0KQEAgLTQ4NzIsNyArNDkyMiw3IEBADQogDQogCXZ3cnEtPnZhbHVlID0g
bG9jYWwtPmNvbmZpZy50eFBvd2VyOw0KIAl2d3JxLT5maXhlZCA9IDE7CS8q
IE5vIHBvd2VyIGNvbnRyb2wgKi8NCi0JdndycS0+ZGlzYWJsZWQgPSAobG9j
YWwtPmZsYWdzICYgRkxBR19SQURJT19PRkYpOw0KKwl2d3JxLT5kaXNhYmxl
ZCA9IHRlc3RfYml0KEZMQUdfUkFESU9fT0ZGLCAmbG9jYWwtPmZsYWdzKTsN
CiAJdndycS0+ZmxhZ3MgPSBJV19UWFBPV19NV0FUVDsNCiANCiAJcmV0dXJu
IDA7DQpAQCAtNTUyMiwxMCArNTU3MiwxNCBAQA0KIAkJd3JpdGVTc2lkUmlk
KGxvY2FsLCAmU1NJRF9yaWQpOw0KIAkJd3JpdGVBUExpc3RSaWQobG9jYWws
ICZBUExpc3RfcmlkKTsNCiAJfQ0KLQl3cml0ZUNvbmZpZ1JpZChsb2NhbCwg
MSk7DQotCWVuYWJsZV9NQUMobG9jYWwsICZyc3AsIDEpOw0KKwlpZiAoZG93
bl9pbnRlcnJ1cHRpYmxlKCZsb2NhbC0+c2VtKSkNCisJCXJldHVybiAtRVJF
U1RBUlRTWVM7DQorCXdyaXRlQ29uZmlnUmlkKGxvY2FsLCAwKTsNCisJZW5h
YmxlX01BQyhsb2NhbCwgJnJzcCwgMCk7DQogCWlmIChsb2NhbC0+bmVlZF9j
b21taXQgPiAxKQ0KIAkJYWlyb19zZXRfcHJvbWlzYyhsb2NhbCk7DQorCWVs
c2UNCisJCXVwKCZsb2NhbC0+c2VtKTsNCiANCiAJcmV0dXJuIDA7DQogfQ0K
QEAgLTYwNjMsNyArNjExNyw3IEBADQogCXVuc2lnbmVkIGNoYXIgKmlvYnVm
Ow0KIAlzdHJ1Y3QgYWlyb19pbmZvICphaSA9IGRldi0+cHJpdjsNCiANCi0J
aWYgKGFpLT5mbGFncyAmIEZMQUdfRkxBU0hJTkcpDQorCWlmICh0ZXN0X2Jp
dChGTEFHX0ZMQVNISU5HLCAmYWktPmZsYWdzKSkNCiAJCXJldHVybiAtRUlP
Ow0KIA0KIAlzd2l0Y2goY29tcC0+Y29tbWFuZCkNCkBAIC02MTMxLDcgKzYx
ODUsNyBAQA0KIAlpZiAoIWNhcGFibGUoQ0FQX05FVF9BRE1JTikpDQogCQly
ZXR1cm4gLUVQRVJNOw0KIA0KLQlpZiAoYWktPmZsYWdzICYgRkxBR19GTEFT
SElORykNCisJaWYgKHRlc3RfYml0KEZMQUdfRkxBU0hJTkcsICZhaS0+Zmxh
Z3MpKQ0KIAkJcmV0dXJuIC1FSU87DQogDQogCXJpZGNvZGUgPSAwOw0KQEAg
LTYyMDUsMTMgKzYyNTksMTMgQEANCiAJaWYgKGNvbXAtPmNvbW1hbmQgPT0g
QUlST1BDRkcpIHsNCiAJCUNvbmZpZ1JpZCAqY2ZnID0gKENvbmZpZ1JpZCAq
KWlvYnVmOw0KIA0KLQkJaWYgKGFpLT5mbGFncyAmIEZMQUdfTUlDX0NBUEFC
TEUpDQorCQlpZiAodGVzdF9iaXQoRkxBR19NSUNfQ0FQQUJMRSwgJmFpLT5m
bGFncykpDQogCQkJY2ZnLT5vcG1vZGUgfD0gTU9ERV9NSUM7DQogDQogCQlp
ZiAoKGNmZy0+b3Btb2RlICYgMHhGRikgPT0gTU9ERV9TVEFfSUJTUykNCi0J
CQlhaS0+ZmxhZ3MgfD0gRkxBR19BREhPQzsNCisJCQlzZXRfYml0IChGTEFH
X0FESE9DLCAmYWktPmZsYWdzKTsNCiAJCWVsc2UNCi0JCQlhaS0+ZmxhZ3Mg
Jj0gfkZMQUdfQURIT0M7DQorCQkJY2xlYXJfYml0IChGTEFHX0FESE9DLCAm
YWktPmZsYWdzKTsNCiAJfQ0KIA0KIAlpZigoKndyaXRlcikoYWksIHJpZGNv
ZGUsIGlvYnVmLGNvbXAtPmxlbiwxKSkgew0KQEAgLTYzMjIsNyArNjM3Niw3
IEBADQogICovDQogDQogaW50IHNldGZsYXNobW9kZSAoc3RydWN0IGFpcm9f
aW5mbyAqYWkpIHsNCi0JYWktPmZsYWdzIHw9IEZMQUdfRkxBU0hJTkc7DQor
CXNldF9iaXQgKEZMQUdfRkxBU0hJTkcsICZhaS0+ZmxhZ3MpOw0KIA0KIAlP
VVQ0NTAwKGFpLCBTV1MwLCBGTEFTSF9DT01NQU5EKTsNCiAJT1VUNDUwMChh
aSwgU1dTMSwgRkxBU0hfQ09NTUFORCk7DQpAQCAtNjMzOCw3ICs2MzkyLDcg
QEANCiAJc2NoZWR1bGVfdGltZW91dCAoSFovMik7IC8qIDUwMG1zIGRlbGF5
ICovDQogDQogCWlmKCF3YWl0YnVzeShhaSkpIHsNCi0JCWFpLT5mbGFncyAm
PSB+RkxBR19GTEFTSElORzsNCisJCWNsZWFyX2JpdCAoRkxBR19GTEFTSElO
RywgJmFpLT5mbGFncyk7DQogCQlwcmludGsoS0VSTl9JTkZPICJXYWl0YnVz
eSBoYW5nIGFmdGVyIHNldGZsYXNoIG1vZGVcbiIpOw0KIAkJcmV0dXJuIC1F
SU87DQogCX0NCkBAIC02NDQ0LDcgKzY0OTgsNyBAQA0KIA0KIAlzZXRfY3Vy
cmVudF9zdGF0ZSAoVEFTS19VTklOVEVSUlVQVElCTEUpOw0KIAlzY2hlZHVs
ZV90aW1lb3V0IChIWik7ICAgICAgICAgIC8qIEFkZGVkIDEyLzcvMDAgKi8N
Ci0JYWktPmZsYWdzICY9IH5GTEFHX0ZMQVNISU5HOw0KKwljbGVhcl9iaXQg
KEZMQUdfRkxBU0hJTkcsICZhaS0+ZmxhZ3MpOw0KIAlzdGF0dXMgPSBzZXR1
cF9jYXJkKGFpLCBkZXYtPmRldl9hZGRyKTsNCiANCiAJZm9yKCBpID0gMDsg
aSA8IE1BWF9GSURTOyBpKysgKSB7DQo=
---559023410-851401618-1060332891=:387--
