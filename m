Return-Path: <linux-kernel-owner+willy=40w.ods.org-S269918AbUIDNYv@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S269918AbUIDNYv (ORCPT <rfc822;willy@w.ods.org>);
	Sat, 4 Sep 2004 09:24:51 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S269943AbUIDNYv
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Sat, 4 Sep 2004 09:24:51 -0400
Received: from postfix4-2.free.fr ([213.228.0.176]:54978 "EHLO
	postfix4-2.free.fr") by vger.kernel.org with ESMTP id S269918AbUIDNWz
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Sat, 4 Sep 2004 09:22:55 -0400
Message-ID: <1094304174.4139c1aeb3e0f@imp4-q.free.fr>
Date: Sat,  4 Sep 2004 15:22:54 +0200
From: castet.matthieu@free.fr
To: linux-kernel@vger.kernel.org
Subject: [RFC/patch] ACPI in linux PnP layer
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="-MOQ10943041741c087f910d7d45234a854f38222fa115"
User-Agent: Internet Messaging Program (IMP) 3.2.5
X-Originating-IP: 213.228.45.27
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

This message is in MIME format.

---MOQ10943041741c087f910d7d45234a854f38222fa115
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit

Hi,

I have started to plug acpi in PnP layer.
A first patch add the function acpi_driver_scan, that allow to call a function
for each acpi device.
I have to do that because acpi is load before PnP, and it can't add my function
in acpi_bus_add (driver/acpi/scan.c).

The second patch is the PnP acpi driver.
It parse possible and activated resources.
It use acpi_register_gsi to activate irq (is that need ???)

Also there are no disable/set acpi resource support, nor ADDRESS resource
support.

But it work well with drivers that work with pnpbios(parport, serial, ...).

What do you think of it ?
Any comment ?

Matthieu

PS : please CC me since I'm not subscribed to lkml.
---MOQ10943041741c087f910d7d45234a854f38222fa115
Content-Type: application/octet-stream; name="acpi.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="acpi.patch"

ZGlmZiAtcnVOIC0tZXhjbHVkZT0nKi5jbWQnIC0tZXhjbHVkZT0nKi5vJyAtLWV4Y2x1ZGU9Jyou
a28nIGxpbnV4Lm9sZC9kcml2ZXJzL2FjcGkvc2Nhbi5jIGxpbnV4LTIuNi45L2RyaXZlcnMvYWNw
aS9zY2FuLmMKLS0tIGxpbnV4Lm9sZC9kcml2ZXJzL2FjcGkvc2Nhbi5jCTIwMDQtMDktMDQgMTQ6
MTY6MzcuMDAwMDAwMDAwICswMjAwCisrKyBsaW51eC0yLjYuOS9kcml2ZXJzL2FjcGkvc2Nhbi5j
CTIwMDQtMDktMDQgMTQ6Mzk6NDcuMDAwMDAwMDAwICswMjAwCkBAIC04LDYgKzgsNyBAQAogI2lu
Y2x1ZGUgPGFjcGkvYWNwaV9kcml2ZXJzLmg+CiAjaW5jbHVkZSA8YWNwaS9hY2ludGVycC5oPgkv
KiBmb3IgYWNwaV9leF9laXNhX2lkX3RvX3N0cmluZygpICovCiAKKyNpbmNsdWRlIDxsaW51eC9t
b2R1bGUuaD4KIAogI2RlZmluZSBfQ09NUE9ORU5UCQlBQ1BJX0JVU19DT01QT05FTlQKIEFDUElf
TU9EVUxFX05BTUUJCSgic2NhbiIpCkBAIC0xMDcwLDQgKzEwNzEsMjIgQEAKIAlyZXR1cm5fVkFM
VUUocmVzdWx0KTsKIH0KIAoraW50IGFjcGlfZHJpdmVyX3NjYW4odm9pZCAoKiBoYW5kbGVyKShz
dHJ1Y3QgYWNwaV9kZXZpY2UgKiBkZXYpKQoreworCXN0cnVjdCBsaXN0X2hlYWQgKiBub2RlLCAq
IG5leHQ7CisJaWYgKCFoYW5kbGVyKQorCQkgcmV0dXJuX1ZBTFVFKC1FSU5WQUwpOworCisJc3Bp
bl9sb2NrKCZhY3BpX2RldmljZV9sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX3NhZmUobm9kZSwgbmV4
dCwgJmFjcGlfZGV2aWNlX2xpc3QpIHsKKwkJc3RydWN0IGFjcGlfZGV2aWNlICogZGV2ID0gY29u
dGFpbmVyX29mKG5vZGUsIHN0cnVjdCBhY3BpX2RldmljZSwgZ19saXN0KTsKKwkJc3Bpbl91bmxv
Y2soJmFjcGlfZGV2aWNlX2xvY2spOworCQloYW5kbGVyKGRldik7CisJCXNwaW5fbG9jaygmYWNw
aV9kZXZpY2VfbG9jayk7CisJfQorCXNwaW5fdW5sb2NrKCZhY3BpX2RldmljZV9sb2NrKTsKKwly
ZXR1cm5fVkFMVUUoMCk7Cit9CisKIHN1YnN5c19pbml0Y2FsbChhY3BpX3NjYW5faW5pdCk7CitF
WFBPUlRfU1lNQk9MKGFjcGlfZHJpdmVyX3NjYW4pOwo=

---MOQ10943041741c087f910d7d45234a854f38222fa115
Content-Type: application/octet-stream; name="pnpacpi.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="pnpacpi.patch"

ZGlmZiAtcnVOIC0tZXhjbHVkZT0nKi5jbWQnIC0tZXhjbHVkZT0nKi5vJyAtLWV4Y2x1ZGU9Jyou
a28nIGxpbnV4Lm9sZC9kcml2ZXJzL3BucC9LY29uZmlnIGxpbnV4LTIuNi45L2RyaXZlcnMvcG5w
L0tjb25maWcKLS0tIGxpbnV4Lm9sZC9kcml2ZXJzL3BucC9LY29uZmlnCTIwMDQtMDYtMTYgMDc6
MTk6MjMuMDAwMDAwMDAwICswMjAwCisrKyBsaW51eC0yLjYuOS9kcml2ZXJzL3BucC9LY29uZmln
CTIwMDQtMDktMDQgMTQ6MDc6NDYuMDAwMDAwMDAwICswMjAwCkBAIC0zNSw1ICszNSw3IEBACiAK
IHNvdXJjZSAiZHJpdmVycy9wbnAvcG5wYmlvcy9LY29uZmlnIgogCitzb3VyY2UgImRyaXZlcnMv
cG5wL3BucGFjcGkvS2NvbmZpZyIKKwogZW5kbWVudQogCmRpZmYgLXJ1TiAtLWV4Y2x1ZGU9Jyou
Y21kJyAtLWV4Y2x1ZGU9JyoubycgLS1leGNsdWRlPScqLmtvJyBsaW51eC5vbGQvZHJpdmVycy9w
bnAvTWFrZWZpbGUgbGludXgtMi42LjkvZHJpdmVycy9wbnAvTWFrZWZpbGUKLS0tIGxpbnV4Lm9s
ZC9kcml2ZXJzL3BucC9NYWtlZmlsZQkyMDA0LTA2LTE2IDA3OjE4OjM4LjAwMDAwMDAwMCArMDIw
MAorKysgbGludXgtMi42LjkvZHJpdmVycy9wbnAvTWFrZWZpbGUJMjAwNC0wOS0wNCAxNDoxMjo1
Ny4wMDAwMDAwMDAgKzAyMDAKQEAgLTYsMyArNiw0IEBACiAKIG9iai0kKENPTkZJR19QTlBCSU9T
KQkJKz0gcG5wYmlvcy8KIG9iai0kKENPTkZJR19JU0FQTlApCQkrPSBpc2FwbnAvCitvYmotJChD
T05GSUdfUE5QQUNQSSkJCSs9IHBucGFjcGkvCmRpZmYgLXJ1TiAtLWV4Y2x1ZGU9JyouY21kJyAt
LWV4Y2x1ZGU9JyoubycgLS1leGNsdWRlPScqLmtvJyBsaW51eC5vbGQvZHJpdmVycy9wbnAvcG5w
YWNwaS9jb3JlLmMgbGludXgtMi42LjkvZHJpdmVycy9wbnAvcG5wYWNwaS9jb3JlLmMKLS0tIGxp
bnV4Lm9sZC9kcml2ZXJzL3BucC9wbnBhY3BpL2NvcmUuYwkxOTcwLTAxLTAxIDAxOjAwOjAwLjAw
MDAwMDAwMCArMDEwMAorKysgbGludXgtMi42LjkvZHJpdmVycy9wbnAvcG5wYWNwaS9jb3JlLmMJ
MjAwNC0wOS0wNCAxNDo1MDozMi4wMDAwMDAwMDAgKzAyMDAKQEAgLTAsMCArMSw2MDggQEAKKy8q
CisgKiBwbnBhY3BpIC0tIFBuUCBBQ1BJIGRyaXZlcgorICoKKyAqIENvcHlyaWdodCAoYykgMjAw
NCBNYXR0aGlldSBDYXN0ZXQgPGNhc3RldC5tYXR0aGlldUBmcmVlLmZyPgorICogCisgKiBUaGlz
IHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29y
IG1vZGlmeSBpdAorICogdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMg
TGljZW5zZSBhcyBwdWJsaXNoZWQgYnkgdGhlCisgKiBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247
IGVpdGhlciB2ZXJzaW9uIDIsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55CisgKiBsYXRlciB2ZXJz
aW9uLgorICoKKyAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0
IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQKKyAqIFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0
IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKKyAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRO
RVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUgR05VCisgKiBHZW5lcmFsIFB1
YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCisgKgorICogWW91IHNob3VsZCBoYXZlIHJl
Y2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKKyAqIGFsb25n
IHdpdGggdGhpcyBwcm9ncmFtOyBpZiBub3QsIHdyaXRlIHRvIHRoZSBGcmVlIFNvZnR3YXJlCisg
KiBGb3VuZGF0aW9uLCBJbmMuLCA1OSBUZW1wbGUgUGxhY2UsIFN1aXRlIDMzMCwgQm9zdG9uLCBN
QSAgMDIxMTEtMTMwNyAgVVNBCisgKi8KKworLyogVE9ETworICogYWRyZXNzIGhhbmRsaW5nCisg
KiBzZXQvZGlzYmxlIGRldmljZQorICogY29kZSBjbGVhbm5pbmcgKyBtZW1sZWFrCisgKiBob3Rw
bHVnIGRldmljZQorICogcmVtb3ZlIGRldmljZQorICovCisgCisjaW5jbHVkZSA8YWNwaS9hY3Bp
X2J1cy5oPgorI2luY2x1ZGUgPGxpbnV4L2FjcGkuaD4KKyNpbmNsdWRlIDxsaW51eC9wbnAuaD4K
KworI2RlZmluZSBNQVhfREVWSUNFIDUwCitzdGF0aWMgc3RydWN0IGFjcGlfZGV2aWNlICogc2Vs
ZiBbTUFYX0RFVklDRV0gPSB7WzAgLi4uIChNQVhfREVWSUNFLTEpXSA9IE5VTEx9OworCit2b2lk
ICpwbnBhY3BpX2ttYWxsb2Moc2l6ZV90IHNpemUsIGludCBmKQoreworCXZvaWQgKnAgPSBrbWFs
bG9jKCBzaXplLCBmICk7CisJaWYgKCBwID09IE5VTEwgKQorCQlwcmludGsoS0VSTl9FUlIgIlBu
UEFDUEk6IGttYWxsb2MoKSBmYWlsZWRcbiIpOworCWVsc2UKKwkJbWVtc2V0KHAsIDAsIHNpemUp
OworCXJldHVybiBwOworfQorLyoKKyAqIENvbXBhdGlibGUgRGV2aWNlIElEcworICovCisKK3Zv
aWQgcG5waWRhY3BpX3RvX3BucGlkKGNoYXIgKmlkLCBjaGFyICpzdHIpCit7CisJc3RyWzBdID0g
aWRbMF07CisJc3RyWzFdID0gaWRbMV07CisJc3RyWzJdID0gaWRbMl07CisJc3RyWzNdID0gdG9s
b3dlcihpZFszXSk7CisJc3RyWzRdID0gdG9sb3dlcihpZFs0XSk7CisJc3RyWzVdID0gdG9sb3dl
cihpZFs1XSk7CisJc3RyWzZdID0gdG9sb3dlcihpZFs2XSk7CisJc3RyWzddID0gJ1wwJzsKKwor
CXJldHVybjsKK30KKworLyoKKyAqIEFsbG9jYXRlZCBSZXNvdXJjZXMKKyAqLworCitzdGF0aWMg
dm9pZAorcG5wYWNwaV9wYXJzZV9hbGxvY2F0ZWRfaXJxcmVzb3VyY2Uoc3RydWN0IHBucF9yZXNv
dXJjZV90YWJsZSAqIHJlcywgaW50IGlycSkKK3sKKwlpbnQgaSA9IDA7CisJd2hpbGUgKCEocmVz
LT5pcnFfcmVzb3VyY2VbaV0uZmxhZ3MgJiBJT1JFU09VUkNFX1VOU0VUKSAmJiBpIDwgUE5QX01B
WF9JUlEpIGkrKzsKKwlpZiAoaSA8IFBOUF9NQVhfSVJRKSB7CisJCXJlcy0+aXJxX3Jlc291cmNl
W2ldLmZsYWdzID0gSU9SRVNPVVJDRV9JUlE7ICAvLyBBbHNvIGNsZWFycyBfVU5TRVQgZmxhZwor
CQlpZiAoaXJxID09IC0xKSB7CisJCQlyZXMtPmlycV9yZXNvdXJjZVtpXS5mbGFncyB8PSBJT1JF
U09VUkNFX0RJU0FCTEVEOworCQkJcmV0dXJuOworCQl9CisJCXJlcy0+aXJxX3Jlc291cmNlW2ld
LnN0YXJ0ID0KKwkJcmVzLT5pcnFfcmVzb3VyY2VbaV0uZW5kID0gKHVuc2lnbmVkIGxvbmcpIGly
cTsKKwl9Cit9CisKK3N0YXRpYyB2b2lkCitwbnBhY3BpX3BhcnNlX2FsbG9jYXRlZF9kbWFyZXNv
dXJjZShzdHJ1Y3QgcG5wX3Jlc291cmNlX3RhYmxlICogcmVzLCBpbnQgZG1hKQoreworCWludCBp
ID0gMDsKKwl3aGlsZSAoIShyZXMtPmRtYV9yZXNvdXJjZVtpXS5mbGFncyAmIElPUkVTT1VSQ0Vf
VU5TRVQpICYmIGkgPCBQTlBfTUFYX0RNQSkgaSsrOworCWlmIChpIDwgUE5QX01BWF9ETUEpIHsK
KwkJcmVzLT5kbWFfcmVzb3VyY2VbaV0uZmxhZ3MgPSBJT1JFU09VUkNFX0RNQTsgIC8vIEFsc28g
Y2xlYXJzIF9VTlNFVCBmbGFnCisJCWlmIChkbWEgPT0gLTEpIHsKKwkJCXJlcy0+ZG1hX3Jlc291
cmNlW2ldLmZsYWdzIHw9IElPUkVTT1VSQ0VfRElTQUJMRUQ7CisJCQlyZXR1cm47CisJCX0KKwkJ
cmVzLT5kbWFfcmVzb3VyY2VbaV0uc3RhcnQgPQorCQlyZXMtPmRtYV9yZXNvdXJjZVtpXS5lbmQg
PSAodW5zaWduZWQgbG9uZykgZG1hOworCX0KK30KKworc3RhdGljIHZvaWQKK3BucGFjcGlfcGFy
c2VfYWxsb2NhdGVkX2lvcmVzb3VyY2Uoc3RydWN0IHBucF9yZXNvdXJjZV90YWJsZSAqIHJlcywg
aW50IGlvLCBpbnQgbGVuKQoreworCWludCBpID0gMDsKKwl3aGlsZSAoIShyZXMtPnBvcnRfcmVz
b3VyY2VbaV0uZmxhZ3MgJiBJT1JFU09VUkNFX1VOU0VUKSAmJiBpIDwgUE5QX01BWF9QT1JUKSBp
Kys7CisJaWYgKGkgPCBQTlBfTUFYX1BPUlQpIHsKKwkJcmVzLT5wb3J0X3Jlc291cmNlW2ldLmZs
YWdzID0gSU9SRVNPVVJDRV9JTzsgIC8vIEFsc28gY2xlYXJzIF9VTlNFVCBmbGFnCisJCWlmIChs
ZW4gPD0gMCB8fCAoaW8gKyBsZW4gLTEpID49IDB4MTAwMDMpIHsKKwkJCXJlcy0+cG9ydF9yZXNv
dXJjZVtpXS5mbGFncyB8PSBJT1JFU09VUkNFX0RJU0FCTEVEOworCQkJcmV0dXJuOworCQl9CisJ
CXJlcy0+cG9ydF9yZXNvdXJjZVtpXS5zdGFydCA9ICh1bnNpZ25lZCBsb25nKSBpbzsKKwkJcmVz
LT5wb3J0X3Jlc291cmNlW2ldLmVuZCA9ICh1bnNpZ25lZCBsb25nKShpbyArIGxlbiAtIDEpOwor
CX0KK30KKworc3RhdGljIHZvaWQKK3BucGFjcGlfcGFyc2VfYWxsb2NhdGVkX21lbXJlc291cmNl
KHN0cnVjdCBwbnBfcmVzb3VyY2VfdGFibGUgKiByZXMsIGludCBtZW0sIGludCBsZW4pCit7CisJ
aW50IGkgPSAwOworCXdoaWxlICghKHJlcy0+bWVtX3Jlc291cmNlW2ldLmZsYWdzICYgSU9SRVNP
VVJDRV9VTlNFVCkgJiYgaSA8IFBOUF9NQVhfTUVNKSBpKys7CisJaWYgKGkgPCBQTlBfTUFYX01F
TSkgeworCQlyZXMtPm1lbV9yZXNvdXJjZVtpXS5mbGFncyA9IElPUkVTT1VSQ0VfTUVNOyAgLy8g
QWxzbyBjbGVhcnMgX1VOU0VUIGZsYWcKKwkJaWYgKGxlbiA8PSAwKSB7CisJCQlyZXMtPm1lbV9y
ZXNvdXJjZVtpXS5mbGFncyB8PSBJT1JFU09VUkNFX0RJU0FCTEVEOworCQkJcmV0dXJuOworCQl9
CisJCXJlcy0+bWVtX3Jlc291cmNlW2ldLnN0YXJ0ID0gKHVuc2lnbmVkIGxvbmcpIG1lbTsKKwkJ
cmVzLT5tZW1fcmVzb3VyY2VbaV0uZW5kID0gKHVuc2lnbmVkIGxvbmcpKG1lbSArIGxlbiAtIDEp
OworCX0KK30KKworCitzdGF0aWMgYWNwaV9zdGF0dXMgYWNwaV9wbnBfYWxsb2NhdGVkX3Jlc291
cmNlKHN0cnVjdCBhY3BpX3Jlc291cmNlICpyZXMsIHZvaWQgKmRhdGEpCit7CisJc3RydWN0IHBu
cF9yZXNvdXJjZV90YWJsZSAqIHJlc190YWJsZSA9IChzdHJ1Y3QgcG5wX3Jlc291cmNlX3RhYmxl
ICopZGF0YTsKKwkvL3ByaW50aygicmVzIGlkICV4XG4iLHJlcy0+aWQpOworCisJc3dpdGNoIChy
ZXMtPmlkKSB7CisJY2FzZSBBQ1BJX1JTVFlQRV9JUlE6CisJCWlmIChyZXMtPmRhdGEuaXJxLm51
bWJlcl9vZl9pbnRlcnJ1cHRzID4gMCkKKwkJCXBucGFjcGlfcGFyc2VfYWxsb2NhdGVkX2lycXJl
c291cmNlKHJlc190YWJsZSwgCisJCQkJLyogaXMgaXQgb2sgPworCQkJCSAqIHByb2R1Y2UgSU9B
UElDWzBdOiBJbnZhbGlkIHJlZmVyZW5jZSB0byBJUlEgMAorCQkJCSAqLworCQkJCWFjcGlfcmVn
aXN0ZXJfZ3NpKHJlcy0+ZGF0YS5pcnEuaW50ZXJydXB0c1swXSwKKwkJCQkJcmVzLT5kYXRhLmly
cS5lZGdlX2xldmVsLAorCQkJCQlyZXMtPmRhdGEuaXJxLmFjdGl2ZV9oaWdoX2xvdykpOworCQli
cmVhazsKKworCWNhc2UgQUNQSV9SU1RZUEVfRVhUX0lSUToKKwkJaWYgKHJlcy0+ZGF0YS5leHRl
bmRlZF9pcnEubnVtYmVyX29mX2ludGVycnVwdHMgPiAwKQorCQkJcG5wYWNwaV9wYXJzZV9hbGxv
Y2F0ZWRfaXJxcmVzb3VyY2UocmVzX3RhYmxlLCAKKwkJCQlhY3BpX3JlZ2lzdGVyX2dzaShyZXMt
PmRhdGEuZXh0ZW5kZWRfaXJxLmludGVycnVwdHNbMF0sCisJCQkJCXJlcy0+ZGF0YS5leHRlbmRl
ZF9pcnEuZWRnZV9sZXZlbCwKKwkJCQkJcmVzLT5kYXRhLmV4dGVuZGVkX2lycS5hY3RpdmVfaGln
aF9sb3cpKTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJX1JTVFlQRV9ETUE6CisJCWlmIChyZXMtPmRh
dGEuZG1hLm51bWJlcl9vZl9jaGFubmVscyA+IDApCisJCQlwbnBhY3BpX3BhcnNlX2FsbG9jYXRl
ZF9kbWFyZXNvdXJjZShyZXNfdGFibGUsIAorCQkJCQlyZXMtPmRhdGEuZG1hLmNoYW5uZWxzWzBd
KTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJX1JTVFlQRV9JTzoKKwkJcG5wYWNwaV9wYXJzZV9hbGxv
Y2F0ZWRfaW9yZXNvdXJjZShyZXNfdGFibGUsIAorCQkJCXJlcy0+ZGF0YS5pby5taW5fYmFzZV9h
ZGRyZXNzLCAKKwkJCQlyZXMtPmRhdGEuaW8ucmFuZ2VfbGVuZ3RoKTsKKwkJYnJlYWs7CisJY2Fz
ZSBBQ1BJX1JTVFlQRV9GSVhFRF9JTzoKKwkJcG5wYWNwaV9wYXJzZV9hbGxvY2F0ZWRfaW9yZXNv
dXJjZShyZXNfdGFibGUsIAorCQkJCXJlcy0+ZGF0YS5maXhlZF9pby5iYXNlX2FkZHJlc3MsIAor
CQkJCXJlcy0+ZGF0YS5maXhlZF9pby5yYW5nZV9sZW5ndGgpOworCQlicmVhazsKKwljYXNlIEFD
UElfUlNUWVBFX01FTTI0OgorCQlwbnBhY3BpX3BhcnNlX2FsbG9jYXRlZF9tZW1yZXNvdXJjZShy
ZXNfdGFibGUsIAorCQkJCXJlcy0+ZGF0YS5tZW1vcnkyNC5taW5fYmFzZV9hZGRyZXNzLCAKKwkJ
CQlyZXMtPmRhdGEubWVtb3J5MjQucmFuZ2VfbGVuZ3RoKTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJ
X1JTVFlQRV9NRU0zMjoKKwkJcG5wYWNwaV9wYXJzZV9hbGxvY2F0ZWRfbWVtcmVzb3VyY2UocmVz
X3RhYmxlLCAKKwkJCQlyZXMtPmRhdGEubWVtb3J5MzIubWluX2Jhc2VfYWRkcmVzcywgCisJCQkJ
cmVzLT5kYXRhLm1lbW9yeTMyLnJhbmdlX2xlbmd0aCk7CisJCWJyZWFrOworCWNhc2UgQUNQSV9S
U1RZUEVfRklYRURfTUVNMzI6CisJCXBucGFjcGlfcGFyc2VfYWxsb2NhdGVkX21lbXJlc291cmNl
KHJlc190YWJsZSwgCisJCQkJcmVzLT5kYXRhLmZpeGVkX21lbW9yeTMyLnJhbmdlX2Jhc2VfYWRk
cmVzcywgCisJCQkJcmVzLT5kYXRhLmZpeGVkX21lbW9yeTMyLnJhbmdlX2xlbmd0aCk7CisJCWJy
ZWFrOworI2lmIDAKKwljYXNlIEFDUElfUlNUWVBFX0FERFJFU1MxNjoKKwkJcG5wYWNwaV9wYXJz
ZV9hbGxvY2F0ZWRfbWVtcmVzb3VyY2UocmVzX3RhYmxlLCAKKwkJCQlyZXMtPmRhdGEuYWRkcmVz
czE2Lm1pbl9hZGRyZXNzX3JhbmdlLCAKKwkJCQlyZXMtPmRhdGEuYWRkcmVzczE2LmFkZHJlc3Nf
bGVuZ3RoKTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJX1JTVFlQRV9BRERSRVNTMzI6CisJCXBucGFj
cGlfcGFyc2VfYWxsb2NhdGVkX21lbXJlc291cmNlKHJlc190YWJsZSwgCisJCQkJcmVzLT5kYXRh
LmFkZHJlc3MzMi5taW5fYWRkcmVzc19yYW5nZSwgCisJCQkJcmVzLT5kYXRhLmFkZHJlc3MzMi5h
ZGRyZXNzX2xlbmd0aCk7CisJCWJyZWFrOworCS8qCisJY2FzZSBBQ1BJX1JTVFlQRV9BRERSRVNT
NjQ6CisJCXBucGFjcGlfcGFyc2VfYWxsb2NhdGVkX21lbXJlc291cmNlKHJlc190YWJsZSwgCisJ
CXJlcy0+ZGF0YS5hZGRyZXNzNjQubWluX2FkZHJlc3NfcmFuZ2UsIAorCQlyZXMtPmRhdGEuYWRk
cmVzczY0LmFkZHJlc3NfbGVuZ3RoKTsKKwkJYnJlYWs7CisJKi8KKyNlbmRpZgorCWRlZmF1bHQ6
CisJCXByaW50ayhLRVJOX1dBUk5JTkcgIlBuUEFDUEk6IEFsbG9jIHR5cGUgOiAlZCBub3QgaGFu
ZGxlXG4iLCAKKwkJCQlyZXMtPmlkKTsKKwl9CisJCQkKKwlyZXR1cm4gQUVfT0s7Cit9CisKK3N0
YXRpYyBhY3BpX3N0YXR1cyBhY3BpX3BucF9wYXJzZV9hbGxvY2F0ZWRfcmVzb3VyY2Uoc3RydWN0
IGFjcGlfZGV2aWNlICpkZXZpY2UsIHN0cnVjdCBwbnBfcmVzb3VyY2VfdGFibGUgKiByZXMpCit7
CisJLyogQmxhbmsgdGhlIHJlc291cmNlIHRhYmxlIHZhbHVlcyAqLworCXBucF9pbml0X3Jlc291
cmNlX3RhYmxlKHJlcyk7CisKKwlyZXR1cm4gYWNwaV93YWxrX3Jlc291cmNlcyhkZXZpY2UtPmhh
bmRsZSwgTUVUSE9EX05BTUVfX0NSUywgYWNwaV9wbnBfYWxsb2NhdGVkX3Jlc291cmNlLCByZXMp
OworfQorCisKK3N0YXRpYyB2b2lkIHBucGFjcGlfcGFyc2VfZG1hX29wdGlvbihzdHJ1Y3QgcG5w
X29wdGlvbiAqb3B0aW9uLCBzdHJ1Y3QgYWNwaV9yZXNvdXJjZV9kbWEgKnApCit7CisJaW50IGk7
CisJc3RydWN0IHBucF9kbWEgKiBkbWE7CisJZG1hID0gcG5wYWNwaV9rbWFsbG9jKHNpemVvZihz
dHJ1Y3QgcG5wX2RtYSksIEdGUF9LRVJORUwpOworCWlmICghZG1hKQorCQlyZXR1cm47CisKKwlm
b3IoaT0wOyBpPHAtPm51bWJlcl9vZl9jaGFubmVsczsgaSsrKQorCQlkbWEtPm1hcCB8PSAxPDxw
LT5jaGFubmVsc1tpXTsKKwlkbWEtPmZsYWdzID0gMDsKKwlpZiAocC0+YnVzX21hc3RlcikKKwkJ
ZG1hLT5mbGFncyB8PSBJT1JFU09VUkNFX0RNQV9NQVNURVI7CisJc3dpdGNoIChwLT50eXBlKSB7
CisJY2FzZSBBQ1BJX0NPTVBBVElCSUxJVFk6CisJCWRtYS0+ZmxhZ3MgfD0gSU9SRVNPVVJDRV9E
TUFfQ09NUEFUSUJMRTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJX1RZUEVfQToKKwkJZG1hLT5mbGFn
cyB8PSBJT1JFU09VUkNFX0RNQV9UWVBFQTsKKwkJYnJlYWs7CisJY2FzZSBBQ1BJX1RZUEVfQjoK
KwkJZG1hLT5mbGFncyB8PSBJT1JFU09VUkNFX0RNQV9UWVBFQjsKKwkJYnJlYWs7CisJY2FzZSBB
Q1BJX1RZUEVfRjoKKwkJZG1hLT5mbGFncyB8PSBJT1JFU09VUkNFX0RNQV9UWVBFRjsKKwkJYnJl
YWs7CisJfQorCXN3aXRjaCAocC0+dHJhbnNmZXIpIHsKKwljYXNlIEFDUElfVFJBTlNGRVJfODoK
KwkJZG1hLT5mbGFncyB8PSBJT1JFU09VUkNFX0RNQV84QklUOworCQlicmVhazsKKwljYXNlIEFD
UElfVFJBTlNGRVJfOF8xNjoKKwkJZG1hLT5mbGFncyB8PSBJT1JFU09VUkNFX0RNQV84QU5EMTZC
SVQ7CisJCWJyZWFrOworCWNhc2UgQUNQSV9UUkFOU0ZFUl8xNjoKKwkJZG1hLT5mbGFncyB8PSBJ
T1JFU09VUkNFX0RNQV8xNkJJVDsKKwkJYnJlYWs7CisJfQorCisKKwlwbnBfcmVnaXN0ZXJfZG1h
X3Jlc291cmNlKG9wdGlvbixkbWEpOworCXJldHVybjsKK30KKworc3RhdGljIGludCBpcnFfZmxh
Z3MoaW50IGVkZ2VfbGV2ZWwsIGludCBhY3RpdmVfaGlnaF9sb3cpCit7CisJaW50IGZsYWc7CisJ
aWYgKGVkZ2VfbGV2ZWwgPT0gQUNQSV9MRVZFTF9TRU5TSVRJVkUpIHsKKwkJaWYoYWN0aXZlX2hp
Z2hfbG93ID09IEFDUElfQUNUSVZFX0xPVykKKwkJCWZsYWcgPSBJT1JFU09VUkNFX0lSUV9MT1dM
RVZFTDsKKwkJZWxzZQorCQkJZmxhZyA9IElPUkVTT1VSQ0VfSVJRX0hJR0hMRVZFTDsKKwl9CisJ
ZWxzZSB7CisJCWlmKGFjdGl2ZV9oaWdoX2xvdyA9PSBBQ1BJX0FDVElWRV9MT1cpCisJCQlmbGFn
ID0gSU9SRVNPVVJDRV9JUlFfTE9XRURHRTsKKwkJZWxzZQorCQkJZmxhZyA9IElPUkVTT1VSQ0Vf
SVJRX0hJR0hFREdFOworCX0KKwlyZXR1cm4gZmxhZzsKK30KKwkKK3N0YXRpYyB2b2lkIHBucGFj
cGlfcGFyc2VfaXJxX29wdGlvbihzdHJ1Y3QgcG5wX29wdGlvbiAqb3B0aW9uLCBzdHJ1Y3QgYWNw
aV9yZXNvdXJjZV9pcnEgKnApCit7CisJaW50IGk7CisJc3RydWN0IHBucF9pcnEgKiBpcnE7CisJ
aXJxID0gcG5wYWNwaV9rbWFsbG9jKHNpemVvZihzdHJ1Y3QgcG5wX2lycSksIEdGUF9LRVJORUwp
OworCWlmICghaXJxKQorCQlyZXR1cm47CisKKwlmb3IoaT0wOyBpPHAtPm51bWJlcl9vZl9pbnRl
cnJ1cHRzOyBpKyspCisJCWlycS0+bWFwIHw9IDE8PHAtPmludGVycnVwdHNbaV07CisJaXJxLT5m
bGFncyA9IGlycV9mbGFncyhwLT5lZGdlX2xldmVsLCBwLT5hY3RpdmVfaGlnaF9sb3cpOworCisJ
cG5wX3JlZ2lzdGVyX2lycV9yZXNvdXJjZShvcHRpb24saXJxKTsKKwlyZXR1cm47Cit9CisKK3N0
YXRpYyB2b2lkIHBucGFjcGlfcGFyc2VfZXh0X2lycV9vcHRpb24oc3RydWN0IHBucF9vcHRpb24g
Km9wdGlvbiwgc3RydWN0IGFjcGlfcmVzb3VyY2VfZXh0X2lycSAqcCkKK3sKKwlpbnQgaTsKKwlz
dHJ1Y3QgcG5wX2lycSAqIGlycTsKKwlpcnEgPSBwbnBhY3BpX2ttYWxsb2Moc2l6ZW9mKHN0cnVj
dCBwbnBfaXJxKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFpcnEpCisJCXJldHVybjsKKworCWZvcihp
PTA7IGk8cC0+bnVtYmVyX29mX2ludGVycnVwdHM7IGkrKykKKwkJaXJxLT5tYXAgfD0gMTw8cC0+
aW50ZXJydXB0c1tpXTsKKwlpcnEtPmZsYWdzID0gaXJxX2ZsYWdzKHAtPmVkZ2VfbGV2ZWwsIHAt
PmFjdGl2ZV9oaWdoX2xvdyk7CisKKwlwbnBfcmVnaXN0ZXJfaXJxX3Jlc291cmNlKG9wdGlvbixp
cnEpOworCXJldHVybjsKK30KKworc3RhdGljIHZvaWQKK3BucGFjcGlfcGFyc2VfcG9ydF9vcHRp
b24oc3RydWN0IHBucF9vcHRpb24gKm9wdGlvbiwgc3RydWN0IGFjcGlfcmVzb3VyY2VfaW8gKmlv
KQoreworCXN0cnVjdCBwbnBfcG9ydCAqIHBvcnQ7CisJcG9ydCA9IHBucGFjcGlfa21hbGxvYyhz
aXplb2Yoc3RydWN0IHBucF9wb3J0KSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFwb3J0KQorCQlyZXR1
cm47CisJcG9ydC0+bWluID0gaW8tPm1pbl9iYXNlX2FkZHJlc3M7CisJcG9ydC0+bWF4ID0gaW8t
Pm1heF9iYXNlX2FkZHJlc3M7CisJcG9ydC0+YWxpZ24gPSBpby0+YWxpZ25tZW50OworCXBvcnQt
PnNpemUgPSBpby0+cmFuZ2VfbGVuZ3RoOworCXBvcnQtPmZsYWdzID0gQUNQSV9ERUNPREVfMTYg
PT0gaW8tPmlvX2RlY29kZSA/IFBOUF9QT1JUX0ZMQUdfMTZCSVRBRERSIDogMDsKKwlwbnBfcmVn
aXN0ZXJfcG9ydF9yZXNvdXJjZShvcHRpb24scG9ydCk7CisJcmV0dXJuOworfQorCitzdGF0aWMg
dm9pZAorcG5wYWNwaV9wYXJzZV9maXhlZF9wb3J0X29wdGlvbihzdHJ1Y3QgcG5wX29wdGlvbiAq
b3B0aW9uLCBzdHJ1Y3QgYWNwaV9yZXNvdXJjZV9maXhlZF9pbyAqaW8pCit7CisJc3RydWN0IHBu
cF9wb3J0ICogcG9ydDsKKwlwb3J0ID0gcG5wYWNwaV9rbWFsbG9jKHNpemVvZihzdHJ1Y3QgcG5w
X3BvcnQpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIXBvcnQpCisJCXJldHVybjsKKwlwb3J0LT5taW4g
PSBwb3J0LT5tYXggPSBpby0+YmFzZV9hZGRyZXNzOworCXBvcnQtPnNpemUgPSBpby0+cmFuZ2Vf
bGVuZ3RoOworCXBvcnQtPmFsaWduID0gMDsKKwlwb3J0LT5mbGFncyA9IFBOUF9QT1JUX0ZMQUdf
RklYRUQ7CisJcG5wX3JlZ2lzdGVyX3BvcnRfcmVzb3VyY2Uob3B0aW9uLHBvcnQpOworCXJldHVy
bjsKK30KKworc3RhdGljIHZvaWQKK3BucGFjcGlfcGFyc2VfbWVtMjRfb3B0aW9uKHN0cnVjdCBw
bnBfb3B0aW9uICpvcHRpb24sIHN0cnVjdCBhY3BpX3Jlc291cmNlX21lbTI0ICpwKQoreworCXN0
cnVjdCBwbnBfbWVtICogbWVtOworCW1lbSA9IHBucGFjcGlfa21hbGxvYyhzaXplb2Yoc3RydWN0
IHBucF9tZW0pLCBHRlBfS0VSTkVMKTsKKwlpZiAoIW1lbSkKKwkJcmV0dXJuOworCW1lbS0+bWlu
ID0gcC0+bWluX2Jhc2VfYWRkcmVzczsKKwltZW0tPm1heCA9IHAtPm1heF9iYXNlX2FkZHJlc3M7
CisJbWVtLT5hbGlnbiA9IHAtPmFsaWdubWVudDsKKwltZW0tPnNpemUgPSBwLT5yYW5nZV9sZW5n
dGg7CisKKwltZW0tPmZsYWdzID0gQUNQSV9SRUFEX1dSSVRFX01FTU9SWSA9PSBwLT5yZWFkX3dy
aXRlX2F0dHJpYnV0ZSA/CisJCQlJT1JFU09VUkNFX01FTV9XUklURUFCTEUgOiAwOworCisJcG5w
X3JlZ2lzdGVyX21lbV9yZXNvdXJjZShvcHRpb24sbWVtKTsKKwlyZXR1cm47Cit9CisKK3N0YXRp
YyB2b2lkCitwbnBhY3BpX3BhcnNlX21lbTMyX29wdGlvbihzdHJ1Y3QgcG5wX29wdGlvbiAqb3B0
aW9uLCBzdHJ1Y3QgYWNwaV9yZXNvdXJjZV9tZW0zMiAqcCkKK3sKKwlzdHJ1Y3QgcG5wX21lbSAq
IG1lbTsKKwltZW0gPSBwbnBhY3BpX2ttYWxsb2Moc2l6ZW9mKHN0cnVjdCBwbnBfbWVtKSwgR0ZQ
X0tFUk5FTCk7CisJaWYgKCFtZW0pCisJCXJldHVybjsKKwltZW0tPm1pbiA9IHAtPm1pbl9iYXNl
X2FkZHJlc3M7CisJbWVtLT5tYXggPSBwLT5tYXhfYmFzZV9hZGRyZXNzOworCW1lbS0+YWxpZ24g
PSBwLT5hbGlnbm1lbnQ7CisJbWVtLT5zaXplID0gcC0+cmFuZ2VfbGVuZ3RoOworCisJbWVtLT5m
bGFncyA9IEFDUElfUkVBRF9XUklURV9NRU1PUlkgPT0gcC0+cmVhZF93cml0ZV9hdHRyaWJ1dGUg
PworCQkJSU9SRVNPVVJDRV9NRU1fV1JJVEVBQkxFIDogMDsKKworCXBucF9yZWdpc3Rlcl9tZW1f
cmVzb3VyY2Uob3B0aW9uLG1lbSk7CisJcmV0dXJuOworfQorCitzdGF0aWMgdm9pZAorcG5wYWNw
aV9wYXJzZV9maXhlZF9tZW0zMl9vcHRpb24oc3RydWN0IHBucF9vcHRpb24gKm9wdGlvbiwgc3Ry
dWN0IGFjcGlfcmVzb3VyY2VfZml4ZWRfbWVtMzIgKnApCit7CisJc3RydWN0IHBucF9tZW0gKiBt
ZW07CisJbWVtID0gcG5wYWNwaV9rbWFsbG9jKHNpemVvZihzdHJ1Y3QgcG5wX21lbSksIEdGUF9L
RVJORUwpOworCWlmICghbWVtKQorCQlyZXR1cm47CisJbWVtLT5taW4gPSBtZW0tPm1heCA9IHAt
PnJhbmdlX2Jhc2VfYWRkcmVzczsKKwltZW0tPnNpemUgPSBwLT5yYW5nZV9sZW5ndGg7CisJbWVt
LT5hbGlnbiA9IDA7CisKKwltZW0tPmZsYWdzID0gQUNQSV9SRUFEX1dSSVRFX01FTU9SWSA9PSBw
LT5yZWFkX3dyaXRlX2F0dHJpYnV0ZSA/CisJCQlJT1JFU09VUkNFX01FTV9XUklURUFCTEUgOiAw
OworCisJcG5wX3JlZ2lzdGVyX21lbV9yZXNvdXJjZShvcHRpb24sbWVtKTsKKwlyZXR1cm47Cit9
CisKKy8vWFhYCitzdGF0aWMgc3RydWN0IHBucF9vcHRpb24gKm9wdGlvbiwgKm9wdGlvbl9pbmRl
cGVuZGVudDsKKworc3RhdGljIGFjcGlfc3RhdHVzIGFjcGlfcG5wX29wdGlvbl9yZXNvdXJjZShz
dHJ1Y3QgYWNwaV9yZXNvdXJjZSAqcmVzLCB2b2lkICpkYXRhKQoreworCWludCBwcmlvcml0eSA9
IDA7CisJc3RydWN0IHBucF9kZXYgKmRldiA9IChzdHJ1Y3QgcG5wX2RldiAqKWRhdGE7CisJLy9w
cmludGsoInBvcyByZXMgaWQgJXhcbiIscmVzLT5pZCk7CisKKwlzd2l0Y2ggKHJlcy0+aWQpIHsK
KwkJY2FzZSBBQ1BJX1JTVFlQRV9JUlE6CisJCQlwbnBhY3BpX3BhcnNlX2lycV9vcHRpb24ob3B0
aW9uLCAmcmVzLT5kYXRhLmlycSk7CisJCWJyZWFrOworCQljYXNlIEFDUElfUlNUWVBFX0VYVF9J
UlE6CisJCQlwbnBhY3BpX3BhcnNlX2V4dF9pcnFfb3B0aW9uKG9wdGlvbiwgJnJlcy0+ZGF0YS5l
eHRlbmRlZF9pcnEpOworCQlicmVhazsKKwkJY2FzZSBBQ1BJX1JTVFlQRV9ETUE6CisJCQlwbnBh
Y3BpX3BhcnNlX2RtYV9vcHRpb24ob3B0aW9uLCAmcmVzLT5kYXRhLmRtYSk7CisJCQkJCQkKKwkJ
YnJlYWs7CisJCWNhc2UgQUNQSV9SU1RZUEVfSU86CisJCQlwbnBhY3BpX3BhcnNlX3BvcnRfb3B0
aW9uKG9wdGlvbiwgJnJlcy0+ZGF0YS5pbyk7CisJCQlicmVhazsKKwkJY2FzZSBBQ1BJX1JTVFlQ
RV9GSVhFRF9JTzoKKwkJCXBucGFjcGlfcGFyc2VfZml4ZWRfcG9ydF9vcHRpb24ob3B0aW9uLCAm
cmVzLT5kYXRhLmZpeGVkX2lvKTsKKwkJCWJyZWFrOworCQljYXNlIEFDUElfUlNUWVBFX01FTTI0
OgorCQkJcG5wYWNwaV9wYXJzZV9tZW0yNF9vcHRpb24ob3B0aW9uLCAmcmVzLT5kYXRhLm1lbW9y
eTI0KTsKKwkJCWJyZWFrOworCQljYXNlIEFDUElfUlNUWVBFX01FTTMyOgorCQkJcG5wYWNwaV9w
YXJzZV9tZW0zMl9vcHRpb24ob3B0aW9uLCAmcmVzLT5kYXRhLm1lbW9yeTMyKTsKKwkJCWJyZWFr
OworCQljYXNlIEFDUElfUlNUWVBFX0ZJWEVEX01FTTMyOgorCQkJcG5wYWNwaV9wYXJzZV9maXhl
ZF9tZW0zMl9vcHRpb24ob3B0aW9uLCAmcmVzLT5kYXRhLmZpeGVkX21lbW9yeTMyKTsKKwkJCWJy
ZWFrOworCQljYXNlIEFDUElfUlNUWVBFX1NUQVJUX0RQRjoKKwkJCXN3aXRjaCAocmVzLT5kYXRh
LnN0YXJ0X2RwZi5jb21wYXRpYmlsaXR5X3ByaW9yaXR5KSB7CisJCQkJY2FzZSBBQ1BJX0dPT0Rf
Q09ORklHVVJBVElPTjoKKwkJCQkJcHJpb3JpdHkgPSBQTlBfUkVTX1BSSU9SSVRZX1BSRUZFUlJF
RDsKKwkJCQkJYnJlYWs7CisJCQkJCQorCQkJCWNhc2UgQUNQSV9BQ0NFUFRBQkxFX0NPTkZJR1VS
QVRJT046CisJCQkJCXByaW9yaXR5ID0gUE5QX1JFU19QUklPUklUWV9BQ0NFUFRBQkxFOworCQkJ
CQlicmVhazsKKworCQkJCWNhc2UgQUNQSV9TVUJfT1BUSU1BTF9DT05GSUdVUkFUSU9OOgorCQkJ
CQlwcmlvcml0eSA9IFBOUF9SRVNfUFJJT1JJVFlfRlVOQ1RJT05BTDsKKwkJCQkJYnJlYWs7CisJ
CQkJZGVmYXVsdDoKKwkJCQkJcHJpb3JpdHkgPSBQTlBfUkVTX1BSSU9SSVRZX0lOVkFMSUQ7CisJ
CQkJCWJyZWFrOworCQkJfQorCQkJb3B0aW9uID0gcG5wX3JlZ2lzdGVyX2RlcGVuZGVudF9vcHRp
b24oZGV2LCBwcmlvcml0eSk7CisJCQlpZiAoIW9wdGlvbikKKwkJCQlyZXR1cm4gLTE7CisJCQli
cmVhazsKKwkJY2FzZSBBQ1BJX1JTVFlQRV9FTkRfRFBGOgorCQkJaWYgKG9wdGlvbl9pbmRlcGVu
ZGVudCA9PSBvcHRpb24pCisJCQkJcHJpbnRrKEtFUk5fV0FSTklORyAiUG5QQUNQSTogTWlzc2lu
ZyBTTUFMTF9UQUdfU1RBUlRERVAgdGFnXG4iKTsKKwkJCW9wdGlvbiA9IG9wdGlvbl9pbmRlcGVu
ZGVudDsKKwkJCWJyZWFrOworCQlkZWZhdWx0OgorCQkJcHJpbnRrKEtFUk5fV0FSTklORyAiUG5Q
QUNQSTogT3B0aW9uIHR5cGUgOiAlZCBub3QgaGFuZGxlXG4iLCByZXMtPmlkKTsKKwl9CisJCQkK
KwlyZXR1cm4gQUVfT0s7Cit9CisKK3N0YXRpYyBpbnQgcG5wYWNwaV9nZXRfcmVzb3VyY2VzKHN0
cnVjdCBwbnBfZGV2ICogZGV2LCBzdHJ1Y3QgcG5wX3Jlc291cmNlX3RhYmxlICogcmVzKQorewor
CisJYWNwaV9zdGF0dXMgc3RhdHVzOworCXN0YXR1cyA9IGFjcGlfcG5wX3BhcnNlX2FsbG9jYXRl
ZF9yZXNvdXJjZShzZWxmW2Rldi0+bnVtYmVyXSwgJmRldi0+cmVzKTsKKwlyZXR1cm4gQUNQSV9G
QUlMVVJFKHN0YXR1cyk/LUVOT0RFVjowOworfQorCitzdGF0aWMgaW50IHBucGFjcGlfc2V0X3Jl
c291cmNlcyhzdHJ1Y3QgcG5wX2RldiAqIGRldiwgc3RydWN0IHBucF9yZXNvdXJjZV90YWJsZSAq
IHJlcykKK3sKKwlwcmludGsoS0VSTl9XQVJOSU5HICJQblBBQ1BJOiBOb3QgaW1wbGVtZW50ZWRc
biIpOworCXJldHVybiAtRU5PREVWOworfQorCitzdGF0aWMgaW50IHBucGFjcGlfZGlzYWJsZV9y
ZXNvdXJjZXMoc3RydWN0IHBucF9kZXYgKmRldikKK3sKKwlwcmludGsoS0VSTl9XQVJOSU5HICJQ
blBBQ1BJOiBOb3QgaW1wbGVtZW50ZWRcbiIpOworCXJldHVybiAtRU5PREVWOworfQorCitzdHJ1
Y3QgcG5wX3Byb3RvY29sIHBucGFjcGlfcHJvdG9jb2wgPSB7CisJLm5hbWUJPSAiUGx1ZyBhbmQg
UGxheSBBQ1BJIiwKKwkuZ2V0CT0gcG5wYWNwaV9nZXRfcmVzb3VyY2VzLAorCS5zZXQJPSBwbnBh
Y3BpX3NldF9yZXNvdXJjZXMsCisJLmRpc2FibGUgPSBwbnBhY3BpX2Rpc2FibGVfcmVzb3VyY2Vz
LAorfTsKKworc3RhdGljIGludCBhY3BpX3BucF9hZGRfZGV2aWNlKHN0cnVjdCBhY3BpX2Rldmlj
ZSAqZGV2aWNlKQoreworCWFjcGlfc3RhdHVzIHN0YXR1czsKKwlzdHJ1Y3QgcG5wX2lkICpkZXZf
aWQ7CisJY2hhciBpZFs4XTsKKwlzdHJ1Y3QgcG5wX2RldiAqZGV2OworCisJc3RhdGljIGludCBu
dW0gPSAwOworCisJaWYobnVtPj1NQVhfREVWSUNFKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWlm
IChzdHJsZW4oYWNwaV9kZXZpY2VfaGlkKGRldmljZSkpICE9IDcpIHsKKwkJLy9wcmludGsoImRl
dmljZSA6IGhpZCAlcyAlZFxuIiwgaWQsIHN0cmxlbihpZCkpOworCQlyZXR1cm4gLTE7CisJfQor
CQorCS8vcHJpbnRrKCJkZXZpY2UgOiBoaWQgJXMgXG4iLCBhY3BpX2RldmljZV9oaWQoZGV2aWNl
KSk7CisJZGV2ID0gIHBucGFjcGlfa21hbGxvYyhzaXplb2Yoc3RydWN0IHBucF9kZXYpLCBHRlBf
S0VSTkVMKTsKKwlpZiAoIWRldikKKwkJcmV0dXJuIC0xOworCisJZGV2LT5udW1iZXIgPSBudW0r
KzsKKwlzZWxmW2Rldi0+bnVtYmVyXSA9IGRldmljZTsKKwlzdHJuY3B5KGRldi0+bmFtZSAsZGV2
aWNlLT5wbnAuYnVzX2lkLCBQTlBfTkFNRV9MRU4pOworCisKKwkvKiBzZXQgdGhlIGluaXRpYWwg
dmFsdWVzIGZvciB0aGUgUG5QIGRldmljZSAqLworCWRldl9pZCA9IHBucGFjcGlfa21hbGxvYyhz
aXplb2Yoc3RydWN0IHBucF9pZCksIEdGUF9LRVJORUwpOworCWlmICghZGV2X2lkKQorCQlnb3Rv
IGVycjsKKwlwbnBpZGFjcGlfdG9fcG5waWQoYWNwaV9kZXZpY2VfaGlkKGRldmljZSksaWQpOwor
CW1lbWNweShkZXZfaWQtPmlkLGlkLDcpOworCisJcG5wX2FkZF9pZChkZXZfaWQsIGRldik7CisJ
Ly9wYXJzZSBhbGxvY2F0ZWQgcmVzb3VyY2UKKwlzdGF0dXMgPSBhY3BpX3BucF9wYXJzZV9hbGxv
Y2F0ZWRfcmVzb3VyY2UoZGV2aWNlLCAmZGV2LT5yZXMpOworCWlmIChBQ1BJX0ZBSUxVUkUoc3Rh
dHVzKSkgeworCQkvL3ByaW50ayhLRVJOX0RFQlVHICJNRVRIT0RfTkFNRV9fQ1JTIGZhaWxsdXJl
XG4iKTsKKwkJZGV2LT5hY3RpdmUgPSAwOworCQkvL3JldHVybiAtRUlPOworCX0KKwllbHNlCisJ
CWRldi0+YWN0aXZlID0gMTsKKworCW9wdGlvbl9pbmRlcGVuZGVudCA9IG9wdGlvbiA9IHBucF9y
ZWdpc3Rlcl9pbmRlcGVuZGVudF9vcHRpb24oZGV2KTsKKwlpZiAoIW9wdGlvbikKKwkJZ290byBl
cnI7CisJc3RhdHVzID0gYWNwaV93YWxrX3Jlc291cmNlcyhkZXZpY2UtPmhhbmRsZSwgTUVUSE9E
X05BTUVfX1BSUywgYWNwaV9wbnBfb3B0aW9uX3Jlc291cmNlLCBkZXYpOworCS8qaWYgKEFDUElf
RkFJTFVSRShzdGF0dXMpKQorCQlwcmludGsoS0VSTl9ERUJVRyAiTUVUSE9EX05BTUVfX1BSUyBm
YWlsbHVyZVxuIik7CisJCS8vcmV0dXJuIC1FSU87CisJKi8KKworCWlmIChkZXZpY2UtPmZsYWdz
LmNvbXBhdGlibGVfaWRzKSB7CisJCXN0cnVjdCBhY3BpX2NvbXBhdGlibGVfaWRfbGlzdCAqY2lk
X2xpc3QgPSBkZXZpY2UtPnBucC5jaWRfbGlzdDsKKwkJaW50IGk7CisKKwkJZm9yIChpID0gMDsg
aSA8IGNpZF9saXN0LT5jb3VudDsgaSsrKSB7CisJCQlkZXZfaWQgPSBwbnBhY3BpX2ttYWxsb2Mo
c2l6ZW9mKHN0cnVjdCBwbnBfaWQpLCBHRlBfS0VSTkVMKTsKKwkJCWlmICghZGV2X2lkKQorCQkJ
CWNvbnRpbnVlOworCisJCQltZW1jcHkoZGV2X2lkLT5pZCxjaWRfbGlzdC0+aWRbaV0udmFsdWUs
Nyk7CisJCQlwbnBfYWRkX2lkKGRldl9pZCwgZGV2KTsKKwkJfQorCX0KKworI2lmIDAKKwlkZXYt
PmZsYWdzID0gbm9kZS0+ZmxhZ3M7CisJaWYgKCEoZGV2LT5mbGFncyAmIFBOUEJJT1NfTk9fQ09O
RklHKSkKKwkJZGV2LT5jYXBhYmlsaXRpZXMgfD0gUE5QX0NPTkZJR1VSQUJMRTsKKwlpZiAoIShk
ZXYtPmZsYWdzICYgUE5QQklPU19OT19ESVNBQkxFKSkKKwkJZGV2LT5jYXBhYmlsaXRpZXMgfD0g
UE5QX0RJU0FCTEU7CisJZGV2LT5jYXBhYmlsaXRpZXMgfD0gUE5QX1JFQUQ7CisJaWYgKHBucGFj
cGlfaXNfZHluYW1pYyhkZXYpKQorCQlkZXYtPmNhcGFiaWxpdGllcyB8PSBQTlBfV1JJVEU7CisJ
aWYgKGRldi0+ZmxhZ3MgJiBQTlBCSU9TX1JFTU9WQUJMRSkKKwkJZGV2LT5jYXBhYmlsaXRpZXMg
fD0gUE5QX1JFTU9WQUJMRTsKKyNlbmRpZgorCisJZGV2LT5wcm90b2NvbCA9ICZwbnBhY3BpX3By
b3RvY29sOworCisJLyogY2xlYXIgb3V0IHRoZSBkYW1hZ2VkIGZsYWdzICovCisJaWYgKCFkZXYt
PmFjdGl2ZSkKKwkJcG5wX2luaXRfcmVzb3VyY2VfdGFibGUoJmRldi0+cmVzKTsKKwlwbnBfYWRk
X2RldmljZShkZXYpOworCXJldHVybiAwOworCitlcnI6CisJa2ZyZWUoZGV2KTsKKwlyZXR1cm4g
LTE7Cit9CisKK3N0YXRpYyB2b2lkIGFjcGlfcG5wX2FkZF9kZXZpY2VfaGFuZGxlcihzdHJ1Y3Qg
YWNwaV9kZXZpY2UgKmRldmljZSkKK3sKKwlhY3BpX3BucF9hZGRfZGV2aWNlKGRldmljZSk7Cit9
CisKKy8vWFhYIHB1dCBpbiBhIGhlYWRlciBmaWxlLi4uCitleHRlcm4gaW50IGFjcGlfZHJpdmVy
X3NjYW4odm9pZCAoKiBoYW5kbGVyKShzdHJ1Y3QgYWNwaV9kZXZpY2UgKiBkZXYpKTsKKworaW50
IF9faW5pdCBwbnBhY3BpX2luaXQodm9pZCkKK3sKKwlwcmludGsoS0VSTl9JTkZPICJQblAgQUNQ
SSBpbml0XG4iKTsKKwlwbnBfcmVnaXN0ZXJfcHJvdG9jb2woJnBucGFjcGlfcHJvdG9jb2wpOwor
CXJldHVybiBhY3BpX2RyaXZlcl9zY2FuKGFjcGlfcG5wX2FkZF9kZXZpY2VfaGFuZGxlcik7Cit9
CitkZXZpY2VfaW5pdGNhbGwocG5wYWNwaV9pbml0KTsKKworRVhQT1JUX1NZTUJPTChwbnBhY3Bp
X3Byb3RvY29sKTsKZGlmZiAtcnVOIC0tZXhjbHVkZT0nKi5jbWQnIC0tZXhjbHVkZT0nKi5vJyAt
LWV4Y2x1ZGU9Jyoua28nIGxpbnV4Lm9sZC9kcml2ZXJzL3BucC9wbnBhY3BpL0tjb25maWcgbGlu
dXgtMi42LjkvZHJpdmVycy9wbnAvcG5wYWNwaS9LY29uZmlnCi0tLSBsaW51eC5vbGQvZHJpdmVy
cy9wbnAvcG5wYWNwaS9LY29uZmlnCTE5NzAtMDEtMDEgMDE6MDA6MDAuMDAwMDAwMDAwICswMTAw
CisrKyBsaW51eC0yLjYuOS9kcml2ZXJzL3BucC9wbnBhY3BpL0tjb25maWcJMjAwNC0wOS0wNCAx
NDoxMTozNi4wMDAwMDAwMDAgKzAyMDAKQEAgLTAsMCArMSwxMCBAQAorIworIyBQbHVnIGFuZCBQ
bGF5IEFDUEkgY29uZmlndXJhdGlvbgorIworY29uZmlnIFBOUEFDUEkKKwlib29sICJQbHVnIGFu
ZCBQbGF5IEFDUEkgc3VwcG9ydCAoRVhQRVJJTUVOVEFMKSIKKwlkZXBlbmRzIG9uIFBOUCAmJiBY
ODYgJiYgQUNQSV9CVVMgJiYgRVhQRVJJTUVOVEFMCisJZGVwZW5kcyBvbiAhUE5QQklPUworCWRl
ZmF1bHQgeQorCS0tLWhlbHAtLS0KKwlUb2RvCmRpZmYgLXJ1TiAtLWV4Y2x1ZGU9JyouY21kJyAt
LWV4Y2x1ZGU9JyoubycgLS1leGNsdWRlPScqLmtvJyBsaW51eC5vbGQvZHJpdmVycy9wbnAvcG5w
YWNwaS9NYWtlZmlsZSBsaW51eC0yLjYuOS9kcml2ZXJzL3BucC9wbnBhY3BpL01ha2VmaWxlCi0t
LSBsaW51eC5vbGQvZHJpdmVycy9wbnAvcG5wYWNwaS9NYWtlZmlsZQkxOTcwLTAxLTAxIDAxOjAw
OjAwLjAwMDAwMDAwMCArMDEwMAorKysgbGludXgtMi42LjkvZHJpdmVycy9wbnAvcG5wYWNwaS9N
YWtlZmlsZQkyMDA0LTA5LTA0IDE0OjM3OjUzLjAwMDAwMDAwMCArMDIwMApAQCAtMCwwICsxLDUg
QEAKKyMKKyMgTWFrZWZpbGUgZm9yIHRoZSBrZXJuZWwgUE5QQUNQSSBkcml2ZXIuCisjCisKK29i
ai15IDo9IGNvcmUubwpkaWZmIC1ydU4gLS1leGNsdWRlPScqLmNtZCcgLS1leGNsdWRlPScqLm8n
IC0tZXhjbHVkZT0nKi5rbycgbGludXgub2xkL2RyaXZlcnMvcG5wL3BucGJpb3MvS2NvbmZpZyBs
aW51eC0yLjYuOS9kcml2ZXJzL3BucC9wbnBiaW9zL0tjb25maWcKLS0tIGxpbnV4Lm9sZC9kcml2
ZXJzL3BucC9wbnBiaW9zL0tjb25maWcJMjAwNC0wNi0xNiAwNzoxOTo0NC4wMDAwMDAwMDAgKzAy
MDAKKysrIGxpbnV4LTIuNi45L2RyaXZlcnMvcG5wL3BucGJpb3MvS2NvbmZpZwkyMDA0LTA5LTA0
IDE0OjExOjMxLjAwMDAwMDAwMCArMDIwMApAQCAtNCw2ICs0LDggQEAKIGNvbmZpZyBQTlBCSU9T
CiAJYm9vbCAiUGx1ZyBhbmQgUGxheSBCSU9TIHN1cHBvcnQgKEVYUEVSSU1FTlRBTCkiCiAJZGVw
ZW5kcyBvbiBQTlAgJiYgWDg2ICYmIEVYUEVSSU1FTlRBTAorCWRlcGVuZHMgb24gIVBOUEFDUEkK
KwlkZWZhdWx0IG4KIAktLS1oZWxwLS0tCiAJICBMaW51eCB1c2VzIHRoZSBQTlBCSU9TIGFzIGRl
ZmluZWQgaW4gIlBsdWcgYW5kIFBsYXkgQklPUwogCSAgU3BlY2lmaWNhdGlvbiBWZXJzaW9uIDEu
MEEgTWF5IDUsIDE5OTQiIHRvIGF1dG9kZXRlY3QgYnVpbHQtaW4K

---MOQ10943041741c087f910d7d45234a854f38222fa115--
