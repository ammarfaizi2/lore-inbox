Return-Path: <linux-kernel-owner+willy=40w.ods.org-S269807AbUHZXsE@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S269807AbUHZXsE (ORCPT <rfc822;willy@w.ods.org>);
	Thu, 26 Aug 2004 19:48:04 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S269663AbUHZXn0
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Thu, 26 Aug 2004 19:43:26 -0400
Received: from 67.107.199.112.ptr.us.xo.net ([67.107.199.112]:19952 "EHLO
	hathawaymix.org") by vger.kernel.org with ESMTP id S269674AbUHZXi3
	(ORCPT <rfc822;linux-kernel@vger.kernel.org>);
	Thu, 26 Aug 2004 19:38:29 -0400
Date: Thu, 26 Aug 2004 17:35:38 -0600 (MDT)
From: shane@hathawaymix.org
X-X-Sender: shane@orangutan.jungle
To: linux-kernel@vger.kernel.org
Subject: [PATCH] e1000 rx buffer allocation
Message-ID: <Pine.LNX.4.60.0408261727170.9545@orangutan.jungle>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-1463811326-1248027210-1093563338=:9545"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

---1463811326-1248027210-1093563338=:9545
Content-Type: TEXT/PLAIN; charset=US-ASCII; format=flowed

I've written a patch to the e1000 driver.  The patch fixes the memory 
allocation problems reported earlier:

http://seclists.org/lists/linux-kernel/2004/Jan/0043.html

Background: my group is scanning microfilms at high resolution.  We're 
trying to receive 50MB/s from a TCP socket and spit it out to a RAID 0 
array.  It works for a few minutes, but then the e1000 driver starts 
failing to allocate new buffers in the ring, we lose packets, and the 
connection breaks down because we can't accept the data quickly enough. 
I don't know whether we're ever actually running out of rx buffers (we're 
using 4096 buffers, the maximum), but the warning from the kernel is scary 
enough that it's worth fixing.

When e1000 is using jumbo frames (mtu=9000), the driver tries to allocate 
just over 16k for each receive buffer.  Allocating so much memory inside 
an interrupt has a good chance of failing.  So my patch changes the driver 
to schedule rx buffer allocation in a sleep-capable context, using 
schedule_work().  Now I see no more problems with the e1000 driver.  The 
box is a dual Xeon with 2 GB of RAM, but the patch also works fine on my 
laptop.

I wouldn't be surprised if someone else has already fixed this problem, 
but if they have, I haven't found the patch.  To achieve reliably high 
transfer rates with jumbo frames, it just doesn't seem to make sense to 
alloc_skb() in interrupt context.

The patch is against 2.6.8.1.  I can move it to 2.6.9-rc1 if it would 
help.  I also added a printk() to the driver that tells you when 10 or 
more rx buffers have been allocated at once.  The message is useful for 
figuring out the right RxDescriptors option value, but we probably need a 
better way to report this information.

Independently of my patch, I'm a little concerned about what will happen 
if the driver runs out of rx buffers.  Ideally, it will just drop packets, 
but I wonder if the code will panic instead.

BTW, this is my first post on this list.  Please CC me on replies.

Shane
---1463811326-1248027210-1093563338=:9545
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="e1000-alloc.patch"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.LNX.4.60.0408261735380.9545@orangutan.jungle>
Content-Description: 
Content-Disposition: attachment; filename="e1000-alloc.patch"

LS0tIGUxMDAwLm9yaWcvZTEwMDBfbWFpbi5jCTIwMDQtMDgtMTQgMDQ6NTU6
MTAuMDAwMDAwMDAwIC0wNjAwDQorKysgZTEwMDAvZTEwMDBfbWFpbi5jCTIw
MDQtMDgtMjYgMTI6Mzg6MzAuNjAyMTkxNjQwIC0wNjAwDQpAQCAtMTQzLDcg
KzE0Myw5IEBADQogI2Vsc2UNCiBzdGF0aWMgYm9vbGVhbl90IGUxMDAwX2Ns
ZWFuX3J4X2lycShzdHJ1Y3QgZTEwMDBfYWRhcHRlciAqYWRhcHRlcik7DQog
I2VuZGlmDQotc3RhdGljIHZvaWQgZTEwMDBfYWxsb2NfcnhfYnVmZmVycyhz
dHJ1Y3QgZTEwMDBfYWRhcHRlciAqYWRhcHRlcik7DQorc3RhdGljIHZvaWQg
ZTEwMDBfYWxsb2NfcnhfYnVmZmVycyhzdHJ1Y3QgZTEwMDBfYWRhcHRlciAq
YWRhcHRlciwNCisJCQkJICAgaW50IGZyb21faXJxKTsNCitzdGF0aWMgdm9p
ZCBlMTAwMF9hbGxvY190YXNrKHN0cnVjdCBlMTAwMF9hZGFwdGVyICphZGFw
dGVyKTsNCiBzdGF0aWMgaW50IGUxMDAwX2lvY3RsKHN0cnVjdCBuZXRfZGV2
aWNlICpuZXRkZXYsIHN0cnVjdCBpZnJlcSAqaWZyLCBpbnQgY21kKTsNCiBz
dGF0aWMgaW50IGUxMDAwX21paV9pb2N0bChzdHJ1Y3QgbmV0X2RldmljZSAq
bmV0ZGV2LCBzdHJ1Y3QgaWZyZXEgKmlmciwNCiAJCQkgICBpbnQgY21kKTsN
CkBAIC0yNjMsNyArMjY1LDcgQEANCiAJZTEwMDBfY29uZmlndXJlX3R4KGFk
YXB0ZXIpOw0KIAllMTAwMF9zZXR1cF9yY3RsKGFkYXB0ZXIpOw0KIAllMTAw
MF9jb25maWd1cmVfcngoYWRhcHRlcik7DQotCWUxMDAwX2FsbG9jX3J4X2J1
ZmZlcnMoYWRhcHRlcik7DQorCWUxMDAwX2FsbG9jX3J4X2J1ZmZlcnMoYWRh
cHRlciwgMCk7DQogDQogCWlmKChlcnIgPSByZXF1ZXN0X2lycShhZGFwdGVy
LT5wZGV2LT5pcnEsICZlMTAwMF9pbnRyLA0KIAkJICAgICAgICAgICAgICBT
QV9TSElSUSB8IFNBX1NBTVBMRV9SQU5ET00sDQpAQCAtMjg2LDYgKzI4OCwx
MCBAQA0KIAlkZWxfdGltZXJfc3luYygmYWRhcHRlci0+dHhfZmlmb19zdGFs
bF90aW1lcik7DQogCWRlbF90aW1lcl9zeW5jKCZhZGFwdGVyLT53YXRjaGRv
Z190aW1lcik7DQogCWRlbF90aW1lcl9zeW5jKCZhZGFwdGVyLT5waHlfaW5m
b190aW1lcik7DQorCXdoaWxlIChhZGFwdGVyLT5hbGxvY19zY2hlZHVsZWQp
IHsNCisJCXByaW50aygid2FpdGluZyBmb3IgZTEwMDBfYWxsb2NfdGFzay4u
LlxuIik7DQorCQltZGVsYXkoNSk7DQorCX0NCiAJYWRhcHRlci0+bGlua19z
cGVlZCA9IDA7DQogCWFkYXB0ZXItPmxpbmtfZHVwbGV4ID0gMDsNCiAJbmV0
aWZfY2Fycmllcl9vZmYobmV0ZGV2KTsNCkBAIC01MzAsNiArNTM2LDkgQEAN
CiAJYWRhcHRlci0+cGh5X2luZm9fdGltZXIuZnVuY3Rpb24gPSAmZTEwMDBf
dXBkYXRlX3BoeV9pbmZvOw0KIAlhZGFwdGVyLT5waHlfaW5mb190aW1lci5k
YXRhID0gKHVuc2lnbmVkIGxvbmcpIGFkYXB0ZXI7DQogDQorCUlOSVRfV09S
SygmYWRhcHRlci0+YWxsb2NfdGFzaywNCisJCSAgKHZvaWQgKCopKHZvaWQg
KikpZTEwMDBfYWxsb2NfdGFzaywgYWRhcHRlcik7DQorDQogCUlOSVRfV09S
SygmYWRhcHRlci0+dHhfdGltZW91dF90YXNrLA0KIAkJKHZvaWQgKCopKHZv
aWQgKikpZTEwMDBfdHhfdGltZW91dF90YXNrLCBuZXRkZXYpOw0KIA0KQEAg
LTEyMDMsNyArMTIxMiw3IEBADQogDQogCWlmKG5ldGlmX3J1bm5pbmcobmV0
ZGV2KSkgew0KIAkJZTEwMDBfY29uZmlndXJlX3J4KGFkYXB0ZXIpOw0KLQkJ
ZTEwMDBfYWxsb2NfcnhfYnVmZmVycyhhZGFwdGVyKTsNCisJCWUxMDAwX2Fs
bG9jX3J4X2J1ZmZlcnMoYWRhcHRlciwgMCk7DQogCX0NCiB9DQogDQpAQCAt
MjM1Niw3ICsyMzY1LDcgQEANCiANCiAJcnhfcmluZy0+bmV4dF90b19jbGVh
biA9IGk7DQogDQotCWUxMDAwX2FsbG9jX3J4X2J1ZmZlcnMoYWRhcHRlcik7
DQorCWUxMDAwX2FsbG9jX3J4X2J1ZmZlcnMoYWRhcHRlciwgMSk7DQogDQog
CXJldHVybiBjbGVhbmVkOw0KIH0NCkBAIC0yMzY0LDEwICsyMzczLDExIEBA
DQogLyoqDQogICogZTEwMDBfYWxsb2NfcnhfYnVmZmVycyAtIFJlcGxhY2Ug
dXNlZCByZWNlaXZlIGJ1ZmZlcnMNCiAgKiBAYWRhcHRlcjogYWRkcmVzcyBv
ZiBib2FyZCBwcml2YXRlIHN0cnVjdHVyZQ0KKyAqIEBmcm9tX2lycTogMSBp
ZiBjYWxsZWQgZnJvbSBhbiBpbnRlcnJ1cHQsIDAgaWYgbm90DQogICoqLw0K
IA0KIHN0YXRpYyB2b2lkDQotZTEwMDBfYWxsb2NfcnhfYnVmZmVycyhzdHJ1
Y3QgZTEwMDBfYWRhcHRlciAqYWRhcHRlcikNCitlMTAwMF9hbGxvY19yeF9i
dWZmZXJzKHN0cnVjdCBlMTAwMF9hZGFwdGVyICphZGFwdGVyLCBpbnQgZnJv
bV9pcnEpDQogew0KIAlzdHJ1Y3QgZTEwMDBfZGVzY19yaW5nICpyeF9yaW5n
ID0gJmFkYXB0ZXItPnJ4X3Jpbmc7DQogCXN0cnVjdCBuZXRfZGV2aWNlICpu
ZXRkZXYgPSBhZGFwdGVyLT5uZXRkZXY7DQpAQCAtMjM3NiwxNyArMjM4Niwy
MSBAQA0KIAlzdHJ1Y3QgZTEwMDBfYnVmZmVyICpidWZmZXJfaW5mbzsNCiAJ
c3RydWN0IHNrX2J1ZmYgKnNrYjsNCiAJdW5zaWduZWQgaW50IGk7DQorCWlu
dCBuZWVkX2FsbG9jID0gMDsNCiANCiAJaSA9IHJ4X3JpbmctPm5leHRfdG9f
dXNlOw0KIAlidWZmZXJfaW5mbyA9ICZyeF9yaW5nLT5idWZmZXJfaW5mb1tp
XTsNCiANCiAJd2hpbGUoIWJ1ZmZlcl9pbmZvLT5za2IpIHsNCiAJCXJ4X2Rl
c2MgPSBFMTAwMF9SWF9ERVNDKCpyeF9yaW5nLCBpKTsNCi0NCi0JCXNrYiA9
IGRldl9hbGxvY19za2IoYWRhcHRlci0+cnhfYnVmZmVyX2xlbiArIE5FVF9J
UF9BTElHTik7DQotDQorCQlza2IgPSBidWZmZXJfaW5mby0+ZnV0dXJlX3Nr
YjsNCisJCWlmKCFza2IgJiYgIWZyb21faXJxKSB7DQorCQkJc2tiID0gYWxs
b2Nfc2tiKGFkYXB0ZXItPnJ4X2J1ZmZlcl9sZW4gKyBORVRfSVBfQUxJR04s
DQorCQkJCQlHRlBfS0VSTkVMKTsNCisJCX0NCiAJCWlmKCFza2IpIHsNCi0J
CQkvKiBCZXR0ZXIgbHVjayBuZXh0IHJvdW5kICovDQorCQkJLyogV2FpdCBm
b3IgdGhlIHRpbWVyICovDQorCQkJbmVlZF9hbGxvYyA9IDE7DQogCQkJYnJl
YWs7DQogCQl9DQogDQpAQCAtMjM5OSw2ICsyNDEzLDcgQEANCiAJCXNrYi0+
ZGV2ID0gbmV0ZGV2Ow0KIA0KIAkJYnVmZmVyX2luZm8tPnNrYiA9IHNrYjsN
CisJCWJ1ZmZlcl9pbmZvLT5mdXR1cmVfc2tiID0gTlVMTDsNCiAJCWJ1ZmZl
cl9pbmZvLT5sZW5ndGggPSBhZGFwdGVyLT5yeF9idWZmZXJfbGVuOw0KIAkJ
YnVmZmVyX2luZm8tPmRtYSA9DQogCQkJcGNpX21hcF9zaW5nbGUocGRldiwN
CkBAIC0yNDIzLDkgKzI0MzgsNDcgQEANCiAJfQ0KIA0KIAlyeF9yaW5nLT5u
ZXh0X3RvX3VzZSA9IGk7DQorCWlmIChuZWVkX2FsbG9jICYmICFhZGFwdGVy
LT5hbGxvY19zY2hlZHVsZWQpIHsNCisJICAgCWFkYXB0ZXItPmFsbG9jX3Nj
aGVkdWxlZCA9IDE7DQorCQlzY2hlZHVsZV93b3JrKCZhZGFwdGVyLT5hbGxv
Y190YXNrKTsNCisJfQ0KIH0NCiANCiAvKioNCisgKiBlMTAwMF9hbGxvY190
YXNrIC0gQWxsb2NhdGUgc2ticyB0byBiZSBjb25zdW1lZCBieSBlMTAwMF9h
bGxvY19yeF9idWZmZXJzDQorICogQGFkYXB0ZXI6IGFkZHJlc3Mgb2YgYm9h
cmQgcHJpdmF0ZSBzdHJ1Y3R1cmUNCisgKiovDQorDQorc3RhdGljIHZvaWQg
ZTEwMDBfYWxsb2NfdGFzayhzdHJ1Y3QgZTEwMDBfYWRhcHRlciAqYWRhcHRl
cikgew0KKwlzdHJ1Y3QgZTEwMDBfZGVzY19yaW5nICpyeF9yaW5nID0gJmFk
YXB0ZXItPnJ4X3Jpbmc7DQorCXN0cnVjdCBlMTAwMF9idWZmZXIgKmJ1ZmZl
cl9pbmZvOw0KKwlzdHJ1Y3Qgc2tfYnVmZiAqc2tiOw0KKwl1bnNpZ25lZCBp
bnQgaTsNCisJaW50IGNvdW50ID0gMDsNCisJDQorCWkgPSByeF9yaW5nLT5u
ZXh0X3RvX3VzZTsNCisJYnVmZmVyX2luZm8gPSAmcnhfcmluZy0+YnVmZmVy
X2luZm9baV07DQorDQorCXdoaWxlKCFidWZmZXJfaW5mby0+c2tiICYmICFi
dWZmZXJfaW5mby0+ZnV0dXJlX3NrYikgew0KKwkJc2tiID0gYWxsb2Nfc2ti
KGFkYXB0ZXItPnJ4X2J1ZmZlcl9sZW4gKyBORVRfSVBfQUxJR04sDQorCQkJ
CUdGUF9LRVJORUwpOw0KKwkJaWYoIXNrYikgew0KKwkJICAvKiBCZXR0ZXIg
bHVjayBuZXh0IHJvdW5kICovDQorCQkgIGJyZWFrOw0KKwkJfQ0KKwkJY291
bnQrKzsNCisJCWJ1ZmZlcl9pbmZvLT5mdXR1cmVfc2tiID0gc2tiOw0KKwkJ
aWYoKytpID09IHJ4X3JpbmctPmNvdW50KSBpID0gMDsNCisJCWJ1ZmZlcl9p
bmZvID0gJnJ4X3JpbmctPmJ1ZmZlcl9pbmZvW2ldOw0KKwl9DQorCWlmKGNv
dW50ID49IDEwKQ0KKwkgIHByaW50aygiZTEwMDA6IGFsbG9jYXRlZCAlZCBi
dWZmZXJzXG4iLCBjb3VudCk7DQorCWFkYXB0ZXItPmFsbG9jX3NjaGVkdWxl
ZCA9IDA7DQorfQ0KKw0KKw0KKw0KKy8qKg0KICAqIGUxMDAwX3NtYXJ0c3Bl
ZWQgLSBXb3JrYXJvdW5kIGZvciBTbWFydFNwZWVkIG9uIDgyNTQxIGFuZCA4
MjU0NyBjb250cm9sbGVycy4NCiAgKiBAYWRhcHRlcjoNCiAgKiovDQotLS0g
ZTEwMDAub3JpZy9lMTAwMC5oCTIwMDQtMDgtMTQgMDQ6NTQ6NDcuMDAwMDAw
MDAwIC0wNjAwDQorKysgZTEwMDAvZTEwMDAuaAkyMDA0LTA4LTI2IDEyOjI1
OjA0LjAwMDAwMDAwMCAtMDYwMA0KQEAgLTE1MSw3ICsxNTEsNyBAQA0KIC8q
IHdyYXBwZXIgYXJvdW5kIGEgcG9pbnRlciB0byBhIHNvY2tldCBidWZmZXIs
DQogICogc28gYSBETUEgaGFuZGxlIGNhbiBiZSBzdG9yZWQgYWxvbmcgd2l0
aCB0aGUgYnVmZmVyICovDQogc3RydWN0IGUxMDAwX2J1ZmZlciB7DQotCXN0
cnVjdCBza19idWZmICpza2I7DQorCXN0cnVjdCBza19idWZmICpza2IsICpm
dXR1cmVfc2tiOw0KIAl1aW50NjRfdCBkbWE7DQogCXVuc2lnbmVkIGxvbmcg
bGVuZ3RoOw0KIAl1bnNpZ25lZCBsb25nIHRpbWVfc3RhbXA7DQpAQCAtMjAy
LDYgKzIwMiw4IEBADQogCXNwaW5sb2NrX3Qgc3RhdHNfbG9jazsNCiAJYXRv
bWljX3QgaXJxX3NlbTsNCiAJc3RydWN0IHdvcmtfc3RydWN0IHR4X3RpbWVv
dXRfdGFzazsNCisJc3RydWN0IHdvcmtfc3RydWN0IGFsbG9jX3Rhc2s7DQor
CWludCBhbGxvY19zY2hlZHVsZWQ7DQogICAgIAl1aW50OF90IGZjX2F1dG9u
ZWc7DQogDQogCXN0cnVjdCB0aW1lcl9saXN0IGJsaW5rX3RpbWVyOw0K

---1463811326-1248027210-1093563338=:9545--
