Return-Path: <linux-kernel-owner+willy=40w.ods.org-S262356AbVAUMwE@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S262356AbVAUMwE (ORCPT <rfc822;willy@w.ods.org>);
	Fri, 21 Jan 2005 07:52:04 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S262357AbVAUMwD
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Fri, 21 Jan 2005 07:52:03 -0500
Received: from mx1.slu.se ([130.238.96.70]:54211 "EHLO mx1.slu.se")
	by vger.kernel.org with ESMTP id S262356AbVAUMuJ (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Fri, 21 Jan 2005 07:50:09 -0500
From: Robert Olsson <Robert.Olsson@data.slu.se>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-ID: <16880.62473.933703.827967@robur.slu.se>
Date: Fri, 21 Jan 2005 13:22:33 +0100
To: Junfeng Yang <yjf@stanford.edu>
Cc: Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
Subject: [BUG] 2.6.* pktgen doesn't set ethnet header properly
In-Reply-To: <Pine.GSO.4.44.0501191800030.17705-100000@epic8.Stanford.EDU>
References: <Pine.GSO.4.44.0501191800030.17705-100000@epic8.Stanford.EDU>
X-Mailer: VM 7.18 under Emacs 21.3.1
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org


Hello!

Look at

pginfos[i].hh[12] = 0x08; /* fill in protocol.  Rest is filled in later. */
pginfos[i].hh[13] = 0x00;

						--ro


Junfeng Yang writes:
 > Hi,
 > 
 > I tried to use pktgen module from 2.6.* kernels and found out that I
 > couldn't receive any packets generated by pktgen.  I did not even see a
 > "packet dropped by kernel" message.  It turned out that function
 > setup_inject in net/core/pktgen.c doesn't setup the ethernet header field
 > correctly.  Below is a patch that fixes the problem.
 > 
 > --- kernel-source-2.6.8-orig/net/core/pktgen.c	2004-08-13 22:37:26.000000000 -0700
 > +++ kernel-source-2.6.8/net/core/pktgen.c	2005-01-19 17:54:46.000000000 -0800
 > @@ -259,6 +259,9 @@
 > 
 >  	/* Set up Dest MAC */
 >  	memcpy(&(info->hh[0]), info->dst_mac, 6);
 > +
 > +	/* Set up protocol */
 > +	((struct ethhdr *)(info->hh))->h_proto = htons(ETH_P_IP);
 > 
 >  	info->saddr_min = 0;
 >  	info->saddr_max = 0;
 > 
 > -Junfeng
 > 
 > -
 > To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
 > the body of a message to majordomo@vger.kernel.org
 > More majordomo info at  http://vger.kernel.org/majordomo-info.html
 > Please read the FAQ at  http://www.tux.org/lkml/
