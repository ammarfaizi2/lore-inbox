Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id <S261731AbSJQRRV>; Thu, 17 Oct 2002 13:17:21 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org
	id <S261700AbSJQRQS>; Thu, 17 Oct 2002 13:16:18 -0400
Received: from ylug.mozilla.gr.jp ([203.141.142.92]:27142 "HELO
	maison.kyo-ko.org") by vger.kernel.org with SMTP id <S261588AbSJQRQB>;
	Thu, 17 Oct 2002 13:16:01 -0400
X-Mailer: cmail 2.61.1+20011011 on GNU Emacs 20.7.2 / Mule 4.1
 =?ISO-2022-JP?B?KBskQjAqGyhCKQ==?=
From: Hiroshi Miura <miura@da-cha.org>
To: sfr@canb.auug.org.au
Cc: linux-kernel@vger.kernel.org
Subject: APM work around for bad bios.
X-Face: "7/]{D;9O-#dR'kB\tvpz_:#o|*UdC.KK/_"IN*i5VTU&EBhS6w68xQDPh]i4N%1byZ~v~X
 k$vdp(%V@gY!_|7x7Ht)^ih5\%\l'hcl$`sqp;%`boxPHDJB<~Sr8(e:zPKmeZ)ZPml[0v\|[V00Jm
 G,%5V5X9Mw7j}(8+!o>&&wmQ]Xh=j
User-Agent: SEMI/1.14.3 (=?ISO-2022-JP?B?GyRCNW0lTkMrGyhC?=) FLIM/1.14.3
 (=?ISO-2022-JP?B?GyRCQCZLNThmTk1BMBsoQg==?=) APEL/10.3 Emacs/20.7
 (i386-debian-linux-gnu) MULE/4.1 (=?ISO-2022-JP?B?GyRCMCobKEI=?=)
MIME-Version: 1.0 (generated by SEMI 1.14.3 - =?ISO-2022-JP?B?IhskQjVtGyhC?=
 =?ISO-2022-JP?B?GyRCJU5DKxsoQiI=?=)
Content-Type: text/plain; charset=US-ASCII
Message-Id: <20021017172155.BCA3F11782A@triton2>
Date: Fri, 18 Oct 2002 02:21:55 +0900 (JST)
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

Hello,

I use CASIO CASSIOPEIA FIVA 101 and 103. (http://www.da-cha.org/fiva/fiva.html)
this use Cyrix MediaGX and Award BIOS.
This APM BIOS report broken value for dseg_len.
it asumes granularity is 1.

I made a work around for this situation.

  *  if (cseg_len < bios.offset) BIOS report BAD len value.
     -- segment length must be always larger than code offset

  *  if (dseg_len <= 0x40 ) BIOS asumes granularity =1.
     -- 0x40 * 4kB = 64kB, my pc reports 0x40.


diff -urB -x .config -x '*.[oasS]' -x '*.in' -x '*.rej' -x '*.orig' linux-2.5.43-orig/arch/i386/kernel/apm.c linux-2.5.43/arch/i386/kernel/apm.c
--- linux-2.5.43-orig/arch/i386/kernel/apm.c	2002-10-12 13:21:05.000000000 +0900
+++ linux-2.5.43/arch/i386/kernel/apm.c	2002-10-14 21:36:14.000000000 +0900
@@ -1980,6 +2141,14 @@
 				(apm_info.bios.cseg_16_len - 1) & 0xffff);
 			_set_limit((char *)&cpu_gdt_table[i][APM_DS >> 3],
 				(apm_info.bios.dseg_len - 1) & 0xffff);
+		      /* workaround for broken BIOSes */
+	                if (apm_info.bios.cseg_len <= apm_info.bios.offset)
+        	                _set_limit((char *)&cpu_gdt_table[i][APM_CS >> 3], 64 * 1024 -1);
+                       if (apm_info.bios.dseg_len <= 0x40) { /* 0x40 * 4kB == 64kB */
+                        	/* for the BIOS that assumes granularity = 1 */
+                        	cpu_gdt_table[i][APM_DS >> 3].b |= 0x800000;
+                        	printk(KERN_NOTICE "apm: we set the granularity of dseg.\n");
+        	        }
 		}
 #endif
 	}


-- 
Hiroshi Miura  --- http://www.da-cha.org/ 
NTTDATA Corp. Marketing & Business Strategy Planning Dept. --- miurahr@nttdata.co.jp 
Key fingerprint = 9117 9407 5684 FBF1 4063  15B4 401D D077 04AB 8617
-- My hacking life is happy as the day is long

