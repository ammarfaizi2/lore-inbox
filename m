Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id <S261590AbTCOVwU>; Sat, 15 Mar 2003 16:52:20 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org
	id <S261587AbTCOVwU>; Sat, 15 Mar 2003 16:52:20 -0500
Received: from holomorphy.com ([66.224.33.161]:29651 "EHLO holomorphy")
	by vger.kernel.org with ESMTP id <S261609AbTCOVwL>;
	Sat, 15 Mar 2003 16:52:11 -0500
Date: Sat, 15 Mar 2003 14:02:41 -0800
From: William Lee Irwin III <wli@holomorphy.com>
To: Alex Tomas <bzzz@tmi.comex.ru>
Cc: linux-kernel <linux-kernel@vger.kernel.org>,
       ext2-devel@lists.sourceforge.net, Andrew Morton <akpm@digeo.com>
Subject: Re: [PATCH] concurrent inode allocation for ext2 against 2.5.64
Message-ID: <20030315220241.GX20188@holomorphy.com>
Mail-Followup-To: William Lee Irwin III <wli@holomorphy.com>,
	Alex Tomas <bzzz@tmi.comex.ru>,
	linux-kernel <linux-kernel@vger.kernel.org>,
	ext2-devel@lists.sourceforge.net, Andrew Morton <akpm@digeo.com>
References: <m365qk1gzx.fsf@lexa.home.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <m365qk1gzx.fsf@lexa.home.net>
User-Agent: Mutt/1.3.28i
Organization: The Domain of Holomorphy
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, Mar 16, 2003 at 12:01:38AM +0300, Alex Tomas wrote:
> here is the patch for ext2 concurrent inode allocation. should be applied
> on top of previous concurrent-balloc patch. tested on dual p3 for several
> hours of stress-test + fsck. hope someone test it on big iron ;)

32x/48GB NUMA-Q

Throughput 257.986 MB/sec 128 procs
dbench 128  95.36s user 4833.06s system 2832% cpu 2:53.97 total

vma      samples  %-age       symbol name
c01dc9ac 4532033  21.4566     .text.lock.dec_and_lock
c0169c0b 3835802  18.1603     .text.lock.dcache
c0106ff4 1741849  8.24666     default_idle
c0264fe0 1506547  7.13264     sync_buffer
c01dc920 1344198  6.36401     atomic_dec_and_lock
c01dc7c0 1059649  5.01683     __copy_to_user_ll
c015142c 468551   2.21832     vfs_read
c01dc828 405337   1.91904     __copy_from_user_ll
c02651b0 305363   1.44572     add_event_entry
c01688dc 305154   1.44473     d_instantiate
c015272a 241552   1.14361     .text.lock.file_table
c0168d3c 231119   1.09422     d_lookup
c0119ddc 219611   1.03973     scheduler_tick
c01686a0 213012   1.00849     d_alloc
c015f66c 199435   0.94421     path_lookup
c0152530 185470   0.878094    file_move
c0152334 184847   0.875145    __fput
c015162c 180988   0.856874    vfs_write
c011fb0c 177776   0.841668    profile_hook
c0167e78 165423   0.783183    prune_dcache
c0264ef8 154338   0.730702    add_sample
c01677b8 151599   0.717734    dput
c0169234 149571   0.708133    d_rehash
c0122960 134989   0.639096    current_kernel_time
c0119890 134442   0.636506    load_balance


procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
 1  0      0 49095776   4928  27296    0    0     2     0   33     2  0  0 100  0
 0  0      0 49092768   4960  27552    0    0    80     0 1028    50  0  0 100  0
 7  0      0 49059424   4960  27616    0    0    16     0 1029   221  0  1 99  0
 1  0      0 49055008   4960  27616    0    0     0     0 1026    39  0  0 100  0
133 17      0 48628832  24672 342528    0    0   344     0 1059  6752  4 76 17  4
151 17      0 48356064  49888 580608    0    0   444     0  925   144  8 92  0  0
151 21      0 48115424  73952 783968    0    0   488     0  993   257  9 90  0  1
139 25      0 47834816 101248 1026272    0    0   460     0 1013   378  5 95  0  0
142 22      0 47626176 122208 1206304    0    0   720     0 1019   265  6 94  0  0
87 13      0 47268832 150624 1564096    0    0  1084     0 1150  1809  2 88  1  9
 0  0      0 47327264 150880 1564960    0    0    28     0 1079   374  0  4 96  0
 0  0      0 47331040 150880 1564960    0    0     0     0 1030    69  0  0 100  0
 0  0      0 47329824 150880 1565088    0    0     0     0 1025    21  0  0 100  0
 0  0      0 47329824 150880 1565088    0    0     0     0 1026    20  0  0 100  0
 0  0      0 47329696 150880 1565120    0    0     0     0 1025    22  0  0 100  0
 0  0      0 47330144 150880 1565152    0    0     0     0 1040    58  0  0 100  0
 0  0      0 47330016 150880 1565184    0    0    28     0 1033    40  0  0 100  0
 0  0      0 47329952 150880 1565216    0    0     0     0 1030    33  0  0 100  0
 0  0      0 47329952 150880 1565216    0    0     0     0 1051    93  0  0 100  0
 0  0      0 47330144 150880 1565216    0    0     0     0 1027    22  0  0 100  0
 0  0      0 47330144 150880 1565216    0    0     0     0 1044    62  0  0 100  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
 1  0      0 47330144 150880 1565248    0    0     0     0 1039   103  0  0 100  0
 0  0      0 47330144 150880 1565248    0    0     0     0 1034    28  0  0 100  0
 0  0      0 47330400 150912 1565280    0    0     8     0 1043    60  0  0 100  0
 0  0      0 47330400 150912 1565280    0    0     0     0 1025    22  0  0 100  0
 0  0      0 47330400 150912 1565280    0    0     0     0 1032    43  0  0 100  0
 0  0      0 47330400 150912 1565280    0    0     0     0 1029    32  0  0 100  0
 5  0      0 47328544 150912 1565344    0    0     4     0 1032    49  0  0 100  0
 0  0      0 47296224 150912 1565344    0    0     0     0 1026   257  0  1 99  0
12  1      0 47129952 150912 1565408    0    0     4     0 1025  1506  2 21 77  0
41  1      0 46885216 173728 1857312    0    0   136     0 1013  1233  2 42 54  2
51  2      0 46698976 194240 2019328    0    0    72     0  996   118 10 85  6  0
62  3      0 46523360 216576 2169952    0    0   140     0 1123   112 10 89  0  1
59  4      0 46364064 235136 2306176    0    0   392     0 1209   177  9 91  0  0
51  5      0 46216288 252224 2433792    0    0   316     0  983   130  5 94  0  0
60  1      0 46053024 268448 2578720    0    0   276     0 1050   221  2 98  0  0
77  1      0 45922400 281376 2698528    0    0   248     0 1052   229  3 97  0  0
96  5      0 45632288 307648 2961568    0    0   248     0 1047   277  3 97  0  0
114  5      0 45373024 335776 3192096    0    0   176     0 1059   346  2 98  0  0
110  2      0 45211424 355840 3330720    0    0    68     0 1042   241  2 98  0  0
111  7      0 45117216 367744 3410240    0    0    44     0 1036   223  1 99  0  0
127  1      0 44932320 384096 3579360    0    0    52     0 1298   501  2 98  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
129  3      0 44775584 401280 3718752    0    0    72     0 1043   305  2 98  0  0
127  1      0 44657376 416512 3818784    0    0    60     0 1044   223  2 98  0  0
127  1      0 44554784 430304 3905664    0    0    56     0 1043   227  2 98  0  0
100 25      0 44485600 440736 3962816    0    0    40     0 1035   243  2 98  0  0
123 19      0 44390144 451712 4045696    0    0    32     0 1034   216  2 98  0  0
124  7      0 44269792 464192 4150816    0    0    32     0 1033   212  2 98  0  0
125  0      0 44189792 473280 4220160    0    0    32     0 1038   220  3 97  0  0
123  1      0 44147296 478816 4255712    0    0    28     0 1031   217  2 98  0  0
126  0      0 44147552 483072 4249472    0    0    12     0 1035   194  2 98  0  0
125  0      0 44157472 485888 4235264    0    0     0     0 1029   188  2 98  0  0
127  0      0 44205536 489184 4182304    0    0     0     0 1018   198  1 99  0  0
121  0      0 44223776 491328 4162272    0    0     0     0 1029   220  1 99  0  0
122  0      0 44231584 493504 4152736    0    0     0     0 1025   321  1 99  0  0
119  0      0 44241952 496544 4137760    0    0     0     0 1031   238  2 98  0  0
121  0      0 44228640 499904 4148128    0    0     0     0 1022   193  2 98  0  0
120  0      0 44213024 502880 4161152    0    0     0     0 1028   195  2 98  0  0
123  0      0 44234400 505280 4135968    0    0     0     0 1026   174  2 98  0  0
116  0      0 44222304 507328 4147360    0    0     0     0 1026   207  1 99  0  0
118  0      0 44215264 509792 4153216    0    0     0     0 1035   236  2 98  0  0
118  0      0 44218336 512960 4146592    0    0     0     0 1023   192  2 98  0  0
120  0      0 44219552 516192 4141984    0    0     8     0 1023   202  2 98  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
118  0      0 44234848 518304 4124768    0    0     0     0 1032   202  1 99  0  0
118  0      0 44224480 522400 4133024    0    0     0     0 1023   239  2 98  0  0
116  0      0 44248544 525504 4105376    0    0     0     0 1034   253  2 98  0  0
118  0      0 44226720 529152 4124640    0    0     0     0 1018   241  1 98  0  0
116  1      0 44202912 533920 4143808    0    0     8     0 1028   207  2 98  0  0
115  0      0 44180192 538080 4162208    0    0    12     0 1029   217  2 98  0  0
114  0      0 44169632 541760 4169536    0    0     8     0 1035   211  2 98  0  0
117  0      0 44161696 545312 4174048    0    0     0     0 1020   198  2 98  0  0
117  0      0 44183264 548640 4149696    0    0     0     0 1030   205  2 98  0  0
119  0      0 44173792 551328 4155936    0    0     0     0 1025   192  2 98  0  0
115  0      0 44184736 553344 4143680    0    0     0     0 1026   211  1 99  0  0
115  0      0 44173216 555840 4154048    0    0     0     0 1028   245  2 98  0  0
115  0      0 44158112 558912 4166176    0    0     0     0 1025   208  2 98  0  0
117  0      0 44173216 561888 4146144    0    0     0     0 1036   239  2 98  0  0
113  0      0 44169888 564128 4148992    0    0     0     0 1019   259  1 99  0  0
114  0      0 44162016 566304 4156160    0    0     0     0 1026   232  2 98  0  0
113  0      0 44171936 568864 4142912    0    0     0     0 1035   241  2 98  0  0
114  0      0 44185376 570656 4127296    0    0     4     0 1023   237  2 98  0  0
112  0      0 44209056 572064 4102080    0    0     0     0 1027   234  2 98  0  0
114  0      0 44255392 573504 4055296    0    0     0     0 1025   223  2 98  0  0
115  0      0 44264544 574720 4044608    0    0     0     0 1030   242  1 99  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
99  0      0 44282656 575936 4026048    0    0     0     0 1036   258  1 99  0  0
111  0      0 44282656 578144 4025920    0    0     0     0 1024   273  2 98  0  0
111  0      0 44285920 580864 4019616    0    0     0     0 1043   240  2 98  0  0
111  0      0 44269856 583712 4032864    0    0     0     0 1031   209  2 98  0  0
112  0      0 44290080 586112 4009312    0    0     0     0 1027   253  2 98  0  0
111  0      0 44320608 588128 3977472    0    0     0     0 1025   222  1 99  0  0
104  0      0 44324704 590816 3971520    0    0     0     0 1028   253  1 98  0  0
108  0      0 44302048 593184 3994496    0    0     0     0 1027   247  2 98  0  0
109  0      0 44299360 596672 3993216    0    0     0     0 1025   210  2 98  0  0
108  0      0 44286176 600288 4002336    0    0     0     0 1037   213  2 98  0  0
107  0      0 44288352 603168 3996960    0    0     0     0 1016   211  2 98  0  0
106  0      0 44296288 605280 3988032    0    0     0     0 1040   216  2 98  0  0
108  0      0 44316128 606560 3966656    0    0     0     0 1017   201  2 98  0  0
106  0      0 44316384 607840 3965248    0    0     0     0 1033   225  1 99  0  0
104  0      0 44332896 609152 3947616    0    0     0     0 1024   229  1 99  0  0
108  0      0 44339104 611040 3940448    0    0     0     0 1019   234  2 98  0  0
107  0      0 44352224 612608 3925536    0    0     0     0 1044   217  1 99  0  0
104  0      0 44357984 614176 3918752    0    0     0     0 1018   277  2 98  0  0
107  0      0 44373216 616352 3902240    0    0     0     0 1022   227  2 98  0  0
105  0      0 44384416 617792 3889600    0    0     0     0 1025   206  1 99  0  0
105  1      0 44388448 618080 3886304    0    0     0   744 1093   254  2 98  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
106  1      0 44387232 615104 3889568    0    0     0   976 1267   242  2 98  0  0
102  0      0 44432800 612320 3846560    0    0     0   536 1271   240  2 98  0  0
98  0      0 44429152 614048 3849632    0    0     0     0 1042   221  1 98  0  0
102  0      0 44428576 616352 3849760    0    0     0     0 1020   247  2 98  0  0
102  0      0 44431648 618240 3844992    0    0     0     0 1028   207  2 98  0  0
105  1      0 44471776 613888 3809248    0    0     0  1108 1202   236  2 98  0  0
99  0      0 44484960 613024 3797696    0    0     0   288 1198   237  1 99  0  0
101  0      0 44475424 615648 3804032    0    0     0     0 1030   279  2 98  0  0
100  0      0 44463520 618656 3814432    0    0     0     0 1024   227  2 98  0  0
99  1      0 44473696 613856 3808416    0    0     0  1452 1257   276  2 98  0  0
100  0      0 44488160 614240 3793568    0    0     0   256 1216   230  2 98  0  0
101  0      0 44483296 616416 3797504    0    0     0     0 1028   215  2 98  0  0
100  0      0 44509664 618304 3769120    0    0     0     0 1043   223  2 98  0  0
99  0      0 44550752 615392 3730208    0    0     0  1056 1148   250  1 98  0  0
99  0      0 44553056 611808 3731232    0    0     0   468 1243   233  1 99  0  0
96  0      0 44557408 613568 3727232    0    0     0     0 1040   286  2 98  0  0
98  0      0 44575904 615680 3706176    0    0     0     0 1026   204  2 98  0  0
97  0      0 44580064 617024 3700992    0    0     0     0 1024   206  1 99  0  0
69  1      0 44577888 614784 3705728    0    0     0   824 1112   295  1 98  0  0
70  0      0 44595104 612032 3691936    0    0     0   788 1270   288  2 98  0  0
70  0      0 44599840 613408 3686592    0    0     0     0 1092   191  2 98  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
72  0      0 44628832 615104 3656480    0    0     0     0 1026   198  2 98  0  0
68  0      0 44639392 617216 3642688    0    0     0     0 1027   187  2 98  0  0
68  1      0 44641312 612448 3645952    0    0     0  1032 1159   232  2 98  0  0
68  0      0 44642080 613120 3644416    0    0     0    64 1169   213  2 98  0  0
70  0      0 44636832 614592 3647520    0    0     0     0 1023   194  2 98  0  0
67  0      0 44683360 616224 3598656    0    0     0     0 1026   195  2 98  0  0
67  1      0 44696224 613152 3589056    0    0     0   976 1143   228  2 98  0  0
68  0      0 44709728 610080 3578208    0    0     0   464 1255   227  2 98  0  0
66  0      0 44748512 611424 3538208    0    0     0     0 1033   193  2 98  0  0
62  0      0 44761184 613888 3520960    0    0     0     0 1038   243  2 97  1  0
63  0      0 44754848 615264 3527328    0    0     0     0 1016   197  2 98  0  0
63  1      0 44782240 609792 3503552    0    0     0  1356 1237   239  2 98  0  0
63  0      0 44796576 609920 3489504    0    0     0   224 1204   218  2 98  0  0
63  0      0 44808928 611072 3476576    0    0     0     0 1024   195  2 98  0  0
66  0      0 44799136 613248 3484448    0    0     0     0 1026   179  2 98  0  0
62  1      0 44787232 608928 3500032    0    0     0   996 1153   232  2 98  0  0
65  0      0 44796128 609312 3490240    0    0     0   204 1202   205  2 98  0  0
60  0      0 44844640 610304 3440576    0    0     0     0 1025   183  2 98  1  0
58  0      0 44872032 611392 3411232    0    0     0     0 1029   191  2 98  0  0
60  0      0 44902880 612224 3379968    0    0     0     0 1024   173  2 98  0  0
58  1      0 44929056 609088 3356160    0    0     0   616 1058   192  2 98  0  0
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
58  1      0 44946208 607232 3340672    0    0     4   688 1262   258  2 98  0  0
56  0      0 44946848 608224 3338432    0    0     4     0 1081   204  2 98  0  0
53  0      0 44939040 609216 3344768    0    0     0     0 1028   174  2 98  0  0
54  1      0 44961440 610144 3321472    0    0    40     0 1035   194  2 98  0  0
53  0      0 45005600 611008 3275968    0    0     8     0 1029   167  2 98  0  0
51  1      0 45035808 612064 3245344    0    0    40     0 1038   189  2 97  0  0
53  1      0 45012384 605952 3274176    0    0    16  1188 1259   187  2 98  0  0
52  1      0 45059168 607200 3225312    0    0    20     0 1100   159  2 98  0  0
49  0      0 45082656 608192 3201120    0    0    20     0 1032   158  2 97  0  0
48  0      0 45105440 608896 3177408    0    0     0     0 1033   119  2 98  0  0
48  0      0 45157152 609376 3124960    0    0     0     0 1019   109  2 98  0  0
47  3      0 45198112 606464 3085984    0    0    52   516 1047   145  2 98  0  0
44  3      0 45223072 606080 3060128    0    0    32   876 1276   226  2 98  0  0
45  1      0 45248032 605792 3035712    0    0    36    68 1150   179  2 98  0  0
42  1      0 45258080 607584 3024096    0    0    64     0 1044   146  2 98  0  0
41  0      0 45307360 608928 2971872    0    0    92     0 1046   209  2 97  1  0
38  3      0 45343264 605600 2939584    0    0    20   900 1137   106  2 98  0  0
36  2      0 45341920 603456 2943168    0    0    20   356 1235   170  2 97  0  0
35  1      0 45377568 605408 2905408    0    0   152     0 1075   220  2 98  0  0
33  3      0 45410208 607968 2869504    0    0   184     0 1066   248  2 97  0  1
32  4      0 45462816 604896 2819904    0    0   160  1124 1216  1102  2 92  0  5
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
29  3      0 45483360 602976 2800448    0    0    72   400 1248   742  2 88  3  7
29  2      0 45538016 606016 2741984    0    0   268     0 1113   788  2 87  7  4
24  5      0 45599776 605152 2680224    0    0   292   816 1175  1267  2 75 14  9
22  6      0 45601952 601824 2681152    0    0    12   656 1289   941  2 69 15 14
22  4      0 45679968 605984 2596672    0    0   456     0 1167  2593  2 63 22 13
14  8      0 45757792 601600 2522816    0    0   252  1068 1231  2940  2 48 31 19
38  2      0 45771040 601440 2515968    0    0    64    68 1197   943  2 63 26 10
45  2      0 45826784 604416 2471168    0    0   300     0 1099   679  1 98  0  0
41  0      0 45937952 608064 2359872    0    0   420     0 1129   944  1 98  0  0
35  0      0 45973856 609088 2325472    0    0    24     0 1034    95  2 94  4  0
31  0      0 45994592 611776 2300832    0    0   216     0 1080   240  2 93  4  1
26  2      0 46052256 605024 2248672    0    0   268   404 1185   780  2 84 10  4
27  0      0 46096608 607776 2202336    0    0   260     0 1093   370  2 78 18  2
27  1      0 46112864 609568 2182944    0    0   144     0 1060   166  2 74 23  1
24  0      0 46137504 611264 2157024    0    0   160     0 1069   201  2 72 25  1
24  0      0 46138272 611488 2155872    0    0     0     0 1026    30  2 69 29  0
23  1      0 46155744 612896 2135936    0    0   152     0 1061   217  2 69 28  1
23  0      0 46168224 613344 2123136    0    0    28     0 1034    73  2 68 30  0
20  0      0 46213664 607584 2083200    0    0   336   980 1282   438  2 64 31  3
18  1      0 46253152 609760 2041632    0    0   264     0 1126   348  2 56 40  2
18  0      0 46279584 611680 2013344    0    0   220     0 1082   249  2 52 45  1
procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
17  0      0 46293280 612032 1998816    0    0    40     0 1040    81  2 49 49  0
15  0      0 46335456 606752 1962336    0    0   220   440 1170   466  2 44 52  2
13  0      0 46372704 608256 1922880    0    0   184     0 1079   291  1 38 59  1
14  1      0 46438432 611264 1861312    0    0   352     0 1113  1133  1 39 55  5
13  1      0 46491360 613600 1806592    0    0   280     0 1096   463  1 38 58  2
10  3      0 46580704 609184 1757312    0    0   320   948 1272  1719  1 30 63  5
 3  4      0 46682336 613856 1674304    0    0   596     0 1197  3547  2 13 67 17
 3  1      0 46788832 611232 1574912    0    0   480   188 1197  1748  1  5 84 11
 0  0      0 46804960 611680 1562208    0    0    56     0 1045    81  0  0 99  0
 0  0      0 46805088 611680 1562208    0    0     0     0 1026    24  0  0 100  0
 1  0      0 46805088 611680 1562208    0    0     0     0 1025    25  0  0 100  0
 0  0      0 46805088 611680 1562208    0    0     0     0 1027    17  0  0 100  0
 0  0      0 46805088 611680 1562208    0    0     0     0 1025    24  0  0 100  0
 1  0      0 46800416 611808 1562304    0    0    76     0 1035   150  0  1 98  0
 0  0      0 46804384 611936 1562400    0    0    32     0 1035    64  0  0 99  0
 0  0      0 46804384 611936 1562400    0    0     0     0 1025    18  0  0 100  0
 0  0      0 46804384 611936 1562400    0    0     0     0 1026    18  0  0 100  0
 0  0      0 46804576 611936 1562400    0    0     0     0 1027    44  0  0 100  0
