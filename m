Return-Path: <linux-kernel-owner+w=401wt.eu-S1750908AbXACQXu@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1750908AbXACQXu (ORCPT <rfc822;w@1wt.eu>);
	Wed, 3 Jan 2007 11:23:50 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1750911AbXACQXu
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Wed, 3 Jan 2007 11:23:50 -0500
Received: from nf-out-0910.google.com ([64.233.182.185]:4001 "EHLO
	nf-out-0910.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1750908AbXACQXr (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Wed, 3 Jan 2007 11:23:47 -0500
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
        s=beta; d=gmail.com;
        h=received:message-id:date:from:to:subject:cc:mime-version:content-type;
        b=CLJzG3sV9LTs1ztIQzmFqvr+McbsRaG7lCISYG8RO0sWTPUOhJbWMuvNMIVM7QUj/VuOXQth4cHBL7h3lM/+B7tt9832fC0NRl+3nIJ+n20hXPz+9/kwJV5Ixkr0/7eF95HFM3vvOsyXlSVAR94tEuLkQGCWvQqSqycbVaGbaPc=
Message-ID: <b1e142760701030823u4ee9f876o49069807ae6404ec@mail.gmail.com>
Date: Wed, 3 Jan 2007 11:23:45 -0500
From: "Ming Zhao" <mingzhao99th@gmail.com>
To: "device-mapper development" <dm-devel@redhat.com>
Subject: [dm-devel] [RFC][PATCH] dm-cache (block level disk cache target): UPDATE
Cc: linux-kernel@vger.kernel.org, ming@acis.ufl.edu, ericvh@gmail.com
MIME-Version: 1.0
Content-Type: multipart/mixed; 
	boundary="----=_Part_221821_3510469.1167841425577"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

------=_Part_221821_3510469.1167841425577
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Made several updates on the dm-cache code. The major ones include,

* The change on handling of reads: cache insertions are now performed
in background for read bio requests, so the reads would appear faster.
* The feature of persistent metadata: cache metadata is automatically
dumped onto cache disk before a cache is removed, and it can be loaded
again when creating a cache so that the existing data on the cache
disk can be reused.
* The handling of status ioctl is also added, so on dmsetup status,
the cache outputs the cache stats, and on dmsetup table, it outputs
the cache configuration.

Signed-off-by: Ming Zhao <mingzhao99th@gmail.com>

------=_Part_221821_3510469.1167841425577
Content-Type: text/plain; name=patch-2.6.19.1; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: base64
X-Attachment-Id: f_ewhyciz6
Content-Disposition: attachment; filename="patch-2.6.19.1"

ZGlmZiAtTmF1ciBsaW51eC0yLjYuMTkuMS1vcmlnL2RyaXZlcnMvbWQvZG0tY2FjaGUuYyBsaW51
eC0yLjYuMTkuMS1kbWNhY2hlL2RyaXZlcnMvbWQvZG0tY2FjaGUuYwotLS0gbGludXgtMi42LjE5
LjEtb3JpZy9kcml2ZXJzL21kL2RtLWNhY2hlLmMJMTk2OS0xMi0zMSAxOTowMDowMC4wMDAwMDAw
MDAgLTA1MDAKKysrIGxpbnV4LTIuNi4xOS4xLWRtY2FjaGUvZHJpdmVycy9tZC9kbS1jYWNoZS5j
CTIwMDctMDEtMDEgMTg6MjY6MDYuMDAwMDAwMDAwIC0wNTAwCkBAIC0wLDAgKzEsMTc1NSBAQAor
LyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioKKyAqICBkbS1jYWNoZS5jCisgKiAgRGV2aWNlIG1hcHBlciB0
YXJnZXQgZm9yIGJsb2NrLWxldmVsIGRpc2sgY2FjaGluZworICoKKyAqICBDb3B5cmlnaHQgKEMp
IEludGVybmF0aW9uYWwgQnVzaW5lc3MgTWFjaGluZXMgQ29ycC4sIDIwMDYKKyAqICBBdXRob3I6
IE1pbmcgWmhhbyAobWluZ3poYW9AdWZsLmVkdSkKKyAqCisgKiAgVGhpcyBwcm9ncmFtIGlzIGZy
ZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKKyAqICBp
dCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1
Ymxpc2hlZCBieQorICogIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IHVuZGVyIHZlcnNp
b24gMiBvZiB0aGUgTGljZW5zZS4KKyAqCisgKiAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVk
IGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCisgKiAgYnV0IFdJVEhPVVQgQU5Z
IFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKKyAqICBNRVJD
SEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhl
CisgKiAgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KKyAqCisg
KiAgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVi
bGljIExpY2Vuc2UKKyAqICBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbTsgaWYgbm90LCB3cml0ZSB0
byB0aGUgRnJlZSBTb2Z0d2FyZQorICogIEZvdW5kYXRpb24sIEluYy4sIDU5IFRlbXBsZSBQbGFj
ZSwgU3VpdGUgMzMwLCBCb3N0b24sIE1BICAwMjExMS0xMzA3ICBVU0EKKyAqCisgKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKi8KKworI2luY2x1ZGUgPGFzbS9hdG9taWMuaD4KKyNpbmNsdWRlIDxhc20vY2hl
Y2tzdW0uaD4KKyNpbmNsdWRlIDxsaW51eC9tb2R1bGUuaD4KKyNpbmNsdWRlIDxsaW51eC9pbml0
Lmg+CisjaW5jbHVkZSA8bGludXgvbGlzdC5oPgorI2luY2x1ZGUgPGxpbnV4L2Jsa2Rldi5oPgor
I2luY2x1ZGUgPGxpbnV4L2Jpby5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRl
IDxsaW51eC9oYXNoLmg+CisjaW5jbHVkZSA8bGludXgvc3BpbmxvY2suaD4KKyNpbmNsdWRlIDxs
aW51eC93b3JrcXVldWUuaD4KKyNpbmNsdWRlIDxsaW51eC9wYWdlbWFwLmg+CisKKyNpbmNsdWRl
ICJkbS5oIgorI2luY2x1ZGUgImRtLWlvLmgiCisjaW5jbHVkZSAiZG0tYmlvLWxpc3QuaCIKKyNp
bmNsdWRlICJrY29weWQuaCIKKworI2RlZmluZSBETUNfREVCVUcgMAorCisjZGVmaW5lIERNX01T
R19QUkVGSVggImNhY2hlIgorI2RlZmluZSBETUNfUFJFRklYICJkbS1jYWNoZTogIgorCisjaWYg
RE1DX0RFQlVHCisjZGVmaW5lIERQUklOVEsoIHMsIGFyZy4uLiApIHByaW50ayhETUNfUFJFRklY
IHMgIlxuIiwgIyNhcmcpCisjZWxzZQorI2RlZmluZSBEUFJJTlRLKCBzLCBhcmcuLi4gKQorI2Vu
ZGlmCisKKy8qIERlZmF1bHQgY2FjaGUgcGFyYW1ldGVycyAqLworI2RlZmluZSBERUZBVUxUX0NB
Q0hFX1NJWkUJNjU1MzYKKyNkZWZpbmUgREVGQVVMVF9DQUNIRV9BU1NPQwkxMDI0CisjZGVmaW5l
IERFRkFVTFRfQkxPQ0tfU0laRQk4CisjZGVmaW5lIENPTlNFQ1VUSVZFX0JMT0NLUwk1MTIKKwor
LyogV3JpdGUgcG9saWN5ICovCisjZGVmaW5lIFdSSVRFX1RIUk9VR0ggMAorI2RlZmluZSBXUklU
RV9CQUNLIDEKKyNkZWZpbmUgREVGQVVMVF9XUklURV9QT0xJQ1kgV1JJVEVfVEhST1VHSAorCisv
KiBOdW1iZXIgb2YgcGFnZXMgZm9yIEkvTyAqLworI2RlZmluZSBETUNBQ0hFX0NPUFlfUEFHRVMg
MTAyNAorCisvKiBIYXNoIGZ1bmN0aW9uICovCisjZGVmaW5lIEhBU0ggMAkJLyogVXNlIGhhc2hf
bG9uZyAqLworI2RlZmluZSBVTklGT1JNIDEJLyogRXZlbmx5IGRpc3RyaWJ1dGVkICovCisjZGVm
aW5lIERFRkFVTFRfSEFTSEZVTkMgVU5JRk9STQorCisvKiBTdGF0ZXMgb2YgYSBjYWNoZSBibG9j
ayAqLworI2RlZmluZSBJTlZBTElECQkwCisjZGVmaW5lIFZBTElECQkxCS8qIFZhbGlkICovCisj
ZGVmaW5lIFJFU0VSVkVECTIJLyogQWxsb2NhdGVkIGJ1dCBkYXRhIG5vdCBpbiBwbGFjZSB5ZXQg
Ki8KKyNkZWZpbmUgRElSVFkJCTQJLyogTG9jYWxseSBtb2RpZmllZCAqLworI2RlZmluZSBXUklU
RUJBQ0sJOAkvKiBJbiB0aGUgcHJvY2VzcyBvZiB3cml0ZSBiYWNrICovCisKKyNkZWZpbmUgaXNf
c3RhdGUoeCwgeSkJCSh4ICYgeSkKKyNkZWZpbmUgc2V0X3N0YXRlKHgsIHkpCQkoeCB8PSB5KQor
I2RlZmluZSBjbGVhcl9zdGF0ZSh4LCB5KQkoeCAmPSB+eSkKKworLyoKKyAqIENhY2hlIGNvbnRl
eHQKKyAqLworc3RydWN0IGNhY2hlX2MgeworCXN0cnVjdCBkbV9kZXYgKnNyY19kZXY7CQkvKiBT
b3VyY2UgZGV2aWNlICovCisJc3RydWN0IGRtX2RldiAqY2FjaGVfZGV2OwkvKiBDYWNoZSBkZXZp
Y2UgKi8KKwlzdHJ1Y3Qga2NvcHlkX2NsaWVudCAqa2NwX2NsaWVudDsgLyogS2NvcHlkIGNsaWVu
dCBmb3Igd3JpdGluZyBiYWNrIGRhdGEgKi8KKworCXN0cnVjdCBjYWNoZWJsb2NrICpjYWNoZTsJ
LyogSGFzaCB0YWJsZSBmb3IgY2FjaGUgYmxvY2tzICovCisJc2VjdG9yX3Qgc2l6ZTsJCQkvKiBD
YWNoZSBzaXplICovCisJdW5zaWduZWQgaW50IGJpdHM7CQkvKiBDYWNoZSBzaXplIGluIGJpdHMg
Ki8KKwl1bnNpZ25lZCBpbnQgYXNzb2M7CQkvKiBDYWNoZSBhc3NvY2lhdGl2aXR5ICovCisJdW5z
aWduZWQgaW50IGJsb2NrX3NpemU7CS8qIENhY2hlIGJsb2NrIHNpemUgKi8KKwl1bnNpZ25lZCBp
bnQgYmxvY2tfc2hpZnQ7CS8qIENhY2hlIGJsb2NrIHNpemUgaW4gYml0cyAqLworCXVuc2lnbmVk
IGludCBibG9ja19tYXNrOwkvKiBDYWNoZSBibG9jayBtYXNrICovCisJdW5zaWduZWQgaW50IGNv
bnNlY3V0aXZlX3NoaWZ0OwkvKiBDb25zZWN1dGl2ZSBibG9ja3Mgc2l6ZSBpbiBiaXRzICovCisJ
dW5zaWduZWQgbG9uZyBjb3VudGVyOwkJLyogTG9naWNhbCB0aW1lc3RhbXAgb2YgbGFzdCBhY2Nl
c3MgKi8KKwl1bnNpZ25lZCBpbnQgd3JpdGVfcG9saWN5OwkvKiBDYWNoZSB3cml0ZSBwb2xpY3kg
Ki8KKwlzZWN0b3JfdCBkaXJ0eV9ibG9ja3M7CQkvKiBOdW1iZXIgb2YgZGlydHkgYmxvY2tzICov
CisKKwlzcGlubG9ja190IGxvY2s7CQkvKiBMb2NrIHRvIHByb3RlY3QgcGFnZSBhbGxvY2F0aW9u
L2RlYWxsb2NhdGlvbiAqLworCXN0cnVjdCBwYWdlX2xpc3QgKnBhZ2VzOwkvKiBQYWdlcyBmb3Ig
SS9PICovCisJdW5zaWduZWQgaW50IG5yX3BhZ2VzOwkJLyogTnVtYmVyIG9mIHBhZ2VzICovCisJ
dW5zaWduZWQgaW50IG5yX2ZyZWVfcGFnZXM7CS8qIE51bWJlciBvZiBmcmVlIHBhZ2VzICovCisJ
d2FpdF9xdWV1ZV9oZWFkX3QgZGVzdHJveXE7CS8qIFdhaXQgcXVldWUgZm9yIEkvTyBjb21wbGV0
aW9uICovCisJYXRvbWljX3QgbnJfam9iczsJCS8qIE51bWJlciBvZiBJL08gam9icyAqLworCS8q
IFN0YXRzICovCisJdW5zaWduZWQgbG9uZyByZWFkczsJCS8qIE51bWJlciBvZiByZWFkcyAqLwor
CXVuc2lnbmVkIGxvbmcgd3JpdGVzOwkJLyogTnVtYmVyIG9mIHdyaXRlcyAqLworCXVuc2lnbmVk
IGxvbmcgY2FjaGVfaGl0czsJLyogTnVtYmVyIG9mIGNhY2hlIGhpdHMgKi8KKwl1bnNpZ25lZCBs
b25nIHJlcGxhY2U7CQkvKiBOdW1iZXIgb2YgY2FjaGUgcmVwbGFjZW1lbnRzICovCisJdW5zaWdu
ZWQgbG9uZyB3cml0ZWJhY2s7CS8qIE51bWJlciBvZiByZXBsYWNlZCBkaXJ0eSBibG9ja3MgKi8K
Kwl1bnNpZ25lZCBsb25nIGRpcnR5OwkJLyogTnVtYmVyIG9mIHN1Ym1pdHRlZCBkaXJ0eSBibG9j
a3MgKi8KK307CisKKy8qIENhY2hlIGJsb2NrIG1ldGFkYXRhIHN0cnVjdHVyZSAqLworc3RydWN0
IGNhY2hlYmxvY2sgeworCXNwaW5sb2NrX3QgbG9jazsJLyogTG9jayB0byBwcm90ZWN0IG9wZXJh
dGlvbnMgb24gdGhlIGJpbyBsaXN0ICovCisJc2VjdG9yX3QgYmxvY2s7CQkvKiBTZWN0b3IgbnVt
YmVyIG9mIHRoZSBjYWNoZWQgYmxvY2sgKi8KKwl1bnNpZ25lZCBzaG9ydCBzdGF0ZTsJLyogU3Rh
dGUgb2YgYSBibG9jayAqLworCXVuc2lnbmVkIGxvbmcgY291bnRlcjsJLyogTG9naWNhbCB0aW1l
c3RhbXAgb2YgdGhlIGJsb2NrJ3MgbGFzdCBhY2Nlc3MgKi8KKwlzdHJ1Y3QgYmlvX2xpc3QgYmlv
czsJLyogTGlzdCBvZiBwZW5kaW5nIGJpb3MgKi8KK307CisKKworLyoqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioKKyAqICBGdW5jdGlvbnMgYW5kIGRhdGEgc3RydWN0dXJlcyBmb3IgaW1wbGVtZW50aW5nIGEg
a2NhY2hlZCB0byBoYW5kbGUgYXN5bmMKKyAqICBJL08uIENvZGUgZm9yIHBhZ2UgYW5kIHF1ZXVl
IGhhbmRsaW5nIGlzIGJvcnJvd2VkIGZyb20ga2NvcHlkLmMuCisgKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
Ki8KKworLyoKKyAqIEZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgcGFnZXMgdXNlZCBieSBhc3luYyBJ
L08uCisgKiBUaGUgZGF0YSBhc2tlZCBieSBhIGJpbyByZXF1ZXN0IG1heSBub3QgYmUgYWxpZ25l
ZCB3aXRoIGNhY2hlIGJsb2NrcywgaW4KKyAqIHdoaWNoIGNhc2UgYWRkaXRpb25hbCBwYWdlcyBh
cmUgcmVxdWlyZWQgZm9yIHRoZSByZXF1ZXN0IHRoYXQgaXMgZm9yd2FyZGVkCisgKiB0byB0aGUg
c2VydmVyLiBBIHBvb2wgb2YgcGFnZXMgYXJlIHJlc2VydmVkIGZvciB0aGlzIHB1cnBvc2UuCisg
Ki8KKworc3RhdGljIHN0cnVjdCBwYWdlX2xpc3QgKmFsbG9jX3BsKHZvaWQpCit7CisJc3RydWN0
IHBhZ2VfbGlzdCAqcGw7CisKKwlwbCA9IGttYWxsb2Moc2l6ZW9mKCpwbCksIEdGUF9LRVJORUwp
OworCWlmICghcGwpCisJCXJldHVybiBOVUxMOworCisJcGwtPnBhZ2UgPSBhbGxvY19wYWdlKEdG
UF9LRVJORUwpOworCWlmICghcGwtPnBhZ2UpIHsKKwkJa2ZyZWUocGwpOworCQlyZXR1cm4gTlVM
TDsKKwl9CisKKwlyZXR1cm4gcGw7Cit9CisKK3N0YXRpYyB2b2lkIGZyZWVfcGwoc3RydWN0IHBh
Z2VfbGlzdCAqcGwpCit7CisJX19mcmVlX3BhZ2UocGwtPnBhZ2UpOworCWtmcmVlKHBsKTsKK30K
Kworc3RhdGljIHZvaWQgZHJvcF9wYWdlcyhzdHJ1Y3QgcGFnZV9saXN0ICpwbCkKK3sKKwlzdHJ1
Y3QgcGFnZV9saXN0ICpuZXh0OworCisJd2hpbGUgKHBsKSB7CisJCW5leHQgPSBwbC0+bmV4dDsK
KwkJZnJlZV9wbChwbCk7CisJCXBsID0gbmV4dDsKKwl9Cit9CisKK3N0YXRpYyBpbnQga2NhY2hl
ZF9nZXRfcGFnZXMoc3RydWN0IGNhY2hlX2MgKmRtYywgdW5zaWduZWQgaW50IG5yLAorCSAgICAg
ICAgICAgICAgICAgICAgICAgICBzdHJ1Y3QgcGFnZV9saXN0ICoqcGFnZXMpCit7CisJc3RydWN0
IHBhZ2VfbGlzdCAqcGw7CisKKwlzcGluX2xvY2soJmRtYy0+bG9jayk7CisJaWYgKGRtYy0+bnJf
ZnJlZV9wYWdlcyA8IG5yKSB7CisJCURQUklOVEsoImtjYWNoZWRfZ2V0X3BhZ2VzOiBObyBmcmVl
IHBhZ2VzOiAldTwldSIsCisJCSAgICAgICAgZG1jLT5ucl9mcmVlX3BhZ2VzLCBucik7CisJCXNw
aW5fdW5sb2NrKCZkbWMtPmxvY2spOworCQlyZXR1cm4gLUVOT01FTTsKKwl9CisKKwlkbWMtPm5y
X2ZyZWVfcGFnZXMgLT0gbnI7CisJZm9yICgqcGFnZXMgPSBwbCA9IGRtYy0+cGFnZXM7IC0tbnI7
IHBsID0gcGwtPm5leHQpCisJCTsKKworCWRtYy0+cGFnZXMgPSBwbC0+bmV4dDsKKwlwbC0+bmV4
dCA9IE5VTEw7CisKKwlzcGluX3VubG9jaygmZG1jLT5sb2NrKTsKKworCXJldHVybiAwOworfQor
CitzdGF0aWMgdm9pZCBrY2FjaGVkX3B1dF9wYWdlcyhzdHJ1Y3QgY2FjaGVfYyAqZG1jLCBzdHJ1
Y3QgcGFnZV9saXN0ICpwbCkKK3sKKwlzdHJ1Y3QgcGFnZV9saXN0ICpjdXJzb3I7CisKKwlzcGlu
X2xvY2soJmRtYy0+bG9jayk7CisJZm9yIChjdXJzb3IgPSBwbDsgY3Vyc29yLT5uZXh0OyBjdXJz
b3IgPSBjdXJzb3ItPm5leHQpCisJCWRtYy0+bnJfZnJlZV9wYWdlcysrOworCisJZG1jLT5ucl9m
cmVlX3BhZ2VzKys7CisJY3Vyc29yLT5uZXh0ID0gZG1jLT5wYWdlczsKKwlkbWMtPnBhZ2VzID0g
cGw7CisKKwlzcGluX3VubG9jaygmZG1jLT5sb2NrKTsKK30KKworc3RhdGljIGludCBhbGxvY19i
aW9fcGFnZXMoc3RydWN0IGNhY2hlX2MgKmRtYywgdW5zaWduZWQgaW50IG5yKQoreworCXVuc2ln
bmVkIGludCBpOworCXN0cnVjdCBwYWdlX2xpc3QgKnBsID0gTlVMTCwgKm5leHQ7CisKKwlmb3Ig
KGkgPSAwOyBpIDwgbnI7IGkrKykgeworCQluZXh0ID0gYWxsb2NfcGwoKTsKKwkJaWYgKCFuZXh0
KSB7CisJCQlpZiAocGwpCisJCQkJZHJvcF9wYWdlcyhwbCk7CisJCQlyZXR1cm4gLUVOT01FTTsK
KwkJfQorCQluZXh0LT5uZXh0ID0gcGw7CisJCXBsID0gbmV4dDsKKwl9CisKKwlrY2FjaGVkX3B1
dF9wYWdlcyhkbWMsIHBsKTsKKwlkbWMtPm5yX3BhZ2VzICs9IG5yOworCisJcmV0dXJuIDA7Cit9
CisKK3N0YXRpYyB2b2lkIGZyZWVfYmlvX3BhZ2VzKHN0cnVjdCBjYWNoZV9jICpkbWMpCit7CisJ
QlVHX09OKGRtYy0+bnJfZnJlZV9wYWdlcyAhPSBkbWMtPm5yX3BhZ2VzKTsKKwlkcm9wX3BhZ2Vz
KGRtYy0+cGFnZXMpOworCWRtYy0+cGFnZXMgPSBOVUxMOworCWRtYy0+bnJfZnJlZV9wYWdlcyA9
IGRtYy0+bnJfcGFnZXMgPSAwOworfQorCisvKiBTdHJ1Y3R1cmUgZm9yIGEga2NhY2hlZCBqb2Ig
Ki8KK3N0cnVjdCBrY2FjaGVkX2pvYiB7CisJc3RydWN0IGxpc3RfaGVhZCBsaXN0OworCXN0cnVj
dCBjYWNoZV9jICpkbWM7CisJc3RydWN0IGJpbyAqYmlvOwkvKiBPcmlnaW5hbCBiaW8gKi8KKwlz
dHJ1Y3QgaW9fcmVnaW9uIHNyYzsKKwlzdHJ1Y3QgaW9fcmVnaW9uIGRlc3Q7CisJc3RydWN0IGNh
Y2hlYmxvY2sgKmNhY2hlYmxvY2s7CisJaW50IHJ3OworCS8qCisJICogV2hlbiB0aGUgb3JpZ2lu
YWwgYmlvIGlzIG5vdCBhbGlnbmVkIHdpdGggY2FjaGUgYmxvY2tzLAorCSAqIHdlIG5lZWQgZXh0
cmEgYnZlY3MgYW5kIHBhZ2VzIGZvciBwYWRkaW5nLgorCSAqLworCXN0cnVjdCBiaW9fdmVjICpi
dmVjOworCXVuc2lnbmVkIGludCBucl9wYWdlczsKKwlzdHJ1Y3QgcGFnZV9saXN0ICpwYWdlczsK
K307CisKK3N0YXRpYyBzdHJ1Y3Qgd29ya3F1ZXVlX3N0cnVjdCAqX2tjYWNoZWRfd3E7CitzdGF0
aWMgc3RydWN0IHdvcmtfc3RydWN0IF9rY2FjaGVkX3dvcms7CisKK3N0YXRpYyBpbmxpbmUgdm9p
ZCB3YWtlKHZvaWQpCit7CisJcXVldWVfd29yayhfa2NhY2hlZF93cSwgJl9rY2FjaGVkX3dvcmsp
OworfQorCisjZGVmaW5lIE1JTl9KT0JTIDEwMjQKKworc3RhdGljIGttZW1fY2FjaGVfdCAqX2pv
Yl9jYWNoZTsKK3N0YXRpYyBtZW1wb29sX3QgKl9qb2JfcG9vbDsKKworc3RhdGljIERFRklORV9T
UElOTE9DSyhfam9iX2xvY2spOworCitzdGF0aWMgTElTVF9IRUFEKF9jb21wbGV0ZV9qb2JzKTsK
K3N0YXRpYyBMSVNUX0hFQUQoX2lvX2pvYnMpOworc3RhdGljIExJU1RfSEVBRChfcGFnZXNfam9i
cyk7CisKK3N0YXRpYyBpbnQgam9ic19pbml0KHZvaWQpCit7CisJX2pvYl9jYWNoZSA9IGttZW1f
Y2FjaGVfY3JlYXRlKCJrY2FjaGVkLWpvYnMiLAorCSAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBzaXplb2Yoc3RydWN0IGtjYWNoZWRfam9iKSwKKwkgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgX19hbGlnbm9mX18oc3RydWN0IGtjYWNoZWRfam9iKSwKKwkgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgMCwgTlVMTCwgTlVMTCk7CisJaWYgKCFfam9iX2NhY2hlKQorCQly
ZXR1cm4gLUVOT01FTTsKKworCV9qb2JfcG9vbCA9IG1lbXBvb2xfY3JlYXRlKE1JTl9KT0JTLCBt
ZW1wb29sX2FsbG9jX3NsYWIsCisJICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtcG9vbF9m
cmVlX3NsYWIsIF9qb2JfY2FjaGUpOworCWlmICghX2pvYl9wb29sKSB7CisJCWttZW1fY2FjaGVf
ZGVzdHJveShfam9iX2NhY2hlKTsKKwkJcmV0dXJuIC1FTk9NRU07CisJfQorCisJcmV0dXJuIDA7
Cit9CisKK3N0YXRpYyB2b2lkIGpvYnNfZXhpdCh2b2lkKQoreworCUJVR19PTighbGlzdF9lbXB0
eSgmX2NvbXBsZXRlX2pvYnMpKTsKKwlCVUdfT04oIWxpc3RfZW1wdHkoJl9pb19qb2JzKSk7CisJ
QlVHX09OKCFsaXN0X2VtcHR5KCZfcGFnZXNfam9icykpOworCisJbWVtcG9vbF9kZXN0cm95KF9q
b2JfcG9vbCk7CisJa21lbV9jYWNoZV9kZXN0cm95KF9qb2JfY2FjaGUpOworCV9qb2JfcG9vbCA9
IE5VTEw7CisJX2pvYl9jYWNoZSA9IE5VTEw7Cit9CisKKy8qCisgKiBGdW5jdGlvbnMgdG8gcHVz
aCBhbmQgcG9wIGEgam9iIG9udG8gdGhlIGhlYWQgb2YgYSBnaXZlbiBqb2IgbGlzdC4KKyAqLwor
c3RhdGljIGlubGluZSBzdHJ1Y3Qga2NhY2hlZF9qb2IgKnBvcChzdHJ1Y3QgbGlzdF9oZWFkICpq
b2JzKQoreworCXN0cnVjdCBrY2FjaGVkX2pvYiAqam9iID0gTlVMTDsKKwl1bnNpZ25lZCBsb25n
IGZsYWdzOworCisJc3Bpbl9sb2NrX2lycXNhdmUoJl9qb2JfbG9jaywgZmxhZ3MpOworCisJaWYg
KCFsaXN0X2VtcHR5KGpvYnMpKSB7CisJCWpvYiA9IGxpc3RfZW50cnkoam9icy0+bmV4dCwgc3Ry
dWN0IGtjYWNoZWRfam9iLCBsaXN0KTsKKwkJbGlzdF9kZWwoJmpvYi0+bGlzdCk7CisJfQorCXNw
aW5fdW5sb2NrX2lycXJlc3RvcmUoJl9qb2JfbG9jaywgZmxhZ3MpOworCisJcmV0dXJuIGpvYjsK
K30KKworc3RhdGljIGlubGluZSB2b2lkIHB1c2goc3RydWN0IGxpc3RfaGVhZCAqam9icywgc3Ry
dWN0IGtjYWNoZWRfam9iICpqb2IpCit7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKworCXNwaW5f
bG9ja19pcnFzYXZlKCZfam9iX2xvY2ssIGZsYWdzKTsKKwlsaXN0X2FkZF90YWlsKCZqb2ItPmxp
c3QsIGpvYnMpOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJl9qb2JfbG9jaywgZmxhZ3MpOwor
fQorCisKKy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqCisgKiBGdW5jdGlvbnMgZm9yIGFzeW5jaHJvbm91
c2x5IGZldGNoaW5nIGRhdGEgZnJvbSBzb3VyY2UgZGV2aWNlIGFuZCBzdG9yaW5nCisgKiBkYXRh
IGluIGNhY2hlIGRldmljZS4gQmVjYXVzZSB0aGUgcmVxdWVzdGVkIGRhdGEgbWF5IG5vdCBhbGln
biB3aXRoIHRoZQorICogY2FjaGUgYmxvY2tzLCBleHRyYSBoYW5kbGluZyBpcyByZXF1aXJlZCB0
byBwYWQgYSBibG9jayByZXF1ZXN0IGFuZCBleHRyYWN0CisgKiB0aGUgcmVxdWVzdGVkIGRhdGEg
ZnJvbSB0aGUgcmVzdWx0cy4KKyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLworCitzdGF0aWMgdm9pZCBp
b19jYWxsYmFjayh1bnNpZ25lZCBsb25nIGVycm9yLCB2b2lkICpjb250ZXh0KQoreworCXN0cnVj
dCBrY2FjaGVkX2pvYiAqam9iID0gKHN0cnVjdCBrY2FjaGVkX2pvYiAqKSBjb250ZXh0OworCXN0
cnVjdCBiaW8gKmJpbyA9IGpvYi0+YmlvLCAqY2xvbmU7CisJaW50IGk7CisKKwlpZiAoZXJyb3Ip
IHsKKwkJLyogVE9ETyAqLworCQlETUVSUigiaW9fY2FsbGJhY2s6IGlvIGVycm9yIik7CisJCXJl
dHVybjsKKwl9CisKKwlpZiAoam9iLT5ydyA9PSBSRUFEKSB7CisJCS8qIEEgUkVBRCBpcyBhY2tu
b3dsZWRnZWQgYXMgc29vbiBhcyB0aGUgcmVxdWVzdGVkIGRhdGEgaXMgZmV0Y2hlZCwgYW5kCisJ
CSAgIGRvZXMgbm90IGhhdmUgdG8gd2FpdCBmb3IgaXQgYmVpbmcgc3RvcmVkIGluIGNhY2hlLiBU
aGUgYmlvIGlzIGNsb25lZAorCQkgICBzbyB0aGF0IHRoZSBvcmlnaW5hbCBvbmUgY2FuIGJlIGVu
ZGVkIGhlcmUuIEJ1dCB0byBhdm9pZCBjb3B5aW5nCisJCSAgIHBhZ2VzLCB3ZSByZXVzZSB0aGUg
cGFnZXMgYWxsb2NhdGVkIGZvciB0aGUgb3JpZ2luYWwgYmlvLCBhbmQgbWFyaworCQkgICBlYWNo
IG9mIHRoZW0gdG8gcHJldmVudCB0aGUgcGFnZXMgYmVpbmcgZnJlZWQgYmVmb3JlIHRoZSBjYWNo
ZQorCQkgICBpbnNlcnRpb24gaXMgY29tcGxldGVkLgorCQkgKi8KKwkJaWYgKGJpb19kYXRhX2Rp
cihiaW8pID09IFJFQUQpIHsKKwkJCWNsb25lID0gYmlvX2Nsb25lKGJpbywgR0ZQX05PSU8pOwor
CQkJZm9yIChpPWJpby0+YmlfaWR4OyBpPGJpby0+YmlfdmNudDsgaSsrKSB7CisJCQkJZ2V0X3Bh
Z2UoYmlvLT5iaV9pb192ZWNbaV0uYnZfcGFnZSk7CisJCQl9CisJCQlEUFJJTlRLKCJiaW8gZW5k
ZWQgZm9yICVsbHU6JXUiLCBiaW8tPmJpX3NlY3RvciwgYmlvLT5iaV9zaXplKTsKKwkJCSAgICAg
ICAgYmlvX2VuZGlvKGJpbywgYmlvLT5iaV9zaXplLCAwKTsKKwkJCWpvYi0+YmlvID0gY2xvbmU7
CisJCX0KKwkJam9iLT5ydyA9IFdSSVRFOworCQlwdXNoKCZfaW9fam9icywgam9iKTsKKwl9IGVs
c2UKKwkJcHVzaCgmX2NvbXBsZXRlX2pvYnMsIGpvYik7CisJd2FrZSgpOworfQorCisvKgorICog
RmV0Y2ggZGF0YSBmcm9tIHRoZSBzb3VyY2UgZGV2aWNlIGFzeW5jaHJvbm91c2x5LgorICogRm9y
IGEgUkVBRCBiaW8sIGlmIGEgY2FjaGUgYmxvY2sgaXMgbGFyZ2VyIHRoYW4gdGhlIHJlcXVlc3Rl
ZCBkYXRhLCB0aGVuCisgKiBhZGRpdGlvbmFsIGRhdGEgYXJlIHByZWZldGNoZWQuIExhcmdlciBj
YWNoZSBibG9jayBzaXplIGVuYWJsZXMgbW9yZQorICogYWdncmVzc2l2ZSByZWFkIHByZWZldGNo
aW5nLCB3aGljaCBpcyB1c2VmdWwgZm9yIHJlYWQtbW9zdGx5IHVzYWdlLgorICogRm9yIGEgV1JJ
VEUgYmlvLCBpZiBhIGNhY2hlIGJsb2NrIGlzIGxhcmdlciB0aGFuIHRoZSByZXF1ZXN0ZWQgZGF0
YSwgdGhlCisgKiBlbnRpcmUgYmxvY2sgbmVlZHMgdG8gYmUgZmV0Y2hlZCwgYW5kIGxhcmdlciBi
bG9jayBzaXplIGluY3VycyBtb3JlIG92ZXJoZWFkLgorICogSW4gc2NlbmFyb3Mgd2hlcmUgd3Jp
dGVzIGFyZSBmcmVxdWVudCwgNEtCIGlzIGEgZ29vZCBjYWNoZSBibG9jayBzaXplLgorICovCitz
dGF0aWMgaW50IGRvX2ZldGNoKHN0cnVjdCBrY2FjaGVkX2pvYiAqam9iKQoreworCWludCByID0g
MCwgaSwgajsKKwlzdHJ1Y3QgYmlvICpiaW8gPSBqb2ItPmJpbzsKKwlzdHJ1Y3QgY2FjaGVfYyAq
ZG1jID0gam9iLT5kbWM7CisJdW5zaWduZWQgaW50IG9mZnNldCwgaGVhZCwgdGFpbCwgcmVtYWlu
aW5nLCBucl92ZWNzLCBpZHggPSAwOworCXN0cnVjdCBiaW9fdmVjICpidmVjOworCXN0cnVjdCBw
YWdlX2xpc3QgKnBsOworCisJb2Zmc2V0ID0gKHVuc2lnbmVkIGludCkgKGJpby0+Ymlfc2VjdG9y
ICYgZG1jLT5ibG9ja19tYXNrKTsKKwloZWFkID0gdG9fYnl0ZXMob2Zmc2V0KTsKKwl0YWlsID0g
dG9fYnl0ZXMoZG1jLT5ibG9ja19zaXplKSAtIGJpby0+Ymlfc2l6ZSAtIGhlYWQ7CisKKwlEUFJJ
TlRLKCJkb19mZXRjaDogJWxsdSglbGx1LT4lbGx1LCVsbHUpLCBoZWFkOiV1LHRhaWw6JXUiLAor
CQkgICAgYmlvLT5iaV9zZWN0b3IsIGpvYi0+c3JjLnNlY3Rvciwgam9iLT5kZXN0LnNlY3RvciwK
KwkgICAgICAgIGpvYi0+c3JjLmNvdW50LCBoZWFkLCB0YWlsKTsKKworCWlmIChiaW9fZGF0YV9k
aXIoYmlvKSA9PSBSRUFEKSB7IC8qIFRoZSBvcmlnaW5hbCByZXF1ZXN0IGlzIGEgUkVBRCAqLwor
CQlpZiAoMCA9PSBqb2ItPm5yX3BhZ2VzKSB7IC8qIFRoZSByZXF1ZXN0IGlzIGFsaWduZWQgdG8g
Y2FjaGUgYmxvY2sgKi8KKwkJCXIgPSBkbV9pb19hc3luY19idmVjKDEsICZqb2ItPnNyYywgUkVB
RCwKKwkJCSAgICAgICAgICAgICAgICAgICAgIGJpby0+YmlfaW9fdmVjICsgYmlvLT5iaV9pZHgs
CisJCQkgICAgICAgICAgICAgICAgICAgICBpb19jYWxsYmFjaywgam9iKTsKKwkJCXJldHVybiBy
OworCQl9CisKKwkJbnJfdmVjcyA9IGJpby0+YmlfdmNudCAtIGJpby0+YmlfaWR4ICsgam9iLT5u
cl9wYWdlczsKKwkJYnZlYyA9IGttYWxsb2MobnJfdmVjcyAqIHNpemVvZigqYnZlYyksIEdGUF9O
T0lPKTsKKwkJaWYgKCFidmVjKSB7CisJCQlETUVSUigiZG9fZmV0Y2g6IE5vIG1lbW9yeSIpOwor
CQkJcmV0dXJuIDE7CisJCX0KKworCQlwbCA9IGpvYi0+cGFnZXM7CisJCWkgPSAwOworCQl3aGls
ZSAoaGVhZCkgeworCQkJYnZlY1tpXS5idl9sZW4gPSBtaW4oaGVhZCwgKHVuc2lnbmVkIGludClQ
QUdFX1NJWkUpOworCQkJYnZlY1tpXS5idl9vZmZzZXQgPSAwOworCQkJYnZlY1tpXS5idl9wYWdl
ID0gcGwtPnBhZ2U7CisJCQloZWFkIC09IGJ2ZWNbaV0uYnZfbGVuOworCQkJcGwgPSBwbC0+bmV4
dDsKKwkJCWkrKzsKKwkJfQorCisJCXJlbWFpbmluZyA9IGJpby0+Ymlfc2l6ZTsKKwkJaiA9IGJp
by0+YmlfaWR4OworCQl3aGlsZSAocmVtYWluaW5nKSB7CisJCQlidmVjW2ldID0gYmlvLT5iaV9p
b192ZWNbal07CisJCQlyZW1haW5pbmcgLT0gYnZlY1tpXS5idl9sZW47CisJCQlpKys7IGorKzsK
KwkJfQorCisJCXdoaWxlICh0YWlsKSB7CisJCQlidmVjW2ldLmJ2X2xlbiA9IG1pbih0YWlsLCAo
dW5zaWduZWQgaW50KVBBR0VfU0laRSk7CisJCQlidmVjW2ldLmJ2X29mZnNldCA9IDA7CisJCQli
dmVjW2ldLmJ2X3BhZ2UgPSBwbC0+cGFnZTsKKwkJCXRhaWwgLT0gYnZlY1tpXS5idl9sZW47CisJ
CQlwbCA9IHBsLT5uZXh0OworCQkJaSsrOworCQl9CisKKwkJam9iLT5idmVjID0gYnZlYzsKKwkJ
ciA9IGRtX2lvX2FzeW5jX2J2ZWMoMSwgJmpvYi0+c3JjLCBSRUFELCBqb2ItPmJ2ZWMsIGlvX2Nh
bGxiYWNrLCBqb2IpOworCQlyZXR1cm4gcjsKKwl9IGVsc2UgeyAvKiBUaGUgb3JpZ2luYWwgcmVx
dWVzdCBpcyBhIFdSSVRFICovCisJCXBsID0gam9iLT5wYWdlczsKKworCQlpZiAoaGVhZCAmJiB0
YWlsKSB7IC8qIFNwZWNpYWwgY2FzZSAqLworCQkJYnZlYyA9IGttYWxsb2Moam9iLT5ucl9wYWdl
cyAqIHNpemVvZigqYnZlYyksIEdGUF9LRVJORUwpOworCQkJaWYgKCFidmVjKSB7CisJCQkJRE1F
UlIoImRvX2ZldGNoOiBObyBtZW1vcnkiKTsKKwkJCQlyZXR1cm4gMTsKKwkJCX0KKwkJCWZvciAo
aT0wOyBpPGpvYi0+bnJfcGFnZXM7IGkrKykgeworCQkJCWJ2ZWNbaV0uYnZfbGVuID0gUEFHRV9T
SVpFOworCQkJCWJ2ZWNbaV0uYnZfb2Zmc2V0ID0gMDsKKwkJCQlidmVjW2ldLmJ2X3BhZ2UgPSBw
bC0+cGFnZTsKKwkJCQlwbCA9IHBsLT5uZXh0OworCQkJfQorCQkJam9iLT5idmVjID0gYnZlYzsK
KwkJCXIgPSBkbV9pb19hc3luY19idmVjKDEsICZqb2ItPnNyYywgUkVBRCwgam9iLT5idmVjLAor
CQkJICAgICAgICAgICAgICAgICAgICAgaW9fY2FsbGJhY2ssIGpvYik7CisJCQlyZXR1cm4gcjsK
KwkJfQorCisJCWJ2ZWMgPSBrbWFsbG9jKChqb2ItPm5yX3BhZ2VzICsgYmlvLT5iaV92Y250IC0g
YmlvLT5iaV9pZHgpCisJCQkJKiBzaXplb2YoKmJ2ZWMpLCBHRlBfS0VSTkVMKTsKKwkJaWYgKCFi
dmVjKSB7CisJCQlETUVSUigiZG9fZmV0Y2g6IE5vIG1lbW9yeSIpOworCQkJcmV0dXJuIDE7CisJ
CX0KKworCQlpID0gMDsKKwkJd2hpbGUgKGhlYWQpIHsKKwkJCWJ2ZWNbaV0uYnZfbGVuID0gbWlu
KGhlYWQsICh1bnNpZ25lZCBpbnQpUEFHRV9TSVpFKTsKKwkJCWJ2ZWNbaV0uYnZfb2Zmc2V0ID0g
MDsKKwkJCWJ2ZWNbaV0uYnZfcGFnZSA9IHBsLT5wYWdlOworCQkJaGVhZCAtPSBidmVjW2ldLmJ2
X2xlbjsKKwkJCXBsID0gcGwtPm5leHQ7CisJCQlpKys7CisJCX0KKworCQlyZW1haW5pbmcgPSBi
aW8tPmJpX3NpemU7CisJCWogPSBiaW8tPmJpX2lkeDsKKwkJd2hpbGUgKHJlbWFpbmluZykgewor
CQkJYnZlY1tpXSA9IGJpby0+YmlfaW9fdmVjW2pdOworCQkJcmVtYWluaW5nIC09IGJ2ZWNbaV0u
YnZfbGVuOworCQkJaSsrOyBqKys7CisJCX0KKworCQlpZiAodGFpbCkgeworCQkJaWR4ID0gaTsK
KwkJCWJ2ZWNbaV0uYnZfb2Zmc2V0ID0gKHRvX2J5dGVzKG9mZnNldCkgKyBiaW8tPmJpX3NpemUp
ICYKKwkJCSAgICAgICAgICAgICAgICAgICAgKFBBR0VfU0laRSAtIDEpOworCQkJYnZlY1tpXS5i
dl9sZW4gPSBQQUdFX1NJWkUgLSBidmVjW2ldLmJ2X29mZnNldDsKKwkJCWJ2ZWNbaV0uYnZfcGFn
ZSA9IHBsLT5wYWdlOworCQkJdGFpbCAtPSBidmVjW2ldLmJ2X2xlbjsKKwkJCXBsID0gcGwtPm5l
eHQ7IGkrKzsKKwkJCXdoaWxlICh0YWlsKSB7CisJCQkJYnZlY1tpXS5idl9sZW4gPSBQQUdFX1NJ
WkU7CisJCQkJYnZlY1tpXS5idl9vZmZzZXQgPSAwOworCQkJCWJ2ZWNbaV0uYnZfcGFnZSA9IHBs
LT5wYWdlOworCQkJCXRhaWwgLT0gYnZlY1tpXS5idl9sZW47CisJCQkJcGwgPSBwbC0+bmV4dDsg
aSsrOworCQkJfQorCQl9CisKKwkJam9iLT5idmVjID0gYnZlYzsKKwkJciA9IGRtX2lvX2FzeW5j
X2J2ZWMoMSwgJmpvYi0+c3JjLCBSRUFELCBqb2ItPmJ2ZWMgKyBpZHgsCisJCSAgICAgICAgICAg
ICAgICAgICAgIGlvX2NhbGxiYWNrLCBqb2IpOworCisJCXJldHVybiByOworCX0KK30KKworLyoK
KyAqIFN0b3JlIGRhdGEgdG8gdGhlIGNhY2hlIHNvdXJjZSBkZXZpY2UgYXN5bmNocm9ub3VzbHku
CisgKiBGb3IgYSBSRUFEIGJpbyByZXF1ZXN0LCB0aGUgZGF0YSBmZXRjaGVkIGZyb20gdGhlIHNv
dXJjZSBkZXZpY2UgYXJlIHJldHVybmVkCisgKiB0byBrZXJuZWwgYW5kIHN0b3JlZCBpbiBjYWNo
ZSBhdCB0aGUgc2FtZSB0aW1lLgorICogRm9yIGEgV1JJVEUgYmlvIHJlcXVlc3QsIHRoZSBkYXRh
IGFyZSB3cml0dGVuIHRvIHRoZSBjYWNoZSBhbmQgc291cmNlIGRldmljZQorICogYXQgdGhlIHNh
bWUgdGltZS4KKyAqLworc3RhdGljIGludCBkb19zdG9yZShzdHJ1Y3Qga2NhY2hlZF9qb2IgKmpv
YikKK3sKKwlpbnQgaSwgaiwgciA9IDA7CisJc3RydWN0IGJpbyAqYmlvID0gam9iLT5iaW87CisJ
c3RydWN0IGNhY2hlX2MgKmRtYyA9IGpvYi0+ZG1jOworCXVuc2lnbmVkIGludCBvZmZzZXQsIGhl
YWQsIHRhaWwsIHJlbWFpbmluZywgbnJfdmVjczsKKwlzdHJ1Y3QgYmlvX3ZlYyAqYnZlYzsKKwor
CW9mZnNldCA9ICh1bnNpZ25lZCBpbnQpIChiaW8tPmJpX3NlY3RvciAmIGRtYy0+YmxvY2tfbWFz
ayk7CisJaGVhZCA9IHRvX2J5dGVzKG9mZnNldCk7CisJdGFpbCA9IHRvX2J5dGVzKGRtYy0+Ymxv
Y2tfc2l6ZSkgLSBiaW8tPmJpX3NpemUgLSBoZWFkOworCisJRFBSSU5USygiZG9fc3RvcmU6ICVs
bHUoJWxsdS0+JWxsdSwlbGx1KSwgaGVhZDoldSx0YWlsOiV1IiwKKwkgICAgICAgIGJpby0+Ymlf
c2VjdG9yLCBqb2ItPnNyYy5zZWN0b3IsIGpvYi0+ZGVzdC5zZWN0b3IsCisJICAgICAgICBqb2It
PnNyYy5jb3VudCwgaGVhZCwgdGFpbCk7CisKKwlpZiAoMCA9PSBqb2ItPm5yX3BhZ2VzKSAvKiBP
cmlnaW5hbCByZXF1ZXN0IGlzIGFsaWduZWQgd2l0aCBjYWNoZSBibG9ja3MgKi8KKwkJciA9IGRt
X2lvX2FzeW5jX2J2ZWMoMSwgJmpvYi0+ZGVzdCwgV1JJVEUsIGJpby0+YmlfaW9fdmVjICsgYmlv
LT5iaV9pZHgsCisJCSAgICAgICAgICAgICAgICAgICAgIGlvX2NhbGxiYWNrLCBqb2IpOworCWVs
c2UgeworCQlpZiAoYmlvX2RhdGFfZGlyKGJpbykgPT0gV1JJVEUgJiYgaGVhZCA+IDAgJiYgdGFp
bCA+IDApIHsKKwkJCURQUklOVEsoIlNwZWNpYWwgY2FzZTogJWx1ICV1ICV1IiwgYmlvX2RhdGFf
ZGlyKGJpbyksIGhlYWQsIHRhaWwpOworCQkJbnJfdmVjcyA9IGpvYi0+bnJfcGFnZXMgKyBiaW8t
PmJpX3ZjbnQgLSBiaW8tPmJpX2lkeDsKKwkJCWlmIChvZmZzZXQgJiYgKG9mZnNldCArIGJpby0+
Ymlfc2l6ZSA8IFBBR0VfU0laRSkpIG5yX3ZlY3MrKzsKKwkJCURQUklOVEsoIkNyZWF0ZSAldSBu
ZXcgdmVjcyIsIG5yX3ZlY3MpOworCQkJYnZlYyA9IGttYWxsb2MobnJfdmVjcyAqIHNpemVvZigq
YnZlYyksIEdGUF9LRVJORUwpOworCQkJaWYgKCFidmVjKSB7CisJCQkJRE1FUlIoImRvX3N0b3Jl
OiBObyBtZW1vcnkiKTsKKwkJCQlyZXR1cm4gMTsKKwkJCX0KKworCQkJaSA9IDA7CisJCQl3aGls
ZSAoaGVhZCkgeworCQkJCWJ2ZWNbaV0uYnZfbGVuID0gbWluKGhlYWQsIGpvYi0+YnZlY1tpXS5i
dl9sZW4pOworCQkJCWJ2ZWNbaV0uYnZfb2Zmc2V0ID0gMDsKKwkJCQlidmVjW2ldLmJ2X3BhZ2Ug
PSBqb2ItPmJ2ZWNbaV0uYnZfcGFnZTsKKwkJCQloZWFkIC09IGJ2ZWNbaV0uYnZfbGVuOworCQkJ
CWkrKzsKKwkJCX0KKwkJCXJlbWFpbmluZyA9IGJpby0+Ymlfc2l6ZTsKKwkJCWogPSBiaW8tPmJp
X2lkeDsKKwkJCXdoaWxlIChyZW1haW5pbmcpIHsKKwkJCQlidmVjW2ldID0gYmlvLT5iaV9pb192
ZWNbal07CisJCQkJcmVtYWluaW5nIC09IGJ2ZWNbaV0uYnZfbGVuOworCQkJCWkrKzsgaisrOwor
CQkJfQorCQkJaiA9ICh0b19ieXRlcyhvZmZzZXQpICsgYmlvLT5iaV9zaXplKSAvIFBBR0VfU0la
RTsKKwkJCWJ2ZWNbaV0uYnZfb2Zmc2V0ID0gKHRvX2J5dGVzKG9mZnNldCkgKyBiaW8tPmJpX3Np
emUpIC0KKwkJCSAgICAgICAgICAgICAgICAgICAgaiAqIFBBR0VfU0laRTsKKwkJCWJ2ZWNbaV0u
YnZfbGVuID0gUEFHRV9TSVpFIC0gYnZlY1tpXS5idl9vZmZzZXQ7CisJCQlidmVjW2ldLmJ2X3Bh
Z2UgPSBqb2ItPmJ2ZWNbal0uYnZfcGFnZTsKKwkJCXRhaWwgLT0gYnZlY1tpXS5idl9sZW47CisJ
CQlpKys7IGorKzsKKwkJCXdoaWxlICh0YWlsKSB7CisJCQkJYnZlY1tpXSA9IGpvYi0+YnZlY1tq
XTsKKwkJCQl0YWlsIC09IGJ2ZWNbaV0uYnZfbGVuOworCQkJCWkrKzsgaisrOworCQkJfQorCQkJ
a2ZyZWUoam9iLT5idmVjKTsKKwkJCWpvYi0+YnZlYyA9IGJ2ZWM7CisJCX0KKworCQlyID0gZG1f
aW9fYXN5bmNfYnZlYygxLCAmam9iLT5kZXN0LCBXUklURSwgam9iLT5idmVjLCBpb19jYWxsYmFj
aywgam9iKTsKKwl9CisKKwlyZXR1cm4gcjsKK30KKworc3RhdGljIGludCBkb19pbyhzdHJ1Y3Qg
a2NhY2hlZF9qb2IgKmpvYikKK3sKKwlpbnQgciA9IDA7CisKKwlpZiAoam9iLT5ydyA9PSBSRUFE
KSB7IC8qIFJlYWQgZnJvbSBzb3VyY2UgZGV2aWNlICovCisJCXIgPSBkb19mZXRjaChqb2IpOwor
CX0gZWxzZSB7IC8qIFdyaXRlIHRvIGNhY2hlIGRldmljZSAqLworCQlyID0gZG9fc3RvcmUoam9i
KTsKKwl9CisKKwlyZXR1cm4gcjsKK30KKworc3RhdGljIGludCBkb19wYWdlcyhzdHJ1Y3Qga2Nh
Y2hlZF9qb2IgKmpvYikKK3sKKwlpbnQgciA9IDA7CisKKwlEUFJJTlRLKCJkb19wYWdlczogJXUi
LCBqb2ItPm5yX3BhZ2VzKTsKKwlyID0ga2NhY2hlZF9nZXRfcGFnZXMoam9iLT5kbWMsIGpvYi0+
bnJfcGFnZXMsICZqb2ItPnBhZ2VzKTsKKworCWlmIChyID09IC1FTk9NRU0pIC8qIGNhbid0IGNv
bXBsZXRlIG5vdyAqLworCQlyZXR1cm4gMTsKKworCS8qIHRoaXMgam9iIGlzIHJlYWR5IGZvciBp
byAqLworCXB1c2goJl9pb19qb2JzLCBqb2IpOworCXJldHVybiAwOworfQorCisvKgorICogRmx1
c2ggdGhlIGJpb3MgdGhhdCBhcmUgd2FpdGluZyBmb3IgdGhpcyBjYWNoZSBpbnNlcnRpb24gb3Ig
d3JpdGUgYmFjay4KKyAqLworc3RhdGljIHZvaWQgZmx1c2hfYmlvcyhzdHJ1Y3QgY2FjaGVibG9j
ayAqY2FjaGVibG9jaykKK3sKKwlzdHJ1Y3QgYmlvICpiaW87CisJc3RydWN0IGJpbyAqbjsKKwor
CXNwaW5fbG9jaygmY2FjaGVibG9jay0+bG9jayk7CisJYmlvID0gYmlvX2xpc3RfZ2V0KCZjYWNo
ZWJsb2NrLT5iaW9zKTsKKwlpZiAoaXNfc3RhdGUoY2FjaGVibG9jay0+c3RhdGUsIFdSSVRFQkFD
SykpIHsgLyogV3JpdGUgYmFjayBmaW5pc2hlZCAqLworCQljYWNoZWJsb2NrLT5zdGF0ZSA9IElO
VkFMSUQ7CisJfSBlbHNlIHsgLyogQ2FjaGUgaW5zZXJ0aW9uIGZpbmlzaGVkICovCisJCXNldF9z
dGF0ZShjYWNoZWJsb2NrLT5zdGF0ZSwgVkFMSUQpOworCQljbGVhcl9zdGF0ZShjYWNoZWJsb2Nr
LT5zdGF0ZSwgUkVTRVJWRUQpOworCX0KKwlzcGluX3VubG9jaygmY2FjaGVibG9jay0+bG9jayk7
CisKKwl3aGlsZSAoYmlvKSB7CisJCW4gPSBiaW8tPmJpX25leHQ7CisJCWJpby0+YmlfbmV4dCA9
IE5VTEw7CisJCURQUklOVEsoIkZsdXNoIGJpbzogJWxsdS0+JWxsdSAoJXUgYnl0ZXMpIiwKKwkJ
ICAgICAgICBjYWNoZWJsb2NrLT5ibG9jaywgYmlvLT5iaV9zZWN0b3IsIGJpby0+Ymlfc2l6ZSk7
CisJCWdlbmVyaWNfbWFrZV9yZXF1ZXN0KGJpbyk7CisJCWJpbyA9IG47CisJfQorfQorCitzdGF0
aWMgaW50IGRvX2NvbXBsZXRlKHN0cnVjdCBrY2FjaGVkX2pvYiAqam9iKQoreworCWludCBpLCBy
ID0gMDsKKwlzdHJ1Y3QgYmlvICpiaW8gPSBqb2ItPmJpbzsKKworCURQUklOVEsoImRvX2NvbXBs
ZXRlOiAlbGx1IiwgYmlvLT5iaV9zZWN0b3IpOworCisJaWYgKGJpb19kYXRhX2RpcihiaW8pID09
IFJFQUQpIHsKKwkJZm9yIChpPWJpby0+YmlfaWR4OyBpPGJpby0+YmlfdmNudDsgaSsrKSB7CisJ
CQlwdXRfcGFnZShiaW8tPmJpX2lvX3ZlY1tpXS5idl9wYWdlKTsKKwkJfQorCQliaW9fcHV0KGJp
byk7CisJfSBlbHNlCisJCWJpb19lbmRpbyhiaW8sIGJpby0+Ymlfc2l6ZSwgMCk7CisKKwlpZiAo
am9iLT5ucl9wYWdlcyA+IDApIHsKKwkJa2ZyZWUoam9iLT5idmVjKTsKKwkJa2NhY2hlZF9wdXRf
cGFnZXMoam9iLT5kbWMsIGpvYi0+cGFnZXMpOworCX0KKworCWZsdXNoX2Jpb3Moam9iLT5jYWNo
ZWJsb2NrKTsKKwltZW1wb29sX2ZyZWUoam9iLCBfam9iX3Bvb2wpOworCisJaWYgKGF0b21pY19k
ZWNfYW5kX3Rlc3QoJmpvYi0+ZG1jLT5ucl9qb2JzKSkKKwkJd2FrZV91cCgmam9iLT5kbWMtPmRl
c3Ryb3lxKTsKKworCXJldHVybiByOworfQorCisvKgorICogUnVuIHRocm91Z2ggYSBsaXN0IGZv
ciBhcyBsb25nIGFzIHBvc3NpYmxlLiAgUmV0dXJucyB0aGUgY291bnQKKyAqIG9mIHN1Y2Nlc3Nm
dWwgam9icy4KKyAqLworc3RhdGljIGludCBwcm9jZXNzX2pvYnMoc3RydWN0IGxpc3RfaGVhZCAq
am9icywKKwkgICAgICAgICAgICAgICAgICAgIGludCAoKmZuKSAoc3RydWN0IGtjYWNoZWRfam9i
ICopKQoreworCXN0cnVjdCBrY2FjaGVkX2pvYiAqam9iOworCWludCByLCBjb3VudCA9IDA7CisK
Kwl3aGlsZSAoKGpvYiA9IHBvcChqb2JzKSkpIHsKKwkJciA9IGZuKGpvYik7CisKKwkJaWYgKHIg
PCAwKSB7CisJCQkvKiBlcnJvciB0aGlzIHJvZ3VlIGpvYiAqLworCQkJRE1FUlIoInByb2Nlc3Nf
am9iczogSm9iIHByb2Nlc3NpbmcgZXJyb3IiKTsKKwkJfQorCisJCWlmIChyID4gMCkgeworCQkJ
LyoKKwkJCSAqIFdlIGNvdWxkbid0IHNlcnZpY2UgdGhpcyBqb2IgQVRNLCBzbworCQkJICogcHVz
aCB0aGlzIGpvYiBiYWNrIG9udG8gdGhlIGxpc3QuCisJCQkgKi8KKwkJCXB1c2goam9icywgam9i
KTsKKwkJCWJyZWFrOworCQl9CisKKwkJY291bnQrKzsKKwl9CisKKwlyZXR1cm4gY291bnQ7Cit9
CisKK3N0YXRpYyB2b2lkIGRvX3dvcmsodm9pZCAqaWdub3JlZCkKK3sKKwlwcm9jZXNzX2pvYnMo
Jl9jb21wbGV0ZV9qb2JzLCBkb19jb21wbGV0ZSk7CisJcHJvY2Vzc19qb2JzKCZfcGFnZXNfam9i
cywgZG9fcGFnZXMpOworCXByb2Nlc3Nfam9icygmX2lvX2pvYnMsIGRvX2lvKTsKK30KKworc3Rh
dGljIHZvaWQgcXVldWVfam9iKHN0cnVjdCBrY2FjaGVkX2pvYiAqam9iKQoreworCWF0b21pY19p
bmMoJmpvYi0+ZG1jLT5ucl9qb2JzKTsKKwlpZiAoam9iLT5ucl9wYWdlcyA+IDApIC8qIFJlcXVl
c3QgcGFnZXMgKi8KKwkJcHVzaCgmX3BhZ2VzX2pvYnMsIGpvYik7CisJZWxzZSAvKiBHbyBhaGVh
ZCB0byBkbyBJL08gKi8KKwkJcHVzaCgmX2lvX2pvYnMsIGpvYik7CisJd2FrZSgpOworfQorCitz
dGF0aWMgaW50IGtjYWNoZWRfaW5pdChzdHJ1Y3QgY2FjaGVfYyAqZG1jKQoreworCWludCByOwor
CisJc3Bpbl9sb2NrX2luaXQoJmRtYy0+bG9jayk7CisJZG1jLT5wYWdlcyA9IE5VTEw7CisJZG1j
LT5ucl9wYWdlcyA9IGRtYy0+bnJfZnJlZV9wYWdlcyA9IDA7CisJciA9IGFsbG9jX2Jpb19wYWdl
cyhkbWMsIERNQ0FDSEVfQ09QWV9QQUdFUyk7CisJaWYgKHIpIHsKKwkJRE1FUlIoImtjYWNoZWRf
aW5pdDogQ291bGQgbm90IGFsbG9jYXRlIGJpbyBwYWdlcyIpOworCQlyZXR1cm4gcjsKKwl9CisK
KwlyID0gZG1faW9fZ2V0KERNQ0FDSEVfQ09QWV9QQUdFUyk7CisJaWYgKHIpIHsKKwkJRE1FUlIo
ImtjYWNoZWRfaW5pdDogQ291bGQgbm90IHJlc2l6ZSBkbSBpbyBwb29sIik7CisJCWZyZWVfYmlv
X3BhZ2VzKGRtYyk7CisJCXJldHVybiByOworCX0KKworCWluaXRfd2FpdHF1ZXVlX2hlYWQoJmRt
Yy0+ZGVzdHJveXEpOworCWF0b21pY19zZXQoJmRtYy0+bnJfam9icywgMCk7CisKKwlyZXR1cm4g
MDsKK30KKwordm9pZCBrY2FjaGVkX2NsaWVudF9kZXN0cm95KHN0cnVjdCBjYWNoZV9jICpkbWMp
Cit7CisJLyogV2FpdCBmb3IgY29tcGxldGlvbiBvZiBhbGwgam9icyBzdWJtaXR0ZWQgYnkgdGhp
cyBjbGllbnQuICovCisJd2FpdF9ldmVudChkbWMtPmRlc3Ryb3lxLCAhYXRvbWljX3JlYWQoJmRt
Yy0+bnJfam9icykpOworCisJZG1faW9fcHV0KGRtYy0+bnJfcGFnZXMpOworCWZyZWVfYmlvX3Bh
Z2VzKGRtYyk7Cit9CisKKworLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKKyAqIEZ1bmN0aW9ucyBmb3Ig
d3JpdGluZyBiYWNrIGRpcnR5IGJsb2Nrcy4KKyAqIFdlIGxldmVyYWdlIGtjb3B5ZCB0byB3cml0
ZSBiYWNrIGRpcnR5IGJsb2NrcyBiZWNhdXNlIGl0IGlzIGNvbnZlbmllbnQgdG8KKyAqIHVzZSBh
bmQgaXQgaXMgbm90IHJlYXNvbmJsZSB0byByZWltcGxlbWVudCB0aGUgc2FtZSBmdW5jdGlvbiBo
ZXJlLiBCdXQgd2UKKyAqIG5lZWQgdG8gcmVzZXJ2ZSBwYWdlcyBmb3IgYm90aCBrY2FjaGVkIGFu
ZCBrY29weWQuIFRPRE86IGR5bmFtaWNhbGx5IGNoYW5nZQorICogdGhlIG51bWJlciBvZiByZXNl
cnZlZCBwYWdlcy4KKyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLworCitzdGF0aWMgdm9pZCBjb3B5X2Nh
bGxiYWNrKGludCByZWFkX2VyciwgdW5zaWduZWQgaW50IHdyaXRlX2Vyciwgdm9pZCAqY29udGV4
dCkKK3sKKwlzdHJ1Y3QgY2FjaGVibG9jayAqY2FjaGVibG9jayA9IChzdHJ1Y3QgY2FjaGVibG9j
ayAqKSBjb250ZXh0OworCisJZmx1c2hfYmlvcyhjYWNoZWJsb2NrKTsKK30KKworc3RhdGljIHZv
aWQgY29weV9ibG9jayhzdHJ1Y3QgY2FjaGVfYyAqZG1jLCBzdHJ1Y3QgaW9fcmVnaW9uIHNyYywK
KwkgICAgICAgICAgICAgICAgICAgc3RydWN0IGlvX3JlZ2lvbiBkZXN0LCBzdHJ1Y3QgY2FjaGVi
bG9jayAqY2FjaGVibG9jaykKK3sKKwlEUFJJTlRLKCJDb3B5aW5nOiAlbGx1OiVsbHUtPiVsbHU6
JWxsdSIsCisJCQlzcmMuc2VjdG9yLCBzcmMuY291bnQgKiA1MTIsIGRlc3Quc2VjdG9yLCBkZXN0
LmNvdW50ICogNTEyKTsKKwlrY29weWRfY29weShkbWMtPmtjcF9jbGllbnQsICZzcmMsIDEsICZk
ZXN0LCAwLCBjb3B5X2NhbGxiYWNrLCBjYWNoZWJsb2NrKTsKK30KKworc3RhdGljIHZvaWQgd3Jp
dGVfYmFjayhzdHJ1Y3QgY2FjaGVfYyAqZG1jLCBzZWN0b3JfdCBpbmRleCwgdW5zaWduZWQgaW50
IGxlbmd0aCkKK3sKKwlzdHJ1Y3QgaW9fcmVnaW9uIHNyYywgZGVzdDsKKwlzdHJ1Y3QgY2FjaGVi
bG9jayAqY2FjaGVibG9jayA9ICZkbWMtPmNhY2hlW2luZGV4XTsKKwl1bnNpZ25lZCBpbnQgaTsK
KworCURQUklOVEsoIldyaXRlIGJhY2sgYmxvY2sgJWxsdSglbGx1LCAldSkiLAorCSAgICAgICAg
aW5kZXgsIGNhY2hlYmxvY2stPmJsb2NrLCBsZW5ndGgpOworCXNyYy5iZGV2ID0gZG1jLT5jYWNo
ZV9kZXYtPmJkZXY7CisJc3JjLnNlY3RvciA9IGluZGV4IDw8IGRtYy0+YmxvY2tfc2hpZnQ7CisJ
c3JjLmNvdW50ID0gZG1jLT5ibG9ja19zaXplICogbGVuZ3RoOworCWRlc3QuYmRldiA9IGRtYy0+
c3JjX2Rldi0+YmRldjsKKwlkZXN0LnNlY3RvciA9IGNhY2hlYmxvY2stPmJsb2NrOworCWRlc3Qu
Y291bnQgPSBkbWMtPmJsb2NrX3NpemUgKiBsZW5ndGg7CisKKwlmb3IgKGk9MDsgaTxsZW5ndGg7
IGkrKykKKwkJc2V0X3N0YXRlKGRtYy0+Y2FjaGVbaW5kZXgraV0uc3RhdGUsIFdSSVRFQkFDSyk7
CisJZG1jLT5kaXJ0eV9ibG9ja3MgLT0gbGVuZ3RoOworCWNvcHlfYmxvY2soZG1jLCBzcmMsIGRl
c3QsIGNhY2hlYmxvY2spOworfQorCisKKy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCisgKiAgRnVuY3Rp
b25zIGZvciBpbXBsZW1lbnRpbmcgdGhlIHZhcmlvdXMgY2FjaGUgb3BlcmF0aW9ucy4KKyAqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqLworCisvKgorICogTWFwIGEgYmxvY2sgZnJvbSB0aGUgc291cmNlIGRl
dmljZSB0byBhIGJsb2NrIGluIHRoZSBjYWNoZSBkZXZpY2UuCisgKi8KK3N0YXRpYyB1bnNpZ25l
ZCBsb25nIGhhc2hfYmxvY2soc3RydWN0IGNhY2hlX2MgKmRtYywgc2VjdG9yX3QgYmxvY2spCit7
CisJdW5zaWduZWQgbG9uZyBzZXRfbnVtYmVyLCB2YWx1ZTsKKworCXZhbHVlID0gKHVuc2lnbmVk
IGxvbmcpKGJsb2NrID4+IChkbWMtPmJsb2NrX3NoaWZ0ICsKKwkgICAgICAgIGRtYy0+Y29uc2Vj
dXRpdmVfc2hpZnQpKTsKKwlpZiAoREVGQVVMVF9IQVNIRlVOQyA9PSBIQVNIKQorCQlzZXRfbnVt
YmVyID0gaGFzaF9sb25nKHZhbHVlLCBkbWMtPmJpdHMpIC8gZG1jLT5hc3NvYzsKKwllbHNlIGlm
KERFRkFVTFRfSEFTSEZVTkMgPT0gVU5JRk9STSkKKwkJc2V0X251bWJlciA9IHZhbHVlICYgKCh1
bnNpZ25lZCBsb25nKShkbWMtPnNpemUgPj4KKwkgICAgICAgICAgICAgICAgIGRtYy0+Y29uc2Vj
dXRpdmVfc2hpZnQpIC0gMSk7CisKKwlEUFJJTlRLKCJIYXNoOiAlbGx1KCVsdSktPiVsdSIsIGJs
b2NrLCB2YWx1ZSwgc2V0X251bWJlcik7CisgCXJldHVybiBzZXRfbnVtYmVyOworfQorCisvKgor
ICogUmVzZXQgdGhlIExSVSBjb3VudGVycyAodGhlIGNhY2hlJ3MgZ2xvYmFsIGNvdW50ZXIgYW5k
IGVhY2ggY2FjaGUgYmxvY2sncworICogY291bnRlcikuIFRoaXMgc2VlbXMgdG8gYmUgYSBuYWl2
ZSBpbXBsZW1lbnRhaW9uLiBIb3dldmVyLCBjb25zaWRlciB0aGUKKyAqIHJhcmVuZXNzIG9mIHRo
aXMgZXZlbnQsIGl0IG1pZ2h0IGJlIG1vcmUgZWZmaWNpZW50IHRoYXQgb3RoZXIgbW9yZSBjb21w
bGV4CisgKiBzY2hlbWVzLiBUT0RPOiBhIG1vcmUgZWxlZ2FudCBzb2x1dGlvbi4KKyAqLworc3Rh
dGljIHZvaWQgY2FjaGVfcmVzZXRfY291bnRlcihzdHJ1Y3QgY2FjaGVfYyAqZG1jKQoreworCXNl
Y3Rvcl90IGk7CisJc3RydWN0IGNhY2hlYmxvY2sgKmNhY2hlID0gZG1jLT5jYWNoZTsKKworCURQ
UklOVEsoIlJlc2V0IExSVSBjb3VudGVycyIpOworCWZvciAoaT0wOyBpPGRtYy0+c2l6ZTsgaSsr
KQorCQljYWNoZVtpXS5jb3VudGVyID0gMDsKKworCWRtYy0+Y291bnRlciA9IDA7Cit9CisKKy8q
CisgKiBMb29rdXAgYSBibG9jayBpbiB0aGUgY2FjaGUuCisgKgorICogUmV0dXJuIHZhbHVlOgor
ICogIDE6IGNhY2hlIGhpdCAoY2FjaGVfYmxvY2sgc3RvcmVzIHRoZSBpbmRleCBvZiB0aGUgbWF0
Y2hlZCBibG9jaykKKyAqICAwOiBjYWNoZSBtaXNzIGJ1dCBmcmFtZSBpcyBhbGxvY2F0ZWQgZm9y
IGluc2VydGlvbjsgY2FjaGVfYmxvY2sgc3RvcmVzIHRoZQorICogICAgIGZyYW1lJ3MgaW5kZXg6
CisgKiAgICAgIElmIHRoZXJlIGFyZSBlbXB0eSBmcmFtZXMsIHRoZW4gdGhlIGZpcnN0IGVuY291
bnRlZCBpcyB1c2VkLgorICogICAgICBJZiB0aGVyZSBhcmUgY2xlYW4gZnJhbWVzLCB0aGVuIHRo
ZSBMUlUgY2xlYW4gYmxvY2sgaXMgcmVwbGFjZWQuCisgKiAgMjogY2FjaGUgbWlzcyBhbmQgZnJh
bWUgaXMgbm90IGFsbG9jYXRlZDsgY2FjaGVfYmxvY2sgc3RvcmVzIHRoZSBMUlUgZGlydHkKKyAq
ICAgICBibG9jaydzIGluZGV4OgorICogICAgICBUaGlzIGhhcHBlbnMgd2hlbiB0aGUgZW50aXJl
IHNldCBpcyBkaXJ0eS4KKyAqIC0xOiBjYWNoZSBtaXNzIGFuZCBubyByb29tIGZvciBpbnNlcnRp
b246CisgKiAgICAgIFRoaXMgaGFwcGVucyB3aGVuIHRoZSBlbnRpcmUgc2V0IGluIHRyYW5zaXRp
b24gbW9kZXMgKFJFU0VSVkVEIG9yCisgKiAgICAgIFdSSVRFQkFDSykuCisgKgorICovCitzdGF0
aWMgaW50IGNhY2hlX2xvb2t1cChzdHJ1Y3QgY2FjaGVfYyAqZG1jLCBzZWN0b3JfdCBibG9jaywK
KwkgICAgICAgICAgICAgICAgICAgIHNlY3Rvcl90ICpjYWNoZV9ibG9jaykKK3sKKwl1bnNpZ25l
ZCBsb25nIHNldF9udW1iZXIgPSBoYXNoX2Jsb2NrKGRtYywgYmxvY2spOworCXNlY3Rvcl90IGlu
ZGV4OworCWludCBpLCByZXM7CisJdW5zaWduZWQgaW50IGNhY2hlX2Fzc29jID0gZG1jLT5hc3Nv
YzsKKwlzdHJ1Y3QgY2FjaGVibG9jayAqY2FjaGUgPSBkbWMtPmNhY2hlOworCWludCBpbnZhbGlk
ID0gLTEsIG9sZGVzdCA9IC0xLCBvbGRlc3RfY2xlYW4gPSAtMTsKKwl1bnNpZ25lZCBsb25nIGNv
dW50ZXIgPSBVTE9OR19NQVgsIGNsZWFuX2NvdW50ZXIgPSBVTE9OR19NQVg7CisKKwlpbmRleD1z
ZXRfbnVtYmVyICogY2FjaGVfYXNzb2M7CisJZm9yIChpPTA7IGk8Y2FjaGVfYXNzb2M7IGkrKywg
aW5kZXgrKykgeworCQlpZiAoaXNfc3RhdGUoY2FjaGVbaW5kZXhdLnN0YXRlLCBWQUxJRCkgfHwK
KwkJICAgIGlzX3N0YXRlKGNhY2hlW2luZGV4XS5zdGF0ZSwgUkVTRVJWRUQpKSB7CisJCQlpZiAo
Y2FjaGVbaW5kZXhdLmJsb2NrID09IGJsb2NrKSB7CisJCQkJKmNhY2hlX2Jsb2NrID0gaW5kZXg7
CisJCQkJLyogUmVzZXQgYWxsIGNvdW50ZXJzIGlmIHRoZSBsYXJnZXN0IG9uZSBpcyBnb2luZyB0
byBvdmVyZmxvdyAqLworCQkJCWlmIChkbWMtPmNvdW50ZXIgPT0gVUxPTkdfTUFYKSBjYWNoZV9y
ZXNldF9jb3VudGVyKGRtYyk7CisJCQkJY2FjaGVbaW5kZXhdLmNvdW50ZXIgPSArK2RtYy0+Y291
bnRlcjsKKwkJCQlicmVhazsKKwkJCX0gZWxzZSB7CisJCQkJLyogRG9uJ3QgY29uc2lkZXIgYmxv
Y2tzIHRoYXQgYXJlIGluIHRoZSBtaWRkbGUgb2YgY29weWluZyAqLworCQkJCWlmICghaXNfc3Rh
dGUoY2FjaGVbaW5kZXhdLnN0YXRlLCBSRVNFUlZFRCkgJiYKKwkJCQkgICAgIWlzX3N0YXRlKGNh
Y2hlW2luZGV4XS5zdGF0ZSwgV1JJVEVCQUNLKSkgeworCQkJCQlpZiAoIWlzX3N0YXRlKGNhY2hl
W2luZGV4XS5zdGF0ZSwgRElSVFkpICYmCisJCQkJCSAgICBjYWNoZVtpbmRleF0uY291bnRlciA8
IGNsZWFuX2NvdW50ZXIpIHsKKwkJCQkJCWNsZWFuX2NvdW50ZXIgPSBjYWNoZVtpbmRleF0uY291
bnRlcjsKKwkJCQkJCW9sZGVzdF9jbGVhbiA9IGk7CisJCQkJCX0KKwkJCQkJaWYgKGNhY2hlW2lu
ZGV4XS5jb3VudGVyIDwgY291bnRlcikgeworCQkJCQkJY291bnRlciA9IGNhY2hlW2luZGV4XS5j
b3VudGVyOworCQkJCQkJb2xkZXN0ID0gaTsKKwkJCQkJfQorCQkJCX0KKwkJCX0KKwkJfSBlbHNl
IHsKKwkJCWlmICgtMSA9PSBpbnZhbGlkKSBpbnZhbGlkID0gaTsKKwkJfQorCX0KKworCXJlcyA9
IGkgPCBjYWNoZV9hc3NvYyA/IDEgOiAwOworCWlmICghcmVzKSB7IC8qIENhY2hlIG1pc3MgKi8K
KwkJaWYgKGludmFsaWQgIT0gLTEpIC8qIENob29zZSB0aGUgZmlyc3QgZW1wdHkgZnJhbWUgKi8K
KwkJCSpjYWNoZV9ibG9jayA9IHNldF9udW1iZXIgKiBjYWNoZV9hc3NvYyArIGludmFsaWQ7CisJ
CWVsc2UgaWYgKG9sZGVzdF9jbGVhbiAhPSAtMSkgLyogQ2hvb3NlIHRoZSBMUlUgY2xlYW4gYmxv
Y2sgdG8gcmVwbGFjZSAqLworCQkJKmNhY2hlX2Jsb2NrID0gc2V0X251bWJlciAqIGNhY2hlX2Fz
c29jICsgb2xkZXN0X2NsZWFuOworCQllbHNlIGlmIChvbGRlc3QgIT0gLTEpIHsgLyogQ2hvb3Nl
IHRoZSBMUlUgZGlydHkgYmxvY2sgdG8gZXZpY3QgKi8KKwkJCXJlcyA9IDI7CisJCQkqY2FjaGVf
YmxvY2sgPSBzZXRfbnVtYmVyICogY2FjaGVfYXNzb2MgKyBvbGRlc3Q7CisJCX0gZWxzZSB7CisJ
CQlyZXMgPSAtMTsKKwkJfQorCX0KKworCWlmICgtMSA9PSByZXMpCisJCURQUklOVEsoIkNhY2hl
IGxvb2t1cDogQmxvY2sgJWxsdSglbHUpOiVzIiwKKwkgICAgICAgICAgICBibG9jaywgc2V0X251
bWJlciwgIk5PIFJPT00iKTsKKwllbHNlCisJCURQUklOVEsoIkNhY2hlIGxvb2t1cDogQmxvY2sg
JWxsdSglbHUpOiVsbHUoJXMpIiwKKwkJICAgICAgICBibG9jaywgc2V0X251bWJlciwgKmNhY2hl
X2Jsb2NrLAorCQkgICAgICAgIDEgPT0gcmVzID8gIkhJVCIgOiAoMCA9PSByZXMgPyAiTUlTUyIg
OiAiV0IgTkVFREVEIikpOworCXJldHVybiByZXM7Cit9CisKKy8qCisgKiBJbnNlcnQgYSBibG9j
ayBpbnRvIHRoZSBjYWNoZSAoaW4gdGhlIGZyYW1lIHNwZWNpZmllZCBieSBjYWNoZV9ibG9jayku
CisgKi8KK3N0YXRpYyBpbnQgY2FjaGVfaW5zZXJ0KHN0cnVjdCBjYWNoZV9jICpkbWMsIHNlY3Rv
cl90IGJsb2NrLAorCSAgICAgICAgICAgICAgICAgICAgc2VjdG9yX3QgY2FjaGVfYmxvY2spCit7
CisJc3RydWN0IGNhY2hlYmxvY2sgKmNhY2hlID0gZG1jLT5jYWNoZTsKKworCS8qIE1hcmsgdGhl
IGJsb2NrIGFzIFJFU0VSVkVEIGJlY2F1c2UgYWx0aG91Z2ggaXQgaXMgYWxsb2NhdGVkLCB0aGUg
ZGF0YSBhcmUKKyAgICAgICBub3QgaW4gcGxhY2UgdW50aWwga2NvcHlkIGZpbmlzaGVzIGl0cyBq
b2IuCisJICovCisJY2FjaGVbY2FjaGVfYmxvY2tdLmJsb2NrID0gYmxvY2s7CisJY2FjaGVbY2Fj
aGVfYmxvY2tdLnN0YXRlID0gUkVTRVJWRUQ7CisJaWYgKGRtYy0+Y291bnRlciA9PSBVTE9OR19N
QVgpIGNhY2hlX3Jlc2V0X2NvdW50ZXIoZG1jKTsKKwljYWNoZVtjYWNoZV9ibG9ja10uY291bnRl
ciA9ICsrZG1jLT5jb3VudGVyOworCisJcmV0dXJuIDE7Cit9CisKKy8qCisgKiBJbnZhbGlkYXRl
IGEgYmxvY2sgKHNwZWNpZmllZCBieSBjYWNoZV9ibG9jaykgaW4gdGhlIGNhY2hlLgorICovCitz
dGF0aWMgdm9pZCBjYWNoZV9pbnZhbGlkYXRlKHN0cnVjdCBjYWNoZV9jICpkbWMsIHNlY3Rvcl90
IGNhY2hlX2Jsb2NrKQoreworCXN0cnVjdCBjYWNoZWJsb2NrICpjYWNoZSA9IGRtYy0+Y2FjaGU7
CisKKwlEUFJJTlRLKCJDYWNoZSBpbnZhbGlkYXRlOiBCbG9jayAlbGx1KCVsbHUpIiwKKwkgICAg
ICAgIGNhY2hlX2Jsb2NrLCBjYWNoZVtjYWNoZV9ibG9ja10uYmxvY2spOworCWNsZWFyX3N0YXRl
KGNhY2hlW2NhY2hlX2Jsb2NrXS5zdGF0ZSwgVkFMSUQpOworfQorCisvKgorICogSGFuZGxlIGEg
Y2FjaGUgaGl0OgorICogIEZvciBSRUFELCBzZXJ2ZSB0aGUgcmVxdWVzdCBmcm9tIGNhY2hlIGlz
IHRoZSBibG9jayBpcyByZWFkeTsgb3RoZXJ3aXNlLAorICogIHF1ZXVlIHRoZSByZXF1ZXN0IGZv
ciBsYXRlciBwcm9jZXNzaW5nLgorICogIEZvciB3cml0ZSwgaW52YWxpZGF0ZSB0aGUgY2FjaGUg
YmxvY2sgaWYgd3JpdGUtdGhyb3VnaC4gSWYgd3JpdGUtYmFjaywKKyAqICBzZXJ2ZSB0aGUgcmVx
dWVzdCBmcm9tIGNhY2hlIGlmIHRoZSBibG9jayBpcyByZWFkeSwgb3IgcXVldWUgdGhlIHJlcXVl
c3QKKyAqICBmb3IgbGF0ZXIgcHJvY2Vzc2luZyBpZiBvdGhlcndpc2UuCisgKi8KK3N0YXRpYyBp
bnQgY2FjaGVfaGl0KHN0cnVjdCBjYWNoZV9jICpkbWMsIHN0cnVjdCBiaW8qIGJpbywgc2VjdG9y
X3QgY2FjaGVfYmxvY2spCit7CisJdW5zaWduZWQgaW50IG9mZnNldCA9ICh1bnNpZ25lZCBpbnQp
KGJpby0+Ymlfc2VjdG9yICYgZG1jLT5ibG9ja19tYXNrKTsKKwlzdHJ1Y3QgY2FjaGVibG9jayAq
Y2FjaGUgPSBkbWMtPmNhY2hlOworCisJZG1jLT5jYWNoZV9oaXRzKys7CisKKwlpZiAoYmlvX2Rh
dGFfZGlyKGJpbykgPT0gUkVBRCkgeyAvKiBSRUFEIGhpdCAqLworCQliaW8tPmJpX2JkZXYgPSBk
bWMtPmNhY2hlX2Rldi0+YmRldjsKKwkJYmlvLT5iaV9zZWN0b3IgPSAoY2FjaGVfYmxvY2sgPDwg
ZG1jLT5ibG9ja19zaGlmdCkgICsgb2Zmc2V0OworCisJCXNwaW5fbG9jaygmY2FjaGVbY2FjaGVf
YmxvY2tdLmxvY2spOworCisJCWlmIChpc19zdGF0ZShjYWNoZVtjYWNoZV9ibG9ja10uc3RhdGUs
IFZBTElEKSkgeyAvKiBWYWxpZCBjYWNoZSBibG9jayAqLworCQkJc3Bpbl91bmxvY2soJmNhY2hl
W2NhY2hlX2Jsb2NrXS5sb2NrKTsKKwkJCXJldHVybiAxOworCQl9CisKKwkJLyogQ2FjaGUgYmxv
Y2sgaXMgbm90IHJlYWR5IHlldCAqLworCQlEUFJJTlRLKCJBZGQgdG8gYmlvIGxpc3QgJXMoJWxs
dSkiLAorCQkJCWRtYy0+Y2FjaGVfZGV2LT5uYW1lLCBiaW8tPmJpX3NlY3Rvcik7CisJCWJpb19s
aXN0X2FkZCgmY2FjaGVbY2FjaGVfYmxvY2tdLmJpb3MsIGJpbyk7CisKKwkJc3Bpbl91bmxvY2so
JmNhY2hlW2NhY2hlX2Jsb2NrXS5sb2NrKTsKKwkJcmV0dXJuIDA7CisJfSBlbHNlIHsgLyogV1JJ
VEUgaGl0ICovCisJCWlmIChkbWMtPndyaXRlX3BvbGljeSA9PSBXUklURV9USFJPVUdIKSB7IC8q
IEludmFsaWRhdGUgY2FjaGVkIGRhdGEgKi8KKwkJCWNhY2hlX2ludmFsaWRhdGUoZG1jLCBjYWNo
ZV9ibG9jayk7CisJCQliaW8tPmJpX2JkZXYgPSBkbWMtPnNyY19kZXYtPmJkZXY7CisJCQlyZXR1
cm4gMTsKKwkJfQorCisJCS8qIFdyaXRlIGRlbGF5ICovCisJCWlmICghaXNfc3RhdGUoY2FjaGVb
Y2FjaGVfYmxvY2tdLnN0YXRlLCBESVJUWSkpIHsKKwkJCXNldF9zdGF0ZShjYWNoZVtjYWNoZV9i
bG9ja10uc3RhdGUsIERJUlRZKTsKKwkJCWRtYy0+ZGlydHlfYmxvY2tzKys7CisJCX0KKworCQlz
cGluX2xvY2soJmNhY2hlW2NhY2hlX2Jsb2NrXS5sb2NrKTsKKworIAkJLyogSW4gdGhlIG1pZGRs
ZSBvZiB3cml0ZSBiYWNrICovCisJCWlmIChpc19zdGF0ZShjYWNoZVtjYWNoZV9ibG9ja10uc3Rh
dGUsIFdSSVRFQkFDSykpIHsKKwkJCS8qIERlbGF5IHRoaXMgd3JpdGUgdW50aWwgdGhlIGJsb2Nr
IGlzIHdyaXR0ZW4gYmFjayAqLworCQkJYmlvLT5iaV9iZGV2ID0gZG1jLT5zcmNfZGV2LT5iZGV2
OworCQkJRFBSSU5USygiQWRkIHRvIGJpbyBsaXN0ICVzKCVsbHUpIiwKKwkJCQkJZG1jLT5zcmNf
ZGV2LT5uYW1lLCBiaW8tPmJpX3NlY3Rvcik7CisJCQliaW9fbGlzdF9hZGQoJmNhY2hlW2NhY2hl
X2Jsb2NrXS5iaW9zLCBiaW8pOworCQkJc3Bpbl91bmxvY2soJmNhY2hlW2NhY2hlX2Jsb2NrXS5s
b2NrKTsKKwkJCXJldHVybiAwOworCQl9CisKKwkJLyogQ2FjaGUgYmxvY2sgbm90IHJlYWR5IHll
dCAqLworCQlpZiAoaXNfc3RhdGUoY2FjaGVbY2FjaGVfYmxvY2tdLnN0YXRlLCBSRVNFUlZFRCkp
IHsKKwkJCWJpby0+YmlfYmRldiA9IGRtYy0+Y2FjaGVfZGV2LT5iZGV2OworCQkJYmlvLT5iaV9z
ZWN0b3IgPSAoY2FjaGVfYmxvY2sgPDwgZG1jLT5ibG9ja19zaGlmdCkgKyBvZmZzZXQ7CisJCQlE
UFJJTlRLKCJBZGQgdG8gYmlvIGxpc3QgJXMoJWxsdSkiLAorCQkJCQlkbWMtPmNhY2hlX2Rldi0+
bmFtZSwgYmlvLT5iaV9zZWN0b3IpOworCQkJYmlvX2xpc3RfYWRkKCZjYWNoZVtjYWNoZV9ibG9j
a10uYmlvcywgYmlvKTsKKwkJCXNwaW5fdW5sb2NrKCZjYWNoZVtjYWNoZV9ibG9ja10ubG9jayk7
CisJCQlyZXR1cm4gMDsKKwkJfQorCisJCS8qIFNlcnZlIHRoZSByZXF1ZXN0IGZyb20gY2FjaGUg
Ki8KKwkJYmlvLT5iaV9iZGV2ID0gZG1jLT5jYWNoZV9kZXYtPmJkZXY7CisJCWJpby0+Ymlfc2Vj
dG9yID0gKGNhY2hlX2Jsb2NrIDw8IGRtYy0+YmxvY2tfc2hpZnQpICsgb2Zmc2V0OworCisJCXNw
aW5fdW5sb2NrKCZjYWNoZVtjYWNoZV9ibG9ja10ubG9jayk7CisJCXJldHVybiAxOworCX0KK30K
Kworc3RhdGljIHN0cnVjdCBrY2FjaGVkX2pvYiAqbmV3X2tjYWNoZWRfam9iKHN0cnVjdCBjYWNo
ZV9jICpkbWMsIHN0cnVjdCBiaW8qIGJpbywKKwkgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBzZWN0b3JfdCByZXF1ZXN0X2Jsb2NrLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHNlY3Rvcl90IGNhY2hlX2Jsb2NrKQoreworCXN0cnVjdCBp
b19yZWdpb24gc3JjLCBkZXN0OworCXN0cnVjdCBrY2FjaGVkX2pvYiAqam9iOworCisJc3JjLmJk
ZXYgPSBkbWMtPnNyY19kZXYtPmJkZXY7CisJc3JjLnNlY3RvciA9IHJlcXVlc3RfYmxvY2s7CisJ
c3JjLmNvdW50ID0gZG1jLT5ibG9ja19zaXplOworCWRlc3QuYmRldiA9IGRtYy0+Y2FjaGVfZGV2
LT5iZGV2OworCWRlc3Quc2VjdG9yID0gY2FjaGVfYmxvY2sgPDwgZG1jLT5ibG9ja19zaGlmdDsK
KwlkZXN0LmNvdW50ID0gc3JjLmNvdW50OworCisJam9iID0gbWVtcG9vbF9hbGxvYyhfam9iX3Bv
b2wsIEdGUF9OT0lPKTsKKwlqb2ItPmRtYyA9IGRtYzsKKwlqb2ItPmJpbyA9IGJpbzsKKwlqb2It
PnNyYyA9IHNyYzsKKwlqb2ItPmRlc3QgPSBkZXN0OworCWpvYi0+Y2FjaGVibG9jayA9ICZkbWMt
PmNhY2hlW2NhY2hlX2Jsb2NrXTsKKworCXJldHVybiBqb2I7Cit9CisKKy8qCisgKiBIYW5kbGUg
YSByZWFkIGNhY2hlIG1pc3M6CisgKiAgVXBkYXRlIHRoZSBtZXRhZGF0YTsgZmV0Y2ggdGhlIG5l
Y2Vzc2FyeSBibG9jayBmcm9tIHNvdXJjZSBkZXZpY2U7CisgKiAgc3RvcmUgZGF0YSB0byBjYWNo
ZSBkZXZpY2UuCisgKi8KK3N0YXRpYyBpbnQgY2FjaGVfcmVhZF9taXNzKHN0cnVjdCBjYWNoZV9j
ICpkbWMsIHN0cnVjdCBiaW8qIGJpbywKKwkgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rvcl90
IGNhY2hlX2Jsb2NrKSB7CisJc3RydWN0IGNhY2hlYmxvY2sgKmNhY2hlID0gZG1jLT5jYWNoZTsK
Kwl1bnNpZ25lZCBpbnQgb2Zmc2V0LCBoZWFkLCB0YWlsOworCXN0cnVjdCBrY2FjaGVkX2pvYiAq
am9iOworCXNlY3Rvcl90IHJlcXVlc3RfYmxvY2s7CisKKwlvZmZzZXQgPSAodW5zaWduZWQgaW50
KShiaW8tPmJpX3NlY3RvciAmIGRtYy0+YmxvY2tfbWFzayk7CisJcmVxdWVzdF9ibG9jayA9IGJp
by0+Ymlfc2VjdG9yIC0gb2Zmc2V0OworCisJaWYgKGNhY2hlW2NhY2hlX2Jsb2NrXS5zdGF0ZSAm
IFZBTElEKSB7CisJCURQUklOVEsoIlJlcGxhY2luZyAlbGx1LT4lbGx1IiwKKwkJICAgICAgICBj
YWNoZVtjYWNoZV9ibG9ja10uYmxvY2ssIHJlcXVlc3RfYmxvY2spOworCQlkbWMtPnJlcGxhY2Ur
KzsKKwl9IGVsc2UgRFBSSU5USygiSW5zZXJ0IGJsb2NrICVsbHUgYXQgZW1wdHkgZnJhbWUgJWxs
dSIsCisJCXJlcXVlc3RfYmxvY2ssIGNhY2hlX2Jsb2NrKTsKKworCWNhY2hlX2luc2VydChkbWMs
IHJlcXVlc3RfYmxvY2ssIGNhY2hlX2Jsb2NrKTsgLyogVXBkYXRlIG1ldGFkYXRhIGZpcnN0ICov
CisKKwlqb2IgPSBuZXdfa2NhY2hlZF9qb2IoZG1jLCBiaW8sIHJlcXVlc3RfYmxvY2ssIGNhY2hl
X2Jsb2NrKTsKKworCWhlYWQgPSB0b19ieXRlcyhvZmZzZXQpOworCXRhaWwgPSB0b19ieXRlcyhk
bWMtPmJsb2NrX3NpemUpIC0gYmlvLT5iaV9zaXplIC0gaGVhZDsKKworCS8qIFJlcXVlc3RlZCBi
bG9jayBpcyBhbGlnbmVkIHdpdGggYSBjYWNoZSBibG9jayAqLworCWlmICgwID09IGhlYWQgJiYg
MCA9PSB0YWlsKQorCQlqb2ItPm5yX3BhZ2VzPSAwOworCWVsc2UgLyogTmVlZCBuZXcgcGFnZXMg
dG8gc3RvcmUgZXh0cmEgZGF0YSAqLworCQlqb2ItPm5yX3BhZ2VzID0gZG1fZGl2X3VwKGhlYWQs
IFBBR0VfU0laRSkgKyBkbV9kaXZfdXAodGFpbCwgUEFHRV9TSVpFKTsKKwlqb2ItPnJ3ID0gUkVB
RDsgLyogRmV0Y2ggZGF0YSBmcm9tIHRoZSBzb3VyY2UgZGV2aWNlICovCisKKwlEUFJJTlRLKCJR
dWV1ZSBqb2IgZm9yICVsbHUgKG5lZWQgJXUgcGFnZXMpIiwKKwkgICAgICAgIGJpby0+Ymlfc2Vj
dG9yLCBqb2ItPm5yX3BhZ2VzKTsKKwlxdWV1ZV9qb2Ioam9iKTsKKworCXJldHVybiAwOworfQor
CisvKgorICogSGFuZGxlIGEgd3JpdGUgY2FjaGUgbWlzczoKKyAqICBJZiB3cml0ZS10aHJvdWdo
LCBmb3J3YXJkIHRoZSByZXF1ZXN0IHRvIHNvdXJjZSBkZXZpY2UuCisgKiAgSWYgd3JpdGUtYmFj
aywgdXBkYXRlIHRoZSBtZXRhZGF0YTsgZmV0Y2ggdGhlIG5lY2Vzc2FyeSBibG9jayBmcm9tIHNv
dXJjZQorICogIGRldmljZTsgd3JpdGUgdG8gY2FjaGUgZGV2aWNlLgorICovCitzdGF0aWMgaW50
IGNhY2hlX3dyaXRlX21pc3Moc3RydWN0IGNhY2hlX2MgKmRtYywgc3RydWN0IGJpbyogYmlvLCBz
ZWN0b3JfdCBjYWNoZV9ibG9jaykgeworCXN0cnVjdCBjYWNoZWJsb2NrICpjYWNoZSA9IGRtYy0+
Y2FjaGU7CisJdW5zaWduZWQgaW50IG9mZnNldCwgaGVhZCwgdGFpbDsKKwlzdHJ1Y3Qga2NhY2hl
ZF9qb2IgKmpvYjsKKwlzZWN0b3JfdCByZXF1ZXN0X2Jsb2NrOworCisJaWYgKGRtYy0+d3JpdGVf
cG9saWN5ID09IFdSSVRFX1RIUk9VR0gpIHsgLyogRm9yd2FyZCByZXF1ZXN0IHRvIHNvdXVjZSAq
LworCQliaW8tPmJpX2JkZXYgPSBkbWMtPnNyY19kZXYtPmJkZXY7CisJCXJldHVybiAxOworCX0K
KworCW9mZnNldCA9ICh1bnNpZ25lZCBpbnQpKGJpby0+Ymlfc2VjdG9yICYgZG1jLT5ibG9ja19t
YXNrKTsKKwlyZXF1ZXN0X2Jsb2NrID0gYmlvLT5iaV9zZWN0b3IgLSBvZmZzZXQ7CisKKwlpZiAo
Y2FjaGVbY2FjaGVfYmxvY2tdLnN0YXRlICYgVkFMSUQpIHsKKwkJRFBSSU5USygiUmVwbGFjaW5n
ICVsbHUtPiVsbHUiLAorCQkgICAgICAgIGNhY2hlW2NhY2hlX2Jsb2NrXS5ibG9jaywgcmVxdWVz
dF9ibG9jayk7CisJCWRtYy0+cmVwbGFjZSsrOworCX0gZWxzZSBEUFJJTlRLKCJJbnNlcnQgYmxv
Y2sgJWxsdSBhdCBlbXB0eSBmcmFtZSAlbGx1IiwKKwkJcmVxdWVzdF9ibG9jaywgY2FjaGVfYmxv
Y2spOworCisJLyogV3JpdGUgZGVsYXkgKi8KKwljYWNoZV9pbnNlcnQoZG1jLCByZXF1ZXN0X2Js
b2NrLCBjYWNoZV9ibG9jayk7IC8qIFVwZGF0ZSBtZXRhZGF0YSBmaXJzdCAqLworCXNldF9zdGF0
ZShjYWNoZVtjYWNoZV9ibG9ja10uc3RhdGUsIERJUlRZKTsKKwlkbWMtPmRpcnR5X2Jsb2Nrcysr
OworCisJam9iID0gbmV3X2tjYWNoZWRfam9iKGRtYywgYmlvLCByZXF1ZXN0X2Jsb2NrLCBjYWNo
ZV9ibG9jayk7CisKKwloZWFkID0gdG9fYnl0ZXMob2Zmc2V0KTsKKwl0YWlsID0gdG9fYnl0ZXMo
ZG1jLT5ibG9ja19zaXplKSAtIGJpby0+Ymlfc2l6ZSAtIGhlYWQ7CisKKwlpZiAoMCA9PSBoZWFk
ICYmIDAgPT0gdGFpbCkgeyAvKiBSZXF1ZXN0ZWQgaXMgYWxpZ25lZCB3aXRoIGEgY2FjaGUgYmxv
Y2sgKi8KKwkJam9iLT5ucl9wYWdlcyA9IDA7CisJCWpvYi0+cncgPSBXUklURTsKKwl9IGVsc2Ug
aWYgKGhlYWQgJiYgdGFpbCl7IC8qIFNwZWNpYWwgY2FzZTogbmVlZCB0byBwYWQgYm90aCBoZWFk
IGFuZCB0YWlsICovCisJCWpvYi0+bnJfcGFnZXMgPSBkbV9kaXZfdXAodG9fYnl0ZXMoZG1jLT5i
bG9ja19zaXplKSwgUEFHRV9TSVpFKTsKKwkJam9iLT5ydyA9IFJFQUQ7CisJfSBlbHNlIHsKKwkJ
aWYgKGhlYWQpIHsgLyogRmV0Y2ggb25seSBoZWFkICovCisJCQlqb2ItPnNyYy5jb3VudCA9IHRv
X3NlY3RvcihoZWFkKTsKKwkJCWpvYi0+bnJfcGFnZXMgPSBkbV9kaXZfdXAoaGVhZCwgUEFHRV9T
SVpFKTsKKwkJfSBlbHNlIHsgLyogRmV0Y2ggb25seSB0YWlsICovCisJCQlqb2ItPnNyYy5zZWN0
b3IgPSBiaW8tPmJpX3NlY3RvciArIHRvX3NlY3RvcihiaW8tPmJpX3NpemUpOworCQkJam9iLT5z
cmMuY291bnQgPSB0b19zZWN0b3IodGFpbCk7CisJCQlqb2ItPm5yX3BhZ2VzID0gZG1fZGl2X3Vw
KHRhaWwsIFBBR0VfU0laRSk7CisJCX0KKwkJam9iLT5ydyA9IFJFQUQ7CisJfQorCisJcXVldWVf
am9iKGpvYik7CisKKwlyZXR1cm4gMDsKK30KKworLyogSGFuZGxlIGNhY2hlIG1pc3NlcyAqLwor
c3RhdGljIGludCBjYWNoZV9taXNzKHN0cnVjdCBjYWNoZV9jICpkbWMsIHN0cnVjdCBiaW8qIGJp
bywgc2VjdG9yX3QgY2FjaGVfYmxvY2spIHsKKwlpZiAoYmlvX2RhdGFfZGlyKGJpbykgPT0gUkVB
RCkKKwkJcmV0dXJuIGNhY2hlX3JlYWRfbWlzcyhkbWMsIGJpbywgY2FjaGVfYmxvY2spOworCWVs
c2UKKwkJcmV0dXJuIGNhY2hlX3dyaXRlX21pc3MoZG1jLCBiaW8sIGNhY2hlX2Jsb2NrKTsKK30K
KworCisvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKgorICogIEZ1bmN0aW9ucyBmb3IgaW1wbGVtZW50aW5n
IHRoZSBvcGVyYXRpb25zIG9uIGEgY2FjaGUgbWFwcGluZy4KKyAqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
LworCisvKgorICogRGVjaWRlIHRoZSBtYXBwaW5nIGFuZCBwZXJmb3JtIG5lY2Vzc2FyeSBjYWNo
ZSBvcGVyYXRpb25zIGZvciBhIGJpbyByZXF1ZXN0LgorICovCitzdGF0aWMgaW50IGNhY2hlX21h
cChzdHJ1Y3QgZG1fdGFyZ2V0ICp0aSwgc3RydWN0IGJpbyAqYmlvLAorCQkgICAgICB1bmlvbiBt
YXBfaW5mbyAqbWFwX2NvbnRleHQpCit7CisJc3RydWN0IGNhY2hlX2MgKmRtYyA9IChzdHJ1Y3Qg
Y2FjaGVfYyAqKSB0aS0+cHJpdmF0ZTsKKwlzZWN0b3JfdCByZXF1ZXN0X2Jsb2NrLCBjYWNoZV9i
bG9jayA9IDAsIG9mZnNldDsKKwlpbnQgcmVzOworCisJb2Zmc2V0ID0gYmlvLT5iaV9zZWN0b3Ig
JiBkbWMtPmJsb2NrX21hc2s7CisJcmVxdWVzdF9ibG9jayA9IGJpby0+Ymlfc2VjdG9yIC0gb2Zm
c2V0OworCURQUklOVEsoIkdvdCBhICVzIGZvciAlbGx1ICgoJWxsdTolbGx1KSwgJXUgYnl0ZXMp
IiwKKwkgICAgICAgIGJpb19ydyhiaW8pID09IFdSSVRFID8gIldSSVRFIiA6IChiaW9fcncoYmlv
KSA9PSBSRUFEID8KKwkgICAgICAgICJSRUFEIjoiUkVBREEiKSwgYmlvLT5iaV9zZWN0b3IsIHJl
cXVlc3RfYmxvY2ssIG9mZnNldCwKKwkgICAgICAgIGJpby0+Ymlfc2l6ZSk7CisKKwlpZiAoYmlv
X2RhdGFfZGlyKGJpbykgPT0gUkVBRCkgZG1jLT5yZWFkcysrOworCWVsc2UgZG1jLT53cml0ZXMr
KzsKKworCXJlcyA9IGNhY2hlX2xvb2t1cChkbWMsIHJlcXVlc3RfYmxvY2ssICZjYWNoZV9ibG9j
ayk7CisJaWYgKDEgPT0gcmVzKSAgLyogQ2FjaGUgaGl0OyBzZXJ2ZXIgcmVxdWVzdCBmcm9tIGNh
Y2hlICovCisJCXJldHVybiBjYWNoZV9oaXQoZG1jLCBiaW8sIGNhY2hlX2Jsb2NrKTsKKwllbHNl
IGlmICgwID09IHJlcykgLyogQ2FjaGUgbWlzczsgcmVwbGFjZW1lbnQgYmxvY2sgaXMgZm91bmQg
Ki8KKwkJcmV0dXJuIGNhY2hlX21pc3MoZG1jLCBiaW8sIGNhY2hlX2Jsb2NrKTsKKwllbHNlIGlm
ICgyID09IHJlcykgeyAvKiBFbnRpcmUgY2FjaGUgc2V0IGlzIGRpcnR5OyBpbml0aWF0ZSBhIHdy
aXRlLWJhY2sgKi8KKwkJd3JpdGVfYmFjayhkbWMsIGNhY2hlX2Jsb2NrLCAxKTsKKwkJZG1jLT53
cml0ZWJhY2srKzsKKwl9CisKKwkvKiBGb3J3YXJkIHRvIHNvdXJjZSBkZXZpY2UgKi8KKwliaW8t
PmJpX2JkZXYgPSBkbWMtPnNyY19kZXYtPmJkZXY7CisKKwlyZXR1cm4gMTsKK30KKworc3RydWN0
IG1ldGFfZG1jIHsKKwlzZWN0b3JfdCBzaXplOworCXVuc2lnbmVkIGludCBibG9ja19zaXplOwor
CXVuc2lnbmVkIGludCBhc3NvYzsKKwl1bnNpZ25lZCBpbnQgd3JpdGVfcG9saWN5OworCXVuc2ln
bmVkIGludCBjaGtzdW07Cit9OworCisvKiBMb2FkIG1ldGFkYXRhIHN0b3JlZCBieSBwcmV2aW91
cyBzZXNzaW9uIGZyb20gZGlzay4gKi8KK3N0YXRpYyBpbnQgbG9hZF9tZXRhZGF0YShzdHJ1Y3Qg
Y2FjaGVfYyAqZG1jKSB7CisJc3RydWN0IGlvX3JlZ2lvbiB3aGVyZTsKKwl1bnNpZ25lZCBsb25n
IGJpdHM7CisJc2VjdG9yX3QgZGV2X3NpemUgPSB0b19zZWN0b3IoZG1jLT5jYWNoZV9kZXYtPmJk
ZXYtPmJkX2lub2RlLT5pX3NpemUpOworCXNlY3Rvcl90IG1ldGFfc2l6ZSwgKm1ldGFfZGF0YSwg
aSwgaiwgaW5kZXggPSAwLCBsaW1pdCwgb3JkZXI7CisJc3RydWN0IG1ldGFfZG1jICptZXRhX2Rt
YzsKKwl1bnNpZ25lZCBpbnQgY2hrc3VtID0gMCwgY2hrc3VtX3NhdiwgY29uc2VjdXRpdmVfYmxv
Y2tzOworCisJbWV0YV9kbWMgPSAoc3RydWN0IG1ldGFfZG1jICopdm1hbGxvYyg1MTIpOworCWlm
ICghbWV0YV9kbWMpIHsKKwkJRE1FUlIoImxvYWRfbWV0YWRhdGE6IFVuYWJsZSB0byBhbGxvY2F0
ZSBtZW1vcnkiKTsKKwkJcmV0dXJuIDE7CisJfQorCisJd2hlcmUuYmRldiA9IGRtYy0+Y2FjaGVf
ZGV2LT5iZGV2OworCXdoZXJlLnNlY3RvciA9IGRldl9zaXplIC0gMTsKKwl3aGVyZS5jb3VudCA9
IDE7CisJZG1faW9fc3luY192bSgxLCAmd2hlcmUsIFJFQUQsIG1ldGFfZG1jLCAmYml0cyk7CisJ
RFBSSU5USygiTG9hZGVkIGNhY2hlIGNvbmY6IGJsb2NrIHNpemUoJXUpLCBjYWNoZSBzaXplKCVs
bHUpLCAiIFwKKwkgICAgICAgICJhc3NvY2lhdGl2aXR5KCV1KSwgd3JpdGUgcG9saWN5KCV1KSwg
Y2hrc3VtKCV1KSIsCisJICAgICAgICBtZXRhX2RtYy0+YmxvY2tfc2l6ZSwgbWV0YV9kbWMtPnNp
emUsCisJICAgICAgICBtZXRhX2RtYy0+YXNzb2MsIG1ldGFfZG1jLT53cml0ZV9wb2xpY3ksCisJ
ICAgICAgICBtZXRhX2RtYy0+Y2hrc3VtKTsKKworCWRtYy0+YmxvY2tfc2l6ZSA9IG1ldGFfZG1j
LT5ibG9ja19zaXplOworCWRtYy0+YmxvY2tfc2hpZnQgPSBmZnMoZG1jLT5ibG9ja19zaXplKSAt
IDE7CisJZG1jLT5ibG9ja19tYXNrID0gZG1jLT5ibG9ja19zaXplIC0gMTsKKworCWRtYy0+c2l6
ZSA9IG1ldGFfZG1jLT5zaXplOworCWRtYy0+Yml0cyA9IGZmcyhkbWMtPnNpemUpIC0gMTsKKwor
CWRtYy0+YXNzb2MgPSBtZXRhX2RtYy0+YXNzb2M7CisJY29uc2VjdXRpdmVfYmxvY2tzID0gZG1j
LT5hc3NvYyA8IENPTlNFQ1VUSVZFX0JMT0NLUyA/CisJICAgICAgICAgICAgICAgICAgICAgZG1j
LT5hc3NvYyA6IENPTlNFQ1VUSVZFX0JMT0NLUzsKKwlkbWMtPmNvbnNlY3V0aXZlX3NoaWZ0ID0g
ZmZzKGNvbnNlY3V0aXZlX2Jsb2NrcykgLSAxOworCisJZG1jLT53cml0ZV9wb2xpY3kgPSBtZXRh
X2RtYy0+d3JpdGVfcG9saWN5OworCWNoa3N1bV9zYXYgPSBtZXRhX2RtYy0+Y2hrc3VtOworCisJ
dmZyZWUoKHZvaWQgKiltZXRhX2RtYyk7CisKKworCW9yZGVyID0gZG1jLT5zaXplICogc2l6ZW9m
KHN0cnVjdCBjYWNoZWJsb2NrKTsKKwlETUlORk8oIkFsbG9jYXRlICVsbHVLQiAoJXVCIHBlcikg
bWVtIGZvciAlbGx1LWVudHJ5IGNhY2hlIiBcCisJICAgICAgICIoY2FwYWNpdHk6JWxsdU1CLCBh
c3NvY2lhdGl2aXR5OiV1LCBibG9jayBzaXplOiV1ICIgXAorCSAgICAgICAic2VjdG9ycygldUtC
KSwgJXMpIiwKKwkgICAgICAgb3JkZXIgPj4gMTAsIHNpemVvZihzdHJ1Y3QgY2FjaGVibG9jayks
IGRtYy0+c2l6ZSwKKwkgICAgICAgZG1jLT5zaXplICogZG1jLT5ibG9ja19zaXplID4+ICgyMC1T
RUNUT1JfU0hJRlQpLCBkbWMtPmFzc29jLAorCSAgICAgICBkbWMtPmJsb2NrX3NpemUsIGRtYy0+
YmxvY2tfc2l6ZSA+PiAoMTAtU0VDVE9SX1NISUZUKSwKKwkgICAgICAgZG1jLT53cml0ZV9wb2xp
Y3kgPyAid3JpdGUtYmFjayIgOiAid3JpdGUtdGhyb3VnaCIpOworCWRtYy0+Y2FjaGUgPSAoc3Ry
dWN0IGNhY2hlYmxvY2sgKil2bWFsbG9jKG9yZGVyKTsKKwlpZiAoIWRtYy0+Y2FjaGUpIHsKKwkJ
RE1FUlIoImxvYWRfbWV0YWRhdGE6IFVuYWJsZSB0byBhbGxvY2F0ZSBtZW1vcnkiKTsKKwkJcmV0
dXJuIDE7CisJfQorCisJbWV0YV9zaXplID0gZG1fZGl2X3VwKGRtYy0+c2l6ZSAqIHNpemVvZihz
ZWN0b3JfdCksIDUxMik7CisJLyogV2hlbiByZXF1ZXN0aW5nIGEgbmV3IGJpbywgdGhlIG51bWJl
ciBvZiByZXF1ZXN0ZWQgYnZlY3MgaGFzIHRvIGJlCisJICAgbGVzcyB0aGFuIEJJT19NQVhfUEFH
RVMuIE90aGVyd2lzZSwgbnVsbCBpcyByZXR1cm5lZC4gSW4gZG0taW8uYywKKwkgICB0aGlzIHJl
dHVybiB2YWx1ZSBpcyBub3QgY2hlY2tlZCBhbmQga2VybmVsIE9vcHMgbWF5IGhhcHBlbi4gV2Ug
c2V0CisJICAgdGhlIGxpbWl0IGhlcmUgdG8gYXZvaWQgc3VjaCBzaXR1YXRpb25zLiAoMiBhZGRp
dGlvbmFsIGJ2ZWNzIGFyZQorCSAgIHJlcXVpcmVkIGJ5IGRtLWlvIGZvciBib29rZWVwaW5nLikK
KwkgKi8KKwlsaW1pdCA9IChCSU9fTUFYX1BBR0VTIC0gMikgKiAoUEFHRV9TSVpFID4+IFNFQ1RP
Ul9TSElGVCk7CisJbWV0YV9kYXRhID0gKHNlY3Rvcl90ICopdm1hbGxvYyh0b19ieXRlcyhtaW4o
bWV0YV9zaXplLCBsaW1pdCkpKTsKKwlpZiAoIW1ldGFfZGF0YSkgeworCQlETUVSUigibG9hZF9t
ZXRhZGF0YTogVW5hYmxlIHRvIGFsbG9jYXRlIG1lbW9yeSIpOworCQl2ZnJlZSgodm9pZCAqKWRt
Yy0+Y2FjaGUpOworCQlyZXR1cm4gMTsKKwl9CisKKwl3aGlsZShpbmRleCA8IG1ldGFfc2l6ZSkg
eworCQl3aGVyZS5zZWN0b3IgPSBkZXZfc2l6ZSAtIDEgLSBtZXRhX3NpemUgKyBpbmRleDsKKwkJ
d2hlcmUuY291bnQgPSBtaW4obWV0YV9zaXplIC0gaW5kZXgsIGxpbWl0KTsKKwkJZG1faW9fc3lu
Y192bSgxLCAmd2hlcmUsIFJFQUQsIG1ldGFfZGF0YSwgJmJpdHMpOworCisJCWZvciAoaT10b19i
eXRlcyhpbmRleCkvc2l6ZW9mKHNlY3Rvcl90KSwgaj0wOworCQkgICAgIGo8dG9fYnl0ZXMod2hl
cmUuY291bnQpL3NpemVvZihzZWN0b3JfdCkgJiYgaTxkbWMtPnNpemU7CisJCSAgICAgaSsrLCBq
KyspIHsKKwkJCWlmKG1ldGFfZGF0YVtqXSkgeworCQkJCWRtYy0+Y2FjaGVbaV0uYmxvY2sgPSBt
ZXRhX2RhdGFbal07CisJCQkJZG1jLT5jYWNoZVtpXS5zdGF0ZSA9IDE7CisJCQl9IGVsc2UKKwkJ
CQlkbWMtPmNhY2hlW2ldLnN0YXRlID0gMDsKKwkJfQorCQljaGtzdW0gPSBjc3VtX3BhcnRpYWwo
KGNoYXIgKiltZXRhX2RhdGEsIHRvX2J5dGVzKHdoZXJlLmNvdW50KSwgY2hrc3VtKTsKKwkJaW5k
ZXggKz0gd2hlcmUuY291bnQ7CisJfQorCisJdmZyZWUoKHZvaWQgKiltZXRhX2RhdGEpOworCisJ
aWYgKGNoa3N1bSAhPSBjaGtzdW1fc2F2KSB7IC8qIENoZWNrIHRoZSBjaGVja3N1bSBvZiB0aGUg
bWV0YWRhdGEgKi8KKwkJRFBSSU5USygiQ2FjaGUgbWV0YWRhdGEgbG9hZGVkIGZyb20gZGlzayBp
cyBjb3JydXB0ZWQiKTsKKwkJdmZyZWUoKHZvaWQgKilkbWMtPmNhY2hlKTsKKwkJcmV0dXJuIDE7
CisJfQorCisJRE1JTkZPKCJDYWNoZSBtZXRhZGF0YSBsb2FkZWQgZnJvbSBkaXNrIChvZmZzZXQg
JWxsdSkiLAorCSAgICAgICBkZXZfc2l6ZSAtIDEgLSBtZXRhX3NpemUpOzsKKworCXJldHVybiAw
OworfQorCisvKiBTdG9yZSBtZXRhZGF0YSBvbnRvIGRpc2suICovCitzdGF0aWMgaW50IGR1bXBf
bWV0YWRhdGEoc3RydWN0IGNhY2hlX2MgKmRtYykgeworCXN0cnVjdCBpb19yZWdpb24gd2hlcmU7
CisJdW5zaWduZWQgbG9uZyBiaXRzOworCXNlY3Rvcl90IGRldl9zaXplID0gdG9fc2VjdG9yKGRt
Yy0+Y2FjaGVfZGV2LT5iZGV2LT5iZF9pbm9kZS0+aV9zaXplKTsKKwlzZWN0b3JfdCBtZXRhX3Np
emUsIGksIGosIGluZGV4ID0gMCwgbGltaXQsICptZXRhX2RhdGE7CisJc3RydWN0IG1ldGFfZG1j
ICptZXRhX2RtYzsKKwl1bnNpZ25lZCBpbnQgY2hrc3VtID0gMDsKKworCW1ldGFfc2l6ZSA9IGRt
X2Rpdl91cChkbWMtPnNpemUgKiBzaXplb2Yoc2VjdG9yX3QpLCA1MTIpOworCWxpbWl0ID0gKEJJ
T19NQVhfUEFHRVMgLSAyKSAqIChQQUdFX1NJWkUgPj4gU0VDVE9SX1NISUZUKTsKKwltZXRhX2Rh
dGEgPSAoc2VjdG9yX3QgKil2bWFsbG9jKHRvX2J5dGVzKG1pbihtZXRhX3NpemUsIGxpbWl0KSkp
OworCWlmICghbWV0YV9kYXRhKSB7CisJCURNRVJSKCJkdW1wX21ldGFkYXRhOiBVbmFibGUgdG8g
YWxsb2NhdGUgbWVtb3J5Iik7CisJCXJldHVybiAxOworCX0KKworCXdoZXJlLmJkZXYgPSBkbWMt
PmNhY2hlX2Rldi0+YmRldjsKKwl3aGlsZShpbmRleCA8IG1ldGFfc2l6ZSkgeworCQl3aGVyZS5z
ZWN0b3IgPSBkZXZfc2l6ZSAtIDEgLSBtZXRhX3NpemUgKyBpbmRleDsKKwkJd2hlcmUuY291bnQg
PSBtaW4obWV0YV9zaXplIC0gaW5kZXgsIGxpbWl0KTsKKworCQlmb3IgKGk9dG9fYnl0ZXMoaW5k
ZXgpL3NpemVvZihzZWN0b3JfdCksIGo9MDsKKwkJICAgICBqPHRvX2J5dGVzKHdoZXJlLmNvdW50
KS9zaXplb2Yoc2VjdG9yX3QpICYmIGk8ZG1jLT5zaXplOworCQkgICAgIGkrKywgaisrKSB7CisJ
CQkvKiBBc3N1bWUgYWxsIGludmFsaWQgY2FjaGUgYmxvY2tzIHN0b3JlIDAuIFdlIGxvc2UgdGhl
IGJsb2NrIHRoYXQKKwkJCSAqIGlzIGFjdHVhbGx5IG1hcHBlZCB0byBvZmZzZXQgMC4KKwkJCSAq
LworCQkJbWV0YV9kYXRhW2pdID0gZG1jLT5jYWNoZVtpXS5zdGF0ZSA/IGRtYy0+Y2FjaGVbaV0u
YmxvY2sgOiAwOworCQl9CisJCWNoa3N1bSA9IGNzdW1fcGFydGlhbCgoY2hhciAqKW1ldGFfZGF0
YSwgdG9fYnl0ZXMod2hlcmUuY291bnQpLCBjaGtzdW0pOworCisJCWRtX2lvX3N5bmNfdm0oMSwg
JndoZXJlLCBXUklURSwgbWV0YV9kYXRhLCAmYml0cyk7CisJCWluZGV4ICs9IHdoZXJlLmNvdW50
OworCX0KKworCXZmcmVlKCh2b2lkICopbWV0YV9kYXRhKTsKKworCW1ldGFfZG1jID0gKHN0cnVj
dCBtZXRhX2RtYyAqKXZtYWxsb2MoNTEyKTsKKwlpZiAoIW1ldGFfZG1jKSB7CisJCURNRVJSKCJk
dW1wX21ldGFkYXRhOiBVbmFibGUgdG8gYWxsb2NhdGUgbWVtb3J5Iik7CisJCXJldHVybiAxOwor
CX0KKworCW1ldGFfZG1jLT5ibG9ja19zaXplID0gZG1jLT5ibG9ja19zaXplOworCW1ldGFfZG1j
LT5zaXplID0gZG1jLT5zaXplOworCW1ldGFfZG1jLT5hc3NvYyA9IGRtYy0+YXNzb2M7CisJbWV0
YV9kbWMtPndyaXRlX3BvbGljeSA9IGRtYy0+d3JpdGVfcG9saWN5OworCW1ldGFfZG1jLT5jaGtz
dW0gPSBjaGtzdW07CisKKwlEUFJJTlRLKCJTdG9yZSBtZXRhZGF0YSB0byBkaXNrOiBibG9jayBz
aXplKCV1KSwgY2FjaGUgc2l6ZSglbGx1KSwgIiBcCisJICAgICAgICAiYXNzb2NpYXRpdml0eSgl
dSksIHdyaXRlIHBvbGljeSgldSksIGNoZWNrc3VtKCV1KSIsCisJICAgICAgICBtZXRhX2RtYy0+
YmxvY2tfc2l6ZSwgbWV0YV9kbWMtPnNpemUsCisJICAgICAgICBtZXRhX2RtYy0+YXNzb2MsIG1l
dGFfZG1jLT53cml0ZV9wb2xpY3ksCisJICAgICAgICBtZXRhX2RtYy0+Y2hrc3VtKTsKKworCXdo
ZXJlLnNlY3RvciA9IGRldl9zaXplIC0gMTsKKwl3aGVyZS5jb3VudCA9IDE7CisJZG1faW9fc3lu
Y192bSgxLCAmd2hlcmUsIFdSSVRFLCBtZXRhX2RtYywgJmJpdHMpOworCisJdmZyZWUoKHZvaWQg
KiltZXRhX2RtYyk7CisKKwlETUlORk8oIkNhY2hlIG1ldGFkYXRhIHNhdmVkIHRvIGRpc2sgKG9m
ZnNldCAlbGx1KSIsCisJICAgICAgIGRldl9zaXplIC0gMSAtIG1ldGFfc2l6ZSk7CisKKwlyZXR1
cm4gMDsKK30KKworLyoKKyAqIENvbnN0cnVjdCBhIGNhY2hlIG1hcHBpbmcuCisgKiAgYXJnWzBd
OiBwYXRoIHRvIHNvdXJjZSBkZXZpY2UKKyAqICBhcmdbMV06IHBhdGggdG8gY2FjaGUgZGV2aWNl
CisgKiAgYXJnWzJdOiBjYWNoZSBwZXJzaXN0ZW5jZSAoaWYgc2V0LCBjYWNoZSBjb25mIGlzIGxv
YWRlZCBmcm9tIGRpc2spCisgKiBDYWNoZSBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgKGlmIG5v
dCBzZXQsIGRlZmF1bHQgdmFsdWVzIGFyZSB1c2VkLgorICogIGFyZ1szXTogY2FjaGUgYmxvY2sg
c2l6ZSAoaW4gc2VjdG9ycykKKyAqICBhcmdbNF06IGNhY2hlIHNpemUgKGluIGJsb2NrcykKKyAq
ICBhcmdbNV06IGNhY2hlIGFzc29jaWF0aXZpdHkKKyAqICBhcmdbNl06IHdyaXRlIGNhY2hpbmcg
cG9saWN5CisgKi8KK3N0YXRpYyBpbnQgY2FjaGVfY3RyKHN0cnVjdCBkbV90YXJnZXQgKnRpLCB1
bnNpZ25lZCBpbnQgYXJnYywgY2hhciAqKmFyZ3YpCit7CisJc3RydWN0IGNhY2hlX2MgKmRtYzsK
Kwl1bnNpZ25lZCBpbnQgY29uc2VjdXRpdmVfYmxvY2tzLCBwZXJzaXN0ZW5jZSA9IDA7CisJc2Vj
dG9yX3QgbG9jYWxzaXplLCBpLCBvcmRlcjsKKwlzZWN0b3JfdCBkYXRhX3NpemUsIG1ldGFfc2l6
ZSwgZGV2X3NpemU7CisJaW50IHIgPSAtRUlOVkFMOworCisJaWYgKGFyZ2MgPCAyKSB7CisJCXRp
LT5lcnJvciA9ICJkbS1jYWNoZTogTmVlZCBhdCBsZWFzdCAyIGFyZ3VtZW50cyI7CisJCWdvdG8g
YmFkOworCX0KKworCWRtYyA9IGttYWxsb2Moc2l6ZW9mKCpkbWMpLCBHRlBfS0VSTkVMKTsKKwlp
ZiAoZG1jID09IE5VTEwpIHsKKwkJdGktPmVycm9yID0gImRtLWNhY2hlOiBGYWlsZWQgdG8gYWxs
b2NhdGUgY2FjaGUgY29udGV4dCI7CisJCXIgPSBFTk9NRU07CisJCWdvdG8gYmFkOworCX0KKwor
CXIgPSBkbV9nZXRfZGV2aWNlKHRpLCBhcmd2WzBdLCAwLCB0aS0+bGVuLAorCQkJICBkbV90YWJs
ZV9nZXRfbW9kZSh0aS0+dGFibGUpLCAmZG1jLT5zcmNfZGV2KTsKKwlpZiAocikgeworCQl0aS0+
ZXJyb3IgPSAiZG0tY2FjaGU6IFNvdXJjZSBkZXZpY2UgbG9va3VwIGZhaWxlZCI7CisJCWdvdG8g
YmFkMTsKKwl9CisKKwlyID0gZG1fZ2V0X2RldmljZSh0aSwgYXJndlsxXSwgMCwgMCwKKwkJCSAg
ZG1fdGFibGVfZ2V0X21vZGUodGktPnRhYmxlKSwgJmRtYy0+Y2FjaGVfZGV2KTsKKwlpZiAocikg
eworCQl0aS0+ZXJyb3IgPSAiZG0tY2FjaGU6IENhY2hlIGRldmljZSBsb29rdXAgZmFpbGVkIjsK
KwkJZ290byBiYWQyOworCX0KKworCXIgPSBrY29weWRfY2xpZW50X2NyZWF0ZShETUNBQ0hFX0NP
UFlfUEFHRVMsICZkbWMtPmtjcF9jbGllbnQpOworCWlmIChyKSB7CisJCXRpLT5lcnJvciA9ICJG
YWlsZWQgdG8gaW5pdGlhbGl6ZSBrY29weWQgY2xpZW50XG4iOworCQlnb3RvIGJhZDM7CisJfQor
CisJciA9IGtjYWNoZWRfaW5pdChkbWMpOworCWlmIChyKSB7CisJCXRpLT5lcnJvciA9ICJGYWls
ZWQgdG8gaW5pdGlhbGl6ZSBrY2FjaGVkIjsKKwkJZ290byBiYWQ0OworCX0KKworCisJaWYgKGFy
Z2MgPj0gMykgeworCQlpZiAoc3NjYW5mKGFyZ3ZbMl0sICIldSIsICZwZXJzaXN0ZW5jZSkgIT0g
MSkgeworCQkJdGktPmVycm9yID0gImRtLWNhY2hlOiBJbnZhbGlkIGNhY2hlIHBlcnNpc3RlbmNl
IjsKKwkJCXIgPSAtRUlOVkFMOworCQkJZ290byBiYWQ1OworCQl9CisJfQorCWlmICgxID09IHBl
cnNpc3RlbmNlKSB7CisJCWlmIChsb2FkX21ldGFkYXRhKGRtYykpIHsKKwkJCXRpLT5lcnJvciA9
ICJkbS1jYWNoZTogSW52YWxpZCBjYWNoZSBjb25maWd1cmF0aW9uIjsKKwkJCXIgPSAtRUlOVkFM
OworCQkJZ290byBiYWQ1OworCQl9CisJCWdvdG8gaW5pdDsgLyogU2tpcCByZWFkaW5nIGNhY2hl
IHBhcmFtZXRlcnMgZnJvbSBjb21tYW5kIGxpbmUgKi8KKwl9IGVsc2UgaWYgKHBlcnNpc3RlbmNl
ICE9IDApIHsKKwkJCXRpLT5lcnJvciA9ICJkbS1jYWNoZTogSW52YWxpZCBjYWNoZSBwZXJzaXN0
ZW5jZSI7CisJCQlyID0gLUVJTlZBTDsKKwkJCWdvdG8gYmFkNTsKKwl9CisKKwlpZiAoYXJnYyA+
PSA0KSB7CisJCWlmIChzc2NhbmYoYXJndlszXSwgIiV1IiwgJmRtYy0+YmxvY2tfc2l6ZSkgIT0g
MSkgeworCQkJdGktPmVycm9yID0gImRtLWNhY2hlOiBJbnZhbGlkIGJsb2NrIHNpemUiOworCQkJ
ciA9IC1FSU5WQUw7CisJCQlnb3RvIGJhZDU7CisJCX0KKwkJaWYgKCFkbWMtPmJsb2NrX3NpemUg
fHwgKGRtYy0+YmxvY2tfc2l6ZSAmIChkbWMtPmJsb2NrX3NpemUgLSAxKSkpIHsKKwkJCXRpLT5l
cnJvciA9ICJkbS1jYWNoZTogSW52YWxpZCBibG9jayBzaXplIjsKKwkJCXIgPSAtRUlOVkFMOwor
CQkJZ290byBiYWQ1OworCQl9CisJfSBlbHNlCisJCWRtYy0+YmxvY2tfc2l6ZSA9IERFRkFVTFRf
QkxPQ0tfU0laRTsKKwlkbWMtPmJsb2NrX3NoaWZ0ID0gZmZzKGRtYy0+YmxvY2tfc2l6ZSkgLSAx
OworCWRtYy0+YmxvY2tfbWFzayA9IGRtYy0+YmxvY2tfc2l6ZSAtIDE7CisKKwlpZiAoYXJnYyA+
PSA1KSB7CisJCWlmIChzc2NhbmYoYXJndls0XSwgIiVsbHUiLCAmZG1jLT5zaXplKSAhPSAxKSB7
CisJCQl0aS0+ZXJyb3IgPSAiZG0tY2FjaGU6IEludmFsaWQgY2FjaGUgc2l6ZSI7CisJCQlyID0g
LUVJTlZBTDsKKwkJCWdvdG8gYmFkNTsKKwkJfQorCQlpZiAoIWRtYy0+c2l6ZSB8fCAoZG1jLT5z
aXplICYgKGRtYy0+c2l6ZSAtIDEpKSkgeworCQkJdGktPmVycm9yID0gImRtLWNhY2hlOiBJbnZh
bGlkIGNhY2hlIHNpemUiOworCQkJciA9IC1FSU5WQUw7CisJCQlnb3RvIGJhZDU7CisJCX0KKwl9
IGVsc2UKKwkJZG1jLT5zaXplID0gREVGQVVMVF9DQUNIRV9TSVpFOworCWxvY2Fsc2l6ZSA9IGRt
Yy0+c2l6ZTsKKwlkbWMtPmJpdHMgPSBmZnMoZG1jLT5zaXplKSAtIDE7CisKKwlpZiAoYXJnYyA+
PSA2KSB7CisJCWlmIChzc2NhbmYoYXJndls1XSwgIiV1IiwgJmRtYy0+YXNzb2MpICE9IDEpIHsK
KwkJCXRpLT5lcnJvciA9ICJkbS1jYWNoZTogSW52YWxpZCBjYWNoZSBhc3NvY2lhdGl2aXR5IjsK
KwkJCXIgPSAtRUlOVkFMOworCQkJZ290byBiYWQ1OworCQl9CisJCWlmICghZG1jLT5hc3NvYyB8
fCAoZG1jLT5hc3NvYyAmIChkbWMtPmFzc29jIC0gMSkpIHx8CisJCQlkbWMtPnNpemUgPCBkbWMt
PmFzc29jKSB7CisJCQl0aS0+ZXJyb3IgPSAiZG0tY2FjaGU6IEludmFsaWQgY2FjaGUgYXNzb2Np
YXRpdml0eSI7CisJCQlyID0gLUVJTlZBTDsKKwkJCWdvdG8gYmFkNTsKKwkJfQorCX0gZWxzZQor
CQlkbWMtPmFzc29jID0gREVGQVVMVF9DQUNIRV9BU1NPQzsKKworCWRldl9zaXplID0gdG9fc2Vj
dG9yKGRtYy0+Y2FjaGVfZGV2LT5iZGV2LT5iZF9pbm9kZS0+aV9zaXplKTsKKwlkYXRhX3NpemUg
PSBkbWMtPnNpemUgKiBkbWMtPmJsb2NrX3NpemU7CisJbWV0YV9zaXplID0gZG1fZGl2X3VwKGRt
Yy0+c2l6ZSAqIHNpemVvZihzZWN0b3JfdCksIDUxMikgKyAxOworCWlmICgoZGF0YV9zaXplICsg
bWV0YV9zaXplKSA+IGRldl9zaXplKSB7CisJCURNRVJSKCJSZXF1ZXN0ZWQgY2FjaGUgc2l6ZSBl
eGVlZHMgdGhlIGNhY2hlIGRldmljZSdzIGNhcGFjaXR5IiBcCisJCSAgICAgICIoJWxsdSslbGx1
PiVsbHUpIiwKKyAgCQkgICAgICBkYXRhX3NpemUsIG1ldGFfc2l6ZSwgZGV2X3NpemUpOworCQl0
aS0+ZXJyb3IgPSAiZG0tY2FjaGU6IEludmFsaWQgY2FjaGUgc2l6ZSI7CisJCXIgPSAtRUlOVkFM
OworCQlnb3RvIGJhZDU7CisJfQorCWNvbnNlY3V0aXZlX2Jsb2NrcyA9IGRtYy0+YXNzb2MgPCBD
T05TRUNVVElWRV9CTE9DS1MgPworCSAgICAgICAgICAgICAgICAgICAgIGRtYy0+YXNzb2MgOiBD
T05TRUNVVElWRV9CTE9DS1M7CisJZG1jLT5jb25zZWN1dGl2ZV9zaGlmdCA9IGZmcyhjb25zZWN1
dGl2ZV9ibG9ja3MpIC0gMTsKKworCWlmIChhcmdjID49IDcpIHsKKwkJaWYgKHNzY2FuZihhcmd2
WzZdLCAiJXUiLCAmZG1jLT53cml0ZV9wb2xpY3kpICE9IDEpIHsKKwkJCXRpLT5lcnJvciA9ICJk
bS1jYWNoZTogSW52YWxpZCBjYWNoZSB3cml0ZSBwb2xpY3kiOworCQkJciA9IC1FSU5WQUw7CisJ
CQlnb3RvIGJhZDU7CisJCX0KKwkJaWYgKGRtYy0+d3JpdGVfcG9saWN5ICE9IDAgJiYgZG1jLT53
cml0ZV9wb2xpY3kgIT0gMSkgeworCQkJdGktPmVycm9yID0gImRtLWNhY2hlOiBJbnZhbGlkIGNh
Y2hlIHdyaXRlIHBvbGljeSI7CisJCQlyID0gLUVJTlZBTDsKKwkJCWdvdG8gYmFkNTsKKwkJfQor
CX0gZWxzZQorCQlkbWMtPndyaXRlX3BvbGljeSA9IERFRkFVTFRfV1JJVEVfUE9MSUNZOworCisJ
b3JkZXIgPSBkbWMtPnNpemUgKiBzaXplb2Yoc3RydWN0IGNhY2hlYmxvY2spOworCWxvY2Fsc2l6
ZSA9IGRhdGFfc2l6ZSA+PiAxMTsKKwlETUlORk8oIkFsbG9jYXRlICVsbHVLQiAoJXVCIHBlcikg
bWVtIGZvciAlbGx1LWVudHJ5IGNhY2hlIiBcCisJICAgICAgICIoY2FwYWNpdHk6JWxsdU1CLCBh
c3NvY2lhdGl2aXR5OiV1LCBibG9jayBzaXplOiV1ICIgXAorCSAgICAgICAic2VjdG9ycygldUtC
KSwgJXMpIiwKKwkgICAgICAgb3JkZXIgPj4gMTAsIHNpemVvZihzdHJ1Y3QgY2FjaGVibG9jayks
IGRtYy0+c2l6ZSwKKwkgICAgICAgZGF0YV9zaXplID4+ICgyMC1TRUNUT1JfU0hJRlQpLCBkbWMt
PmFzc29jLCBkbWMtPmJsb2NrX3NpemUsCisJICAgICAgIGRtYy0+YmxvY2tfc2l6ZSA+PiAoMTAt
U0VDVE9SX1NISUZUKSwKKwkgICAgICAgZG1jLT53cml0ZV9wb2xpY3kgPyAid3JpdGUtYmFjayIg
OiAid3JpdGUtdGhyb3VnaCIpOworCWRtYy0+Y2FjaGUgPSAoc3RydWN0IGNhY2hlYmxvY2sgKil2
bWFsbG9jKG9yZGVyKTsKKwlpZiAoIWRtYy0+Y2FjaGUpIHsKKwkJdGktPmVycm9yID0gIlVuYWJs
ZSB0byBhbGxvY2F0ZSBtZW1vcnkiOworCQlyID0gLUVOT01FTTsKKwkJZ290byBiYWQ1OworCX0K
KworCitpbml0OgkvKiBJbml0aWFsaXplIHRoZSBjYWNoZSBzdHJ1Y3RzICovCisJZm9yIChpPTA7
IGk8ZG1jLT5zaXplOyBpKyspIHsKKwkJYmlvX2xpc3RfaW5pdCgmZG1jLT5jYWNoZVtpXS5iaW9z
KTsKKwkJaWYoIXBlcnNpc3RlbmNlKSBkbWMtPmNhY2hlW2ldLnN0YXRlID0gMDsKKwkJZG1jLT5j
YWNoZVtpXS5jb3VudGVyID0gMDsKKwkJc3Bpbl9sb2NrX2luaXQoJmRtYy0+Y2FjaGVbaV0ubG9j
ayk7CisJfQorCisJZG1jLT5jb3VudGVyID0gMDsKKwlkbWMtPmRpcnR5X2Jsb2NrcyA9IDA7CisJ
ZG1jLT5yZWFkcyA9IDA7CisJZG1jLT53cml0ZXMgPSAwOworCWRtYy0+Y2FjaGVfaGl0cyA9IDA7
CisJZG1jLT5yZXBsYWNlID0gMDsKKwlkbWMtPndyaXRlYmFjayA9IDA7CisJZG1jLT5kaXJ0eSA9
IDA7CisKKwl0aS0+c3BsaXRfaW8gPSBkbWMtPmJsb2NrX3NpemU7CisJdGktPnByaXZhdGUgPSBk
bWM7CisKKwlyZXR1cm4gMDsKKworYmFkNToKKwlrY2FjaGVkX2NsaWVudF9kZXN0cm95KGRtYyk7
CitiYWQ0OgorCWtjb3B5ZF9jbGllbnRfZGVzdHJveShkbWMtPmtjcF9jbGllbnQpOworYmFkMzoK
KwlkbV9wdXRfZGV2aWNlKHRpLCBkbWMtPmNhY2hlX2Rldik7CitiYWQyOgorCWRtX3B1dF9kZXZp
Y2UodGksIGRtYy0+c3JjX2Rldik7CitiYWQxOgorCWtmcmVlKGRtYyk7CitiYWQ6CisJcmV0dXJu
IHI7Cit9CisKKworc3RhdGljIHZvaWQgY2FjaGVfZmx1c2goc3RydWN0IGNhY2hlX2MgKmRtYykK
K3sKKwlzdHJ1Y3QgY2FjaGVibG9jayAqY2FjaGUgPSBkbWMtPmNhY2hlOworCXNlY3Rvcl90IGkg
PSAwOworCXVuc2lnbmVkIGludCBqOworCisJRE1JTkZPKCJGbHVzaCBkaXJ0eSBibG9ja3MgKCVs
bHUpIC4uLiIsIGRtYy0+ZGlydHlfYmxvY2tzKTsKKwl3aGlsZSAoaTwgZG1jLT5zaXplKSB7CisJ
CWogPSAxOworCQlpZiAoaXNfc3RhdGUoY2FjaGVbaV0uc3RhdGUsIERJUlRZKSkgeworCQkJd2hp
bGUgKChpK2opIDwgZG1jLT5zaXplICYmIGlzX3N0YXRlKGNhY2hlW2kral0uc3RhdGUsIERJUlRZ
KQorCQkJICAgICAgICYmIChjYWNoZVtpK2pdLmJsb2NrID09IGNhY2hlW2ldLmJsb2NrICsgaiAq
CisJCQkgICAgICAgZG1jLT5ibG9ja19zaXplKSkgeworCQkJCWorKzsKKwkJCX0KKwkJCWRtYy0+
ZGlydHkgKz0gajsKKwkJCXdyaXRlX2JhY2soZG1jLCBpLCBqKTsKKwkJfQorCQlpICs9IGo7CisJ
fQorfQorCisvKgorICogRGVzdHJveSB0aGUgY2FjaGUgbWFwcGluZy4KKyAqLworc3RhdGljIHZv
aWQgY2FjaGVfZHRyKHN0cnVjdCBkbV90YXJnZXQgKnRpKQoreworCXN0cnVjdCBjYWNoZV9jICpk
bWMgPSAoc3RydWN0IGNhY2hlX2MgKikgdGktPnByaXZhdGU7CisKKwlpZiAoZG1jLT5kaXJ0eV9i
bG9ja3MgPiAwKSBjYWNoZV9mbHVzaChkbWMpOworCisJa2NhY2hlZF9jbGllbnRfZGVzdHJveShk
bWMpOworCisJa2NvcHlkX2NsaWVudF9kZXN0cm95KGRtYy0+a2NwX2NsaWVudCk7CisKKwlpZiAo
ZG1jLT5yZWFkcyArIGRtYy0+d3JpdGVzID4gMCkKKwkJRE1JTkZPKCJzdGF0czogcmVhZHMoJWx1
KSwgd3JpdGVzKCVsdSksIGNhY2hlIGhpdHMoJWx1LCAwLiVsdSksIiBcCisJCSAgICAgICAicmVw
bGFjZW1lbnQoJWx1KSwgcmVwbGFjZWQgZGlydHkgYmxvY2tzKCVsdSksICIgXAorCSAgICAgICAg
ICAgImZsdXNoZWQgZGlydHkgYmxvY2tzKCVsdSkiLAorCQkgICAgICAgZG1jLT5yZWFkcywgZG1j
LT53cml0ZXMsIGRtYy0+Y2FjaGVfaGl0cywKKwkJICAgICAgIGRtYy0+Y2FjaGVfaGl0cyAqIDEw
MCAvIChkbWMtPnJlYWRzICsgZG1jLT53cml0ZXMpLAorCQkgICAgICAgZG1jLT5yZXBsYWNlLCBk
bWMtPndyaXRlYmFjaywgZG1jLT5kaXJ0eSk7CisKKwlkdW1wX21ldGFkYXRhKGRtYyk7IC8qIEFs
d2F5cyBkdW1wIG1ldGFkYXRhIHRvIGRpc2sgYmVmb3JlIGV4aXQgKi8KKwl2ZnJlZSgodm9pZCAq
KWRtYy0+Y2FjaGUpOworCisJZG1fcHV0X2RldmljZSh0aSwgZG1jLT5zcmNfZGV2KTsKKwlkbV9w
dXRfZGV2aWNlKHRpLCBkbWMtPmNhY2hlX2Rldik7CisJa2ZyZWUoZG1jKTsKK30KKworLyoKKyAq
IFJlcG9ydCBjYWNoZSBzdGF0dXM6CisgKiAgT3V0cHV0IGNhY2hlIHN0YXRzIHVwb24gcmVxdWVz
dCBvZiBkZXZpY2Ugc3RhdHVzOworICogIE91dHB1dCBjYWNoZSBjb25maWd1cmF0aW9uIHVwb24g
cmVxdWVzdCBvZiB0YWJsZSBzdGF0dXMuCisgKi8KK3N0YXRpYyBpbnQgY2FjaGVfc3RhdHVzKHN0
cnVjdCBkbV90YXJnZXQgKnRpLCBzdGF0dXNfdHlwZV90IHR5cGUsCisJCQkgY2hhciAqcmVzdWx0
LCB1bnNpZ25lZCBpbnQgbWF4bGVuKQoreworCXN0cnVjdCBjYWNoZV9jICpkbWMgPSAoc3RydWN0
IGNhY2hlX2MgKikgdGktPnByaXZhdGU7CisJaW50IHN6ID0gMDsKKworCXN3aXRjaCAodHlwZSkg
eworCWNhc2UgU1RBVFVTVFlQRV9JTkZPOgorCQlETUVNSVQoInN0YXRzOiByZWFkcyglbHUpLCB3
cml0ZXMoJWx1KSwgY2FjaGUgaGl0cyglbHUsIDAuJWx1KSwiIFwKKwkgICAgICAgICAgICJyZXBs
YWNlbWVudCglbHUpLCByZXBsYWNlZCBkaXJ0eSBibG9ja3MoJWx1KSIsCisJICAgICAgICAgICBk
bWMtPnJlYWRzLCBkbWMtPndyaXRlcywgZG1jLT5jYWNoZV9oaXRzLAorCSAgICAgICAgICAgZG1j
LT5jYWNoZV9oaXRzICogMTAwIC8gKGRtYy0+cmVhZHMgKyBkbWMtPndyaXRlcyksCisJICAgICAg
ICAgICBkbWMtPnJlcGxhY2UsIGRtYy0+d3JpdGViYWNrKTsKKwkJYnJlYWs7CisJY2FzZSBTVEFU
VVNUWVBFX1RBQkxFOgorCQlETUVNSVQoImNvbmY6IGNhcGFjaXR5KCVsbHVNKSwgYXNzb2NpYXRp
dml0eSgldSksIGJsb2NrIHNpemUoJXVLKSwgJXMiLAorCSAgICAgICAgICAgZG1jLT5zaXplKmRt
Yy0+YmxvY2tfc2l6ZT4+MTEsIGRtYy0+YXNzb2MsCisJICAgICAgICAgICBkbWMtPmJsb2NrX3Np
emU+PigxMC1TRUNUT1JfU0hJRlQpLAorCSAgICAgICAgICAgZG1jLT53cml0ZV9wb2xpY3kgPyAi
d3JpdGUtYmFjayI6IndyaXRlLXRocm91Z2giKTsKKwkJYnJlYWs7CisJfQorCXJldHVybiAwOwor
fQorCisKKy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqCisgKiAgRnVuY3Rpb25zIGZvciBtYW5pcHVsYXRp
bmcgYSBjYWNoZSB0YXJnZXQuCisgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KKworc3RhdGljIHN0cnVj
dCB0YXJnZXRfdHlwZSBjYWNoZV90YXJnZXQgPSB7CisJLm5hbWUgICA9ICJjYWNoZSIsCisJLnZl
cnNpb249IHsxLCAwLCAxfSwKKwkubW9kdWxlID0gVEhJU19NT0RVTEUsCisJLmN0ciAgICA9IGNh
Y2hlX2N0ciwKKwkuZHRyICAgID0gY2FjaGVfZHRyLAorCS5tYXAgICAgPSBjYWNoZV9tYXAsCisJ
LnN0YXR1cyA9IGNhY2hlX3N0YXR1cywKK307CisKKy8qCisgKiBJbml0aWF0ZSBhIGNhY2hlIHRh
cmdldC4KKyAqLworaW50IF9faW5pdCBkbV9jYWNoZV9pbml0KHZvaWQpCit7CisJaW50IHI7CisK
KwlyID0gam9ic19pbml0KCk7CisJaWYgKHIpCisJCXJldHVybiByOworCisJX2tjYWNoZWRfd3Eg
PSBjcmVhdGVfc2luZ2xldGhyZWFkX3dvcmtxdWV1ZSgia2NhY2hlZCIpOworCWlmICghX2tjYWNo
ZWRfd3EpIHsKKwkJRE1FUlIoImZhaWxlZCB0byBzdGFydCBrY2FjaGVkIik7CisJCXJldHVybiAt
RU5PTUVNOworCX0KKwlJTklUX1dPUksoJl9rY2FjaGVkX3dvcmssIGRvX3dvcmssIE5VTEwpOwor
CisJciA9IGRtX3JlZ2lzdGVyX3RhcmdldCgmY2FjaGVfdGFyZ2V0KTsKKwlpZiAociA8IDApIHsK
KwkJRE1FUlIoImNhY2hlOiByZWdpc3RlciBmYWlsZWQgJWQiLCByKTsKKwkJZGVzdHJveV93b3Jr
cXVldWUoX2tjYWNoZWRfd3EpOworCX0KKworCXJldHVybiByOworfQorCisvKgorICogRGVzdHJv
eSBhIGNhY2hlIHRhcmdldC4KKyAqLwordm9pZCBkbV9jYWNoZV9leGl0KHZvaWQpCit7CisJaW50
IHIgPSBkbV91bnJlZ2lzdGVyX3RhcmdldCgmY2FjaGVfdGFyZ2V0KTsKKworCWlmIChyIDwgMCkK
KwkJRE1FUlIoImNhY2hlOiB1bnJlZ2lzdGVyIGZhaWxlZCAlZCIsIHIpOworCisJam9ic19leGl0
KCk7CisJZGVzdHJveV93b3JrcXVldWUoX2tjYWNoZWRfd3EpOworfQorCittb2R1bGVfaW5pdChk
bV9jYWNoZV9pbml0KTsKK21vZHVsZV9leGl0KGRtX2NhY2hlX2V4aXQpOworCitNT0RVTEVfREVT
Q1JJUFRJT04oRE1fTkFNRSAiIGNhY2hlIHRhcmdldCIpOworTU9EVUxFX0FVVEhPUigiTWluZyIp
OworTU9EVUxFX0xJQ0VOU0UoIkdQTCIpOwpkaWZmIC1OYXVyIGxpbnV4LTIuNi4xOS4xLW9yaWcv
ZHJpdmVycy9tZC9LY29uZmlnIGxpbnV4LTIuNi4xOS4xLWRtY2FjaGUvZHJpdmVycy9tZC9LY29u
ZmlnCi0tLSBsaW51eC0yLjYuMTkuMS1vcmlnL2RyaXZlcnMvbWQvS2NvbmZpZwkyMDA2LTEyLTMx
IDEyOjE4OjIwLjAwMDAwMDAwMCAtMDUwMAorKysgbGludXgtMi42LjE5LjEtZG1jYWNoZS9kcml2
ZXJzL21kL0tjb25maWcJMjAwNi0xMi0zMSAxMzoxODoxOC4wMDAwMDAwMDAgLTA1MDAKQEAgLTI2
MSw2ICsyNjEsMTIgQEAKIAktLS1oZWxwLS0tCiAJICBNdWx0aXBhdGggc3VwcG9ydCBmb3IgRU1D
IENYL0FYIHNlcmllcyBoYXJkd2FyZS4KIAorY29uZmlnIERNX0NBQ0hFCisJdHJpc3RhdGUgIkNh
Y2hlIHRhcmdldCBzdXBwb3J0IChFWFBFUklNRU5UQUwpIgorCWRlcGVuZHMgb24gQkxLX0RFVl9E
TSAmJiBFWFBFUklNRU5UQUwKKwktLS1oZWxwLS0tCisJICBTdXBwb3J0IGZvciBnZW5lcmljIGNh
Y2hlIHRhcmdldCBmb3IgZGV2aWNlLW1hcHBlci4KKwogZW5kbWVudQogCiBlbmRpZgpkaWZmIC1O
YXVyIGxpbnV4LTIuNi4xOS4xLW9yaWcvZHJpdmVycy9tZC9NYWtlZmlsZSBsaW51eC0yLjYuMTku
MS1kbWNhY2hlL2RyaXZlcnMvbWQvTWFrZWZpbGUKLS0tIGxpbnV4LTIuNi4xOS4xLW9yaWcvZHJp
dmVycy9tZC9NYWtlZmlsZQkyMDA2LTEyLTMxIDEyOjE4OjIwLjAwMDAwMDAwMCAtMDUwMAorKysg
bGludXgtMi42LjE5LjEtZG1jYWNoZS9kcml2ZXJzL21kL01ha2VmaWxlCTIwMDYtMTItMzEgMTM6
MjI6MjcuMDAwMDAwMDAwIC0wNTAwCkBAIC0zNiw2ICszNiw3IEBACiBvYmotJChDT05GSUdfRE1f
U05BUFNIT1QpCSs9IGRtLXNuYXBzaG90Lm8KIG9iai0kKENPTkZJR19ETV9NSVJST1IpCQkrPSBk
bS1taXJyb3Iubwogb2JqLSQoQ09ORklHX0RNX1pFUk8pCQkrPSBkbS16ZXJvLm8KK29iai0kKENP
TkZJR19ETV9DQUNIRSkJCSs9IGRtLWNhY2hlLm8KIAogcXVpZXRfY21kX3Vucm9sbCA9IFVOUk9M
TCAgJEAKICAgICAgIGNtZF91bnJvbGwgPSAkKFBFUkwpICQoc3JjdHJlZSkvJChzcmMpL3Vucm9s
bC5wbCAkKFVOUk9MTCkgXAo=
------=_Part_221821_3510469.1167841425577--
