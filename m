Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S264471AbTFXIDa (ORCPT <rfc822;willy@w.ods.org>);
	Tue, 24 Jun 2003 04:03:30 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S264912AbTFXIDa
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Tue, 24 Jun 2003 04:03:30 -0400
Received: from griffon.mipsys.com ([217.167.51.129]:7915 "EHLO gaston")
	by vger.kernel.org with ESMTP id S264471AbTFXIDK (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Tue, 24 Jun 2003 04:03:10 -0400
Subject: Re: 2.5.72: oops with swsusp+ide
From: Benjamin Herrenschmidt <benh@kernel.crashing.org>
To: Michal Ceresna <ceresna@dbai.tuwien.ac.at>
Cc: linux-kernel mailing list <linux-kernel@vger.kernel.org>
In-Reply-To: <200306240922.54292.ceresna@dbai.tuwien.ac.at>
References: <200306240922.54292.ceresna@dbai.tuwien.ac.at>
Content-Type: text/plain
Content-Transfer-Encoding: 7bit
Message-Id: <1056442621.9700.54.camel@gaston>
Mime-Version: 1.0
X-Mailer: Ximian Evolution 1.4.0 
Date: 24 Jun 2003 10:17:02 +0200
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

On Tue, 2003-06-24 at 09:22, Michal Ceresna wrote:
> Hi,
> 
> I'm not sure if this is already a know problem,
> but I get this oops while trying the software
> suspend in recent 2.5.7x.

I'm not sure I'm interpreting that oops properly, but it _seems_
the kernel complains about scheduling from the IDE resume function.

However, it's my understanding that such resume functions should
be allowed to schedule. I'm not too familiar with the swsusp
code, but if you call device_resume(), you should NOT be in
'atomic' code, especially since device_resume() itself will
do a down() on a semaphore...

But again, I may have misinterpreted the Oops log.

> best wishes,
> Michal
> 
> klogd entered refrigerator
> <4>=init entered refrigerator
> <4>=pdflush entered refrigerator
> <4>=pdflush entered refrigerator
> <4>=kswapd0 entered refrigerator
> <4>=kseriod entered refrigerator
> <4>=devfsd entered refrigerator
> <4>=kjournald entered refrigerator
> <4>=kjournald entered refrigerator
> <4>=kjournald entered refrigerator
> <4>=kjournald entered refrigerator
> <4>=kjournald entered refrigerator
> <4>=portmap entered refrigeratorip
> <4>=syslogd entered refrigerator
> <4>=ifd entered refrigerator
> <4>=acpid entered refrigerator
> <4>=cupsd entered refrigerator
> <4>=dictd entered refrigerator
> <4>=famd entered refrigerator
> <4>=gpm entered refrigerator
> <4>=inetd entered refrigerator
> <4>=masqmail entered refrigerator
> <4>=mysqld_safe entered refrigerator
> <4>=mysqld entered refrigerator
> <4>=mysqld entered refrigerator
> <4>=mysqld entered refrigerator
> <4>=mysqld entered refrigerator
> <4>=nmbd entered refrigerator
> <4>=smbd entered refrigerator
> <4>=sshd entered refrigerator
> <4>=wwwoffled entered refrigerator
> <4>=atd entered refrigerator
> <4>=cron entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=getty entered refrigerator
> <4>=|
> <4>Freeing memory: .......................................|
> <4>Syncing disks before copy
> <0>Suspending devices
> <0>Suspending devices
> <4>hdb: start_power_step(step: 0)
> <4>hdb: completing PM request, suspend
> <4>hda: start_power_step(step: 0)
> <4>hda: completing PM request, suspend
> <4>hda: a request made it's way while we are power managing...
> <0>Suspending devices
> <4>/critical section: Counting pages to copy[nosave c035e000] (pages needed: 
> 8173+512=8685 free: 122876)
> <4>Alloc pagedir
> <4>..................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................!
.......................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................!
.......................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................!
.......................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................!
......................[nosave 
> c035e000]critical section/: done (8173 pages copied)
> <4>hda: Wakeup request inited, waiting for !BSY...
> <4>hda: start_power_step(step: 1000)
> <4>blk: queue c039ebbc, I/O limit 4095Mb (mask 0xffffffff)
> <4>hda: completing PM request, resume
> <3>bad: scheduling while atomic!
> <4>Call Trace:
> <4> [<c011e6e6>] schedule+0x3b6/0x3c0
> <4> [<c011ea48>] wait_for_completion+0x78/0xd0
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c011e740>] <1>Unable to handle kernel NULL pointer dereference at 
> virtual address 00000014
> <4> printing eip:
> <4>c0235519
> <1>*pde = 00000000
> <4>Oops: 0000 [#1]
> <4>CPU:    0
> <4>EIP:    0060:[<c0235519>]    Not tainted
> <4>EFLAGS: 00010246
> <4>EIP is at ide_dma_intr+0x89/0xc0
> <4>eax: 00000000   ebx: c039ebac   ecx: 00010001   edx: c0334660
> <4>esi: 00000282   edi: dfdfea80   ebp: c039ebac   esp: dc375b50
> <4>ds: 007b   es: 007b   ss: 0068
> <4>Process bash (pid: 761, threadinfo=dc374000 task=dd412d20)
> <4>Stack: 000001f7 c0129216 dc374000 50004000 dc374000 c022260a c039ebac 
> dc374000 
> <4>       c0235490 c039eb00 dfdfd760 04000001 00000000 dc375bd0 c010b8c9 
> 0000000e 
> <4>       dfdfea80 dc375bd0 dc374000 0000000e 000001c0 c035fbc0 c010bc31 
> 0000000e 
> <4>Call Trace:
> <4> [<c0129216>] del_timer+0x86/0x90
> <4> [<c022260a>] ide_intr+0xea/0x190
> <4> [<c0235490>] ide_dma_intr+0x0/0xc0
> <4> [<c010b8c9>] handle_IRQ_event+0x49/0x80
> <4> [<c010bc31>] do_IRQ+0x91/0x130
> <4> [<c010a048>] common_interrupt+0x18/0x20
> <4> [<c013007b>] ____call_usermodehelper+0x5b/0xa0
> <4> [<c0137cbd>] kallsyms_lookup+0x12d/0x1c0
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c0137d8f>] __print_symbol+0x3f/0x170
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c020e62d>] vt_console_print+0x21d/0x300
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c010a342>] show_trace+0x92/0xa0
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c010a41f>] dump_stack+0xf/0x20
> <4> [<c011e6e6>] schedule+0x3b6/0x3c0
> <4> [<c011ea48>] wait_for_completion+0x78/0xd0
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c011e740>] default_wake_function+0x0/0x30
> <4> [<c0218536>] __elv_add_request+0x36/0x50
> <4> [<c02227cb>] ide_do_drive_cmd+0xfb/0x130
> <4> [<c022b6d9>] generic_ide_resume+0xc9/0xd0
> <4> [<c010bc9d>] do_IRQ+0xfd/0x130
> <4> [<c021649a>] device_resume+0xaa/0xc0
> <4> [<c013942f>] drivers_unsuspend+0xf/0x20
> <4> [<c0139715>] suspend_save_image+0x5/0x20
> <4> [<c01399ed>] do_magic_suspend_2+0xad/0xc0
> <4> [<c011a99d>] do_magic+0x4d/0x130
> <4> [<c0139a6e>] do_software_suspend+0x6e/0xa0
> <4> [<c01e54c2>] acpi_system_write_sleep+0xc9/0x10a
> <4> [<c01e53f9>] acpi_system_write_sleep+0x0/0x10a
> <4> [<c01558e8>] vfs_write+0xb8/0x130
> <4> [<c0155a12>] sys_write+0x42/0x70
> <4> [<c01096db>] syscall_call+0x7/0xb
> <4>
> <4>Code: 8b 40 14 c7 44 24 04 01 00 00 00 89 1c 24 89 44 24 08 ff 52 
> <4> <0>Kernel panic: Fatal exception in interrupt
> <0>In interrupt handler - not syncing
> <4> <0>Dumping messages in 0 seconds : last chance for Alt-SysRq...
-- 
Benjamin Herrenschmidt <benh@kernel.crashing.org>
