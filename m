Return-Path: <linux-kernel-owner+willy=40w.ods.org@vger.kernel.org>
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S262672AbUCOSI2 (ORCPT <rfc822;willy@w.ods.org>);
	Mon, 15 Mar 2004 13:08:28 -0500
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S262661AbUCOSGx
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Mon, 15 Mar 2004 13:06:53 -0500
Received: from ns.suse.de ([195.135.220.2]:50136 "EHLO Cantor.suse.de")
	by vger.kernel.org with ESMTP id S262655AbUCOSFz (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Mon, 15 Mar 2004 13:05:55 -0500
Date: Mon, 15 Mar 2004 19:05:52 +0100
Message-ID: <s5hn06igf3z.wl@alsa2.suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Dave Jones <davej@redhat.com>
Cc: Jaroslav Kysela <perex@suse.cz>,
       Isaku Yamahata <yamahata@private.email.ne.jp>,
       George Hansper <ghansper@apana.org.au>,
       Linux Kernel <linux-kernel@vger.kernel.org>
Subject: Re: ALSA MIDI serial u16550 horribly broken in 2.6.4
In-Reply-To: <20040315175110.GS28660@redhat.com>
References: <20040315161047.GA19555@redhat.com>
	<Pine.LNX.4.58.0403151728380.13684@pnote.perex-int.cz>
	<20040315175110.GS28660@redhat.com>
User-Agent: Wanderlust/2.10.1 (Watching The Wheels) SEMI/1.14.5 (Awara-Onsen) FLIM/1.14.5 (Demachiyanagi) APEL/10.6 MULE XEmacs/21.4 (patch 13) (Rational FORTRAN) (i386-suse-linux)
MIME-Version: 1.0 (generated by SEMI 1.14.5 - "Awara-Onsen")
Content-Type: multipart/mixed;
 boundary="Multipart_Mon_Mar_15_19:05:52_2004-1"
Sender: linux-kernel-owner@vger.kernel.org
X-Mailing-List: linux-kernel@vger.kernel.org

--Multipart_Mon_Mar_15_19:05:52_2004-1
Content-Type: text/plain; charset=US-ASCII

At Mon, 15 Mar 2004 17:51:10 +0000,
Dave Jones wrote:
> 
> On Mon, Mar 15, 2004 at 05:29:44PM +0100, Jaroslav Kysela wrote:
>  > On Mon, 15 Mar 2004, Dave Jones wrote:
>  > 
>  > > poking io port 0x1 probably isn't going to do much good.
>  > > Here's what happens after a 'modprobe snd_serial_u16550'
>  > 
>  > Thanks. I've fixed this problem in our CVS tree. The oops should
>  > be fixed in the current Linus's tree, too.
> 
> Hmm, I don't see it at http://cvs.sourceforge.net/viewcvs.py/alsa/alsa-kernel/drivers/serial-u16550.c
> Is there somewhere else I should look ?

it must be the usual delay of sourceforce's anon cvs tree...
the patch is attached below.


Takashi

--Multipart_Mon_Mar_15_19:05:52_2004-1
Content-Type: text/plain; charset=US-ASCII

--- linux/sound/drivers/serial-u16550.c	13 Jan 2004 17:09:57 -0000	1.20
+++ linux/sound/drivers/serial-u16550.c	15 Mar 2004 17:40:01 -0000	1.21
@@ -342,7 +342,7 @@
 	unsigned char c;
 
 	/* Do some vague tests for the presence of the uart */
-	if (io_base == 0) {
+	if (io_base == 0 || io_base == SNDRV_AUTO_PORT) {
 		return -ENODEV;	/* Not configured */
 	}
 
@@ -804,10 +804,9 @@
 		return err;
 	}
 
-	if (irq >= 0) {
+	if (irq >= 0 && irq != SNDRV_AUTO_IRQ) {
 		if (request_irq(irq, snd_uart16550_interrupt,
 				SA_INTERRUPT, "Serial MIDI", (void *) uart)) {
-			uart->irq = -1;
 			snd_printk("irq %d busy. Using Polling.\n", irq);
 		} else {
 			uart->irq = irq;

--Multipart_Mon_Mar_15_19:05:52_2004-1--
